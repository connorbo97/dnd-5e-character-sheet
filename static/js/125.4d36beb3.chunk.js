"use strict";(self.webpackChunkdnd_5e_character_sheet=self.webpackChunkdnd_5e_character_sheet||[]).push([[125],{7125:function(e,t,i){i.r(t),i.d(t,{default:function(){return xs}});var n=i(4925),r=i(4942),s=i(3433),a=i(1413),o=i(8737),l=i(2963),u=i(7326),h=i(1120);function c(){return c="undefined"!==typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,i){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=(0,h.Z)(e)););return e}(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(arguments.length<3?e:i):r.value}},c.apply(this,arguments)}var d=i(4165),f=i(5861),_=i(9439),v=i(136),g=i(9388),p=i(7762),m=i(5671),y=i(3144),T=i(3252),E=["id","value"],S=Object.defineProperty,b=function(e,t,i){return function(e,t,i){t in e?S(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i}(e,"symbol"!=typeof t?t+"":t,i),i},x=function(e,t,i){if(!t.has(e))throw TypeError("Cannot "+i)},M=function(e,t,i){return x(e,t,"read from private field"),i?i.call(e):t.get(e)},A=function(e,t,i){if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)},R=function(e,t,i,n){return x(e,t,"write to private field"),n?n.call(e,i):t.set(e,i),i},C=function(e,t,i,n){return{set _(n){R(e,t,n,i)},get _(){return M(e,t,n)}}},I=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"WithinEpsilon",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1401298e-51;return Math.abs(e-t)<=i}},{key:"ToHex",value:function(e){var t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}},{key:"Sign",value:function(e){return 0===(e=+e)||isNaN(e)?e:e>0?1:-1}},{key:"Clamp",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return Math.min(i,Math.max(t,e))}},{key:"Log2",value:function(e){return Math.log(e)*Math.LOG2E}},{key:"ILog2",value:function(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(0===e)return-1/0;var t=0;if(e<1){for(;e<1;)t++,e*=2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}},{key:"Repeat",value:function(e,t){return e-Math.floor(e/t)*t}},{key:"Normalize",value:function(e,t,i){return(e-t)/(i-t)}},{key:"Denormalize",value:function(e,t,i){return e*(i-t)+t}},{key:"DeltaAngle",value:function(t,i){var n=e.Repeat(i-t,360);return n>180&&(n-=360),n}},{key:"PingPong",value:function(t,i){var n=e.Repeat(t,2*i);return i-Math.abs(n-i)}},{key:"SmoothStep",value:function(t,i,n){var r=e.Clamp(n);return i*(r=-2*r*r*r+3*r*r)+t*(1-r)}},{key:"MoveTowards",value:function(t,i,n){return Math.abs(i-t)<=n?i:t+e.Sign(i-t)*n}},{key:"MoveTowardsAngle",value:function(t,i,n){var r=e.DeltaAngle(t,i),s=0;return-n<r&&r<n?s=i:(i=t+r,s=e.MoveTowards(t,i,n)),s}},{key:"Lerp",value:function(e,t,i){return e+(t-e)*i}},{key:"LerpAngle",value:function(t,i,n){var r=e.Repeat(i-t,360);return r>180&&(r-=360),t+r*e.Clamp(n)}},{key:"InverseLerp",value:function(t,i,n){return t!=i?e.Clamp((n-t)/(i-t)):0}},{key:"Hermite",value:function(e,t,i,n,r){var s=r*r,a=r*s;return e*(2*a-3*s+1)+i*(-2*a+3*s)+t*(a-2*s+r)+n*(a-s)}},{key:"Hermite1stDerivative",value:function(e,t,i,n,r){var s=r*r;return 6*(s-r)*e+(3*s-4*r+1)*t+6*(-s+r)*i+(3*s-2*r)*n}},{key:"RandomRange",value:function(e,t){return e===t?e:Math.random()*(t-e)+e}},{key:"RangeToPercent",value:function(e,t,i){return(e-t)/(i-t)}},{key:"PercentToRange",value:function(e,t,i){return(i-t)*e+t}},{key:"NormalizeRadians",value:function(t){return t-=e.TwoPi*Math.floor((t+Math.PI)/e.TwoPi)}},{key:"HCF",value:function(t,i){var n=t%i;return 0===n?i:e.HCF(i,n)}}]),e}();I.TwoPi=2*Math.PI;var P=1/2.2,k=2.2,D=.001,F=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"BuildArray",value:function(e,t){for(var i=[],n=0;n<e;++n)i.push(t());return i}},{key:"BuildTuple",value:function(t,i){return e.BuildArray(t,i)}}]),e}();var w=["push","splice","pop","shift","unshift"];function O(e,t){var i=w.map((function(i){return function(e,t,i){var n=e[t];if("function"!=typeof n)return null;var r=function n(){var r=e.length,s=n.previous.apply(e,arguments);return i(t,r),s};return n.next=r,r.previous=n,e[t]=r,function(){var i=r.previous;if(i){var n=r.next;n?(i.next=n,n.previous=i):(i.next=void 0,e[t]=i),r.next=void 0,r.previous=void 0}}}(e,i,t)}));return function(){i.forEach((function(e){null==e||e()}))}}var L={};function N(e,t){L[e]=t}function B(e){return L[e]}var U=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"SetMatrixPrecision",value:function(t){if(e.MatrixTrackPrecisionChange=!1,t&&!e.MatrixUse64Bits&&e.MatrixTrackedMatrices)for(var i=0;i<e.MatrixTrackedMatrices.length;++i){var n=e.MatrixTrackedMatrices[i],r=n._m;n._m=new Array(16);for(var s=0;s<16;++s)n._m[s]=r[s]}e.MatrixUse64Bits=t,e.MatrixCurrentType=e.MatrixUse64Bits?Array:Float32Array,e.MatrixTrackedMatrices=null}}]),e}();U.MatrixUse64Bits=!1,U.MatrixTrackPrecisionChange=!0,U.MatrixCurrentType=Float32Array,U.MatrixTrackedMatrices=[];var V=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"LastCreatedEngine",get:function(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]}},{key:"LastCreatedScene",get:function(){return this._LastCreatedScene}}]),e}();V.Instances=new Array,V._LastCreatedScene=null,V.UseFallbackTexture=!0,V.FallbackTexture="";var G=function(e){return parseInt(e.toString().replace(/\W/g,""))},W=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;(0,m.Z)(this,e),this.x=t,this.y=i}return(0,y.Z)(e,[{key:"toString",value:function(){return"{X: ".concat(this.x," Y: ").concat(this.y,"}")}},{key:"getClassName",value:function(){return"Vector2"}},{key:"getHashCode",value:function(){var e=G(this.x);return e=397*e^G(this.y)}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e[t]=this.x,e[t+1]=this.y,this}},{key:"fromArray",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e.FromArrayToRef(t,i,this),this}},{key:"asArray",value:function(){var e=new Array;return this.toArray(e,0),e}},{key:"copyFrom",value:function(e){return this.x=e.x,this.y=e.y,this}},{key:"copyFromFloats",value:function(e,t){return this.x=e,this.y=t,this}},{key:"set",value:function(e,t){return this.copyFromFloats(e,t)}},{key:"add",value:function(e){return new this.constructor(this.x+e.x,this.y+e.y)}},{key:"addToRef",value:function(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}},{key:"addInPlace",value:function(e){return this.x+=e.x,this.y+=e.y,this}},{key:"addVector3",value:function(e){return new this.constructor(this.x+e.x,this.y+e.y)}},{key:"subtract",value:function(e){return new this.constructor(this.x-e.x,this.y-e.y)}},{key:"subtractToRef",value:function(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}},{key:"subtractInPlace",value:function(e){return this.x-=e.x,this.y-=e.y,this}},{key:"multiplyInPlace",value:function(e){return this.x*=e.x,this.y*=e.y,this}},{key:"multiply",value:function(e){return new this.constructor(this.x*e.x,this.y*e.y)}},{key:"multiplyToRef",value:function(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}},{key:"multiplyByFloats",value:function(e,t){return new this.constructor(this.x*e,this.y*t)}},{key:"divide",value:function(e){return new this.constructor(this.x/e.x,this.y/e.y)}},{key:"divideToRef",value:function(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}},{key:"divideInPlace",value:function(e){return this.divideToRef(e,this)}},{key:"negate",value:function(){return new this.constructor(-this.x,-this.y)}},{key:"negateInPlace",value:function(){return this.x*=-1,this.y*=-1,this}},{key:"negateToRef",value:function(e){return e.copyFromFloats(-1*this.x,-1*this.y)}},{key:"scaleInPlace",value:function(e){return this.x*=e,this.y*=e,this}},{key:"scale",value:function(e){var t=new this.constructor(0,0);return this.scaleToRef(e,t),t}},{key:"scaleToRef",value:function(e,t){return t.x=this.x*e,t.y=this.y*e,t}},{key:"scaleAndAddToRef",value:function(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}},{key:"equals",value:function(e){return e&&this.x===e.x&&this.y===e.y}},{key:"equalsWithEpsilon",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:D;return e&&I.WithinEpsilon(this.x,e.x,t)&&I.WithinEpsilon(this.y,e.y,t)}},{key:"floor",value:function(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}},{key:"fract",value:function(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}},{key:"rotateToRef",value:function(e,t){var i=Math.cos(e),n=Math.sin(e);return t.x=i*this.x-n*this.y,t.y=n*this.x+i*this.y,t}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalize",value:function(){return e.NormalizeToRef(this,this),this}},{key:"clone",value:function(){return new this.constructor(this.x,this.y)}}],[{key:"Zero",value:function(){return new e(0,0)}},{key:"One",value:function(){return new e(1,1)}},{key:"ZeroReadOnly",get:function(){return e._ZeroReadOnly}},{key:"FromArray",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new e(t[i],t[i+1])}},{key:"FromArrayToRef",value:function(e,t,i){return i.x=e[t],i.y=e[t+1],i}},{key:"CatmullRom",value:function(e,t,i,n,r){var s=r*r,a=r*s,o=.5*(2*t.x+(-e.x+i.x)*r+(2*e.x-5*t.x+4*i.x-n.x)*s+(-e.x+3*t.x-3*i.x+n.x)*a),l=.5*(2*t.y+(-e.y+i.y)*r+(2*e.y-5*t.y+4*i.y-n.y)*s+(-e.y+3*t.y-3*i.y+n.y)*a);return new e.constructor(o,l)}},{key:"Clamp",value:function(e,t,i){var n=e.x;n=(n=n>i.x?i.x:n)<t.x?t.x:n;var r=e.y;return r=(r=r>i.y?i.y:r)<t.y?t.y:r,new e.constructor(n,r)}},{key:"Hermite",value:function(e,t,i,n,r){var s=r*r,a=r*s,o=2*a-3*s+1,l=-2*a+3*s,u=a-2*s+r,h=a-s,c=e.x*o+i.x*l+t.x*u+n.x*h,d=e.y*o+i.y*l+t.y*u+n.y*h;return new e.constructor(c,d)}},{key:"Hermite1stDerivative",value:function(e,t,i,n,r){var s=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,n,r,s),s}},{key:"Hermite1stDerivativeToRef",value:function(e,t,i,n,r,s){var a=r*r;return s.x=6*(a-r)*e.x+(3*a-4*r+1)*t.x+6*(-a+r)*i.x+(3*a-2*r)*n.x,s.y=6*(a-r)*e.y+(3*a-4*r+1)*t.y+6*(-a+r)*i.y+(3*a-2*r)*n.y,s}},{key:"Lerp",value:function(e,t,i){var n=e.x+(t.x-e.x)*i,r=e.y+(t.y-e.y)*i;return new e.constructor(n,r)}},{key:"Dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"Normalize",value:function(e){var t=new e.constructor;return this.NormalizeToRef(e,t),t}},{key:"NormalizeToRef",value:function(e,t){var i=e.length();return 0===i||(t.x=e.x/i,t.y=e.y/i),t}},{key:"Minimize",value:function(e,t){var i=e.x<t.x?e.x:t.x,n=e.y<t.y?e.y:t.y;return new e.constructor(i,n)}},{key:"Maximize",value:function(e,t){var i=e.x>t.x?e.x:t.x,n=e.y>t.y?e.y:t.y;return new e.constructor(i,n)}},{key:"Transform",value:function(t,i){var n=new t.constructor;return e.TransformToRef(t,i,n),n}},{key:"TransformToRef",value:function(e,t,i){var n=t.m,r=e.x*n[0]+e.y*n[4]+n[12],s=e.x*n[1]+e.y*n[5]+n[13];return i.x=r,i.y=s,i}},{key:"PointInTriangle",value:function(e,t,i,n){var r=.5*(-i.y*n.x+t.y*(-i.x+n.x)+t.x*(i.y-n.y)+i.x*n.y),s=r<0?-1:1,a=(t.y*n.x-t.x*n.y+(n.y-t.y)*e.x+(t.x-n.x)*e.y)*s,o=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*s;return a>0&&o>0&&a+o<2*r*s}},{key:"Distance",value:function(t,i){return Math.sqrt(e.DistanceSquared(t,i))}},{key:"DistanceSquared",value:function(e,t){var i=e.x-t.x,n=e.y-t.y;return i*i+n*n}},{key:"Center",value:function(t,i){var n=new t.constructor;return e.CenterToRef(t,i,n)}},{key:"CenterToRef",value:function(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}},{key:"DistanceOfPointFromSegment",value:function(t,i,n){var r=e.DistanceSquared(i,n);if(0===r)return e.Distance(t,i);var s=n.subtract(i),a=Math.max(0,Math.min(1,e.Dot(t.subtract(i),s)/r)),o=i.add(s.multiplyByFloats(a,a));return e.Distance(t,o)}}]),e}();W._ZeroReadOnly=W.Zero();var z=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;(0,m.Z)(this,e),this._isDirty=!0,this._x=t,this._y=i,this._z=n}return(0,y.Z)(e,[{key:"x",get:function(){return this._x},set:function(e){this._x=e,this._isDirty=!0}},{key:"y",get:function(){return this._y},set:function(e){this._y=e,this._isDirty=!0}},{key:"z",get:function(){return this._z},set:function(e){this._z=e,this._isDirty=!0}},{key:"toString",value:function(){return"{X: ".concat(this._x," Y: ").concat(this._y," Z: ").concat(this._z,"}")}},{key:"getClassName",value:function(){return"Vector3"}},{key:"getHashCode",value:function(){var e=G(this._x);return e=397*(e=397*e^G(this._y))^G(this._z)}},{key:"asArray",value:function(){var e=[];return this.toArray(e,0),e}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}},{key:"fromArray",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e.FromArrayToRef(t,i,this),this}},{key:"toQuaternion",value:function(){return H.RotationYawPitchRoll(this._y,this._x,this._z)}},{key:"addInPlace",value:function(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)}},{key:"addInPlaceFromFloats",value:function(e,t,i){return this.x+=e,this.y+=t,this.z+=i,this}},{key:"add",value:function(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z)}},{key:"addToRef",value:function(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}},{key:"subtractInPlace",value:function(e){return this.x-=e._x,this.y-=e._y,this.z-=e._z,this}},{key:"subtract",value:function(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z)}},{key:"subtractToRef",value:function(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}},{key:"subtractFromFloats",value:function(e,t,i){return new this.constructor(this._x-e,this._y-t,this._z-i)}},{key:"subtractFromFloatsToRef",value:function(e,t,i,n){return n.copyFromFloats(this._x-e,this._y-t,this._z-i)}},{key:"negate",value:function(){return new this.constructor(-this._x,-this._y,-this._z)}},{key:"negateInPlace",value:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this}},{key:"negateToRef",value:function(e){return e.copyFromFloats(-1*this._x,-1*this._y,-1*this._z)}},{key:"scaleInPlace",value:function(e){return this.x*=e,this.y*=e,this.z*=e,this}},{key:"scale",value:function(e){return new this.constructor(this._x*e,this._y*e,this._z*e)}},{key:"scaleToRef",value:function(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)}},{key:"getNormalToRef",value:function(e){var t=this.length(),i=Math.acos(this.y/t),n=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;var r=t*Math.sin(i)*Math.cos(n),s=t*Math.cos(i),a=t*Math.sin(i)*Math.sin(n);return e.set(r,s,a),e}},{key:"applyRotationQuaternionToRef",value:function(e,t){var i=e.w*this.x+e.y*this.z-e.z*this.y,n=e.w*this.y+e.z*this.x-e.x*this.z,r=e.w*this.z+e.x*this.y-e.y*this.x,s=-e.x*this.x-e.y*this.y-e.z*this.z;return t.x=i*e.w+s*-e.x+n*-e.z-r*-e.y,t.y=n*e.w+s*-e.y+r*-e.x-i*-e.z,t.z=r*e.w+s*-e.z+i*-e.y-n*-e.x,t}},{key:"applyRotationQuaternionInPlace",value:function(e){return this.applyRotationQuaternionToRef(e,this)}},{key:"applyRotationQuaternion",value:function(e){return this.applyRotationQuaternionToRef(e,new this.constructor)}},{key:"scaleAndAddToRef",value:function(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}},{key:"projectOnPlane",value:function(e,t){var i=new this.constructor;return this.projectOnPlaneToRef(e,t,i),i}},{key:"projectOnPlaneToRef",value:function(t,i,n){var r=t.normal,s=t.d,a=K.Vector3[0];this.subtractToRef(i,a),a.normalize();var o=e.Dot(a,r);if(Math.abs(o)<Math.pow(10,-10))n.setAll(1/0);else{var l=-(e.Dot(i,r)+s)/o,u=a.scaleInPlace(l);i.addToRef(u,n)}return n}},{key:"equals",value:function(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}},{key:"equalsWithEpsilon",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:D;return e&&I.WithinEpsilon(this._x,e._x,t)&&I.WithinEpsilon(this._y,e._y,t)&&I.WithinEpsilon(this._z,e._z,t)}},{key:"equalsToFloats",value:function(e,t,i){return this._x===e&&this._y===t&&this._z===i}},{key:"multiplyInPlace",value:function(e){return this.x*=e._x,this.y*=e._y,this.z*=e._z,this}},{key:"multiply",value:function(e){return this.multiplyByFloats(e._x,e._y,e._z)}},{key:"multiplyToRef",value:function(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}},{key:"multiplyByFloats",value:function(e,t,i){return new this.constructor(this._x*e,this._y*t,this._z*i)}},{key:"divide",value:function(e){return new this.constructor(this._x/e._x,this._y/e._y,this._z/e._z)}},{key:"divideToRef",value:function(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}},{key:"divideInPlace",value:function(e){return this.divideToRef(e,this)}},{key:"minimizeInPlace",value:function(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}},{key:"maximizeInPlace",value:function(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}},{key:"minimizeInPlaceFromFloats",value:function(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}},{key:"maximizeInPlaceFromFloats",value:function(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}},{key:"isNonUniformWithinEpsilon",value:function(e){var t=Math.abs(this._x),i=Math.abs(this._y);if(!I.WithinEpsilon(t,i,e))return!0;var n=Math.abs(this._z);return!I.WithinEpsilon(t,n,e)||!I.WithinEpsilon(i,n,e)}},{key:"isNonUniform",get:function(){var e=Math.abs(this._x);return e!==Math.abs(this._y)||e!==Math.abs(this._z)}},{key:"floor",value:function(){return new this.constructor(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}},{key:"fract",value:function(){return new this.constructor(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}},{key:"length",value:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}},{key:"lengthSquared",value:function(){return this._x*this._x+this._y*this._y+this._z*this._z}},{key:"hasAZeroComponent",get:function(){return this._x*this._y*this._z===0}},{key:"normalize",value:function(){return this.normalizeFromLength(this.length())}},{key:"reorderInPlace",value:function(e){var t=this;return"xyz"===(e=e.toLowerCase())||(K.Vector3[0].copyFrom(this),["x","y","z"].forEach((function(i,n){t[i]=K.Vector3[0][e[n]]}))),this}},{key:"rotateByQuaternionToRef",value:function(t,i){return t.toRotationMatrix(K.Matrix[0]),e.TransformCoordinatesToRef(this,K.Matrix[0],i),i}},{key:"rotateByQuaternionAroundPointToRef",value:function(e,t,i){return this.subtractToRef(t,K.Vector3[0]),K.Vector3[0].rotateByQuaternionToRef(e,K.Vector3[0]),t.addToRef(K.Vector3[0],i),i}},{key:"cross",value:function(t){var i=new this.constructor;return e.CrossToRef(this,t,i)}},{key:"normalizeFromLength",value:function(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}},{key:"normalizeToNew",value:function(){var e=new this.constructor(0,0,0);return this.normalizeToRef(e),e}},{key:"normalizeToRef",value:function(e){var t=this.length();return 0===t||1===t?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)}},{key:"clone",value:function(){return new this.constructor(this._x,this._y,this._z)}},{key:"copyFrom",value:function(e){return this.copyFromFloats(e._x,e._y,e._z)}},{key:"copyFromFloats",value:function(e,t,i){return this.x=e,this.y=t,this.z=i,this}},{key:"set",value:function(e,t,i){return this.copyFromFloats(e,t,i)}},{key:"setAll",value:function(e){return this.x=this.y=this.z=e,this}}],[{key:"GetClipFactor",value:function(t,i,n,r){var s=e.Dot(t,n)-r;return s/(s-(e.Dot(i,n)-r))}},{key:"GetAngleBetweenVectors",value:function(t,i,n){var r=t.normalizeToRef(K.Vector3[1]),s=i.normalizeToRef(K.Vector3[2]),a=e.Dot(r,s);a=I.Clamp(a,-1,1);var o=Math.acos(a),l=K.Vector3[3];return e.CrossToRef(r,s,l),e.Dot(l,n)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(a)}},{key:"GetAngleBetweenVectorsOnPlane",value:function(t,i,n){K.Vector3[0].copyFrom(t);var r=K.Vector3[0];K.Vector3[1].copyFrom(i);var s=K.Vector3[1];K.Vector3[2].copyFrom(n);var a=K.Vector3[2],o=K.Vector3[3],l=K.Vector3[4];r.normalize(),s.normalize(),a.normalize(),e.CrossToRef(a,r,o),e.CrossToRef(o,a,l);var u=Math.atan2(e.Dot(s,o),e.Dot(s,l));return I.NormalizeRadians(u)}},{key:"PitchYawRollToMoveBetweenPointsToRef",value:function(e,t,i){var n=Y.Vector3[0];return t.subtractToRef(e,n),i.y=Math.atan2(n.x,n.z)||0,i.x=Math.atan2(Math.sqrt(Math.pow(n.x,2)+Math.pow(n.z,2)),n.y)||0,i.z=0,i}},{key:"PitchYawRollToMoveBetweenPoints",value:function(t,i){var n=e.Zero();return e.PitchYawRollToMoveBetweenPointsToRef(t,i,n)}},{key:"SlerpToRef",value:function(t,i,n,r){n=I.Clamp(n,0,1);var s=K.Vector3[0],a=K.Vector3[1];s.copyFrom(t);var o=s.length();s.normalizeFromLength(o),a.copyFrom(i);var l=a.length();a.normalizeFromLength(l);var u,h,c=e.Dot(s,a);if(c<1-D){var d=Math.acos(c),f=1/Math.sin(d);u=Math.sin((1-n)*d)*f,h=Math.sin(n*d)*f}else u=1-n,h=n;return s.scaleInPlace(u),a.scaleInPlace(h),r.copyFrom(s).addInPlace(a),r.scaleInPlace(I.Lerp(o,l,n)),r}},{key:"SmoothToRef",value:function(t,i,n,r,s){return e.SlerpToRef(t,i,0===r?1:n/r,s),s}},{key:"FromArray",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new e(t[i],t[i+1],t[i+2])}},{key:"FromFloatArray",value:function(t,i){return e.FromArray(t,i)}},{key:"FromArrayToRef",value:function(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i}},{key:"FromFloatArrayToRef",value:function(t,i,n){return e.FromArrayToRef(t,i,n)}},{key:"FromFloatsToRef",value:function(e,t,i,n){return n.copyFromFloats(e,t,i),n}},{key:"Zero",value:function(){return new e(0,0,0)}},{key:"One",value:function(){return new e(1,1,1)}},{key:"Up",value:function(){return new e(0,1,0)}},{key:"UpReadOnly",get:function(){return e._UpReadOnly}},{key:"DownReadOnly",get:function(){return e._DownReadOnly}},{key:"RightReadOnly",get:function(){return e._RightReadOnly}},{key:"LeftReadOnly",get:function(){return e._LeftReadOnly}},{key:"LeftHandedForwardReadOnly",get:function(){return e._LeftHandedForwardReadOnly}},{key:"RightHandedForwardReadOnly",get:function(){return e._RightHandedForwardReadOnly}},{key:"ZeroReadOnly",get:function(){return e._ZeroReadOnly}},{key:"Down",value:function(){return new e(0,-1,0)}},{key:"Forward",value:function(){return new e(0,0,arguments.length>0&&void 0!==arguments[0]&&arguments[0]?-1:1)}},{key:"Backward",value:function(){return new e(0,0,arguments.length>0&&void 0!==arguments[0]&&arguments[0]?1:-1)}},{key:"Right",value:function(){return new e(1,0,0)}},{key:"Left",value:function(){return new e(-1,0,0)}},{key:"TransformCoordinates",value:function(t,i){var n=e.Zero();return e.TransformCoordinatesToRef(t,i,n),n}},{key:"TransformCoordinatesToRef",value:function(t,i,n){return e.TransformCoordinatesFromFloatsToRef(t._x,t._y,t._z,i,n),n}},{key:"TransformCoordinatesFromFloatsToRef",value:function(e,t,i,n,r){var s=n.m,a=e*s[0]+t*s[4]+i*s[8]+s[12],o=e*s[1]+t*s[5]+i*s[9]+s[13],l=e*s[2]+t*s[6]+i*s[10]+s[14],u=1/(e*s[3]+t*s[7]+i*s[11]+s[15]);return r.x=a*u,r.y=o*u,r.z=l*u,r}},{key:"TransformNormal",value:function(t,i){var n=e.Zero();return e.TransformNormalToRef(t,i,n),n}},{key:"TransformNormalToRef",value:function(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}},{key:"TransformNormalFromFloatsToRef",value:function(e,t,i,n,r){var s=n.m;return r.x=e*s[0]+t*s[4]+i*s[8],r.y=e*s[1]+t*s[5]+i*s[9],r.z=e*s[2]+t*s[6]+i*s[10],r}},{key:"CatmullRom",value:function(e,t,i,n,r){var s=r*r,a=r*s,o=.5*(2*t._x+(-e._x+i._x)*r+(2*e._x-5*t._x+4*i._x-n._x)*s+(-e._x+3*t._x-3*i._x+n._x)*a),l=.5*(2*t._y+(-e._y+i._y)*r+(2*e._y-5*t._y+4*i._y-n._y)*s+(-e._y+3*t._y-3*i._y+n._y)*a),u=.5*(2*t._z+(-e._z+i._z)*r+(2*e._z-5*t._z+4*i._z-n._z)*s+(-e._z+3*t._z-3*i._z+n._z)*a);return new e.constructor(o,l,u)}},{key:"Clamp",value:function(t,i,n){var r=new t.constructor;return e.ClampToRef(t,i,n,r),r}},{key:"ClampToRef",value:function(e,t,i,n){var r=e._x;r=(r=r>i._x?i._x:r)<t._x?t._x:r;var s=e._y;s=(s=s>i._y?i._y:s)<t._y?t._y:s;var a=e._z;return a=(a=a>i._z?i._z:a)<t._z?t._z:a,n.copyFromFloats(r,s,a),n}},{key:"CheckExtends",value:function(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}},{key:"Hermite",value:function(e,t,i,n,r){var s=r*r,a=r*s,o=2*a-3*s+1,l=-2*a+3*s,u=a-2*s+r,h=a-s,c=e._x*o+i._x*l+t._x*u+n._x*h,d=e._y*o+i._y*l+t._y*u+n._y*h,f=e._z*o+i._z*l+t._z*u+n._z*h;return new e.constructor(c,d,f)}},{key:"Hermite1stDerivative",value:function(e,t,i,n,r){var s=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,n,r,s),s}},{key:"Hermite1stDerivativeToRef",value:function(e,t,i,n,r,s){var a=r*r;return s.x=6*(a-r)*e.x+(3*a-4*r+1)*t.x+6*(-a+r)*i.x+(3*a-2*r)*n.x,s.y=6*(a-r)*e.y+(3*a-4*r+1)*t.y+6*(-a+r)*i.y+(3*a-2*r)*n.y,s.z=6*(a-r)*e.z+(3*a-4*r+1)*t.z+6*(-a+r)*i.z+(3*a-2*r)*n.z,s}},{key:"Lerp",value:function(t,i,n){var r=new t.constructor(0,0,0);return e.LerpToRef(t,i,n,r),r}},{key:"LerpToRef",value:function(e,t,i,n){return n.x=e._x+(t._x-e._x)*i,n.y=e._y+(t._y-e._y)*i,n.z=e._z+(t._z-e._z)*i,n}},{key:"Dot",value:function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}},{key:"Cross",value:function(t,i){var n=new t.constructor;return e.CrossToRef(t,i,n),n}},{key:"CrossToRef",value:function(e,t,i){var n=e._y*t._z-e._z*t._y,r=e._z*t._x-e._x*t._z,s=e._x*t._y-e._y*t._x;return i.copyFromFloats(n,r,s),i}},{key:"Normalize",value:function(t){var i=e.Zero();return e.NormalizeToRef(t,i),i}},{key:"NormalizeToRef",value:function(e,t){return e.normalizeToRef(t),t}},{key:"Project",value:function(t,i,n,r){var s=new t.constructor;return e.ProjectToRef(t,i,n,r,s),s}},{key:"ProjectToRef",value:function(t,i,n,r,s){var a=r.width,o=r.height,l=r.x,u=r.y,h=K.Matrix[1];Z.FromValuesToRef(a/2,0,0,0,0,-o/2,0,0,0,0,.5,0,l+a/2,o/2+u,.5,1,h);var c=K.Matrix[0];return i.multiplyToRef(n,c),c.multiplyToRef(h,c),e.TransformCoordinatesToRef(t,c,s),s}},{key:"Reflect",value:function(t,i){return this.ReflectToRef(t,i,new e)}},{key:"ReflectToRef",value:function(t,i,n){var r=Y.Vector3[0];return r.copyFrom(i).scaleInPlace(2*e.Dot(t,i)),n.copyFrom(t).subtractInPlace(r)}},{key:"_UnprojectFromInvertedMatrixToRef",value:function(t,i,n){e.TransformCoordinatesToRef(t,i,n);var r=i.m,s=t._x*r[3]+t._y*r[7]+t._z*r[11]+r[15];return I.WithinEpsilon(s,1)&&n.scaleInPlace(1/s),n}},{key:"UnprojectFromTransform",value:function(e,t,i,n,r){return this.Unproject(e,t,i,n,r,Z.IdentityReadOnly)}},{key:"Unproject",value:function(t,i,n,r,s,a){var o=new t.constructor;return e.UnprojectToRef(t,i,n,r,s,a,o),o}},{key:"UnprojectToRef",value:function(t,i,n,r,s,a,o){return e.UnprojectFloatsToRef(t._x,t._y,t._z,i,n,r,s,a,o),o}},{key:"UnprojectFloatsToRef",value:function(t,i,n,r,s,a,o,l,u){var h,c=K.Matrix[0];a.multiplyToRef(o,c),c.multiplyToRef(l,c),c.invert();var d=K.Vector3[0];return d.x=t/r*2-1,d.y=-(i/s*2-1),null!==(h=V.LastCreatedEngine)&&void 0!==h&&h.isNDCHalfZRange?d.z=n:d.z=2*n-1,e._UnprojectFromInvertedMatrixToRef(d,c,u),u}},{key:"Minimize",value:function(e,t){var i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}},{key:"Maximize",value:function(e,t){var i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}},{key:"Distance",value:function(t,i){return Math.sqrt(e.DistanceSquared(t,i))}},{key:"DistanceSquared",value:function(e,t){var i=e._x-t._x,n=e._y-t._y,r=e._z-t._z;return i*i+n*n+r*r}},{key:"ProjectOnTriangleToRef",value:function(t,i,n,r,s){var a=K.Vector3[0],o=K.Vector3[1],l=K.Vector3[2],u=K.Vector3[3],h=K.Vector3[4];n.subtractToRef(i,a),r.subtractToRef(i,o),r.subtractToRef(n,l);var c=a.length(),d=o.length(),f=l.length();if(c<D||d<D||f<D)return s.copyFrom(i),e.Distance(t,i);t.subtractToRef(i,h),e.CrossToRef(a,o,u);var _=u.length();if(_<D)return s.copyFrom(i),e.Distance(t,i);u.normalizeFromLength(_);var v=h.length();if(v<D)return s.copyFrom(i),0;h.normalizeFromLength(v);var g=e.Dot(u,h),p=K.Vector3[5],m=K.Vector3[6];p.copyFrom(u).scaleInPlace(-v*g),m.copyFrom(t).addInPlace(p);var y=K.Vector3[4],T=K.Vector3[5],E=K.Vector3[7],S=K.Vector3[8];y.copyFrom(a).scaleInPlace(1/c),S.copyFrom(o).scaleInPlace(1/d),y.addInPlace(S).scaleInPlace(-1),T.copyFrom(a).scaleInPlace(-1/c),S.copyFrom(l).scaleInPlace(1/f),T.addInPlace(S).scaleInPlace(-1),E.copyFrom(l).scaleInPlace(-1/f),S.copyFrom(o).scaleInPlace(-1/d),E.addInPlace(S).scaleInPlace(-1);var b=K.Vector3[9];b.copyFrom(m).subtractInPlace(i),e.CrossToRef(y,b,S);var x=e.Dot(S,u);b.copyFrom(m).subtractInPlace(n),e.CrossToRef(T,b,S);var M=e.Dot(S,u);b.copyFrom(m).subtractInPlace(r),e.CrossToRef(E,b,S);var A,R,C=e.Dot(S,u),P=K.Vector3[10];x>0&&M<0?(P.copyFrom(a),A=i,R=n):M>0&&C<0?(P.copyFrom(l),A=n,R=r):(P.copyFrom(o).scaleInPlace(-1),A=r,R=i);var k=K.Vector3[9],F=K.Vector3[4];if(A.subtractToRef(m,S),R.subtractToRef(m,k),e.CrossToRef(S,k,F),!(e.Dot(F,u)<0))return s.copyFrom(m),Math.abs(v*g);var w=K.Vector3[5];e.CrossToRef(P,F,w),w.normalize();var O=K.Vector3[9];O.copyFrom(A).subtractInPlace(m);var L=O.length();if(L<D)return s.copyFrom(A),e.Distance(t,A);O.normalizeFromLength(L);var N=e.Dot(w,O),B=K.Vector3[7];B.copyFrom(m).addInPlace(w.scaleInPlace(L*N)),S.copyFrom(B).subtractInPlace(A),v=P.length(),P.normalizeFromLength(v);var U=e.Dot(S,P)/Math.max(v,D);return U=I.Clamp(U,0,1),B.copyFrom(A).addInPlace(P.scaleInPlace(U*v)),s.copyFrom(B),e.Distance(t,B)}},{key:"Center",value:function(t,i){return e.CenterToRef(t,i,e.Zero())}},{key:"CenterToRef",value:function(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}},{key:"RotationFromAxis",value:function(t,i,n){var r=new t.constructor;return e.RotationFromAxisToRef(t,i,n,r),r}},{key:"RotationFromAxisToRef",value:function(e,t,i,n){var r=K.Quaternion[0];return H.RotationQuaternionFromAxisToRef(e,t,i,r),r.toEulerAnglesToRef(n),n}}]),e}();z._UpReadOnly=z.Up(),z._DownReadOnly=z.Down(),z._LeftHandedForwardReadOnly=z.Forward(!1),z._RightHandedForwardReadOnly=z.Forward(!0),z._RightReadOnly=z.Right(),z._LeftReadOnly=z.Left(),z._ZeroReadOnly=z.Zero();var X=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;(0,m.Z)(this,e),this.x=t,this.y=i,this.z=n,this.w=r}return(0,y.Z)(e,[{key:"toString",value:function(){return"{X: ".concat(this.x," Y: ").concat(this.y," Z: ").concat(this.z," W: ").concat(this.w,"}")}},{key:"getClassName",value:function(){return"Vector4"}},{key:"getHashCode",value:function(){var e=G(this.x);return e=397*(e=397*(e=397*e^G(this.y))^G(this.z))^G(this.w)}},{key:"asArray",value:function(){var e=new Array;return this.toArray(e,0),e}},{key:"toArray",value:function(e,t){return void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}},{key:"fromArray",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e.FromArrayToRef(t,i,this),this}},{key:"addInPlace",value:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}},{key:"add",value:function(e){return new this.constructor(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}},{key:"addToRef",value:function(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}},{key:"subtractInPlace",value:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}},{key:"subtract",value:function(e){return new this.constructor(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}},{key:"subtractToRef",value:function(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}},{key:"subtractFromFloats",value:function(e,t,i,n){return new this.constructor(this.x-e,this.y-t,this.z-i,this.w-n)}},{key:"subtractFromFloatsToRef",value:function(e,t,i,n,r){return r.x=this.x-e,r.y=this.y-t,r.z=this.z-i,r.w=this.w-n,r}},{key:"negate",value:function(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}},{key:"negateInPlace",value:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}},{key:"negateToRef",value:function(e){return e.copyFromFloats(-1*this.x,-1*this.y,-1*this.z,-1*this.w)}},{key:"scaleInPlace",value:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}},{key:"scale",value:function(e){return new this.constructor(this.x*e,this.y*e,this.z*e,this.w*e)}},{key:"scaleToRef",value:function(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}},{key:"scaleAndAddToRef",value:function(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}},{key:"equals",value:function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"equalsWithEpsilon",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:D;return e&&I.WithinEpsilon(this.x,e.x,t)&&I.WithinEpsilon(this.y,e.y,t)&&I.WithinEpsilon(this.z,e.z,t)&&I.WithinEpsilon(this.w,e.w,t)}},{key:"equalsToFloats",value:function(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}},{key:"multiplyInPlace",value:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}},{key:"multiply",value:function(e){return new this.constructor(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}},{key:"multiplyToRef",value:function(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}},{key:"multiplyByFloats",value:function(e,t,i,n){return new this.constructor(this.x*e,this.y*t,this.z*i,this.w*n)}},{key:"divide",value:function(e){return new this.constructor(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}},{key:"divideToRef",value:function(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}},{key:"divideInPlace",value:function(e){return this.divideToRef(e,this)}},{key:"minimizeInPlace",value:function(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}},{key:"maximizeInPlace",value:function(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}},{key:"floor",value:function(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}},{key:"fract",value:function(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"normalize",value:function(){var e=this.length();return 0===e?this:this.scaleInPlace(1/e)}},{key:"toVector3",value:function(){return new z(this.x,this.y,this.z)}},{key:"clone",value:function(){return new this.constructor(this.x,this.y,this.z,this.w)}},{key:"copyFrom",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}},{key:"copyFromFloats",value:function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}},{key:"set",value:function(e,t,i,n){return this.copyFromFloats(e,t,i,n)}},{key:"setAll",value:function(e){return this.x=this.y=this.z=this.w=e,this}}],[{key:"FromArray",value:function(t,i){return i||(i=0),new e(t[i],t[i+1],t[i+2],t[i+3])}},{key:"FromArrayToRef",value:function(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}},{key:"FromFloatArrayToRef",value:function(t,i,n){return e.FromArrayToRef(t,i,n),n}},{key:"FromFloatsToRef",value:function(e,t,i,n,r){return r.x=e,r.y=t,r.z=i,r.w=n,r}},{key:"Zero",value:function(){return new e(0,0,0,0)}},{key:"One",value:function(){return new e(1,1,1,1)}},{key:"ZeroReadOnly",get:function(){return e._ZeroReadOnly}},{key:"Normalize",value:function(t){var i=e.Zero();return e.NormalizeToRef(t,i),i}},{key:"NormalizeToRef",value:function(e,t){return t.copyFrom(e),t.normalize(),t}},{key:"Minimize",value:function(e,t){var i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}},{key:"Maximize",value:function(e,t){var i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}},{key:"Distance",value:function(t,i){return Math.sqrt(e.DistanceSquared(t,i))}},{key:"DistanceSquared",value:function(e,t){var i=e.x-t.x,n=e.y-t.y,r=e.z-t.z,s=e.w-t.w;return i*i+n*n+r*r+s*s}},{key:"Center",value:function(t,i){return e.CenterToRef(t,i,e.Zero())}},{key:"CenterToRef",value:function(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}},{key:"TransformCoordinates",value:function(t,i){var n=e.Zero();return e.TransformCoordinatesToRef(t,i,n),n}},{key:"TransformCoordinatesToRef",value:function(t,i,n){return e.TransformCoordinatesFromFloatsToRef(t._x,t._y,t._z,i,n),n}},{key:"TransformCoordinatesFromFloatsToRef",value:function(e,t,i,n,r){var s=n.m,a=e*s[0]+t*s[4]+i*s[8]+s[12],o=e*s[1]+t*s[5]+i*s[9]+s[13],l=e*s[2]+t*s[6]+i*s[10]+s[14],u=e*s[3]+t*s[7]+i*s[11]+s[15];return r.x=a,r.y=o,r.z=l,r.w=u,r}},{key:"TransformNormal",value:function(t,i){var n=new t.constructor;return e.TransformNormalToRef(t,i,n),n}},{key:"TransformNormalToRef",value:function(e,t,i){var n=t.m,r=e.x*n[0]+e.y*n[4]+e.z*n[8],s=e.x*n[1]+e.y*n[5]+e.z*n[9],a=e.x*n[2]+e.y*n[6]+e.z*n[10];return i.x=r,i.y=s,i.z=a,i.w=e.w,i}},{key:"TransformNormalFromFloatsToRef",value:function(e,t,i,n,r,s){var a=r.m;return s.x=e*a[0]+t*a[4]+i*a[8],s.y=e*a[1]+t*a[5]+i*a[9],s.z=e*a[2]+t*a[6]+i*a[10],s.w=n,s}},{key:"FromVector3",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new e(t._x,t._y,t._z,i)}}]),e}();X._ZeroReadOnly=X.Zero();var H=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;(0,m.Z)(this,e),this._isDirty=!0,this._x=t,this._y=i,this._z=n,this._w=r}return(0,y.Z)(e,[{key:"x",get:function(){return this._x},set:function(e){this._x=e,this._isDirty=!0}},{key:"y",get:function(){return this._y},set:function(e){this._y=e,this._isDirty=!0}},{key:"z",get:function(){return this._z},set:function(e){this._z=e,this._isDirty=!0}},{key:"w",get:function(){return this._w},set:function(e){this._w=e,this._isDirty=!0}},{key:"toString",value:function(){return"{X: ".concat(this._x," Y: ").concat(this._y," Z: ").concat(this._z," W: ").concat(this._w,"}")}},{key:"getClassName",value:function(){return"Quaternion"}},{key:"getHashCode",value:function(){var e=G(this._x);return e=397*(e=397*(e=397*e^G(this._y))^G(this._z))^G(this._w)}},{key:"asArray",value:function(){return[this._x,this._y,this._z,this._w]}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}},{key:"equals",value:function(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}},{key:"equalsWithEpsilon",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:D;return e&&I.WithinEpsilon(this._x,e._x,t)&&I.WithinEpsilon(this._y,e._y,t)&&I.WithinEpsilon(this._z,e._z,t)&&I.WithinEpsilon(this._w,e._w,t)}},{key:"clone",value:function(){return new this.constructor(this._x,this._y,this._z,this._w)}},{key:"copyFrom",value:function(e){return this.x=e._x,this.y=e._y,this.z=e._z,this.w=e._w,this}},{key:"copyFromFloats",value:function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}},{key:"set",value:function(e,t,i,n){return this.copyFromFloats(e,t,i,n)}},{key:"add",value:function(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}},{key:"addInPlace",value:function(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this}},{key:"subtract",value:function(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}},{key:"subtractInPlace",value:function(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this}},{key:"scale",value:function(e){return new this.constructor(this._x*e,this._y*e,this._z*e,this._w*e)}},{key:"scaleToRef",value:function(e,t){return t.x=this._x*e,t.y=this._y*e,t.z=this._z*e,t.w=this._w*e,t}},{key:"scaleInPlace",value:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}},{key:"scaleAndAddToRef",value:function(e,t){return t.x+=this._x*e,t.y+=this._y*e,t.z+=this._z*e,t.w+=this._w*e,t}},{key:"multiply",value:function(e){var t=new this.constructor(0,0,0,1);return this.multiplyToRef(e,t),t}},{key:"multiplyToRef",value:function(e,t){var i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,n=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,r=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,s=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,n,r,s),t}},{key:"multiplyInPlace",value:function(e){return this.multiplyToRef(e,this),this}},{key:"conjugateToRef",value:function(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}},{key:"conjugateInPlace",value:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this}},{key:"conjugate",value:function(){return new this.constructor(-this._x,-this._y,-this._z,this._w)}},{key:"invert",value:function(){var e=this.conjugate(),t=this.lengthSquared();return 0==t||1==t||e.scaleInPlace(1/t),e}},{key:"invertInPlace",value:function(){this.conjugateInPlace();var e=this.lengthSquared();return 0==e||1==e||this.scaleInPlace(1/e),this}},{key:"lengthSquared",value:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}},{key:"length",value:function(){return Math.sqrt(this.lengthSquared())}},{key:"normalize",value:function(){var e=this.length();if(0===e)return this;var t=1/e;return this.scaleInPlace(t),this}},{key:"normalizeToNew",value:function(){var e=this.length();if(0===e)return this.clone();var t=1/e;return this.scale(t)}},{key:"toEulerAngles",value:function(){var e=z.Zero();return this.toEulerAnglesToRef(e),e}},{key:"toEulerAnglesToRef",value:function(e){var t=this._z,i=this._x,n=this._y,r=this._w,s=n*t-i*r,a=.4999999;if(s<-a)e.y=2*Math.atan2(n,r),e.x=Math.PI/2,e.z=0;else if(s>a)e.y=2*Math.atan2(n,r),e.x=-Math.PI/2,e.z=0;else{var o=r*r,l=t*t,u=i*i,h=n*n;e.z=Math.atan2(2*(i*n+t*r),-l-u+h+o),e.x=Math.asin(-2*s),e.y=Math.atan2(2*(t*i+n*r),l-u-h+o)}return e}},{key:"toRotationMatrix",value:function(e){return Z.FromQuaternionToRef(this,e),e}},{key:"fromRotationMatrix",value:function(t){return e.FromRotationMatrixToRef(t,this),this}}],[{key:"FromRotationMatrix",value:function(t){var i=new e;return e.FromRotationMatrixToRef(t,i),i}},{key:"FromRotationMatrixToRef",value:function(e,t){var i,n=e.m,r=n[0],s=n[4],a=n[8],o=n[1],l=n[5],u=n[9],h=n[2],c=n[6],d=n[10],f=r+l+d;return f>0?(i=.5/Math.sqrt(f+1),t.w=.25/i,t.x=(c-u)*i,t.y=(a-h)*i,t.z=(o-s)*i):r>l&&r>d?(i=2*Math.sqrt(1+r-l-d),t.w=(c-u)/i,t.x=.25*i,t.y=(s+o)/i,t.z=(a+h)/i):l>d?(i=2*Math.sqrt(1+l-r-d),t.w=(a-h)/i,t.x=(s+o)/i,t.y=.25*i,t.z=(u+c)/i):(i=2*Math.sqrt(1+d-r-l),t.w=(o-s)/i,t.x=(a+h)/i,t.y=(u+c)/i,t.z=.25*i),t}},{key:"Dot",value:function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}},{key:"AreClose",value:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.1,r=e.Dot(t,i);return 1-r*r<=n}},{key:"SmoothToRef",value:function(t,i,n,r,s){var a=0===r?1:n/r;return a=I.Clamp(a,0,1),e.SlerpToRef(t,i,a,s),s}},{key:"Zero",value:function(){return new e(0,0,0,0)}},{key:"Inverse",value:function(e){return new e.constructor(-e._x,-e._y,-e._z,e._w)}},{key:"InverseToRef",value:function(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}},{key:"Identity",value:function(){return new e(0,0,0,1)}},{key:"IsIdentity",value:function(e){return e&&0===e._x&&0===e._y&&0===e._z&&1===e._w}},{key:"RotationAxis",value:function(t,i){return e.RotationAxisToRef(t,i,new e)}},{key:"RotationAxisToRef",value:function(e,t,i){var n=Math.sin(t/2);return e.normalize(),i.w=Math.cos(t/2),i.x=e._x*n,i.y=e._y*n,i.z=e._z*n,i}},{key:"FromArray",value:function(t,i){return i||(i=0),new e(t[i],t[i+1],t[i+2],t[i+3])}},{key:"FromArrayToRef",value:function(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}},{key:"FromEulerAngles",value:function(t,i,n){var r=new e;return e.RotationYawPitchRollToRef(i,t,n,r),r}},{key:"FromEulerAnglesToRef",value:function(t,i,n,r){return e.RotationYawPitchRollToRef(i,t,n,r),r}},{key:"FromEulerVector",value:function(t){var i=new e;return e.RotationYawPitchRollToRef(t._y,t._x,t._z,i),i}},{key:"FromEulerVectorToRef",value:function(t,i){return e.RotationYawPitchRollToRef(t._y,t._x,t._z,i),i}},{key:"FromUnitVectorsToRef",value:function(e,t,i){var n=z.Dot(e,t)+1;return n<D?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(z.CrossToRef(e,t,Y.Vector3[0]),i.set(Y.Vector3[0].x,Y.Vector3[0].y,Y.Vector3[0].z,n)),i.normalize()}},{key:"RotationYawPitchRoll",value:function(t,i,n){var r=new e;return e.RotationYawPitchRollToRef(t,i,n,r),r}},{key:"RotationYawPitchRollToRef",value:function(e,t,i,n){var r=.5*i,s=.5*t,a=.5*e,o=Math.sin(r),l=Math.cos(r),u=Math.sin(s),h=Math.cos(s),c=Math.sin(a),d=Math.cos(a);return n.x=d*u*l+c*h*o,n.y=c*h*l-d*u*o,n.z=d*h*o-c*u*l,n.w=d*h*l+c*u*o,n}},{key:"RotationAlphaBetaGamma",value:function(t,i,n){var r=new e;return e.RotationAlphaBetaGammaToRef(t,i,n,r),r}},{key:"RotationAlphaBetaGammaToRef",value:function(e,t,i,n){var r=.5*(i+e),s=.5*(i-e),a=.5*t;return n.x=Math.cos(s)*Math.sin(a),n.y=Math.sin(s)*Math.sin(a),n.z=Math.sin(r)*Math.cos(a),n.w=Math.cos(r)*Math.cos(a),n}},{key:"RotationQuaternionFromAxis",value:function(t,i,n){var r=new e(0,0,0,0);return e.RotationQuaternionFromAxisToRef(t,i,n,r),r}},{key:"RotationQuaternionFromAxisToRef",value:function(t,i,n,r){var s=K.Matrix[0];return Z.FromXYZAxesToRef(t.normalize(),i.normalize(),n.normalize(),s),e.FromRotationMatrixToRef(s,r),r}},{key:"FromLookDirectionLH",value:function(t,i){var n=new e;return e.FromLookDirectionLHToRef(t,i,n),n}},{key:"FromLookDirectionLHToRef",value:function(t,i,n){var r=K.Matrix[0];return Z.LookDirectionLHToRef(t,i,r),e.FromRotationMatrixToRef(r,n),n}},{key:"FromLookDirectionRH",value:function(t,i){var n=new e;return e.FromLookDirectionRHToRef(t,i,n),n}},{key:"FromLookDirectionRHToRef",value:function(t,i,n){var r=K.Matrix[0];return Z.LookDirectionRHToRef(t,i,r),e.FromRotationMatrixToRef(r,n)}},{key:"Slerp",value:function(t,i,n){var r=e.Identity();return e.SlerpToRef(t,i,n,r),r}},{key:"SlerpToRef",value:function(e,t,i,n){var r,s,a=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,o=!1;if(a<0&&(o=!0,a=-a),a>.999999)s=1-i,r=o?-i:i;else{var l=Math.acos(a),u=1/Math.sin(l);s=Math.sin((1-i)*l)*u,r=o?-Math.sin(i*l)*u:Math.sin(i*l)*u}return n.x=s*e._x+r*t._x,n.y=s*e._y+r*t._y,n.z=s*e._z+r*t._z,n.w=s*e._w+r*t._w,n}},{key:"Hermite",value:function(e,t,i,n,r){var s=r*r,a=r*s,o=2*a-3*s+1,l=-2*a+3*s,u=a-2*s+r,h=a-s,c=e._x*o+i._x*l+t._x*u+n._x*h,d=e._y*o+i._y*l+t._y*u+n._y*h,f=e._z*o+i._z*l+t._z*u+n._z*h,_=e._w*o+i._w*l+t._w*u+n._w*h;return new e.constructor(c,d,f,_)}},{key:"Hermite1stDerivative",value:function(e,t,i,n,r){var s=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,n,r,s),s}},{key:"Hermite1stDerivativeToRef",value:function(e,t,i,n,r,s){var a=r*r;return s.x=6*(a-r)*e.x+(3*a-4*r+1)*t.x+6*(-a+r)*i.x+(3*a-2*r)*n.x,s.y=6*(a-r)*e.y+(3*a-4*r+1)*t.y+6*(-a+r)*i.y+(3*a-2*r)*n.y,s.z=6*(a-r)*e.z+(3*a-4*r+1)*t.z+6*(-a+r)*i.z+(3*a-2*r)*n.z,s.w=6*(a-r)*e.w+(3*a-4*r+1)*t.w+6*(-a+r)*i.w+(3*a-2*r)*n.w,s}}]),e}(),Z=function(){function e(){(0,m.Z)(this,e),this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,U.MatrixTrackPrecisionChange&&U.MatrixTrackedMatrices.push(this),this._m=new U.MatrixCurrentType(16),this.markAsUpdated()}return(0,y.Z)(e,[{key:"m",get:function(){return this._m}},{key:"markAsUpdated",value:function(){this.updateFlag=e._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}},{key:"_updateIdentityStatus",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=!this._isIdentity&&t,this._isIdentity3x2Dirty=!this._isIdentity3x2&&n}},{key:"isIdentity",value:function(){if(this._isIdentityDirty){this._isIdentityDirty=!1;var e=this._m;this._isIdentity=1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}return this._isIdentity}},{key:"isIdentityAs3x2",value:function(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,1!==this._m[0]||1!==this._m[5]||1!==this._m[15]||0!==this._m[1]||0!==this._m[2]||0!==this._m[3]||0!==this._m[4]||0!==this._m[6]||0!==this._m[7]||0!==this._m[8]||0!==this._m[9]||0!==this._m[10]||0!==this._m[11]||0!==this._m[12]||0!==this._m[13]||0!==this._m[14]?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}},{key:"determinant",value:function(){if(!0===this._isIdentity)return 1;var e=this._m,t=e[0],i=e[1],n=e[2],r=e[3],s=e[4],a=e[5],o=e[6],l=e[7],u=e[8],h=e[9],c=e[10],d=e[11],f=e[12],_=e[13],v=e[14],g=e[15],p=c*g-v*d,m=h*g-_*d,y=h*v-_*c,T=u*g-f*d,E=u*v-c*f,S=u*_-f*h;return t*+(a*p-o*m+l*y)+i*-(s*p-o*T+l*E)+n*+(s*m-a*T+l*S)+r*-(s*y-a*E+o*S)}},{key:"toArray",value:function(){return this._m}},{key:"asArray",value:function(){return this._m}},{key:"invert",value:function(){return this.invertToRef(this),this}},{key:"reset",value:function(){return e.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}},{key:"add",value:function(e){var t=new this.constructor;return this.addToRef(e,t),t}},{key:"addToRef",value:function(e,t){for(var i=this._m,n=t._m,r=e.m,s=0;s<16;s++)n[s]=i[s]+r[s];return t.markAsUpdated(),t}},{key:"addToSelf",value:function(e){for(var t=this._m,i=e.m,n=0;n<16;n++)t[n]+=i[n];return this.markAsUpdated(),this}},{key:"invertToRef",value:function(t){if(!0===this._isIdentity)return e.IdentityToRef(t),t;var i=this._m,n=i[0],r=i[1],s=i[2],a=i[3],o=i[4],l=i[5],u=i[6],h=i[7],c=i[8],d=i[9],f=i[10],_=i[11],v=i[12],g=i[13],p=i[14],m=i[15],y=f*m-p*_,T=d*m-g*_,E=d*p-g*f,S=c*m-v*_,b=c*p-f*v,x=c*g-v*d,M=+(l*y-u*T+h*E),A=-(o*y-u*S+h*b),R=+(o*T-l*S+h*x),C=-(o*E-l*b+u*x),I=n*M+r*A+s*R+a*C;if(0===I)return t.copyFrom(this),t;var P=1/I,k=u*m-p*h,D=l*m-g*h,F=l*p-g*u,w=o*m-v*h,O=o*p-v*u,L=o*g-v*l,N=u*_-f*h,B=l*_-d*h,U=l*f-d*u,V=o*_-c*h,G=o*f-c*u,W=o*d-c*l,z=-(r*y-s*T+a*E),X=+(n*y-s*S+a*b),H=-(n*T-r*S+a*x),Z=+(n*E-r*b+s*x),K=+(r*k-s*D+a*F),Y=-(n*k-s*w+a*O),q=+(n*D-r*w+a*L),j=-(n*F-r*O+s*L),Q=-(r*N-s*B+a*U),J=+(n*N-s*V+a*G),$=-(n*B-r*V+a*W),ee=+(n*U-r*G+s*W);return e.FromValuesToRef(M*P,z*P,K*P,Q*P,A*P,X*P,Y*P,J*P,R*P,H*P,q*P,$*P,C*P,Z*P,j*P,ee*P,t),t}},{key:"addAtIndex",value:function(e,t){return this._m[e]+=t,this.markAsUpdated(),this}},{key:"multiplyAtIndex",value:function(e,t){return this._m[e]*=t,this.markAsUpdated(),this}},{key:"setTranslationFromFloats",value:function(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}},{key:"addTranslationFromFloats",value:function(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}},{key:"setTranslation",value:function(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}},{key:"getTranslation",value:function(){return new z(this._m[12],this._m[13],this._m[14])}},{key:"getTranslationToRef",value:function(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}},{key:"removeRotationAndScaling",value:function(){var t=this.m;return e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t[12],t[13],t[14],t[15],this),this._updateIdentityStatus(0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]),this}},{key:"multiply",value:function(e){var t=new this.constructor;return this.multiplyToRef(e,t),t}},{key:"copyFrom",value:function(e){e.copyToArray(this._m);var t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}},{key:"copyToArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}},{key:"multiplyToRef",value:function(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}},{key:"multiplyToArray",value:function(e,t,i){var n=this._m,r=e.m,s=n[0],a=n[1],o=n[2],l=n[3],u=n[4],h=n[5],c=n[6],d=n[7],f=n[8],_=n[9],v=n[10],g=n[11],p=n[12],m=n[13],y=n[14],T=n[15],E=r[0],S=r[1],b=r[2],x=r[3],M=r[4],A=r[5],R=r[6],C=r[7],I=r[8],P=r[9],k=r[10],D=r[11],F=r[12],w=r[13],O=r[14],L=r[15];return t[i]=s*E+a*M+o*I+l*F,t[i+1]=s*S+a*A+o*P+l*w,t[i+2]=s*b+a*R+o*k+l*O,t[i+3]=s*x+a*C+o*D+l*L,t[i+4]=u*E+h*M+c*I+d*F,t[i+5]=u*S+h*A+c*P+d*w,t[i+6]=u*b+h*R+c*k+d*O,t[i+7]=u*x+h*C+c*D+d*L,t[i+8]=f*E+_*M+v*I+g*F,t[i+9]=f*S+_*A+v*P+g*w,t[i+10]=f*b+_*R+v*k+g*O,t[i+11]=f*x+_*C+v*D+g*L,t[i+12]=p*E+m*M+y*I+T*F,t[i+13]=p*S+m*A+y*P+T*w,t[i+14]=p*b+m*R+y*k+T*O,t[i+15]=p*x+m*C+y*D+T*L,this}},{key:"equals",value:function(e){var t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;var i=this.m,n=t.m;return i[0]===n[0]&&i[1]===n[1]&&i[2]===n[2]&&i[3]===n[3]&&i[4]===n[4]&&i[5]===n[5]&&i[6]===n[6]&&i[7]===n[7]&&i[8]===n[8]&&i[9]===n[9]&&i[10]===n[10]&&i[11]===n[11]&&i[12]===n[12]&&i[13]===n[13]&&i[14]===n[14]&&i[15]===n[15]}},{key:"clone",value:function(){var e=new this.constructor;return e.copyFrom(this),e}},{key:"getClassName",value:function(){return"Matrix"}},{key:"getHashCode",value:function(){for(var e=G(this._m[0]),t=1;t<16;t++)e=397*e^G(this._m[t]);return e}},{key:"decomposeToTransformNode",value:function(e){return e.rotationQuaternion=e.rotationQuaternion||new H,this.decompose(e.scaling,e.rotationQuaternion,e.position)}},{key:"decompose",value:function(t,i,n,r){if(this._isIdentity)return n&&n.setAll(0),t&&t.setAll(1),i&&i.copyFromFloats(0,0,0,1),!0;var s=this._m;if(n&&n.copyFromFloats(s[12],s[13],s[14]),(t=t||K.Vector3[0]).x=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),t.y=Math.sqrt(s[4]*s[4]+s[5]*s[5]+s[6]*s[6]),t.z=Math.sqrt(s[8]*s[8]+s[9]*s[9]+s[10]*s[10]),r){var a=r.scaling.x<0?-1:1,o=r.scaling.y<0?-1:1,l=r.scaling.z<0?-1:1;t.x*=a,t.y*=o,t.z*=l}else this.determinant()<=0&&(t.y*=-1);if(0===t._x||0===t._y||0===t._z)return i&&i.copyFromFloats(0,0,0,1),!1;if(i){var u=1/t._x,h=1/t._y,c=1/t._z;e.FromValuesToRef(s[0]*u,s[1]*u,s[2]*u,0,s[4]*h,s[5]*h,s[6]*h,0,s[8]*c,s[9]*c,s[10]*c,0,0,0,0,1,K.Matrix[0]),H.FromRotationMatrixToRef(K.Matrix[0],i)}return!0}},{key:"getRow",value:function(e){if(e<0||e>3)return null;var t=4*e;return new X(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}},{key:"getRowToRef",value:function(e,t){if(e>=0&&e<3){var i=4*e;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}},{key:"setRow",value:function(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}},{key:"transpose",value:function(){var t=new this.constructor;return e.TransposeToRef(this,t),t}},{key:"transposeToRef",value:function(t){return e.TransposeToRef(this,t),t}},{key:"setRowFromFloats",value:function(e,t,i,n,r){if(e<0||e>3)return this;var s=4*e;return this._m[s+0]=t,this._m[s+1]=i,this._m[s+2]=n,this._m[s+3]=r,this.markAsUpdated(),this}},{key:"scale",value:function(e){var t=new this.constructor;return this.scaleToRef(e,t),t}},{key:"scaleToRef",value:function(e,t){for(var i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}},{key:"scaleAndAddToRef",value:function(e,t){for(var i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}},{key:"toNormalMatrix",value:function(t){var i=K.Matrix[0];this.invertToRef(i),i.transposeToRef(t);var n=t._m;return e.FromValuesToRef(n[0],n[1],n[2],0,n[4],n[5],n[6],0,n[8],n[9],n[10],0,0,0,0,1,t),t}},{key:"getRotationMatrix",value:function(){var e=new this.constructor;return this.getRotationMatrixToRef(e),e}},{key:"getRotationMatrixToRef",value:function(t){var i=K.Vector3[0];if(!this.decompose(i))return e.IdentityToRef(t),t;var n=this._m,r=1/i._x,s=1/i._y,a=1/i._z;return e.FromValuesToRef(n[0]*r,n[1]*r,n[2]*r,0,n[4]*s,n[5]*s,n[6]*s,0,n[8]*a,n[9]*a,n[10]*a,0,0,0,0,1,t),t}},{key:"toggleModelMatrixHandInPlace",value:function(){var e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}},{key:"toggleProjectionMatrixHandInPlace",value:function(){var e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}}],[{key:"Use64Bits",get:function(){return U.MatrixUse64Bits}},{key:"FromArray",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=new e;return e.FromArrayToRef(t,i,n),n}},{key:"FromArrayToRef",value:function(e,t,i){for(var n=0;n<16;n++)i._m[n]=e[n+t];return i.markAsUpdated(),i}},{key:"FromFloat32ArrayToRefScaled",value:function(e,t,i,n){for(var r=0;r<16;r++)n._m[r]=e[r+t]*i;return n.markAsUpdated(),n}},{key:"IdentityReadOnly",get:function(){return e._IdentityReadOnly}},{key:"FromValuesToRef",value:function(e,t,i,n,r,s,a,o,l,u,h,c,d,f,_,v,g){var p=g._m;p[0]=e,p[1]=t,p[2]=i,p[3]=n,p[4]=r,p[5]=s,p[6]=a,p[7]=o,p[8]=l,p[9]=u,p[10]=h,p[11]=c,p[12]=d,p[13]=f,p[14]=_,p[15]=v,g.markAsUpdated()}},{key:"FromValues",value:function(t,i,n,r,s,a,o,l,u,h,c,d,f,_,v,g){var p=new e,m=p._m;return m[0]=t,m[1]=i,m[2]=n,m[3]=r,m[4]=s,m[5]=a,m[6]=o,m[7]=l,m[8]=u,m[9]=h,m[10]=c,m[11]=d,m[12]=f,m[13]=_,m[14]=v,m[15]=g,p.markAsUpdated(),p}},{key:"Compose",value:function(t,i,n){var r=new e;return e.ComposeToRef(t,i,n,r),r}},{key:"ComposeToRef",value:function(e,t,i,n){var r=n._m,s=t._x,a=t._y,o=t._z,l=t._w,u=s+s,h=a+a,c=o+o,d=s*u,f=s*h,_=s*c,v=a*h,g=a*c,p=o*c,m=l*u,y=l*h,T=l*c,E=e._x,S=e._y,b=e._z;return r[0]=(1-(v+p))*E,r[1]=(f+T)*E,r[2]=(_-y)*E,r[3]=0,r[4]=(f-T)*S,r[5]=(1-(d+p))*S,r[6]=(g+m)*S,r[7]=0,r[8]=(_+y)*b,r[9]=(g-m)*b,r[10]=(1-(d+v))*b,r[11]=0,r[12]=i._x,r[13]=i._y,r[14]=i._z,r[15]=1,n.markAsUpdated(),n}},{key:"Identity",value:function(){var t=e.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return t._updateIdentityStatus(!0),t}},{key:"IdentityToRef",value:function(t){return e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(!0),t}},{key:"Zero",value:function(){var t=e.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return t._updateIdentityStatus(!1),t}},{key:"RotationX",value:function(t){var i=new e;return e.RotationXToRef(t,i),i}},{key:"Invert",value:function(e){var t=new e.constructor;return e.invertToRef(t),t}},{key:"RotationXToRef",value:function(t,i){var n=Math.sin(t),r=Math.cos(t);return e.FromValuesToRef(1,0,0,0,0,r,n,0,0,-n,r,0,0,0,0,1,i),i._updateIdentityStatus(1===r&&0===n),i}},{key:"RotationY",value:function(t){var i=new e;return e.RotationYToRef(t,i),i}},{key:"RotationYToRef",value:function(t,i){var n=Math.sin(t),r=Math.cos(t);return e.FromValuesToRef(r,0,-n,0,0,1,0,0,n,0,r,0,0,0,0,1,i),i._updateIdentityStatus(1===r&&0===n),i}},{key:"RotationZ",value:function(t){var i=new e;return e.RotationZToRef(t,i),i}},{key:"RotationZToRef",value:function(t,i){var n=Math.sin(t),r=Math.cos(t);return e.FromValuesToRef(r,n,0,0,-n,r,0,0,0,0,1,0,0,0,0,1,i),i._updateIdentityStatus(1===r&&0===n),i}},{key:"RotationAxis",value:function(t,i){var n=new e;return e.RotationAxisToRef(t,i,n),n}},{key:"RotationAxisToRef",value:function(e,t,i){var n=Math.sin(-t),r=Math.cos(-t),s=1-r;e.normalize();var a=i._m;return a[0]=e._x*e._x*s+r,a[1]=e._x*e._y*s-e._z*n,a[2]=e._x*e._z*s+e._y*n,a[3]=0,a[4]=e._y*e._x*s+e._z*n,a[5]=e._y*e._y*s+r,a[6]=e._y*e._z*s-e._x*n,a[7]=0,a[8]=e._z*e._x*s-e._y*n,a[9]=e._z*e._y*s+e._x*n,a[10]=e._z*e._z*s+r,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,i.markAsUpdated(),i}},{key:"RotationAlignToRef",value:function(e,t,i){var n=z.Dot(t,e),r=i._m;if(n<-1+D)r[0]=-1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0;else{var s=z.Cross(t,e),a=1/(1+n);r[0]=s._x*s._x*a+n,r[1]=s._y*s._x*a-s._z,r[2]=s._z*s._x*a+s._y,r[3]=0,r[4]=s._x*s._y*a+s._z,r[5]=s._y*s._y*a+n,r[6]=s._z*s._y*a-s._x,r[7]=0,r[8]=s._x*s._z*a-s._y,r[9]=s._y*s._z*a+s._x,r[10]=s._z*s._z*a+n,r[11]=0}return r[12]=0,r[13]=0,r[14]=0,r[15]=1,i.markAsUpdated(),i}},{key:"RotationYawPitchRoll",value:function(t,i,n){var r=new e;return e.RotationYawPitchRollToRef(t,i,n,r),r}},{key:"RotationYawPitchRollToRef",value:function(e,t,i,n){return H.RotationYawPitchRollToRef(e,t,i,K.Quaternion[0]),K.Quaternion[0].toRotationMatrix(n),n}},{key:"Scaling",value:function(t,i,n){var r=new e;return e.ScalingToRef(t,i,n,r),r}},{key:"ScalingToRef",value:function(t,i,n,r){return e.FromValuesToRef(t,0,0,0,0,i,0,0,0,0,n,0,0,0,0,1,r),r._updateIdentityStatus(1===t&&1===i&&1===n),r}},{key:"Translation",value:function(t,i,n){var r=new e;return e.TranslationToRef(t,i,n,r),r}},{key:"TranslationToRef",value:function(t,i,n,r){return e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t,i,n,1,r),r._updateIdentityStatus(0===t&&0===i&&0===n),r}},{key:"Lerp",value:function(t,i,n){var r=new t.constructor;return e.LerpToRef(t,i,n,r),r}},{key:"LerpToRef",value:function(e,t,i,n){for(var r=n._m,s=e.m,a=t.m,o=0;o<16;o++)r[o]=s[o]*(1-i)+a[o]*i;return n.markAsUpdated(),n}},{key:"DecomposeLerp",value:function(t,i,n){var r=new t.constructor;return e.DecomposeLerpToRef(t,i,n,r),r}},{key:"DecomposeLerpToRef",value:function(t,i,n,r){var s=K.Vector3[0],a=K.Quaternion[0],o=K.Vector3[1];t.decompose(s,a,o);var l=K.Vector3[2],u=K.Quaternion[1],h=K.Vector3[3];i.decompose(l,u,h);var c=K.Vector3[4];z.LerpToRef(s,l,n,c);var d=K.Quaternion[2];H.SlerpToRef(a,u,n,d);var f=K.Vector3[5];return z.LerpToRef(o,h,n,f),e.ComposeToRef(c,d,f,r),r}},{key:"LookAtLH",value:function(t,i,n){var r=new e;return e.LookAtLHToRef(t,i,n,r),r}},{key:"LookAtLHToRef",value:function(t,i,n,r){var s=K.Vector3[0],a=K.Vector3[1],o=K.Vector3[2];i.subtractToRef(t,o),o.normalize(),z.CrossToRef(n,o,s);var l=s.lengthSquared();0===l?s.x=1:s.normalizeFromLength(Math.sqrt(l)),z.CrossToRef(o,s,a),a.normalize();var u=-z.Dot(s,t),h=-z.Dot(a,t),c=-z.Dot(o,t);e.FromValuesToRef(s._x,a._x,o._x,0,s._y,a._y,o._y,0,s._z,a._z,o._z,0,u,h,c,1,r)}},{key:"LookAtRH",value:function(t,i,n){var r=new e;return e.LookAtRHToRef(t,i,n,r),r}},{key:"LookAtRHToRef",value:function(t,i,n,r){var s=K.Vector3[0],a=K.Vector3[1],o=K.Vector3[2];t.subtractToRef(i,o),o.normalize(),z.CrossToRef(n,o,s);var l=s.lengthSquared();0===l?s.x=1:s.normalizeFromLength(Math.sqrt(l)),z.CrossToRef(o,s,a),a.normalize();var u=-z.Dot(s,t),h=-z.Dot(a,t),c=-z.Dot(o,t);return e.FromValuesToRef(s._x,a._x,o._x,0,s._y,a._y,o._y,0,s._z,a._z,o._z,0,u,h,c,1,r),r}},{key:"LookDirectionLH",value:function(t,i){var n=new e;return e.LookDirectionLHToRef(t,i,n),n}},{key:"LookDirectionLHToRef",value:function(t,i,n){var r=K.Vector3[0];r.copyFrom(t),r.scaleInPlace(-1);var s=K.Vector3[1];return z.CrossToRef(i,r,s),e.FromValuesToRef(s._x,s._y,s._z,0,i._x,i._y,i._z,0,r._x,r._y,r._z,0,0,0,0,1,n),n}},{key:"LookDirectionRH",value:function(t,i){var n=new e;return e.LookDirectionRHToRef(t,i,n),n}},{key:"LookDirectionRHToRef",value:function(t,i,n){var r=K.Vector3[2];return z.CrossToRef(i,t,r),e.FromValuesToRef(r._x,r._y,r._z,0,i._x,i._y,i._z,0,t._x,t._y,t._z,0,0,0,0,1,n),n}},{key:"OrthoLH",value:function(t,i,n,r,s){var a=new e;return e.OrthoLHToRef(t,i,n,r,a,s),a}},{key:"OrthoLHToRef",value:function(t,i,n,r,s,a){var o=2/t,l=2/i,u=2/(r-n),h=-(r+n)/(r-n);return e.FromValuesToRef(o,0,0,0,0,l,0,0,0,0,u,0,0,0,h,1,s),a&&s.multiplyToRef(Q,s),s._updateIdentityStatus(1===o&&1===l&&1===u&&0===h),s}},{key:"OrthoOffCenterLH",value:function(t,i,n,r,s,a,o){var l=new e;return e.OrthoOffCenterLHToRef(t,i,n,r,s,a,l,o),l}},{key:"OrthoOffCenterLHToRef",value:function(t,i,n,r,s,a,o,l){var u=2/(i-t),h=2/(r-n),c=2/(a-s),d=-(a+s)/(a-s),f=(t+i)/(t-i),_=(r+n)/(n-r);return e.FromValuesToRef(u,0,0,0,0,h,0,0,0,0,c,0,f,_,d,1,o),l&&o.multiplyToRef(Q,o),o.markAsUpdated(),o}},{key:"OrthoOffCenterRH",value:function(t,i,n,r,s,a,o){var l=new e;return e.OrthoOffCenterRHToRef(t,i,n,r,s,a,l,o),l}},{key:"OrthoOffCenterRHToRef",value:function(t,i,n,r,s,a,o,l){return e.OrthoOffCenterLHToRef(t,i,n,r,s,a,o,l),o._m[10]*=-1,o}},{key:"PerspectiveLH",value:function(t,i,n,r,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=new e,l=2*n/t,u=2*n/i,h=(r+n)/(r-n),c=-2*r*n/(r-n),d=Math.tan(a);return e.FromValuesToRef(l,0,0,0,0,u,0,d,0,0,h,1,0,0,c,0,o),s&&o.multiplyToRef(Q,o),o._updateIdentityStatus(!1),o}},{key:"PerspectiveFovLH",value:function(t,i,n,r,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=new e;return e.PerspectiveFovLHToRef(t,i,n,r,l,!0,s,a,o),l}},{key:"PerspectiveFovLHToRef",value:function(t,i,n,r,s){var a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=arguments.length>6?arguments[6]:void 0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=arguments.length>8&&void 0!==arguments[8]&&arguments[8],h=n,c=r,d=1/Math.tan(.5*t),f=a?d/i:d,_=a?d:d*i,v=u&&0===h?-1:0!==c?(c+h)/(c-h):1,g=u&&0===h?2*c:0!==c?-2*c*h/(c-h):-2*h,p=Math.tan(l);return e.FromValuesToRef(f,0,0,0,0,_,0,p,0,0,v,1,0,0,g,0,s),o&&s.multiplyToRef(Q,s),s._updateIdentityStatus(!1),s}},{key:"PerspectiveFovReverseLHToRef",value:function(t,i,n,r,s){var a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=arguments.length>6?arguments[6]:void 0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=1/Math.tan(.5*t),h=a?u/i:u,c=a?u:u*i,d=Math.tan(l);return e.FromValuesToRef(h,0,0,0,0,c,0,d,0,0,-n,1,0,0,1,0,s),o&&s.multiplyToRef(Q,s),s._updateIdentityStatus(!1),s}},{key:"PerspectiveFovRH",value:function(t,i,n,r,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=new e;return e.PerspectiveFovRHToRef(t,i,n,r,l,!0,s,a,o),l}},{key:"PerspectiveFovRHToRef",value:function(t,i,n,r,s){var a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=arguments.length>6?arguments[6]:void 0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=arguments.length>8&&void 0!==arguments[8]&&arguments[8],h=n,c=r,d=1/Math.tan(.5*t),f=a?d/i:d,_=a?d:d*i,v=u&&0===h?1:0!==c?-(c+h)/(c-h):-1,g=u&&0===h?2*c:0!==c?-2*c*h/(c-h):-2*h,p=Math.tan(l);return e.FromValuesToRef(f,0,0,0,0,_,0,p,0,0,v,-1,0,0,g,0,s),o&&s.multiplyToRef(Q,s),s._updateIdentityStatus(!1),s}},{key:"PerspectiveFovReverseRHToRef",value:function(t,i,n,r,s){var a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=arguments.length>6?arguments[6]:void 0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=1/Math.tan(.5*t),h=a?u/i:u,c=a?u:u*i,d=Math.tan(l);return e.FromValuesToRef(h,0,0,0,0,c,0,d,0,0,-n,-1,0,0,-1,0,s),o&&s.multiplyToRef(Q,s),s._updateIdentityStatus(!1),s}},{key:"PerspectiveFovWebVRToRef",value:function(e,t,i,n){var r=arguments.length>5?arguments[5]:void 0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4]?-1:1,o=Math.tan(e.upDegrees*Math.PI/180),l=Math.tan(e.downDegrees*Math.PI/180),u=Math.tan(e.leftDegrees*Math.PI/180),h=Math.tan(e.rightDegrees*Math.PI/180),c=2/(u+h),d=2/(o+l),f=Math.tan(s),_=n._m;return _[0]=c,_[1]=_[2]=_[3]=_[4]=0,_[5]=d,_[6]=0,_[7]=f,_[8]=(u-h)*c*.5,_[9]=-(o-l)*d*.5,_[10]=-i/(t-i),_[11]=1*a,_[12]=_[13]=_[15]=0,_[14]=-2*i*t/(i-t),r&&n.multiplyToRef(Q,n),n.markAsUpdated(),n}},{key:"GetFinalMatrix",value:function(t,i,n,r,s,a){var o=t.width,l=t.height,u=t.x,h=t.y,c=e.FromValues(o/2,0,0,0,0,-l/2,0,0,0,0,a-s,0,u+o/2,l/2+h,s,1),d=new i.constructor;return i.multiplyToRef(n,d),d.multiplyToRef(r,d),d.multiplyToRef(c,d)}},{key:"GetAsMatrix2x2",value:function(e){var t=e.m,i=[t[0],t[1],t[4],t[5]];return U.MatrixUse64Bits?i:new Float32Array(i)}},{key:"GetAsMatrix3x3",value:function(e){var t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return U.MatrixUse64Bits?i:new Float32Array(i)}},{key:"Transpose",value:function(t){var i=new t.constructor;return e.TransposeToRef(t,i),i}},{key:"TransposeToRef",value:function(e,t){var i=t._m,n=e.m;return i[0]=n[0],i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=n[1],i[5]=n[5],i[6]=n[9],i[7]=n[13],i[8]=n[2],i[9]=n[6],i[10]=n[10],i[11]=n[14],i[12]=n[3],i[13]=n[7],i[14]=n[11],i[15]=n[15],t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}},{key:"Reflection",value:function(t){var i=new e;return e.ReflectionToRef(t,i),i}},{key:"ReflectionToRef",value:function(t,i){t.normalize();var n=t.normal.x,r=t.normal.y,s=t.normal.z,a=-2*n,o=-2*r,l=-2*s;return e.FromValuesToRef(a*n+1,o*n,l*n,0,a*r,o*r+1,l*r,0,a*s,o*s,l*s+1,0,a*t.d,o*t.d,l*t.d,1,i),i}},{key:"FromXYZAxesToRef",value:function(t,i,n,r){return e.FromValuesToRef(t._x,t._y,t._z,0,i._x,i._y,i._z,0,n._x,n._y,n._z,0,0,0,0,1,r),r}},{key:"FromQuaternionToRef",value:function(e,t){var i=e._x*e._x,n=e._y*e._y,r=e._z*e._z,s=e._x*e._y,a=e._z*e._w,o=e._z*e._x,l=e._y*e._w,u=e._y*e._z,h=e._x*e._w;return t._m[0]=1-2*(n+r),t._m[1]=2*(s+a),t._m[2]=2*(o-l),t._m[3]=0,t._m[4]=2*(s-a),t._m[5]=1-2*(r+i),t._m[6]=2*(u+h),t._m[7]=0,t._m[8]=2*(o+l),t._m[9]=2*(u-h),t._m[10]=1-2*(n+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}]),e}();Z._UpdateFlagSeed=0,Z._IdentityReadOnly=Z.Identity();var K=(0,y.Z)((function e(){(0,m.Z)(this,e)}));K.Vector3=F.BuildTuple(11,z.Zero),K.Matrix=F.BuildTuple(2,Z.Identity),K.Quaternion=F.BuildTuple(3,H.Zero);var Y=(0,y.Z)((function e(){(0,m.Z)(this,e)}));Y.Vector2=F.BuildTuple(3,W.Zero),Y.Vector3=F.BuildTuple(13,z.Zero),Y.Vector4=F.BuildTuple(3,X.Zero),Y.Quaternion=F.BuildTuple(2,H.Zero),Y.Matrix=F.BuildTuple(8,Z.Identity),N("BABYLON.Vector2",W),N("BABYLON.Vector3",z),N("BABYLON.Vector4",X),N("BABYLON.Matrix",Z);var q,j,Q=Z.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1),J=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;(0,m.Z)(this,e),this.initialize(t,i,n,r)}return(0,y.Z)(e,[{key:"initialize",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=n,this}}]),e}(),$=(0,y.Z)((function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(0,m.Z)(this,e),this.callback=t,this.mask=i,this.scope=n,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1})),ee=function(){function e(t){(0,m.Z)(this,e),this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._eventState=new J(0),t&&(this._onObserverAdded=t)}return(0,y.Z)(e,[{key:"observers",get:function(){return this._observers}},{key:"add",value:function(e){var t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(!e)return null;var n=new $(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,arguments.length>3&&void 0!==arguments[3]?arguments[3]:null);return n.unregisterOnNextCall=i,t?this._observers.unshift(n):this._observers.push(n),this._onObserverAdded&&this._onObserverAdded(n),n}},{key:"addOnce",value:function(e){return this.add(e,void 0,void 0,void 0,!0)}},{key:"remove",value:function(e){return!(!e||-1===this._observers.indexOf(e))&&(this._deferUnregister(e),!0)}},{key:"removeCallback",value:function(e,t){for(var i=0;i<this._observers.length;i++){var n=this._observers[i];if(!n._willBeUnregistered&&n.callback===e&&(!t||t===n.scope))return this._deferUnregister(n),!0}return!1}},{key:"_deferUnregister",value:function(e){var t=this;this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout((function(){t._remove(e)}),0)}},{key:"_remove",value:function(e){if(!e)return!1;var t=this._observers.indexOf(e);return-1!==t&&(this._numObserversMarkedAsDeleted--,this._observers.splice(t,1),!0)}},{key:"makeObserverTopPriority",value:function(e){this._remove(e),this._observers.unshift(e)}},{key:"makeObserverBottomPriority",value:function(e){this._remove(e),this._observers.push(e)}},{key:"notifyObservers",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0;if(!this._observers.length)return!0;var s=this._eventState;s.mask=t,s.target=i,s.currentTarget=n,s.skipNextObservers=!1,s.lastReturnValue=e,s.userInfo=r;var a,o=(0,p.Z)(this._observers);try{for(o.s();!(a=o.n()).done;){var l=a.value;if(!l._willBeUnregistered&&(l.mask&t&&(l.unregisterOnNextCall&&this._deferUnregister(l),l.scope?s.lastReturnValue=l.callback.apply(l.scope,[e,s]):s.lastReturnValue=l.callback(e,s)),s.skipNextObservers))return!1}}catch(u){o.e(u)}finally{o.f()}return!0}},{key:"notifyObserver",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;if(!e._willBeUnregistered){var n=this._eventState;n.mask=i,n.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,n)}}},{key:"hasObservers",value:function(){return this._observers.length-this._numObserversMarkedAsDeleted>0}},{key:"clear",value:function(){this._observers=new Array,this._onObserverAdded=null}},{key:"clone",value:function(){var t=new e;return t._observers=this._observers.slice(0),t}},{key:"hasSpecificMask",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,i=(0,p.Z)(this._observers);try{for(i.s();!(e=i.n()).done;){var n=e.value;if(n.mask&t||n.mask===t)return!0}}catch(r){i.e(r)}finally{i.f()}return!1}}],[{key:"FromPromise",value:function(t,i){var n=new e;return t.then((function(e){n.notifyObservers(e)})).catch((function(e){if(!i)throw e;i.notifyObservers(e)})),n}}]),e}(),te=function(){function e(){(0,m.Z)(this,e),this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}return(0,y.Z)(e,[{key:"wrapU",get:function(){return this._cachedWrapU},set:function(e){this._cachedWrapU=e}},{key:"wrapV",get:function(){return this._cachedWrapV},set:function(e){this._cachedWrapV=e}},{key:"wrapR",get:function(){return this._cachedWrapR},set:function(e){this._cachedWrapR=e}},{key:"anisotropicFilteringLevel",get:function(){return this._cachedAnisotropicFilteringLevel},set:function(e){this._cachedAnisotropicFilteringLevel=e}},{key:"comparisonFunction",get:function(){return this._comparisonFunction},set:function(e){this._comparisonFunction=e}},{key:"useMipMaps",get:function(){return this._useMipMaps},set:function(e){this._useMipMaps=e}},{key:"setParameters",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:2,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=n,this.samplingMode=r,this._comparisonFunction=s,this}},{key:"compareSampler",value:function(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}]),e}();(j=q||(q={}))[j.Unknown=0]="Unknown",j[j.Url=1]="Url",j[j.Temp=2]="Temp",j[j.Raw=3]="Raw",j[j.Dynamic=4]="Dynamic",j[j.RenderTarget=5]="RenderTarget",j[j.MultiRenderTarget=6]="MultiRenderTarget",j[j.Cube=7]="Cube",j[j.CubeRaw=8]="CubeRaw",j[j.CubePrefiltered=9]="CubePrefiltered",j[j.Raw3D=10]="Raw3D",j[j.Raw2DArray=11]="Raw2DArray",j[j.DepthStencil=12]="DepthStencil",j[j.CubeRawRGBD=13]="CubeRawRGBD",j[j.Depth=14]="Depth";var ie=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r,s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return(0,m.Z)(this,i),(r=t.call(this)).isReady=!1,r.isCube=!1,r.is3D=!1,r.is2DArray=!1,r.isMultiview=!1,r.url="",r.generateMipMaps=!1,r.samples=0,r.type=-1,r.format=-1,r.onLoadedObservable=new ee,r.onErrorObservable=new ee,r.onRebuildCallback=null,r.width=0,r.height=0,r.depth=0,r.baseWidth=0,r.baseHeight=0,r.baseDepth=0,r.invertY=!1,r._invertVScale=!1,r._associatedChannel=-1,r._source=q.Unknown,r._buffer=null,r._bufferView=null,r._bufferViewArray=null,r._bufferViewArrayArray=null,r._size=0,r._extension="",r._files=null,r._workingCanvas=null,r._workingContext=null,r._cachedCoordinatesMode=null,r._isDisabled=!1,r._compression=null,r._sphericalPolynomial=null,r._sphericalPolynomialPromise=null,r._sphericalPolynomialComputed=!1,r._lodGenerationScale=0,r._lodGenerationOffset=0,r._useSRGBBuffer=!1,r._lodTextureHigh=null,r._lodTextureMid=null,r._lodTextureLow=null,r._isRGBD=!1,r._linearSpecularLOD=!1,r._irradianceTexture=null,r._hardwareTexture=null,r._maxLodLevel=null,r._references=1,r._gammaSpace=null,r._engine=e,r._source=n,r._uniqueId=i._Counter++,s||(r._hardwareTexture=e._createHardwareTexture()),r}return(0,y.Z)(i,[{key:"useMipMaps",get:function(){return this.generateMipMaps},set:function(e){this.generateMipMaps=e}},{key:"uniqueId",get:function(){return this._uniqueId}},{key:"_setUniqueId",value:function(e){this._uniqueId=e}},{key:"getEngine",value:function(){return this._engine}},{key:"source",get:function(){return this._source}},{key:"incrementReferences",value:function(){this._references++}},{key:"updateSize",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}},{key:"_rebuild",value:function(){var e,t=this;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){var i=this.onRebuildCallback(this),n=function(e){e._swapAndDie(t,!1),t.isReady=i.isReady};i.isAsync?i.proxy.then(n):n(i.proxy)}else{var r;switch(this.source){case q.Temp:break;case q.Url:return void(r=this._engine.createTexture(null!==(e=this._originalUrl)&&void 0!==e?e:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,(function(e){e._swapAndDie(t,!1),t.isReady=!0}),null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer));case q.Raw:(r=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer))._swapAndDie(this,!1),this.isReady=!0;break;case q.Raw3D:(r=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type))._swapAndDie(this,!1),this.isReady=!0;break;case q.Raw2DArray:(r=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type))._swapAndDie(this,!1),this.isReady=!0;break;case q.Dynamic:(r=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode))._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case q.Cube:return void(r=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,(function(){r._swapAndDie(t,!1),t.isReady=!0}),null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer));case q.CubeRaw:(r=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression))._swapAndDie(this,!1),this.isReady=!0;break;case q.CubeRawRGBD:return;case q.CubePrefiltered:return r=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,(function(e){e&&e._swapAndDie(t,!1),t.isReady=!0}),null,this.format,this._extension),void(r._sphericalPolynomial=this._sphericalPolynomial)}}}},{key:"_swapAndDie",value:function(e){var t,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];null===(t=this._hardwareTexture)||void 0===t||t.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,i&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);var n=this._engine.getLoadedTexturesCache(),r=n.indexOf(this);-1!==r&&n.splice(r,1),-1===(r=n.indexOf(e))&&n.push(e)}},{key:"dispose",value:function(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),0===this._references&&(this._engine._releaseTexture(this),this._hardwareTexture=null)}}]),i}(te);function ne(){return typeof window<"u"}function re(){return typeof navigator<"u"}function se(){return typeof document<"u"}function ae(e){for(var t="",i=e.firstChild;i;)3===i.nodeType&&(t+=i.textContent),i=i.nextSibling;return t}ie._Counter=0;var oe={IsWindowObjectExist:ne,IsNavigatorAvailable:re,IsDocumentAvailable:se,GetDOMTextContent:ae};function le(e){return"".concat(e," needs to be imported before as it contains a side-effect required by your code.")}var ue=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"_CheckLimit",value:function(t,i){var n=e._LogLimitOutputs[t];return n?n.current++:(n={limit:i,current:1},e._LogLimitOutputs[t]=n),n.current<=n.limit}},{key:"_GenerateLimitMessage",value:function(t){var i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=e._LogLimitOutputs[t];if(r&&e.MessageLimitReached){var s=this._Levels[n];r.current===r.limit&&e[s.name](e.MessageLimitReached.replace(/%LIMIT%/g,""+r.limit).replace(/%TYPE%/g,null!==(i=s.name)&&void 0!==i?i:""))}}},{key:"_AddLogEntry",value:function(t){e._LogCache=t+e._LogCache,e.OnNewCacheEntry&&e.OnNewCacheEntry(t)}},{key:"_FormatMessage",value:function(e){var t=function(e){return e<10?"0"+e:""+e},i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}},{key:"_LogDisabled",value:function(e,t){}},{key:"_LogEnabled",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;if(void 0===n||e._CheckLimit(i,n)){var r=e._FormatMessage(i),s=this._Levels[t];s.logFunc&&s.logFunc("BJS - "+r);var a="<div style='color:".concat(s.color,"'>").concat(r,"</div><br>");e._AddLogEntry(a),e._GenerateLimitMessage(i,t)}}},{key:"LogCache",get:function(){return e._LogCache}},{key:"ClearLogCache",value:function(){e._LogCache="",e._LogLimitOutputs={},e.errorsCount=0}},{key:"LogLevels",set:function(t){var i=this;e.Log=e._LogDisabled,e.Warn=e._LogDisabled,e.Error=e._LogDisabled,[e.MessageLogLevel,e.WarningLogLevel,e.ErrorLogLevel].forEach((function(n){(t&n)===n&&(e[i._Levels[n].name]=e._LogEnabled.bind(e,n))}))}}]),e}();ue.NoneLogLevel=0,ue.MessageLogLevel=1,ue.WarningLogLevel=2,ue.ErrorLogLevel=4,ue.AllLogLevel=7,ue.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",ue._LogCache="",ue._LogLimitOutputs={},ue._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}],ue.errorsCount=0,ue.Log=ue._LogEnabled.bind(ue,ue.MessageLogLevel),ue.Warn=ue._LogEnabled.bind(ue,ue.WarningLogLevel),ue.Error=ue._LogEnabled.bind(ue,ue.ErrorLogLevel);var he=function(){function e(){(0,m.Z)(this,e),this.children=[]}return(0,y.Z)(e,[{key:"isValid",value:function(e){return!0}},{key:"process",value:function(e,t){var i,n,r,s,a,o,l="";if(this.line){var u=this.line,h=t.processor;if(h){h.lineProcessor&&(u=h.lineProcessor(u,t.isFragment,t.processingContext));var c=null!==(n=null===(i=t.processor)||void 0===i?void 0:i.attributeKeywordName)&&void 0!==n?n:"attribute",d=t.isFragment&&null!==(r=t.processor)&&void 0!==r&&r.varyingFragmentKeywordName?null===(s=t.processor)||void 0===s?void 0:s.varyingFragmentKeywordName:!t.isFragment&&null!==(a=t.processor)&&void 0!==a&&a.varyingVertexKeywordName?null===(o=t.processor)||void 0===o?void 0:o.varyingVertexKeywordName:"varying";!t.isFragment&&h.attributeProcessor&&this.line.startsWith(c)?u=h.attributeProcessor(this.line,e,t.processingContext):h.varyingProcessor&&this.line.startsWith(d)?u=h.varyingProcessor(this.line,t.isFragment,e,t.processingContext):h.uniformProcessor&&h.uniformRegexp&&h.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(u=h.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):h.uniformBufferProcessor&&h.uniformBufferRegexp&&h.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(u=h.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):h.textureProcessor&&h.textureRegexp&&h.textureRegexp.test(this.line)?u=h.textureProcessor(this.line,t.isFragment,e,t.processingContext):(h.uniformProcessor||h.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?h.uniformProcessor&&(u=h.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):h.uniformBufferProcessor&&(u=h.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(t.lookForClosingBracketForUniformBuffer=!1,h.endOfUniformBufferProcessor&&(u=h.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}l+=u+"\r\n"}return this.children.forEach((function(i){l+=i.process(e,t)})),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),l}}]),e}(),ce=function(){function e(){(0,m.Z)(this,e),this._lines=[]}return(0,y.Z)(e,[{key:"currentLine",get:function(){return this._lines[this.lineIndex]}},{key:"canRead",get:function(){return this.lineIndex<this._lines.length-1}},{key:"lines",set:function(e){this._lines.length=0;var t,i=(0,p.Z)(e);try{for(i.s();!(t=i.n()).done;){var n=t.value;if("#"!==n[0])if(n.trim().startsWith("//"))this._lines.push(n);else for(var r=n.split(";"),s=0;s<r.length;s++){var a=r[s];(a=a.trim())&&this._lines.push(a+(s!==r.length-1?";":""))}else this._lines.push(n)}}catch(o){i.e(o)}finally{i.f()}}}]),e}(),de=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){return(0,m.Z)(this,i),t.apply(this,arguments)}return(0,y.Z)(i,[{key:"process",value:function(e,t){for(var i=0;i<this.children.length;i++){var n=this.children[i];if(n.isValid(e))return n.process(e,t)}return""}}]),i}(he),fe=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){return(0,m.Z)(this,i),t.apply(this,arguments)}return(0,y.Z)(i,[{key:"isValid",value:function(e){return this.testExpression.isTrue(e)}}]),i}(he),_e=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,[{key:"isTrue",value:function(e){return!0}}],[{key:"postfixToInfix",value:function(t){var i,n=[],r=(0,p.Z)(t);try{for(r.s();!(i=r.n()).done;){var s=i.value;if(void 0===e._OperatorPriority[s])n.push(s);else{var a=n[n.length-1],o=n[n.length-2];n.length-=2,n.push("(".concat(o).concat(s).concat(a,")"))}}}catch(l){r.e(l)}finally{r.f()}return n[n.length-1]}},{key:"infixToPostfix",value:function(t){for(var i=[],n=-1,r=function(){""!==(u=u.trim())&&(i.push(u),u="")},s=function(t){n<e._Stack.length-1&&(e._Stack[++n]=t)},a=function(){return e._Stack[n]},o=function(){return-1===n?"!!INVALID EXPRESSION!!":e._Stack[n--]},l=0,u="";l<t.length;){var h=t.charAt(l),c=l<t.length-1?t.substr(l,2):"";if("("===h)u="",s(h);else if(")"===h){for(r();-1!==n&&"("!==a();)i.push(o());o()}else if(e._OperatorPriority[c]>1){for(r();-1!==n&&e._OperatorPriority[a()]>=e._OperatorPriority[c];)i.push(o());s(c),l++}else u+=h;l++}for(r();-1!==n;)"("===a()?o():i.push(o());return i}}]),e}();_e._OperatorPriority={")":0,"(":1,"||":2,"&&":3},_e._Stack=["","","","","","","","","","","","","","","","","","","",""];var ve,ge=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e){var n,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return(0,m.Z)(this,i),(n=t.call(this)).define=e,n.not=r,n}return(0,y.Z)(i,[{key:"isTrue",value:function(e){var t=void 0!==e[this.define];return this.not&&(t=!t),t}}]),i}(_e),pe=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){return(0,m.Z)(this,i),t.apply(this,arguments)}return(0,y.Z)(i,[{key:"isTrue",value:function(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}]),i}(_e),me=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){return(0,m.Z)(this,i),t.apply(this,arguments)}return(0,y.Z)(i,[{key:"isTrue",value:function(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}]),i}(_e),ye=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r){var s;return(0,m.Z)(this,i),(s=t.call(this)).define=e,s.operand=n,s.testValue=r,s}return(0,y.Z)(i,[{key:"isTrue",value:function(e){var t=e[this.define];void 0===t&&(t=this.define);var i=!1,n=parseInt(t),r=parseInt(this.testValue);switch(this.operand){case">":i=n>r;break;case"<":i=n<r;break;case"<=":i=n<=r;break;case">=":i=n>=r;break;case"==":i=n===r}return i}}]),i}(_e);!function(e){e[e.GLSL=0]="GLSL",e[e.WGSL=1]="WGSL"}(ve||(ve={}));var Te=/defined\s*?\((.+?)\)/g,Ee=/defined\s*?\[(.+?)\]/g,Se=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,be=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"Initialize",value:function(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}},{key:"Process",value:function(e,t,i,n){var r,s=this;!(null===(r=t.processor)||void 0===r)&&r.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,(function(e){t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e));var r=s._ProcessShaderConversion(e,t,n);i(r,e)}))}},{key:"PreProcess",value:function(e,t,i,n){var r,s=this;!(null===(r=t.processor)||void 0===r)&&r.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,(function(e){t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e));var r=s._ApplyPreProcessing(e,t,n);i(r,e)}))}},{key:"Finalize",value:function(e,t,i){return i.processor&&i.processor.finalizeShaders?i.processor.finalizeShaders(e,t,i.processingContext):{vertexCode:e,fragmentCode:t}}},{key:"_ProcessPrecision",value:function(e,t){var i;if(null!==(i=t.processor)&&void 0!==i&&i.noPrecision)return e;var n=t.shouldUseHighPrecisionShader;return-1===e.indexOf("precision highp float")?e=n?"precision highp float;\n"+e:"precision mediump float;\n"+e:n||(e=e.replace("precision highp float","precision mediump float")),e}},{key:"_ExtractOperation",value:function(e){var t=/defined\((.+)\)/.exec(e);if(t&&t.length)return new ge(t[1].trim(),"!"===e[0]);for(var i="",n=0,r=0,s=["==",">=","<=","<",">"];r<s.length&&(i=s[r],!((n=e.indexOf(i))>-1));r++);if(-1===n)return new ge(e);var a=e.substring(0,n).trim(),o=e.substring(n+i.length).trim();return new ye(a,i,o)}},{key:"_BuildSubExpression",value:function(e){e=e.replace(Te,"defined[$1]");var t,i=_e.infixToPostfix(e),n=[],r=(0,p.Z)(i);try{for(r.s();!(t=r.n()).done;){var s=t.value;if("||"!==s&&"&&"!==s)n.push(s);else if(n.length>=2){var a=n[n.length-1],o=n[n.length-2];n.length-=2;var l="&&"==s?new me:new pe;"string"==typeof a&&(a=a.replace(Ee,"defined($1)")),"string"==typeof o&&(o=o.replace(Ee,"defined($1)")),l.leftOperand="string"==typeof o?this._ExtractOperation(o):o,l.rightOperand="string"==typeof a?this._ExtractOperation(a):a,n.push(l)}}}catch(h){r.e(h)}finally{r.f()}var u=n[n.length-1];return"string"==typeof u&&(u=u.replace(Ee,"defined($1)")),"string"==typeof u?this._ExtractOperation(u):u}},{key:"_BuildExpression",value:function(e,t){var i=new fe,n=e.substring(0,t),r=e.substring(t);return r=r.substring(0,(r.indexOf("//")+1||r.length+1)-1).trim(),i.testExpression="#ifdef"===n?new ge(r):"#ifndef"===n?new ge(r,!0):this._BuildSubExpression(r),i}},{key:"_MoveCursorWithinIf",value:function(e,t,i){for(var n=e.currentLine;this._MoveCursor(e,i);){var r=(n=e.currentLine).substring(0,5).toLowerCase();if("#else"===r){var s=new he;return t.children.push(s),void this._MoveCursor(e,s)}if("#elif"===r){var a=this._BuildExpression(n,5);t.children.push(a),i=a}}}},{key:"_MoveCursor",value:function(e,t){for(;e.canRead;){e.lineIndex++;var i=e.currentLine,n=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(i);if(n&&n.length)switch(n[0]){case"#ifdef":var r=new de;t.children.push(r);var s=this._BuildExpression(i,6);r.children.push(s),this._MoveCursorWithinIf(e,r,s);break;case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":var a=new de;t.children.push(a);var o=this._BuildExpression(i,7);a.children.push(o),this._MoveCursorWithinIf(e,a,o);break;case"#if":var l=new de,u=this._BuildExpression(i,3);t.children.push(l),l.children.push(u),this._MoveCursorWithinIf(e,l,u)}else{var h=new he;if(h.line=i,t.children.push(h),"#"===i[0]&&"d"===i[1]){var c=i.replace(";","").split(" ");h.additionalDefineKey=c[1],3===c.length&&(h.additionalDefineValue=c[2])}}}return!1}},{key:"_EvaluatePreProcessors",value:function(e,t,i){var n=new he,r=new ce;return r.lineIndex=-1,r.lines=e.split("\n"),this._MoveCursor(r,n),n.process(t,i)}},{key:"_PreparePreProcessors",value:function(e,t){var i,n,r=e.defines,s={},a=(0,p.Z)(r);try{for(a.s();!(n=a.n()).done;){var o=n.value.replace("#define","").replace(";","").trim().split(" ");s[o[0]]=o.length>1?o[1]:""}}catch(l){a.e(l)}finally{a.f()}return(null===(i=e.processor)||void 0===i?void 0:i.shaderLanguage)===ve.GLSL&&(s.GL_ES="true"),s.__VERSION__=e.version,s[e.platformName]="true",t._getGlobalDefines(s),s}},{key:"_ProcessShaderConversion",value:function(e,t,i){var n=this._ProcessPrecision(e,t);if(!t.processor||t.processor.shaderLanguage===ve.GLSL&&-1!==n.indexOf("#version 3")&&(n=n.replace("#version 300 es",""),!t.processor.parseGLES3))return n;var r=t.defines,s=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(n=t.processor.preProcessor(n,r,t.isFragment,t.processingContext)),n=this._EvaluatePreProcessors(n,s,t),t.processor.postProcessor&&(n=t.processor.postProcessor(n,r,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(n=i.inlineShaderCode(n)),n}},{key:"_ApplyPreProcessing",value:function(e,t,i){var n,r,s=e,a=t.defines,o=this._PreparePreProcessors(t,i);return!(null===(n=t.processor)||void 0===n)&&n.preProcessor&&(s=t.processor.preProcessor(s,a,t.isFragment,t.processingContext)),s=this._EvaluatePreProcessors(s,o,t),!(null===(r=t.processor)||void 0===r)&&r.postProcessor&&(s=t.processor.postProcessor(s,a,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(s=i.inlineShaderCode(s)),s}},{key:"_ProcessIncludes",value:function(t,i,n){for(var r=this,s=Se.exec(t),a=new String(t),o=!1,l=function(){var l=s[1];if(-1!==l.indexOf("__decl__")&&(l=l.replace(/__decl__/,""),i.supportsUniformBuffers&&(l=(l=l.replace(/Vertex/,"Ubo")).replace(/Fragment/,"Ubo")),l+="Declaration"),!i.includesShadersStore[l]){var u=i.shadersRepository+"ShadersInclude/"+l+".fx";return e._FileToolsLoadFile(u,(function(e){i.includesShadersStore[l]=e,r._ProcessIncludes(a,i,n)})),{v:void 0}}var h=i.includesShadersStore[l];if(s[2])for(var c=s[3].split(","),d=0;d<c.length;d+=2){var f=new RegExp(c[d],"g"),_=c[d+1];h=h.replace(f,_)}if(s[4]){var v=s[5];if(-1!==v.indexOf("..")){var g=v.split(".."),p=parseInt(g[0]),m=parseInt(g[1]),y=h.slice(0);h="",isNaN(m)&&(m=i.indexParameters[g[1]]);for(var T=p;T<m;T++)i.supportsUniformBuffers||(y=y.replace(/light\{X\}.(\w*)/g,(function(e,t){return t+"{X}"}))),h+=y.replace(/\{X\}/g,T.toString())+"\n"}else i.supportsUniformBuffers||(h=h.replace(/light\{X\}.(\w*)/g,(function(e,t){return t+"{X}"}))),h=h.replace(/\{X\}/g,v)}a=a.replace(s[0],h),o=o||h.indexOf("#include<")>=0||h.indexOf("#include <")>=0,s=Se.exec(t)};null!=s;){var u=l();if("object"===typeof u)return u.v}o?this._ProcessIncludes(a.toString(),i,n):n(a)}},{key:"_FileToolsLoadFile",value:function(e,t,i,n,r,s){throw le("FileTools")}}]),e}(),xe=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"GetShadersRepository",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:ve.GLSL)===ve.GLSL?e.ShadersRepository:e.ShadersRepositoryWGSL}},{key:"GetShadersStore",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:ve.GLSL)===ve.GLSL?e.ShadersStore:e.ShadersStoreWGSL}},{key:"GetIncludesShadersStore",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:ve.GLSL)===ve.GLSL?e.IncludesShadersStore:e.IncludesShadersStoreWGSL}}]),e}();xe.ShadersRepository="src/Shaders/",xe.ShadersStore={},xe.IncludesShadersStore={},xe.ShadersRepositoryWGSL="src/ShadersWGSL/",xe.ShadersStoreWGSL={},xe.IncludesShadersStoreWGSL={};var Me=function(){function e(t,i,n){var r,s,a,o=this,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,u=arguments.length>4?arguments[4]:void 0,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,f=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,_=arguments.length>9?arguments[9]:void 0,v=arguments.length>10&&void 0!==arguments[10]?arguments[10]:"",g=arguments.length>11&&void 0!==arguments[11]?arguments[11]:ve.GLSL;(0,m.Z)(this,e),this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new ee,this.onErrorObservable=new ee,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=t,this._key=v;var p,y,T,E=null;if(i.attributes){var S=i;if(this._engine=n,this._attributesNames=S.attributes,this._uniformsNames=S.uniformsNames.concat(S.samplers),this._samplerList=S.samplers.slice(),this.defines=S.defines,this.onError=S.onError,this.onCompiled=S.onCompiled,this._fallbacks=S.fallbacks,this._indexParameters=S.indexParameters,this._transformFeedbackVaryings=S.transformFeedbackVaryings||null,this._multiTarget=!!S.multiTarget,this._shaderLanguage=null!==(r=S.shaderLanguage)&&void 0!==r?r:ve.GLSL,S.uniformBuffersNames){this._uniformBuffersNamesList=S.uniformBuffersNames.slice();for(var b=0;b<S.uniformBuffersNames.length;b++)this._uniformBuffersNames[S.uniformBuffersNames[b]]=b}E=null!==(s=S.processFinalCode)&&void 0!==s?s:null,p=null!==(a=S.processCodeAfterIncludes)&&void 0!==a?a:void 0}else this._engine=u,this.defines=null!==h&&void 0!==h?h:"",this._uniformsNames=n.concat(l),this._samplerList=l?l.slice():[],this._attributesNames=i,this._uniformBuffersNamesList=[],this._shaderLanguage=g,this.onError=f,this.onCompiled=d,this._indexParameters=_,this._fallbacks=c;this._attributeLocationByName={},this.uniqueId=e._UniqueIdSeed++;var x=ne()?this._engine.getHostDocument():null;t.vertexSource?y="source:"+t.vertexSource:t.vertexElement?(y=x?x.getElementById(t.vertexElement):null)||(y=t.vertexElement):y=t.vertex||t,t.fragmentSource?T="source:"+t.fragmentSource:t.fragmentElement?(T=x?x.getElementById(t.fragmentElement):null)||(T=t.fragmentElement):T=t.fragment||t,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);var M={defines:this.defines.split("\n"),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:xe.GetShadersRepository(this._shaderLanguage),includesShadersStore:xe.GetIncludesShadersStore(this._shaderLanguage),version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:p},A=[void 0,void 0],R=function(){if(A[0]&&A[1]){M.isFragment=!0;var e=A[0],i=A[1];be.Process(i,M,(function(i,n){o._fragmentSourceCodeBeforeMigration=n,E&&(i=E("fragment",i));var r=be.Finalize(e,i,M);o._useFinalCode(r.vertexCode,r.fragmentCode,t)}),o._engine)}};this._loadShader(y,"Vertex","",(function(e){be.Initialize(M),be.Process(e,M,(function(t,i){o._rawVertexSourceCode=e,o._vertexSourceCodeBeforeMigration=i,E&&(t=E("vertex",t)),A[0]=t,R()}),o._engine)})),this._loadShader(T,"Fragment","Pixel",(function(e){o._rawFragmentSourceCode=e,A[1]=e,R()})),M=null;var C=function(e){return function(){return this._pipelineContext&&this._pipelineContext[e].apply(this._pipelineContext,arguments),this}};["Int?","UInt?","IntArray?","UIntArray?","Array?","Color?","Vector?","Float?","Matrices","Matrix","Matrix3x3","Matrix2x2","Quaternion","DirectColor4"].forEach((function(e){var t="set".concat(e);t.endsWith("?")?["",2,3,4].forEach((function(e){o[t.slice(0,-1)+e]=o[t.slice(0,-1)+e]||C(t.slice(0,-1)+e).bind(o)})):o[t]=o[t]||C(t).bind(o)}))}return(0,y.Z)(e,[{key:"onBindObservable",get:function(){return this._onBindObservable||(this._onBindObservable=new ee),this._onBindObservable}},{key:"_useFinalCode",value:function(e,t,i){if(i){var n=i.vertexElement||i.vertex||i.spectorName||i,r=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode=(this._shaderLanguage===ve.WGSL?"//":"")+"#define SHADER_NAME vertex:"+n+"\n"+e,this._fragmentSourceCode=(this._shaderLanguage===ve.WGSL?"//":"")+"#define SHADER_NAME fragment:"+r+"\n"+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect()}},{key:"key",get:function(){return this._key}},{key:"isReady",value:function(){try{return this._isReadyInternal()}catch(e){return!1}}},{key:"_isReadyInternal",value:function(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}},{key:"getEngine",value:function(){return this._engine}},{key:"getPipelineContext",value:function(){return this._pipelineContext}},{key:"getAttributesNames",value:function(){return this._attributesNames}},{key:"getAttributeLocation",value:function(e){return this._attributes[e]}},{key:"getAttributeLocationByName",value:function(e){return this._attributeLocationByName[e]}},{key:"getAttributesCount",value:function(){return this._attributes.length}},{key:"getUniformIndex",value:function(e){return this._uniformsNames.indexOf(e)}},{key:"getUniform",value:function(e){return this._uniforms[e]}},{key:"getSamplers",value:function(){return this._samplerList}},{key:"getUniformNames",value:function(){return this._uniformsNames}},{key:"getUniformBuffersNames",value:function(){return this._uniformBuffersNamesList}},{key:"getIndexParameters",value:function(){return this._indexParameters}},{key:"getCompilationError",value:function(){return this._compilationError}},{key:"allFallbacksProcessed",value:function(){return this._allFallbacksProcessed}},{key:"executeWhenCompiled",value:function(e){var t=this;this.isReady()?e(this):(this.onCompileObservable.add((function(t){e(t)})),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout((function(){t._checkIsReady(null)}),16))}},{key:"_checkIsReady",value:function(e){var t=this;try{if(this._isReadyInternal())return}catch(i){return void this._processCompilationErrors(i,e)}this._isDisposed||setTimeout((function(){t._checkIsReady(e)}),16)}},{key:"_loadShader",value:function(e,t,i,n){if(typeof HTMLElement<"u"&&e instanceof HTMLElement)n(ae(e));else if("source:"!==e.substr(0,7))if("base64:"!==e.substr(0,7)){var r,s=xe.GetShadersStore(this._shaderLanguage);if(s[e+t+"Shader"])n(s[e+t+"Shader"]);else if(i&&s[e+i+"Shader"])n(s[e+i+"Shader"]);else r="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:xe.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(r+"."+t.toLowerCase()+".fx",n)}else{n(window.atob(e.substr(7)))}else n(e.substr(7))}},{key:"vertexSourceCode",get:function(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:null!==(t=null===(e=this._pipelineContext)||void 0===e?void 0:e._getVertexShaderCode())&&void 0!==t?t:this._vertexSourceCode}},{key:"fragmentSourceCode",get:function(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:null!==(t=null===(e=this._pipelineContext)||void 0===e?void 0:e._getFragmentShaderCode())&&void 0!==t?t:this._fragmentSourceCode}},{key:"vertexSourceCodeBeforeMigration",get:function(){return this._vertexSourceCodeBeforeMigration}},{key:"fragmentSourceCodeBeforeMigration",get:function(){return this._fragmentSourceCodeBeforeMigration}},{key:"rawVertexSourceCode",get:function(){return this._rawVertexSourceCode}},{key:"rawFragmentSourceCode",get:function(){return this._rawFragmentSourceCode}},{key:"_rebuildProgram",value:function(e,t,i,n){var r=this;this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=function(e,t){n&&n(t)},this.onCompiled=function(){var e=r.getEngine().scenes;if(e)for(var t=0;t<e.length;t++)e[t].markAllMaterialsAsDirty(63);r._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()}},{key:"_prepareEffect",value:function(){var e=this,t=this._attributesNames,i=this.defines,n=this._pipelineContext;this._isReady=!1;try{var r=this._engine;this._pipelineContext=r.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;var s=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?r._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,s,null,this._transformFeedbackVaryings,this._key):r._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,s,i,this._transformFeedbackVaryings,this._key),r._executeWhenRenderingStateIsCompiled(this._pipelineContext,(function(){if(e._attributes=[],e._pipelineContext._fillEffectInformation(e,e._uniformBuffersNames,e._uniformsNames,e._uniforms,e._samplerList,e._samplers,t,e._attributes),t)for(var i=0;i<t.length;i++){var s=t[i];e._attributeLocationByName[s]=e._attributes[i]}r.bindSamplers(e),e._compilationError="",e._isReady=!0,e.onCompiled&&e.onCompiled(e),e.onCompileObservable.notifyObservers(e),e.onCompileObservable.clear(),e._fallbacks&&e._fallbacks.unBindMesh(),n&&e.getEngine()._deletePipelineContext(n)})),this._pipelineContext.isAsync&&this._checkIsReady(n)}catch(r){this._processCompilationErrors(r,n)}}},{key:"_getShaderCodeAndErrorLine",value:function(e,t,i){var n=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/,r=null;if(t&&e){var s=t.match(n);if(s&&2===s.length){var a=parseInt(s[1]),o=e.split("\n",-1);o.length>=a&&(r="Offending line [".concat(a,"] in ").concat(i?"fragment":"vertex"," code: ").concat(o[a-1]))}}return[e,r]}},{key:"_processCompilationErrors",value:function(t){var i,n,r,s=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._compilationError=t.message;var o=this._attributesNames,l=this._fallbacks;if(ue.Error("Unable to compile effect:"),ue.Error("Uniforms: "+this._uniformsNames.map((function(e){return" "+e}))),ue.Error("Attributes: "+o.map((function(e){return" "+e}))),ue.Error("Defines:\r\n"+this.defines),e.LogShaderCodeOnCompilationError){var u,h,c,d,f=null,v=null,g=null;!(null===(i=this._pipelineContext)||void 0===i)&&i._getVertexShaderCode()&&(u=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),g=(h=(0,_.Z)(u,2))[0],f=h[1],g&&(ue.Error("Vertex code:"),ue.Error(g))),!(null===(n=this._pipelineContext)||void 0===n)&&n._getFragmentShaderCode()&&(c=this._getShaderCodeAndErrorLine(null===(r=this._pipelineContext)||void 0===r?void 0:r._getFragmentShaderCode(),this._compilationError,!0),g=(d=(0,_.Z)(c,2))[0],v=d[1],g&&(ue.Error("Fragment code:"),ue.Error(g))),f&&ue.Error(f),v&&ue.Error(v)}ue.Error("Error: "+this._compilationError);var p=function(){s.onError&&s.onError(s,s._compilationError),s.onErrorObservable.notifyObservers(s)};a&&(this._pipelineContext=a,this._isReady=!0,p()),l?(this._pipelineContext=null,l.hasMoreFallbacks?(this._allFallbacksProcessed=!1,ue.Error("Trying next fallback."),this.defines=l.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,p(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,a||p())}},{key:"isSupported",get:function(){return""===this._compilationError}},{key:"_bindTexture",value:function(e,t){this._engine._bindTexture(this._samplers[e],t,e)}},{key:"setTexture",value:function(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}},{key:"setDepthStencilTexture",value:function(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)}},{key:"setTextureArray",value:function(e,t){var i=e+"Ex";if(-1===this._samplerList.indexOf(i+"0")){for(var n=this._samplerList.indexOf(e),r=1;r<t.length;r++){var s=i+(r-1).toString();this._samplerList.splice(n+r,0,s)}var a,o=0,l=(0,p.Z)(this._samplerList);try{for(l.s();!(a=l.n()).done;){var u=a.value;this._samplers[u]=o,o+=1}}catch(h){l.e(h)}finally{l.f()}}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}},{key:"setTextureFromPostProcess",value:function(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)}},{key:"setTextureFromPostProcessOutput",value:function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)}},{key:"bindUniformBuffer",value:function(t,i){var n=this._uniformBuffersNames[i];void 0===n||e._BaseCache[n]===t&&this._engine._features.useUBOBindingCache||(e._BaseCache[n]=t,this._engine.bindUniformBufferBase(t,n,i))}},{key:"bindUniformBlock",value:function(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}},{key:"setFloatArray",value:function(e,t){return this._pipelineContext.setArray(e,t),this}},{key:"setFloatArray2",value:function(e,t){return this._pipelineContext.setArray2(e,t),this}},{key:"setFloatArray3",value:function(e,t){return this._pipelineContext.setArray3(e,t),this}},{key:"setFloatArray4",value:function(e,t){return this._pipelineContext.setArray4(e,t),this}},{key:"setBool",value:function(e,t){return this._pipelineContext.setInt(e,t?1:0),this}},{key:"dispose",value:function(){var e;null===(e=this._pipelineContext)||void 0===e||e.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}}],[{key:"ShadersRepository",get:function(){return xe.ShadersRepository},set:function(e){xe.ShadersRepository=e}},{key:"RegisterShader",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ve.GLSL;t&&(xe.GetShadersStore(n)["".concat(e,"PixelShader")]=t),i&&(xe.GetShadersStore(n)["".concat(e,"VertexShader")]=i)}},{key:"ResetCache",value:function(){e._BaseCache={}}}]),e}();Me.LogShaderCodeOnCompilationError=!0,Me._UniqueIdSeed=0,Me._BaseCache={},Me.ShadersStore=xe.ShadersStore,Me.IncludesShadersStore=xe.IncludesShadersStore;var Ae=function(){function e(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];(0,m.Z)(this,e),this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,t&&this.reset()}return(0,y.Z)(e,[{key:"isDirty",get:function(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}},{key:"zOffset",get:function(){return this._zOffset},set:function(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}},{key:"zOffsetUnits",get:function(){return this._zOffsetUnits},set:function(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}},{key:"cullFace",get:function(){return this._cullFace},set:function(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}},{key:"cull",get:function(){return this._cull},set:function(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}},{key:"depthFunc",get:function(){return this._depthFunc},set:function(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}},{key:"depthMask",get:function(){return this._depthMask},set:function(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}},{key:"depthTest",get:function(){return this._depthTest},set:function(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}},{key:"frontFace",get:function(){return this._frontFace},set:function(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}},{key:"reset",value:function(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}},{key:"apply",value:function(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}]),e}(),Re=function(){function e(){(0,m.Z)(this,e),this.reset()}return(0,y.Z)(e,[{key:"reset",value:function(){this.enabled=!1,this.mask=255,this.func=e.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=e.KEEP,this.opDepthFail=e.KEEP,this.opStencilDepthPass=e.REPLACE}},{key:"stencilFunc",get:function(){return this.func},set:function(e){this.func=e}},{key:"stencilFuncRef",get:function(){return this.funcRef},set:function(e){this.funcRef=e}},{key:"stencilFuncMask",get:function(){return this.funcMask},set:function(e){this.funcMask=e}},{key:"stencilOpStencilFail",get:function(){return this.opStencilFail},set:function(e){this.opStencilFail=e}},{key:"stencilOpDepthFail",get:function(){return this.opDepthFail},set:function(e){this.opDepthFail=e}},{key:"stencilOpStencilDepthPass",get:function(){return this.opStencilDepthPass},set:function(e){this.opStencilDepthPass=e}},{key:"stencilMask",get:function(){return this.mask},set:function(e){this.mask=e}},{key:"stencilTest",get:function(){return this.enabled},set:function(e){this.enabled=e}}]),e}();Re.ALWAYS=519,Re.KEEP=7680,Re.REPLACE=7681;var Ce=function(){function e(){(0,m.Z)(this,e),this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}return(0,y.Z)(e,[{key:"isDirty",get:function(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}},{key:"alphaBlend",get:function(){return this._alphaBlend},set:function(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}},{key:"setAlphaBlendConstants",value:function(e,t,i,n){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===n||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=n,this._isBlendConstantsDirty=!0)}},{key:"setAlphaBlendFunctionParameters",value:function(e,t,i,n){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===n||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=n,this._isBlendFunctionParametersDirty=!0)}},{key:"setAlphaEquationParameters",value:function(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}},{key:"reset",value:function(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}},{key:"apply",value:function(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}]),e}(),Ie=function(){function e(){(0,m.Z)(this,e),this.shaderLanguage=ve.GLSL}return(0,y.Z)(e,[{key:"postProcessor",value:function(e,t,i,n,r){if(!r.getCaps().drawBuffersExtension){e=e.replace(/#extension.+GL_EXT_draw_buffers.+(enable|require)/g,"")}return e}}]),e}(),Pe=function(){function e(){(0,m.Z)(this,e),this.shaderLanguage=ve.GLSL}return(0,y.Z)(e,[{key:"attributeProcessor",value:function(e){return e.replace("attribute","in")}},{key:"varyingProcessor",value:function(e,t){return e.replace("varying",t?"in":"out")}},{key:"postProcessor",value:function(e,t,i){var n=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i)e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(n?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");else if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e}}]),e}(),ke=function(){function e(){(0,m.Z)(this,e),this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=e._Counter++}return(0,y.Z)(e,[{key:"underlyingResource",get:function(){return null}}]),e}();ke._Counter=0;var De=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e){var n;return(0,m.Z)(this,i),(n=t.call(this))._buffer=e,n}return(0,y.Z)(i,[{key:"underlyingResource",get:function(){return this._buffer}}]),i}(ke),Fe=["Int","Int2","Int3","Int4","UInt","UInt2","UInt3","UInt4","Vector2","Vector3","Vector4","Float2","Float","Float3","Float4","Quaternion","Color3","Color4","DirectColor4"],we=function(){function e(){var t=this;(0,m.Z)(this,e),this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null;var i=[],n=function(){i.length=0,Array.prototype.push.apply(i,arguments),i[0]=this._uniforms[i[0]]},r=function(e){var r=Fe.includes(e.substring(3))&&"FloatN";if(r){var s=t["_cache".concat(r)];return function(){var t=this.engine[e];n.apply(this,arguments),s.apply(this,arguments)&&(t.apply(this.engine,i)||(this._valueCache[arguments[0]]=null))}}return function(){var t=this.engine[e];n.apply(this,arguments),void 0!==arguments[1]&&(this._valueCache[arguments[0]]=null,t.apply(this.engine,i))}};["Int?","UInt?","IntArray?","UIntArray?","Array?","Float?","Matrices","Matrix3x3","Matrix2x2"].forEach((function(e){var i="set".concat(e);t[i]||(i.endsWith("?")?["",2,3,4].forEach((function(e){t[i.slice(0,-1)+e]=t[i.slice(0,-1)+e]||r(i.slice(0,-1)+e).bind(t)})):t[i]=t[i]||r(i).bind(t))}))}return(0,y.Z)(e,[{key:"isAsync",get:function(){return this.isParallelCompiled}},{key:"isReady",get:function(){return!!this.program&&(!this.isParallelCompiled||this.engine._isRenderingStateCompiled(this))}},{key:"_handlesSpectorRebuildCallback",value:function(e){e&&this.program&&e(this.program)}},{key:"_fillEffectInformation",value:function(e,t,i,n,r,s,a,o){var l,u=this.engine;if(u.supportsUniformBuffers)for(var h in t)e.bindUniformBlock(h,t[h]);for(this.engine.getUniforms(this,i).forEach((function(e,t){n[i[t]]=e})),this._uniforms=n,l=0;l<r.length;l++)null==e.getUniform(r[l])&&(r.splice(l,1),l--);r.forEach((function(e,t){s[e]=t}));var c,d=(0,p.Z)(u.getAttributes(this,a));try{for(d.s();!(c=d.n()).done;){var f=c.value;o.push(f)}}catch(_){d.e(_)}finally{d.f()}}},{key:"dispose",value:function(){this._uniforms={}}},{key:"_cacheMatrix",value:function(e,t){var i=this._valueCache[e],n=t.updateFlag;return(void 0===i||i!==n)&&(this._valueCache[e]=n,!0)}},{key:"_cacheFloatN",value:function(e,t,i,n,r){var s=this._valueCache[arguments[0]];if(!s||s.length!==arguments.length-1)return s=Array.prototype.slice.call(arguments,1),this._valueCache[arguments[0]]=s,!0;for(var a=!1,o=0;o<s.length;++o)s[o]!==arguments[o+1]&&(s[o]=arguments[o+1],a=!0);return a}},{key:"_cacheFloat2",value:function(e,t,i){return this._cacheFloatN(e,t,i)}},{key:"_cacheFloat3",value:function(e,t,i,n){return this._cacheFloatN(e,t,i,n)}},{key:"_cacheFloat4",value:function(e,t,i,n,r){return this._cacheFloatN(e,t,i,n,r)}},{key:"setMatrix",value:function(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}},{key:"setVector2",value:function(e,t){this.setFloat2(e,t.x,t.y)}},{key:"setVector3",value:function(e,t){this.setFloat3(e,t.x,t.y,t.z)}},{key:"setVector4",value:function(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}},{key:"setQuaternion",value:function(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}},{key:"setColor3",value:function(e,t){this.setFloat3(e,t.r,t.g,t.b)}},{key:"setColor4",value:function(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}},{key:"setDirectColor4",value:function(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}},{key:"_getVertexShaderCode",value:function(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}},{key:"_getFragmentShaderCode",value:function(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}]),e}(),Oe=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1?arguments[1]:void 0;if((0,m.Z)(this,e),this._MSAARenderBuffer=null,this._context=i,!t&&!(t=i.createTexture()))throw new Error("Unable to create webGL texture");this.set(t)}return(0,y.Z)(e,[{key:"underlyingResource",get:function(){return this._webGLTexture}},{key:"setUsage",value:function(){}},{key:"set",value:function(e){this._webGLTexture=e}},{key:"reset",value:function(){this._webGLTexture=null,this._MSAARenderBuffer=null}},{key:"release",value:function(){this._MSAARenderBuffer&&(this._context.deleteRenderbuffer(this._MSAARenderBuffer),this._MSAARenderBuffer=null),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}]),e}(),Le=function(){function e(t){var i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];(0,m.Z)(this,e),this.effect=null,this.defines=null,this.drawContext=t.createDrawContext(),i&&(this.materialContext=t.createMaterialContext())}return(0,y.Z)(e,[{key:"setEffect",value:function(e,t){var i,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.effect=e,void 0!==t&&(this.defines=t),n&&(null===(i=this.drawContext)||void 0===i||i.reset())}},{key:"dispose",value:function(){var e;null===(e=this.drawContext)||void 0===e||e.dispose()}}],[{key:"IsWrapper",value:function(e){return void 0===e.getPipelineContext}},{key:"GetEffect",value:function(e){return void 0===e.getPipelineContext?e.effect:e}}]),e}(),Ne=function(){function e(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];(0,m.Z)(this,e),this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,t&&this.reset()}return(0,y.Z)(e,[{key:"isDirty",get:function(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}},{key:"func",get:function(){return this._func},set:function(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}},{key:"funcRef",get:function(){return this._funcRef},set:function(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}},{key:"funcMask",get:function(){return this._funcMask},set:function(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}},{key:"opStencilFail",get:function(){return this._opStencilFail},set:function(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}},{key:"opDepthFail",get:function(){return this._opDepthFail},set:function(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}},{key:"opStencilDepthPass",get:function(){return this._opStencilDepthPass},set:function(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}},{key:"mask",get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}},{key:"reset",value:function(){var e;this.stencilMaterial=void 0,null===(e=this.stencilGlobal)||void 0===e||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}},{key:"apply",value:function(e){var t;if(e){var i=!this.useStencilGlobalOnly&&!(null===(t=this.stencilMaterial)||void 0===t||!t.enabled);this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}}]),e}(),Be=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"Now",get:function(){return oe.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}]),e}(),Ue=(0,y.Z)((function e(){(0,m.Z)(this,e)})),Ve=function(){function e(t,i,n,r){var s,a=this;(0,m.Z)(this,e),this._name="WebGL",this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new ee,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new ee,this.onContextRestoredObservable=new ee,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new Ae,this._stencilStateComposer=new Ne,this._stencilState=new Re,this._alphaState=new Ce,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new ee,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._useExactSrgbConversions=!1,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},this.startTime=Be.Now;var o=null;if(n=n||{},this._creationOptions=n,this.adaptToDeviceRatio=null!==(s=r)&&void 0!==s&&s,this._stencilStateComposer.stencilGlobal=this._stencilState,U.SetMatrixPrecision(!!n.useHighPrecisionMatrix),t){if(r=r||n.adaptToDeviceRatio||!1,t.getContext){if(o=t,this._renderingCanvas=o,void 0!==i&&(n.antialias=i),void 0===n.deterministicLockstep&&(n.deterministicLockstep=!1),void 0===n.lockstepMaxSteps&&(n.lockstepMaxSteps=4),void 0===n.timeStep&&(n.timeStep=1/60),void 0===n.preserveDrawingBuffer&&(n.preserveDrawingBuffer=!1),void 0===n.audioEngine&&(n.audioEngine=!0),void 0!==n.audioEngineOptions&&void 0!==n.audioEngineOptions.audioContext&&(this._audioContext=n.audioEngineOptions.audioContext),void 0!==n.audioEngineOptions&&void 0!==n.audioEngineOptions.audioDestination&&(this._audioDestination=n.audioEngineOptions.audioDestination),void 0===n.stencil&&(n.stencil=!0),!1===n.premultipliedAlpha&&(this.premultipliedAlpha=!1),void 0===n.xrCompatible&&(n.xrCompatible=!0),void 0!==n.useExactSrgbConversions&&(this._useExactSrgbConversions=n.useExactSrgbConversions),this._doNotHandleContextLost=!!n.doNotHandleContextLost,navigator&&navigator.userAgent){this._checkForMobile=function(){var e=navigator.userAgent;a.hostInformation.isMobile=-1!==e.indexOf("Mobile")||-1!==e.indexOf("Mac")&&se()&&"ontouchend"in document},this._checkForMobile(),ne()&&window.addEventListener("resize",this._checkForMobile);var l,u=navigator.userAgent,h=(0,p.Z)(e.ExceptionList);try{for(h.s();!(l=h.n()).done;){var c=l.value,d=c.key,f=c.targets;if(new RegExp(d).test(u)){if(c.capture&&c.captureConstraint){var _=c.capture,v=c.captureConstraint,g=new RegExp(_).exec(u);if(g&&g.length>0&&parseInt(g[g.length-1])>=v)continue}var y,T=(0,p.Z)(f);try{for(T.s();!(y=T.n()).done;){switch(y.value){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":n.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}catch(A){T.e(A)}finally{T.f()}}}}catch(A){h.e(A)}finally{h.f()}}if(this._doNotHandleContextLost||(this._onContextLost=function(e){e.preventDefault(),a._contextWasLost=!0,ue.Warn("WebGL context lost."),a.onContextLostObservable.notifyObservers(a)},this._onContextRestored=function(){a._restoreEngineAfterContextLost(a._initGLContext.bind(a))},o.addEventListener("webglcontextlost",this._onContextLost,!1),o.addEventListener("webglcontextrestored",this._onContextRestored,!1),n.powerPreference="high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(n.xrCompatible=!1),!n.disableWebGL2Support)try{this._gl=o.getContext("webgl2",n)||o.getContext("experimental-webgl2",n),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(R){}if(!this._gl){if(!o)throw new Error("The provided canvas is null or undefined.");try{this._gl=o.getContext("webgl",n)||o.getContext("experimental-webgl",n)}catch(C){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=t,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";var E=this._gl.getContextAttributes();E&&(n.stencil=E.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==n.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=n.useHighPrecisionFloats);var S=ne()&&window.devicePixelRatio||1,b=n.limitDeviceRatio||S;this._hardwareScalingLevel=r?1/Math.min(b,S):1,this._lastDevicePixelRatio=S,this.resize(),this._isStencilEnable=!!n.stencil,this._initGLContext(),this._initFeatures();for(var x=0;x<this._caps.maxVertexAttribs;x++)this._currentBufferPointers[x]=new Ue;this._shaderProcessor=this.webGLVersion>1?new Pe:new Ie,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);var M="Babylon.js v".concat(e.Version);console.log(M+" - ".concat(this.description)),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",M)}}return(0,y.Z)(e,[{key:"description",get:function(){var e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"version",get:function(){return this._webGLVersion}},{key:"_getShaderProcessor",value:function(e){return this._shaderProcessor}},{key:"useReverseDepthBuffer",get:function(){return this._useReverseDepthBuffer},set:function(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,this._depthCullingState.depthFunc=e?518:515)}},{key:"frameId",get:function(){return this._frameId}},{key:"supportsUniformBuffers",get:function(){return this.webGLVersion>1&&!this.disableUniformBuffers}},{key:"getCreationOptions",value:function(){return this._creationOptions}},{key:"_shouldUseHighPrecisionShader",get:function(){return!(!this._caps.highPrecisionShaderSupported||!this._highPrecisionShadersAllowed)}},{key:"needPOTTextures",get:function(){return this._webGLVersion<2||this.forcePOTTextures}},{key:"activeRenderLoops",get:function(){return this._activeRenderLoops}},{key:"doNotHandleContextLost",get:function(){return this._doNotHandleContextLost},set:function(e){this._doNotHandleContextLost=e}},{key:"_supportsHardwareTextureRescaling",get:function(){return!1}},{key:"framebufferDimensionsObject",set:function(e){this._framebufferDimensionsObject=e}},{key:"currentViewport",get:function(){return this._cachedViewport}},{key:"emptyTexture",get:function(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}},{key:"emptyTexture3D",get:function(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}},{key:"emptyTexture2DArray",get:function(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}},{key:"emptyCubeTexture",get:function(){if(!this._emptyCubeTexture){var e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}},{key:"isWebGPU",get:function(){return this._isWebGPU}},{key:"shaderPlatformName",get:function(){return this._shaderPlatformName}},{key:"snapshotRendering",get:function(){return!1},set:function(e){}},{key:"snapshotRenderingMode",get:function(){return this._snapshotRenderingMode},set:function(e){this._snapshotRenderingMode=e}},{key:"useExactSrgbConversions",get:function(){return this._useExactSrgbConversions}},{key:"snapshotRenderingReset",value:function(){this.snapshotRendering=!1}},{key:"createCanvas",value:function(t,i){return e._CreateCanvas(t,i)}},{key:"createCanvasImage",value:function(){return document.createElement("img")}},{key:"_restoreEngineAfterContextLost",value:function(e){var t=this;setTimeout((0,f.Z)((0,d.Z)().mark((function i(){var n,r,s,a,o;return(0,d.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return t._dummyFramebuffer=null,r=t._depthCullingState.depthTest,s=t._depthCullingState.depthFunc,a=t._depthCullingState.depthMask,o=t._stencilState.stencilTest,i.next=4,e();case 4:t.wipeCaches(!0),t._rebuildEffects(),null===(n=t._rebuildComputeEffects)||void 0===n||n.call(t),t._rebuildBuffers(),t._rebuildInternalTextures(),t._rebuildRenderTargetWrappers(),t.wipeCaches(!0),t._depthCullingState.depthTest=r,t._depthCullingState.depthFunc=s,t._depthCullingState.depthMask=a,t._stencilState.stencilTest=o,ue.Warn(t.name+" context successfully restored."),t.onContextRestoredObservable.notifyObservers(t),t._contextWasLost=!1;case 18:case"end":return i.stop()}}),i)}))),0)}},{key:"_sharedInit",value:function(e,t,i){this._renderingCanvas=e}},{key:"_getShaderProcessingContext",value:function(e){return null}},{key:"_rebuildInternalTextures",value:function(){var e,t=this._internalTexturesCache.slice(),i=(0,p.Z)(t);try{for(i.s();!(e=i.n()).done;){e.value._rebuild()}}catch(n){i.e(n)}finally{i.f()}}},{key:"_rebuildRenderTargetWrappers",value:function(){var e,t=this._renderTargetWrapperCache.slice(),i=(0,p.Z)(t);try{for(i.s();!(e=i.n()).done;){e.value._rebuild()}}catch(n){i.e(n)}finally{i.f()}}},{key:"_rebuildEffects",value:function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}Me.ResetCache()}},{key:"areAllEffectsReady",value:function(){for(var e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}},{key:"_rebuildBuffers",value:function(){var e,t=(0,p.Z)(this._uniformBuffers);try{for(t.s();!(e=t.n()).done;){e.value._rebuild()}}catch(r){t.e(r)}finally{t.f()}var i,n=(0,p.Z)(this._storageBuffers);try{for(n.s();!(i=n.n()).done;){i.value._rebuild()}}catch(r){n.e(r)}finally{n.f()}}},{key:"_initGLContext",value:function(){var e;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?256:128},this._glVersion=this._gl.getParameter(this._gl.VERSION);var t=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=t&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(null!==(e=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))&&void 0!==e?e:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{var i=this._gl.getExtension("WEBGL_draw_buffers");if(null!==i){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=i.drawBuffersWEBGL.bind(i),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(var n=0;n<16;n++)this._gl["COLOR_ATTACHMENT"+n+"_WEBGL"]=i["COLOR_ATTACHMENT"+n+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{var r=this._gl.getExtension("WEBGL_depth_texture");null!=r&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=r.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{var s=this._gl.getExtension("OES_vertex_array_object");null!=s&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=s.createVertexArrayOES.bind(s),this._gl.bindVertexArray=s.bindVertexArrayOES.bind(s),this._gl.deleteVertexArray=s.deleteVertexArrayOES.bind(s))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{var a=this._gl.getExtension("ANGLE_instanced_arrays");null!=a?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=a.drawArraysInstancedANGLE.bind(a),this._gl.drawElementsInstanced=a.drawElementsInstancedANGLE.bind(a),this._gl.vertexAttribDivisor=a.vertexAttribDivisorANGLE.bind(a)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){var o=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),l=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);o&&l&&(this._caps.highPrecisionShaderSupported=0!==o.precision&&0!==l.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{var u=this._gl.getExtension("EXT_blend_minmax");null!=u&&(this._caps.blendMinMax=!0,this._gl.MAX=u.MAX_EXT,this._gl.MIN=u.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0;else{var h=this._gl.getExtension("EXT_sRGB");null!=h&&(this._caps.supportSRGBBuffers=!0,this._gl.SRGB=h.SRGB_EXT,this._gl.SRGB8=h.SRGB_ALPHA_EXT,this._gl.SRGB8_ALPHA8=h.SRGB_ALPHA_EXT)}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!(!this._creationOptions||!this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(var c=0;c<this._maxSimultaneousTextures;c++)this._nextFreeTextureSlots.push(c)}},{key:"_initFeatures",value:function(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}},{key:"webGLVersion",get:function(){return this._webGLVersion}},{key:"getClassName",value:function(){return"ThinEngine"}},{key:"isStencilEnable",get:function(){return this._isStencilEnable}},{key:"_prepareWorkingCanvas",value:function(){if(!this._workingCanvas){this._workingCanvas=this.createCanvas(1,1);var e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}}},{key:"resetTextureCache",value:function(){for(var e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}},{key:"getInfo",value:function(){return this.getGlInfo()}},{key:"getGlInfo",value:function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}},{key:"setHardwareScalingLevel",value:function(e){this._hardwareScalingLevel=e,this.resize()}},{key:"getHardwareScalingLevel",value:function(){return this._hardwareScalingLevel}},{key:"getLoadedTexturesCache",value:function(){return this._internalTexturesCache}},{key:"getCaps",value:function(){return this._caps}},{key:"stopRenderLoop",value:function(e){if(e){var t=this._activeRenderLoops.indexOf(e);t>=0&&this._activeRenderLoops.splice(t,1)}else this._activeRenderLoops=[]}},{key:"_renderLoop",value:function(){if(!this._contextWasLost){var e=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e){this.beginFrame();for(var t=0;t<this._activeRenderLoops.length;t++){(0,this._activeRenderLoops[t])()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}},{key:"getRenderingCanvas",value:function(){return this._renderingCanvas}},{key:"getAudioContext",value:function(){return this._audioContext}},{key:"getAudioDestination",value:function(){return this._audioDestination}},{key:"getHostWindow",value:function(){return ne()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}},{key:"getRenderWidth",value:function(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}},{key:"getRenderHeight",value:function(){return!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}},{key:"_queueNewFrame",value:function(t,i){return e.QueueNewFrame(t,i)}},{key:"runRenderLoop",value:function(e){-1===this._activeRenderLoops.indexOf(e)&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}},{key:"clear",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=r;var s=0;t&&e&&(this._gl.clearColor(e.r,e.g,e.b,void 0!==e.a?e.a:1),s|=this._gl.COLOR_BUFFER_BIT),i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),s|=this._gl.DEPTH_BUFFER_BIT),n&&(this._gl.clearStencil(0),s|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(s)}},{key:"_viewport",value:function(e,t,i,n){(e!==this._viewportCached.x||t!==this._viewportCached.y||i!==this._viewportCached.z||n!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=n,this._gl.viewport(e,t,i,n))}},{key:"setViewport",value:function(e,t,i){var n=t||this.getRenderWidth(),r=i||this.getRenderHeight(),s=e.x||0,a=e.y||0;this._cachedViewport=e,this._viewport(s*n,a*r,n*e.width,r*e.height)}},{key:"beginFrame",value:function(){}},{key:"endFrame",value:function(){this._badOS&&this.flushFramebuffer(),this._frameId++}},{key:"resize",value:function(){var e,t,i=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.adaptToDeviceRatio){var n=ne()&&window.devicePixelRatio||1,r=this._lastDevicePixelRatio/n;this._lastDevicePixelRatio=n,this._hardwareScalingLevel*=r}ne()?(e=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,t=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(e=this._renderingCanvas?this._renderingCanvas.width:100,t=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(e/this._hardwareScalingLevel,t/this._hardwareScalingLevel,i)}},{key:"setSize",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return!(!this._renderingCanvas||(e|=0,t|=0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t))&&(this._renderingCanvas.width=e,this._renderingCanvas.height=t,!0)}},{key:"bindFramebuffer",value:function(e){var t,i,n,r,s,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2?arguments[2]:void 0,l=arguments.length>3?arguments[3]:void 0,u=arguments.length>4?arguments[4]:void 0,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,d=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(d._MSAAFramebuffer?d._MSAAFramebuffer:d._framebuffer);var f=this._gl;e.is2DArray?f.framebufferTextureLayer(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,null===(t=e.texture._hardwareTexture)||void 0===t?void 0:t.underlyingResource,h,c):e.isCube&&f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_CUBE_MAP_POSITIVE_X+a,null===(i=e.texture._hardwareTexture)||void 0===i?void 0:i.underlyingResource,h);var _=e._depthStencilTexture;if(_){var v=e._depthStencilTextureWithStencil?f.DEPTH_STENCIL_ATTACHMENT:f.DEPTH_ATTACHMENT;e.is2DArray?f.framebufferTextureLayer(f.FRAMEBUFFER,v,null===(n=_._hardwareTexture)||void 0===n?void 0:n.underlyingResource,h,c):e.isCube?f.framebufferTexture2D(f.FRAMEBUFFER,v,f.TEXTURE_CUBE_MAP_POSITIVE_X+a,null===(r=_._hardwareTexture)||void 0===r?void 0:r.underlyingResource,h):f.framebufferTexture2D(f.FRAMEBUFFER,v,f.TEXTURE_2D,null===(s=_._hardwareTexture)||void 0===s?void 0:s.underlyingResource,h)}this._cachedViewport&&!u?this.setViewport(this._cachedViewport,o,l):(o||(o=e.width,h&&(o/=Math.pow(2,h))),l||(l=e.height,h&&(l/=Math.pow(2,h))),this._viewport(0,0,o,l)),this.wipeCaches()}},{key:"setState",value:function(e){var t,i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(this._depthCullingState.cull!==e||r)&&(this._depthCullingState.cull=e);var u=null===(i=null!==(t=this.cullBackFaces)&&void 0!==t?t:a)||void 0===i||i?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==u||r)&&(this._depthCullingState.cullFace=u),this.setZOffset(n),this.setZOffsetUnits(l);var h=s?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==h||r)&&(this._depthCullingState.frontFace=h),this._stencilStateComposer.stencilMaterial=o}},{key:"getDepthBuffer",value:function(){return this._depthCullingState.depthTest}},{key:"setDepthBuffer",value:function(e){this._depthCullingState.depthTest=e}},{key:"setZOffset",value:function(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}},{key:"getZOffset",value:function(){var e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}},{key:"setZOffsetUnits",value:function(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}},{key:"getZOffsetUnits",value:function(){var e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}},{key:"_bindUnboundFramebuffer",value:function(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}},{key:"_currentFrameBufferIsDefaultFrameBuffer",value:function(){return null===this._currentFramebuffer}},{key:"generateMipmaps",value:function(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}},{key:"unBindFramebuffer",value:function(e){var t,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0,r=e;this._currentRenderTarget=null;var s=this._gl;if(r._MSAAFramebuffer){if(e.isMulti)return void this.unBindMultiColorAttachmentFramebuffer(e,i,n);s.bindFramebuffer(s.READ_FRAMEBUFFER,r._MSAAFramebuffer),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,r._framebuffer),s.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,s.COLOR_BUFFER_BIT,s.NEAREST)}!(null===(t=e.texture)||void 0===t)&&t.generateMipMaps&&!i&&!e.isCube&&this.generateMipmaps(e.texture),n&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),n()),this._bindUnboundFramebuffer(null)}},{key:"flushFramebuffer",value:function(){this._gl.flush()}},{key:"restoreDefaultFramebuffer",value:function(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}},{key:"_resetVertexBufferBinding",value:function(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}},{key:"createVertexBuffer",value:function(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}},{key:"_createVertexBuffer",value:function(e,t){var i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");var n=new De(i);return this.bindArrayBuffer(n),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),n.references=1,n}},{key:"createDynamicVertexBuffer",value:function(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}},{key:"_resetIndexBufferBinding",value:function(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}},{key:"createIndexBuffer",value:function(e,t){var i=this._gl.createBuffer(),n=new De(i);if(!i)throw new Error("Unable to create index buffer");this.bindIndexBuffer(n);var r=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,r,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),n.references=1,n.is32Bits=4===r.BYTES_PER_ELEMENT,n}},{key:"_normalizeIndexData",value:function(e){if(2===e.BYTES_PER_ELEMENT)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(var t=0;t<e.length;t++)if(e[t]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}},{key:"bindArrayBuffer",value:function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}},{key:"bindUniformBlock",value:function(e,t,i){var n=e.program,r=this._gl.getUniformBlockIndex(n,t);this._gl.uniformBlockBinding(n,r,i)}},{key:"bindIndexBuffer",value:function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}},{key:"_bindBuffer",value:function(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}},{key:"updateArrayBuffer",value:function(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}},{key:"_vertexAttribPointer",value:function(e,t,i,n,r,s,a){var o=this._currentBufferPointers[t];if(o){var l=!1;o.active?(o.buffer!==e&&(o.buffer=e,l=!0),o.size!==i&&(o.size=i,l=!0),o.type!==n&&(o.type=n,l=!0),o.normalized!==r&&(o.normalized=r,l=!0),o.stride!==s&&(o.stride=s,l=!0),o.offset!==a&&(o.offset=a,l=!0)):(l=!0,o.active=!0,o.index=t,o.size=i,o.type=n,o.normalized=r,o.stride=s,o.offset=a,o.buffer=e),(l||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),n===this._gl.UNSIGNED_INT||n===this._gl.INT?this._gl.vertexAttribIPointer(t,i,n,s,a):this._gl.vertexAttribPointer(t,i,n,r,s,a))}}},{key:"_bindIndexBufferWithCache",value:function(e){null!=e&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}},{key:"_bindVertexBuffersAttributes",value:function(e,t,i){var n=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var r=0;r<n.length;r++){var s=t.getAttributeLocation(r);if(s>=0){var a=n[r],o=null;if(i&&(o=i[a]),o||(o=e[a]),!o)continue;this._gl.enableVertexAttribArray(s),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[s]=!0);var l=o.getBuffer();l&&(this._vertexAttribPointer(l,s,o.getSize(),o.type,o.normalized,o.byteStride,o.byteOffset),o.getIsInstanced()&&(this._gl.vertexAttribDivisor(s,o.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(l))))}}}},{key:"recordVertexArrayObject",value:function(e,t,i,n){var r=this._gl.createVertexArray();if(!r)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(r),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,n),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),r}},{key:"bindVertexArrayObject",value:function(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=t&&t.is32Bits,this._mustWipeVertexAttributes=!0)}},{key:"bindBuffersDirectly",value:function(e,t,i,n,r){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==r){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r;var s=r.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var a=0,o=0;o<s;o++)if(o<i.length){var l=r.getAttributeLocation(o);l>=0&&(this._gl.enableVertexAttribArray(l),this._vertexAttribArraysEnabled[l]=!0,this._vertexAttribPointer(e,l,i[o],this._gl.FLOAT,!1,n,a)),a+=4*i[o]}}this._bindIndexBufferWithCache(t)}},{key:"_unbindVertexArrayObject",value:function(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}},{key:"bindBuffers",value:function(e,t,i,n){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,n)),this._bindIndexBufferWithCache(t)}},{key:"unbindInstanceAttributes",value:function(){for(var e,t=0,i=this._currentInstanceLocations.length;t<i;t++){var n=this._currentInstanceBuffers[t];e!=n&&n.references&&(e=n,this.bindArrayBuffer(n));var r=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(r,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}},{key:"releaseVertexArrayObject",value:function(e){this._gl.deleteVertexArray(e)}},{key:"_releaseBuffer",value:function(e){return e.references--,0===e.references&&(this._deleteBuffer(e),!0)}},{key:"_deleteBuffer",value:function(e){this._gl.deleteBuffer(e.underlyingResource)}},{key:"updateAndBindInstancesBuffer",value:function(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),void 0!==i[0].index)this.bindInstancesBuffer(e,i,!0);else for(var n=0;n<4;n++){var r=i[n];this._vertexAttribArraysEnabled[r]||(this._gl.enableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!0),this._vertexAttribPointer(e,r,4,this._gl.FLOAT,!1,64,16*n),this._gl.vertexAttribDivisor(r,1),this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(e)}}},{key:"bindInstancesBuffer",value:function(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.bindArrayBuffer(e);var n=0;if(i)for(var r=0;r<t.length;r++){n+=4*t[r].attributeSize}for(var s=0;s<t.length;s++){var a=t[s];void 0===a.index&&(a.index=this._currentEffect.getAttributeLocationByName(a.attributeName)),!(a.index<0)&&(this._vertexAttribArraysEnabled[a.index]||(this._gl.enableVertexAttribArray(a.index),this._vertexAttribArraysEnabled[a.index]=!0),this._vertexAttribPointer(e,a.index,a.attributeSize,a.attributeType||this._gl.FLOAT,a.normalized||!1,n,a.offset),this._gl.vertexAttribDivisor(a.index,void 0===a.divisor?1:a.divisor),this._currentInstanceLocations.push(a.index),this._currentInstanceBuffers.push(e))}}},{key:"disableInstanceAttributeByName",value:function(e){if(this._currentEffect){var t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}}},{key:"disableInstanceAttribute",value:function(e){for(var t,i=!1;-1!==(t=this._currentInstanceLocations.indexOf(e));)this._currentInstanceLocations.splice(t,1),this._currentInstanceBuffers.splice(t,1),i=!0,t=this._currentInstanceLocations.indexOf(e);i&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}},{key:"disableAttributeByIndex",value:function(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}},{key:"draw",value:function(e,t,i,n){this.drawElementsType(e?0:1,t,i,n)}},{key:"drawPointClouds",value:function(e,t,i){this.drawArraysType(2,e,t,i)}},{key:"drawUnIndexed",value:function(e,t,i,n){this.drawArraysType(e?0:1,t,i,n)}},{key:"drawElementsType",value:function(e,t,i,n){this.applyStates(),this._reportDrawCall();var r=this._drawMode(e),s=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,a=this._uintIndicesCurrentlySet?4:2;n?this._gl.drawElementsInstanced(r,i,s,t*a,n):this._gl.drawElements(r,i,s,t*a)}},{key:"drawArraysType",value:function(e,t,i,n){this.applyStates(),this._reportDrawCall();var r=this._drawMode(e);n?this._gl.drawArraysInstanced(r,t,i,n):this._gl.drawArrays(r,t,i)}},{key:"_drawMode",value:function(e){switch(e){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}},{key:"_reportDrawCall",value:function(){}},{key:"_releaseEffect",value:function(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];var t=e.getPipelineContext();t&&this._deletePipelineContext(t)}},{key:"_deletePipelineContext",value:function(e){var t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))}},{key:"_getGlobalDefines",value:function(e){if(e)return this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,void(this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS);var t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+="\n"),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+="\n"),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}},{key:"createEffect",value:function(e,t,i,n,r,s,a,o,l){var u,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:ve.GLSL,c=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,d=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,f=this._getGlobalDefines(),_=null!==(u=null!==r&&void 0!==r?r:t.defines)&&void 0!==u?u:"";f&&(_+=f);var v=c+"+"+d+"@"+_;if(this._compiledEffects[v]){var g=this._compiledEffects[v];return a&&g.isReady()&&a(g),g}var p=new Me(e,t,i,n,this,r,s,a,o,l,v,h);return this._compiledEffects[v]=p,p}},{key:"_compileShader",value:function(t,i,n,r){return this._compileRawShader(e._ConcatenateShader(t,n,r),i)}},{key:"_compileRawShader",value:function(e,t){var i=this._gl,n=i.createShader("vertex"===t?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!n){for(var r=i.NO_ERROR,s=i.NO_ERROR;(s=i.getError())!==i.NO_ERROR;)r=s;throw new Error("Something went wrong while creating a gl ".concat(t," shader object. gl error=").concat(r,", gl isContextLost=").concat(i.isContextLost(),", _contextWasLost=").concat(this._contextWasLost))}return i.shaderSource(n,e),i.compileShader(n),n}},{key:"_getShaderSource",value:function(e){return this._gl.getShaderSource(e)}},{key:"createRawShaderProgram",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;n=n||this._gl;var s=this._compileRawShader(t,"vertex"),a=this._compileRawShader(i,"fragment");return this._createShaderProgram(e,s,a,n,r)}},{key:"createShaderProgram",value:function(e,t,i,n,r){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;r=r||this._gl;var a=this._webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"",o=this._compileShader(t,"vertex",n,a),l=this._compileShader(i,"fragment",n,a);return this._createShaderProgram(e,o,l,r,s)}},{key:"inlineShaderCode",value:function(e){return e}},{key:"createPipelineContext",value:function(e){var t=new we;return t.engine=this,this._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t}},{key:"createMaterialContext",value:function(){}},{key:"createDrawContext",value:function(){}},{key:"_createShaderProgram",value:function(e,t,i,n){var r=n.createProgram();if(e.program=r,!r)throw new Error("Unable to create program");return n.attachShader(r,t),n.attachShader(r,i),n.linkProgram(r),e.context=n,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),r}},{key:"_finalizePipelineContext",value:function(e){var t=e.context,i=e.vertexShader,n=e.fragmentShader,r=e.program;if(!t.getProgramParameter(r,t.LINK_STATUS)){if(!this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS)){var s=this._gl.getShaderInfoLog(i);if(s)throw e.vertexCompilationError=s,new Error("VERTEX SHADER "+s)}if(!this._gl.getShaderParameter(n,this._gl.COMPILE_STATUS)){var a=this._gl.getShaderInfoLog(n);if(a)throw e.fragmentCompilationError=a,new Error("FRAGMENT SHADER "+a)}var o=t.getProgramInfoLog(r);if(o)throw e.programLinkError=o,new Error(o)}if(this.validateShaderPrograms&&(t.validateProgram(r),!t.getProgramParameter(r,t.VALIDATE_STATUS))){var l=t.getProgramInfoLog(r);if(l)throw e.programValidationError=l,new Error(l)}t.deleteShader(i),t.deleteShader(n),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)}},{key:"_preparePipelineContext",value:function(e,t,i,n,r,s,a,o,l,u){var h=e;h.program=n?this.createRawShaderProgram(h,t,i,void 0,l):this.createShaderProgram(h,t,i,o,void 0,l),h.program.__SPECTOR_rebuildProgram=a}},{key:"_isRenderingStateCompiled",value:function(e){var t=e;return!!this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)&&(this._finalizePipelineContext(t),!0)}},{key:"_executeWhenRenderingStateIsCompiled",value:function(e,t){var i=e;if(i.isParallelCompiled){var n=i.onCompiled;i.onCompiled=n?function(){n(),t()}:t}else t()}},{key:"getUniforms",value:function(e,t){for(var i=new Array,n=e,r=0;r<t.length;r++)i.push(this._gl.getUniformLocation(n.program,t[r]));return i}},{key:"getAttributes",value:function(e,t){for(var i=[],n=e,r=0;r<t.length;r++)try{i.push(this._gl.getAttribLocation(n.program,t[r]))}catch(s){i.push(-1)}return i}},{key:"enableEffect",value:function(e){(e=null!==e&&Le.IsWrapper(e)?e.effect:e)&&e!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}},{key:"setInt",value:function(e,t){return!!e&&(this._gl.uniform1i(e,t),!0)}},{key:"setInt2",value:function(e,t,i){return!!e&&(this._gl.uniform2i(e,t,i),!0)}},{key:"setInt3",value:function(e,t,i,n){return!!e&&(this._gl.uniform3i(e,t,i,n),!0)}},{key:"setInt4",value:function(e,t,i,n,r){return!!e&&(this._gl.uniform4i(e,t,i,n,r),!0)}},{key:"setIntArray",value:function(e,t){return!!e&&(this._gl.uniform1iv(e,t),!0)}},{key:"setIntArray2",value:function(e,t){return!(!e||t.length%2!==0)&&(this._gl.uniform2iv(e,t),!0)}},{key:"setIntArray3",value:function(e,t){return!(!e||t.length%3!==0)&&(this._gl.uniform3iv(e,t),!0)}},{key:"setIntArray4",value:function(e,t){return!(!e||t.length%4!==0)&&(this._gl.uniform4iv(e,t),!0)}},{key:"setUInt",value:function(e,t){return!!e&&(this._gl.uniform1ui(e,t),!0)}},{key:"setUInt2",value:function(e,t,i){return!!e&&(this._gl.uniform2ui(e,t,i),!0)}},{key:"setUInt3",value:function(e,t,i,n){return!!e&&(this._gl.uniform3ui(e,t,i,n),!0)}},{key:"setUInt4",value:function(e,t,i,n,r){return!!e&&(this._gl.uniform4ui(e,t,i,n,r),!0)}},{key:"setUIntArray",value:function(e,t){return!!e&&(this._gl.uniform1uiv(e,t),!0)}},{key:"setUIntArray2",value:function(e,t){return!(!e||t.length%2!==0)&&(this._gl.uniform2uiv(e,t),!0)}},{key:"setUIntArray3",value:function(e,t){return!(!e||t.length%3!==0)&&(this._gl.uniform3uiv(e,t),!0)}},{key:"setUIntArray4",value:function(e,t){return!(!e||t.length%4!==0)&&(this._gl.uniform4uiv(e,t),!0)}},{key:"setArray",value:function(e,t){return!(!e||t.length<1)&&(this._gl.uniform1fv(e,t),!0)}},{key:"setArray2",value:function(e,t){return!(!e||t.length%2!==0)&&(this._gl.uniform2fv(e,t),!0)}},{key:"setArray3",value:function(e,t){return!(!e||t.length%3!==0)&&(this._gl.uniform3fv(e,t),!0)}},{key:"setArray4",value:function(e,t){return!(!e||t.length%4!==0)&&(this._gl.uniform4fv(e,t),!0)}},{key:"setMatrices",value:function(e,t){return!!e&&(this._gl.uniformMatrix4fv(e,!1,t),!0)}},{key:"setMatrix3x3",value:function(e,t){return!!e&&(this._gl.uniformMatrix3fv(e,!1,t),!0)}},{key:"setMatrix2x2",value:function(e,t){return!!e&&(this._gl.uniformMatrix2fv(e,!1,t),!0)}},{key:"setFloat",value:function(e,t){return!!e&&(this._gl.uniform1f(e,t),!0)}},{key:"setFloat2",value:function(e,t,i){return!!e&&(this._gl.uniform2f(e,t,i),!0)}},{key:"setFloat3",value:function(e,t,i,n){return!!e&&(this._gl.uniform3f(e,t,i,n),!0)}},{key:"setFloat4",value:function(e,t,i,n,r){return!!e&&(this._gl.uniform4f(e,t,i,n,r),!0)}},{key:"applyStates",value:function(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;var e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}},{key:"setColorWrite",value:function(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}},{key:"getColorWrite",value:function(){return this._colorWrite}},{key:"depthCullingState",get:function(){return this._depthCullingState}},{key:"alphaState",get:function(){return this._alphaState}},{key:"stencilState",get:function(){return this._stencilState}},{key:"stencilStateComposer",get:function(){return this._stencilStateComposer}},{key:"clearInternalTexturesCache",value:function(){this._internalTexturesCache.length=0}},{key:"wipeCaches",value:function(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}},{key:"_getSamplingParameters",value:function(e,t){var i=this._gl,n=i.NEAREST,r=i.NEAREST;switch(e){case 11:n=i.LINEAR,r=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 3:n=i.LINEAR,r=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 8:n=i.NEAREST,r=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 4:n=i.NEAREST,r=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 5:n=i.NEAREST,r=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 6:n=i.NEAREST,r=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 7:n=i.NEAREST,r=i.LINEAR;break;case 1:n=i.NEAREST,r=i.NEAREST;break;case 9:n=i.LINEAR,r=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 10:n=i.LINEAR,r=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 2:n=i.LINEAR,r=i.LINEAR;break;case 12:n=i.LINEAR,r=i.NEAREST}return{min:r,mag:n}}},{key:"_createTexture",value:function(){var e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}},{key:"_createHardwareTexture",value:function(){return new Oe(this._createTexture(),this._gl)}},{key:"_createInternalTexture",value:function(e,t){var i,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:q.Unknown,r=!1,s=0,a=3,o=5,l=!1,u=1;void 0!==t&&"object"==typeof t?(r=!!t.generateMipMaps,s=void 0===t.type?0:t.type,a=void 0===t.samplingMode?3:t.samplingMode,o=void 0===t.format?5:t.format,l=void 0!==t.useSRGBBuffer&&t.useSRGBBuffer,u=null!==(i=t.samples)&&void 0!==i?i:1):r=!!t,l&&(l=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1===s&&!this._caps.textureFloatLinearFiltering||2===s&&!this._caps.textureHalfFloatLinearFiltering)&&(a=1),1===s&&!this._caps.textureFloat&&(s=0,ue.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));var h=this._gl,c=new ie(this,n),d=e.width||e,f=e.height||e,_=e.layers||0,v=this._getSamplingParameters(a,r),g=0!==_?h.TEXTURE_2D_ARRAY:h.TEXTURE_2D,p=this._getRGBABufferInternalSizedFormat(s,o,l),m=this._getInternalFormat(o),y=this._getWebGLTextureType(s);return this._bindTextureDirectly(g,c),0!==_?(c.is2DArray=!0,h.texImage3D(g,0,p,d,f,_,0,m,y,null)):h.texImage2D(g,0,p,d,f,0,m,y,null),h.texParameteri(g,h.TEXTURE_MAG_FILTER,v.mag),h.texParameteri(g,h.TEXTURE_MIN_FILTER,v.min),h.texParameteri(g,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(g,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),r&&this._gl.generateMipmap(g),this._bindTextureDirectly(g,null),c._useSRGBBuffer=l,c.baseWidth=d,c.baseHeight=f,c.width=d,c.height=f,c.depth=_,c.isReady=!0,c.samples=u,c.generateMipMaps=r,c.samplingMode=a,c.type=s,c.format=o,this._internalTexturesCache.push(c),c}},{key:"_getUseSRGBBuffer",value:function(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||t)}},{key:"_createTextureBase",value:function(t,i,n,r){var s=this,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,u=arguments.length>7?arguments[7]:void 0,h=arguments.length>8?arguments[8]:void 0,c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,d=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,f=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,_=arguments.length>12&&void 0!==arguments[12]?arguments[12]:null,v=arguments.length>13?arguments[13]:void 0,g=arguments.length>14?arguments[14]:void 0,m=arguments.length>15?arguments[15]:void 0,y="data:"===(t=t||"").substr(0,5),T="blob:"===t.substr(0,5),E=y&&-1!==t.indexOf(";base64,"),S=d||new ie(this,q.Url),b=t;this._transformTextureUrl&&!E&&!d&&!c&&(t=this._transformTextureUrl(t)),b!==t&&(S._originalUrl=b);var x=t.lastIndexOf("."),M=_||(x>-1?t.substring(x).toLowerCase():""),A=null;M.indexOf("?")>-1&&(M=M.split("?")[0]);var R,C=(0,p.Z)(e._TextureLoaders);try{for(C.s();!(R=C.n()).done;){var I=R.value;if(I.canLoad(M,v)){A=I;break}}}catch(w){C.e(w)}finally{C.f()}r&&r.addPendingData(S),S.url=t,S.generateMipMaps=!i,S.samplingMode=a,S.invertY=n,S._useSRGBBuffer=this._getUseSRGBBuffer(!!m,i),this._doNotHandleContextLost||(S._buffer=c);var P=null;o&&!d&&(P=S.onLoadedObservable.add(o)),d||this._internalTexturesCache.push(S);var k=function(e,n){r&&r.removePendingData(S),t===b?(P&&S.onLoadedObservable.remove(P),V.UseFallbackTexture&&s._createTextureBase(V.FallbackTexture,i,S.invertY,r,a,null,l,u,h,c,S),e=(e||"Unknown error")+(V.UseFallbackTexture?" - Fallback texture was used":""),S.onErrorObservable.notifyObservers({message:e,exception:n}),l&&l(e,n)):(ue.Warn("Failed to load ".concat(t,", falling back to ").concat(b)),s._createTextureBase(b,i,S.invertY,r,a,o,l,u,h,c,S,f,_,v,g,m))};if(A){var D=function(e){A.loadData(e,S,(function(e,t,i,n,s,o){o?k("TextureLoader failed to load data"):u(S,M,r,{width:e,height:t},S.invertY,!i,n,(function(){return s(),!1}),a)}),g)};c?c instanceof ArrayBuffer?D(new Uint8Array(c)):ArrayBuffer.isView(c)?D(c):l&&l("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(t,(function(e){return D(new Uint8Array(e))}),void 0,r?r.offlineProvider:void 0,!0,(function(e,t){k("Unable to load "+(e&&e.responseURL,t))}))}else{var F=function(e){T&&!s._doNotHandleContextLost&&(S._buffer=e),u(S,M,r,e,S.invertY,i,!1,h,a)};!y||E?c&&("string"==typeof c.decoding||c.close)?F(c):e._FileToolsLoadImage(t,F,k,r?r.offlineProvider:null,v,S.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):"string"==typeof c||c instanceof ArrayBuffer||ArrayBuffer.isView(c)||c instanceof Blob?e._FileToolsLoadImage(c,F,k,r?r.offlineProvider:null,v,S.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):c&&F(c)}return S}},{key:"createTexture",value:function(e,t,i,n){var r=this,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,d=arguments.length>11?arguments[11]:void 0,f=arguments.length>12?arguments[12]:void 0,_=arguments.length>14?arguments[14]:void 0;return this._createTextureBase(e,t,i,n,s,a,o,this._prepareWebGLTexture.bind(this),(function(e,t,i,s,a,o){var l=r._gl,u=i.width===e&&i.height===t,c=h?r._getInternalFormat(h,a._useSRGBBuffer):".jpg"!==s||a._useSRGBBuffer?a._useSRGBBuffer?l.SRGB8_ALPHA8:l.RGBA:l.RGB,d=h?r._getInternalFormat(h):".jpg"!==s||a._useSRGBBuffer?l.RGBA:l.RGB;if(a._useSRGBBuffer&&1===r.webGLVersion&&(d=c),u)return l.texImage2D(l.TEXTURE_2D,0,c,d,l.UNSIGNED_BYTE,i),!1;var f=r._caps.maxTextureSize;if(i.width>f||i.height>f||!r._supportsHardwareTextureRescaling)return r._prepareWorkingCanvas(),!r._workingCanvas||!r._workingContext||(r._workingCanvas.width=e,r._workingCanvas.height=t,r._workingContext.drawImage(i,0,0,i.width,i.height,0,0,e,t),l.texImage2D(l.TEXTURE_2D,0,c,d,l.UNSIGNED_BYTE,r._workingCanvas),a.width=e,a.height=t),!1;var _=new ie(r,q.Temp);return r._bindTextureDirectly(l.TEXTURE_2D,_,!0),l.texImage2D(l.TEXTURE_2D,0,c,d,l.UNSIGNED_BYTE,i),r._rescaleTexture(_,a,n,c,(function(){r._releaseTexture(_),r._bindTextureDirectly(l.TEXTURE_2D,a,!0),o()})),!0}),l,u,h,c,d,f,_)}},{key:"_rescaleTexture",value:function(e,t,i,n,r){}},{key:"createRawTexture",value:function(e,t,i,n,r,s,a){throw le("Engine.RawTexture")}},{key:"createRawCubeTexture",value:function(e,t,i,n,r,s,a){throw le("Engine.RawTexture")}},{key:"createRawTexture3D",value:function(e,t,i,n,r,s,a,o){throw le("Engine.RawTexture")}},{key:"createRawTexture2DArray",value:function(e,t,i,n,r,s,a,o){throw le("Engine.RawTexture")}},{key:"_unpackFlipY",value:function(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}},{key:"_getUnpackAlignement",value:function(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}},{key:"_getTextureTarget",value:function(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}},{key:"updateTextureSamplingMode",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this._getTextureTarget(t),r=this._getSamplingParameters(e,t.generateMipMaps||i);this._setTextureParameterInteger(n,this._gl.TEXTURE_MAG_FILTER,r.mag,t),this._setTextureParameterInteger(n,this._gl.TEXTURE_MIN_FILTER,r.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(n)),this._bindTextureDirectly(n,null),t.samplingMode=e}},{key:"updateTextureDimensions",value:function(e,t,i){}},{key:"updateTextureWrappingMode",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=this._getTextureTarget(e);null!==t&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),null!==i&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&null!==n&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(n),e),e._cachedWrapR=n),this._bindTextureDirectly(r,null)}},{key:"_setupDepthStencilTexture",value:function(e,t,i,n,r){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,a=t.width||t,o=t.height||t,l=t.layers||0;e.baseWidth=a,e.baseHeight=o,e.width=a,e.height=o,e.is2DArray=l>0,e.depth=l,e.isReady=!0,e.samples=s,e.generateMipMaps=!1,e.samplingMode=n?2:1,e.type=0,e._comparisonFunction=r;var u=this._gl,h=this._getTextureTarget(e),c=this._getSamplingParameters(e.samplingMode,!1);u.texParameteri(h,u.TEXTURE_MAG_FILTER,c.mag),u.texParameteri(h,u.TEXTURE_MIN_FILTER,c.min),u.texParameteri(h,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(h,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===r?(u.texParameteri(h,u.TEXTURE_COMPARE_FUNC,515),u.texParameteri(h,u.TEXTURE_COMPARE_MODE,u.NONE)):(u.texParameteri(h,u.TEXTURE_COMPARE_FUNC,r),u.texParameteri(h,u.TEXTURE_COMPARE_MODE,u.COMPARE_REF_TO_TEXTURE)))}},{key:"_uploadCompressedDataToTextureDirectly",value:function(e,t,i,n,r){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,o=this._gl,l=o.TEXTURE_2D;if(e.isCube&&(l=o.TEXTURE_CUBE_MAP_POSITIVE_X+s),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=o.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=o.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=o.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=o.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=o.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=o.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=o.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1}this._gl.compressedTexImage2D(l,a,t,i,n,0,r)}},{key:"_uploadDataToTextureDirectly",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4?arguments[4]:void 0,s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=this._gl,o=this._getWebGLTextureType(e.type),l=this._getInternalFormat(e.format),u=void 0===r?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(r,e._useSRGBBuffer);this._unpackFlipY(e.invertY);var h=a.TEXTURE_2D;e.isCube&&(h=a.TEXTURE_CUBE_MAP_POSITIVE_X+i);var c=Math.round(Math.log(e.width)*Math.LOG2E),d=Math.round(Math.log(e.height)*Math.LOG2E),f=s?e.width:Math.pow(2,Math.max(c-n,0)),_=s?e.height:Math.pow(2,Math.max(d-n,0));a.texImage2D(h,n,u,f,_,0,l,o,t)}},{key:"updateTextureData",value:function(e,t,i,n,r,s){var a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]&&arguments[8],u=this._gl,h=this._getWebGLTextureType(e.type),c=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);var d=u.TEXTURE_2D,f=u.TEXTURE_2D;e.isCube&&(f=u.TEXTURE_CUBE_MAP_POSITIVE_X+a,d=u.TEXTURE_CUBE_MAP),this._bindTextureDirectly(d,e,!0),u.texSubImage2D(f,o,i,n,r,s,c,h,t),l&&this._gl.generateMipmap(f),this._bindTextureDirectly(d,null)}},{key:"_uploadArrayBufferViewToTexture",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=this._gl,s=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(s,e,!0),this._uploadDataToTextureDirectly(e,t,i,n),this._bindTextureDirectly(s,null,!0)}},{key:"_prepareWebGLTextureContinuation",value:function(e,t,i,n,r){var s=this._gl;if(s){var a=this._getSamplingParameters(r,!i);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,a.mag),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,a.min),!i&&!n&&s.generateMipmap(s.TEXTURE_2D),this._bindTextureDirectly(s.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}}},{key:"_prepareWebGLTexture",value:function(t,i,n,r,s,a,o,l){var u=this,h=arguments.length>8&&void 0!==arguments[8]?arguments[8]:3,c=this.getCaps().maxTextureSize,d=Math.min(c,this.needPOTTextures?e.GetExponentOfTwo(r.width,c):r.width),f=Math.min(c,this.needPOTTextures?e.GetExponentOfTwo(r.height,c):r.height),_=this._gl;if(_){if(!t._hardwareTexture)return void(n&&n.removePendingData(t));this._bindTextureDirectly(_.TEXTURE_2D,t,!0),this._unpackFlipY(void 0===s||!!s),t.baseWidth=r.width,t.baseHeight=r.height,t.width=d,t.height=f,t.isReady=!0,!l(d,f,r,i,t,(function(){u._prepareWebGLTextureContinuation(t,n,a,o,h)}))&&this._prepareWebGLTextureContinuation(t,n,a,o,h)}}},{key:"_setupFramebufferDepthAttachments",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=this._gl;if(e&&t)return this._createRenderBuffer(i,n,r,s.DEPTH_STENCIL,s.DEPTH24_STENCIL8,s.DEPTH_STENCIL_ATTACHMENT);if(t){var a=s.DEPTH_COMPONENT16;return this._webGLVersion>1&&(a=s.DEPTH_COMPONENT32F),this._createRenderBuffer(i,n,r,a,a,s.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(i,n,r,s.STENCIL_INDEX8,s.STENCIL_INDEX8,s.STENCIL_ATTACHMENT):null}},{key:"_createRenderBuffer",value:function(e,t,i,n,r,s){var a=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],o=this._gl.createRenderbuffer();return this._updateRenderBuffer(o,e,t,i,n,r,s,a)}},{key:"_updateRenderBuffer",value:function(e,t,i,n,r,s,a){var o=!(arguments.length>7&&void 0!==arguments[7])||arguments[7],l=this._gl;return l.bindRenderbuffer(l.RENDERBUFFER,e),n>1&&l.renderbufferStorageMultisample?l.renderbufferStorageMultisample(l.RENDERBUFFER,n,s,t,i):l.renderbufferStorage(l.RENDERBUFFER,r,t,i),l.framebufferRenderbuffer(l.FRAMEBUFFER,a,l.RENDERBUFFER,e),o&&l.bindRenderbuffer(l.RENDERBUFFER,null),e}},{key:"_releaseTexture",value:function(e){var t;this._deleteTexture(null===(t=e._hardwareTexture)||void 0===t?void 0:t.underlyingResource),this.unbindAllTextures();var i=this._internalTexturesCache.indexOf(e);-1!==i&&this._internalTexturesCache.splice(i,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}},{key:"_releaseRenderTargetWrapper",value:function(e){var t=this._renderTargetWrapperCache.indexOf(e);-1!==t&&this._renderTargetWrapperCache.splice(t,1)}},{key:"_deleteTexture",value:function(e){e&&this._gl.deleteTexture(e)}},{key:"_setProgram",value:function(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)}},{key:"bindSamplers",value:function(e){var t=e.getPipelineContext();this._setProgram(t.program);for(var i=e.getSamplers(),n=0;n<i.length;n++){var r=e.getUniform(i[n]);r&&(this._boundUniforms[n]=r)}this._currentEffect=null}},{key:"_activateCurrentTexture",value:function(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}},{key:"_bindTextureDirectly",value:function(e,t){var i,n,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=!1,o=t&&t._associatedChannel>-1;if(r&&o&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||s){if(this._activateCurrentTexture(),t&&t.isMultiview)throw console.error(e,t),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,null!==(n=null===(i=null==t?void 0:t._hardwareTexture)||void 0===i?void 0:i.underlyingResource)&&void 0!==n?n:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else r&&(a=!0,this._activateCurrentTexture());return o&&!r&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),a}},{key:"_bindTexture",value:function(e,t,i){if(void 0!==e){t&&(t._associatedChannel=e),this._activeChannel=e;var n=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(n,t)}}},{key:"unbindAllTextures",value:function(){for(var e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}},{key:"setTexture",value:function(e,t,i,n){void 0!==e&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}},{key:"_bindSamplerUniformToChannel",value:function(e,t){var i=this._boundUniforms[e];!i||i._currentState===t||(this._gl.uniform1i(i,t),i._currentState=t)}},{key:"_getTextureWrapMode",value:function(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}},{key:"_setTexture",value:function(e,t){var i,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video)this._activeChannel=e,t.update();else if(4===t.delayLoadState)return t.delayLoad(),!1;i=r?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!n&&i&&(i._associatedChannel=e);var s=!0;this._boundTexturesCache[e]===i&&(n||this._bindSamplerUniformToChannel(i._associatedChannel,e),s=!1),this._activeChannel=e;var a=this._getTextureTarget(i);if(s&&this._bindTextureDirectly(a,i,n),i&&!i.isMultiview){if(i.isCube&&i._cachedCoordinatesMode!==t.coordinatesMode){i._cachedCoordinatesMode=t.coordinatesMode;var o=3!==t.coordinatesMode&&5!==t.coordinatesMode?1:0;t.wrapU=o,t.wrapV=o}i._cachedWrapU!==t.wrapU&&(i._cachedWrapU=t.wrapU,this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),i)),i._cachedWrapV!==t.wrapV&&(i._cachedWrapV=t.wrapV,this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),i)),i.is3D&&i._cachedWrapR!==t.wrapR&&(i._cachedWrapR=t.wrapR,this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),i)),this._setAnisotropicLevel(a,i,t.anisotropicFilteringLevel)}return!0}},{key:"setTextureArray",value:function(e,t,i,n){if(void 0!==e&&t){(!this._textureUnits||this._textureUnits.length!==i.length)&&(this._textureUnits=new Int32Array(i.length));for(var r=0;r<i.length;r++){var s=i[r].getInternalTexture();s?(this._textureUnits[r]=e+r,s._associatedChannel=e+r):this._textureUnits[r]=-1}this._gl.uniform1iv(t,this._textureUnits);for(var a=0;a<i.length;a++)this._setTexture(this._textureUnits[a],i[a],!0)}}},{key:"_setAnisotropicLevel",value:function(e,t,i){var n=this._caps.textureAnisotropicFilterExtension;11!==t.samplingMode&&3!==t.samplingMode&&2!==t.samplingMode&&(i=1),n&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}},{key:"_setTextureParameterFloat",value:function(e,t,i,n){this._bindTextureDirectly(e,n,!0,!0),this._gl.texParameterf(e,t,i)}},{key:"_setTextureParameterInteger",value:function(e,t,i,n){n&&this._bindTextureDirectly(e,n,!0,!0),this._gl.texParameteri(e,t,i)}},{key:"unbindAllAttributes",value:function(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(var e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e)}else for(var t=0,i=this._vertexAttribArraysEnabled.length;t<i;t++)t>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[t]||this.disableAttributeByIndex(t)}},{key:"releaseEffects",value:function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}},{key:"dispose",value:function(){var e;this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),null===(e=this.releaseComputeEffects)||void 0===e||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},ne()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,Me.ResetCache();var t,i=(0,p.Z)(this._activeRequests);try{for(i.s();!(t=i.n()).done;){t.value.abort()}}catch(n){i.e(n)}finally{i.f()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}},{key:"attachContextLostEvent",value:function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}},{key:"attachContextRestoredEvent",value:function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}},{key:"getError",value:function(){return this._gl.getError()}},{key:"_canRenderToFloatFramebuffer",value:function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}},{key:"_canRenderToHalfFloatFramebuffer",value:function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}},{key:"_canRenderToFramebuffer",value:function(e){for(var t=this._gl;t.getError()!==t.NO_ERROR;);var i=!0,n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);var r=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n,0);var s=t.checkFramebufferStatus(t.FRAMEBUFFER);if((i=(i=i&&s===t.FRAMEBUFFER_COMPLETE)&&t.getError()===t.NO_ERROR)&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);var a=t.RGBA,o=t.UNSIGNED_BYTE,l=new Uint8Array(4);t.readPixels(0,0,1,1,a,o,l),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(n),t.deleteFramebuffer(r),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}},{key:"_getWebGLTextureType",value:function(e){if(1===this._webGLVersion){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}},{key:"_getInternalFormat",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._gl.SRGB:this._gl.RGB;break;case 5:i=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER}return i}},{key:"_getRGBABufferInternalSizedFormat",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(1===this._webGLVersion){if(void 0!==t)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._gl.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._gl.SRGB8:this._gl.RGB8;case 5:return i?this._gl.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return i?this._gl.SRGB8_ALPHA8:this._gl.RGBA8}},{key:"_getRGBAMultiSampleBufferFormat",value:function(e){return 1===e?this._gl.RGBA32F:2===e?this._gl.RGBA16F:this._gl.RGBA8}},{key:"_loadFile",value:function(t,i,n,r,s,a){var o=this,l=e._FileToolsLoadFile(t,i,n,r,s,a);return this._activeRequests.push(l),l.onCompleteObservable.add((function(e){o._activeRequests.splice(o._activeRequests.indexOf(e),1)})),l}},{key:"readPixels",value:function(e,t,i,n){var r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=r?4:3,o=r?this._gl.RGBA:this._gl.RGB,l=new Uint8Array(n*i*a);return s&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,n,o,this._gl.UNSIGNED_BYTE,l),Promise.resolve(l)}},{key:"getHostDocument",value:function(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:se()?document:null}}],[{key:"NpmPackage",get:function(){return"babylonjs@5.43.0"}},{key:"Version",get:function(){return"5.43.0"}},{key:"ShadersRepository",get:function(){return Me.ShadersRepository},set:function(e){Me.ShadersRepository=e}},{key:"_CreateCanvas",value:function(e,t){if(typeof document>"u")return new OffscreenCanvas(e,t);var i=document.createElement("canvas");return i.width=e,i.height=t,i}},{key:"_ConcatenateShader",value:function(e,t){return(arguments.length>2&&void 0!==arguments[2]?arguments[2]:"")+(t?t+"\n":"")+e}},{key:"_FileToolsLoadImage",value:function(e,t,i,n,r,s){throw le("FileTools")}},{key:"_FileToolsLoadFile",value:function(e,t,i,n,r,s){throw le("FileTools")}},{key:"IsSupportedAsync",get:function(){return Promise.resolve(this.isSupported())}},{key:"IsSupported",get:function(){return this.isSupported()}},{key:"isSupported",value:function(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{var e=this._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=null!=t&&!!window.WebGLRenderingContext}catch(i){this._IsSupported=!1}return this._IsSupported}},{key:"HasMajorPerformanceCaveat",get:function(){if(null===this._HasMajorPerformanceCaveat)try{var e=this._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch(i){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}},{key:"CeilingPOT",value:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}},{key:"FloorPOT",value:function(e){return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)-(e>>1)}},{key:"NearestPOT",value:function(t){var i=e.CeilingPOT(t),n=e.FloorPOT(t);return i-t>t-n?n:i}},{key:"GetExponentOfTwo",value:function(t,i){var n;switch(arguments.length>2&&void 0!==arguments[2]?arguments[2]:2){case 1:n=e.FloorPOT(t);break;case 2:n=e.NearestPOT(t);break;default:n=e.CeilingPOT(t)}return Math.min(n,i)}},{key:"QueueNewFrame",value:function(e,t){if(ne()){var i=t||window,n=i.requestPostAnimationFrame,r=i.requestAnimationFrame;if("function"==typeof n)return n(e);if("function"==typeof r)return r(e)}else if("function"==typeof requestAnimationFrame)return requestAnimationFrame(e);return setTimeout(e,16)}}]),e}();Ve.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],Ve._TextureLoaders=[],Ve.CollisionsEpsilon=.001,Ve._IsSupported=null,Ve._HasMajorPerformanceCaveat=null;var Ge=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;(0,m.Z)(this,e),this._enabled=!0,this._rollingFrameTime=new We(t)}return(0,y.Z)(e,[{key:"sampleFrame",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Be.Now;if(this._enabled){if(null!=this._lastFrameTimeMs){var t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}},{key:"averageFrameTime",get:function(){return this._rollingFrameTime.average}},{key:"averageFrameTimeVariance",get:function(){return this._rollingFrameTime.variance}},{key:"instantaneousFrameTime",get:function(){return this._rollingFrameTime.history(0)}},{key:"averageFPS",get:function(){return 1e3/this._rollingFrameTime.average}},{key:"instantaneousFPS",get:function(){var e=this._rollingFrameTime.history(0);return 0===e?0:1e3/e}},{key:"isSaturated",get:function(){return this._rollingFrameTime.isSaturated()}},{key:"enable",value:function(){this._enabled=!0}},{key:"disable",value:function(){this._enabled=!1,this._lastFrameTimeMs=null}},{key:"isEnabled",get:function(){return this._enabled}},{key:"reset",value:function(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}]),e}(),We=function(){function e(t){(0,m.Z)(this,e),this._samples=new Array(t),this.reset()}return(0,y.Z)(e,[{key:"add",value:function(e){var t;if(this.isSaturated()){var i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}},{key:"history",value:function(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;var t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}},{key:"isSaturated",value:function(){return this._sampleCount>=this._samples.length}},{key:"reset",value:function(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}},{key:"_wrapPosition",value:function(e){var t=this._samples.length;return(e%t+t)%t}}]),e}(),ze=function(){function e(){(0,m.Z)(this,e),this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}return(0,y.Z)(e,[{key:"min",get:function(){return this._min}},{key:"max",get:function(){return this._max}},{key:"average",get:function(){return this._average}},{key:"lastSecAverage",get:function(){return this._lastSecAverage}},{key:"current",get:function(){return this._current}},{key:"total",get:function(){return this._totalAccumulated}},{key:"count",get:function(){return this._totalValueCount}},{key:"fetchNewFrame",value:function(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}},{key:"addCount",value:function(t,i){e.Enabled&&(this._current+=t,i&&this._fetchResult())}},{key:"beginMonitoring",value:function(){e.Enabled&&(this._startMonitoringTime=Be.Now)}},{key:"endMonitoring",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(e.Enabled){t&&this.fetchNewFrame();var i=Be.Now;this._current=i-this._startMonitoringTime,t&&this._fetchResult()}}},{key:"_fetchResult",value:function(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;var e=Be.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}]),e}();ze.Enabled=!0,Ve.prototype.setAlphaConstants=function(e,t,i,n){this._alphaState.setAlphaBlendConstants(e,t,i,n)},Ve.prototype.setAlphaMode=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._alphaMode!==e){switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}t||(this.depthCullingState.depthMask=0===e),this._alphaMode=e}},Ve.prototype.getAlphaMode=function(){return this._alphaMode},Ve.prototype.setAlphaEquation=function(e){if(this._alphaEquation!==e){switch(e){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=e}},Ve.prototype.getAlphaEquation=function(){return this._alphaEquation},Ve.prototype._readTexturePixelsSync=function(e,t,i){var n,r,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,l=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],u=arguments.length>7&&void 0!==arguments[7]&&arguments[7],h=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,d=this._gl;if(!d)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){var f=d.createFramebuffer();if(!f)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=f}d.bindFramebuffer(d.FRAMEBUFFER,this._dummyFramebuffer),s>-1?d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+s,null===(n=e._hardwareTexture)||void 0===n?void 0:n.underlyingResource,a):d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,null===(r=e._hardwareTexture)||void 0===r?void 0:r.underlyingResource,a);var _=void 0!==e.type?this._getWebGLTextureType(e.type):d.UNSIGNED_BYTE;if(u)o||(o=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3?arguments[3]:void 0;switch(e){case 3:var r=(ArrayBuffer,new Int8Array(t));return n&&r.set(new Int8Array(n)),r;case 0:var s=(ArrayBuffer,new Uint8Array(t));return n&&s.set(new Uint8Array(n)),s;case 4:var a=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(i?t/2:t);return n&&a.set(new Int16Array(n)),a;case 5:case 8:case 9:case 10:case 2:var o=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(i?t/2:t);return n&&o.set(new Uint16Array(n)),o;case 6:var l=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(i?t/4:t);return n&&l.set(new Int32Array(n)),l;case 7:case 11:case 12:case 13:case 14:case 15:var u=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(i?t/4:t);return n&&u.set(new Uint32Array(n)),u;case 1:var h=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(i?t/4:t);return n&&h.set(new Float32Array(n)),h}var c=(ArrayBuffer,new Uint8Array(t));return n&&c.set(new Uint8Array(n)),c}(e.type,4*t*i));else if(_===d.UNSIGNED_BYTE)o||(o=new Uint8Array(4*t*i)),_=d.UNSIGNED_BYTE;else o||(o=new Float32Array(4*t*i)),_=d.FLOAT;return l&&this.flushFramebuffer(),d.readPixels(h,c,t,i,d.RGBA,_,o),d.bindFramebuffer(d.FRAMEBUFFER,this._currentFramebuffer),o},Ve.prototype._readTexturePixels=function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],o=arguments.length>7&&void 0!==arguments[7]&&arguments[7],l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;return Promise.resolve(this._readTexturePixelsSync(e,t,i,n,r,s,a,o,l,u))},Ve.prototype.updateDynamicIndexBuffer=function(e,t){var i;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(e),i=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},Ve.prototype.updateDynamicVertexBuffer=function(e,t,i,n){this.bindArrayBuffer(e),void 0===i&&(i=0);var r=t.byteLength||t.length;void 0===n||n>=r&&0===i?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t).subarray(i,i+n)):(t=t instanceof ArrayBuffer?new Uint8Array(t,i,n):new Uint8Array(t.buffer,t.byteOffset+i,n),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)),this._resetVertexBufferBinding()};var Xe=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r){var s,a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if((0,m.Z)(this,i),(s=t.call(this,e,n,r,a)).enableOfflineSupport=!1,s.disableManifestCheck=!1,s.disableContextMenu=!0,s.scenes=new Array,s._virtualScenes=new Array,s.onNewSceneAddedObservable=new ee,s.postProcesses=new Array,s.isPointerLock=!1,s.onResizeObservable=new ee,s.onCanvasBlurObservable=new ee,s.onCanvasFocusObservable=new ee,s.onCanvasPointerOutObservable=new ee,s.onBeginFrameObservable=new ee,s.customAnimationFrameRequester=null,s.onEndFrameObservable=new ee,s.onBeforeShaderCompilationObservable=new ee,s.onAfterShaderCompilationObservable=new ee,s._deterministicLockstep=!1,s._lockstepMaxSteps=4,s._timeStep=1/60,s._fps=60,s._deltaTime=0,s._drawCalls=new ze,s.canvasTabIndex=1,s.disablePerformanceMonitorInBackground=!1,s._performanceMonitor=new Ge,s._compatibilityMode=!0,s.currentRenderPassId=0,s._renderPassNames=["main"],i.Instances.push((0,u.Z)(s)),e){if(s._features.supportRenderPasses=!0,r=s._creationOptions,e.getContext){var o=e;s._sharedInit(o,!!r.doNotHandleTouchAction,r.audioEngine),se()&&(s._onFullscreenChange=function(){s.isFullscreen=!!document.fullscreenElement,s.isFullscreen&&s._pointerLockRequested&&o&&i._RequestPointerlock(o)},document.addEventListener("fullscreenchange",s._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",s._onFullscreenChange,!1),s._onPointerLockChange=function(){s.isPointerLock=document.pointerLockElement===o},document.addEventListener("pointerlockchange",s._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",s._onPointerLockChange,!1),!i.audioEngine&&r.audioEngine&&i.AudioEngineFactory&&(i.audioEngine=i.AudioEngineFactory(s.getRenderingCanvas(),s.getAudioContext(),s.getAudioDestination()))),s._connectVREvents(),s.enableOfflineSupport=void 0!==i.OfflineProviderFactory,s._deterministicLockstep=!!r.deterministicLockstep,s._lockstepMaxSteps=r.lockstepMaxSteps||0,s._timeStep=r.timeStep||1/60}s._prepareVRComponent(),r.autoEnableWebVR&&s.initWebVR()}return(0,l.Z)(s)}return(0,y.Z)(i,[{key:"_createImageBitmapFromSource",value:function(e,t){var i=this;return new Promise((function(n,r){var s=new Image;s.onload=function(){s.decode().then((function(){i.createImageBitmap(s,t).then((function(e){n(e)}))}))},s.onerror=function(){r("Error loading image ".concat(s.src))},s.src=e}))}},{key:"createImageBitmap",value:function(e){function t(t,i){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e,t){return createImageBitmap(e,t)}))},{key:"resizeImageBitmap",value:function(e,t,i){var n=this.createCanvas(t,i).getContext("2d");if(!n)throw new Error("Unable to get 2d context for resizeImageBitmap");return n.drawImage(e,0,0),n.getImageData(0,0,t,i).data}},{key:"_supportsHardwareTextureRescaling",get:function(){return!!i._RescalePostProcessFactory}},{key:"performanceMonitor",get:function(){return this._performanceMonitor}},{key:"compatibilityMode",get:function(){return this._compatibilityMode},set:function(e){this._compatibilityMode=!0}},{key:"getInputElement",value:function(){return this._renderingCanvas}},{key:"_initGLContext",value:function(){c((0,h.Z)(i.prototype),"_initGLContext",this).call(this),this._rescalePostProcess=null}},{key:"_sharedInit",value:function(e,t,n){var r=this;c((0,h.Z)(i.prototype),"_sharedInit",this).call(this,e,t,n),this._onCanvasFocus=function(){r.onCanvasFocusObservable.notifyObservers(r)},this._onCanvasBlur=function(){r.onCanvasBlurObservable.notifyObservers(r)},this._onCanvasContextMenu=function(e){r.disableContextMenu&&e.preventDefault()},e.addEventListener("focus",this._onCanvasFocus),e.addEventListener("blur",this._onCanvasBlur),e.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=function(){r.disablePerformanceMonitorInBackground&&r._performanceMonitor.disable(),r._windowIsBackground=!0},this._onFocus=function(){r.disablePerformanceMonitorInBackground&&r._performanceMonitor.enable(),r._windowIsBackground=!1},this._onCanvasPointerOut=function(t){document.elementFromPoint(t.clientX,t.clientY)!==e&&r.onCanvasPointerOutObservable.notifyObservers(t)};var s=this.getHostWindow();s&&"function"==typeof s.addEventListener&&(s.addEventListener("blur",this._onBlur),s.addEventListener("focus",this._onFocus)),e.addEventListener("pointerout",this._onCanvasPointerOut),t||this._disableTouchAction(),!i.audioEngine&&n&&i.AudioEngineFactory&&(i.audioEngine=i.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination()))}},{key:"getAspectRatio",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)}},{key:"getScreenAspectRatio",value:function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}},{key:"getRenderingCanvasClientRect",value:function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}},{key:"getInputElementClientRect",value:function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}},{key:"isDeterministicLockStep",value:function(){return this._deterministicLockstep}},{key:"getLockstepMaxSteps",value:function(){return this._lockstepMaxSteps}},{key:"getTimeStep",value:function(){return 1e3*this._timeStep}},{key:"generateMipMapsForCubemap",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(e.generateMipMaps){var i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)}}},{key:"getDepthWrite",value:function(){return this._depthCullingState.depthMask}},{key:"setDepthWrite",value:function(e){this._depthCullingState.depthMask=e}},{key:"getStencilBuffer",value:function(){return this._stencilState.stencilTest}},{key:"setStencilBuffer",value:function(e){this._stencilState.stencilTest=e}},{key:"getStencilMask",value:function(){return this._stencilState.stencilMask}},{key:"setStencilMask",value:function(e){this._stencilState.stencilMask=e}},{key:"getStencilFunction",value:function(){return this._stencilState.stencilFunc}},{key:"getStencilFunctionReference",value:function(){return this._stencilState.stencilFuncRef}},{key:"getStencilFunctionMask",value:function(){return this._stencilState.stencilFuncMask}},{key:"setStencilFunction",value:function(e){this._stencilState.stencilFunc=e}},{key:"setStencilFunctionReference",value:function(e){this._stencilState.stencilFuncRef=e}},{key:"setStencilFunctionMask",value:function(e){this._stencilState.stencilFuncMask=e}},{key:"getStencilOperationFail",value:function(){return this._stencilState.stencilOpStencilFail}},{key:"getStencilOperationDepthFail",value:function(){return this._stencilState.stencilOpDepthFail}},{key:"getStencilOperationPass",value:function(){return this._stencilState.stencilOpStencilDepthPass}},{key:"setStencilOperationFail",value:function(e){this._stencilState.stencilOpStencilFail=e}},{key:"setStencilOperationDepthFail",value:function(e){this._stencilState.stencilOpDepthFail=e}},{key:"setStencilOperationPass",value:function(e){this._stencilState.stencilOpStencilDepthPass=e}},{key:"setDitheringState",value:function(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}},{key:"setRasterizerState",value:function(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}},{key:"getDepthFunction",value:function(){return this._depthCullingState.depthFunc}},{key:"setDepthFunction",value:function(e){this._depthCullingState.depthFunc=e}},{key:"setDepthFunctionToGreater",value:function(){this.setDepthFunction(516)}},{key:"setDepthFunctionToGreaterOrEqual",value:function(){this.setDepthFunction(518)}},{key:"setDepthFunctionToLess",value:function(){this.setDepthFunction(513)}},{key:"setDepthFunctionToLessOrEqual",value:function(){this.setDepthFunction(515)}},{key:"cacheStencilState",value:function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}},{key:"restoreStencilState",value:function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}},{key:"setDirectViewport",value:function(e,t,i,n){var r=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,n),r}},{key:"scissorClear",value:function(e,t,i,n,r){this.enableScissor(e,t,i,n),this.clear(r,!0,!0,!0),this.disableScissor()}},{key:"enableScissor",value:function(e,t,i,n){var r=this._gl;r.enable(r.SCISSOR_TEST),r.scissor(e,t,i,n)}},{key:"disableScissor",value:function(){var e=this._gl;e.disable(e.SCISSOR_TEST)}},{key:"_reportDrawCall",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._drawCalls.addCount(e,!1)}},{key:"initWebVR",value:function(){throw le("WebVRCamera")}},{key:"_prepareVRComponent",value:function(){}},{key:"_connectVREvents",value:function(e,t){}},{key:"_submitVRFrame",value:function(){}},{key:"disableVR",value:function(){}},{key:"isVRPresenting",value:function(){return!1}},{key:"_requestVRFrame",value:function(){}},{key:"_loadFileAsync",value:function(e,t,i){var n=this;return new Promise((function(r,s){n._loadFile(e,(function(e){r(e)}),void 0,t,i,(function(e,t){s(t)}))}))}},{key:"getVertexShaderSource",value:function(e){var t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}},{key:"getFragmentShaderSource",value:function(e){var t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}},{key:"setDepthStencilTexture",value:function(e,t,i,n){void 0!==e&&(t&&(this._boundUniforms[e]=t),i&&i.depthStencilTexture?this._setTexture(e,i,!1,!0,n):this._setTexture(e,null,void 0,void 0,n))}},{key:"setTextureFromPostProcess",value:function(e,t,i){var n,r=null;t&&(t._textures.data[t._currentRenderTextureInd]?r=t._textures.data[t._currentRenderTextureInd]:t._forcedOutputTexture&&(r=t._forcedOutputTexture)),this._bindTexture(e,null!==(n=null==r?void 0:r.texture)&&void 0!==n?n:null,i)}},{key:"setTextureFromPostProcessOutput",value:function(e,t,i){var n,r;this._bindTexture(e,null!==(r=null===(n=null==t?void 0:t._outputTexture)||void 0===n?void 0:n.texture)&&void 0!==r?r:null,i)}},{key:"_rebuildBuffers",value:function(){var e,t=(0,p.Z)(this.scenes);try{for(t.s();!(e=t.n()).done;){var n=e.value;n.resetCachedMaterial(),n._rebuildGeometries(),n._rebuildTextures()}}catch(o){t.e(o)}finally{t.f()}var r,s=(0,p.Z)(this._virtualScenes);try{for(s.s();!(r=s.n()).done;){var a=r.value;a.resetCachedMaterial(),a._rebuildGeometries(),a._rebuildTextures()}}catch(o){s.e(o)}finally{s.f()}c((0,h.Z)(i.prototype),"_rebuildBuffers",this).call(this)}},{key:"_renderFrame",value:function(){for(var e=0;e<this._activeRenderLoops.length;e++){(0,this._activeRenderLoops[e])()}}},{key:"_renderLoop",value:function(){if(!this._contextWasLost){var e=!0;!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}},{key:"_renderViews",value:function(){return!1}},{key:"switchFullscreen",value:function(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}},{key:"enterFullscreen",value:function(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&i._RequestFullscreen(this._renderingCanvas))}},{key:"exitFullscreen",value:function(){this.isFullscreen&&i._ExitFullscreen()}},{key:"enterPointerlock",value:function(){this._renderingCanvas&&i._RequestPointerlock(this._renderingCanvas)}},{key:"exitPointerlock",value:function(){i._ExitPointerlock()}},{key:"beginFrame",value:function(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),c((0,h.Z)(i.prototype),"beginFrame",this).call(this)}},{key:"endFrame",value:function(){c((0,h.Z)(i.prototype),"endFrame",this).call(this),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)}},{key:"resize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.isVRPresenting()||c((0,h.Z)(i.prototype),"resize",this).call(this,e)}},{key:"setSize",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._renderingCanvas||!c((0,h.Z)(i.prototype),"setSize",this).call(this,e,t,n))return!1;if(this.scenes){for(var r=0;r<this.scenes.length;r++)for(var s=this.scenes[r],a=0;a<s.cameras.length;a++){s.cameras[a]._currentRenderId=0}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}},{key:"_deletePipelineContext",value:function(e){var t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),c((0,h.Z)(i.prototype),"_deletePipelineContext",this).call(this,e)}},{key:"createShaderProgram",value:function(e,t,n,r,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;s=s||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);var o=c((0,h.Z)(i.prototype),"createShaderProgram",this).call(this,e,t,n,r,s,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),o}},{key:"_createShaderProgram",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=n.createProgram();if(e.program=s,!s)throw new Error("Unable to create program");if(n.attachShader(s,t),n.attachShader(s,i),this.webGLVersion>1&&r){var a=this.createTransformFeedback();this.bindTransformFeedback(a),this.setTranformFeedbackVaryings(s,r),e.transformFeedback=a}return n.linkProgram(s),this.webGLVersion>1&&r&&this.bindTransformFeedback(null),e.context=n,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),s}},{key:"_releaseTexture",value:function(e){c((0,h.Z)(i.prototype),"_releaseTexture",this).call(this,e)}},{key:"_releaseRenderTargetWrapper",value:function(e){c((0,h.Z)(i.prototype),"_releaseRenderTargetWrapper",this).call(this,e),this.scenes.forEach((function(t){t.postProcesses.forEach((function(t){t._outputTexture===e&&(t._outputTexture=null)})),t.cameras.forEach((function(t){t._postProcesses.forEach((function(t){t&&t._outputTexture===e&&(t._outputTexture=null)}))}))}))}},{key:"getRenderPassNames",value:function(){return this._renderPassNames}},{key:"getCurrentRenderPassName",value:function(){return this._renderPassNames[this.currentRenderPassId]}},{key:"createRenderPassId",value:function(e){var t=++i._RenderPassIdCounter;return this._renderPassNames[t]=null!==e&&void 0!==e?e:"NONAME",t}},{key:"releaseRenderPassId",value:function(e){this._renderPassNames[e]=void 0;for(var t=0;t<this.scenes.length;++t)for(var i=this.scenes[t],n=0;n<i.meshes.length;++n){var r=i.meshes[n];if(r.subMeshes)for(var s=0;s<r.subMeshes.length;++s)r.subMeshes[s]._removeDrawWrapper(e)}}},{key:"_rescaleTexture",value:function(e,t,n,r,s){var a=this;this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);var o=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&i._RescalePostProcessFactory&&(this._rescalePostProcess=i._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled((function(){a._rescalePostProcess.onApply=function(t){t._bindTexture("textureSampler",e)};var i=n;i||(i=a.scenes[a.scenes.length-1]),i.postProcessManager.directRender([a._rescalePostProcess],o,!0),a._bindTextureDirectly(a._gl.TEXTURE_2D,t,!0),a._gl.copyTexImage2D(a._gl.TEXTURE_2D,0,r,0,0,t.width,t.height,0),a.unBindFramebuffer(o),o.dispose(),s&&s()})))}},{key:"getFps",value:function(){return this._fps}},{key:"getDeltaTime",value:function(){return this._deltaTime}},{key:"_measureFps",value:function(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}},{key:"wrapWebGLTexture",value:function(e){var t=new Oe(e,this._gl),i=new ie(this,q.Unknown,!0);return i._hardwareTexture=t,i.isReady=!0,i}},{key:"_uploadImageToTexture",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=this._gl,s=this._getWebGLTextureType(e.type),a=this._getInternalFormat(e.format),o=this._getRGBABufferInternalSizedFormat(e.type,a),l=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(l,e,!0),this._unpackFlipY(e.invertY);var u=r.TEXTURE_2D;e.isCube&&(u=r.TEXTURE_CUBE_MAP_POSITIVE_X+i),r.texImage2D(u,n,o,a,s,t),this._bindTextureDirectly(l,null,!0)}},{key:"updateTextureComparisonFunction",value:function(e,t){if(1!==this.webGLVersion){var i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),0===t?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),0===t?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}else ue.Error("WebGL 1 does not support texture comparison.")}},{key:"createInstancesBuffer",value:function(e){var t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");var i=new De(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}},{key:"deleteInstancesBuffer",value:function(e){this._gl.deleteBuffer(e)}},{key:"_clientWaitAsync",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,n=this._gl;return new Promise((function(r,s){!function a(){var o=n.clientWaitSync(e,t,0);o!=n.WAIT_FAILED?o!=n.TIMEOUT_EXPIRED?r():setTimeout(a,i):s()}()}))}},{key:"_readPixelsAsync",value:function(e,t,i,n,r,s,a){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");var o=this._gl,l=o.createBuffer();o.bindBuffer(o.PIXEL_PACK_BUFFER,l),o.bufferData(o.PIXEL_PACK_BUFFER,a.byteLength,o.STREAM_READ),o.readPixels(e,t,i,n,r,s,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null);var u=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);return u?(o.flush(),this._clientWaitAsync(u,0,10).then((function(){return o.deleteSync(u),o.bindBuffer(o.PIXEL_PACK_BUFFER,l),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,a),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),o.deleteBuffer(l),a}))):null}},{key:"dispose",value:function(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();1===i.Instances.length&&i.audioEngine&&(i.audioEngine.dispose(),i.audioEngine=null),this.disableVR();var e=this.getHostWindow();e&&"function"==typeof e.removeEventListener&&(e.removeEventListener("blur",this._onBlur),e.removeEventListener("focus",this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),se()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)),c((0,h.Z)(i.prototype),"dispose",this).call(this);var t=i.Instances.indexOf(this);t>=0&&i.Instances.splice(t,1),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}},{key:"_disableTouchAction",value:function(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}},{key:"displayLoadingUI",value:function(){if(ne()){var e=this.loadingScreen;e&&e.displayLoadingUI()}}},{key:"hideLoadingUI",value:function(){if(ne()){var e=this._loadingScreen;e&&e.hideLoadingUI()}}},{key:"loadingScreen",get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=i.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(e){this._loadingScreen=e}},{key:"loadingUIText",set:function(e){this.loadingScreen.loadingUIText=e}},{key:"loadingUIBackgroundColor",set:function(e){this.loadingScreen.loadingUIBackgroundColor=e}},{key:"createVideoElement",value:function(e){return document.createElement("video")}},{key:"getFontOffset",value:function(e){var t=document.createElement("span");t.innerHTML="Hg",t.setAttribute("style","font: ".concat(e," !important"));var i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";var n=document.createElement("div");n.style.whiteSpace="nowrap",n.appendChild(t),n.appendChild(i),document.body.appendChild(n);var r=0,s=0;try{s=i.getBoundingClientRect().top-t.getBoundingClientRect().top,i.style.verticalAlign="baseline",r=i.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(n)}return{ascent:r,height:s,descent:s-r}}}],[{key:"NpmPackage",get:function(){return Ve.NpmPackage}},{key:"Version",get:function(){return Ve.Version}},{key:"Instances",get:function(){return V.Instances}},{key:"LastCreatedEngine",get:function(){return V.LastCreatedEngine}},{key:"LastCreatedScene",get:function(){return V.LastCreatedScene}},{key:"MarkAllMaterialsAsDirty",value:function(e,t){for(var n=0;n<i.Instances.length;n++)for(var r=i.Instances[n],s=0;s<r.scenes.length;s++)r.scenes[s].markAllMaterialsAsDirty(e,t)}},{key:"DefaultLoadingScreenFactory",value:function(e){throw le("LoadingScreen")}},{key:"_RequestPointerlock",value:function(e){e.requestPointerLock&&(e.requestPointerLock(),e.focus())}},{key:"_ExitPointerlock",value:function(){document.exitPointerLock&&document.exitPointerLock()}},{key:"_RequestFullscreen",value:function(e){var t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e)}},{key:"_ExitFullscreen",value:function(){var e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}}]),i}(Ve);function He(e){return new Xe(e,!0,{preserveDrawingBuffer:!0,stencil:!0})}Xe.ALPHA_DISABLE=0,Xe.ALPHA_ADD=1,Xe.ALPHA_COMBINE=2,Xe.ALPHA_SUBTRACT=3,Xe.ALPHA_MULTIPLY=4,Xe.ALPHA_MAXIMIZED=5,Xe.ALPHA_ONEONE=6,Xe.ALPHA_PREMULTIPLIED=7,Xe.ALPHA_PREMULTIPLIED_PORTERDUFF=8,Xe.ALPHA_INTERPOLATE=9,Xe.ALPHA_SCREENMODE=10,Xe.DELAYLOADSTATE_NONE=0,Xe.DELAYLOADSTATE_LOADED=1,Xe.DELAYLOADSTATE_LOADING=2,Xe.DELAYLOADSTATE_NOTLOADED=4,Xe.NEVER=512,Xe.ALWAYS=519,Xe.LESS=513,Xe.EQUAL=514,Xe.LEQUAL=515,Xe.GREATER=516,Xe.GEQUAL=518,Xe.NOTEQUAL=517,Xe.KEEP=7680,Xe.REPLACE=7681,Xe.INCR=7682,Xe.DECR=7683,Xe.INVERT=5386,Xe.INCR_WRAP=34055,Xe.DECR_WRAP=34056,Xe.TEXTURE_CLAMP_ADDRESSMODE=0,Xe.TEXTURE_WRAP_ADDRESSMODE=1,Xe.TEXTURE_MIRROR_ADDRESSMODE=2,Xe.TEXTUREFORMAT_ALPHA=0,Xe.TEXTUREFORMAT_LUMINANCE=1,Xe.TEXTUREFORMAT_LUMINANCE_ALPHA=2,Xe.TEXTUREFORMAT_RGB=4,Xe.TEXTUREFORMAT_RGBA=5,Xe.TEXTUREFORMAT_RED=6,Xe.TEXTUREFORMAT_R=6,Xe.TEXTUREFORMAT_RG=7,Xe.TEXTUREFORMAT_RED_INTEGER=8,Xe.TEXTUREFORMAT_R_INTEGER=8,Xe.TEXTUREFORMAT_RG_INTEGER=9,Xe.TEXTUREFORMAT_RGB_INTEGER=10,Xe.TEXTUREFORMAT_RGBA_INTEGER=11,Xe.TEXTURETYPE_UNSIGNED_BYTE=0,Xe.TEXTURETYPE_UNSIGNED_INT=0,Xe.TEXTURETYPE_FLOAT=1,Xe.TEXTURETYPE_HALF_FLOAT=2,Xe.TEXTURETYPE_BYTE=3,Xe.TEXTURETYPE_SHORT=4,Xe.TEXTURETYPE_UNSIGNED_SHORT=5,Xe.TEXTURETYPE_INT=6,Xe.TEXTURETYPE_UNSIGNED_INTEGER=7,Xe.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,Xe.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,Xe.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,Xe.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,Xe.TEXTURETYPE_UNSIGNED_INT_24_8=12,Xe.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,Xe.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,Xe.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,Xe.TEXTURE_NEAREST_SAMPLINGMODE=1,Xe.TEXTURE_BILINEAR_SAMPLINGMODE=2,Xe.TEXTURE_TRILINEAR_SAMPLINGMODE=3,Xe.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,Xe.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,Xe.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,Xe.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,Xe.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,Xe.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,Xe.TEXTURE_NEAREST_LINEAR=7,Xe.TEXTURE_NEAREST_NEAREST=1,Xe.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,Xe.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,Xe.TEXTURE_LINEAR_LINEAR=2,Xe.TEXTURE_LINEAR_NEAREST=12,Xe.TEXTURE_EXPLICIT_MODE=0,Xe.TEXTURE_SPHERICAL_MODE=1,Xe.TEXTURE_PLANAR_MODE=2,Xe.TEXTURE_CUBIC_MODE=3,Xe.TEXTURE_PROJECTION_MODE=4,Xe.TEXTURE_SKYBOX_MODE=5,Xe.TEXTURE_INVCUBIC_MODE=6,Xe.TEXTURE_EQUIRECTANGULAR_MODE=7,Xe.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,Xe.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,Xe.SCALEMODE_FLOOR=1,Xe.SCALEMODE_NEAREST=2,Xe.SCALEMODE_CEILING=3,Xe._RescalePostProcessFactory=null,Xe._RenderPassIdCounter=0,Ve.prototype._debugPushGroup=function(e,t){},Ve.prototype._debugPopGroup=function(e){},Ve.prototype._debugInsertMarker=function(e,t){},Ve.prototype._debugFlushPendingCommands=function(){};var Ze=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;(0,m.Z)(this,e),this.r=t,this.g=i,this.b=n}return(0,y.Z)(e,[{key:"toString",value:function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}},{key:"getClassName",value:function(){return"Color3"}},{key:"getHashCode",value:function(){var e=255*this.r|0;return e=397*(e=397*e^(255*this.g|0))^(255*this.b|0)}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}},{key:"fromArray",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e.FromArrayToRef(t,i,this),this}},{key:"toColor4",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return new Ke(this.r,this.g,this.b,e)}},{key:"asArray",value:function(){return[this.r,this.g,this.b]}},{key:"toLuminance",value:function(){return.3*this.r+.59*this.g+.11*this.b}},{key:"multiply",value:function(t){return new e(this.r*t.r,this.g*t.g,this.b*t.b)}},{key:"multiplyToRef",value:function(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this}},{key:"equals",value:function(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}},{key:"equalsFloats",value:function(e,t,i){return this.r===e&&this.g===t&&this.b===i}},{key:"scale",value:function(t){return new e(this.r*t,this.g*t,this.b*t)}},{key:"scaleInPlace",value:function(e){return this.r*=e,this.g*=e,this.b*=e,this}},{key:"scaleToRef",value:function(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this}},{key:"scaleAndAddToRef",value:function(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this}},{key:"clampToRef",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2?arguments[2]:void 0;return i.r=I.Clamp(this.r,e,t),i.g=I.Clamp(this.g,e,t),i.b=I.Clamp(this.b,e,t),this}},{key:"add",value:function(t){return new e(this.r+t.r,this.g+t.g,this.b+t.b)}},{key:"addToRef",value:function(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this}},{key:"subtract",value:function(t){return new e(this.r-t.r,this.g-t.g,this.b-t.b)}},{key:"subtractToRef",value:function(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this}},{key:"clone",value:function(){return new e(this.r,this.g,this.b)}},{key:"copyFrom",value:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}},{key:"copyFromFloats",value:function(e,t,i){return this.r=e,this.g=t,this.b=i,this}},{key:"set",value:function(e,t,i){return this.copyFromFloats(e,t,i)}},{key:"toHexString",value:function(){var e=Math.round(255*this.r),t=Math.round(255*this.g),i=Math.round(255*this.b);return"#"+I.ToHex(e)+I.ToHex(t)+I.ToHex(i)}},{key:"toLinearSpace",value:function(){var t=new e;return this.toLinearSpaceToRef(t),t}},{key:"toHSV",value:function(){var t=new e;return this.toHSVToRef(t),t}},{key:"toHSVToRef",value:function(e){var t=this.r,i=this.g,n=this.b,r=Math.max(t,i,n),s=Math.min(t,i,n),a=0,o=0,l=r,u=r-s;0!==r&&(o=u/r),r!=s&&(r==t?(a=(i-n)/u,i<n&&(a+=6)):r==i?a=(n-t)/u+2:r==n&&(a=(t-i)/u+4),a*=60),e.r=a,e.g=o,e.b=l}},{key:"toLinearSpaceToRef",value:function(e){return e.r=Math.pow(this.r,k),e.g=Math.pow(this.g,k),e.b=Math.pow(this.b,k),this}},{key:"toGammaSpace",value:function(){var t=new e;return this.toGammaSpaceToRef(t),t}},{key:"toGammaSpaceToRef",value:function(e){return e.r=Math.pow(this.r,P),e.g=Math.pow(this.g,P),e.b=Math.pow(this.b,P),this}}],[{key:"HSVtoRGBToRef",value:function(e,t,i,n){var r=i*t,s=e/60,a=r*(1-Math.abs(s%2-1)),o=0,l=0,u=0;s>=0&&s<=1?(o=r,l=a):s>=1&&s<=2?(o=a,l=r):s>=2&&s<=3?(l=r,u=a):s>=3&&s<=4?(l=a,u=r):s>=4&&s<=5?(o=a,u=r):s>=5&&s<=6&&(o=r,u=a);var h=i-r;n.set(o+h,l+h,u+h)}},{key:"FromHSV",value:function(t,i,n){var r=new e(0,0,0);return e.HSVtoRGBToRef(t,i,n,r),r}},{key:"FromHexString",value:function(t){if("#"!==t.substring(0,1)||7!==t.length)return new e(0,0,0);var i=parseInt(t.substring(1,3),16),n=parseInt(t.substring(3,5),16),r=parseInt(t.substring(5,7),16);return e.FromInts(i,n,r)}},{key:"FromArray",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new e(t[i],t[i+1],t[i+2])}},{key:"FromArrayToRef",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;i.r=e[t],i.g=e[t+1],i.b=e[t+2]}},{key:"FromInts",value:function(t,i,n){return new e(t/255,i/255,n/255)}},{key:"Lerp",value:function(t,i,n){var r=new e(0,0,0);return e.LerpToRef(t,i,n,r),r}},{key:"LerpToRef",value:function(e,t,i,n){n.r=e.r+(t.r-e.r)*i,n.g=e.g+(t.g-e.g)*i,n.b=e.b+(t.b-e.b)*i}},{key:"Hermite",value:function(t,i,n,r,s){var a=s*s,o=s*a,l=2*o-3*a+1,u=-2*o+3*a,h=o-2*a+s,c=o-a;return new e(t.r*l+n.r*u+i.r*h+r.r*c,t.g*l+n.g*u+i.g*h+r.g*c,t.b*l+n.b*u+i.b*h+r.b*c)}},{key:"Hermite1stDerivative",value:function(t,i,n,r,s){var a=e.Black();return this.Hermite1stDerivativeToRef(t,i,n,r,s,a),a}},{key:"Hermite1stDerivativeToRef",value:function(e,t,i,n,r,s){var a=r*r;s.r=6*(a-r)*e.r+(3*a-4*r+1)*t.r+6*(-a+r)*i.r+(3*a-2*r)*n.r,s.g=6*(a-r)*e.g+(3*a-4*r+1)*t.g+6*(-a+r)*i.g+(3*a-2*r)*n.g,s.b=6*(a-r)*e.b+(3*a-4*r+1)*t.b+6*(-a+r)*i.b+(3*a-2*r)*n.b}},{key:"Red",value:function(){return new e(1,0,0)}},{key:"Green",value:function(){return new e(0,1,0)}},{key:"Blue",value:function(){return new e(0,0,1)}},{key:"Black",value:function(){return new e(0,0,0)}},{key:"BlackReadOnly",get:function(){return e._BlackReadOnly}},{key:"White",value:function(){return new e(1,1,1)}},{key:"Purple",value:function(){return new e(.5,0,.5)}},{key:"Magenta",value:function(){return new e(1,0,1)}},{key:"Yellow",value:function(){return new e(1,1,0)}},{key:"Gray",value:function(){return new e(.5,.5,.5)}},{key:"Teal",value:function(){return new e(0,1,1)}},{key:"Random",value:function(){return new e(Math.random(),Math.random(),Math.random())}}]),e}();Ze._BlackReadOnly=Ze.Black();var Ke=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;(0,m.Z)(this,e),this.r=t,this.g=i,this.b=n,this.a=r}return(0,y.Z)(e,[{key:"addInPlace",value:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}},{key:"asArray",value:function(){return[this.r,this.g,this.b,this.a]}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}},{key:"fromArray",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e.FromArrayToRef(t,i,this),this}},{key:"equals",value:function(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}},{key:"add",value:function(t){return new e(this.r+t.r,this.g+t.g,this.b+t.b,this.a+t.a)}},{key:"subtract",value:function(t){return new e(this.r-t.r,this.g-t.g,this.b-t.b,this.a-t.a)}},{key:"subtractToRef",value:function(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this}},{key:"scale",value:function(t){return new e(this.r*t,this.g*t,this.b*t,this.a*t)}},{key:"scaleInPlace",value:function(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}},{key:"scaleToRef",value:function(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this}},{key:"scaleAndAddToRef",value:function(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this}},{key:"clampToRef",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2?arguments[2]:void 0;return i.r=I.Clamp(this.r,e,t),i.g=I.Clamp(this.g,e,t),i.b=I.Clamp(this.b,e,t),i.a=I.Clamp(this.a,e,t),this}},{key:"multiply",value:function(t){return new e(this.r*t.r,this.g*t.g,this.b*t.b,this.a*t.a)}},{key:"multiplyToRef",value:function(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}},{key:"toString",value:function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}},{key:"getClassName",value:function(){return"Color4"}},{key:"getHashCode",value:function(){var e=255*this.r|0;return e=397*(e=397*(e=397*e^(255*this.g|0))^(255*this.b|0))^(255*this.a|0)}},{key:"clone",value:function(){return new e(this.r,this.g,this.b,this.a)}},{key:"copyFrom",value:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}},{key:"copyFromFloats",value:function(e,t,i,n){return this.r=e,this.g=t,this.b=i,this.a=n,this}},{key:"set",value:function(e,t,i,n){return this.copyFromFloats(e,t,i,n)}},{key:"toHexString",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=Math.round(255*this.r),i=Math.round(255*this.g),n=Math.round(255*this.b);if(e)return"#"+I.ToHex(t)+I.ToHex(i)+I.ToHex(n);var r=Math.round(255*this.a);return"#"+I.ToHex(t)+I.ToHex(i)+I.ToHex(n)+I.ToHex(r)}},{key:"toLinearSpace",value:function(){var t=new e;return this.toLinearSpaceToRef(t),t}},{key:"toLinearSpaceToRef",value:function(e){return e.r=Math.pow(this.r,k),e.g=Math.pow(this.g,k),e.b=Math.pow(this.b,k),e.a=this.a,this}},{key:"toGammaSpace",value:function(){var t=new e;return this.toGammaSpaceToRef(t),t}},{key:"toGammaSpaceToRef",value:function(e){return e.r=Math.pow(this.r,P),e.g=Math.pow(this.g,P),e.b=Math.pow(this.b,P),e.a=this.a,this}}],[{key:"FromHexString",value:function(t){if("#"!==t.substring(0,1)||9!==t.length&&7!==t.length)return new e(0,0,0,0);var i=parseInt(t.substring(1,3),16),n=parseInt(t.substring(3,5),16),r=parseInt(t.substring(5,7),16),s=9===t.length?parseInt(t.substring(7,9),16):255;return e.FromInts(i,n,r,s)}},{key:"Lerp",value:function(t,i,n){var r=new e(0,0,0,0);return e.LerpToRef(t,i,n,r),r}},{key:"LerpToRef",value:function(e,t,i,n){n.r=e.r+(t.r-e.r)*i,n.g=e.g+(t.g-e.g)*i,n.b=e.b+(t.b-e.b)*i,n.a=e.a+(t.a-e.a)*i}},{key:"Hermite",value:function(t,i,n,r,s){var a=s*s,o=s*a,l=2*o-3*a+1,u=-2*o+3*a,h=o-2*a+s,c=o-a;return new e(t.r*l+n.r*u+i.r*h+r.r*c,t.g*l+n.g*u+i.g*h+r.g*c,t.b*l+n.b*u+i.b*h+r.b*c,t.a*l+n.a*u+i.a*h+r.a*c)}},{key:"Hermite1stDerivative",value:function(t,i,n,r,s){var a=new e;return this.Hermite1stDerivativeToRef(t,i,n,r,s,a),a}},{key:"Hermite1stDerivativeToRef",value:function(e,t,i,n,r,s){var a=r*r;s.r=6*(a-r)*e.r+(3*a-4*r+1)*t.r+6*(-a+r)*i.r+(3*a-2*r)*n.r,s.g=6*(a-r)*e.g+(3*a-4*r+1)*t.g+6*(-a+r)*i.g+(3*a-2*r)*n.g,s.b=6*(a-r)*e.b+(3*a-4*r+1)*t.b+6*(-a+r)*i.b+(3*a-2*r)*n.b,s.a=6*(a-r)*e.a+(3*a-4*r+1)*t.a+6*(-a+r)*i.a+(3*a-2*r)*n.a}},{key:"FromColor3",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return new e(t.r,t.g,t.b,i)}},{key:"FromArray",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new e(t[i],t[i+1],t[i+2],t[i+3])}},{key:"FromArrayToRef",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}},{key:"FromInts",value:function(t,i,n,r){return new e(t/255,i/255,n/255,r/255)}},{key:"CheckColors4",value:function(e,t){if(e.length===3*t){for(var i=[],n=0;n<e.length;n+=3){var r=n/3*4;i[r]=e[n],i[r+1]=e[n+1],i[r+2]=e[n+2],i[r+3]=1}return i}return e}}]),e}(),Ye=(0,y.Z)((function e(){(0,m.Z)(this,e)}));Ye.Color3=F.BuildArray(3,Ze.Black),Ye.Color4=F.BuildArray(3,(function(){return new Ke(0,0,0,0)})),N("BABYLON.Color3",Ze),N("BABYLON.Color4",Ke);var qe=function(e,t){return!e||e.getClassName&&"Mesh"===e.getClassName()?null:e.getClassName&&"SubMesh"===e.getClassName()?e.clone(t):e.clone?e.clone():null};var je=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"DeepCopy",value:function(e,t,i,n){var r,s=function(e){var t=[];do{Object.getOwnPropertyNames(e).forEach((function(e){-1===t.indexOf(e)&&t.push(e)}))}while(e=Object.getPrototypeOf(e));return t}(e),a=(0,p.Z)(s);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(!("_"===o[0]&&(!n||-1===n.indexOf(o))||o.endsWith("Observable")||i&&-1!==i.indexOf(o))){var l=e[o],u=typeof l;if("function"!==u)try{if("object"===u)if(l instanceof Array){if(t[o]=[],l.length>0)if("object"==typeof l[0])for(var h=0;h<l.length;h++){var c=qe(l[h],t);-1===t[o].indexOf(c)&&t[o].push(c)}else t[o]=l.slice(0)}else t[o]=qe(l,t);else t[o]=l}catch(h){ue.Warn(h.message)}}}}catch(d){a.e(d)}finally{a.f()}}}]),e}();var Qe=function(){function e(){(0,m.Z)(this,e),this._xhr=typeof _native<"u"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest,this._requestURL=""}return(0,y.Z)(e,[{key:"_injectCustomRequestHeaders",value:function(){if(!this._shouldSkipRequestModifications(this._requestURL))for(var t in e.CustomRequestHeaders){var i=e.CustomRequestHeaders[t];i&&this._xhr.setRequestHeader(t,i)}}},{key:"_shouldSkipRequestModifications",value:function(t){return e.SkipRequestModificationForBabylonCDN&&(t.includes("preview.babylonjs.com")||t.includes("cdn.babylonjs.com"))}},{key:"onprogress",get:function(){return this._xhr.onprogress},set:function(e){this._xhr.onprogress=e}},{key:"readyState",get:function(){return this._xhr.readyState}},{key:"status",get:function(){return this._xhr.status}},{key:"statusText",get:function(){return this._xhr.statusText}},{key:"response",get:function(){return this._xhr.response}},{key:"responseURL",get:function(){return this._xhr.responseURL}},{key:"responseText",get:function(){return this._xhr.responseText}},{key:"responseType",get:function(){return this._xhr.responseType},set:function(e){this._xhr.responseType=e}},{key:"timeout",get:function(){return this._xhr.timeout},set:function(e){this._xhr.timeout=e}},{key:"addEventListener",value:function(e,t,i){this._xhr.addEventListener(e,t,i)}},{key:"removeEventListener",value:function(e,t,i){this._xhr.removeEventListener(e,t,i)}},{key:"abort",value:function(){this._xhr.abort()}},{key:"send",value:function(t){e.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(t)}},{key:"open",value:function(t,i){var n,r=(0,p.Z)(e.CustomRequestModifiers);try{for(r.s();!(n=r.n()).done;){var s=n.value;if(this._shouldSkipRequestModifications(i))return;s(this._xhr,i)}}catch(a){r.e(a)}finally{r.f()}return i=(i=i.replace("file:http:","http:")).replace("file:https:","https:"),this._requestURL=i,this._xhr.open(t,i,!0)}},{key:"setRequestHeader",value:function(e,t){this._xhr.setRequestHeader(e,t)}},{key:"getResponseHeader",value:function(e){return this._xhr.getResponseHeader(e)}}]),e}();Qe.CustomRequestHeaders={},Qe.CustomRequestModifiers=new Array,Qe.SkipRequestModificationForBabylonCDN=!0;var Je=(0,y.Z)((function e(){(0,m.Z)(this,e)}));Je.FilesToLoad={};var $e=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"ExponentialBackoff",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500;return function(i,n,r){return 0!==n.status||r>=e||-1!==i.indexOf("file:")?-1:Math.pow(2,r)*t}}}]),e}(),et=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){return(0,m.Z)(this,i),t.apply(this,arguments)}return(0,y.Z)(i)}((0,o.Z)(Error));et._setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e};var tt=0,it=3e3,nt=4e3,rt=4001,st=4002,at=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r){var s;return(0,m.Z)(this,i),(s=t.call(this,e)).errorCode=n,s.innerError=r,s.name="RuntimeError",et._setPrototypeOf((0,u.Z)(s),i.prototype),s}return(0,y.Z)(i)}(et),ot=function(e){for(var t,i,n,r,s,a,o,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u="",h=0,c=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);h<c.length;)r=(t=c[h++])>>2,s=(3&t)<<4|(i=h<c.length?c[h++]:Number.NaN)>>4,a=(15&i)<<2|(n=h<c.length?c[h++]:Number.NaN)>>6,o=63&n,isNaN(i)?a=o=64:isNaN(n)&&(o=64),u+=l.charAt(r)+l.charAt(s)+l.charAt(a)+l.charAt(o);return u},lt=function(e){return atob(e)},ut=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"SetImmediate",value:function(e){ne()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}]),e}(),ht=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i),ct=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r;return(0,m.Z)(this,i),(r=t.call(this,e,nt)).name="LoadFileError",et._setPrototypeOf((0,u.Z)(r),i.prototype),n instanceof Qe?r.request=n:r.file=n,r}return(0,y.Z)(i)}(at),dt=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r;return(0,m.Z)(this,i),(r=t.call(this,e,rt)).request=n,r.name="RequestFileError",et._setPrototypeOf((0,u.Z)(r),i.prototype),r}return(0,y.Z)(i)}(at),ft=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r;return(0,m.Z)(this,i),(r=t.call(this,e,st)).file=n,r.name="ReadFileError",et._setPrototypeOf((0,u.Z)(r),i.prototype),r}return(0,y.Z)(i)}(at),_t={DefaultRetryStrategy:$e.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:function(e){return e}},vt=function(e){return e=e.replace(/#/gm,"%23")},gt=function(e,t){if((!e||0!==e.indexOf("data:"))&&_t.CorsBehavior)if("string"==typeof _t.CorsBehavior||_t.CorsBehavior instanceof String)t.crossOrigin=_t.CorsBehavior;else{var i=_t.CorsBehavior(e);i&&(t.crossOrigin=i)}},pt=function(e,t,i,n){var r,s,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"",l=arguments.length>5?arguments[5]:void 0,u=!1;e instanceof ArrayBuffer||ArrayBuffer.isView(e)?typeof Blob<"u"&&typeof URL<"u"?(s=URL.createObjectURL(new Blob([e],{type:o})),u=!0):s="data:".concat(o,";base64,")+ot(e):e instanceof Blob?(s=URL.createObjectURL(e),u=!0):(s=vt(e),s=_t.PreprocessUrl(e));var h=V.LastCreatedEngine,c=function(t){if(i){var n=s||e.toString();i("Error while trying to load image: ".concat(0===n.indexOf("http")||n.length<=128?n:n.slice(0,128)+"..."),t)}};if(typeof Image>"u"||null!==(r=null==h?void 0:h._features.forceBitmapOverHTMLImageElement)&&void 0!==r&&r)return yt(s,(function(n){h.createImageBitmap(new Blob([n],{type:o}),(0,a.Z)({premultiplyAlpha:"none"},l)).then((function(e){t(e),u&&URL.revokeObjectURL(s)})).catch((function(t){i&&i("Error while trying to load image: "+e,t)}))}),void 0,n||void 0,!0,(function(e,t){c(t)})),null;var d=new Image;gt(s,d);var f=[],_=function(){f.forEach((function(e){e.target.removeEventListener(e.name,e.handler)})),f.length=0};f.push({target:d,name:"load",handler:function(){_(),t(d),u&&d.src&&URL.revokeObjectURL(d.src)}}),f.push({target:d,name:"error",handler:function(e){_(),c(e),u&&d.src&&URL.revokeObjectURL(d.src)}}),f.push({target:document,name:"securitypolicyviolation",handler:function(e){_();var t=new Error("CSP violation of policy ".concat(e.effectiveDirective," ").concat(e.blockedURI,". Current policy is ").concat(e.originalPolicy));V.UseFallbackTexture=!1,c(t),u&&d.src&&URL.revokeObjectURL(d.src),d.src=""}}),f.forEach((function(e){e.target.addEventListener(e.name,e.handler)}));var v="blob:"===s.substring(0,5),g="data:"===s.substring(0,5),p=function(){v||g?d.src=s:yt(s,(function(e,t,i){var n=new Blob([e],{type:!o&&i?i:o}),r=URL.createObjectURL(n);u=!0,d.src=r}),void 0,n||void 0,!0,(function(e,t){c(t)}))};if(!v&&!g&&n&&n.enableTexturesOffline)n.open((function(){n&&n.loadImage(s,d)}),p);else{if(-1!==s.indexOf("file:")){var m=decodeURIComponent(s.substring(5).toLowerCase());if(Je.FilesToLoad[m]&&typeof URL<"u"){try{var y;try{y=URL.createObjectURL(Je.FilesToLoad[m])}catch(T){y=URL.createObjectURL(Je.FilesToLoad[m])}d.src=y,u=!0}catch(E){d.src=""}return d}}p()}return d},mt=function(e,t,i,n,r){var s=new FileReader,a={onCompleteObservable:new ee,abort:function(){return s.abort()}};return s.onloadend=function(){return a.onCompleteObservable.notifyObservers(a)},r&&(s.onerror=function(){r(new ft("Unable to read ".concat(e.name),e))}),s.onload=function(e){t(e.target.result)},i&&(s.onprogress=i),n?s.readAsArrayBuffer(e):s.readAsText(e),a},yt=function(e,t,i,n,r,s,a){if(e.name)return mt(e,t,i,r,s?function(e){s(void 0,e)}:void 0);var o=e;if(-1!==o.indexOf("file:")){var l=decodeURIComponent(o.substring(5).toLowerCase());0===l.indexOf("./")&&(l=l.substring(2));var u=Je.FilesToLoad[l];if(u)return mt(u,t,i,r,s?function(e){return s(void 0,new ct(e.message,e.file))}:void 0)}var h=bt(o),c=h.match,d=h.type;if(c){var f={onCompleteObservable:new ee,abort:function(){return function(){}}};try{var _=r?xt(o):At(o);t(_,void 0,d)}catch(u){s?s(void 0,u):ue.Error(u.message||"Failed to parse the Data URL")}return ut.SetImmediate((function(){f.onCompleteObservable.notifyObservers(f)})),f}return Tt(o,(function(e,i){t(e,null==i?void 0:i.responseURL,null==i?void 0:i.getResponseHeader("content-type"))}),i,n,r,s?function(e){s(e.request,new ct(e.message,e.request))}:void 0,a)},Tt=function(e,t,i,n,r,s,a){e=vt(e),e=_t.PreprocessUrl(e);var o=_t.BaseUrl+e,l=!1,u={onCompleteObservable:new ee,abort:function(){return l=!0}},h=function(){var e,n=new Qe,h=null,c=function(){n&&(i&&n.removeEventListener("progress",i),e&&n.removeEventListener("readystatechange",e),n.removeEventListener("loadend",d))},d=function(){c(),u.onCompleteObservable.notifyObservers(u),u.onCompleteObservable.clear(),i=void 0,e=null,d=null,s=void 0,a=void 0,t=void 0};u.abort=function(){l=!0,d&&d(),n&&n.readyState!==(XMLHttpRequest.DONE||4)&&n.abort(),null!==h&&(clearTimeout(h),h=null),n=null};var f=function(e){var t=e.message||"Unknown error";s&&n?s(new dt(t,n)):ue.Error(t)};!function u(_){if(n){if(n.open("GET",o),a)try{a(n)}catch(v){return void f(v)}r&&(n.responseType="arraybuffer"),i&&n.addEventListener("progress",i),d&&n.addEventListener("loadend",d),e=function(){if(!l&&n&&n.readyState===(XMLHttpRequest.DONE||4)){if(e&&n.removeEventListener("readystatechange",e),n.status>=200&&n.status<300||0===n.status&&(!ne()||Et())){try{t&&t(r?n.response:n.responseText,n)}catch(a){f(a)}return}var i=_t.DefaultRetryStrategy;if(i){var a=i(o,n,_);if(-1!==a)return c(),n=new Qe,void(h=setTimeout((function(){return u(_+1)}),a))}var d=new dt("Error status: "+n.status+" "+n.statusText+" - Unable to load "+o,n);s&&s(d)}},n.addEventListener("readystatechange",e),n.send()}}(0)};if(n&&n.enableSceneOffline){var c=function(e){e&&e.status>400?s&&s(e):h()};n.open((function(){n&&n.loadFile(_t.BaseUrl+e,(function(e){!l&&t&&t(e),u.onCompleteObservable.notifyObservers(u)}),i?function(e){!l&&i&&i(e)}:void 0,c,r)}),c)}else h();return u},Et=function(){return typeof location<"u"&&"file:"===location.protocol},St=function(e){return ht.test(e)},bt=function(e){var t=ht.exec(e);return null===t||0===t.length?{match:!1,type:""}:{match:!0,type:t[0].replace("data:","").replace("base64,","")}};function xt(e){return function(e){for(var t=lt(e),i=t.length,n=new Uint8Array(new ArrayBuffer(i)),r=0;r<i;r++)n[r]=t.charCodeAt(r);return n.buffer}(e.split(",")[1])}var Mt,At=function(e){return lt(e.split(",")[1])};Ve._FileToolsLoadImage=pt,Ve._FileToolsLoadFile=yt,be._FileToolsLoadFile=yt;!function(e,t,i,n,r,s,a,o,l,u){Mt={DecodeBase64UrlToBinary:e,DecodeBase64UrlToString:t,DefaultRetryStrategy:i.DefaultRetryStrategy,BaseUrl:i.BaseUrl,CorsBehavior:i.CorsBehavior,PreprocessUrl:i.PreprocessUrl,IsBase64DataUrl:n,IsFileURL:r,LoadFile:s,LoadImage:a,ReadFile:o,RequestFile:l,SetCorsBehavior:u},Object.defineProperty(Mt,"DefaultRetryStrategy",{get:function(){return i.DefaultRetryStrategy},set:function(e){i.DefaultRetryStrategy=e}}),Object.defineProperty(Mt,"BaseUrl",{get:function(){return i.BaseUrl},set:function(e){i.BaseUrl=e}}),Object.defineProperty(Mt,"PreprocessUrl",{get:function(){return i.PreprocessUrl},set:function(e){i.PreprocessUrl=e}}),Object.defineProperty(Mt,"CorsBehavior",{get:function(){return i.CorsBehavior},set:function(e){i.CorsBehavior=e}})}(xt,At,_t,St,Et,yt,pt,mt,Tt,gt);var Rt=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"Instantiate",value:function(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];var t=B(e);if(t)return t;ue.Warn(e+" not found, you may have missed an import.");for(var i=e.split("."),n=window||this,r=0,s=i.length;r<s;r++)n=n[i[r]];return"function"!=typeof n?null:n}}]),e}();function Ct(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}Rt.RegisteredExternalClasses={};var It=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"BaseUrl",get:function(){return _t.BaseUrl},set:function(e){_t.BaseUrl=e}},{key:"DefaultRetryStrategy",get:function(){return _t.DefaultRetryStrategy},set:function(e){_t.DefaultRetryStrategy=e}},{key:"CorsBehavior",get:function(){return _t.CorsBehavior},set:function(e){_t.CorsBehavior=e}},{key:"UseFallbackTexture",get:function(){return V.UseFallbackTexture},set:function(e){V.UseFallbackTexture=e}},{key:"RegisteredExternalClasses",get:function(){return Rt.RegisteredExternalClasses},set:function(e){Rt.RegisteredExternalClasses=e}},{key:"fallbackTexture",get:function(){return V.FallbackTexture},set:function(e){V.FallbackTexture=e}},{key:"FetchToRef",value:function(e,t,i,n,r,s){var a=4*((Math.abs(e)*i%i|0)+(Math.abs(t)*n%n|0)*i);s.r=r[a]/255,s.g=r[a+1]/255,s.b=r[a+2]/255,s.a=r[a+3]/255}},{key:"Mix",value:function(e,t,i){return e*(1-i)+t*i}},{key:"Instantiate",value:function(e){return Rt.Instantiate(e)}},{key:"SetImmediate",value:function(e){ut.SetImmediate(e)}},{key:"IsExponentOfTwo",value:function(e){var t=1;do{t*=2}while(t<e);return t===e}},{key:"FloatRound",value:function(t){return Math.fround?Math.fround(t):(e._TmpFloatArray[0]=t,e._TmpFloatArray[0])}},{key:"GetFilename",value:function(e){var t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}},{key:"GetFolderPath",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}},{key:"ToDegrees",value:function(e){return 180*e/Math.PI}},{key:"ToRadians",value:function(e){return e*Math.PI/180}},{key:"SmoothAngleChange",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.9,n=this.ToRadians(e),r=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(r)+i*Math.sin(n),(1-i)*Math.cos(r)+i*Math.cos(n)))}},{key:"MakeArray",value:function(e,t){return!0===t||void 0!==e&&null!=e?Array.isArray(e)?e:[e]:null}},{key:"GetPointerPrefix",value:function(e){var t="pointer";return ne()&&!window.PointerEvent&&(t="mouse"),e._badDesktopOS&&!e._badOS&&!(document&&"ontouchend"in document)&&(t="mouse"),t}},{key:"SetCorsBehavior",value:function(e,t){gt(e,t)}},{key:"SetReferrerPolicyBehavior",value:function(e,t){t.referrerPolicy=e}},{key:"CleanUrl",value:function(e){return e=e.replace(/#/gm,"%23")}},{key:"PreprocessUrl",get:function(){return _t.PreprocessUrl},set:function(e){_t.PreprocessUrl=e}},{key:"LoadImage",value:function(e,t,i,n,r,s){return pt(e,t,i,n,r,s)}},{key:"LoadFile",value:function(e,t,i,n,r,s){return yt(e,t,i,n,r,s)}},{key:"LoadFileAsync",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return new Promise((function(i,n){yt(e,(function(e){i(e)}),void 0,void 0,t,(function(e,t){n(t)}))}))}},{key:"LoadScript",value:function(e,t,i,n){if("function"!=typeof importScripts)if(ne()){var r=document.getElementsByTagName("head")[0],s=document.createElement("script");s.setAttribute("type","text/javascript"),s.setAttribute("src",e),n&&(s.id=n),s.onload=function(){t&&t()},s.onerror=function(t){i&&i("Unable to load script '".concat(e,"'"),t)},r.appendChild(s)}else null==i||i("Cannot load script '".concat(e,"' outside of a window or a worker"));else try{importScripts(e),t()}catch(a){null==i||i("Unable to load script '".concat(e,"' in worker"),a)}}},{key:"LoadScriptAsync",value:function(e){var t=this;return new Promise((function(i,n){t.LoadScript(e,(function(){i()}),(function(e,t){n(t||new Error(e))}))}))}},{key:"ReadFileAsDataURL",value:function(e,t,i){var n=new FileReader,r={onCompleteObservable:new ee,abort:function(){return n.abort()}};return n.onloadend=function(){r.onCompleteObservable.notifyObservers(r)},n.onload=function(e){t(e.target.result)},n.onprogress=i,n.readAsDataURL(e),r}},{key:"ReadFile",value:function(e,t,i,n,r){return mt(e,t,i,n,r)}},{key:"FileAsURL",value:function(e){var t=new Blob([e]);return window.URL.createObjectURL(t)}},{key:"Format",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return e.toFixed(t)}},{key:"DeepCopy",value:function(e,t,i,n){je.DeepCopy(e,t,i,n)}},{key:"IsEmpty",value:function(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}},{key:"RegisterTopRootEvents",value:function(e,t){for(var i=0;i<t.length;i++){var n=t[i];e.addEventListener(n.name,n.handler,!1);try{window.parent&&window.parent.addEventListener(n.name,n.handler,!1)}catch(r){}}}},{key:"UnregisterTopRootEvents",value:function(e,t){for(var i=0;i<t.length;i++){var n=t[i];e.removeEventListener(n.name,n.handler);try{e.parent&&e.parent.removeEventListener(n.name,n.handler)}catch(r){}}}},{key:"DumpFramebuffer",value:function(){var e=(0,f.Z)((0,d.Z)().mark((function e(t,i,n,r){var s=arguments;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw s.length>4&&void 0!==s[4]?s[4]:"image/png",s.length>5?s[5]:void 0,le("DumpTools");case 3:case"end":return e.stop()}}),e)})));return function(t,i,n,r){return e.apply(this,arguments)}}()},{key:"DumpData",value:function(e,t,i,n){throw le("DumpTools")}},{key:"DumpDataAsync",value:function(e,t,i){throw le("DumpTools")}},{key:"ToBlob",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"image/png",n=arguments.length>3?arguments[3]:void 0;e.toBlob||(e.toBlob=function(e,t,i){var n=this;setTimeout((function(){for(var r=atob(n.toDataURL(t,i).split(",")[1]),s=r.length,a=new Uint8Array(s),o=0;o<s;o++)a[o]=r.charCodeAt(o);e(new Blob([a]))}))}),e.toBlob((function(e){t(e)}),i,n)}},{key:"DownloadBlob",value:function(t,i){if("download"in document.createElement("a")){if(!i){var n=new Date;i="screenshot_"+(n.getFullYear()+"-"+(n.getMonth()+1)).slice(2)+"-"+n.getDate()+"_"+n.getHours()+"-"+("0"+n.getMinutes()).slice(-2)+".png"}e.Download(t,i)}else if(t&&typeof URL<"u"){var r=URL.createObjectURL(t),s=window.open("");if(!s)return;var a=s.document.createElement("img");a.onload=function(){URL.revokeObjectURL(r)},a.src=r,s.document.body.appendChild(a)}}},{key:"EncodeScreenshotCanvasData",value:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"image/png",r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;i?i(t.toDataURL(n,s)):this.ToBlob(t,(function(t){t&&e.DownloadBlob(t,r)}),n,s)}},{key:"Download",value:function(e,t){if(!(typeof URL>"u")){var i=window.URL.createObjectURL(e),n=document.createElement("a");document.body.appendChild(n),n.style.display="none",n.href=i,n.download=t,n.addEventListener("click",(function(){n.parentElement&&n.parentElement.removeChild(n)})),n.click(),window.URL.revokeObjectURL(i)}}},{key:"BackCompatCameraNoPreventDefault",value:function(e){return"boolean"==typeof e[0]?e[0]:"boolean"==typeof e[1]&&e[1]}},{key:"CreateScreenshot",value:function(e,t,i,n){throw le("ScreenshotTools")}},{key:"CreateScreenshotAsync",value:function(e,t,i){throw le("ScreenshotTools")}},{key:"CreateScreenshotUsingRenderTarget",value:function(e,t,i,n){throw le("ScreenshotTools")}},{key:"CreateScreenshotUsingRenderTargetAsync",value:function(e,t,i){throw le("ScreenshotTools")}},{key:"RandomId",value:function(){return Ct()}},{key:"IsBase64",value:function(e){return St(e)}},{key:"DecodeBase64",value:function(e){return xt(e)}},{key:"errorsCount",get:function(){return ue.errorsCount}},{key:"Log",value:function(e){ue.Log(e)}},{key:"Warn",value:function(e){ue.Warn(e)}},{key:"Error",value:function(e){ue.Error(e)}},{key:"LogCache",get:function(){return ue.LogCache}},{key:"ClearLogCache",value:function(){ue.ClearLogCache()}},{key:"LogLevels",set:function(e){ue.LogLevels=e}},{key:"PerformanceLogLevel",set:function(t){return(t&e.PerformanceUserMarkLogLevel)===e.PerformanceUserMarkLogLevel?(e.StartPerformanceCounter=e._StartUserMark,void(e.EndPerformanceCounter=e._EndUserMark)):(t&e.PerformanceConsoleLogLevel)===e.PerformanceConsoleLogLevel?(e.StartPerformanceCounter=e._StartPerformanceConsole,void(e.EndPerformanceCounter=e._EndPerformanceConsole)):(e.StartPerformanceCounter=e._StartPerformanceCounterDisabled,void(e.EndPerformanceCounter=e._EndPerformanceCounterDisabled))}},{key:"_StartPerformanceCounterDisabled",value:function(e,t){}},{key:"_EndPerformanceCounterDisabled",value:function(e,t){}},{key:"_StartUserMark",value:function(t){var i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!e._Performance){if(!ne())return;e._Performance=window.performance}!i||!e._Performance.mark||e._Performance.mark(t+"-Begin")}},{key:"_EndUserMark",value:function(t){!(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])||!e._Performance.mark||(e._Performance.mark(t+"-End"),e._Performance.measure(t,t+"-Begin",t+"-End"))}},{key:"_StartPerformanceConsole",value:function(t){var i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];i&&(e._StartUserMark(t,i),console.time&&console.time(t))}},{key:"_EndPerformanceConsole",value:function(t){var i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];i&&(e._EndUserMark(t,i),console.timeEnd(t))}},{key:"Now",get:function(){return Be.Now}},{key:"GetClassName",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}},{key:"First",value:function(e,t){var i,n=(0,p.Z)(e);try{for(n.s();!(i=n.n()).done;){var r=i.value;if(t(r))return r}}catch(s){n.e(s)}finally{n.f()}return null}},{key:"getFullClassName",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=null,n=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){var r=t?e:Object.getPrototypeOf(e);i=r.constructor.__bjsclassName__,n=r.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(null!=n?n+".":"")+i:null}},{key:"DelayAsync",value:function(e){return new Promise((function(t){setTimeout((function(){t()}),e)}))}},{key:"IsSafari",value:function(){return!!re()&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}}]),e}();It.UseCustomRequestHeaders=!1,It.CustomRequestHeaders=Qe.CustomRequestHeaders,It._TmpFloatArray=new Float32Array(1),It.GetDOMTextContent=ae,It.GetAbsoluteUrl="object"==typeof document?function(e){var t=document.createElement("a");return t.href=e,t.href}:"function"==typeof URL&&"object"==typeof location?function(e){return new URL(e,location.origin).href}:function(){throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},It.NoneLogLevel=ue.NoneLogLevel,It.MessageLogLevel=ue.MessageLogLevel,It.WarningLogLevel=ue.WarningLogLevel,It.ErrorLogLevel=ue.ErrorLogLevel,It.AllLogLevel=ue.AllLogLevel,It.IsWindowObjectExist=ne,It.PerformanceNoneLogLevel=0,It.PerformanceUserMarkLogLevel=1,It.PerformanceConsoleLogLevel=2,It.StartPerformanceCounter=It._StartPerformanceCounterDisabled,It.EndPerformanceCounter=It._EndPerformanceCounterDisabled;var Pt=function(){function e(t,i,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;(0,m.Z)(this,e),this.iterations=t,this.index=r-1,this._done=!1,this._fn=i,this._successCallback=n}return(0,y.Z)(e,[{key:"executeNext",value:function(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}},{key:"breakLoop",value:function(){this._done=!0,this._successCallback()}}],[{key:"Run",value:function(t,i,n){var r=new e(t,i,n,arguments.length>3&&void 0!==arguments[3]?arguments[3]:0);return r.executeNext(),r}},{key:"SyncAsyncForLoop",value:function(t,i,n,r,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return e.Run(Math.ceil(t/i),(function(e){s&&s()?e.breakLoop():setTimeout((function(){for(var r=0;r<i;++r){var a=e.index*i+r;if(a>=t)break;if(n(a),s&&s()){e.breakLoop();break}}e.executeNext()}),a)}),r)}}]),e}();V.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";var kt=function(){function e(t){(0,m.Z)(this,e),this.length=0,this.data=new Array(t),this._id=e._GlobalId++}return(0,y.Z)(e,[{key:"push",value:function(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}},{key:"forEach",value:function(e){for(var t=0;t<this.length;t++)e(this.data[t])}},{key:"sort",value:function(e){this.data.sort(e)}},{key:"reset",value:function(){this.length=0}},{key:"dispose",value:function(){this.reset(),this.data&&(this.data.length=0)}},{key:"concat",value:function(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(var t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}},{key:"indexOf",value:function(e){var t=this.data.indexOf(e);return t>=this.length?-1:t}},{key:"contains",value:function(e){return-1!==this.indexOf(e)}}]),e}();kt._GlobalId=0;var Dt=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){var e;return(0,m.Z)(this,i),(e=t.apply(this,arguments))._duplicateId=0,e}return(0,y.Z)(i,[{key:"push",value:function(e){c((0,h.Z)(i.prototype),"push",this).call(this,e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}},{key:"pushNoDuplicate",value:function(e){return(!e.__smartArrayFlags||e.__smartArrayFlags[this._id]!==this._duplicateId)&&(this.push(e),!0)}},{key:"reset",value:function(){c((0,h.Z)(i.prototype),"reset",this).call(this),this._duplicateId++}},{key:"concatWithNoDuplicate",value:function(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(var t=0;t<e.length;t++){var i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}]),i}(kt),Ft=function(){function e(){(0,m.Z)(this,e),this._count=0,this._data={}}return(0,y.Z)(e,[{key:"copyFrom",value:function(e){var t=this;this.clear(),e.forEach((function(e,i){return t.add(e,i)}))}},{key:"get",value:function(e){var t=this._data[e];if(void 0!==t)return t}},{key:"getOrAddWithFactory",value:function(e,t){var i=this.get(e);return void 0!==i||(i=t(e))&&this.add(e,i),i}},{key:"getOrAdd",value:function(e,t){var i=this.get(e);return void 0!==i?i:(this.add(e,t),t)}},{key:"contains",value:function(e){return void 0!==this._data[e]}},{key:"add",value:function(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,!0)}},{key:"set",value:function(e,t){return void 0!==this._data[e]&&(this._data[e]=t,!0)}},{key:"getAndRemove",value:function(e){var t=this.get(e);return void 0!==t?(delete this._data[e],--this._count,t):null}},{key:"remove",value:function(e){return!!this.contains(e)&&(delete this._data[e],--this._count,!0)}},{key:"clear",value:function(){this._data={},this._count=0}},{key:"count",get:function(){return this._count}},{key:"forEach",value:function(e){for(var t in this._data){e(t,this._data[t])}}},{key:"first",value:function(e){for(var t in this._data){var i=e(t,this._data[t]);if(i)return i}return null}}]),e}(),wt=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"Eval",value:function(t,i){return"true"===(t=t.match(/\([^()]*\)/g)?t.replace(/\([^()]*\)/g,(function(t){return t=t.slice(1,t.length-1),e._HandleParenthesisContent(t,i)})):e._HandleParenthesisContent(t,i))||"false"!==t&&e.Eval(t,i)}},{key:"_HandleParenthesisContent",value:function(t,i){var n;i=i||function(e){return"true"===e};var r=t.split("||");for(var s in r)if(Object.prototype.hasOwnProperty.call(r,s)){var a=e._SimplifyNegation(r[s].trim()),o=a.split("&&");if(o.length>1)for(var l=0;l<o.length;++l){var u=e._SimplifyNegation(o[l].trim());if(!(n="true"!==u&&"false"!==u?"!"===u[0]?!i(u.substring(1)):i(u):"true"===u)){a="false";break}}if(n||"true"===a){n=!0;break}n="true"!==a&&"false"!==a?"!"===a[0]?!i(a.substring(1)):i(a):"true"===a}return n?"true":"false"}},{key:"_SimplifyNegation",value:function(e){return"!true"===(e=(e=e.replace(/^[\s!]+/,(function(e){return(e=e.replace(/[\s]/g,(function(){return""}))).length%2?"!":""}))).trim())?e="false":"!false"===e&&(e="true"),e}}]),e}(),Ot=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"EnableFor",value:function(t){t._tags=t._tags||{},t.hasTags=function(){return e.HasTags(t)},t.addTags=function(i){return e.AddTagsTo(t,i)},t.removeTags=function(i){return e.RemoveTagsFrom(t,i)},t.matchesTagsQuery=function(i){return e.MatchesQuery(t,i)}}},{key:"DisableFor",value:function(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}},{key:"HasTags",value:function(e){if(!e._tags)return!1;var t=e._tags;for(var i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1}},{key:"GetTags",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!e._tags)return null;if(t){var i=[];for(var n in e._tags)Object.prototype.hasOwnProperty.call(e._tags,n)&&!0===e._tags[n]&&i.push(n);return i.join(" ")}return e._tags}},{key:"AddTagsTo",value:function(t,i){i&&"string"==typeof i&&i.split(" ").forEach((function(i){e._AddTagTo(t,i)}))}},{key:"_AddTagTo",value:function(t,i){""!==(i=i.trim())&&"true"!==i&&"false"!==i&&(i.match(/[\s]/)||i.match(/^([!]|([|]|[&]){2})/)||(e.EnableFor(t),t._tags[i]=!0))}},{key:"RemoveTagsFrom",value:function(t,i){if(e.HasTags(t)){var n=i.split(" ");for(var r in n)e._RemoveTagFrom(t,n[r])}}},{key:"_RemoveTagFrom",value:function(e,t){delete e._tags[t]}},{key:"MatchesQuery",value:function(t,i){return void 0===i||(""===i?e.HasTags(t):wt.Eval(i,(function(i){return e.HasTags(t)&&t._tags[i]})))}}]),e}(),Lt=function(){function e(){(0,m.Z)(this,e),this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this._environmentTexture=null,this.postProcesses=new Array}return(0,y.Z)(e,[{key:"environmentTexture",get:function(){return this._environmentTexture},set:function(e){this._environmentTexture=e}},{key:"getNodes",value:function(){var e=new Array;return e=(e=(e=(e=e.concat(this.meshes)).concat(this.lights)).concat(this.cameras)).concat(this.transformNodes),this.skeletons.forEach((function(t){return e=e.concat(t.bones)})),e}}],[{key:"AddParser",value:function(e,t){this._BabylonFileParsers[e]=t}},{key:"GetParser",value:function(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null}},{key:"AddIndividualParser",value:function(e,t){this._IndividualBabylonFileParsers[e]=t}},{key:"GetIndividualParser",value:function(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null}},{key:"Parse",value:function(e,t,i,n){for(var r in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,r)&&this._BabylonFileParsers[r](e,t,i,n)}}]),e}();function Nt(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,i,a):r(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}Lt._BabylonFileParsers={},Lt._IndividualBabylonFileParsers={};var Bt={},Ut={},Vt=function(e,t,i){var n=e();Ot&&Ot.AddTagsTo(n,t.tags);var r=Gt(n);for(var s in r){var a=r[s],o=t[s],l=a.type;if(null!=o&&("uniqueId"!==s||jt.AllowLoadingUniqueId))switch(l){case 0:case 6:case 11:n[s]=o;break;case 1:n[s]=i||o.isRenderTarget?o:o.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:n[s]=i?o:o.clone()}}return n};function Gt(e){var t=e.getClassName();if(Ut[t])return Ut[t];Ut[t]={};for(var i=Ut[t],n=e,r=t;r;){var s=Bt[r];for(var a in s)i[a]=s[a];var o=void 0,l=!1;do{if(!(o=Object.getPrototypeOf(n)).getClassName){l=!0;break}if(o.getClassName()!==r)break;n=o}while(o);if(l)break;r=o.getClassName(),n=o}return i}function Wt(e,t){return function(i,n){var r=function(e){var t=e.getClassName();return Bt[t]||(Bt[t]={}),Bt[t]}(i);r[n]||(r[n]={type:e,sourceName:t})}}function zt(e){return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return function(i,n){var r=t||"_"+n;Object.defineProperty(i,n,{get:function(){return this[r]},set:function(t){"function"==typeof this.equals&&this.equals(t)||this[r]!==t&&(this[r]=t,i[e].apply(this))},enumerable:!0,configurable:!0})}}(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:null)}function Xt(e){return Wt(0,e)}function Ht(e){return Wt(1,e)}function Zt(e){return Wt(2,e)}function Kt(e){return Wt(3,e)}function Yt(e){return Wt(5,e)}function qt(e){return Wt(8,e)}var jt=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"AppendSerializedAnimations",value:function(e,t){if(e.animations){t.animations=[];for(var i=0;i<e.animations.length;i++){var n=e.animations[i];t.animations.push(n.serialize())}}}},{key:"Serialize",value:function(t,i){i||(i={}),Ot&&(i.tags=Ot.GetTags(t));var n=Gt(t);for(var r in n){var s=n[r],a=s.sourceName||r,o=s.type,l=t[r];if(null!=l&&("uniqueId"!==r||e.AllowLoadingUniqueId))switch(o){case 0:i[a]=l;break;case 1:case 3:case 7:case 9:i[a]=l.serialize();break;case 2:case 4:case 5:case 8:case 10:case 12:i[a]=l.asArray();break;case 6:case 11:i[a]=l.id}}return i}},{key:"Parse",value:function(t,i,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=t();r||(r=""),Ot&&Ot.AddTagsTo(s,i.tags);var a=Gt(s);for(var o in a){var l=a[o],u=i[l.sourceName||o],h=l.type;if(null!=u&&("uniqueId"!==o||e.AllowLoadingUniqueId)){var c=s;switch(h){case 0:c[o]=u;break;case 1:n&&(c[o]=e._TextureParser(u,n,r));break;case 2:c[o]=Ze.FromArray(u);break;case 3:c[o]=e._FresnelParametersParser(u);break;case 4:c[o]=W.FromArray(u);break;case 5:c[o]=z.FromArray(u);break;case 6:n&&(c[o]=n.getLastMeshById(u));break;case 7:c[o]=e._ColorCurvesParser(u);break;case 8:c[o]=Ke.FromArray(u);break;case 9:c[o]=e._ImageProcessingConfigurationParser(u);break;case 10:c[o]=H.FromArray(u);break;case 11:n&&(c[o]=n.getCameraById(u));break;case 12:c[o]=Z.FromArray(u)}}}return s}},{key:"Clone",value:function(e,t){return Vt(e,t,!1)}},{key:"Instanciate",value:function(e,t){return Vt(e,t,!0)}}]),e}();function Qt(e,t,i,n){var r=i.value;i.value=function(){var i=r;if(typeof _native<"u"&&_native[t]){var s=_native[t];i=n?function(){return n.apply(void 0,arguments)?s.apply(void 0,arguments):r.apply(void 0,arguments)}:s}return e[t]=i,i.apply(void 0,arguments)}}jt.AllowLoadingUniqueId=!1,jt._ImageProcessingConfigurationParser=function(e){throw le("ImageProcessingConfiguration")},jt._FresnelParametersParser=function(e){throw le("FresnelParameters")},jt._ColorCurvesParser=function(e){throw le("ColorCurves")},jt._TextureParser=function(e,t,i){throw le("Texture")},Qt.filter=function(e){return function(t,i,n){return Qt(t,i,n,e)}};var Jt=function(){function e(t){if((0,m.Z)(this,e),this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=t,t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&this._setDefaultValue(i)}return(0,y.Z)(e,[{key:"isDirty",get:function(){return this._isDirty}},{key:"markAsProcessed",value:function(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}},{key:"markAsUnprocessed",value:function(){this._isDirty=!0}},{key:"markAllAsDirty",value:function(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0}},{key:"markAsImageProcessingDirty",value:function(){this._areImageProcessingDirty=!0,this._isDirty=!0}},{key:"markAsLightDirty",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}},{key:"markAsAttributesDirty",value:function(){this._areAttributesDirty=!0,this._isDirty=!0}},{key:"markAsTexturesDirty",value:function(){this._areTexturesDirty=!0,this._isDirty=!0}},{key:"markAsFresnelDirty",value:function(){this._areFresnelDirty=!0,this._isDirty=!0}},{key:"markAsMiscDirty",value:function(){this._areMiscDirty=!0,this._isDirty=!0}},{key:"markAsPrePassDirty",value:function(){this._arePrePassDirty=!0,this._isDirty=!0}},{key:"rebuild",value:function(){this._keys.length=0;for(var e=0,t=Object.keys(this);e<t.length;e++){var i=t[e];"_"!==i[0]&&this._keys.push(i)}if(this._externalProperties)for(var n in this._externalProperties)-1===this._keys.indexOf(n)&&this._keys.push(n)}},{key:"isEqual",value:function(e){if(this._keys.length!==e._keys.length)return!1;for(var t=0;t<this._keys.length;t++){var i=this._keys[t];if(this[i]!==e[i])return!1}return!0}},{key:"cloneTo",value:function(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(var t=0;t<this._keys.length;t++){var i=this._keys[t];e[i]=this[i]}}},{key:"reset",value:function(){var e=this;this._keys.forEach((function(t){return e._setDefaultValue(t)}))}},{key:"_setDefaultValue",value:function(e){var t,i,n,r,s,a=null!==(n=null===(i=null===(t=this._externalProperties)||void 0===t?void 0:t[e])||void 0===i?void 0:i.type)&&void 0!==n?n:typeof this[e],o=null===(s=null===(r=this._externalProperties)||void 0===r?void 0:r[e])||void 0===s?void 0:s.default;switch(a){case"number":this[e]=null!==o&&void 0!==o?o:0;break;case"string":this[e]=null!==o&&void 0!==o?o:"";break;default:this[e]=null!==o&&void 0!==o&&o}}},{key:"toString",value:function(){for(var e="",t=0;t<this._keys.length;t++){var i=this._keys[t],n=this[i];switch(typeof n){case"number":case"string":e+="#define "+i+" "+n+"\n";break;default:n&&(e+="#define "+i+"\n")}}return e}}]),e}(),$t=function(){function e(){(0,m.Z)(this,e),this._dirty=!0,this._tempColor=new Ke(0,0,0,0),this._globalCurve=new Ke(0,0,0,0),this._highlightsCurve=new Ke(0,0,0,0),this._midtonesCurve=new Ke(0,0,0,0),this._shadowsCurve=new Ke(0,0,0,0),this._positiveCurve=new Ke(0,0,0,0),this._negativeCurve=new Ke(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}return(0,y.Z)(e,[{key:"globalHue",get:function(){return this._globalHue},set:function(e){this._globalHue=e,this._dirty=!0}},{key:"globalDensity",get:function(){return this._globalDensity},set:function(e){this._globalDensity=e,this._dirty=!0}},{key:"globalSaturation",get:function(){return this._globalSaturation},set:function(e){this._globalSaturation=e,this._dirty=!0}},{key:"globalExposure",get:function(){return this._globalExposure},set:function(e){this._globalExposure=e,this._dirty=!0}},{key:"highlightsHue",get:function(){return this._highlightsHue},set:function(e){this._highlightsHue=e,this._dirty=!0}},{key:"highlightsDensity",get:function(){return this._highlightsDensity},set:function(e){this._highlightsDensity=e,this._dirty=!0}},{key:"highlightsSaturation",get:function(){return this._highlightsSaturation},set:function(e){this._highlightsSaturation=e,this._dirty=!0}},{key:"highlightsExposure",get:function(){return this._highlightsExposure},set:function(e){this._highlightsExposure=e,this._dirty=!0}},{key:"midtonesHue",get:function(){return this._midtonesHue},set:function(e){this._midtonesHue=e,this._dirty=!0}},{key:"midtonesDensity",get:function(){return this._midtonesDensity},set:function(e){this._midtonesDensity=e,this._dirty=!0}},{key:"midtonesSaturation",get:function(){return this._midtonesSaturation},set:function(e){this._midtonesSaturation=e,this._dirty=!0}},{key:"midtonesExposure",get:function(){return this._midtonesExposure},set:function(e){this._midtonesExposure=e,this._dirty=!0}},{key:"shadowsHue",get:function(){return this._shadowsHue},set:function(e){this._shadowsHue=e,this._dirty=!0}},{key:"shadowsDensity",get:function(){return this._shadowsDensity},set:function(e){this._shadowsDensity=e,this._dirty=!0}},{key:"shadowsSaturation",get:function(){return this._shadowsSaturation},set:function(e){this._shadowsSaturation=e,this._dirty=!0}},{key:"shadowsExposure",get:function(){return this._shadowsExposure},set:function(e){this._shadowsExposure=e,this._dirty=!0}},{key:"getClassName",value:function(){return"ColorCurves"}},{key:"_getColorGradingDataToRef",value:function(t,i,n,r,s){null!=t&&(t=e._Clamp(t,0,360),i=e._Clamp(i,-100,100),n=e._Clamp(n,-100,100),r=e._Clamp(r,-100,100),i=e._ApplyColorGradingSliderNonlinear(i),i*=.5,r=e._ApplyColorGradingSliderNonlinear(r),i<0&&(i*=-1,t=(t+180)%360),e._FromHSBToRef(t,i,50+.25*r,s),s.scaleToRef(2,s),s.a=1+.01*n)}},{key:"clone",value:function(){return jt.Clone((function(){return new e}),this)}},{key:"serialize",value:function(){return jt.Serialize(this)}}],[{key:"Bind",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"vCameraColorCurvePositive",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"vCameraColorCurveNeutral",r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"vCameraColorCurveNegative";e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(n,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(r,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}},{key:"PrepareUniforms",value:function(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}},{key:"_ApplyColorGradingSliderNonlinear",value:function(e){e/=100;var t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100}},{key:"_FromHSBToRef",value:function(t,i,n,r){var s=e._Clamp(t,0,360),a=e._Clamp(i/100,0,1),o=e._Clamp(n/100,0,1);if(0===a)r.r=o,r.g=o,r.b=o;else{s/=60;var l=Math.floor(s),u=s-l,h=o*(1-a),c=o*(1-a*u),d=o*(1-a*(1-u));switch(l){case 0:r.r=o,r.g=d,r.b=h;break;case 1:r.r=c,r.g=o,r.b=h;break;case 2:r.r=h,r.g=o,r.b=d;break;case 3:r.r=h,r.g=c,r.b=o;break;case 4:r.r=d,r.g=h,r.b=o;break;default:r.r=o,r.g=h,r.b=c}}r.a=1}},{key:"_Clamp",value:function(e,t,i){return Math.min(Math.max(e,t),i)}},{key:"Parse",value:function(t){return jt.Parse((function(){return new e}),t,null,null)}}]),e}();Nt([Xt()],$t.prototype,"_globalHue",void 0),Nt([Xt()],$t.prototype,"_globalDensity",void 0),Nt([Xt()],$t.prototype,"_globalSaturation",void 0),Nt([Xt()],$t.prototype,"_globalExposure",void 0),Nt([Xt()],$t.prototype,"_highlightsHue",void 0),Nt([Xt()],$t.prototype,"_highlightsDensity",void 0),Nt([Xt()],$t.prototype,"_highlightsSaturation",void 0),Nt([Xt()],$t.prototype,"_highlightsExposure",void 0),Nt([Xt()],$t.prototype,"_midtonesHue",void 0),Nt([Xt()],$t.prototype,"_midtonesDensity",void 0),Nt([Xt()],$t.prototype,"_midtonesSaturation",void 0),Nt([Xt()],$t.prototype,"_midtonesExposure",void 0),jt._ColorCurvesParser=$t.Parse;var ei=function(){function e(){(0,m.Z)(this,e),this.colorCurves=new $t,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=e.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new Ke(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=e.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new ee}return(0,y.Z)(e,[{key:"colorCurvesEnabled",get:function(){return this._colorCurvesEnabled},set:function(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}},{key:"colorGradingTexture",get:function(){return this._colorGradingTexture},set:function(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}},{key:"colorGradingEnabled",get:function(){return this._colorGradingEnabled},set:function(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}},{key:"colorGradingWithGreenDepth",get:function(){return this._colorGradingWithGreenDepth},set:function(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}},{key:"colorGradingBGR",get:function(){return this._colorGradingBGR},set:function(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}},{key:"exposure",get:function(){return this._exposure},set:function(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}},{key:"toneMappingEnabled",get:function(){return this._toneMappingEnabled},set:function(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}},{key:"toneMappingType",get:function(){return this._toneMappingType},set:function(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}},{key:"contrast",get:function(){return this._contrast},set:function(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}},{key:"vignetteCentreY",get:function(){return this.vignetteCenterY},set:function(e){this.vignetteCenterY=e}},{key:"vignetteCentreX",get:function(){return this.vignetteCenterX},set:function(e){this.vignetteCenterX=e}},{key:"vignetteBlendMode",get:function(){return this._vignetteBlendMode},set:function(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}},{key:"vignetteEnabled",get:function(){return this._vignetteEnabled},set:function(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}},{key:"ditheringEnabled",get:function(){return this._ditheringEnabled},set:function(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}},{key:"ditheringIntensity",get:function(){return this._ditheringIntensity},set:function(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}},{key:"skipFinalColorClamp",get:function(){return this._skipFinalColorClamp},set:function(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}},{key:"applyByPostProcess",get:function(){return this._applyByPostProcess},set:function(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}},{key:"isEnabled",get:function(){return this._isEnabled},set:function(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}},{key:"_updateParameters",value:function(){this.onUpdateParameters.notifyObservers(this)}},{key:"getClassName",value:function(){return"ImageProcessingConfiguration"}},{key:"prepareDefines",value:function(t){if((arguments.length>1&&void 0!==arguments[1]&&arguments[1])!==this.applyByPostProcess||!this._isEnabled)return t.VIGNETTE=!1,t.TONEMAPPING=!1,t.TONEMAPPING_ACES=!1,t.CONTRAST=!1,t.EXPOSURE=!1,t.COLORCURVES=!1,t.COLORGRADING=!1,t.COLORGRADING3D=!1,t.DITHER=!1,t.IMAGEPROCESSING=!1,t.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,void(t.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled);if(t.VIGNETTE=this.vignetteEnabled,t.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===e._VIGNETTEMODE_MULTIPLY,t.VIGNETTEBLENDMODEOPAQUE=!t.VIGNETTEBLENDMODEMULTIPLY,t.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType===e.TONEMAPPING_ACES)t.TONEMAPPING_ACES=!0;else t.TONEMAPPING_ACES=!1;t.CONTRAST=1!==this.contrast,t.EXPOSURE=1!==this.exposure,t.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,t.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,t.COLORGRADING?t.COLORGRADING3D=this.colorGradingTexture.is3D:t.COLORGRADING3D=!1,t.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,t.SAMPLER3DBGRMAP=this.colorGradingBGR,t.DITHER=this._ditheringEnabled,t.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,t.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,t.IMAGEPROCESSING=t.VIGNETTE||t.TONEMAPPING||t.CONTRAST||t.EXPOSURE||t.COLORCURVES||t.COLORGRADING||t.DITHER}},{key:"isReady",value:function(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}},{key:"bind",value:function(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&$t.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){var i=1/e.getEngine().getRenderWidth(),n=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,n),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){var r=null!==t&&void 0!==t?t:n/i,s=Math.tan(.5*this.vignetteCameraFov),a=s*r,o=Math.sqrt(a*s);a=It.Mix(a,o,this.vignetteStretch),s=It.Mix(s,o,this.vignetteStretch),e.setFloat4("vignetteSettings1",a,s,-a*this.vignetteCenterX,-s*this.vignetteCenterY);var l=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,l)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);var u=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(u-1)/u,.5/u,u,this.colorGradingTexture.level)}}},{key:"clone",value:function(){return jt.Clone((function(){return new e}),this)}},{key:"serialize",value:function(){return jt.Serialize(this)}}],[{key:"PrepareUniforms",value:function(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&$t.PrepareUniforms(e),t.DITHER&&e.push("ditherIntensity")}},{key:"PrepareSamplers",value:function(e,t){t.COLORGRADING&&e.push("txColorTransform")}},{key:"Parse",value:function(t){var i=jt.Parse((function(){return new e}),t,null,null);return void 0!==t.vignetteCentreX&&(i.vignetteCenterX=t.vignetteCentreX),void 0!==t.vignetteCentreY&&(i.vignetteCenterY=t.vignetteCentreY),i}},{key:"VIGNETTEMODE_MULTIPLY",get:function(){return this._VIGNETTEMODE_MULTIPLY}},{key:"VIGNETTEMODE_OPAQUE",get:function(){return this._VIGNETTEMODE_OPAQUE}}]),e}();ei.TONEMAPPING_STANDARD=0,ei.TONEMAPPING_ACES=1,ei._VIGNETTEMODE_MULTIPLY=0,ei._VIGNETTEMODE_OPAQUE=1,Nt([function(e){return Wt(7,e)}()],ei.prototype,"colorCurves",void 0),Nt([Xt()],ei.prototype,"_colorCurvesEnabled",void 0),Nt([Ht("colorGradingTexture")],ei.prototype,"_colorGradingTexture",void 0),Nt([Xt()],ei.prototype,"_colorGradingEnabled",void 0),Nt([Xt()],ei.prototype,"_colorGradingWithGreenDepth",void 0),Nt([Xt()],ei.prototype,"_colorGradingBGR",void 0),Nt([Xt()],ei.prototype,"_exposure",void 0),Nt([Xt()],ei.prototype,"_toneMappingEnabled",void 0),Nt([Xt()],ei.prototype,"_toneMappingType",void 0),Nt([Xt()],ei.prototype,"_contrast",void 0),Nt([Xt()],ei.prototype,"vignetteStretch",void 0),Nt([Xt()],ei.prototype,"vignetteCenterX",void 0),Nt([Xt()],ei.prototype,"vignetteCenterY",void 0),Nt([Xt()],ei.prototype,"vignetteWeight",void 0),Nt([qt()],ei.prototype,"vignetteColor",void 0),Nt([Xt()],ei.prototype,"vignetteCameraFov",void 0),Nt([Xt()],ei.prototype,"_vignetteBlendMode",void 0),Nt([Xt()],ei.prototype,"_vignetteEnabled",void 0),Nt([Xt()],ei.prototype,"_ditheringEnabled",void 0),Nt([Xt()],ei.prototype,"_ditheringIntensity",void 0),Nt([Xt()],ei.prototype,"_skipFinalColorClamp",void 0),Nt([Xt()],ei.prototype,"_applyByPostProcess",void 0),Nt([Xt()],ei.prototype,"_isEnabled",void 0),jt._ImageProcessingConfigurationParser=ei.Parse,Ve.prototype.createUniformBuffer=function(e){var t=this._gl.createBuffer();if(!t)throw new Error("Unable to create uniform buffer");var i=new De(t);return this.bindUniformBuffer(i),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),i.references=1,i},Ve.prototype.createDynamicUniformBuffer=function(e){var t=this._gl.createBuffer();if(!t)throw new Error("Unable to create dynamic uniform buffer");var i=new De(t);return this.bindUniformBuffer(i),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),i.references=1,i},Ve.prototype.updateUniformBuffer=function(e,t,i,n){this.bindUniformBuffer(e),void 0===i&&(i=0),void 0===n?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(i,i+n)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(i,i+n)),this.bindUniformBuffer(null)},Ve.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e?e.underlyingResource:null)},Ve.prototype.bindUniformBufferBase=function(e,t,i){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e?e.underlyingResource:null)},Ve.prototype.bindUniformBlock=function(e,t,i){var n=e.program,r=this._gl.getUniformBlockIndex(n,t);4294967295!==r&&this._gl.uniformBlockBinding(n,r,i)};var ti=function(){function e(t,i,n,r){var s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];(0,m.Z)(this,e),this._valueCache={},this._engine=t,this._noUBO=!t.supportsUniformBuffers||s,this._dynamic=n,this._name=null!==r&&void 0!==r?r:"no-name",this._data=i||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}return(0,y.Z)(e,[{key:"useUbo",get:function(){return!this._noUBO}},{key:"isSync",get:function(){return!this._needSync}},{key:"isDynamic",value:function(){return void 0!==this._dynamic}},{key:"getData",value:function(){return this._bufferData}},{key:"getBuffer",value:function(){return this._buffer}},{key:"_fillAlignment",value:function(e){var t;if(t=e<=2?e:4,this._uniformLocationPointer%t!==0){var i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;for(var n=this._uniformLocationPointer-i,r=0;r<n;r++)this._data.push(0)}}},{key:"addUniform",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!this._noUBO&&void 0===this._uniformLocations[e]){var n;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},16==t)t*=i;else t=t*i+(4-t)*i;n=[];for(var r=0;r<t;r++)n.push(0)}else{if(t instanceof Array)t=(n=t).length;else{n=[];for(var s=0;s<t;s++)n.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(var a=0;a<t;a++)this._data.push(n[a]);this._needSync=!0}}},{key:"addMatrix",value:function(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))}},{key:"addFloat2",value:function(e,t,i){var n=[t,i];this.addUniform(e,n)}},{key:"addFloat3",value:function(e,t,i,n){var r=[t,i,n];this.addUniform(e,r)}},{key:"addColor3",value:function(e,t){var i=[t.r,t.g,t.b];this.addUniform(e,i)}},{key:"addColor4",value:function(e,t,i){var n=[t.r,t.g,t.b,i];this.addUniform(e,n)}},{key:"addVector3",value:function(e,t){var i=[t.x,t.y,t.z];this.addUniform(e,i)}},{key:"addMatrix3x3",value:function(e){this.addUniform(e,12)}},{key:"addMatrix2x2",value:function(e){this.addUniform(e,8)}},{key:"create",value:function(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}},{key:"_rebuild",value:function(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}},{key:"_numBuffers",get:function(){return this._buffers.length}},{key:"_indexBuffer",get:function(){return this._bufferIndex}},{key:"name",get:function(){return this._name}},{key:"_buffersEqual",value:function(e,t){for(var i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}},{key:"_copyBuffer",value:function(e,t){for(var i=0;i<e.length;++i)t[i]=e[i]}},{key:"update",value:function(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer)return void this.create();if(!this._dynamic&&!this._needSync)return void(this._createBufferOnWrite=this._engine._features.trackUbosInFrame);if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1]){if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1]))return this._needSync=!1,void(this._createBufferOnWrite=this._engine._features.trackUbosInFrame);this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1])}this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(e._UpdatedUbosInFrame[this._name]||(e._UpdatedUbosInFrame[this._name]=0),e._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}},{key:"_createNewBuffer",value:function(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}},{key:"_checkNewFrame",value:function(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=0!==this._bufferIndex,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}},{key:"updateUniform",value:function(e,t,i){this._checkNewFrame();var n=this._uniformLocations[e];if(void 0===n){if(this._buffer)return void ue.Error("Cannot add an uniform after UBO has been created.");this.addUniform(e,i),n=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(var r=0;r<i;r++)this._bufferData[n+r]=t[r];else{for(var s=!1,a=0;a<i;a++)(16===i&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[n+a]!==It.FloatRound(t[a]))&&(s=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+a]=t[a]);this._needSync=this._needSync||s}}},{key:"updateUniformArray",value:function(e,t,i){this._checkNewFrame();var n=this._uniformLocations[e];if(void 0!==n){this._buffer||this.create();var r=this._uniformArraySizes[e];if(this._dynamic)for(var s=0;s<i;s++)this._bufferData[n+s]=t[s];else{for(var a=!1,o=0,l=0,u=0;u<i;u++)if(this._bufferData[n+4*l+o]!==It.FloatRound(t[u])&&(a=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+4*l+o]=t[u]),++o===r.strideSize){for(;o<4;o++)this._bufferData[n+4*l+o]=0;o=0,l++}this._needSync=this._needSync||a}}else ue.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.")}},{key:"_cacheMatrix",value:function(e,t){this._checkNewFrame();var i=this._valueCache[e],n=t.updateFlag;return(void 0===i||i!==n)&&(this._valueCache[e]=n,!0)}},{key:"_updateMatrix3x3ForUniform",value:function(t,i){for(var n=0;n<3;n++)e._TempBuffer[4*n]=i[3*n],e._TempBuffer[4*n+1]=i[3*n+1],e._TempBuffer[4*n+2]=i[3*n+2],e._TempBuffer[4*n+3]=0;this.updateUniform(t,e._TempBuffer,12)}},{key:"_updateMatrix3x3ForEffect",value:function(e,t){this._currentEffect.setMatrix3x3(e,t)}},{key:"_updateMatrix2x2ForEffect",value:function(e,t){this._currentEffect.setMatrix2x2(e,t)}},{key:"_updateMatrix2x2ForUniform",value:function(t,i){for(var n=0;n<2;n++)e._TempBuffer[4*n]=i[2*n],e._TempBuffer[4*n+1]=i[2*n+1],e._TempBuffer[4*n+2]=0,e._TempBuffer[4*n+3]=0;this.updateUniform(t,e._TempBuffer,8)}},{key:"_updateFloatForEffect",value:function(e,t){this._currentEffect.setFloat(e,t)}},{key:"_updateFloatForUniform",value:function(t,i){e._TempBuffer[0]=i,this.updateUniform(t,e._TempBuffer,1)}},{key:"_updateFloat2ForEffect",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this._currentEffect.setFloat2(e+n,t,i)}},{key:"_updateFloat2ForUniform",value:function(t,i,n){e._TempBuffer[0]=i,e._TempBuffer[1]=n,this.updateUniform(t,e._TempBuffer,2)}},{key:"_updateFloat3ForEffect",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";this._currentEffect.setFloat3(e+r,t,i,n)}},{key:"_updateFloat3ForUniform",value:function(t,i,n,r){e._TempBuffer[0]=i,e._TempBuffer[1]=n,e._TempBuffer[2]=r,this.updateUniform(t,e._TempBuffer,3)}},{key:"_updateFloat4ForEffect",value:function(e,t,i,n,r){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"";this._currentEffect.setFloat4(e+s,t,i,n,r)}},{key:"_updateFloat4ForUniform",value:function(t,i,n,r,s){e._TempBuffer[0]=i,e._TempBuffer[1]=n,e._TempBuffer[2]=r,e._TempBuffer[3]=s,this.updateUniform(t,e._TempBuffer,4)}},{key:"_updateFloatArrayForEffect",value:function(e,t){this._currentEffect.setFloatArray(e,t)}},{key:"_updateFloatArrayForUniform",value:function(e,t){this.updateUniformArray(e,t,t.length)}},{key:"_updateArrayForEffect",value:function(e,t){this._currentEffect.setArray(e,t)}},{key:"_updateArrayForUniform",value:function(e,t){this.updateUniformArray(e,t,t.length)}},{key:"_updateIntArrayForEffect",value:function(e,t){this._currentEffect.setIntArray(e,t)}},{key:"_updateIntArrayForUniform",value:function(t,i){e._TempBufferInt32View.set(i),this.updateUniformArray(t,e._TempBuffer,i.length)}},{key:"_updateUIntArrayForEffect",value:function(e,t){this._currentEffect.setUIntArray(e,t)}},{key:"_updateUIntArrayForUniform",value:function(t,i){e._TempBufferUInt32View.set(i),this.updateUniformArray(t,e._TempBuffer,i.length)}},{key:"_updateMatrixForEffect",value:function(e,t){this._currentEffect.setMatrix(e,t)}},{key:"_updateMatrixForUniform",value:function(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)}},{key:"_updateMatricesForEffect",value:function(e,t){this._currentEffect.setMatrices(e,t)}},{key:"_updateMatricesForUniform",value:function(e,t){this.updateUniform(e,t,t.length)}},{key:"_updateVector3ForEffect",value:function(e,t){this._currentEffect.setVector3(e,t)}},{key:"_updateVector3ForUniform",value:function(t,i){e._TempBuffer[0]=i.x,e._TempBuffer[1]=i.y,e._TempBuffer[2]=i.z,this.updateUniform(t,e._TempBuffer,3)}},{key:"_updateVector4ForEffect",value:function(e,t){this._currentEffect.setVector4(e,t)}},{key:"_updateVector4ForUniform",value:function(t,i){e._TempBuffer[0]=i.x,e._TempBuffer[1]=i.y,e._TempBuffer[2]=i.z,e._TempBuffer[3]=i.w,this.updateUniform(t,e._TempBuffer,4)}},{key:"_updateColor3ForEffect",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";this._currentEffect.setColor3(e+i,t)}},{key:"_updateColor3ForUniform",value:function(t,i){e._TempBuffer[0]=i.r,e._TempBuffer[1]=i.g,e._TempBuffer[2]=i.b,this.updateUniform(t,e._TempBuffer,3)}},{key:"_updateColor4ForEffect",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this._currentEffect.setColor4(e+n,t,i)}},{key:"_updateDirectColor4ForEffect",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";this._currentEffect.setDirectColor4(e+i,t)}},{key:"_updateColor4ForUniform",value:function(t,i,n){e._TempBuffer[0]=i.r,e._TempBuffer[1]=i.g,e._TempBuffer[2]=i.b,e._TempBuffer[3]=n,this.updateUniform(t,e._TempBuffer,4)}},{key:"_updateDirectColor4ForUniform",value:function(t,i){e._TempBuffer[0]=i.r,e._TempBuffer[1]=i.g,e._TempBuffer[2]=i.b,e._TempBuffer[3]=i.a,this.updateUniform(t,e._TempBuffer,4)}},{key:"_updateIntForEffect",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";this._currentEffect.setInt(e+i,t)}},{key:"_updateIntForUniform",value:function(t,i){e._TempBufferInt32View[0]=i,this.updateUniform(t,e._TempBuffer,1)}},{key:"_updateInt2ForEffect",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this._currentEffect.setInt2(e+n,t,i)}},{key:"_updateInt2ForUniform",value:function(t,i,n){e._TempBufferInt32View[0]=i,e._TempBufferInt32View[1]=n,this.updateUniform(t,e._TempBuffer,2)}},{key:"_updateInt3ForEffect",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";this._currentEffect.setInt3(e+r,t,i,n)}},{key:"_updateInt3ForUniform",value:function(t,i,n,r){e._TempBufferInt32View[0]=i,e._TempBufferInt32View[1]=n,e._TempBufferInt32View[2]=r,this.updateUniform(t,e._TempBuffer,3)}},{key:"_updateInt4ForEffect",value:function(e,t,i,n,r){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"";this._currentEffect.setInt4(e+s,t,i,n,r)}},{key:"_updateInt4ForUniform",value:function(t,i,n,r,s){e._TempBufferInt32View[0]=i,e._TempBufferInt32View[1]=n,e._TempBufferInt32View[2]=r,e._TempBufferInt32View[3]=s,this.updateUniform(t,e._TempBuffer,4)}},{key:"_updateUIntForEffect",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";this._currentEffect.setUInt(e+i,t)}},{key:"_updateUIntForUniform",value:function(t,i){e._TempBufferUInt32View[0]=i,this.updateUniform(t,e._TempBuffer,1)}},{key:"_updateUInt2ForEffect",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this._currentEffect.setUInt2(e+n,t,i)}},{key:"_updateUInt2ForUniform",value:function(t,i,n){e._TempBufferUInt32View[0]=i,e._TempBufferUInt32View[1]=n,this.updateUniform(t,e._TempBuffer,2)}},{key:"_updateUInt3ForEffect",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";this._currentEffect.setUInt3(e+r,t,i,n)}},{key:"_updateUInt3ForUniform",value:function(t,i,n,r){e._TempBufferUInt32View[0]=i,e._TempBufferUInt32View[1]=n,e._TempBufferUInt32View[2]=r,this.updateUniform(t,e._TempBuffer,3)}},{key:"_updateUInt4ForEffect",value:function(e,t,i,n,r){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"";this._currentEffect.setUInt4(e+s,t,i,n,r)}},{key:"_updateUInt4ForUniform",value:function(t,i,n,r,s){e._TempBufferUInt32View[0]=i,e._TempBufferUInt32View[1]=n,e._TempBufferUInt32View[2]=r,e._TempBufferUInt32View[3]=s,this.updateUniform(t,e._TempBuffer,4)}},{key:"setTexture",value:function(e,t){this._currentEffect.setTexture(e,t)}},{key:"updateUniformDirectly",value:function(e,t){this.updateUniform(e,t,t.length),this.update()}},{key:"bindToEffect",value:function(e,t){this._currentEffect=e,this._currentEffectName=t}},{key:"bindUniformBuffer",value:function(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}},{key:"unbindEffect",value:function(){this._currentEffect=void 0,this._currentEffectName=void 0}},{key:"setDataBuffer",value:function(e){if(!this._buffers)return this._buffer===e;for(var t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}},{key:"dispose",value:function(){if(!this._noUBO){var e=this._engine._uniformBuffers,t=e.indexOf(this);if(-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(var i=0;i<this._buffers.length;++i){var n=this._buffers[i][0];this._engine._releaseBuffer(n)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}}]),e}();ti._UpdatedUbosInFrame={},ti._MAX_UNIFORM_SIZE=256,ti._TempBuffer=new Float32Array(ti._MAX_UNIFORM_SIZE),ti._TempBufferInt32View=new Int32Array(ti._TempBuffer.buffer),ti._TempBufferUInt32View=new Uint32Array(ti._TempBuffer.buffer);var ii=function(){function e(t,i,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=arguments.length>7?arguments[7]:void 0;(0,m.Z)(this,e),this._isAlreadyOwned=!1,t.getScene?this._engine=t.getScene().getEngine():this._engine=t,this._updatable=n,this._instanced=a,this._divisor=l||1,i instanceof ke?(this._data=null,this._buffer=i):(this._data=i,this._buffer=null),this.byteStride=o?r:r*Float32Array.BYTES_PER_ELEMENT,s||this.create()}return(0,y.Z)(e,[{key:"createVertexBuffer",value:function(e,t,i,n,r){var s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=arguments.length>6?arguments[6]:void 0,o=s?t:t*Float32Array.BYTES_PER_ELEMENT,l=n?s?n:n*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new ni(this._engine,this,e,this._updatable,!0,l,void 0===r?this._instanced:r,o,i,void 0,void 0,!0,this._divisor||a)}},{key:"isUpdatable",value:function(){return this._updatable}},{key:"getData",value:function(){return this._data}},{key:"getBuffer",value:function(){return this._buffer}},{key:"getStrideSize",value:function(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}},{key:"create",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;!e&&this._buffer||(e=e||this._data)&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e))}},{key:"_rebuild",value:function(){this._buffer=null,this.create(this._data)}},{key:"update",value:function(e){this.create(e)}},{key:"updateDirectly",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,n?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),this._data=0===t&&void 0===i?e:null)}},{key:"_increaseReferences",value:function(){if(this._buffer){if(!this._isAlreadyOwned)return void(this._isAlreadyOwned=!0);this._buffer.references++}}},{key:"dispose",value:function(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)}}]),e}(),ni=function(){function e(t,i,n,r,s,a,o,l,u,h){var c=arguments.length>10&&void 0!==arguments[10]&&arguments[10],d=arguments.length>11&&void 0!==arguments[11]&&arguments[11],f=arguments.length>12&&void 0!==arguments[12]?arguments[12]:1,_=arguments.length>13&&void 0!==arguments[13]&&arguments[13];if((0,m.Z)(this,e),i instanceof ii?(this._buffer=i,this._ownsBuffer=_):(this._buffer=new ii(t,i,r,a,s,o,d),this._ownsBuffer=!0),this.uniqueId=e._Counter++,this._kind=n,null==h){var v=this.getData();this.type=e.FLOAT,v instanceof Int8Array?this.type=e.BYTE:v instanceof Uint8Array?this.type=e.UNSIGNED_BYTE:v instanceof Int16Array?this.type=e.SHORT:v instanceof Uint16Array?this.type=e.UNSIGNED_SHORT:v instanceof Int32Array?this.type=e.INT:v instanceof Uint32Array&&(this.type=e.UNSIGNED_INT)}else this.type=h;var g=e.GetTypeByteLength(this.type);d?(this._size=u||(a?a/g:e.DeduceStride(n)),this.byteStride=a||this._buffer.byteStride||this._size*g,this.byteOffset=l||0):(this._size=u||a||e.DeduceStride(n),this.byteStride=a?a*g:this._buffer.byteStride||this._size*g,this.byteOffset=(l||0)*g),this.normalized=c,this._instanced=void 0!==o&&o,this._instanceDivisor=o?f:0,this._computeHashCode()}return(0,y.Z)(e,[{key:"instanceDivisor",get:function(){return this._instanceDivisor},set:function(e){var t=0!=e;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}},{key:"_computeHashCode",value:function(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}},{key:"_rebuild",value:function(){this._buffer&&this._buffer._rebuild()}},{key:"getKind",value:function(){return this._kind}},{key:"isUpdatable",value:function(){return this._buffer.isUpdatable()}},{key:"getData",value:function(){return this._buffer.getData()}},{key:"getFloatData",value:function(t,i){var n=this.getData();if(!n)return null;var r=this.getSize()*e.GetTypeByteLength(this.type),s=t*this.getSize();if(this.type!==e.FLOAT||this.byteStride!==r){var a=new Float32Array(s);return this.forEach(s,(function(e,t){return a[t]=e})),a}if(!(n instanceof Array||n instanceof Float32Array)||0!==this.byteOffset||n.length!==s){if(n instanceof Array){var o=this.byteOffset/4;return n.slice(o,o+s)}if(n instanceof ArrayBuffer)return new Float32Array(n,this.byteOffset,s);var l=n.byteOffset+this.byteOffset;if(i){var u=new Float32Array(s),h=new Float32Array(n.buffer,l,s);return u.set(h),u}var c=l%4;return c&&(l=Math.max(0,l-c)),new Float32Array(n.buffer,l,s)}return i?n.slice():n}},{key:"getBuffer",value:function(){return this._buffer.getBuffer()}},{key:"getStrideSize",value:function(){return this.byteStride/e.GetTypeByteLength(this.type)}},{key:"getOffset",value:function(){return this.byteOffset/e.GetTypeByteLength(this.type)}},{key:"getSize",value:function(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]?this._size*e.GetTypeByteLength(this.type):this._size}},{key:"getIsInstanced",value:function(){return this._instanced}},{key:"getInstanceDivisor",value:function(){return this._instanceDivisor}},{key:"create",value:function(e){this._buffer.create(e)}},{key:"update",value:function(e){this._buffer.update(e)}},{key:"updateDirectly",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._buffer.updateDirectly(e,t,void 0,i)}},{key:"dispose",value:function(){this._ownsBuffer&&this._buffer.dispose()}},{key:"forEach",value:function(t,i){e.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,t,this.normalized,i)}}],[{key:"DeduceStride",value:function(t){switch(t){case e.UVKind:case e.UV2Kind:case e.UV3Kind:case e.UV4Kind:case e.UV5Kind:case e.UV6Kind:return 2;case e.NormalKind:case e.PositionKind:return 3;case e.ColorKind:case e.MatricesIndicesKind:case e.MatricesIndicesExtraKind:case e.MatricesWeightsKind:case e.MatricesWeightsExtraKind:case e.TangentKind:return 4;default:throw new Error("Invalid kind '"+t+"'")}}},{key:"GetTypeByteLength",value:function(t){switch(t){case e.BYTE:case e.UNSIGNED_BYTE:return 1;case e.SHORT:case e.UNSIGNED_SHORT:return 2;case e.INT:case e.UNSIGNED_INT:case e.FLOAT:return 4;default:throw new Error("Invalid type '".concat(t,"'"))}}},{key:"ForEach",value:function(t,i,n,r,s,a,o,l){if(t instanceof Array)for(var u=i/4,h=n/4,c=0;c<a;c+=r){for(var d=0;d<r;d++)l(t[u+d],c+d);u+=h}else for(var f=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),_=e.GetTypeByteLength(s),v=0;v<a;v+=r){for(var g=i,p=0;p<r;p++){l(e._GetFloatValue(f,s,g,o),v+p),g+=_}i+=n}}},{key:"_GetFloatValue",value:function(t,i,n,r){switch(i){case e.BYTE:var s=t.getInt8(n);return r&&(s=Math.max(s/127,-1)),s;case e.UNSIGNED_BYTE:var a=t.getUint8(n);return r&&(a/=255),a;case e.SHORT:var o=t.getInt16(n,!0);return r&&(o=Math.max(o/32767,-1)),o;case e.UNSIGNED_SHORT:var l=t.getUint16(n,!0);return r&&(l/=65535),l;case e.INT:return t.getInt32(n,!0);case e.UNSIGNED_INT:return t.getUint32(n,!0);case e.FLOAT:return t.getFloat32(n,!0);default:throw new Error("Invalid component type ".concat(i))}}}]),e}();ni._Counter=0,ni.BYTE=5120,ni.UNSIGNED_BYTE=5121,ni.SHORT=5122,ni.UNSIGNED_SHORT=5123,ni.INT=5124,ni.UNSIGNED_INT=5125,ni.FLOAT=5126,ni.PositionKind="position",ni.NormalKind="normal",ni.TangentKind="tangent",ni.UVKind="uv",ni.UV2Kind="uv2",ni.UV3Kind="uv3",ni.UV4Kind="uv4",ni.UV5Kind="uv5",ni.UV6Kind="uv6",ni.ColorKind="color",ni.ColorInstanceKind="instanceColor",ni.MatricesIndicesKind="matricesIndices",ni.MatricesWeightsKind="matricesWeights",ni.MatricesIndicesExtraKind="matricesIndicesExtra",ni.MatricesWeightsExtraKind="matricesWeightsExtra";var ri=function(){function e(){(0,m.Z)(this,e),this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}return(0,y.Z)(e,[{key:"getNormal",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(ni.NormalKind))return null;var i,n=this.pickedMesh.getIndices();if(!n)return null;if(t){var r=this.pickedMesh.getVerticesData(ni.NormalKind),s=z.FromArray(r,3*n[3*this.faceId]),a=z.FromArray(r,3*n[3*this.faceId+1]),o=z.FromArray(r,3*n[3*this.faceId+2]);s=s.scale(this.bu),a=a.scale(this.bv),o=o.scale(1-this.bu-this.bv),i=new z(s.x+a.x+o.x,s.y+a.y+o.y,s.z+a.z+o.z)}else{var l=this.pickedMesh.getVerticesData(ni.PositionKind),u=z.FromArray(l,3*n[3*this.faceId]),h=z.FromArray(l,3*n[3*this.faceId+1]),c=z.FromArray(l,3*n[3*this.faceId+2]),d=u.subtract(h),f=c.subtract(h);i=z.Cross(d,f)}var _=function(e,t){var i=e.getWorldMatrix();e.nonUniformScaling&&(Y.Matrix[0].copyFrom(i),(i=Y.Matrix[0]).setTranslationFromFloats(0,0,0),i.invert(),i.transposeToRef(Y.Matrix[1]),i=Y.Matrix[1]),z.TransformNormalToRef(t,i,t)};if(e&&_(this.pickedMesh,i),this.ray){var v=Y.Vector3[0].copyFrom(i);e||_(this.pickedMesh,v),z.Dot(v,this.ray.direction)>0&&i.negateInPlace()}return i.normalize(),i}},{key:"getTextureCoordinates",value:function(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(ni.UVKind))return null;var e=this.pickedMesh.getIndices();if(!e)return null;var t=this.pickedMesh.getVerticesData(ni.UVKind);if(!t)return null;var i=W.FromArray(t,2*e[3*this.faceId]),n=W.FromArray(t,2*e[3*this.faceId+1]),r=W.FromArray(t,2*e[3*this.faceId+2]);return i=i.scale(this.bu),n=n.scale(this.bv),r=r.scale(1-this.bu-this.bv),new W(i.x+n.x+r.x,i.y+n.y+r.y)}}]),e}(),si=function(){function e(t,i,n,r,s,a){(0,m.Z)(this,e),this.source=t,this.pointerX=i,this.pointerY=n,this.meshUnderPointer=r,this.sourceEvent=s,this.additionalData=a}return(0,y.Z)(e,null,[{key:"CreateNew",value:function(t,i,n){var r=t.getScene();return new e(t,r.pointerX,r.pointerY,r.meshUnderPointer||t,i,n)}},{key:"CreateNewFromSprite",value:function(t,i,n,r){return new e(t,i.pointerX,i.pointerY,i.meshUnderPointer,n,r)}},{key:"CreateNewFromScene",value:function(t,i){return new e(null,t.pointerX,t.pointerY,t.meshUnderPointer,i)}},{key:"CreateNewFromPrimitive",value:function(t,i,n,r){return new e(t,i.x,i.y,null,n,r)}}]),e}(),ai=function(){function e(t){(0,m.Z)(this,e),this._vertexBuffers={},this._scene=t}return(0,y.Z)(e,[{key:"_prepareBuffers",value:function(){if(!this._vertexBuffers[ni.PositionKind]){var e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[ni.PositionKind]=new ni(this._scene.getEngine(),e,ni.PositionKind,!1,!1,2),this._buildIndexBuffer()}}},{key:"_buildIndexBuffer",value:function(){var e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}},{key:"_rebuild",value:function(){var e=this._vertexBuffers[ni.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}},{key:"_prepareFrame",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=this._scene.activeCamera;return!!(i&&(t=t||i._postProcesses.filter((function(e){return null!=e})),t&&0!==t.length&&this._scene.postProcessesEnabled))&&(t[0].activate(i,e,null!=t),!0)}},{key:"directRender",value:function(e){for(var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=this._scene.getEngine(),l=0;l<e.length;l++){l<e.length-1?e[l+1].activate(this._scene.activeCamera,null==i?void 0:i.texture):(i?o.bindFramebuffer(i,r,void 0,void 0,n,s):a||o.restoreDefaultFramebuffer(),null===(t=o._debugInsertMarker)||void 0===t||t.call(o,"post process ".concat(e[l].name," output")));var u=e[l],h=u.apply();h&&(u.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,h),o.drawElementsType(0,0,6),u.onAfterRenderObservable.notifyObservers(h))}o.setDepthBuffer(!0),o.setDepthWrite(!0)}},{key:"_finalizeFrame",value:function(e,t,i,n){var r,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=this._scene.activeCamera;if(a&&(n=n||a._postProcesses.filter((function(e){return null!=e})),0!==n.length&&this._scene.postProcessesEnabled)){for(var o=this._scene.getEngine(),l=0,u=n.length;l<u;l++){var h=n[l];if(l<u-1?h._outputTexture=n[l+1].activate(a,null==t?void 0:t.texture):(t?(o.bindFramebuffer(t,i,void 0,void 0,s),h._outputTexture=t):(o.restoreDefaultFramebuffer(),h._outputTexture=null),null===(r=o._debugInsertMarker)||void 0===r||r.call(o,"post process ".concat(n[l].name," output"))),e)break;var c=h.apply();c&&(h.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,c),o.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(c))}o.setDepthBuffer(!0),o.setDepthWrite(!0),o.setAlphaMode(0)}}},{key:"dispose",value:function(){var e=this._vertexBuffers[ni.PositionKind];e&&(e.dispose(),this._vertexBuffers[ni.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}]),e}(),oi=function(){function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;(0,m.Z)(this,e),this.index=t,this._opaqueSubMeshes=new kt(256),this._transparentSubMeshes=new kt(256),this._alphaTestSubMeshes=new kt(256),this._depthOnlySubMeshes=new kt(256),this._particleSystems=new kt(256),this._spriteManagers=new kt(256),this._empty=!0,this._edgesRenderers=new Dt(16),this._scene=i,this.opaqueSortCompareFn=n,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=s}return(0,y.Z)(e,[{key:"opaqueSortCompareFn",set:function(t){this._opaqueSortCompareFn=t||e.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}},{key:"alphaTestSortCompareFn",set:function(t){this._alphaTestSortCompareFn=t||e.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}},{key:"transparentSortCompareFn",set:function(t){this._transparentSortCompareFn=t||e.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}},{key:"render",value:function(e,t,i,n){if(e)e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);else{var r=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(r.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),r.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);var s=r.getStencilBuffer();if(r.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(n),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length||this._scene.useOrderIndependentTransparency){if(r.setStencilBuffer(s),this._scene.useOrderIndependentTransparency){var a=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);a.length&&this._renderTransparent(a)}else this._renderTransparent(this._transparentSubMeshes);r.setAlphaMode(0)}if(r.setStencilBuffer(!1),this._edgesRenderers.length){for(var o=0;o<this._edgesRenderers.length;o++)this._edgesRenderers.data[o].render();r.setAlphaMode(0)}r.setStencilBuffer(s)}}},{key:"_renderOpaqueSorted",value:function(t){return e._RenderSorted(t,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}},{key:"_renderAlphaTestSorted",value:function(t){return e._RenderSorted(t,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}},{key:"_renderTransparentSorted",value:function(t){return e._RenderSorted(t,this._transparentSortCompareFn,this._scene.activeCamera,!0)}},{key:"prepare",value:function(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}},{key:"prepareSprites",value:function(){this._spriteManagers.reset()}},{key:"dispose",value:function(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}},{key:"dispatch",value:function(e,t,i){void 0===t&&(t=e.getMesh()),void 0===i&&(i=e.getMaterial()),null!=i&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}},{key:"dispatchSprites",value:function(e){this._spriteManagers.push(e),this._empty=!1}},{key:"dispatchParticles",value:function(e){this._particleSystems.push(e),this._empty=!1}},{key:"_renderParticles",value:function(e){if(0!==this._particleSystems.length){var t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(var i=0;i<this._particleSystems.length;i++){var n=this._particleSystems.data[i];if(0!==(t&&t.layerMask&n.layerMask)){var r=n.emitter;(!r.position||!e||-1!==e.indexOf(r))&&this._scene._activeParticles.addCount(n.render(),!1)}}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}}},{key:"_renderSprites",value:function(){if(this._scene.spritesEnabled&&0!==this._spriteManagers.length){var e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(var t=0;t<this._spriteManagers.length;t++){var i=this._spriteManagers.data[t];0!==(e&&e.layerMask&i.layerMask)&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}}],[{key:"_RenderSorted",value:function(t,i,n,r){var s,a=0,o=n?n.globalPosition:e._ZeroVector;if(r)for(;a<t.length;a++)(s=t.data[a])._alphaIndex=s.getMesh().alphaIndex,s._distanceToCamera=z.Distance(s.getBoundingInfo().boundingSphere.centerWorld,o);var l=t.length===t.data.length?t.data:t.data.slice(0,t.length);i&&l.sort(i);var u=l[0].getMesh().getScene();for(a=0;a<l.length;a++)if(s=l[a],!u._activeMeshesFrozenButKeepClipping||s.isInFrustum(u._frustumPlanes)){if(r){var h=s.getMaterial();if(h&&h.needDepthPrePass){var c=h.getScene().getEngine();c.setColorWrite(!1),c.setAlphaMode(0),s.render(!1),c.setColorWrite(!0)}}s.render(r)}}},{key:"defaultTransparentSortCompare",value:function(t,i){return t._alphaIndex>i._alphaIndex?1:t._alphaIndex<i._alphaIndex?-1:e.backToFrontSortCompare(t,i)}},{key:"backToFrontSortCompare",value:function(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}},{key:"frontToBackSortCompare",value:function(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}},{key:"PainterSortCompare",value:function(e,t){var i=e.getMesh(),n=t.getMesh();return i.material&&n.material?i.material.uniqueId-n.material.uniqueId:i.uniqueId-n.uniqueId}}]),e}();oi._ZeroVector=z.Zero();var li=(0,y.Z)((function e(){(0,m.Z)(this,e)})),ui=function(){function e(t){(0,m.Z)(this,e),this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new li,this._maintainStateBetweenFrames=!1,this._scene=t;for(var i=e.MIN_RENDERINGGROUPS;i<e.MAX_RENDERINGGROUPS;i++)this._autoClearDepthStencil[i]={autoClear:!0,depth:!0,stencil:!0}}return(0,y.Z)(e,[{key:"maintainStateBetweenFrames",get:function(){return this._maintainStateBetweenFrames},set:function(e){if(e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,!this._maintainStateBetweenFrames)){var t,i=(0,p.Z)(this._scene.meshes);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(n.subMeshes){var r,s=(0,p.Z)(n.subMeshes);try{for(s.s();!(r=s.n()).done;){r.value._wasDispatched=!1}}catch(h){s.e(h)}finally{s.f()}}}}catch(h){i.e(h)}finally{i.f()}var a,o=(0,p.Z)(this._scene.spriteManagers);try{for(o.s();!(a=o.n()).done;){a.value._wasDispatched=!1}}catch(h){o.e(h)}finally{o.f()}var l,u=(0,p.Z)(this._scene.particleSystems);try{for(u.s();!(l=u.n()).done;){l.value._wasDispatched=!1}}catch(h){u.e(h)}finally{u.f()}}}},{key:"getRenderingGroup",value:function(e){var t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}},{key:"_clearDepthStencilBuffer",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}},{key:"render",value:function(t,i,n,r){var s=this._renderingGroupInfo;if(s.scene=this._scene,s.camera=this._scene.activeCamera,this._scene.spriteManagers&&r)for(var a=0;a<this._scene.spriteManagers.length;a++){var o=this._scene.spriteManagers[a];this.dispatchSprites(o)}for(var l=e.MIN_RENDERINGGROUPS;l<e.MAX_RENDERINGGROUPS;l++){this._depthStencilBufferAlreadyCleaned=l===e.MIN_RENDERINGGROUPS;var u=this._renderingGroups[l];if(u&&!u._empty){var h=Math.pow(2,l);if(s.renderingGroupId=l,this._scene.onBeforeRenderingGroupObservable.notifyObservers(s,h),e.AUTOCLEAR){var c=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(l):this._autoClearDepthStencil[l];c&&c.autoClear&&this._clearDepthStencilBuffer(c.depth,c.stencil)}var d,f=(0,p.Z)(this._scene._beforeRenderingGroupDrawStage);try{for(f.s();!(d=f.n()).done;){d.value.action(l)}}catch(g){f.e(g)}finally{f.f()}u.render(t,r,n,i);var _,v=(0,p.Z)(this._scene._afterRenderingGroupDrawStage);try{for(v.s();!(_=v.n()).done;){_.value.action(l)}}catch(g){v.e(g)}finally{v.f()}this._scene.onAfterRenderingGroupObservable.notifyObservers(s,h)}}}},{key:"reset",value:function(){if(!this.maintainStateBetweenFrames)for(var t=e.MIN_RENDERINGGROUPS;t<e.MAX_RENDERINGGROUPS;t++){var i=this._renderingGroups[t];i&&i.prepare()}}},{key:"resetSprites",value:function(){if(!this.maintainStateBetweenFrames)for(var t=e.MIN_RENDERINGGROUPS;t<e.MAX_RENDERINGGROUPS;t++){var i=this._renderingGroups[t];i&&i.prepareSprites()}}},{key:"dispose",value:function(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}},{key:"freeRenderingGroups",value:function(){for(var t=e.MIN_RENDERINGGROUPS;t<e.MAX_RENDERINGGROUPS;t++){var i=this._renderingGroups[t];i&&i.dispose()}}},{key:"_prepareRenderingGroup",value:function(e){void 0===this._renderingGroups[e]&&(this._renderingGroups[e]=new oi(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}},{key:"dispatchSprites",value:function(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}},{key:"dispatchParticles",value:function(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}},{key:"dispatch",value:function(e,t,i){void 0===t&&(t=e.getMesh()),(!this.maintainStateBetweenFrames||!e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}},{key:"setRenderingOrder",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=n,this._renderingGroups[e]){var r=this._renderingGroups[e];r.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],r.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],r.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}},{key:"setRenderingAutoClearDepthStencil",value:function(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:n}}},{key:"getAutoClearDepthStencilSetup",value:function(e){return this._autoClearDepthStencil[e]}}]),e}();ui.MAX_RENDERINGGROUPS=4,ui.MIN_RENDERINGGROUPS=0,ui.AUTOCLEAR=!0;var hi=(0,y.Z)((function e(){(0,m.Z)(this,e)}));hi.NAME_EFFECTLAYER="EffectLayer",hi.NAME_LAYER="Layer",hi.NAME_LENSFLARESYSTEM="LensFlareSystem",hi.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",hi.NAME_PARTICLESYSTEM="ParticleSystem",hi.NAME_GAMEPAD="Gamepad",hi.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",hi.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",hi.NAME_PREPASSRENDERER="PrePassRenderer",hi.NAME_DEPTHRENDERER="DepthRenderer",hi.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",hi.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",hi.NAME_SPRITE="Sprite",hi.NAME_SUBSURFACE="SubSurface",hi.NAME_OUTLINERENDERER="Outline",hi.NAME_PROCEDURALTEXTURE="ProceduralTexture",hi.NAME_SHADOWGENERATOR="ShadowGenerator",hi.NAME_OCTREE="Octree",hi.NAME_PHYSICSENGINE="PhysicsEngine",hi.NAME_AUDIO="Audio",hi.NAME_FLUIDRENDERER="FluidRenderer",hi.STEP_ISREADYFORMESH_EFFECTLAYER=0,hi.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,hi.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,hi.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,hi.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,hi.STEP_BEFORECAMERADRAW_PREPASS=0,hi.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,hi.STEP_BEFORECAMERADRAW_LAYER=2,hi.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,hi.STEP_BEFORERENDERTARGETDRAW_LAYER=1,hi.STEP_BEFORERENDERINGMESH_PREPASS=0,hi.STEP_BEFORERENDERINGMESH_OUTLINE=1,hi.STEP_AFTERRENDERINGMESH_PREPASS=0,hi.STEP_AFTERRENDERINGMESH_OUTLINE=1,hi.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,hi.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,hi.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,hi.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,hi.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,hi.STEP_BEFORECLEAR_PREPASS=1,hi.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,hi.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,hi.STEP_AFTERRENDERTARGETDRAW_LAYER=1,hi.STEP_AFTERCAMERADRAW_PREPASS=0,hi.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,hi.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,hi.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,hi.STEP_AFTERCAMERADRAW_LAYER=4,hi.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,hi.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,hi.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,hi.STEP_AFTERRENDER_AUDIO=0,hi.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,hi.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,hi.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,hi.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,hi.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,hi.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,hi.STEP_POINTERMOVE_SPRITE=0,hi.STEP_POINTERDOWN_SPRITE=0,hi.STEP_POINTERUP_SPRITE=0;var ci=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e){return(0,m.Z)(this,i),t.call.apply(t,[this].concat((0,s.Z)(e)))}return(0,y.Z)(i,[{key:"registerStep",value:function(e,t,i){var n=0;for(Number.MAX_VALUE;n<this.length&&!(e<this[n].index);n++);this.splice(n,0,{index:e,component:t,action:i.bind(t)})}},{key:"clear",value:function(){this.length=0}}],[{key:"Create",value:function(){return Object.create(i.prototype)}}]),i}((0,o.Z)(Array)),di=(0,y.Z)((function e(){(0,m.Z)(this,e)}));di.POINTERDOWN=1,di.POINTERUP=2,di.POINTERMOVE=4,di.POINTERWHEEL=8,di.POINTERPICK=16,di.POINTERTAP=32,di.POINTERDOUBLETAP=64;var fi=(0,y.Z)((function e(t,i){(0,m.Z)(this,e),this.type=t,this.event=i})),_i=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r,s){var a;return(0,m.Z)(this,i),(a=t.call(this,e,n)).ray=null,a.originalPickingInfo=null,a.skipOnPointerObservable=!1,a.localPosition=new W(r,s),a}return(0,y.Z)(i)}(fi),vi=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r){var s,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return(0,m.Z)(this,i),(s=t.call(this,e,n))._pickInfo=r,s._inputManager=a,s}return(0,y.Z)(i,[{key:"pickInfo",get:function(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}},{key:"_generatePickInfo",value:function(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event.pointerId),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}]),i}(fi),gi=function(){function e(){(0,m.Z)(this,e),this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}return(0,y.Z)(e,null,[{key:"HasTriggers",get:function(){for(var t in e.Triggers)if(Object.prototype.hasOwnProperty.call(e.Triggers,t))return!0;return!1}},{key:"HasPickTriggers",get:function(){for(var t in e.Triggers)if(Object.prototype.hasOwnProperty.call(e.Triggers,t)){var i=parseInt(t);if(i>=1&&i<=7)return!0}return!1}},{key:"HasSpecificTrigger",value:function(t){for(var i in e.Triggers)if(Object.prototype.hasOwnProperty.call(e.Triggers,i)&&parseInt(i)===t)return!0;return!1}}]),e}();gi.Triggers={};var pi=(0,y.Z)((function e(){(0,m.Z)(this,e)}));pi.KEYDOWN=1,pi.KEYUP=2;var mi,yi,Ti,Ei,Si,bi,xi,Mi,Ai=(0,y.Z)((function e(t,i){(0,m.Z)(this,e),this.type=t,this.event=i})),Ri=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r;return(0,m.Z)(this,i),(r=t.call(this,e,n)).type=e,r.event=n,r.skipOnKeyboardObservable=!1,r}return(0,y.Z)(i,[{key:"skipOnPointerObservable",get:function(){return this.skipOnKeyboardObservable},set:function(e){this.skipOnKeyboardObservable=e}}]),i}(Ai);!function(e){e[e.Generic=0]="Generic",e[e.Keyboard=1]="Keyboard",e[e.Mouse=2]="Mouse",e[e.Touch=3]="Touch",e[e.DualShock=4]="DualShock",e[e.Xbox=5]="Xbox",e[e.Switch=6]="Switch",e[e.DualSense=7]="DualSense"}(mi||(mi={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.Move=12]="Move"}(yi||(yi={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.DeltaHorizontal=10]="DeltaHorizontal",e[e.DeltaVertical=11]="DeltaVertical"}(Ti||(Ti={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(Ei||(Ei={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Create=8]="Create",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(Si||(Si={})),function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.LT=6]="LT",e[e.RT=7]="RT",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.LStickXAxis=17]="LStickXAxis",e[e.LStickYAxis=18]="LStickYAxis",e[e.RStickXAxis=19]="RStickXAxis",e[e.RStickYAxis=20]="RStickYAxis"}(bi||(bi={})),function(e){e[e.B=0]="B",e[e.A=1]="A",e[e.Y=2]="Y",e[e.X=3]="X",e[e.L=4]="L",e[e.R=5]="R",e[e.ZL=6]="ZL",e[e.ZR=7]="ZR",e[e.Minus=8]="Minus",e[e.Plus=9]="Plus",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.Capture=17]="Capture",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(xi||(xi={})),function(e){e[e.PointerMove=0]="PointerMove",e[e.PointerDown=1]="PointerDown",e[e.PointerUp=2]="PointerUp"}(Mi||(Mi={}));var Ci=(0,y.Z)((function e(){(0,m.Z)(this,e)}));Ci.DOM_DELTA_PIXEL=0,Ci.DOM_DELTA_LINE=1,Ci.DOM_DELTA_PAGE=2;var Ii=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"CreateDeviceEvent",value:function(e,t,i,n,r,s){switch(e){case mi.Keyboard:return this._CreateKeyboardEvent(i,n,r,s);case mi.Mouse:if(i===yi.MouseWheelX||i===yi.MouseWheelY||i===yi.MouseWheelZ)return this._CreateWheelEvent(e,t,i,n,r,s);case mi.Touch:return this._CreatePointerEvent(e,t,i,n,r,s);default:throw"Unable to generate event for device ".concat(mi[e])}}},{key:"_CreatePointerEvent",value:function(e,t,i,n,r,s){var a=this._CreateMouseEvent(e,t,i,n,r,s);return e===mi.Mouse?(a.deviceType=mi.Mouse,a.pointerId=1,a.pointerType="mouse"):(a.deviceType=mi.Touch,a.pointerId=t,a.pointerType="touch"),i===yi.Move?a.type="pointermove":i>=yi.LeftClick&&i<=yi.RightClick&&(a.type=1===n?"pointerdown":"pointerup",a.button=i-2),a}},{key:"_CreateWheelEvent",value:function(e,t,i,n,r,s){var a=this._CreateMouseEvent(e,t,i,n,r,s);switch(a.type="wheel",a.deltaMode=Ci.DOM_DELTA_PIXEL,a.deltaX=0,a.deltaY=0,a.deltaZ=0,i){case yi.MouseWheelX:a.deltaX=n;break;case yi.MouseWheelY:a.deltaY=n;break;case yi.MouseWheelZ:a.deltaZ=n}return a}},{key:"_CreateMouseEvent",value:function(e,t,i,n,r,s){var a=this._CreateEvent(s),o=r.pollInput(e,t,yi.Horizontal),l=r.pollInput(e,t,yi.Vertical);return s?(a.movementX=0,a.movementY=0,a.offsetX=a.movementX-s.getBoundingClientRect().x,a.offsetY=a.movementY-s.getBoundingClientRect().y):(a.movementX=r.pollInput(e,t,Ti.DeltaHorizontal),a.movementY=r.pollInput(e,t,Ti.DeltaVertical),a.offsetX=0,a.offsetY=0),this._CheckNonCharacterKeys(a,r),a.clientX=o,a.clientY=l,a.x=o,a.y=l,a.deviceType=e,a.deviceSlot=t,a.inputIndex=i,a}},{key:"_CreateKeyboardEvent",value:function(e,t,i,n){var r=this._CreateEvent(n);return this._CheckNonCharacterKeys(r,i),r.deviceType=mi.Keyboard,r.deviceSlot=0,r.inputIndex=e,r.type=1===t?"keydown":"keyup",r.key=String.fromCharCode(e),r.keyCode=e,r}},{key:"_CheckNonCharacterKeys",value:function(e,t){var i=t.isDeviceAvailable(mi.Keyboard),n=i&&1===t.pollInput(mi.Keyboard,0,18),r=i&&1===t.pollInput(mi.Keyboard,0,17),s=i&&(1===t.pollInput(mi.Keyboard,0,91)||1===t.pollInput(mi.Keyboard,0,92)||1===t.pollInput(mi.Keyboard,0,93)),a=i&&1===t.pollInput(mi.Keyboard,0,16);e.altKey=n,e.ctrlKey=r,e.metaKey=s,e.shiftKey=a}},{key:"_CreateEvent",value:function(e){var t={preventDefault:function(){}};return t.target=e,t}}]),e}(),Pi=function(){function e(t,i,n){var r=this;(0,m.Z)(this,e),this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(t,i,(function(e,t,i,s){var a=Ii.CreateDeviceEvent(e,t,i,s,r);n(e,t,a)})):this._createDummyNativeInput()}return(0,y.Z)(e,[{key:"pollInput",value:function(e,t,i){return this._nativeInput.pollInput(e,t,i)}},{key:"isDeviceAvailable",value:function(e){return e===mi.Mouse||e===mi.Touch}},{key:"dispose",value:function(){this._nativeInput.dispose()}},{key:"_createDummyNativeInput",value:function(){return{pollInput:function(){return 0},isDeviceAvailable:function(){return!1},dispose:function(){}}}}]),e}(),ki=Object.keys(yi).length/2,Di=function(){function e(t,i,n,r){var s=this;(0,m.Z)(this,e),this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=It.IsSafari(),this._usingMacOS=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=function(e){},this._keyboardUpEvent=function(e){},this._keyboardBlurEvent=function(e){},this._pointerMoveEvent=function(e){},this._pointerDownEvent=function(e){},this._pointerUpEvent=function(e){},this._pointerCancelEvent=function(e){},this._pointerWheelEvent=function(e){},this._pointerBlurEvent=function(e){},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=oe.IsNavigatorAvailable()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=function(e){},this._gamepadDisconnectedEvent=function(e){},this._eventPrefix=It.GetPointerPrefix(t),this._engine=t,this._onDeviceConnected=i,this._onDeviceDisconnected=n,this._onInputChanged=r,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=function(){s._enableEvents()})}return(0,y.Z)(e,[{key:"pollInput",value:function(e,t,i){var n=this._inputs[e][t];if(!n)throw"Unable to find device ".concat(mi[e]);e>=mi.DualShock&&e<=mi.DualSense&&this._updateDevice(e,t,i);var r=n[i];if(void 0===r)throw"Unable to find input ".concat(i," for device ").concat(mi[e]," in slot ").concat(t);return i===yi.Move&&It.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),r}},{key:"isDeviceAvailable",value:function(e){return void 0!==this._inputs[e]}},{key:"dispose",value:function(){this._onDeviceConnected=function(){},this._onDeviceDisconnected=function(){},this._onInputChanged=function(){},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}},{key:"_enableEvents",value:function(){var e=null===this||void 0===this?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){var t,i=(0,p.Z)(this._inputs);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(n)for(var r in n){var s=n[+r];if(s)for(var a=0;a<s.length;a++)s[a]=0}}}catch(o){i.e(o)}finally{i.f()}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}},{key:"_disableEvents",value:function(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}},{key:"_checkForConnectedDevices",value:function(){if(navigator.getGamepads){var e,t=navigator.getGamepads(),i=(0,p.Z)(t);try{for(i.s();!(e=i.n()).done;){var n=e.value;n&&this._addGamePad(n)}}catch(r){i.e(r)}finally{i.f()}}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(mi.Mouse,0,0,0)}},{key:"_addGamePad",value:function(e){var t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}},{key:"_addPointerDevice",value:function(e,t,i,n){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,ki);var r=this._inputs[e][t];r[0]=i,r[1]=n}},{key:"_registerDevice",value:function(e,t,i){if(void 0===t)throw"Unable to register device ".concat(mi[e]," to undefined slot.");if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){var n=new Array(i);n.fill(0),this._inputs[e][t]=n,this._onDeviceConnected(e,t)}}},{key:"_unregisterDevice",value:function(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}},{key:"_handleKeyActions",value:function(){var e=this;this._keyboardDownEvent=function(t){e._keyboardActive||(e._keyboardActive=!0,e._registerDevice(mi.Keyboard,0,255));var i=e._inputs[mi.Keyboard][0];if(i){i[t.keyCode]=1;var n=t;n.inputIndex=t.keyCode,e._usingMacOS&&t.metaKey&&"Meta"!==t.key&&(e._metaKeys.includes(t.keyCode)||e._metaKeys.push(t.keyCode)),e._onInputChanged(mi.Keyboard,0,n)}},this._keyboardUpEvent=function(t){e._keyboardActive||(e._keyboardActive=!0,e._registerDevice(mi.Keyboard,0,255));var i=e._inputs[mi.Keyboard][0];if(i){i[t.keyCode]=0;var n=t;if(n.inputIndex=t.keyCode,e._usingMacOS&&"Meta"===t.key&&e._metaKeys.length>0){var r,s=(0,p.Z)(e._metaKeys);try{for(s.s();!(r=s.n()).done;){var a=r.value,o=Ii.CreateDeviceEvent(mi.Keyboard,0,a,0,e,e._elementToAttachTo);i[a]=0,e._onInputChanged(mi.Keyboard,0,o)}}catch(l){s.e(l)}finally{s.f()}e._metaKeys.splice(0,e._metaKeys.length)}e._onInputChanged(mi.Keyboard,0,n)}},this._keyboardBlurEvent=function(){if(e._keyboardActive){for(var t=e._inputs[mi.Keyboard][0],i=0;i<t.length;i++)if(0!==t[i]){t[i]=0;var n=Ii.CreateDeviceEvent(mi.Keyboard,0,i,0,e,e._elementToAttachTo);e._onInputChanged(mi.Keyboard,0,n)}e._usingMacOS&&e._metaKeys.splice(0,e._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}},{key:"_handlePointerActions",value:function(){var e=this;this._maxTouchPoints=oe.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(var t=0;t<this._maxTouchPoints;t++)this._activeTouchIds[t]=-1;this._pointerMoveEvent=function(t){var i=e._getPointerType(t),n=i===mi.Mouse?0:e._activeTouchIds.indexOf(t.pointerId);e._inputs[i]||(e._inputs[i]={}),e._inputs[i][n]||e._addPointerDevice(i,n,t.clientX,t.clientY);var r=e._inputs[i][n];if(r){var s=t;s.inputIndex=yi.Move,r[yi.Horizontal]=t.clientX,r[yi.Vertical]=t.clientY,e._onInputChanged(i,n,s),!e._usingSafari&&-1!==t.button&&(s.inputIndex=t.button+2,r[t.button+2]=r[t.button+2]?0:1,e._onInputChanged(i,n,s))}},this._pointerDownEvent=function(t){var i=e._getPointerType(t),n=i===mi.Mouse?0:t.pointerId;if(i===mi.Touch){var r=e._activeTouchIds.indexOf(-1);if(!(r>=0))return void It.Warn("Max number of touches exceeded.  Ignoring touches in excess of ".concat(e._maxTouchPoints));n=r,e._activeTouchIds[r]=t.pointerId}e._inputs[i]||(e._inputs[i]={}),e._inputs[i][n]?i===mi.Touch&&e._onDeviceConnected(i,n):e._addPointerDevice(i,n,t.clientX,t.clientY);var s=e._inputs[i][n];if(s){var a=s[yi.Horizontal],o=s[yi.Vertical];if(i===mi.Mouse){if(-1===e._mouseId&&(void 0===t.pointerId?e._mouseId=e._isUsingFirefox?0:1:e._mouseId=t.pointerId),!document.pointerLockElement)try{e._elementToAttachTo.setPointerCapture(e._mouseId)}catch(u){}}else if(t.pointerId&&!document.pointerLockElement)try{e._elementToAttachTo.setPointerCapture(t.pointerId)}catch(h){}s[yi.Horizontal]=t.clientX,s[yi.Vertical]=t.clientY,s[t.button+2]=1;var l=t;l.inputIndex=t.button+2,e._onInputChanged(i,n,l),(a!==t.clientX||o!==t.clientY)&&(l.inputIndex=yi.Move,e._onInputChanged(i,n,l))}},this._pointerUpEvent=function(t){var i,n,r,s,a,o=e._getPointerType(t),l=o===mi.Mouse?0:e._activeTouchIds.indexOf(t.pointerId);if(o===mi.Touch){if(-1===l)return;e._activeTouchIds[l]=-1}var u=null===(i=e._inputs[o])||void 0===i?void 0:i[l];if(u&&0!==u[t.button+2]){var h=u[yi.Horizontal],c=u[yi.Vertical];u[yi.Horizontal]=t.clientX,u[yi.Vertical]=t.clientY,u[t.button+2]=0;var d=t;(h!==t.clientX||c!==t.clientY)&&(d.inputIndex=yi.Move,e._onInputChanged(o,l,d)),d.inputIndex=t.button+2,o===mi.Mouse&&e._mouseId>=0&&null!==(r=(n=e._elementToAttachTo).hasPointerCapture)&&void 0!==r&&r.call(n,e._mouseId)?e._elementToAttachTo.releasePointerCapture(e._mouseId):t.pointerId&&!(null===(a=(s=e._elementToAttachTo).hasPointerCapture)||void 0===a)&&a.call(s,t.pointerId)&&e._elementToAttachTo.releasePointerCapture(t.pointerId),e._onInputChanged(o,l,d),o===mi.Touch&&e._onDeviceDisconnected(o,l)}},this._pointerCancelEvent=function(t){var i,n,r,s;if("mouse"===t.pointerType){var a=e._inputs[mi.Mouse][0];e._mouseId>=0&&null!==(n=(i=e._elementToAttachTo).hasPointerCapture)&&void 0!==n&&n.call(i,e._mouseId)&&e._elementToAttachTo.releasePointerCapture(e._mouseId);for(var o=yi.LeftClick;o<=yi.BrowserForward;o++)if(1===a[o]){a[o]=0;var l=Ii.CreateDeviceEvent(mi.Mouse,0,o,0,e,e._elementToAttachTo);e._onInputChanged(mi.Mouse,0,l)}}else{var u=e._activeTouchIds.indexOf(t.pointerId);!(null===(s=(r=e._elementToAttachTo).hasPointerCapture)||void 0===s)&&s.call(r,t.pointerId)&&e._elementToAttachTo.releasePointerCapture(t.pointerId),e._inputs[mi.Touch][u][yi.LeftClick]=0;var h=Ii.CreateDeviceEvent(mi.Touch,u,yi.LeftClick,0,e,e._elementToAttachTo);e._onInputChanged(mi.Touch,u,h),e._activeTouchIds[u]=-1,e._onDeviceDisconnected(mi.Touch,u)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";var i=!1,n=function(){};try{var r=Object.defineProperty({},"passive",{get:function(){i=!0}});this._elementToAttachTo.addEventListener("test",n,r),this._elementToAttachTo.removeEventListener("test",n,r)}catch(s){}this._pointerBlurEvent=function(){var t,i,n,r,s;if(e.isDeviceAvailable(mi.Mouse)){var a=e._inputs[mi.Mouse][0];e._mouseId>=0&&null!==(i=(t=e._elementToAttachTo).hasPointerCapture)&&void 0!==i&&i.call(t,e._mouseId)&&e._elementToAttachTo.releasePointerCapture(e._mouseId);for(var o=yi.LeftClick;o<=yi.BrowserForward;o++)if(1===a[o]){a[o]=0;var l=Ii.CreateDeviceEvent(mi.Mouse,0,o,0,e,e._elementToAttachTo);e._onInputChanged(mi.Mouse,0,l)}}if(e.isDeviceAvailable(mi.Touch))for(var u=e._inputs[mi.Touch],h=0;h<e._activeTouchIds.length;h++){var c=e._activeTouchIds[h];if(!(null===(r=(n=e._elementToAttachTo).hasPointerCapture)||void 0===r)&&r.call(n,c)&&e._elementToAttachTo.releasePointerCapture(c),-1!==c&&1===(null===(s=u[h])||void 0===s?void 0:s[yi.LeftClick])){u[h][yi.LeftClick]=0;var d=Ii.CreateDeviceEvent(mi.Touch,h,yi.LeftClick,0,e,e._elementToAttachTo);e._onInputChanged(mi.Touch,h,d),e._activeTouchIds[h]=-1,e._onDeviceDisconnected(mi.Touch,h)}}},this._pointerWheelEvent=function(t){var i=mi.Mouse;e._inputs[i]||(e._inputs[i]=[]),e._inputs[i][0]||(e._pointerActive=!0,e._registerDevice(i,0,ki));var n=e._inputs[i][0];if(n){n[yi.MouseWheelX]=t.deltaX||0,n[yi.MouseWheelY]=t.deltaY||t.wheelDelta||0,n[yi.MouseWheelZ]=t.deltaZ||0;var r=t;0!==n[yi.MouseWheelX]&&(r.inputIndex=yi.MouseWheelX,e._onInputChanged(i,0,r)),0!==n[yi.MouseWheelY]&&(r.inputIndex=yi.MouseWheelY,e._onInputChanged(i,0,r)),0!==n[yi.MouseWheelZ]&&(r.inputIndex=yi.MouseWheelZ,e._onInputChanged(i,0,r))}},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!i&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add((function(){if(e.isDeviceAvailable(mi.Mouse)){var t=e._inputs[mi.Mouse][0];t[yi.MouseWheelX]=0,t[yi.MouseWheelY]=0,t[yi.MouseWheelZ]=0}}))}},{key:"_handleGamepadActions",value:function(){var e=this;this._gamepadConnectedEvent=function(t){e._addGamePad(t.gamepad)},this._gamepadDisconnectedEvent=function(t){if(e._gamepads){var i=e._getGamepadDeviceType(t.gamepad.id),n=t.gamepad.index;e._unregisterDevice(i,n),delete e._gamepads[n]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}},{key:"_updateDevice",value:function(e,t,i){var n=navigator.getGamepads()[t];if(n&&e===this._gamepads[t]){var r=this._inputs[e][t];i>=n.buttons.length?r[i]=n.axes[i-n.buttons.length].valueOf():r[i]=n.buttons[i].value}}},{key:"_getGamepadDeviceType",value:function(e){return-1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?mi.DualSense:mi.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?mi.Xbox:-1!==e.indexOf("057e")?mi.Switch:mi.Generic}},{key:"_getPointerType",value:function(e){var t=mi.Mouse;return("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=mi.Touch),t}}]),e}(),Fi=function(){function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;(0,m.Z)(this,e),this.deviceType=i,this.deviceSlot=n,this.onInputChangedObservable=new ee,this._deviceInputSystem=t}return(0,y.Z)(e,[{key:"getInput",value:function(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}]),e}(),wi=function(){function e(t){var i=this;(0,m.Z)(this,e),this._registeredManagers=new Array,this._refCount=0,this.registerManager=function(e){for(var t=0;t<i._devices.length;t++){var n=i._devices[t];for(var r in n){var s=+r;e._addDevice(new Fi(i._deviceInputSystem,t,s))}}i._registeredManagers.push(e)},this.unregisterManager=function(e){var t=i._registeredManagers.indexOf(e);t>-1&&i._registeredManagers.splice(t,1)};var n=Object.keys(mi).length/2;this._devices=new Array(n);var r=function(e,t){i._devices[e]||(i._devices[e]=new Array),i._devices[e][t]||(i._devices[e][t]=t);var n,r=(0,p.Z)(i._registeredManagers);try{for(r.s();!(n=r.n()).done;){var s=n.value,a=new Fi(i._deviceInputSystem,e,t);s._addDevice(a)}}catch(o){r.e(o)}finally{r.f()}},s=function(e,t){var n;null!==(n=i._devices[e])&&void 0!==n&&n[t]&&delete i._devices[e][t];var r,s=(0,p.Z)(i._registeredManagers);try{for(s.s();!(r=s.n()).done;){r.value._removeDevice(e,t)}}catch(a){s.e(a)}finally{s.f()}},a=function(e,t,n){if(n){var r,s=(0,p.Z)(i._registeredManagers);try{for(s.s();!(r=s.n()).done;){r.value._onInputChanged(e,t,n)}}catch(a){s.e(a)}finally{s.f()}}};typeof _native<"u"?this._deviceInputSystem=new Pi(r,s,a):this._deviceInputSystem=new Di(t,r,s,a)}return(0,y.Z)(e,[{key:"dispose",value:function(){this._deviceInputSystem.dispose()}}]),e}(),Oi=function(){function e(t){var i=this;(0,m.Z)(this,e);var n=Object.keys(mi).length/2;this._devices=new Array(n),this._firstDevice=new Array(n),this._engine=t,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new wi(t)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new ee((function(e){var t,n=(0,p.Z)(i._devices);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r){var s,a=(0,p.Z)(r);try{for(a.s();!(s=a.n()).done;){var o=s.value;o&&i.onDeviceConnectedObservable.notifyObserver(e,o)}}catch(l){a.e(l)}finally{a.f()}}}}catch(l){n.e(l)}finally{n.f()}})),this.onDeviceDisconnectedObservable=new ee,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=t.onDisposeObservable.add((function(){i.dispose()}))}return(0,y.Z)(e,[{key:"getDeviceSource",value:function(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e]}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null}},{key:"getDeviceSources",value:function(e){return this._devices[e]?this._devices[e].filter((function(e){return!!e})):[]}},{key:"dispose",value:function(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}},{key:"_addDevice",value:function(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}},{key:"_removeDevice",value:function(e,t){var i,n,r=null===(i=this._devices[e])||void 0===i?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(r),!(null===(n=this._devices[e])||void 0===n)&&n[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}},{key:"_onInputChanged",value:function(e,t,i){var n,r;null===(r=null===(n=this._devices[e])||void 0===n?void 0:n[t])||void 0===r||r.onInputChangedObservable.notifyObservers(i)}},{key:"_updateFirstDevices",value:function(e){switch(e){case mi.Keyboard:case mi.Mouse:this._firstDevice[e]=0;break;case mi.Touch:case mi.DualSense:case mi.DualShock:case mi.Xbox:case mi.Switch:case mi.Generic:delete this._firstDevice[e];var t=this._devices[e];if(t)for(var i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}}}]),e}(),Li=function(){function e(){(0,m.Z)(this,e),this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}return(0,y.Z)(e,[{key:"singleClick",get:function(){return this._singleClick},set:function(e){this._singleClick=e}},{key:"doubleClick",get:function(){return this._doubleClick},set:function(e){this._doubleClick=e}},{key:"hasSwiped",get:function(){return this._hasSwiped},set:function(e){this._hasSwiped=e}},{key:"ignore",get:function(){return this._ignore},set:function(e){this._ignore=e}}]),e}(),Ni=function(){function e(t){(0,m.Z)(this,e),this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new W(0,0),this._previousStartingPointerPosition=new W(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._deviceSourceManager=null,this._scene=t||V.LastCreatedScene,this._scene}return(0,y.Z)(e,[{key:"meshUnderPointer",get:function(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}},{key:"getMeshUnderPointerByPointerId",value:function(e){return this._meshUnderPointerId[e]||null}},{key:"unTranslatedPointer",get:function(){return new W(this._unTranslatedPointerX,this._unTranslatedPointerY)}},{key:"pointerX",get:function(){return this._pointerX},set:function(e){this._pointerX=e}},{key:"pointerY",get:function(){return this._pointerY},set:function(e){this._pointerY=e}},{key:"_updatePointerPosition",value:function(e){var t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}},{key:"_processPointerMove",value:function(e,t){var i=this._scene,n=i.getEngine(),r=n.getInputElement();r&&(r.tabIndex=n.canvasTabIndex,i.doNotHandleCursors||(r.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t.pointerId,i);var s,a=(0,p.Z)(i._pointerMoveStage);try{for(a.s();!(s=a.n()).done;){var o=s.value,l=!(null==e||!e.pickedMesh);e=o.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,l,r)}}catch(c){a.e(c)}finally{a.f()}var u,h=t.inputIndex>=yi.MouseWheelX&&t.inputIndex<=yi.MouseWheelZ?di.POINTERWHEEL:di.POINTERMOVE;i.onPointerMove&&(e=e||this._pickMove(t.pointerId),i.onPointerMove(t,e,h)),e?(u=new vi(h,t,e),this._setRayOnPointerInfo(e,t)):(u=new vi(h,t,null,this),this._movePointerInfo=u),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(u,h)}},{key:"_setRayOnPointerInfo",value:function(e,t){var i=this._scene;e&&i._pickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,Z.Identity(),i.activeCamera)))}},{key:"_addCameraPointerObserver",value:function(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}},{key:"_removeCameraPointerObserver",value:function(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}},{key:"_checkForPicking",value:function(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}},{key:"_checkPrePointerObservable",value:function(e,t,i){var n=this._scene,r=new _i(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(r.originalPickingInfo=e,r.ray=e.ray,e.originMesh&&(r.nearInteractionPickingInfo=e)),n.onPrePointerObservable.notifyObservers(r,i),!!r.skipOnPointerObservable}},{key:"_pickMove",value:function(e){var t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,!1,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}},{key:"_setCursorAndPointerOverMesh",value:function(e,t,i){var n=i.getEngine().getInputElement();if(null!=e&&e.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t,e),!i.doNotHandleCursors&&n&&this._pointerOverMesh){var r=this._pointerOverMesh._getActionManagerForTrigger();r&&r.hasPointerTriggers&&(n.style.cursor=r.hoverCursor||i.hoverCursor)}}else this.setPointerOverMesh(null,t,e)}},{key:"simulatePointerMove",value:function(e,t){var i=new PointerEvent("pointermove",t);i.inputIndex=yi.Move,!this._checkPrePointerObservable(e,i,di.POINTERMOVE)&&this._processPointerMove(e,i)}},{key:"simulatePointerDown",value:function(e,t){var i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,!this._checkPrePointerObservable(e,i,di.POINTERDOWN)&&this._processPointerDown(e,i)}},{key:"_processPointerDown",value:function(t,i){var n,r=this,s=this._scene;if(null!=t&&t.pickedMesh){this._pickedDownMesh=t.pickedMesh;var a=t.pickedMesh._getActionManagerForTrigger();if(a){if(a.hasPickTriggers)switch(a.processTrigger(5,si.CreateNew(t.pickedMesh,i)),i.button){case 0:a.processTrigger(2,si.CreateNew(t.pickedMesh,i));break;case 1:a.processTrigger(4,si.CreateNew(t.pickedMesh,i));break;case 2:a.processTrigger(3,si.CreateNew(t.pickedMesh,i))}a.hasSpecificTrigger(8)&&window.setTimeout((function(){var t=s.pick(r._unTranslatedPointerX,r._unTranslatedPointerY,(function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.actionManager&&e.actionManager.hasSpecificTrigger(8)&&e===r._pickedDownMesh}),!1,s.cameraToUseForPointers);null!=t&&t.pickedMesh&&a&&0!==r._totalPointersPressed&&Date.now()-r._startingPointerTime>e.LongPressDelay&&!r._isPointerSwiping()&&(r._startingPointerTime=0,a.processTrigger(8,si.CreateNew(t.pickedMesh,i)))}),e.LongPressDelay)}}else{var o,l=(0,p.Z)(s._pointerDownStage);try{for(l.s();!(o=l.n()).done;){t=o.value.action(this._unTranslatedPointerX,this._unTranslatedPointerY,t,i,!1)}}catch(h){l.e(h)}finally{l.f()}}var u=di.POINTERDOWN;t?(s.onPointerDown&&s.onPointerDown(i,t,u),n=new vi(u,i,t),this._setRayOnPointerInfo(t,i)):n=new vi(u,i,null,this),s.onPointerObservable.hasObservers()&&s.onPointerObservable.notifyObservers(n,u)}},{key:"_isPointerSwiping",value:function(){return this._isSwiping}},{key:"simulatePointerUp",value:function(e,t,i){var n=new PointerEvent("pointerup",t);n.inputIndex=yi.Move;var r=new Li;i?r.doubleClick=!0:r.singleClick=!0,!this._checkPrePointerObservable(e,n,di.POINTERUP)&&this._processPointerUp(e,n,r)}},{key:"_processPointerUp",value:function(e,t,i){var n=this._scene;if(null!=e&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(n.onPointerPick&&n.onPointerPick(t,e),i.singleClick&&!i.ignore&&n.onPointerObservable.observers.length>this._cameraObserverCount)){var r=di.POINTERPICK,s=new vi(r,t,e);this._setRayOnPointerInfo(e,t),n.onPointerObservable.notifyObservers(s,r)}var a=e.pickedMesh._getActionManagerForTrigger();if(a&&!i.ignore){a.processTrigger(7,si.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&a.processTrigger(1,si.CreateNew(e.pickedMesh,t,e));var o=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&o&&o.processTrigger(6,si.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore){var l,u=(0,p.Z)(n._pointerUpStage);try{for(u.s();!(l=u.n()).done;){e=l.value.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick)}}catch(_){u.e(_)}finally{u.f()}}if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){var h=this._pickedDownMesh._getActionManagerForTrigger(16);h&&h.processTrigger(16,si.CreateNew(this._pickedDownMesh,t))}if(!i.ignore){var c=new vi(di.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),n.onPointerObservable.notifyObservers(c,di.POINTERUP),n.onPointerUp&&n.onPointerUp(t,e,di.POINTERUP),!i.hasSwiped&&!this._skipPointerTap){var d=0;if(i.singleClick?d=di.POINTERTAP:i.doubleClick&&(d=di.POINTERDOUBLETAP),d){var f=new vi(d,t,e);n.onPointerObservable.hasObservers()&&n.onPointerObservable.hasSpecificMask(d)&&n.onPointerObservable.notifyObservers(f,d)}}}}},{key:"isPointerCaptured",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._pointerCaptures[e]}},{key:"attachControl",value:function(){var t=this,i=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=this._scene,o=a.getEngine();s||(s=o.getInputElement()),this._alreadyAttached&&this.detachControl(),s&&(this._alreadyAttachedTo=s),this._deviceSourceManager=new Oi(o),this._initActionManager=function(e){if(!t._meshPickProceed){var i=a.skipPointerUpPicking||0===a._registeredActions&&!t._checkForPicking()&&!a.onPointerUp?null:a.pick(t._unTranslatedPointerX,t._unTranslatedPointerY,a.pointerUpPredicate,!1,a.cameraToUseForPointers);t._currentPickResult=i,i&&(e=i.hit&&i.pickedMesh?i.pickedMesh._getActionManagerForTrigger():null),t._meshPickProceed=!0}return e},this._delayedSimpleClick=function(i,n,r){(Date.now()-t._previousStartingPointerTime>e.DoubleClickDelay&&!t._doubleClickOccured||i!==t._previousButtonPressed)&&(t._doubleClickOccured=!1,n.singleClick=!0,n.ignore=!1,r(n,t._currentPickResult))},this._initClickEvent=function(i,n,r,s){var a=new Li;t._currentPickResult=null;var o=null,l=i.hasSpecificMask(di.POINTERPICK)||n.hasSpecificMask(di.POINTERPICK)||i.hasSpecificMask(di.POINTERTAP)||n.hasSpecificMask(di.POINTERTAP)||i.hasSpecificMask(di.POINTERDOUBLETAP)||n.hasSpecificMask(di.POINTERDOUBLETAP);!l&&gi&&((o=t._initActionManager(o,a))&&(l=o.hasPickTriggers));var u=!1;if(l){var h=r.button;if(a.hasSwiped=t._isPointerSwiping(),!a.hasSwiped){var c=!e.ExclusiveDoubleClickMode;c||(c=!i.hasSpecificMask(di.POINTERDOUBLETAP)&&!n.hasSpecificMask(di.POINTERDOUBLETAP))&&!gi.HasSpecificTrigger(6)&&((o=t._initActionManager(o,a))&&(c=!o.hasSpecificTrigger(6))),c?(Date.now()-t._previousStartingPointerTime>e.DoubleClickDelay||h!==t._previousButtonPressed)&&(a.singleClick=!0,s(a,t._currentPickResult),u=!0):(t._previousDelayedSimpleClickTimeout=t._delayedSimpleClickTimeout,t._delayedSimpleClickTimeout=window.setTimeout(t._delayedSimpleClick.bind(t,h,a,s),e.DoubleClickDelay));var d=i.hasSpecificMask(di.POINTERDOUBLETAP)||n.hasSpecificMask(di.POINTERDOUBLETAP);!d&&gi.HasSpecificTrigger(6)&&((o=t._initActionManager(o,a))&&(d=o.hasSpecificTrigger(6))),d&&(h===t._previousButtonPressed&&Date.now()-t._previousStartingPointerTime<e.DoubleClickDelay&&!t._doubleClickOccured?(a.hasSwiped||t._isPointerSwiping()?(t._doubleClickOccured=!1,t._previousStartingPointerTime=t._startingPointerTime,t._previousStartingPointerPosition.x=t._startingPointerPosition.x,t._previousStartingPointerPosition.y=t._startingPointerPosition.y,t._previousButtonPressed=h,e.ExclusiveDoubleClickMode?(t._previousDelayedSimpleClickTimeout&&clearTimeout(t._previousDelayedSimpleClickTimeout),t._previousDelayedSimpleClickTimeout=t._delayedSimpleClickTimeout,s(a,t._previousPickResult)):s(a,t._currentPickResult)):(t._previousStartingPointerTime=0,t._doubleClickOccured=!0,a.doubleClick=!0,a.ignore=!1,e.ExclusiveDoubleClickMode&&t._previousDelayedSimpleClickTimeout&&clearTimeout(t._previousDelayedSimpleClickTimeout),t._previousDelayedSimpleClickTimeout=t._delayedSimpleClickTimeout,s(a,t._currentPickResult)),u=!0):(t._doubleClickOccured=!1,t._previousStartingPointerTime=t._startingPointerTime,t._previousStartingPointerPosition.x=t._startingPointerPosition.x,t._previousStartingPointerPosition.y=t._startingPointerPosition.y,t._previousButtonPressed=h))}}u||s(a,t._currentPickResult)},this._onPointerMove=function(i){if(void 0===i.pointerId&&(i.pointerId=0),t._updatePointerPosition(i),!t._isSwiping&&-1!==t._swipeButtonPressed&&(t._isSwiping=Math.abs(t._startingPointerPosition.x-t._pointerX)>e.DragMovementThreshold||Math.abs(t._startingPointerPosition.y-t._pointerY)>e.DragMovementThreshold),!t._checkPrePointerObservable(null,i,i.inputIndex>=yi.MouseWheelX&&i.inputIndex<=yi.MouseWheelZ?di.POINTERWHEEL:di.POINTERMOVE)&&(a.cameraToUseForPointers||a.activeCamera))if(a.skipPointerMovePicking)t._processPointerMove(new ri,i);else{a.pointerMovePredicate||(a.pointerMovePredicate=function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(e.enablePointerMoveEvents||a.constantlyUpdateMeshUnderPointer||null!==e._getActionManagerForTrigger())&&(!a.cameraToUseForPointers||0!==(a.cameraToUseForPointers.layerMask&e.layerMask))});var n=a._registeredActions>0?t._pickMove(i.pointerId):null;t._processPointerMove(n,i)}},this._onPointerDown=function(e){var i;(t._totalPointersPressed++,t._pickedDownMesh=null,t._meshPickProceed=!1,void 0===e.pointerId&&(e.pointerId=0),t._updatePointerPosition(e),-1===t._swipeButtonPressed&&(t._swipeButtonPressed=e.button),a.preventDefaultOnPointerDown&&s&&(e.preventDefault(),s.focus()),t._startingPointerPosition.x=t._pointerX,t._startingPointerPosition.y=t._pointerY,t._startingPointerTime=Date.now(),t._checkPrePointerObservable(null,e,di.POINTERDOWN)||!a.cameraToUseForPointers&&!a.activeCamera)||(t._pointerCaptures[e.pointerId]=!0,a.pointerDownPredicate||(a.pointerDownPredicate=function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!a.cameraToUseForPointers||0!==(a.cameraToUseForPointers.layerMask&e.layerMask))}),t._pickedDownMesh=null,i=a.skipPointerDownPicking||0===a._registeredActions&&!t._checkForPicking()&&!a.onPointerDown?new ri:a.pick(t._unTranslatedPointerX,t._unTranslatedPointerY,a.pointerDownPredicate,!1,a.cameraToUseForPointers),t._processPointerDown(i,e))},this._onPointerUp=function(e){0!==t._totalPointersPressed&&(t._totalPointersPressed--,t._pickedUpMesh=null,t._meshPickProceed=!1,void 0===e.pointerId&&(e.pointerId=0),t._updatePointerPosition(e),a.preventDefaultOnPointerUp&&s&&(e.preventDefault(),s.focus()),t._initClickEvent(a.onPrePointerObservable,a.onPointerObservable,e,(function(i,n){if(a.onPrePointerObservable.hasObservers()&&(t._skipPointerTap=!1,!i.ignore)){if(t._checkPrePointerObservable(null,e,di.POINTERUP))return void(t._swipeButtonPressed===e.button&&(t._isSwiping=!1,t._swipeButtonPressed=-1));i.hasSwiped||(i.singleClick&&a.onPrePointerObservable.hasSpecificMask(di.POINTERTAP)&&t._checkPrePointerObservable(null,e,di.POINTERTAP)&&(t._skipPointerTap=!0),i.doubleClick&&a.onPrePointerObservable.hasSpecificMask(di.POINTERDOUBLETAP)&&t._checkPrePointerObservable(null,e,di.POINTERDOUBLETAP)&&(t._skipPointerTap=!0))}t._pointerCaptures[e.pointerId]=!1,(a.cameraToUseForPointers||a.activeCamera)&&(a.pointerUpPredicate||(a.pointerUpPredicate=function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!a.cameraToUseForPointers||0!==(a.cameraToUseForPointers.layerMask&e.layerMask))}),!t._meshPickProceed&&(gi&&gi.HasTriggers||t._checkForPicking()||a.onPointerUp)&&t._initActionManager(null,i),n||(n=t._currentPickResult),t._processPointerUp(n,e,i),t._previousPickResult=t._currentPickResult,t._swipeButtonPressed===e.button&&(t._isSwiping=!1,t._swipeButtonPressed=-1))})))},this._onKeyDown=function(e){var t=pi.KEYDOWN;if(a.onPreKeyboardObservable.hasObservers()){var i=new Ri(t,e);if(a.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}if(a.onKeyboardObservable.hasObservers()){var n=new Ai(t,e);a.onKeyboardObservable.notifyObservers(n,t)}a.actionManager&&a.actionManager.processTrigger(14,si.CreateNewFromScene(a,e))},this._onKeyUp=function(e){var t=pi.KEYUP;if(a.onPreKeyboardObservable.hasObservers()){var i=new Ri(t,e);if(a.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}if(a.onKeyboardObservable.hasObservers()){var n=new Ai(t,e);a.onKeyboardObservable.notifyObservers(n,t)}a.actionManager&&a.actionManager.processTrigger(15,si.CreateNewFromScene(a,e))},this._deviceSourceManager.onDeviceConnectedObservable.add((function(e){e.deviceType===mi.Mouse?e.onInputChangedObservable.add((function(s){s.inputIndex===yi.LeftClick||s.inputIndex===yi.MiddleClick||s.inputIndex===yi.RightClick||s.inputIndex===yi.BrowserBack||s.inputIndex===yi.BrowserForward?n&&1===e.getInput(s.inputIndex)?t._onPointerDown(s):i&&0===e.getInput(s.inputIndex)&&t._onPointerUp(s):r&&(s.inputIndex===yi.Move||s.inputIndex===yi.MouseWheelX||s.inputIndex===yi.MouseWheelY||s.inputIndex===yi.MouseWheelZ)&&t._onPointerMove(s)})):e.deviceType===mi.Touch?e.onInputChangedObservable.add((function(s){s.inputIndex===yi.LeftClick&&(n&&1===e.getInput(s.inputIndex)?t._onPointerDown(s):i&&0===e.getInput(s.inputIndex)&&t._onPointerUp(s)),r&&s.inputIndex===yi.Move&&t._onPointerMove(s)})):e.deviceType===mi.Keyboard&&e.onInputChangedObservable.add((function(e){"keydown"===e.type?t._onKeyDown(e):"keyup"===e.type&&t._onKeyUp(e)}))})),this._alreadyAttached=!0}},{key:"detachControl",value:function(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}},{key:"setPointerOverMesh",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(this._meshUnderPointerId[t]!==e||e&&e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting){var n,r=this._meshUnderPointerId[t];r&&((n=r._getActionManagerForTrigger(10))&&n.processTrigger(10,si.CreateNew(r,void 0,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,(n=e._getActionManagerForTrigger(9))&&n.processTrigger(9,si.CreateNew(e,void 0,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}}},{key:"getPointerOverMesh",value:function(){return this.meshUnderPointer}},{key:"_invalidateMesh",value:function(e){for(var t in this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null),this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}}]),e}();Ni.DragMovementThreshold=10,Ni.LongPressDelay=500,Ni.DoubleClickDelay=300,Ni.ExclusiveDoubleClickMode=!1;var Bi=function(){function e(t,i,n,r){(0,m.Z)(this,e),this.normal=new z(t,i,n),this.d=r}return(0,y.Z)(e,[{key:"asArray",value:function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}},{key:"clone",value:function(){return new e(this.normal.x,this.normal.y,this.normal.z,this.d)}},{key:"getClassName",value:function(){return"Plane"}},{key:"getHashCode",value:function(){var e=this.normal.getHashCode();return e=397*e^(0|this.d)}},{key:"normalize",value:function(){var e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),t=0;return 0!==e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}},{key:"transform",value:function(t){var i=e._TmpMatrix;t.invertToRef(i);var n=i.m,r=this.normal.x,s=this.normal.y,a=this.normal.z,o=this.d;return new e(r*n[0]+s*n[1]+a*n[2]+o*n[3],r*n[4]+s*n[5]+a*n[6]+o*n[7],r*n[8]+s*n[9]+a*n[10]+o*n[11],r*n[12]+s*n[13]+a*n[14]+o*n[15])}},{key:"dotCoordinate",value:function(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}},{key:"copyFromPoints",value:function(e,t,i){var n,r=t.x-e.x,s=t.y-e.y,a=t.z-e.z,o=i.x-e.x,l=i.y-e.y,u=i.z-e.z,h=s*u-a*l,c=a*o-r*u,d=r*l-s*o,f=Math.sqrt(h*h+c*c+d*d);return n=0!==f?1/f:0,this.normal.x=h*n,this.normal.y=c*n,this.normal.z=d*n,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}},{key:"isFrontFacingTo",value:function(e,t){return z.Dot(this.normal,e)<=t}},{key:"signedDistanceTo",value:function(e){return z.Dot(e,this.normal)+this.d}}],[{key:"FromArray",value:function(t){return new e(t[0],t[1],t[2],t[3])}},{key:"FromPoints",value:function(t,i,n){var r=new e(0,0,0,0);return r.copyFromPoints(t,i,n),r}},{key:"FromPositionAndNormal",value:function(t,i){var n=new e(0,0,0,0);return i.normalize(),n.normal=i,n.d=-(i.x*t.x+i.y*t.y+i.z*t.z),n}},{key:"SignedDistanceToPlaneFromPositionAndNormal",value:function(e,t,i){var n=-(t.x*e.x+t.y*e.y+t.z*e.z);return z.Dot(i,t)+n}}]),e}();Bi._TmpMatrix=Z.Identity();var Ui=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"GetPlanes",value:function(t){for(var i=[],n=0;n<6;n++)i.push(new Bi(0,0,0,0));return e.GetPlanesToRef(t,i),i}},{key:"GetNearPlaneToRef",value:function(e,t){var i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}},{key:"GetFarPlaneToRef",value:function(e,t){var i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}},{key:"GetLeftPlaneToRef",value:function(e,t){var i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}},{key:"GetRightPlaneToRef",value:function(e,t){var i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}},{key:"GetTopPlaneToRef",value:function(e,t){var i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}},{key:"GetBottomPlaneToRef",value:function(e,t){var i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}},{key:"GetPlanesToRef",value:function(t,i){e.GetNearPlaneToRef(t,i[0]),e.GetFarPlaneToRef(t,i[1]),e.GetLeftPlaneToRef(t,i[2]),e.GetRightPlaneToRef(t,i[3]),e.GetTopPlaneToRef(t,i[4]),e.GetBottomPlaneToRef(t,i[5])}}]),e}(),Vi=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"UniqueId",get:function(){var e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}]),e}();Vi._UniqueIdCounter=1;var Gi,Wi=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"CompareLightsPriority",value:function(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}]),e}();Wi.FALLOFF_DEFAULT=0,Wi.FALLOFF_PHYSICAL=1,Wi.FALLOFF_GLTF=2,Wi.FALLOFF_STANDARD=3,Wi.LIGHTMAP_DEFAULT=0,Wi.LIGHTMAP_SPECULAR=1,Wi.LIGHTMAP_SHADOWSONLY=2,Wi.INTENSITYMODE_AUTOMATIC=0,Wi.INTENSITYMODE_LUMINOUSPOWER=1,Wi.INTENSITYMODE_LUMINOUSINTENSITY=2,Wi.INTENSITYMODE_ILLUMINANCE=3,Wi.INTENSITYMODE_LUMINANCE=4,Wi.LIGHTTYPEID_POINTLIGHT=0,Wi.LIGHTTYPEID_DIRECTIONALLIGHT=1,Wi.LIGHTTYPEID_SPOTLIGHT=2,Wi.LIGHTTYPEID_HEMISPHERICLIGHT=3,function(e){e[e.BackwardCompatible=0]="BackwardCompatible",e[e.Intermediate=1]="Intermediate",e[e.Aggressive=2]="Aggressive"}(Gi||(Gi={}));var zi=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r;(0,m.Z)(this,i),(r=t.call(this))._inputManager=new Ni((0,u.Z)(r)),r.cameraToUseForPointers=null,r._isScene=!0,r._blockEntityCollection=!1,r.autoClear=!0,r.autoClearDepthAndStencil=!0,r.clearColor=new Ke(.2,.2,.3,1),r.ambientColor=new Ze(0,0,0),r.environmentIntensity=1,r._performancePriority=Gi.BackwardCompatible,r._forceWireframe=!1,r._skipFrustumClipping=!1,r._forcePointsCloud=!1,r.animationsEnabled=!0,r._animationPropertiesOverride=null,r.useConstantAnimationDeltaTime=!1,r.constantlyUpdateMeshUnderPointer=!1,r.hoverCursor="pointer",r.defaultCursor="",r.doNotHandleCursors=!1,r.preventDefaultOnPointerDown=!0,r.preventDefaultOnPointerUp=!0,r.metadata=null,r.reservedDataStore=null,r.disableOfflineSupportExceptionRules=new Array,r.onDisposeObservable=new ee,r._onDisposeObserver=null,r.onBeforeRenderObservable=new ee,r._onBeforeRenderObserver=null,r.onAfterRenderObservable=new ee,r.onAfterRenderCameraObservable=new ee,r._onAfterRenderObserver=null,r.onBeforeAnimationsObservable=new ee,r.onAfterAnimationsObservable=new ee,r.onBeforeDrawPhaseObservable=new ee,r.onAfterDrawPhaseObservable=new ee,r.onReadyObservable=new ee,r.onBeforeCameraRenderObservable=new ee,r._onBeforeCameraRenderObserver=null,r.onAfterCameraRenderObservable=new ee,r._onAfterCameraRenderObserver=null,r.onBeforeActiveMeshesEvaluationObservable=new ee,r.onAfterActiveMeshesEvaluationObservable=new ee,r.onBeforeParticlesRenderingObservable=new ee,r.onAfterParticlesRenderingObservable=new ee,r.onDataLoadedObservable=new ee,r.onNewCameraAddedObservable=new ee,r.onCameraRemovedObservable=new ee,r.onNewLightAddedObservable=new ee,r.onLightRemovedObservable=new ee,r.onNewGeometryAddedObservable=new ee,r.onGeometryRemovedObservable=new ee,r.onNewTransformNodeAddedObservable=new ee,r.onTransformNodeRemovedObservable=new ee,r.onNewMeshAddedObservable=new ee,r.onMeshRemovedObservable=new ee,r.onNewSkeletonAddedObservable=new ee,r.onSkeletonRemovedObservable=new ee,r.onNewMaterialAddedObservable=new ee,r.onNewMultiMaterialAddedObservable=new ee,r.onMaterialRemovedObservable=new ee,r.onMultiMaterialRemovedObservable=new ee,r.onNewTextureAddedObservable=new ee,r.onTextureRemovedObservable=new ee,r.onBeforeRenderTargetsRenderObservable=new ee,r.onAfterRenderTargetsRenderObservable=new ee,r.onBeforeStepObservable=new ee,r.onAfterStepObservable=new ee,r.onActiveCameraChanged=new ee,r.onActiveCamerasChanged=new ee,r.onBeforeRenderingGroupObservable=new ee,r.onAfterRenderingGroupObservable=new ee,r.onMeshImportedObservable=new ee,r.onAnimationFileImportedObservable=new ee,r._registeredForLateAnimationBindings=new Dt(256),r.skipPointerMovePicking=!1,r.skipPointerDownPicking=!1,r.skipPointerUpPicking=!1,r.onPrePointerObservable=new ee,r.onPointerObservable=new ee,r.onPreKeyboardObservable=new ee,r.onKeyboardObservable=new ee,r._useRightHandedSystem=!1,r._timeAccumulator=0,r._currentStepId=0,r._currentInternalStep=0,r._fogEnabled=!0,r._fogMode=i.FOGMODE_NONE,r.fogColor=new Ze(.2,.2,.3),r.fogDensity=.1,r.fogStart=0,r.fogEnd=1e3,r.needsPreviousWorldMatrices=!1,r._shadowsEnabled=!0,r._lightsEnabled=!0,r._unObserveActiveCameras=null,r._texturesEnabled=!0,r.physicsEnabled=!0,r.particlesEnabled=!0,r.spritesEnabled=!0,r._skeletonsEnabled=!0,r.lensFlaresEnabled=!0,r.collisionsEnabled=!0,r.gravity=new z(0,-9.807,0),r.postProcessesEnabled=!0,r.renderTargetsEnabled=!0,r.dumpNextRenderTargets=!1,r.customRenderTargets=new Array,r.importedMeshesFiles=new Array,r.probesEnabled=!0,r._meshesForIntersections=new Dt(256),r.proceduralTexturesEnabled=!0,r._totalVertices=new ze,r._activeIndices=new ze,r._activeParticles=new ze,r._activeBones=new ze,r._animationTime=0,r.animationTimeScale=1,r._renderId=0,r._frameId=0,r._executeWhenReadyTimeoutId=null,r._intermediateRendering=!1,r._defaultFrameBufferCleared=!1,r._viewUpdateFlag=-1,r._projectionUpdateFlag=-1,r._toBeDisposed=new Array(256),r._activeRequests=new Array,r._pendingData=new Array,r._isDisposed=!1,r.dispatchAllSubMeshesOfActiveMeshes=!1,r._activeMeshes=new kt(256),r._processedMaterials=new kt(256),r._renderTargets=new Dt(256),r._materialsRenderTargets=new Dt(256),r._activeParticleSystems=new kt(256),r._activeSkeletons=new Dt(32),r._softwareSkinnedMeshes=new Dt(32),r._activeAnimatables=new Array,r._transformMatrix=Z.Zero(),r.requireLightSorting=!1,r._components=[],r._serializableComponents=[],r._transientComponents=[],r._beforeCameraUpdateStage=ci.Create(),r._beforeClearStage=ci.Create(),r._beforeRenderTargetClearStage=ci.Create(),r._gatherRenderTargetsStage=ci.Create(),r._gatherActiveCameraRenderTargetsStage=ci.Create(),r._isReadyForMeshStage=ci.Create(),r._beforeEvaluateActiveMeshStage=ci.Create(),r._evaluateSubMeshStage=ci.Create(),r._preActiveMeshStage=ci.Create(),r._cameraDrawRenderTargetStage=ci.Create(),r._beforeCameraDrawStage=ci.Create(),r._beforeRenderTargetDrawStage=ci.Create(),r._beforeRenderingGroupDrawStage=ci.Create(),r._beforeRenderingMeshStage=ci.Create(),r._afterRenderingMeshStage=ci.Create(),r._afterRenderingGroupDrawStage=ci.Create(),r._afterCameraDrawStage=ci.Create(),r._afterCameraPostProcessStage=ci.Create(),r._afterRenderTargetDrawStage=ci.Create(),r._afterRenderTargetPostProcessStage=ci.Create(),r._afterRenderStage=ci.Create(),r._pointerMoveStage=ci.Create(),r._pointerDownStage=ci.Create(),r._pointerUpStage=ci.Create(),r._geometriesByUniqueId=null,r._defaultMeshCandidates={data:[],length:0},r._defaultSubMeshCandidates={data:[],length:0},r._preventFreeActiveMeshesAndRenderingGroups=!1,r._activeMeshesFrozen=!1,r._activeMeshesFrozenButKeepClipping=!1,r._skipEvaluateActiveMeshesCompletely=!1,r._allowPostProcessClearColor=!0,r.getDeterministicFrameTime=function(){return r._engine.getTimeStep()},r._registeredActions=0,r._blockMaterialDirtyMechanism=!1,r._perfCollector=null,r.activeCameras=new Array;var s=(0,a.Z)({useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1},n);return r._engine=e||V.LastCreatedEngine,s.virtual?r._engine._virtualScenes.push((0,u.Z)(r)):(V._LastCreatedScene=(0,u.Z)(r),r._engine.scenes.push((0,u.Z)(r))),r._uid=null,r._renderingManager=new ui((0,u.Z)(r)),ai&&(r.postProcessManager=new ai((0,u.Z)(r))),ne()&&r.attachControl(),r._createUbo(),ei&&(r._imageProcessingConfiguration=new ei),r.setDefaultCandidateProviders(),s.useGeometryUniqueIdsMap&&(r._geometriesByUniqueId={}),r.useMaterialMeshMap=s.useMaterialMeshMap,r.useClonedMeshMap=s.useClonedMeshMap,(!n||!n.virtual)&&r._engine.onNewSceneAddedObservable.notifyObservers((0,u.Z)(r)),r}return(0,y.Z)(i,[{key:"environmentTexture",get:function(){return this._environmentTexture},set:function(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}},{key:"imageProcessingConfiguration",get:function(){return this._imageProcessingConfiguration}},{key:"performancePriority",get:function(){return this._performancePriority},set:function(e){if(e!==this._performancePriority)switch(this._performancePriority=e,e){case Gi.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case Gi.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case Gi.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1}}},{key:"forceWireframe",get:function(){return this._forceWireframe},set:function(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}},{key:"skipFrustumClipping",get:function(){return this._skipFrustumClipping},set:function(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}},{key:"forcePointsCloud",get:function(){return this._forcePointsCloud},set:function(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}},{key:"animationPropertiesOverride",get:function(){return this._animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e}},{key:"onDispose",set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}},{key:"beforeRender",set:function(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}},{key:"afterRender",set:function(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}},{key:"beforeCameraRender",set:function(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}},{key:"afterCameraRender",set:function(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}},{key:"unTranslatedPointer",get:function(){return this._inputManager.unTranslatedPointer}},{key:"bindEyePosition",value:function(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"vEyePosition",n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:null!==(t=this.activeCamera.globalPosition)&&void 0!==t?t:this.activeCamera.devicePosition,s=this.useRightHandedSystem===(null!=this._mirroredCameraPosition);return Y.Vector4[0].set(r.x,r.y,r.z,s?-1:1),e&&(n?e.setFloat3(i,Y.Vector4[0].x,Y.Vector4[0].y,Y.Vector4[0].z):e.setVector4(i,Y.Vector4[0])),Y.Vector4[0]}},{key:"finalizeSceneUbo",value:function(){var e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}},{key:"useRightHandedSystem",get:function(){return this._useRightHandedSystem},set:function(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}},{key:"setStepId",value:function(e){this._currentStepId=e}},{key:"getStepId",value:function(){return this._currentStepId}},{key:"getInternalStep",value:function(){return this._currentInternalStep}},{key:"fogEnabled",get:function(){return this._fogEnabled},set:function(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}},{key:"fogMode",get:function(){return this._fogMode},set:function(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}},{key:"prePass",get:function(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}},{key:"shadowsEnabled",get:function(){return this._shadowsEnabled},set:function(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}},{key:"lightsEnabled",get:function(){return this._lightsEnabled},set:function(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}},{key:"activeCameras",get:function(){return this._activeCameras},set:function(e){var t=this;this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=O(e,(function(){t.onActiveCamerasChanged.notifyObservers(t)}))),this._activeCameras=e}},{key:"activeCamera",get:function(){return this._activeCamera},set:function(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}},{key:"defaultMaterial",get:function(){return this._defaultMaterial||(this._defaultMaterial=i.DefaultMaterialFactory(this)),this._defaultMaterial},set:function(e){this._defaultMaterial=e}},{key:"texturesEnabled",get:function(){return this._texturesEnabled},set:function(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}},{key:"skeletonsEnabled",get:function(){return this._skeletonsEnabled},set:function(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}},{key:"collisionCoordinator",get:function(){return this._collisionCoordinator||(this._collisionCoordinator=i.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}},{key:"renderingManager",get:function(){return this._renderingManager}},{key:"frustumPlanes",get:function(){return this._frustumPlanes}},{key:"_registerTransientComponents",value:function(){if(this._transientComponents.length>0){var e,t=(0,p.Z)(this._transientComponents);try{for(t.s();!(e=t.n()).done;){e.value.register()}}catch(i){t.e(i)}finally{t.f()}this._transientComponents.length=0}}},{key:"_addComponent",value:function(e){this._components.push(e),this._transientComponents.push(e);var t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}},{key:"_getComponent",value:function(e){var t,i=(0,p.Z)(this._components);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(n.name===e)return n}}catch(r){i.e(r)}finally{i.f()}return null}},{key:"getClassName",value:function(){return"Scene"}},{key:"_getDefaultMeshCandidates",value:function(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}},{key:"_getDefaultSubMeshCandidates",value:function(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}},{key:"setDefaultCandidateProviders",value:function(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)}},{key:"meshUnderPointer",get:function(){return this._inputManager.meshUnderPointer}},{key:"pointerX",get:function(){return this._inputManager.pointerX},set:function(e){this._inputManager.pointerX=e}},{key:"pointerY",get:function(){return this._inputManager.pointerY},set:function(e){this._inputManager.pointerY=e}},{key:"getCachedMaterial",value:function(){return this._cachedMaterial}},{key:"getCachedEffect",value:function(){return this._cachedEffect}},{key:"getCachedVisibility",value:function(){return this._cachedVisibility}},{key:"isCachedMaterialInvalid",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}},{key:"getEngine",value:function(){return this._engine}},{key:"getTotalVertices",value:function(){return this._totalVertices.current}},{key:"totalVerticesPerfCounter",get:function(){return this._totalVertices}},{key:"getActiveIndices",value:function(){return this._activeIndices.current}},{key:"totalActiveIndicesPerfCounter",get:function(){return this._activeIndices}},{key:"getActiveParticles",value:function(){return this._activeParticles.current}},{key:"activeParticlesPerfCounter",get:function(){return this._activeParticles}},{key:"getActiveBones",value:function(){return this._activeBones.current}},{key:"activeBonesPerfCounter",get:function(){return this._activeBones}},{key:"getActiveMeshes",value:function(){return this._activeMeshes}},{key:"getAnimationRatio",value:function(){return void 0!==this._animationRatio?this._animationRatio:1}},{key:"getRenderId",value:function(){return this._renderId}},{key:"getFrameId",value:function(){return this._frameId}},{key:"incrementRenderId",value:function(){this._renderId++}},{key:"_createUbo",value:function(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}},{key:"simulatePointerMove",value:function(e,t){return this._inputManager.simulatePointerMove(e,t),this}},{key:"simulatePointerDown",value:function(e,t){return this._inputManager.simulatePointerDown(e,t),this}},{key:"simulatePointerUp",value:function(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}},{key:"isPointerCaptured",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._inputManager.isPointerCaptured(e)}},{key:"attachControl",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._inputManager.attachControl(e,t,i)}},{key:"detachControl",value:function(){this._inputManager.detachControl()}},{key:"isReady",value:function(){var e,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._isDisposed)return!1;var i=this.getEngine(),n=!0;for(this._pendingData.length>0&&(n=!1),t&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),e=0;e<this.meshes.length;e++){var r=this.meshes[e];if(r.subMeshes&&0!==r.subMeshes.length)if(r.isReady(!0)){var s,a=r.hasThinInstances||"InstancedMesh"===r.getClassName()||"InstancedLinesMesh"===r.getClassName()||i.getCaps().instancedArrays&&r.instances.length>0,o=(0,p.Z)(this._isReadyForMeshStage);try{for(o.s();!(s=o.n()).done;){s.value.action(r,a)||(n=!1)}}catch(g){o.e(g)}finally{o.f()}if(t){var l=r.material||this.defaultMaterial;if(l)if(l._storeEffectOnSubMeshes){var u,h=(0,p.Z)(r.subMeshes);try{for(h.s();!(u=h.n()).done;){var c=u.value.getMaterial();c&&c.hasRenderTargetTextures&&null!=c.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(c)&&(this._processedMaterials.push(c),this._materialsRenderTargets.concatWithNoDuplicate(c.getRenderTargetTextures()))}}catch(g){h.e(g)}finally{h.f()}}else l.hasRenderTargetTextures&&null!=l.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(l)&&(this._processedMaterials.push(l),this._materialsRenderTargets.concatWithNoDuplicate(l.getRenderTargetTextures()))}}else n=!1}if(!n||!i.areAllEffectsReady())return!1;if(t)for(e=0;e<this._materialsRenderTargets.length;++e)if(!this._materialsRenderTargets.data[e].isReadyForRendering())return!1;for(e=0;e<this.geometries.length;e++)if(2===this.geometries[e].delayLoadState)return!1;if(this.activeCameras&&this.activeCameras.length>0){var d,f=(0,p.Z)(this.activeCameras);try{for(f.s();!(d=f.n()).done;){if(!d.value.isReady(!0))return!1}}catch(g){f.e(g)}finally{f.f()}}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;var _,v=(0,p.Z)(this.particleSystems);try{for(v.s();!(_=v.n()).done;){if(!_.value.isReady())return!1}}catch(g){v.e(g)}finally{v.f()}return!0}},{key:"resetCachedMaterial",value:function(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}},{key:"registerBeforeRender",value:function(e){this.onBeforeRenderObservable.add(e)}},{key:"unregisterBeforeRender",value:function(e){this.onBeforeRenderObservable.removeCallback(e)}},{key:"registerAfterRender",value:function(e){this.onAfterRenderObservable.add(e)}},{key:"unregisterAfterRender",value:function(e){this.onAfterRenderObservable.removeCallback(e)}},{key:"_executeOnceBeforeRender",value:function(e){var t=this;this.registerBeforeRender((function i(){e(),setTimeout((function(){t.unregisterBeforeRender(i)}))}))}},{key:"executeOnceBeforeRender",value:function(e,t){var i=this;void 0!==t?setTimeout((function(){i._executeOnceBeforeRender(e)}),t):this._executeOnceBeforeRender(e)}},{key:"addPendingData",value:function(e){this._pendingData.push(e)}},{key:"removePendingData",value:function(e){var t=this.isLoading,i=this._pendingData.indexOf(e);-1!==i&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}},{key:"getWaitingItemsCount",value:function(){return this._pendingData.length}},{key:"isLoading",get:function(){return this._pendingData.length>0}},{key:"executeWhenReady",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.onReadyObservable.addOnce(e),null===this._executeWhenReadyTimeoutId&&this._checkIsReady(t)}},{key:"whenReadyAsync",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return new Promise((function(i){e.executeWhenReady((function(){i()}),t)}))}},{key:"_checkIsReady",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._registerTransientComponents(),this.isReady(t)?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):this._isDisposed?(this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):void(this._executeWhenReadyTimeoutId=setTimeout((function(){e.incrementRenderId(),e._checkIsReady(t)}),100))}},{key:"animatables",get:function(){return this._activeAnimatables}},{key:"resetLastAnimationTimeFrame",value:function(){this._animationTimeLast=Be.Now}},{key:"getViewMatrix",value:function(){return this._viewMatrix}},{key:"getProjectionMatrix",value:function(){return this._projectionMatrix}},{key:"getTransformMatrix",value:function(){return this._transformMatrix}},{key:"setTransformMatrix",value:function(e,t,i,n){!i&&!n&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),(this._viewUpdateFlag!==e.updateFlag||this._projectionUpdateFlag!==t.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?Ui.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Ui.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,n):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}},{key:"getSceneUniformBuffer",value:function(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}},{key:"createSceneUniformBuffer",value:function(e){var t=new ti(this._engine,void 0,!1,null!==e&&void 0!==e?e:"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}},{key:"setSceneUniformBuffer",value:function(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}},{key:"getUniqueId",value:function(){return Vi.UniqueId}},{key:"addMesh",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),i&&e.getChildMeshes().forEach((function(e){t.addMesh(e)})))}},{key:"removeMesh",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.meshes.indexOf(e);return-1!==n&&(this.meshes[n]=this.meshes[this.meshes.length-1],this.meshes.pop(),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),i&&e.getChildMeshes().forEach((function(e){t.removeMesh(e)})),n}},{key:"addTransformNode",value:function(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneTransformNodesArray||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}},{key:"removeTransformNode",value:function(e){var t=e._indexInSceneTransformNodesArray;if(-1!==t){if(t!==this.transformNodes.length-1){var i=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=i,i._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}},{key:"removeSkeleton",value:function(e){var t=this.skeletons.indexOf(e);return-1!==t&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}},{key:"removeMorphTargetManager",value:function(e){var t=this.morphTargetManagers.indexOf(e);return-1!==t&&this.morphTargetManagers.splice(t,1),t}},{key:"removeLight",value:function(e){var t=this.lights.indexOf(e);if(-1!==t){var i,n=(0,p.Z)(this.meshes);try{for(n.s();!(i=n.n()).done;){i.value._removeLightSource(e,!1)}}catch(r){n.e(r)}finally{n.f()}this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}},{key:"removeCamera",value:function(e){var t=this.cameras.indexOf(e);if(-1!==t&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){var i=this.activeCameras.indexOf(e);-1!==i&&this.activeCameras.splice(i,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}},{key:"removeParticleSystem",value:function(e){var t=this.particleSystems.indexOf(e);return-1!==t&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}},{key:"removeAnimation",value:function(e){var t=this.animations.indexOf(e);return-1!==t&&this.animations.splice(t,1),t}},{key:"stopAnimation",value:function(e,t,i){}},{key:"removeAnimationGroup",value:function(e){var t=this.animationGroups.indexOf(e);return-1!==t&&this.animationGroups.splice(t,1),t}},{key:"removeMultiMaterial",value:function(e){var t=this.multiMaterials.indexOf(e);return-1!==t&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}},{key:"removeMaterial",value:function(e){var t=e._indexInSceneMaterialArray;if(-1!==t&&t<this.materials.length){if(t!==this.materials.length-1){var i=this.materials[this.materials.length-1];this.materials[t]=i,i._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}},{key:"removeActionManager",value:function(e){var t=this.actionManagers.indexOf(e);return-1!==t&&this.actionManagers.splice(t,1),t}},{key:"removeTexture",value:function(e){var t=this.textures.indexOf(e);return-1!==t&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}},{key:"addLight",value:function(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();var t,i=(0,p.Z)(this.meshes);try{for(i.s();!(t=i.n()).done;){var n=t.value;-1===n.lightSources.indexOf(e)&&(n.lightSources.push(e),n._resyncLightSources())}}catch(r){i.e(r)}finally{i.f()}this.onNewLightAddedObservable.notifyObservers(e)}}},{key:"sortLightsByPriority",value:function(){this.requireLightSorting&&this.lights.sort(Wi.CompareLightsPriority)}},{key:"addCamera",value:function(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}},{key:"addSkeleton",value:function(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}},{key:"addParticleSystem",value:function(e){this._blockEntityCollection||this.particleSystems.push(e)}},{key:"addAnimation",value:function(e){this._blockEntityCollection||this.animations.push(e)}},{key:"addAnimationGroup",value:function(e){this._blockEntityCollection||this.animationGroups.push(e)}},{key:"addMultiMaterial",value:function(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}},{key:"addMaterial",value:function(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneMaterialArray||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}},{key:"addMorphTargetManager",value:function(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}},{key:"addGeometry",value:function(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}},{key:"addActionManager",value:function(e){this.actionManagers.push(e)}},{key:"addTexture",value:function(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}},{key:"switchActiveCamera",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}},{key:"setActiveCameraById",value:function(e){var t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}},{key:"setActiveCameraByName",value:function(e){var t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}},{key:"getAnimationGroupByName",value:function(e){for(var t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}},{key:"_getMaterial",value:function(e,t){for(var i=0;i<this.materials.length;i++){var n=this.materials[i];if(t(n))return n}if(e)for(var r=0;r<this.multiMaterials.length;r++){var s=this.multiMaterials[r];if(t(s))return s}return null}},{key:"getMaterialByUniqueID",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._getMaterial(t,(function(t){return t.uniqueId===e}))}},{key:"getMaterialById",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._getMaterial(t,(function(t){return t.id===e}))}},{key:"getMaterialByName",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._getMaterial(t,(function(t){return t.name===e}))}},{key:"getLastMaterialById",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this.materials.length-1;i>=0;i--)if(this.materials[i].id===e)return this.materials[i];if(t)for(var n=this.multiMaterials.length-1;n>=0;n--)if(this.multiMaterials[n].id===e)return this.multiMaterials[n];return null}},{key:"getTextureByUniqueId",value:function(e){for(var t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}},{key:"getTextureByName",value:function(e){for(var t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}},{key:"getCameraById",value:function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}},{key:"getCameraByUniqueId",value:function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}},{key:"getCameraByName",value:function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}},{key:"getBoneById",value:function(e){for(var t=0;t<this.skeletons.length;t++)for(var i=this.skeletons[t],n=0;n<i.bones.length;n++)if(i.bones[n].id===e)return i.bones[n];return null}},{key:"getBoneByName",value:function(e){for(var t=0;t<this.skeletons.length;t++)for(var i=this.skeletons[t],n=0;n<i.bones.length;n++)if(i.bones[n].name===e)return i.bones[n];return null}},{key:"getLightByName",value:function(e){for(var t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}},{key:"getLightById",value:function(e){for(var t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}},{key:"getLightByUniqueId",value:function(e){for(var t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}},{key:"getParticleSystemById",value:function(e){for(var t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}},{key:"getGeometryById",value:function(e){for(var t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}},{key:"_getGeometryByUniqueId",value:function(e){if(this._geometriesByUniqueId){var t=this._geometriesByUniqueId[e];if(void 0!==t)return this.geometries[t]}else for(var i=0;i<this.geometries.length;i++)if(this.geometries[i].uniqueId===e)return this.geometries[i];return null}},{key:"pushGeometry",value:function(e,t){return!(!t&&this._getGeometryByUniqueId(e.uniqueId))&&(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),!0)}},{key:"removeGeometry",value:function(e){var t;if(this._geometriesByUniqueId){if(void 0===(t=this._geometriesByUniqueId[e.uniqueId]))return!1}else if((t=this.geometries.indexOf(e))<0)return!1;if(t!==this.geometries.length-1){var i=this.geometries[this.geometries.length-1];i&&(this.geometries[t]=i,this._geometriesByUniqueId&&(this._geometriesByUniqueId[i.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}},{key:"getGeometries",value:function(){return this.geometries}},{key:"getMeshById",value:function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}},{key:"getMeshesById",value:function(e){return this.meshes.filter((function(t){return t.id===e}))}},{key:"getTransformNodeById",value:function(e){for(var t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}},{key:"getTransformNodeByUniqueId",value:function(e){for(var t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}},{key:"getTransformNodesById",value:function(e){return this.transformNodes.filter((function(t){return t.id===e}))}},{key:"getMeshByUniqueId",value:function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}},{key:"getLastMeshById",value:function(e){for(var t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}},{key:"getLastEntryById",value:function(e){var t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}},{key:"getNodeById",value:function(e){var t=this.getMeshById(e);if(t)return t;var i=this.getTransformNodeById(e);if(i)return i;var n=this.getLightById(e);if(n)return n;var r=this.getCameraById(e);return r||(this.getBoneById(e)||null)}},{key:"getNodeByName",value:function(e){var t=this.getMeshByName(e);if(t)return t;var i=this.getTransformNodeByName(e);if(i)return i;var n=this.getLightByName(e);if(n)return n;var r=this.getCameraByName(e);return r||(this.getBoneByName(e)||null)}},{key:"getMeshByName",value:function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}},{key:"getTransformNodeByName",value:function(e){for(var t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}},{key:"getLastSkeletonById",value:function(e){for(var t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}},{key:"getSkeletonByUniqueId",value:function(e){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}},{key:"getSkeletonById",value:function(e){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}},{key:"getSkeletonByName",value:function(e){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}},{key:"getMorphTargetManagerById",value:function(e){for(var t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}},{key:"getMorphTargetById",value:function(e){for(var t=0;t<this.morphTargetManagers.length;++t)for(var i=this.morphTargetManagers[t],n=0;n<i.numTargets;++n){var r=i.getTarget(n);if(r.id===e)return r}return null}},{key:"getMorphTargetByName",value:function(e){for(var t=0;t<this.morphTargetManagers.length;++t)for(var i=this.morphTargetManagers[t],n=0;n<i.numTargets;++n){var r=i.getTarget(n);if(r.name===e)return r}return null}},{key:"getPostProcessByName",value:function(e){for(var t=0;t<this.postProcesses.length;++t){var i=this.postProcesses[t];if(i.name===e)return i}return null}},{key:"isActiveMesh",value:function(e){return-1!==this._activeMeshes.indexOf(e)}},{key:"uid",get:function(){return this._uid||(this._uid=It.RandomId()),this._uid}},{key:"addExternalData",value:function(e,t){return this._externalData||(this._externalData=new Ft),this._externalData.add(e,t)}},{key:"getExternalData",value:function(e){return this._externalData?this._externalData.get(e):null}},{key:"getOrAddExternalDataWithFactory",value:function(e,t){return this._externalData||(this._externalData=new Ft),this._externalData.getOrAddWithFactory(e,t)}},{key:"removeExternalData",value:function(e){return this._externalData.remove(e)}},{key:"_evaluateSubMesh",value:function(e,t,i,n){if(n||e.isInFrustum(this._frustumPlanes)){var r,s=(0,p.Z)(this._evaluateSubMeshStage);try{for(s.s();!(r=s.n()).done;){r.value.action(t,e)}}catch(o){s.e(o)}finally{s.f()}var a=e.getMaterial();null!=a&&(a.hasRenderTargetTextures&&null!=a.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(a)&&(this._processedMaterials.push(a),this._materialsRenderTargets.concatWithNoDuplicate(a.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,a))}}},{key:"freeProcessedMaterials",value:function(){this._processedMaterials.dispose()}},{key:"blockfreeActiveMeshesAndRenderingGroups",get:function(){return this._preventFreeActiveMeshesAndRenderingGroups},set:function(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}},{key:"freeActiveMeshes",value:function(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(var e=0;e<this.activeCameras.length;e++){var t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}},{key:"freeRenderingGroups",value:function(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(var e=0;e<this.textures.length;e++){var t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}},{key:"_isInIntermediateRendering",value:function(){return this._intermediateRendering}},{key:"freezeActiveMeshes",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return this.executeWhenReady((function(){if(e.activeCamera){if(e._frustumPlanes||e.updateTransformMatrix(),e._evaluateActiveMeshes(),e._activeMeshesFrozen=!0,e._activeMeshesFrozenButKeepClipping=s,e._skipEvaluateActiveMeshesCompletely=t,r)for(var a=0;a<e._activeMeshes.length;a++)e._activeMeshes.data[a]._freeze();i&&i()}else n&&n("No active camera found")})),this}},{key:"unfreezeActiveMeshes",value:function(){for(var e=0;e<this.meshes.length;e++){var t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(var i=0;i<this._activeMeshes.length;i++)this._activeMeshes.data[i]._unFreeze();return this._activeMeshesFrozen=!1,this}},{key:"_executeActiveContainerCleanup",value:function(e){(!this._engine.snapshotRendering||1!==this._engine.snapshotRenderingMode)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce((function(){return e.dispose()}))}},{key:"_evaluateActiveMeshes",value:function(){var e;if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode)this._activeMeshes.length>0&&(null===(e=this.activeCamera)||void 0===e||e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());else if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely)for(var t=this._activeMeshes.length,i=0;i<t;i++)this._activeMeshes.data[i].computeWorldMatrix();if(this._activeParticleSystems)for(var n=this._activeParticleSystems.length,r=0;r<n;r++)this._activeParticleSystems.data[r].animate();this._renderingManager.resetSprites()}else if(this.activeCamera){this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();var s,a=(0,p.Z)(this._beforeEvaluateActiveMeshStage);try{for(a.s();!(s=a.n()).done;){s.value.action()}}catch(m){a.e(m)}finally{a.f()}for(var o=this.getActiveMeshCandidates(),l=o.length,u=0;u<l;u++){var h=o.data[u];if(h._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,!h.isBlocked&&(this._totalVertices.addCount(h.getTotalVertices(),!1),h.isReady()&&h.isEnabled()&&!h.scaling.hasAZeroComponent)){h.computeWorldMatrix(),h.actionManager&&h.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(h);var c=this.customLODSelector?this.customLODSelector(h,this.activeCamera):h.getLOD(this.activeCamera);if(h._internalAbstractMeshDataInfo._currentLOD=c,h._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,null!=c&&(c!==h&&0!==c.billboardMode&&c.computeWorldMatrix(),h._preActivate(),h.isVisible&&h.visibility>0&&h.layerMask&this.activeCamera.layerMask&&(this._skipFrustumClipping||h.alwaysSelectAsActiveMesh||h.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(h),this.activeCamera._activeMeshes.push(h),c!==h&&c._activate(this._renderId,!1);var d,f=(0,p.Z)(this._preActiveMeshStage);try{for(f.s();!(d=f.n()).done;){d.value.action(h)}}catch(m){f.e(m)}finally{f.f()}h._activate(this._renderId,!1)&&(h.isAnInstance?h._internalAbstractMeshDataInfo._actAsRegularMesh&&(c=h):c._internalAbstractMeshDataInfo._onlyForInstances=!1,c._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(h,c)),h._postActivate()}}}if(this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(var _=0;_<this.particleSystems.length;_++){var v=this.particleSystems[_];if(v.isStarted()&&v.emitter){var g=v.emitter;(!g.position||g.isEnabled())&&(this._activeParticleSystems.push(v),v.animate(),this._renderingManager.dispatchParticles(v))}}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}}},{key:"_activeMesh",value:function(e,t){this._skeletonsEnabled&&null!==t.skeleton&&void 0!==t.skeleton&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&(t.skeleton.prepare(),this._activeBones.addCount(t.skeleton.bones.length,!1)),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t));var i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){var n=this.getActiveSubMeshCandidates(t),r=n.length;i=i||1===r;for(var s=0;s<r;s++){var a=n.data[s];this._evaluateSubMesh(a,t,e,i)}}}},{key:"updateTransformMatrix",value:function(e){if(this.activeCamera)if(this.activeCamera._renderingMultiview){var t=this.activeCamera._rigCameras[0],i=this.activeCamera._rigCameras[1];this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e),i.getViewMatrix(),i.getProjectionMatrix(e))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(e))}},{key:"_bindFrameBuffer",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),t&&this._clearFrameBuffer(e)}},{key:"_clearFrameBuffer",value:function(e){if(!e||!e._multiviewTexture)if(e&&e.outputRenderTarget&&!e._renderingMultiview){var t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||(this.autoClear&&this._engine.clear(t.clearColor||this.clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}},{key:"_renderForCamera",value:function(e,t){var i,n,r,s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!e||!e._skipRendering){var a=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(a.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&s){var o=!0;e._renderingMultiview&&e.outputRenderTarget&&(o=e.outputRenderTarget.skipInitialClear,this.autoClear&&(e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=o)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(var l=0;l<this._softwareSkinnedMeshes.length;l++){var u=this._softwareSkinnedMeshes.data[l];u.applySkeleton(u.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);var h,c=(0,p.Z)(this._gatherActiveCameraRenderTargetsStage);try{for(c.s();!(h=c.n()).done;){h.value.action(this._renderTargets)}}catch(A){c.e(A)}finally{c.f()}var d=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){It.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(var f=0;f<this._renderTargets.length;f++){var _=this._renderTargets.data[f];if(_._shouldRender()){this._renderId++;var v=_.activeCamera&&_.activeCamera!==this.activeCamera;_.render(v,this.dumpNextRenderTargets),d=!0}}It.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}var g,m=(0,p.Z)(this._cameraDrawRenderTargetStage);try{for(m.s();!(g=m.n()).done;){d=g.value.action(this.activeCamera)||d}}catch(A){m.e(A)}finally{m.f()}this._intermediateRendering=!1}this._engine.currentRenderPassId=null!==(r=null!==(n=null===(i=e.outputRenderTarget)||void 0===i?void 0:i.renderPassId)&&void 0!==n?n:e.renderPassId)&&void 0!==r?r:0,d&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!e._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();var y,T=(0,p.Z)(this._beforeCameraDrawStage);try{for(T.s();!(y=T.n()).done;){y.value.action(this.activeCamera)}}catch(A){T.e(A)}finally{T.f()}this.onBeforeDrawPhaseObservable.notifyObservers(this),a.snapshotRendering&&1===a.snapshotRenderingMode&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);var E,S=(0,p.Z)(this._afterCameraDrawStage);try{for(S.s();!(E=S.n()).done;){E.value.action(this.activeCamera)}}catch(A){S.e(A)}finally{S.f()}if(this.postProcessManager&&!e._multiviewTexture){var b=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,b)}var x,M=(0,p.Z)(this._afterCameraPostProcessStage);try{for(M.s();!(x=M.n()).done;){x.value.action(this.activeCamera)}}catch(A){M.e(A)}finally{M.f()}this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}}},{key:"_processSubCameras",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(0===e.cameraRigMode||e._renderingMultiview)return e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),void this.onAfterRenderCameraObservable.notifyObservers(e);if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(var i=0;i<e._rigCameras.length;i++)this._renderForCamera(e._rigCameras[i],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}},{key:"_checkIntersections",value:function(){for(var e=0;e<this._meshesForIntersections.length;e++){var t=this._meshesForIntersections.data[e];if(t.actionManager)for(var i=function(){var e=t.actionManager.actions[n];if(12===e.trigger||13===e.trigger){var i=e.getTriggerParameter(),r=i.mesh?i.mesh:i,s=r.intersectsMesh(t,i.usePreciseIntersection),a=t._intersectionsInProgress.indexOf(r);s&&-1===a?12===e.trigger?(e._executeCurrent(si.CreateNew(t,void 0,r)),t._intersectionsInProgress.push(r)):13===e.trigger&&t._intersectionsInProgress.push(r):!s&&a>-1&&(13===e.trigger&&e._executeCurrent(si.CreateNew(t,void 0,r)),(!t.actionManager.hasSpecificTrigger(13,(function(e){var t=e.mesh?e.mesh:e;return r===t}))||13===e.trigger)&&t._intersectionsInProgress.splice(a,1))}},n=0;t.actionManager&&n<t.actionManager.actions.length;n++)i()}}},{key:"_advancePhysicsEngineStep",value:function(e){}},{key:"_animate",value:function(){}},{key:"animate",value:function(){if(this._engine.isDeterministicLockStep()){var e=Math.max(i.MinDeltaTime,Math.min(this._engine.getDeltaTime(),i.MaxDeltaTime))+this._timeAccumulator,t=this._engine.getTimeStep(),n=1e3/t/1e3,r=0,s=this._engine.getLockstepMaxSteps(),a=Math.floor(e/t);for(a=Math.min(a,s);e>0&&r<a;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*n,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,r++,e-=t;this._timeAccumulator=e<0?0:e}else{var o=this.useConstantAnimationDeltaTime?16:Math.max(i.MinDeltaTime,Math.min(this._engine.getDeltaTime(),i.MaxDeltaTime));this._animationRatio=.06*o,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(o)}}},{key:"_clear",value:function(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}},{key:"_checkCameraRenderTarget",value:function(e){var t;if(null!=e&&e.outputRenderTarget&&!(null!=e&&e.isRigCamera)&&(e.outputRenderTarget._cleared=!1),null!==(t=null==e?void 0:e.rigCameras)&&void 0!==t&&t.length)for(var i=0;i<e.rigCameras.length;++i){var n=e.rigCameras[i].outputRenderTarget;n&&(n._cleared=!1)}}},{key:"resetDrawCache",value:function(e){if(this.meshes){var t,i=(0,p.Z)(this.meshes);try{for(i.s();!(t=i.n()).done;){t.value.resetDrawCache(e)}}catch(n){i.e(n)}finally{i.f()}}}},{key:"render",value:function(){var e,t,i,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.isDisposed){this.onReadyObservable.hasObservers()&&null===this._executeWhenReadyTimeoutId&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),!(null===(e=this.activeCameras)||void 0===e)&&e.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),r||this.animate();var s,a=(0,p.Z)(this._beforeCameraUpdateStage);try{for(a.s();!(s=a.n()).done;){s.value.action()}}catch(M){a.e(M)}finally{a.f()}if(n)if(this.activeCameras&&this.activeCameras.length>0)for(var o=0;o<this.activeCameras.length;o++){var l=this.activeCameras[o];if(l.update(),0!==l.cameraRigMode)for(var u=0;u<l._rigCameras.length;u++)l._rigCameras[u].update()}else if(this.activeCamera&&(this.activeCamera.update(),0!==this.activeCamera.cameraRigMode))for(var h=0;h<this.activeCamera._rigCameras.length;h++)this.activeCamera._rigCameras[h].update();this.onBeforeRenderObservable.notifyObservers(this);var c=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);var d=null!==(t=this.activeCameras)&&void 0!==t&&t.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){It.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(var f=0;f<this.customRenderTargets.length;f++){var _=this.customRenderTargets[f];if(_._shouldRender()){if(this._renderId++,this.activeCamera=_.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");c.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),_.render(d!==this.activeCamera,this.dumpNextRenderTargets)}}It.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=null!==(i=null==d?void 0:d.renderPassId)&&void 0!==i?i:0,this.activeCamera=d,this._activeCamera&&22!==this._activeCamera.cameraRigMode&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);var v,g=(0,p.Z)(this._beforeClearStage);try{for(g.s();!(v=g.n()).done;){v.value.action()}}catch(M){g.e(M)}finally{g.f()}this._clearFrameBuffer(this.activeCamera);var m,y=(0,p.Z)(this._gatherRenderTargetsStage);try{for(y.s();!(m=y.n()).done;){m.value.action(this._renderTargets)}}catch(M){y.e(M)}finally{y.f()}if(this.activeCameras&&this.activeCameras.length>0)for(var T=0;T<this.activeCameras.length;T++)this._processSubCameras(this.activeCameras[T],T>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();var E,S=(0,p.Z)(this._afterRenderStage);try{for(S.s();!(E=S.n()).done;){E.value.action()}}catch(M){S.e(M)}finally{S.f()}if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(var b=0;b<this._toBeDisposed.length;b++){var x=this._toBeDisposed[b];x&&x.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}}},{key:"freezeMaterials",value:function(){for(var e=0;e<this.materials.length;e++)this.materials[e].freeze()}},{key:"unfreezeMaterials",value:function(){for(var e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}},{key:"dispose",value:function(){if(!this.isDisposed){this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;var e,t=this._activeRequests.slice(),i=(0,p.Z)(t);try{for(i.s();!(e=i.n()).done;){e.value.abort()}}catch(a){i.e(a)}finally{i.f()}this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(n){console.error("An error occurred while calling onDisposeObservable!",n)}if(this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.detachControl(),this._engine.getInputElement())for(var n=0;n<this.cameras.length;n++)this.cameras[n].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,(function(e){return e.dispose(!0)})),this._disposeList(this.transformNodes,(function(e){return e.dispose(!0)}));var r=this.cameras;this._disposeList(r),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);var s=this._engine.scenes.indexOf(this);s>-1&&this._engine.scenes.splice(s,1),V._LastCreatedScene===this&&(this._engine.scenes.length>0?V._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:V._LastCreatedScene=null),(s=this._engine._virtualScenes.indexOf(this))>-1&&this._engine._virtualScenes.splice(s,1),this._engine.wipeCaches(!0),this._isDisposed=!0}}},{key:"_disposeList",value:function(e,t){var i,n=e.slice(0);t=null!==(i=t)&&void 0!==i?i:function(e){return e.dispose()};var r,s=(0,p.Z)(n);try{for(s.s();!(r=s.n()).done;){t(r.value)}}catch(a){s.e(a)}finally{s.f()}e.length=0}},{key:"isDisposed",get:function(){return this._isDisposed}},{key:"clearCachedVertexData",value:function(){for(var e=0;e<this.meshes.length;e++){var t=this.meshes[e].geometry;t&&t.clearCachedData()}}},{key:"cleanCachedTextureBuffer",value:function(){var e,t=(0,p.Z)(this.textures);try{for(t.s();!(e=t.n()).done;){var i=e.value;i._buffer&&(i._buffer=null)}}catch(n){t.e(n)}finally{t.f()}}},{key:"getWorldExtends",value:function(e){var t=new z(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new z(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||function(){return!0},this.meshes.filter(e).forEach((function(e){if(e.computeWorldMatrix(!0),e.subMeshes&&0!==e.subMeshes.length&&!e.infiniteDistance){var n=e.getBoundingInfo(),r=n.boundingBox.minimumWorld,s=n.boundingBox.maximumWorld;z.CheckExtends(r,t,i),z.CheckExtends(s,t,i)}})),{min:t,max:i}}},{key:"createPickingRay",value:function(e,t,i,n){throw le("Ray")}},{key:"createPickingRayToRef",value:function(e,t,i,n,r){throw le("Ray")}},{key:"createPickingRayInCameraSpace",value:function(e,t,i){throw le("Ray")}},{key:"createPickingRayInCameraSpaceToRef",value:function(e,t,i,n){throw le("Ray")}},{key:"_pickingAvailable",get:function(){return!1}},{key:"pick",value:function(e,t,i,n,r,s){return new ri}},{key:"pickWithBoundingInfo",value:function(e,t,i,n,r){return new ri}},{key:"pickWithRay",value:function(e,t,i,n){throw le("Ray")}},{key:"multiPick",value:function(e,t,i,n,r){throw le("Ray")}},{key:"multiPickWithRay",value:function(e,t,i){throw le("Ray")}},{key:"setPointerOverMesh",value:function(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}},{key:"getPointerOverMesh",value:function(){return this._inputManager.getPointerOverMesh()}},{key:"_rebuildGeometries",value:function(){var e,t=(0,p.Z)(this.geometries);try{for(t.s();!(e=t.n()).done;){e.value._rebuild()}}catch(h){t.e(h)}finally{t.f()}var i,n=(0,p.Z)(this.meshes);try{for(n.s();!(i=n.n()).done;){i.value._rebuild()}}catch(h){n.e(h)}finally{n.f()}this.postProcessManager&&this.postProcessManager._rebuild();var r,s=(0,p.Z)(this._components);try{for(s.s();!(r=s.n()).done;){r.value.rebuild()}}catch(h){s.e(h)}finally{s.f()}var a,o=(0,p.Z)(this.particleSystems);try{for(o.s();!(a=o.n()).done;){a.value.rebuild()}}catch(h){o.e(h)}finally{o.f()}if(this.spriteManagers){var l,u=(0,p.Z)(this.spriteManagers);try{for(u.s();!(l=u.n()).done;){l.value.rebuild()}}catch(h){u.e(h)}finally{u.f()}}}},{key:"_rebuildTextures",value:function(){var e,t=(0,p.Z)(this.textures);try{for(t.s();!(e=t.n()).done;){e.value._rebuild()}}catch(i){t.e(i)}finally{t.f()}this.markAllMaterialsAsDirty(1)}},{key:"_getByTags",value:function(e,t,i){if(void 0===t)return e;var n=[];for(var r in i=i||function(e){},e){var s=e[r];Ot&&Ot.MatchesQuery(s,t)&&(n.push(s),i(s))}return n}},{key:"getMeshesByTags",value:function(e,t){return this._getByTags(this.meshes,e,t)}},{key:"getCamerasByTags",value:function(e,t){return this._getByTags(this.cameras,e,t)}},{key:"getLightsByTags",value:function(e,t){return this._getByTags(this.lights,e,t)}},{key:"getMaterialByTags",value:function(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}},{key:"getTransformNodesByTags",value:function(e,t){return this._getByTags(this.transformNodes,e,t)}},{key:"setRenderingOrder",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._renderingManager.setRenderingOrder(e,t,i,n)}},{key:"setRenderingAutoClearDepthStencil",value:function(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,n)}},{key:"getAutoClearDepthStencilSetup",value:function(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}},{key:"blockMaterialDirtyMechanism",get:function(){return this._blockMaterialDirtyMechanism},set:function(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}},{key:"markAllMaterialsAsDirty",value:function(e,t){if(!this._blockMaterialDirtyMechanism){var i,n=(0,p.Z)(this.materials);try{for(n.s();!(i=n.n()).done;){var r=i.value;t&&!t(r)||r.markAsDirty(e)}}catch(s){n.e(s)}finally{n.f()}}}},{key:"_loadFile",value:function(e,t,i,n,r,s,a){var o=this,l=yt(e,t,i,n?this.offlineProvider:void 0,r,s,a);return this._activeRequests.push(l),l.onCompleteObservable.add((function(e){o._activeRequests.splice(o._activeRequests.indexOf(e),1)})),l}},{key:"_loadFileAsync",value:function(e,t,i,n,r){var s=this;return new Promise((function(a,o){s._loadFile(e,(function(e){a(e)}),t,i,n,(function(e,t){o(t)}),r)}))}},{key:"_requestFile",value:function(e,t,i,n,r,s,a){var o=this,l=Tt(e,t,i,n?this.offlineProvider:void 0,r,s,a);return this._activeRequests.push(l),l.onCompleteObservable.add((function(e){o._activeRequests.splice(o._activeRequests.indexOf(e),1)})),l}},{key:"_requestFileAsync",value:function(e,t,i,n,r){var s=this;return new Promise((function(a,o){s._requestFile(e,(function(e){a(e)}),t,i,n,(function(e){o(e)}),r)}))}},{key:"_readFile",value:function(e,t,i,n,r){var s=this,a=mt(e,t,i,n,r);return this._activeRequests.push(a),a.onCompleteObservable.add((function(e){s._activeRequests.splice(s._activeRequests.indexOf(e),1)})),a}},{key:"_readFileAsync",value:function(e,t,i){var n=this;return new Promise((function(r,s){n._readFile(e,(function(e){r(e)}),t,i,(function(e){s(e)}))}))}},{key:"getPerfCollector",value:function(){throw le("performanceViewerSceneExtension")}}],[{key:"DefaultMaterialFactory",value:function(e){throw le("StandardMaterial")}},{key:"CollisionCoordinatorFactory",value:function(){throw le("DefaultCollisionCoordinator")}},{key:"DragMovementThreshold",get:function(){return Ni.DragMovementThreshold},set:function(e){Ni.DragMovementThreshold=e}},{key:"LongPressDelay",get:function(){return Ni.LongPressDelay},set:function(e){Ni.LongPressDelay=e}},{key:"DoubleClickDelay",get:function(){return Ni.DoubleClickDelay},set:function(e){Ni.DoubleClickDelay=e}},{key:"ExclusiveDoubleClickMode",get:function(){return Ni.ExclusiveDoubleClickMode},set:function(e){Ni.ExclusiveDoubleClickMode=e}}]),i}(Lt);function Xi(e,t,i){try{var n=e.next();n.done?t(n):n.value?n.value.then((function(){n.value=void 0,t(n)}),i):t(n)}catch(n){i(n)}}function Hi(e,t,i,n,r){!function s(){var a,o=function(e){e.done?i(e.value):void 0===a?a=!0:s()};do{a=void 0,r&&r.aborted?n(new Error("Aborted")):t(e,o,n),void 0===a&&(a=!1)}while(a)}()}function Zi(e,t){var i;return Hi(e,Xi,(function(e){return i=e}),(function(e){throw e}),t),i}zi.FOGMODE_NONE=0,zi.FOGMODE_EXP=1,zi.FOGMODE_EXP2=2,zi.FOGMODE_LINEAR=3,zi.MinDeltaTime=1,zi.MaxDeltaTime=1e3,zi.prototype.setActiveCameraByID=function(e){return this.setActiveCameraById(e)},zi.prototype.getLastMaterialByID=function(e){return this.getLastMaterialById(e)},zi.prototype.getMaterialByID=function(e){return this.getMaterialById(e)},zi.prototype.getTextureByUniqueID=function(e){return this.getTextureByUniqueId(e)},zi.prototype.getCameraByID=function(e){return this.getCameraById(e)},zi.prototype.getCameraByUniqueID=function(e){return this.getCameraByUniqueId(e)},zi.prototype.getBoneByID=function(e){return this.getBoneById(e)},zi.prototype.getLightByID=function(e){return this.getLightById(e)},zi.prototype.getLightByUniqueID=function(e){return this.getLightByUniqueId(e)},zi.prototype.getParticleSystemByID=function(e){return this.getParticleSystemById(e)},zi.prototype.getGeometryByID=function(e){return this.getGeometryById(e)},zi.prototype.getMeshByID=function(e){return this.getMeshById(e)},zi.prototype.getMeshesByID=function(e){return this.getMeshesById(e)},zi.prototype.getTransformNodeByID=function(e){return this.getTransformNodeById(e)},zi.prototype.getTransformNodeByUniqueID=function(e){return this.getTransformNodeByUniqueId(e)},zi.prototype.getTransformNodesByID=function(e){return this.getTransformNodesById(e)},zi.prototype.getMeshByUniqueID=function(e){return this.getMeshByUniqueId(e)},zi.prototype.getLastMeshByID=function(e){return this.getLastMeshById(e)},zi.prototype.getLastEntryByID=function(e){return this.getLastEntryById(e)},zi.prototype.getNodeByID=function(e){return this.getNodeById(e)},zi.prototype.getLastSkeletonByID=function(e){return this.getLastSkeletonById(e)};var Ki=(0,y.Z)((function e(){(0,m.Z)(this,e),this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new ee,this._onClonedObservable=new ee})),Yi=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;(0,m.Z)(this,e),this._isDirty=!1,this._nodeDataStorage=new Ki,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new ee,this._parentContainer=null,this.animations=new Array,this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=Z.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new ee,this._onDisposeObserver=null,this._behaviors=new Array,this.name=t,this.id=t,this._scene=i||V.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}return(0,y.Z)(e,[{key:"accessibilityTag",get:function(){return this._accessibilityTag},set:function(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}},{key:"doNotSerialize",get:function(){return!!this._nodeDataStorage._doNotSerialize||!!this._parentNode&&this._parentNode.doNotSerialize},set:function(e){this._nodeDataStorage._doNotSerialize=e}},{key:"isDisposed",value:function(){return this._nodeDataStorage._isDisposed}},{key:"parent",get:function(){return this._parentNode},set:function(e){if(this._parentNode!==e){var t=this._parentNode;if(this._parentNode&&void 0!==this._parentNode._children&&null!==this._parentNode._children){var i=this._parentNode._children.indexOf(this);-1!==i&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&((void 0===this._parentNode._children||null===this._parentNode._children)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}}},{key:"_serializeAsParent",value:function(e){e.parentId=this.uniqueId}},{key:"_addToSceneRootNodes",value:function(){-1===this._nodeDataStorage._sceneRootNodesIndex&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}},{key:"_removeFromSceneRootNodes",value:function(){if(-1!==this._nodeDataStorage._sceneRootNodesIndex){var e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}},{key:"animationPropertiesOverride",get:function(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e}},{key:"getClassName",value:function(){return"Node"}},{key:"onDispose",set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}},{key:"onEnabledStateChangedObservable",get:function(){return this._nodeDataStorage._onEnabledStateChangedObservable}},{key:"onClonedObservable",get:function(){return this._nodeDataStorage._onClonedObservable}},{key:"getScene",value:function(){return this._scene}},{key:"getEngine",value:function(){return this._scene.getEngine()}},{key:"addBehavior",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return-1!==this._behaviors.indexOf(e)||(e.init(),this._scene.isLoading&&!i?this._scene.onDataLoadedObservable.addOnce((function(){e.attach(t)})):e.attach(this),this._behaviors.push(e)),this}},{key:"removeBehavior",value:function(e){var t=this._behaviors.indexOf(e);return-1===t||(this._behaviors[t].detach(),this._behaviors.splice(t,1)),this}},{key:"behaviors",get:function(){return this._behaviors}},{key:"getBehaviorByName",value:function(e){var t,i=(0,p.Z)(this._behaviors);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(n.name===e)return n}}catch(r){i.e(r)}finally{i.f()}return null}},{key:"getWorldMatrix",value:function(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}},{key:"_getWorldMatrixDeterminant",value:function(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}},{key:"worldMatrixFromCache",get:function(){return this._worldMatrix}},{key:"_initCache",value:function(){this._cache={},this._cache.parent=void 0}},{key:"updateCache",value:function(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}},{key:"_getActionManagerForTrigger",value:function(e){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}},{key:"_updateCache",value:function(e){}},{key:"_isSynchronized",value:function(){return!0}},{key:"_markSyncedWithParent",value:function(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}},{key:"isSynchronizedWithParent",value:function(){return!this._parentNode||!this._parentNode._isDirty&&this._parentUpdateId===this._parentNode._childUpdateId&&this._parentNode.isSynchronized()}},{key:"isSynchronized",value:function(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):!(this._parentNode&&!this.isSynchronizedWithParent())&&this._isSynchronized()}},{key:"isReady",value:function(){return this._nodeDataStorage._isReady}},{key:"markAsDirty",value:function(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}},{key:"isEnabled",value:function(){return!1===(!(arguments.length>0&&void 0!==arguments[0])||arguments[0])?this._nodeDataStorage._isEnabled:!!this._nodeDataStorage._isEnabled&&this._nodeDataStorage._isParentEnabled}},{key:"_syncParentEnabledState",value:function(){this._nodeDataStorage._isParentEnabled=!this._parentNode||this._parentNode.isEnabled(),this._children&&this._children.forEach((function(e){e._syncParentEnabledState()}))}},{key:"setEnabled",value:function(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}},{key:"isDescendantOf",value:function(e){return!!this.parent&&(this.parent===e||this.parent.isDescendantOf(e))}},{key:"_getDescendants",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2?arguments[2]:void 0;if(this._children)for(var n=0;n<this._children.length;n++){var r=this._children[n];(!i||i(r))&&e.push(r),t||r._getDescendants(e,!1,i)}}},{key:"getDescendants",value:function(e,t){var i=new Array;return this._getDescendants(i,e,t),i}},{key:"getChildMeshes",value:function(e,t){var i=[];return this._getDescendants(i,e,(function(e){return(!t||t(e))&&void 0!==e.cullingStrategy})),i}},{key:"getChildren",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.getDescendants(t,e)}},{key:"_setReady",value:function(e){if(e!==this._nodeDataStorage._isReady){if(!e)return void(this._nodeDataStorage._isReady=!1);this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}},{key:"getAnimationByName",value:function(e){for(var t=0;t<this.animations.length;t++){var i=this.animations[t];if(i.name===e)return i}return null}},{key:"createAnimationRange",value:function(t,i,n){if(!this._ranges[t]){this._ranges[t]=e._AnimationRangeFactory(t,i,n);for(var r=0,s=this.animations.length;r<s;r++)this.animations[r]&&this.animations[r].createRange(t,i,n)}}},{key:"deleteAnimationRange",value:function(e){for(var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=0,n=this.animations.length;i<n;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}},{key:"getAnimationRange",value:function(e){return this._ranges[e]||null}},{key:"getAnimationRanges",value:function(){var e,t=[];for(e in this._ranges)t.push(this._ranges[e]);return t}},{key:"beginAnimation",value:function(e,t,i,n){var r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,n):null}},{key:"serializeAnimationRanges",value:function(){var e=[];for(var t in this._ranges){var i=this._ranges[t];if(i){var n={};n.name=t,n.from=i.from,n.to=i.to,e.push(n)}}return e}},{key:"computeWorldMatrix",value:function(e){return this._worldMatrix||(this._worldMatrix=Z.Identity()),this._worldMatrix}},{key:"dispose",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._nodeDataStorage._isDisposed=!0,!e){var i,n=this.getDescendants(!0),r=(0,p.Z)(n);try{for(r.s();!(i=r.n()).done;){i.value.dispose(e,t)}}catch(o){r.e(o)}finally{r.f()}}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();var s,a=(0,p.Z)(this._behaviors);try{for(a.s();!(s=a.n()).done;){s.value.detach()}}catch(o){a.e(o)}finally{a.f()}this._behaviors.length=0,this.metadata=null}},{key:"getHierarchyBoundingVectors",value:function(){var e,t,i=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);var r=this;if(r.getBoundingInfo&&r.subMeshes){var s=r.getBoundingInfo();e=s.boundingBox.minimumWorld.clone(),t=s.boundingBox.maximumWorld.clone()}else e=new z(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t=new z(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(i){var a,o=this.getDescendants(!1),l=(0,p.Z)(o);try{for(l.s();!(a=l.n()).done;){var u=a.value;if(u.computeWorldMatrix(!0),(!n||n(u))&&u.getBoundingInfo&&0!==u.getTotalVertices()){var h=u.getBoundingInfo().boundingBox,c=h.minimumWorld,d=h.maximumWorld;z.CheckExtends(c,e,t),z.CheckExtends(d,e,t)}}}catch(f){l.e(f)}finally{l.f()}}return{min:e,max:t}}}],[{key:"AddNodeConstructor",value:function(e,t){this._NodeConstructors[e]=t}},{key:"Construct",value:function(e,t,i,n){var r=this._NodeConstructors[e];return r?r(t,i,n):null}},{key:"ParseAnimationRanges",value:function(e,t,i){if(t.ranges)for(var n=0;n<t.ranges.length;n++){var r=t.ranges[n];e.createAnimationRange(r.name,r.from,r.to)}}}]),e}();Yi._AnimationRangeFactory=function(e,t,i){throw le("AnimationRange")},Yi._NodeConstructors={},Nt([Xt()],Yi.prototype,"name",void 0),Nt([Xt()],Yi.prototype,"id",void 0),Nt([Xt()],Yi.prototype,"uniqueId",void 0),Nt([Xt()],Yi.prototype,"state",void 0),Nt([Xt()],Yi.prototype,"metadata",void 0);var qi=function(){function e(t,i,n,r){(0,m.Z)(this,e),this.x=t,this.y=i,this.width=n,this.height=r}return(0,y.Z)(e,[{key:"toGlobal",value:function(t,i){return new e(this.x*t,this.y*i,this.width*t,this.height*i)}},{key:"toGlobalToRef",value:function(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}},{key:"clone",value:function(){return new e(this.x,this.y,this.width,this.height)}}]),e}(),ji=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r){var s,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return(0,m.Z)(this,i),(s=t.call(this,e,r))._position=z.Zero(),s._upVector=z.Up(),s._orthoLeft=null,s._orthoRight=null,s._orthoBottom=null,s._orthoTop=null,s.fov=.8,s.projectionPlaneTilt=0,s.minZ=1,s.maxZ=1e4,s.inertia=.9,s._mode=i.PERSPECTIVE_CAMERA,s.isIntermediate=!1,s.viewport=new qi(0,0,1,1),s.layerMask=268435455,s.fovMode=i.FOVMODE_VERTICAL_FIXED,s.cameraRigMode=i.RIG_MODE_NONE,s.customRenderTargets=new Array,s.outputRenderTarget=null,s.onViewMatrixChangedObservable=new ee,s.onProjectionMatrixChangedObservable=new ee,s.onAfterCheckInputsObservable=new ee,s.onRestoreStateObservable=new ee,s.isRigCamera=!1,s._rigCameras=new Array,s._webvrViewMatrix=Z.Identity(),s._skipRendering=!1,s._projectionMatrix=new Z,s._postProcesses=new Array,s._activeMeshes=new kt(256),s._globalPosition=z.Zero(),s._computedViewMatrix=Z.Identity(),s._doNotComputeProjectionMatrix=!1,s._transformMatrix=Z.Zero(),s._refreshFrustumPlanes=!0,s._absoluteRotation=H.Identity(),s._isCamera=!0,s._isLeftCamera=!1,s._isRightCamera=!1,s.getScene().addCamera((0,u.Z)(s)),a&&!s.getScene().activeCamera&&(s.getScene().activeCamera=(0,u.Z)(s)),s.position=n,s.renderPassId=s.getScene().getEngine().createRenderPassId("Camera ".concat(e)),s}return(0,y.Z)(i,[{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"upVector",get:function(){return this._upVector},set:function(e){this._upVector=e}},{key:"screenArea",get:function(){var e,t,n,r,s=0,a=0;if(this.mode===i.PERSPECTIVE_CAMERA)this.fovMode===i.FOVMODE_VERTICAL_FIXED?(a=2*this.minZ*Math.tan(this.fov/2),s=this.getEngine().getAspectRatio(this)*a):a=(s=2*this.minZ*Math.tan(this.fov/2))/this.getEngine().getAspectRatio(this);else{var o=this.getEngine().getRenderWidth()/2,l=this.getEngine().getRenderHeight()/2;s=(null!==(e=this.orthoRight)&&void 0!==e?e:o)-(null!==(t=this.orthoLeft)&&void 0!==t?t:-o),a=(null!==(n=this.orthoTop)&&void 0!==n?n:l)-(null!==(r=this.orthoBottom)&&void 0!==r?r:-l)}return s*a}},{key:"orthoLeft",get:function(){return this._orthoLeft},set:function(e){this._orthoLeft=e;var t,i=(0,p.Z)(this._rigCameras);try{for(i.s();!(t=i.n()).done;){t.value.orthoLeft=e}}catch(n){i.e(n)}finally{i.f()}}},{key:"orthoRight",get:function(){return this._orthoRight},set:function(e){this._orthoRight=e;var t,i=(0,p.Z)(this._rigCameras);try{for(i.s();!(t=i.n()).done;){t.value.orthoRight=e}}catch(n){i.e(n)}finally{i.f()}}},{key:"orthoBottom",get:function(){return this._orthoBottom},set:function(e){this._orthoBottom=e;var t,i=(0,p.Z)(this._rigCameras);try{for(i.s();!(t=i.n()).done;){t.value.orthoBottom=e}}catch(n){i.e(n)}finally{i.f()}}},{key:"orthoTop",get:function(){return this._orthoTop},set:function(e){this._orthoTop=e;var t,i=(0,p.Z)(this._rigCameras);try{for(i.s();!(t=i.n()).done;){t.value.orthoTop=e}}catch(n){i.e(n)}finally{i.f()}}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e;var t,i=(0,p.Z)(this._rigCameras);try{for(i.s();!(t=i.n()).done;){t.value.mode=e}}catch(n){i.e(n)}finally{i.f()}}},{key:"storeState",value:function(){return this._stateStored=!0,this._storedFov=this.fov,this}},{key:"_restoreStateValues",value:function(){return!!this._stateStored&&(this.fov=this._storedFov,!0)}},{key:"restoreState",value:function(){return!!this._restoreStateValues()&&(this.onRestoreStateObservable.notifyObservers(this),!0)}},{key:"getClassName",value:function(){return"Camera"}},{key:"toString",value:function(e){var t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(var i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}},{key:"applyVerticalCorrection",value:function(){var e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}},{key:"globalPosition",get:function(){return this._globalPosition}},{key:"getActiveMeshes",value:function(){return this._activeMeshes}},{key:"isActiveMesh",value:function(e){return-1!==this._activeMeshes.indexOf(e)}},{key:"isReady",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(e){var t,n=(0,p.Z)(this._postProcesses);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r&&!r.isReady())return!1}}catch(s){n.e(s)}finally{n.f()}}return c((0,h.Z)(i.prototype),"isReady",this).call(this,e)}},{key:"_initCache",value:function(){c((0,h.Z)(i.prototype),"_initCache",this).call(this),this._cache.position=new z(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new z(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}},{key:"_updateCache",value:function(e){e||c((0,h.Z)(i.prototype),"_updateCache",this).call(this),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}},{key:"_isSynchronized",value:function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}},{key:"_isSynchronizedViewMatrix",value:function(){return!!c((0,h.Z)(i.prototype),"_isSynchronized",this).call(this)&&(this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent())}},{key:"_isSynchronizedProjectionMatrix",value:function(){var e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;var t=this.getEngine();return e=this.mode===i.PERSPECTIVE_CAMERA?this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight()}},{key:"attachControl",value:function(e,t){}},{key:"detachControl",value:function(e){}},{key:"update",value:function(){this._checkInputs(),this.cameraRigMode!==i.RIG_MODE_NONE&&this._updateRigCameras()}},{key:"_checkInputs",value:function(){this.onAfterCheckInputsObservable.notifyObservers(this)}},{key:"rigCameras",get:function(){return this._rigCameras}},{key:"rigPostProcess",get:function(){return this._rigPostProcess}},{key:"_getFirstPostProcess",value:function(){for(var e=0;e<this._postProcesses.length;e++)if(null!==this._postProcesses[e])return this._postProcesses[e];return null}},{key:"_cascadePostProcessesToRigCams",value:function(){var e=this._getFirstPostProcess();e&&e.markTextureDirty();for(var t=0,i=this._rigCameras.length;t<i;t++){var n=this._rigCameras[t],r=n._rigPostProcess;r?("pass"===r.getEffectName()&&(n.isIntermediate=0===this._postProcesses.length),n._postProcesses=this._postProcesses.slice(0).concat(r),r.markTextureDirty()):n._postProcesses=this._postProcesses.slice(0)}}},{key:"attachPostProcess",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(ue.Error("You're trying to reuse a post process not defined as reusable."),0):(null==t||t<0?this._postProcesses.push(e):null===this._postProcesses[t]?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}},{key:"detachPostProcess",value:function(e){var t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}},{key:"getWorldMatrix",value:function(){return this._isSynchronizedViewMatrix()||this.getViewMatrix(),this._worldMatrix}},{key:"_getViewMatrix",value:function(){return Z.Identity()}},{key:"getViewMatrix",value:function(e){return!e&&this._isSynchronizedViewMatrix()||(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix)),this._computedViewMatrix}},{key:"freezeProjectionMatrix",value:function(e){this._doNotComputeProjectionMatrix=!0,void 0!==e&&(this._projectionMatrix=e)}},{key:"unfreezeProjectionMatrix",value:function(){this._doNotComputeProjectionMatrix=!1}},{key:"getProjectionMatrix",value:function(e){var t,n,r,s,a,o,l,u;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;var h=this.getEngine(),c=this.getScene(),d=h.useReverseDepthBuffer;if(this.mode===i.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=h.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1),(c.useRightHandedSystem?Z.PerspectiveFovRHToRef:Z.PerspectiveFovLHToRef)(this.fov,h.getAspectRatio(this),d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===i.FOVMODE_VERTICAL_FIXED,h.isNDCHalfZRange,this.projectionPlaneTilt,d)}else{var f=h.getRenderWidth()/2,_=h.getRenderHeight()/2;c.useRightHandedSystem?Z.OrthoOffCenterRHToRef(null!==(t=this.orthoLeft)&&void 0!==t?t:-f,null!==(n=this.orthoRight)&&void 0!==n?n:f,null!==(r=this.orthoBottom)&&void 0!==r?r:-_,null!==(s=this.orthoTop)&&void 0!==s?s:_,d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,h.isNDCHalfZRange):Z.OrthoOffCenterLHToRef(null!==(a=this.orthoLeft)&&void 0!==a?a:-f,null!==(o=this.orthoRight)&&void 0!==o?o:f,null!==(l=this.orthoBottom)&&void 0!==l?l:-_,null!==(u=this.orthoTop)&&void 0!==u?u:_,d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,h.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=h.getRenderWidth(),this._cache.renderHeight=h.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}},{key:"getTransformationMatrix",value:function(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}},{key:"_updateFrustumPlanes",value:function(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?Ui.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Ui.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}},{key:"isInFrustum",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){var i=!1;return this.rigCameras.forEach((function(t){t._updateFrustumPlanes(),i=i||e.isInFrustum(t._frustumPlanes)})),i}return e.isInFrustum(this._frustumPlanes)}},{key:"isCompletelyInFrustum",value:function(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}},{key:"getForwardRay",value:function(){throw le("Ray")}},{key:"getForwardRayToRef",value:function(e){throw le("Ray")}},{key:"dispose",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){var n=this._rigCameras.pop();n&&n.dispose()}if(this._parentContainer){var r=this._parentContainer.cameras.indexOf(this);r>-1&&this._parentContainer.cameras.splice(r,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==i.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else for(var s=this._postProcesses.length;--s>=0;){var a=this._postProcesses[s];a&&a.dispose(this)}for(var o=this.customRenderTargets.length;--o>=0;)this.customRenderTargets[o].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),c((0,h.Z)(i.prototype),"dispose",this).call(this,e,t)}},{key:"isLeftCamera",get:function(){return this._isLeftCamera}},{key:"isRightCamera",get:function(){return this._isRightCamera}},{key:"leftCamera",get:function(){return this._rigCameras.length<1?null:this._rigCameras[0]}},{key:"rightCamera",get:function(){return this._rigCameras.length<2?null:this._rigCameras[1]}},{key:"getLeftTarget",value:function(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}},{key:"getRightTarget",value:function(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}},{key:"setCameraRigMode",value:function(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){var n=this._rigCameras.pop();n&&n.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=It.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==i.RIG_MODE_NONE){var r=this.createRigCamera(this.name+"_L",0);r&&(r._isLeftCamera=!0);var s=this.createRigCamera(this.name+"_R",1);s&&(s._isRightCamera=!0),r&&s&&(this._rigCameras.push(r),this._rigCameras.push(s))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}},{key:"_setRigMode",value:function(e){}},{key:"_getVRProjectionMatrix",value:function(){return Z.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}},{key:"_updateCameraRotationMatrix",value:function(){}},{key:"_updateWebVRCameraRotationMatrix",value:function(){}},{key:"_getWebVRProjectionMatrix",value:function(){return Z.Identity()}},{key:"_getWebVRViewMatrix",value:function(){return Z.Identity()}},{key:"setCameraRigParameter",value:function(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,"interaxialDistance"===e&&(this._cameraRigParams.stereoHalfAngle=It.ToRadians(t/.0637))}},{key:"createRigCamera",value:function(e,t){return null}},{key:"_updateRigCameras",value:function(){for(var e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===i.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}},{key:"_setupInputs",value:function(){}},{key:"serialize",value:function(){var e=jt.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),jt.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}},{key:"clone",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=jt.Clone(i.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return n.name=e,n.parent=t,this.onClonedObservable.notifyObservers(n),n}},{key:"getDirection",value:function(e){var t=z.Zero();return this.getDirectionToRef(e,t),t}},{key:"absoluteRotation",get:function(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}},{key:"getDirectionToRef",value:function(e,t){z.TransformNormalToRef(e,this.getWorldMatrix(),t)}},{key:"computeWorldMatrix",value:function(){return this.getWorldMatrix()}}],[{key:"GetConstructorFromName",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];return Yi.Construct(e,t,n,{interaxial_distance:r,isStereoscopicSideBySide:s})||function(){return i._CreateDefaultParsedCamera(t,n)}}},{key:"Parse",value:function(e,t){var n=e.type,r=i.GetConstructorFromName(n,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),s=jt.Parse(r,e,t);if(void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s.inputs&&(s.inputs.parse(e),s._setupInputs()),e.upVector&&(s.upVector=z.FromArray(e.upVector)),s.setPosition&&(s.position.copyFromFloats(0,0,0),s.setPosition(z.FromArray(e.position))),e.target&&s.setTarget&&s.setTarget(z.FromArray(e.target)),e.cameraRigMode){var a=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};s.setCameraRigMode(e.cameraRigMode,a)}if(e.animations){for(var o=0;o<e.animations.length;o++){var l=e.animations[o],u=B("BABYLON.Animation");u&&s.animations.push(u.Parse(l))}Yi.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&s.setEnabled(e.isEnabled),s}}]),i}(Yi);ji._CreateDefaultParsedCamera=function(e,t){throw le("UniversalCamera")},ji.PERSPECTIVE_CAMERA=0,ji.ORTHOGRAPHIC_CAMERA=1,ji.FOVMODE_VERTICAL_FIXED=0,ji.FOVMODE_HORIZONTAL_FIXED=1,ji.RIG_MODE_NONE=0,ji.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,ji.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,ji.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,ji.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,ji.RIG_MODE_STEREOSCOPIC_INTERLACED=14,ji.RIG_MODE_VR=20,ji.RIG_MODE_WEBVR=21,ji.RIG_MODE_CUSTOM=22,ji.ForceAttachControlToAlwaysPreventDefault=!1,Nt([Yt("position")],ji.prototype,"_position",void 0),Nt([Yt("upVector")],ji.prototype,"_upVector",void 0),Nt([Xt()],ji.prototype,"orthoLeft",null),Nt([Xt()],ji.prototype,"orthoRight",null),Nt([Xt()],ji.prototype,"orthoBottom",null),Nt([Xt()],ji.prototype,"orthoTop",null),Nt([Xt()],ji.prototype,"fov",void 0),Nt([Xt()],ji.prototype,"projectionPlaneTilt",void 0),Nt([Xt()],ji.prototype,"minZ",void 0),Nt([Xt()],ji.prototype,"maxZ",void 0),Nt([Xt()],ji.prototype,"inertia",void 0),Nt([Xt()],ji.prototype,"mode",null),Nt([Xt()],ji.prototype,"layerMask",void 0),Nt([Xt()],ji.prototype,"fovMode",void 0),Nt([Xt()],ji.prototype,"cameraRigMode",void 0),Nt([Xt()],ji.prototype,"interaxialDistance",void 0),Nt([Xt()],ji.prototype,"isStereoscopicSideBySide",void 0);var Qi=function(){function e(){(0,m.Z)(this,e),this._applyTo=function(e,t){return function(){return Zi(e.apply(void 0,arguments),t)}}(this._applyToCoroutine.bind(this))}return(0,y.Z)(e,[{key:"set",value:function(e,t){switch(e.length||ue.Warn("Setting vertex data kind '".concat(t,"' with an empty array")),t){case ni.PositionKind:this.positions=e;break;case ni.NormalKind:this.normals=e;break;case ni.TangentKind:this.tangents=e;break;case ni.UVKind:this.uvs=e;break;case ni.UV2Kind:this.uvs2=e;break;case ni.UV3Kind:this.uvs3=e;break;case ni.UV4Kind:this.uvs4=e;break;case ni.UV5Kind:this.uvs5=e;break;case ni.UV6Kind:this.uvs6=e;break;case ni.ColorKind:this.colors=e;break;case ni.MatricesIndicesKind:this.matricesIndices=e;break;case ni.MatricesWeightsKind:this.matricesWeights=e;break;case ni.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case ni.MatricesWeightsExtraKind:this.matricesWeightsExtra=e}}},{key:"applyToMesh",value:function(e,t){return this._applyTo(e,t,!1),this}},{key:"applyToGeometry",value:function(e,t){return this._applyTo(e,t,!1),this}},{key:"updateMesh",value:function(e){return this._update(e),this}},{key:"updateGeometry",value:function(e){return this._update(e),this}},{key:"_applyToCoroutine",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;return(0,d.Z)().mark((function r(){return(0,d.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(r.t0=t.positions,!r.t0){r.next=7;break}if(e.setVerticesData(ni.PositionKind,t.positions,i),r.t1=n,!r.t1){r.next=7;break}return void(r.next=7);case 7:if(r.t2=t.normals,!r.t2){r.next=14;break}if(e.setVerticesData(ni.NormalKind,t.normals,i),r.t3=n,!r.t3){r.next=14;break}return void(r.next=14);case 14:if(r.t4=t.tangents,!r.t4){r.next=21;break}if(e.setVerticesData(ni.TangentKind,t.tangents,i),r.t5=n,!r.t5){r.next=21;break}return void(r.next=21);case 21:if(r.t6=t.uvs,!r.t6){r.next=28;break}if(e.setVerticesData(ni.UVKind,t.uvs,i),r.t7=n,!r.t7){r.next=28;break}return void(r.next=28);case 28:if(r.t8=t.uvs2,!r.t8){r.next=35;break}if(e.setVerticesData(ni.UV2Kind,t.uvs2,i),r.t9=n,!r.t9){r.next=35;break}return void(r.next=35);case 35:if(r.t10=t.uvs3,!r.t10){r.next=42;break}if(e.setVerticesData(ni.UV3Kind,t.uvs3,i),r.t11=n,!r.t11){r.next=42;break}return void(r.next=42);case 42:if(r.t12=t.uvs4,!r.t12){r.next=49;break}if(e.setVerticesData(ni.UV4Kind,t.uvs4,i),r.t13=n,!r.t13){r.next=49;break}return void(r.next=49);case 49:if(r.t14=t.uvs5,!r.t14){r.next=56;break}if(e.setVerticesData(ni.UV5Kind,t.uvs5,i),r.t15=n,!r.t15){r.next=56;break}return void(r.next=56);case 56:if(r.t16=t.uvs6,!r.t16){r.next=63;break}if(e.setVerticesData(ni.UV6Kind,t.uvs6,i),r.t17=n,!r.t17){r.next=63;break}return void(r.next=63);case 63:if(r.t18=t.colors,!r.t18){r.next=70;break}if(e.setVerticesData(ni.ColorKind,t.colors,i),r.t19=n,!r.t19){r.next=70;break}return void(r.next=70);case 70:if(r.t20=t.matricesIndices,!r.t20){r.next=77;break}if(e.setVerticesData(ni.MatricesIndicesKind,t.matricesIndices,i),r.t21=n,!r.t21){r.next=77;break}return void(r.next=77);case 77:if(r.t22=t.matricesWeights,!r.t22){r.next=84;break}if(e.setVerticesData(ni.MatricesWeightsKind,t.matricesWeights,i),r.t23=n,!r.t23){r.next=84;break}return void(r.next=84);case 84:if(r.t24=t.matricesIndicesExtra,!r.t24){r.next=91;break}if(e.setVerticesData(ni.MatricesIndicesExtraKind,t.matricesIndicesExtra,i),r.t25=n,!r.t25){r.next=91;break}return void(r.next=91);case 91:if(r.t26=t.matricesWeightsExtra,!r.t26){r.next=98;break}if(e.setVerticesData(ni.MatricesWeightsExtraKind,t.matricesWeightsExtra,i),r.t27=n,!r.t27){r.next=98;break}return void(r.next=98);case 98:if(!t.indices){r.next=106;break}if(e.setIndices(t.indices,null,i),r.t28=n,!r.t28){r.next=104;break}return void(r.next=104);case 104:r.next=107;break;case 106:e.setIndices([],null);case 107:return r.abrupt("return",t);case 108:case"end":return r.stop()}}),r)}))()}},{key:"_update",value:function(e,t,i){return this.positions&&e.updateVerticesData(ni.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(ni.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(ni.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(ni.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(ni.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(ni.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(ni.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(ni.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(ni.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(ni.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(ni.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(ni.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(ni.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(ni.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}},{key:"transform",value:function(t){var i=t.determinant()<0;return this.positions&&e._TransformVector3Coordinates(this.positions,t),this.normals&&e._TransformVector3Normals(this.normals,t),this.tangents&&e._TransformVector4Normals(this.tangents,t),i&&this.indices&&e._FlipFaces(this.indices),this}},{key:"merge",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=Array.isArray(e)?e.map((function(e){return[e,void 0]})):[[e,void 0]];return Zi(this._mergeCoroutine(void 0,n,t,!1,i))}},{key:"_mergeCoroutine",value:function(t,i){var n=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0;return(0,d.Z)().mark((function o(){var l,u,h,c,f,v,g,m,y,T,E,S,b,x,M,A,R,C,I;return(0,d.Z)().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:n._validate(),f=i.map((function(e){return e[0]})),v=(0,p.Z)(f),o.prev=3,v.s();case 5:if((g=v.n()).done){o.next=11;break}if((m=g.value)._validate(),!n.normals==!m.normals&&!n.tangents==!m.tangents&&!n.uvs==!m.uvs&&!n.uvs2==!m.uvs2&&!n.uvs3==!m.uvs3&&!n.uvs4==!m.uvs4&&!n.uvs5==!m.uvs5&&!n.uvs6==!m.uvs6&&!n.colors==!m.colors&&!n.matricesIndices==!m.matricesIndices&&!n.matricesWeights==!m.matricesWeights&&!n.matricesIndicesExtra==!m.matricesIndicesExtra&&!n.matricesWeightsExtra==!m.matricesWeightsExtra){o.next=9;break}throw new Error("Cannot merge vertex data that do not have the same set of attributes");case 9:o.next=5;break;case 11:o.next=16;break;case 13:o.prev=13,o.t0=o.catch(3),v.e(o.t0);case 16:return o.prev=16,v.f(),o.finish(16);case 19:if(y=f.reduce((function(e,t){var i,n;return e+(null!==(n=null===(i=t.indices)||void 0===i?void 0:i.length)&&void 0!==n?n:0)}),null!==(u=null===(l=n.indices)||void 0===l?void 0:l.length)&&void 0!==u?u:0),T=a||f.some((function(e){return e.indices===n.indices}))?null===(h=n.indices)||void 0===h?void 0:h.slice():n.indices,!(y>0)){o.next=49;break}E=null!==(c=null==T?void 0:T.length)&&void 0!==c?c:0,T||(T=new Array(y)),T.length!==y&&(Array.isArray(T)?T.length=y:((S=r||T instanceof Uint32Array?new Uint32Array(y):new Uint16Array(y)).set(T),T=S),t&&t.determinant()<0&&e._FlipFaces(T,0,E)),b=n.positions?n.positions.length/3:0,x=(0,p.Z)(i),o.prev=26,x.s();case 28:if((M=x.n()).done){o.next=41;break}if(A=(0,_.Z)(M.value,2),R=A[0],C=A[1],!R.indices){o.next=39;break}for(I=0;I<R.indices.length;I++)T[E+I]=R.indices[I]+b;if(C&&C.determinant()<0&&e._FlipFaces(T,E,R.indices.length),b+=R.positions.length/3,E+=R.indices.length,o.t1=s,!o.t1){o.next=39;break}return void(o.next=39);case 39:o.next=28;break;case 41:o.next=46;break;case 43:o.prev=43,o.t2=o.catch(26),x.e(o.t2);case 46:return o.prev=46,x.f(),o.finish(46);case 49:if(n.indices=T,n.positions=e._MergeElement(ni.PositionKind,n.positions,t,i.map((function(e){return[e[0].positions,e[1]]}))),o.t3=s,!o.t3){o.next=55;break}return void(o.next=55);case 55:if(n.normals=e._MergeElement(ni.NormalKind,n.normals,t,i.map((function(e){return[e[0].normals,e[1]]}))),o.t4=s,!o.t4){o.next=60;break}return void(o.next=60);case 60:if(n.tangents=e._MergeElement(ni.TangentKind,n.tangents,t,i.map((function(e){return[e[0].tangents,e[1]]}))),o.t5=s,!o.t5){o.next=65;break}return void(o.next=65);case 65:if(n.uvs=e._MergeElement(ni.UVKind,n.uvs,t,i.map((function(e){return[e[0].uvs,e[1]]}))),o.t6=s,!o.t6){o.next=70;break}return void(o.next=70);case 70:if(n.uvs2=e._MergeElement(ni.UV2Kind,n.uvs2,t,i.map((function(e){return[e[0].uvs2,e[1]]}))),o.t7=s,!o.t7){o.next=75;break}return void(o.next=75);case 75:if(n.uvs3=e._MergeElement(ni.UV3Kind,n.uvs3,t,i.map((function(e){return[e[0].uvs3,e[1]]}))),o.t8=s,!o.t8){o.next=80;break}return void(o.next=80);case 80:if(n.uvs4=e._MergeElement(ni.UV4Kind,n.uvs4,t,i.map((function(e){return[e[0].uvs4,e[1]]}))),o.t9=s,!o.t9){o.next=85;break}return void(o.next=85);case 85:if(n.uvs5=e._MergeElement(ni.UV5Kind,n.uvs5,t,i.map((function(e){return[e[0].uvs5,e[1]]}))),o.t10=s,!o.t10){o.next=90;break}return void(o.next=90);case 90:if(n.uvs6=e._MergeElement(ni.UV6Kind,n.uvs6,t,i.map((function(e){return[e[0].uvs6,e[1]]}))),o.t11=s,!o.t11){o.next=95;break}return void(o.next=95);case 95:if(n.colors=e._MergeElement(ni.ColorKind,n.colors,t,i.map((function(e){return[e[0].colors,e[1]]}))),o.t12=s,!o.t12){o.next=100;break}return void(o.next=100);case 100:if(n.matricesIndices=e._MergeElement(ni.MatricesIndicesKind,n.matricesIndices,t,i.map((function(e){return[e[0].matricesIndices,e[1]]}))),o.t13=s,!o.t13){o.next=105;break}return void(o.next=105);case 105:if(n.matricesWeights=e._MergeElement(ni.MatricesWeightsKind,n.matricesWeights,t,i.map((function(e){return[e[0].matricesWeights,e[1]]}))),o.t14=s,!o.t14){o.next=110;break}return void(o.next=110);case 110:if(n.matricesIndicesExtra=e._MergeElement(ni.MatricesIndicesExtraKind,n.matricesIndicesExtra,t,i.map((function(e){return[e[0].matricesIndicesExtra,e[1]]}))),o.t15=s,!o.t15){o.next=115;break}return void(o.next=115);case 115:return n.matricesWeightsExtra=e._MergeElement(ni.MatricesWeightsExtraKind,n.matricesWeightsExtra,t,i.map((function(e){return[e[0].matricesWeightsExtra,e[1]]}))),o.abrupt("return",n);case 117:case"end":return o.stop()}}),o,null,[[3,13,16,19],[26,43,46,49]])}))()}},{key:"_validate",value:function(){if(!this.positions)throw new at("Positions are required",tt);var e=function(e,t){var i=ni.DeduceStride(e);if(t.length%i!==0)throw new Error("The "+e+"s array count must be a multiple of "+i);return t.length/i},t=e(ni.PositionKind,this.positions),i=function(i,n){var r=e(i,n);if(r!==t)throw new Error("The "+i+"s element count ("+r+") does not match the positions count ("+t+")")};this.normals&&i(ni.NormalKind,this.normals),this.tangents&&i(ni.TangentKind,this.tangents),this.uvs&&i(ni.UVKind,this.uvs),this.uvs2&&i(ni.UV2Kind,this.uvs2),this.uvs3&&i(ni.UV3Kind,this.uvs3),this.uvs4&&i(ni.UV4Kind,this.uvs4),this.uvs5&&i(ni.UV5Kind,this.uvs5),this.uvs6&&i(ni.UV6Kind,this.uvs6),this.colors&&i(ni.ColorKind,this.colors),this.matricesIndices&&i(ni.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(ni.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(ni.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(ni.MatricesWeightsExtraKind,this.matricesWeightsExtra)}},{key:"serialize",value:function(){var e={};return this.positions&&(e.positions=this.positions),this.normals&&(e.normals=this.normals),this.tangents&&(e.tangents=this.tangents),this.uvs&&(e.uvs=this.uvs),this.uvs2&&(e.uvs2=this.uvs2),this.uvs3&&(e.uvs3=this.uvs3),this.uvs4&&(e.uvs4=this.uvs4),this.uvs5&&(e.uvs5=this.uvs5),this.uvs6&&(e.uvs6=this.uvs6),this.colors&&(e.colors=this.colors),this.matricesIndices&&(e.matricesIndices=this.matricesIndices,e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(e.matricesIndicesExtra=this.matricesIndicesExtra,e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=this.matricesWeightsExtra),e.indices=this.indices,e}}],[{key:"_TransformVector3Coordinates",value:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.length,r=Y.Vector3[0],s=Y.Vector3[1],a=i;a<i+n;a+=3)z.FromArrayToRef(e,a,r),z.TransformCoordinatesToRef(r,t,s),e[a]=s.x,e[a+1]=s.y,e[a+2]=s.z}},{key:"_TransformVector3Normals",value:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.length,r=Y.Vector3[0],s=Y.Vector3[1],a=i;a<i+n;a+=3)z.FromArrayToRef(e,a,r),z.TransformNormalToRef(r,t,s),e[a]=s.x,e[a+1]=s.y,e[a+2]=s.z}},{key:"_TransformVector4Normals",value:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.length,r=Y.Vector4[0],s=Y.Vector4[1],a=i;a<i+n;a+=4)X.FromArrayToRef(e,a,r),X.TransformNormalToRef(r,t,s),e[a]=s.x,e[a+1]=s.y,e[a+2]=s.z,e[a+3]=s.w}},{key:"_FlipFaces",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length,n=t;n<t+i;n+=3){var r=e[n+1];e[n+1]=e[n+2],e[n+2]=r}}},{key:"_MergeElement",value:function(t,i,n,r){var s=r.filter((function(e){return null!==e[0]&&void 0!==e[0]}));if(!i&&0==s.length)return i;if(!i)return this._MergeElement(t,s[0][0],s[0][1],s.slice(1));var a=s.reduce((function(e,t){return e+t[0].length}),i.length),o=t===ni.PositionKind?e._TransformVector3Coordinates:t===ni.NormalKind?e._TransformVector3Normals:t===ni.TangentKind?e._TransformVector4Normals:function(){};if(i instanceof Float32Array){var l=new Float32Array(a);l.set(i),n&&o(l,n,0,i.length);var u,h=i.length,c=(0,p.Z)(s);try{for(c.s();!(u=c.n()).done;){var d=(0,_.Z)(u.value,2),f=d[0],v=d[1];l.set(f,h),v&&o(l,v,h,f.length),h+=f.length}}catch(A){c.e(A)}finally{c.f()}return l}for(var g=new Array(a),m=0;m<i.length;m++)g[m]=i[m];n&&o(g,n,0,i.length);var y,T=i.length,E=(0,p.Z)(s);try{for(E.s();!(y=E.n()).done;){for(var S=(0,_.Z)(y.value,2),b=S[0],x=S[1],M=0;M<b.length;M++)g[T+M]=b[M];x&&o(g,x,T,b.length),T+=b.length}}catch(A){E.e(A)}finally{E.f()}return g}},{key:"ExtractFromMesh",value:function(t,i,n){return e._ExtractFrom(t,i,n)}},{key:"ExtractFromGeometry",value:function(t,i,n){return e._ExtractFrom(t,i,n)}},{key:"_ExtractFrom",value:function(t,i,n){var r=new e;return t.isVerticesDataPresent(ni.PositionKind)&&(r.positions=t.getVerticesData(ni.PositionKind,i,n)),t.isVerticesDataPresent(ni.NormalKind)&&(r.normals=t.getVerticesData(ni.NormalKind,i,n)),t.isVerticesDataPresent(ni.TangentKind)&&(r.tangents=t.getVerticesData(ni.TangentKind,i,n)),t.isVerticesDataPresent(ni.UVKind)&&(r.uvs=t.getVerticesData(ni.UVKind,i,n)),t.isVerticesDataPresent(ni.UV2Kind)&&(r.uvs2=t.getVerticesData(ni.UV2Kind,i,n)),t.isVerticesDataPresent(ni.UV3Kind)&&(r.uvs3=t.getVerticesData(ni.UV3Kind,i,n)),t.isVerticesDataPresent(ni.UV4Kind)&&(r.uvs4=t.getVerticesData(ni.UV4Kind,i,n)),t.isVerticesDataPresent(ni.UV5Kind)&&(r.uvs5=t.getVerticesData(ni.UV5Kind,i,n)),t.isVerticesDataPresent(ni.UV6Kind)&&(r.uvs6=t.getVerticesData(ni.UV6Kind,i,n)),t.isVerticesDataPresent(ni.ColorKind)&&(r.colors=t.getVerticesData(ni.ColorKind,i,n)),t.isVerticesDataPresent(ni.MatricesIndicesKind)&&(r.matricesIndices=t.getVerticesData(ni.MatricesIndicesKind,i,n)),t.isVerticesDataPresent(ni.MatricesWeightsKind)&&(r.matricesWeights=t.getVerticesData(ni.MatricesWeightsKind,i,n)),t.isVerticesDataPresent(ni.MatricesIndicesExtraKind)&&(r.matricesIndicesExtra=t.getVerticesData(ni.MatricesIndicesExtraKind,i,n)),t.isVerticesDataPresent(ni.MatricesWeightsExtraKind)&&(r.matricesWeightsExtra=t.getVerticesData(ni.MatricesWeightsExtraKind,i,n)),r.indices=t.getIndices(i,n),r}},{key:"CreateRibbon",value:function(e){throw le("ribbonBuilder")}},{key:"CreateBox",value:function(e){throw le("boxBuilder")}},{key:"CreateTiledBox",value:function(e){throw le("tiledBoxBuilder")}},{key:"CreateTiledPlane",value:function(e){throw le("tiledPlaneBuilder")}},{key:"CreateSphere",value:function(e){throw le("sphereBuilder")}},{key:"CreateCylinder",value:function(e){throw le("cylinderBuilder")}},{key:"CreateTorus",value:function(e){throw le("torusBuilder")}},{key:"CreateLineSystem",value:function(e){throw le("linesBuilder")}},{key:"CreateDashedLines",value:function(e){throw le("linesBuilder")}},{key:"CreateGround",value:function(e){throw le("groundBuilder")}},{key:"CreateTiledGround",value:function(e){throw le("groundBuilder")}},{key:"CreateGroundFromHeightMap",value:function(e){throw le("groundBuilder")}},{key:"CreatePlane",value:function(e){throw le("planeBuilder")}},{key:"CreateDisc",value:function(e){throw le("discBuilder")}},{key:"CreatePolygon",value:function(e,t,i,n,r,s,a){throw le("polygonBuilder")}},{key:"CreateIcoSphere",value:function(e){throw le("icoSphereBuilder")}},{key:"CreatePolyhedron",value:function(e){throw le("polyhedronBuilder")}},{key:"CreateCapsule",value:function(){arguments.length>0&&void 0!==arguments[0]||z.Up();throw le("capsuleBuilder")}},{key:"CreateTorusKnot",value:function(e){throw le("torusKnotBuilder")}},{key:"ComputeNormals",value:function(e,t,i,n){var r=0,s=0,a=0,o=0,l=0,u=0,h=0,c=0,d=0,f=0,_=0,v=0,g=0,p=0,m=0,y=0,T=0,E=0,S=0,b=0,x=!1,M=!1,A=!1,R=!1,C=1,I=0,P=null;n&&(x=!!n.facetNormals,M=!!n.facetPositions,A=!!n.facetPartitioning,C=!0===n.useRightHandedSystem?-1:1,I=n.ratio||0,R=!!n.depthSort,P=n.distanceTo,R&&void 0===P&&(P=z.Zero()));var k=0,D=0,F=0,w=0;for(A&&n&&n.bbSize&&(k=n.subDiv.X*I/n.bbSize.x,D=n.subDiv.Y*I/n.bbSize.y,F=n.subDiv.Z*I/n.bbSize.z,w=n.subDiv.max*n.subDiv.max,n.facetPartitioning.length=0),r=0;r<e.length;r++)i[r]=0;var O=t.length/3|0;for(r=0;r<O;r++){if(g=(v=3*t[3*r])+1,p=v+2,y=(m=3*t[3*r+1])+1,T=m+2,S=(E=3*t[3*r+2])+1,b=E+2,s=e[v]-e[m],a=e[g]-e[y],o=e[p]-e[T],l=e[E]-e[m],u=e[S]-e[y],c=C*(a*(h=e[b]-e[T])-o*u),d=C*(o*l-s*h),f=C*(s*u-a*l),c/=_=0===(_=Math.sqrt(c*c+d*d+f*f))?1:_,d/=_,f/=_,x&&n&&(n.facetNormals[r].x=c,n.facetNormals[r].y=d,n.facetNormals[r].z=f),M&&n&&(n.facetPositions[r].x=(e[v]+e[m]+e[E])/3,n.facetPositions[r].y=(e[g]+e[y]+e[S])/3,n.facetPositions[r].z=(e[p]+e[T]+e[b])/3),A&&n){var L=Math.floor((n.facetPositions[r].x-n.bInfo.minimum.x*I)*k),N=Math.floor((n.facetPositions[r].y-n.bInfo.minimum.y*I)*D),B=Math.floor((n.facetPositions[r].z-n.bInfo.minimum.z*I)*F),U=Math.floor((e[v]-n.bInfo.minimum.x*I)*k),V=Math.floor((e[g]-n.bInfo.minimum.y*I)*D),G=Math.floor((e[p]-n.bInfo.minimum.z*I)*F),W=Math.floor((e[m]-n.bInfo.minimum.x*I)*k),X=Math.floor((e[y]-n.bInfo.minimum.y*I)*D),H=Math.floor((e[T]-n.bInfo.minimum.z*I)*F),Z=Math.floor((e[E]-n.bInfo.minimum.x*I)*k),K=Math.floor((e[S]-n.bInfo.minimum.y*I)*D),Y=Math.floor((e[b]-n.bInfo.minimum.z*I)*F),q=U+n.subDiv.max*V+w*G,j=W+n.subDiv.max*X+w*H,Q=Z+n.subDiv.max*K+w*Y,J=L+n.subDiv.max*N+w*B;n.facetPartitioning[J]=n.facetPartitioning[J]?n.facetPartitioning[J]:new Array,n.facetPartitioning[q]=n.facetPartitioning[q]?n.facetPartitioning[q]:new Array,n.facetPartitioning[j]=n.facetPartitioning[j]?n.facetPartitioning[j]:new Array,n.facetPartitioning[Q]=n.facetPartitioning[Q]?n.facetPartitioning[Q]:new Array,n.facetPartitioning[q].push(r),j!=q&&n.facetPartitioning[j].push(r),Q==j||Q==q||n.facetPartitioning[Q].push(r),J==q||J==j||J==Q||n.facetPartitioning[J].push(r)}if(R&&n&&n.facetPositions){var $=n.depthSortedFacets[r];$.ind=3*r,$.sqDistance=z.DistanceSquared(n.facetPositions[r],P)}i[v]+=c,i[g]+=d,i[p]+=f,i[m]+=c,i[y]+=d,i[T]+=f,i[E]+=c,i[S]+=d,i[b]+=f}for(r=0;r<i.length/3;r++)c=i[3*r],d=i[3*r+1],f=i[3*r+2],c/=_=0===(_=Math.sqrt(c*c+d*d+f*f))?1:_,d/=_,f/=_,i[3*r]=c,i[3*r+1]=d,i[3*r+2]=f}},{key:"_ComputeSides",value:function(t,i,n,r,s,a,o){var l,u,h=n.length,c=r.length;switch(t=t||e.DEFAULTSIDE){case e.FRONTSIDE:break;case e.BACKSIDE:for(l=0;l<h;l+=3){var d=n[l];n[l]=n[l+2],n[l+2]=d}for(u=0;u<c;u++)r[u]=-r[u];break;case e.DOUBLESIDE:for(var f=i.length,_=f/3,v=0;v<f;v++)i[f+v]=i[v];for(l=0;l<h;l+=3)n[l+h]=n[l+2]+_,n[l+1+h]=n[l+1]+_,n[l+2+h]=n[l]+_;for(u=0;u<c;u++)r[c+u]=-r[u];var g=s.length,p=0;for(p=0;p<g;p++)s[p+g]=s[p];for(a=a||new X(0,0,1,1),o=o||new X(0,0,1,1),p=0,l=0;l<g/2;l++)s[p]=a.x+(a.z-a.x)*s[p],s[p+1]=a.y+(a.w-a.y)*s[p+1],s[p+g]=o.x+(o.z-o.x)*s[p+g],s[p+g+1]=o.y+(o.w-o.y)*s[p+g+1],p+=2}}},{key:"ImportVertexData",value:function(t,i){var n=new e,r=t.positions;r&&n.set(r,ni.PositionKind);var s=t.normals;s&&n.set(s,ni.NormalKind);var a=t.tangents;a&&n.set(a,ni.TangentKind);var o=t.uvs;o&&n.set(o,ni.UVKind);var l=t.uv2s;l&&n.set(l,ni.UV2Kind);var u=t.uv3s;u&&n.set(u,ni.UV3Kind);var h=t.uv4s;h&&n.set(h,ni.UV4Kind);var c=t.uv5s;c&&n.set(c,ni.UV5Kind);var d=t.uv6s;d&&n.set(d,ni.UV6Kind);var f=t.colors;f&&n.set(Ke.CheckColors4(f,r.length/3),ni.ColorKind);var _=t.matricesIndices;_&&n.set(_,ni.MatricesIndicesKind);var v=t.matricesWeights;v&&n.set(v,ni.MatricesWeightsKind);var g=t.indices;g&&(n.indices=g),i.setAllVerticesData(n,t.updatable)}}]),e}();Qi.FRONTSIDE=0,Qi.BACKSIDE=1,Qi.DOUBLESIDE=2,Qi.DEFAULTSIDE=0,Nt([Qt.filter((function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[0];return!Array.isArray(n)}))],Qi,"_TransformVector3Coordinates",null),Nt([Qt.filter((function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[0];return!Array.isArray(n)}))],Qi,"_TransformVector3Normals",null),Nt([Qt.filter((function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[0];return!Array.isArray(n)}))],Qi,"_TransformVector4Normals",null),Nt([Qt.filter((function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[0];return!Array.isArray(n)}))],Qi,"_FlipFaces",null);var Ji=(0,y.Z)((function e(t,i,n){(0,m.Z)(this,e),this.bu=t,this.bv=i,this.distance=n,this.faceId=0,this.subMeshId=0})),$i=function(){function e(t,i,n){(0,m.Z)(this,e),this.vectors=F.BuildArray(8,z.Zero),this.center=z.Zero(),this.centerWorld=z.Zero(),this.extendSize=z.Zero(),this.extendSizeWorld=z.Zero(),this.directions=F.BuildArray(3,z.Zero),this.vectorsWorld=F.BuildArray(8,z.Zero),this.minimumWorld=z.Zero(),this.maximumWorld=z.Zero(),this.minimum=z.Zero(),this.maximum=z.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(t,i,n)}return(0,y.Z)(e,[{key:"reConstruct",value:function(e,t,i){var n=e.x,r=e.y,s=e.z,a=t.x,o=t.y,l=t.z,u=this.vectors;this.minimum.copyFromFloats(n,r,s),this.maximum.copyFromFloats(a,o,l),u[0].copyFromFloats(n,r,s),u[1].copyFromFloats(a,o,l),u[2].copyFromFloats(a,r,s),u[3].copyFromFloats(n,o,s),u[4].copyFromFloats(n,r,l),u[5].copyFromFloats(a,o,s),u[6].copyFromFloats(n,o,l),u[7].copyFromFloats(a,r,l),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||Z.IdentityReadOnly,this._update(this._worldMatrix)}},{key:"scale",value:function(t){var i=e._TmpVector3,n=this.maximum.subtractToRef(this.minimum,i[0]),r=n.length();n.normalizeFromLength(r);var s=r*t,a=n.scaleInPlace(.5*s),o=this.center.subtractToRef(a,i[1]),l=this.center.addToRef(a,i[2]);return this.reConstruct(o,l,this._worldMatrix),this}},{key:"getWorldMatrix",value:function(){return this._worldMatrix}},{key:"_update",value:function(e){var t=this.minimumWorld,i=this.maximumWorld,n=this.directions,r=this.vectorsWorld,s=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(var a=0;a<8;++a)r[a].copyFrom(s[a]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(var o=0;o<8;++o){var l=r[o];z.TransformCoordinatesToRef(s[o],e,l),t.minimizeInPlace(l),i.maximizeInPlace(l)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}z.FromArrayToRef(e.m,0,n[0]),z.FromArrayToRef(e.m,4,n[1]),z.FromArrayToRef(e.m,8,n[2]),this._worldMatrix=e}},{key:"isInFrustum",value:function(t){return e.IsInFrustum(this.vectorsWorld,t)}},{key:"isCompletelyInFrustum",value:function(t){return e.IsCompletelyInFrustum(this.vectorsWorld,t)}},{key:"intersectsPoint",value:function(e){var t=this.minimumWorld,i=this.maximumWorld,n=t.x,r=t.y,s=t.z,a=i.x,o=i.y,l=i.z,u=e.x,h=e.y,c=e.z,d=-D;return!(a-u<d||d>u-n||o-h<d||d>h-r||l-c<d||d>c-s)}},{key:"intersectsSphere",value:function(t){return e.IntersectsSphere(this.minimumWorld,this.maximumWorld,t.centerWorld,t.radiusWorld)}},{key:"intersectsMinMax",value:function(e,t){var i=this.minimumWorld,n=this.maximumWorld,r=i.x,s=i.y,a=i.z,o=n.x,l=n.y,u=n.z,h=e.x,c=e.y,d=e.z,f=t.x,_=t.y,v=t.z;return!(o<h||r>f||l<c||s>_||u<d||a>v)}},{key:"dispose",value:function(){var e,t;null===(e=this._drawWrapperFront)||void 0===e||e.dispose(),null===(t=this._drawWrapperBack)||void 0===t||t.dispose()}}],[{key:"Intersects",value:function(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}},{key:"IntersectsSphere",value:function(t,i,n,r){var s=e._TmpVector3[0];return z.ClampToRef(n,t,i,s),z.DistanceSquared(n,s)<=r*r}},{key:"IsCompletelyInFrustum",value:function(e,t){for(var i=0;i<6;++i)for(var n=t[i],r=0;r<8;++r)if(n.dotCoordinate(e[r])<0)return!1;return!0}},{key:"IsInFrustum",value:function(e,t){for(var i=0;i<6;++i){for(var n=!0,r=t[i],s=0;s<8;++s)if(r.dotCoordinate(e[s])>=0){n=!1;break}if(n)return!1}return!0}}]),e}();$i._TmpVector3=F.BuildArray(3,z.Zero);var en=function(){function e(t,i,n){(0,m.Z)(this,e),this.center=z.Zero(),this.centerWorld=z.Zero(),this.minimum=z.Zero(),this.maximum=z.Zero(),this.reConstruct(t,i,n)}return(0,y.Z)(e,[{key:"reConstruct",value:function(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);var n=z.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=.5*n,this._update(i||Z.IdentityReadOnly)}},{key:"scale",value:function(t){var i=this.radius*t,n=e._TmpVector3,r=n[0].setAll(i),s=this.center.subtractToRef(r,n[1]),a=this.center.addToRef(r,n[2]);return this.reConstruct(s,a,this._worldMatrix),this}},{key:"getWorldMatrix",value:function(){return this._worldMatrix}},{key:"_update",value:function(t){if(t.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{z.TransformCoordinatesToRef(this.center,t,this.centerWorld);var i=e._TmpVector3[0];z.TransformNormalFromFloatsToRef(1,1,1,t,i),this.radiusWorld=Math.max(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z))*this.radius}}},{key:"isInFrustum",value:function(e){for(var t=this.centerWorld,i=this.radiusWorld,n=0;n<6;n++)if(e[n].dotCoordinate(t)<=-i)return!1;return!0}},{key:"isCenterInFrustum",value:function(e){for(var t=this.centerWorld,i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}},{key:"intersectsPoint",value:function(e){var t=z.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}}],[{key:"Intersects",value:function(e,t){var i=z.DistanceSquared(e.centerWorld,t.centerWorld),n=e.radiusWorld+t.radiusWorld;return!(n*n<i)}},{key:"CreateFromCenterAndRadius",value:function(t,i,n){this._TmpVector3[0].copyFrom(t),this._TmpVector3[1].copyFromFloats(0,0,i),this._TmpVector3[2].copyFrom(t),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);var r=new e(this._TmpVector3[0],this._TmpVector3[2]);return r._worldMatrix=n||Z.Identity(),r}}]),e}();en._TmpVector3=F.BuildArray(3,z.Zero);var tn={min:0,max:0},nn={min:0,max:0},rn=function(e,t,i){var n=z.Dot(t.centerWorld,e),r=Math.abs(z.Dot(t.directions[0],e))*t.extendSize.x+Math.abs(z.Dot(t.directions[1],e))*t.extendSize.y+Math.abs(z.Dot(t.directions[2],e))*t.extendSize.z;i.min=n-r,i.max=n+r},sn=function(e,t,i){return rn(e,t,tn),rn(e,i,nn),!(tn.min>nn.max||nn.min>tn.max)},an=function(){function e(t,i,n){(0,m.Z)(this,e),this._isLocked=!1,this.boundingBox=new $i(t,i,n),this.boundingSphere=new en(t,i,n)}return(0,y.Z)(e,[{key:"reConstruct",value:function(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}},{key:"minimum",get:function(){return this.boundingBox.minimum}},{key:"maximum",get:function(){return this.boundingBox.maximum}},{key:"isLocked",get:function(){return this._isLocked},set:function(e){this._isLocked=e}},{key:"update",value:function(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}},{key:"centerOn",value:function(t,i){var n=e._TmpVector3[0].copyFrom(t).subtractInPlace(i),r=e._TmpVector3[1].copyFrom(t).addInPlace(i);return this.boundingBox.reConstruct(n,r,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(n,r,this.boundingBox.getWorldMatrix()),this}},{key:"encapsulate",value:function(e){var t=z.Minimize(this.minimum,e),i=z.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}},{key:"encapsulateBoundingInfo",value:function(e){return this.encapsulate(e.boundingBox.centerWorld.subtract(e.boundingBox.extendSizeWorld)),this.encapsulate(e.boundingBox.centerWorld.add(e.boundingBox.extendSizeWorld)),this}},{key:"scale",value:function(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}},{key:"isInFrustum",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return!(2!==t&&3!==t||!this.boundingSphere.isCenterInFrustum(e))||!!this.boundingSphere.isInFrustum(e)&&(1===t||3===t||this.boundingBox.isInFrustum(e))}},{key:"diagonalLength",get:function(){var t=this.boundingBox;return t.maximumWorld.subtractToRef(t.minimumWorld,e._TmpVector3[0]).length()}},{key:"isCompletelyInFrustum",value:function(e){return this.boundingBox.isCompletelyInFrustum(e)}},{key:"_checkCollision",value:function(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}},{key:"intersectsPoint",value:function(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}},{key:"intersects",value:function(e,t){if(!en.Intersects(this.boundingSphere,e.boundingSphere)||!$i.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;var i=this.boundingBox,n=e.boundingBox;return!(!sn(i.directions[0],i,n)||!sn(i.directions[1],i,n)||!sn(i.directions[2],i,n)||!sn(n.directions[0],i,n)||!sn(n.directions[1],i,n)||!sn(n.directions[2],i,n)||!sn(z.Cross(i.directions[0],n.directions[0]),i,n)||!sn(z.Cross(i.directions[0],n.directions[1]),i,n)||!sn(z.Cross(i.directions[0],n.directions[2]),i,n)||!sn(z.Cross(i.directions[1],n.directions[0]),i,n)||!sn(z.Cross(i.directions[1],n.directions[1]),i,n)||!sn(z.Cross(i.directions[1],n.directions[2]),i,n)||!sn(z.Cross(i.directions[2],n.directions[0]),i,n)||!sn(z.Cross(i.directions[2],n.directions[1]),i,n)||!sn(z.Cross(i.directions[2],n.directions[2]),i,n))}}]),e}();an._TmpVector3=F.BuildArray(2,z.Zero);var on=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"extractMinAndMaxIndexed",value:function(e,t,i,n,r,s){for(var a=i;a<i+n;a++){var o=3*t[a],l=e[o],u=e[o+1],h=e[o+2];r.minimizeInPlaceFromFloats(l,u,h),s.maximizeInPlaceFromFloats(l,u,h)}}},{key:"extractMinAndMax",value:function(e,t,i,n,r,s){for(var a=t,o=t*n;a<t+i;a++,o+=n){var l=e[o],u=e[o+1],h=e[o+2];r.minimizeInPlaceFromFloats(l,u,h),s.maximizeInPlaceFromFloats(l,u,h)}}}]),e}();function ln(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4?arguments[4]:void 0,s=new z(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new z(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return r||(r=3),on.extractMinAndMax(e,t,i,r,s,a),n&&(s.x-=s.x*n.x+n.y,s.y-=s.y*n.x+n.y,s.z-=s.z*n.x+n.y,a.x+=a.x*n.x+n.y,a.y+=a.y*n.x+n.y,a.z+=a.z*n.x+n.y),{minimum:s,maximum:a}}Nt([Qt.filter((function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[0],r=t[1];return!Array.isArray(n)&&!Array.isArray(r)}))],on,"extractMinAndMaxIndexed",null),Nt([Qt.filter((function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[0];return!Array.isArray(n)}))],on,"extractMinAndMax",null);var un=function(){function e(t,i,n,r,s,a,o){var l=!(arguments.length>7&&void 0!==arguments[7])||arguments[7],u=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];(0,m.Z)(this,e),this.materialIndex=t,this.verticesStart=i,this.verticesCount=n,this.indexStart=r,this.indexCount=s,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=a,this._renderingMesh=o||a,u&&a.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=a.subMeshes.length-1,l&&(this.refreshBoundingInfo(),a.computeWorldMatrix(!0))}return(0,y.Z)(e,[{key:"materialDefines",get:function(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:null===(e=this._getDrawWrapper())||void 0===e?void 0:e.defines},set:function(e){var t;(null!==(t=this._mainDrawWrapperOverride)&&void 0!==t?t:this._getDrawWrapper(void 0,!0)).defines=e}},{key:"_getDrawWrapper",value:function(e){var t,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e=null!==(t=e)&&void 0!==t?t:this._engine.currentRenderPassId;var n=this._drawWrappers[e];return!n&&i&&(this._drawWrappers[e]=n=new Le(this._mesh.getScene().getEngine())),n}},{key:"_removeDrawWrapper",value:function(e){var t;(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&(null===(t=this._drawWrappers[e])||void 0===t||t.dispose()),this._drawWrappers[e]=void 0}},{key:"effect",get:function(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:null!==(t=null===(e=this._getDrawWrapper())||void 0===e?void 0:e.effect)&&void 0!==t?t:null}},{key:"_drawWrapper",get:function(){var e;return null!==(e=this._mainDrawWrapperOverride)&&void 0!==e?e:this._getDrawWrapper(void 0,!0)}},{key:"_drawWrapperOverride",get:function(){return this._mainDrawWrapperOverride}},{key:"_setMainDrawWrapperOverride",value:function(e){this._mainDrawWrapperOverride=e}},{key:"setEffect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2?arguments[2]:void 0,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=this._drawWrapper;r.setEffect(e,t,n),void 0!==i&&(r.materialContext=i),e||(r.defines=null,r.materialContext=void 0)}},{key:"resetDrawCache",value:function(e){if(this._drawWrappers){if(void 0!==e)return void this._removeDrawWrapper(e);var t,i=(0,p.Z)(this._drawWrappers);try{for(i.s();!(t=i.n()).done;){var n=t.value;null==n||n.dispose()}}catch(r){i.e(r)}finally{i.f()}}this._drawWrappers=[]}},{key:"IsGlobal",get:function(){return 0===this.verticesStart&&this.verticesCount===this._mesh.getTotalVertices()&&0===this.indexStart&&this.indexCount===this._mesh.getTotalIndices()}},{key:"getBoundingInfo",value:function(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo}},{key:"setBoundingInfo",value:function(e){return this._boundingInfo=e,this}},{key:"getMesh",value:function(){return this._mesh}},{key:"getRenderingMesh",value:function(){return this._renderingMesh}},{key:"getReplacementMesh",value:function(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}},{key:"getEffectiveMesh",value:function(){return(this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null)||this._renderingMesh}},{key:"getMaterial",value:function(){var e,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],i=null!==(e=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))&&void 0!==e?e:this._renderingMesh.material;if(!i)return t?this._mesh.getScene().defaultMaterial:null;if(this._isMultiMaterial(i)){var n=i.getSubMaterial(this.materialIndex);return this._currentMaterial!==n&&(this._currentMaterial=n,this.resetDrawCache()),n}return i}},{key:"_isMultiMaterial",value:function(e){return void 0!==e.getSubMaterial}},{key:"refreshBoundingInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(ni.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;var t,i=this._renderingMesh.getIndices();if(0===this.indexStart&&this.indexCount===i.length){var n=this._renderingMesh.getBoundingInfo();t={minimum:n.minimum.clone(),maximum:n.maximum.clone()}}else t=function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=new z(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new z(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return on.extractMinAndMaxIndexed(e,t,i,n,s,a),r&&(s.x-=s.x*r.x+r.y,s.y-=s.y*r.x+r.y,s.z-=s.z*r.x+r.y,a.x+=a.x*r.x+r.y,a.y+=a.y*r.x+r.y,a.z+=a.z*r.x+r.y),{minimum:s,maximum:a}}(e,i,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(t.minimum,t.maximum):this._boundingInfo=new an(t.minimum,t.maximum),this}},{key:"_checkCollision",value:function(e){return this.getBoundingInfo()._checkCollision(e)}},{key:"updateBoundingInfo",value:function(e){var t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}},{key:"isInFrustum",value:function(e){var t=this.getBoundingInfo();return!!t&&t.isInFrustum(e,this._mesh.cullingStrategy)}},{key:"isCompletelyInFrustum",value:function(e){var t=this.getBoundingInfo();return!!t&&t.isCompletelyInFrustum(e)}},{key:"render",value:function(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}},{key:"_getLinesIndexBuffer",value:function(e,t){if(!this._linesIndexBuffer){for(var i=[],n=this.indexStart;n<this.indexStart+this.indexCount;n+=3)i.push(e[n],e[n+1],e[n+1],e[n+2],e[n+2],e[n]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}},{key:"canIntersects",value:function(e){var t=this.getBoundingInfo();return!!t&&e.intersectsBox(t.boundingBox)}},{key:"intersects",value:function(e,t,i,n,r){var s=this.getMaterial();if(!s)return null;var a=3,o=!1;switch(s.fillMode){case 3:case 5:case 6:case 8:return null;case 7:a=1,o=!0}return 4===s.fillMode?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,n):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,n):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,n,r):this._intersectTriangles(e,t,i,a,o,n,r)}},{key:"_intersectLines",value:function(e,t,i,n,r){for(var s=null,a=this.indexStart;a<this.indexStart+this.indexCount;a+=2){var o=t[i[a]],l=t[i[a+1]],u=e.intersectionSegment(o,l,n);if(!(u<0)&&(r||!s||u<s.distance)&&((s=new Ji(null,null,u)).faceId=a/2,r))break}return s}},{key:"_intersectUnIndexedLines",value:function(e,t,i,n,r){for(var s=null,a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=2){var o=t[a],l=t[a+1],u=e.intersectionSegment(o,l,n);if(!(u<0)&&(r||!s||u<s.distance)&&((s=new Ji(null,null,u)).faceId=a/2,r))break}return s}},{key:"_intersectTriangles",value:function(e,t,i,n,r,s,a){for(var o=null,l=-1,u=this.indexStart;u<this.indexStart+this.indexCount-(3-n);u+=n){l++;var h=i[u],c=i[u+1],d=i[u+2];if(r&&4294967295===d)u+=2;else{var f=t[h],_=t[c],v=t[d];if(f&&_&&v&&(!a||a(f,_,v,e,h,c,d))){var g=e.intersectsTriangle(f,_,v);if(g){if(g.distance<0)continue;if((s||!o||g.distance<o.distance)&&((o=g).faceId=l,s))break}}}}return o}},{key:"_intersectUnIndexedTriangles",value:function(e,t,i,n,r){for(var s=null,a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=3){var o=t[a],l=t[a+1],u=t[a+2];if(!r||r(o,l,u,e,-1,-1,-1)){var h=e.intersectsTriangle(o,l,u);if(h){if(h.distance<0)continue;if((n||!s||h.distance<s.distance)&&((s=h).faceId=a/3,n))break}}}return s}},{key:"_rebuild",value:function(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}},{key:"clone",value:function(t,i){var n=new e(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,t,i,!1);if(!this.IsGlobal){var r=this.getBoundingInfo();if(!r)return n;n._boundingInfo=new an(r.minimum,r.maximum)}return n}},{key:"dispose",value:function(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);var e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}},{key:"getClassName",value:function(){return"SubMesh"}}],[{key:"AddToMesh",value:function(t,i,n,r,s,a,o){return new e(t,i,n,r,s,a,o,!(arguments.length>7&&void 0!==arguments[7])||arguments[7])}},{key:"CreateFromIndices",value:function(t,i,n,r,s){for(var a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=Number.MAX_VALUE,l=-Number.MAX_VALUE,u=(s||r).getIndices(),h=i;h<i+n;h++){var c=u[h];c<o&&(o=c),c>l&&(l=c)}return new e(t,o,l-o+1,i,n,r,s,a)}}]),e}(),hn=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"ForceFullSceneLoadingForIncremental",get:function(){return e._ForceFullSceneLoadingForIncremental},set:function(t){e._ForceFullSceneLoadingForIncremental=t}},{key:"ShowLoadingScreen",get:function(){return e._ShowLoadingScreen},set:function(t){e._ShowLoadingScreen=t}},{key:"loggingLevel",get:function(){return e._LoggingLevel},set:function(t){e._LoggingLevel=t}},{key:"CleanBoneMatrixWeights",get:function(){return e._CleanBoneMatrixWeights},set:function(t){e._CleanBoneMatrixWeights=t}}]),e}();hn._ForceFullSceneLoadingForIncremental=!1,hn._ShowLoadingScreen=!0,hn._CleanBoneMatrixWeights=!1,hn._LoggingLevel=0;var cn=(0,y.Z)((function e(){(0,m.Z)(this,e)}));cn.UseOpenGLOrientationForUV=!1;var dn,fn=function(){function e(t,i,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;(0,m.Z)(this,e),this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=i||V.LastCreatedScene,this._scene&&(this.id=t,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=r,n?this.setAllVerticesData(n,r):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),s&&(this.applyToMesh(s),s.computeWorldMatrix(!0)))}return(0,y.Z)(e,[{key:"boundingBias",get:function(){return this._boundingBias},set:function(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}},{key:"meshes",get:function(){return this._meshes}},{key:"extend",get:function(){return this._extend}},{key:"getScene",value:function(){return this._scene}},{key:"getEngine",value:function(){return this._engine}},{key:"isReady",value:function(){return 1===this.delayLoadState||0===this.delayLoadState}},{key:"doNotSerialize",get:function(){for(var e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}},{key:"_rebuild",value:function(){for(var e in this._vertexArrayObjects&&(this._vertexArrayObjects={}),0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),this._vertexBuffers)this._vertexBuffers[e]._rebuild()}},{key:"setAllVerticesData",value:function(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}},{key:"setVerticesData",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3?arguments[3]:void 0;i&&Array.isArray(t)&&(t=new Float32Array(t));var r=new ni(this._engine,t,e,i,0===this._meshes.length,n);this.setVerticesBuffer(r)}},{key:"removeVerticesData",value:function(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}},{key:"setVerticesBuffer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=e.getKind();this._vertexBuffers[n]&&i&&this._vertexBuffers[n].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[n]=e;var r=this._meshes,s=r.length;if(n===ni.PositionKind){var a=e.getData();null!=t?this._totalVertices=t:null!=a&&(this._totalVertices=a.length/(e.type===ni.BYTE?e.byteStride:e.byteStride/4)),this._updateExtend(a),this._resetPointsArrayCache();for(var o=0;o<s;o++){var l=r[o];l.buildBoundingInfo(this._extend.minimum,this._extend.maximum),l._createGlobalSubMesh(l.isUnIndexed),l.computeWorldMatrix(!0),l.synchronizeInstances()}}this._notifyUpdate(n)}},{key:"updateVerticesDataDirectly",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=this.getVertexBuffer(e);r&&(r.updateDirectly(t,i,n),this._notifyUpdate(e))}},{key:"updateVerticesData",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.getVertexBuffer(e);n&&(n.update(t),e===ni.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}},{key:"_updateBoundingInfo",value:function(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){var i,n=this._meshes,r=(0,p.Z)(n);try{for(r.s();!(i=r.n()).done;){var s=i.value;s.hasBoundingInfo?s.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):s.buildBoundingInfo(this._extend.minimum,this._extend.maximum);var a,o=s.subMeshes,l=(0,p.Z)(o);try{for(l.s();!(a=l.n()).done;){a.value.refreshBoundingInfo()}}catch(u){l.e(u)}finally{l.f()}}}catch(u){r.e(u)}finally{r.f()}}}},{key:"_bind",value:function(e,t,i,n){if(e){void 0===t&&(t=this._indexBuffer);var r=this.getVertexBuffers();if(r)if(t==this._indexBuffer&&(this._vertexArrayObjects||n)){var s=n||this._vertexArrayObjects;s[e.key]||(s[e.key]=this._engine.recordVertexArrayObject(r,t,e,i)),this._engine.bindVertexArrayObject(s[e.key],t)}else this._engine.bindBuffers(r,t,e,i)}}},{key:"getTotalVertices",value:function(){return this.isReady()?this._totalVertices:0}},{key:"getVerticesData",value:function(e,t,i){var n=this.getVertexBuffer(e);return n?n.getFloatData(this._totalVertices,i||t&&1!==this._meshes.length):null}},{key:"isVertexBufferUpdatable",value:function(e){var t=this._vertexBuffers[e];return!!t&&t.isUpdatable()}},{key:"getVertexBuffer",value:function(e){return this.isReady()?this._vertexBuffers[e]:null}},{key:"getVertexBuffers",value:function(){return this.isReady()?this._vertexBuffers:null}},{key:"isVerticesDataPresent",value:function(e){return this._vertexBuffers?void 0!==this._vertexBuffers[e]:!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}},{key:"getVerticesDataKinds",value:function(){var e,t=[];if(!this._vertexBuffers&&this._delayInfo)for(e in this._delayInfo)t.push(e);else for(e in this._vertexBuffers)t.push(e);return t}},{key:"updateIndices",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this._indexBuffer)if(this._indexBufferIsUpdatable){var n=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),n){var r,s=(0,p.Z)(this._meshes);try{for(s.s();!(r=s.n()).done;){r.value._createGlobalSubMesh(!0)}}catch(a){s.e(a)}finally{s.f()}}}else this.setIndices(e,null,!0)}},{key:"setIndices",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),null!=t&&(this._totalVertices=t);var n,r=(0,p.Z)(this._meshes);try{for(r.s();!(n=r.n()).done;){var s=n.value;s._createGlobalSubMesh(!0),s.synchronizeInstances()}}catch(a){r.e(a)}finally{r.f()}this._notifyUpdate()}},{key:"getTotalIndices",value:function(){return this.isReady()?this._indices.length:0}},{key:"getIndices",value:function(e,t){if(!this.isReady())return null;var i=this._indices;return t||e&&1!==this._meshes.length?i.slice():i}},{key:"getIndexBuffer",value:function(){return this.isReady()?this._indexBuffer:null}},{key:"_releaseVertexArrayObject",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}},{key:"releaseForMesh",value:function(e,t){var i=this._meshes,n=i.indexOf(e);-1!==n&&(i.splice(n,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,0===i.length&&t&&this.dispose())}},{key:"applyToMesh",value:function(e){if(e._geometry!==this){var t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();var i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}}},{key:"_updateExtend",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&!(e=this.getVerticesData(ni.PositionKind)))return;this._extend=ln(e,0,this._totalVertices,this.boundingBias,3)}}},{key:"_applyToMesh",value:function(e){var t=this._meshes.length;for(var i in this._vertexBuffers)1===t&&this._vertexBuffers[i].create(),i===ni.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());1===t&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}},{key:"_notifyUpdate",value:function(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();var t,i=(0,p.Z)(this._meshes);try{for(i.s();!(t=i.n()).done;){t.value._markSubMeshesAsAttributesDirty()}}catch(n){i.e(n)}finally{i.f()}}},{key:"load",value:function(e,t){if(2!==this.delayLoadState){if(this.isReady())return void(t&&t());this.delayLoadState=2,this._queueLoad(e,t)}}},{key:"_queueLoad",value:function(e,t){var i=this;this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,(function(n){if(i._delayLoadingFunction){i._delayLoadingFunction(JSON.parse(n),i),i.delayLoadState=1,i._delayInfo=[],e.removePendingData(i);for(var r=i._meshes,s=r.length,a=0;a<s;a++)i._applyToMesh(r[a]);t&&t()}}),void 0,!0))}},{key:"toLeftHanded",value:function(){var e=this.getIndices(!1);if(null!=e&&e.length>0){for(var t=0;t<e.length;t+=3){var i=e[t+0];e[t+0]=e[t+2],e[t+2]=i}this.setIndices(e)}var n=this.getVerticesData(ni.PositionKind,!1);if(null!=n&&n.length>0){for(var r=0;r<n.length;r+=3)n[r+2]=-n[r+2];this.setVerticesData(ni.PositionKind,n,!1)}var s=this.getVerticesData(ni.NormalKind,!1);if(null!=s&&s.length>0){for(var a=0;a<s.length;a+=3)s[a+2]=-s[a+2];this.setVerticesData(ni.NormalKind,s,!1)}}},{key:"_resetPointsArrayCache",value:function(){this._positions=null}},{key:"_generatePointsArray",value:function(){if(this._positions)return!0;var e=this.getVerticesData(ni.PositionKind);if(!e||0===e.length)return!1;for(var t=3*this._positionsCache.length,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=z.FromArray(e,t);for(var n=0,r=0;n<e.length;n+=3,++r)this._positionsCache[r].set(e[0+n],e[1+n],e[2+n]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}},{key:"isDisposed",value:function(){return this._isDisposed}},{key:"_disposeVertexArrayObjects",value:function(){if(this._vertexArrayObjects){for(var e in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e]);this._vertexArrayObjects={};for(var t=this._meshes,i=t.length,n=0;n<i;n++)t[n]._invalidateInstanceVertexArrayObject()}}},{key:"dispose",value:function(){var e,t=this._meshes,i=t.length;for(e=0;e<i;e++)this.releaseForMesh(t[e]);for(var n in this._meshes.length=0,this._disposeVertexArrayObjects(),this._vertexBuffers)this._vertexBuffers[n].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){var r=this._parentContainer.geometries.indexOf(this);r>-1&&this._parentContainer.geometries.splice(r,1),this._parentContainer=null}this._isDisposed=!0}},{key:"copy",value:function(t){var i=new Qi;i.indices=[];var n=this.getIndices();if(n)for(var r=0;r<n.length;r++)i.indices.push(n[r]);var s,a=!1,o=!1;for(s in this._vertexBuffers){var l=this.getVerticesData(s);if(l&&(l instanceof Float32Array?i.set(new Float32Array(l),s):i.set(l.slice(0),s),!o)){var u=this.getVertexBuffer(s);u&&(o=!(a=u.isUpdatable()))}}var h=new e(t,this._scene,i,a);for(s in h.delayLoadState=this.delayLoadState,h.delayLoadingFile=this.delayLoadingFile,h._delayLoadingFunction=this._delayLoadingFunction,this._delayInfo)h._delayInfo=h._delayInfo||[],h._delayInfo.push(s);return h._boundingInfo=new an(this._extend.minimum,this._extend.maximum),h}},{key:"serialize",value:function(){var e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,Ot&&Ot.HasTags(this)&&(e.tags=Ot.GetTags(this)),e}},{key:"_toNumberArray",value:function(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}},{key:"clearCachedData",value:function(){for(var e in this._indices=[],this._resetPointsArrayCache(),this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}},{key:"serializeVerticeData",value:function(){var e=this.serialize();return this.isVerticesDataPresent(ni.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(ni.PositionKind)),this.isVertexBufferUpdatable(ni.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(ni.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(ni.NormalKind)),this.isVertexBufferUpdatable(ni.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(ni.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(ni.TangentKind)),this.isVertexBufferUpdatable(ni.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(ni.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(ni.UVKind)),this.isVertexBufferUpdatable(ni.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(ni.UV2Kind)&&(e.uv2s=this._toNumberArray(this.getVerticesData(ni.UV2Kind)),this.isVertexBufferUpdatable(ni.UV2Kind)&&(e.uv2s._updatable=!0)),this.isVerticesDataPresent(ni.UV3Kind)&&(e.uv3s=this._toNumberArray(this.getVerticesData(ni.UV3Kind)),this.isVertexBufferUpdatable(ni.UV3Kind)&&(e.uv3s._updatable=!0)),this.isVerticesDataPresent(ni.UV4Kind)&&(e.uv4s=this._toNumberArray(this.getVerticesData(ni.UV4Kind)),this.isVertexBufferUpdatable(ni.UV4Kind)&&(e.uv4s._updatable=!0)),this.isVerticesDataPresent(ni.UV5Kind)&&(e.uv5s=this._toNumberArray(this.getVerticesData(ni.UV5Kind)),this.isVertexBufferUpdatable(ni.UV5Kind)&&(e.uv5s._updatable=!0)),this.isVerticesDataPresent(ni.UV6Kind)&&(e.uv6s=this._toNumberArray(this.getVerticesData(ni.UV6Kind)),this.isVertexBufferUpdatable(ni.UV6Kind)&&(e.uv6s._updatable=!0)),this.isVerticesDataPresent(ni.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(ni.ColorKind)),this.isVertexBufferUpdatable(ni.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(ni.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(ni.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(ni.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(ni.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(ni.MatricesWeightsKind)),this.isVertexBufferUpdatable(ni.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}}],[{key:"CreateGeometryForMesh",value:function(t){var i=new e(e.RandomId(),t.getScene());return i.applyToMesh(t),i}},{key:"ExtractFromMesh",value:function(e,t){var i=e._geometry;return i?i.copy(t):null}},{key:"RandomId",value:function(){return It.RandomId()}},{key:"_GetGeometryByLoadedUniqueId",value:function(e,t){for(var i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}},{key:"_ImportGeometry",value:function(t,i){var n=i.getScene(),r=t.geometryUniqueId,s=t.geometryId;if(r||s){var a=r?this._GetGeometryByLoadedUniqueId(r,n):n.getGeometryById(s);a&&a.applyToMesh(i)}else if(t instanceof ArrayBuffer){var o=i._binaryInfo;if(o.positionsAttrDesc&&o.positionsAttrDesc.count>0){var l=new Float32Array(t,o.positionsAttrDesc.offset,o.positionsAttrDesc.count);i.setVerticesData(ni.PositionKind,l,!1)}if(o.normalsAttrDesc&&o.normalsAttrDesc.count>0){var u=new Float32Array(t,o.normalsAttrDesc.offset,o.normalsAttrDesc.count);i.setVerticesData(ni.NormalKind,u,!1)}if(o.tangetsAttrDesc&&o.tangetsAttrDesc.count>0){var h=new Float32Array(t,o.tangetsAttrDesc.offset,o.tangetsAttrDesc.count);i.setVerticesData(ni.TangentKind,h,!1)}if(o.uvsAttrDesc&&o.uvsAttrDesc.count>0){var c=new Float32Array(t,o.uvsAttrDesc.offset,o.uvsAttrDesc.count);if(cn.UseOpenGLOrientationForUV)for(var d=1;d<c.length;d+=2)c[d]=1-c[d];i.setVerticesData(ni.UVKind,c,!1)}if(o.uvs2AttrDesc&&o.uvs2AttrDesc.count>0){var f=new Float32Array(t,o.uvs2AttrDesc.offset,o.uvs2AttrDesc.count);if(cn.UseOpenGLOrientationForUV)for(var _=1;_<f.length;_+=2)f[_]=1-f[_];i.setVerticesData(ni.UV2Kind,f,!1)}if(o.uvs3AttrDesc&&o.uvs3AttrDesc.count>0){var v=new Float32Array(t,o.uvs3AttrDesc.offset,o.uvs3AttrDesc.count);if(cn.UseOpenGLOrientationForUV)for(var g=1;g<v.length;g+=2)v[g]=1-v[g];i.setVerticesData(ni.UV3Kind,v,!1)}if(o.uvs4AttrDesc&&o.uvs4AttrDesc.count>0){var p=new Float32Array(t,o.uvs4AttrDesc.offset,o.uvs4AttrDesc.count);if(cn.UseOpenGLOrientationForUV)for(var m=1;m<p.length;m+=2)p[m]=1-p[m];i.setVerticesData(ni.UV4Kind,p,!1)}if(o.uvs5AttrDesc&&o.uvs5AttrDesc.count>0){var y=new Float32Array(t,o.uvs5AttrDesc.offset,o.uvs5AttrDesc.count);if(cn.UseOpenGLOrientationForUV)for(var T=1;T<y.length;T+=2)y[T]=1-y[T];i.setVerticesData(ni.UV5Kind,y,!1)}if(o.uvs6AttrDesc&&o.uvs6AttrDesc.count>0){var E=new Float32Array(t,o.uvs6AttrDesc.offset,o.uvs6AttrDesc.count);if(cn.UseOpenGLOrientationForUV)for(var S=1;S<E.length;S+=2)E[S]=1-E[S];i.setVerticesData(ni.UV6Kind,E,!1)}if(o.colorsAttrDesc&&o.colorsAttrDesc.count>0){var b=new Float32Array(t,o.colorsAttrDesc.offset,o.colorsAttrDesc.count);i.setVerticesData(ni.ColorKind,b,!1,o.colorsAttrDesc.stride)}if(o.matricesIndicesAttrDesc&&o.matricesIndicesAttrDesc.count>0){for(var x=new Int32Array(t,o.matricesIndicesAttrDesc.offset,o.matricesIndicesAttrDesc.count),M=[],A=0;A<x.length;A++){var R=x[A];M.push(255&R),M.push((65280&R)>>8),M.push((16711680&R)>>16),M.push(R>>24&255)}i.setVerticesData(ni.MatricesIndicesKind,M,!1)}if(o.matricesIndicesExtraAttrDesc&&o.matricesIndicesExtraAttrDesc.count>0){for(var C=new Int32Array(t,o.matricesIndicesExtraAttrDesc.offset,o.matricesIndicesExtraAttrDesc.count),I=[],P=0;P<C.length;P++){var k=C[P];I.push(255&k),I.push((65280&k)>>8),I.push((16711680&k)>>16),I.push(k>>24&255)}i.setVerticesData(ni.MatricesIndicesExtraKind,I,!1)}if(o.matricesWeightsAttrDesc&&o.matricesWeightsAttrDesc.count>0){var D=new Float32Array(t,o.matricesWeightsAttrDesc.offset,o.matricesWeightsAttrDesc.count);i.setVerticesData(ni.MatricesWeightsKind,D,!1)}if(o.indicesAttrDesc&&o.indicesAttrDesc.count>0){var F=new Int32Array(t,o.indicesAttrDesc.offset,o.indicesAttrDesc.count);i.setIndices(F,null)}if(o.subMeshesAttrDesc&&o.subMeshesAttrDesc.count>0){var w=new Int32Array(t,o.subMeshesAttrDesc.offset,5*o.subMeshesAttrDesc.count);i.subMeshes=[];for(var O=0;O<o.subMeshesAttrDesc.count;O++){var L=w[5*O+0],N=w[5*O+1],B=w[5*O+2],U=w[5*O+3],V=w[5*O+4];un.AddToMesh(L,N,B,U,V,i)}}}else if(t.positions&&t.normals&&t.indices){if(i.setVerticesData(ni.PositionKind,t.positions,t.positions._updatable),i.setVerticesData(ni.NormalKind,t.normals,t.normals._updatable),t.tangents&&i.setVerticesData(ni.TangentKind,t.tangents,t.tangents._updatable),t.uvs&&i.setVerticesData(ni.UVKind,t.uvs,t.uvs._updatable),t.uvs2&&i.setVerticesData(ni.UV2Kind,t.uvs2,t.uvs2._updatable),t.uvs3&&i.setVerticesData(ni.UV3Kind,t.uvs3,t.uvs3._updatable),t.uvs4&&i.setVerticesData(ni.UV4Kind,t.uvs4,t.uvs4._updatable),t.uvs5&&i.setVerticesData(ni.UV5Kind,t.uvs5,t.uvs5._updatable),t.uvs6&&i.setVerticesData(ni.UV6Kind,t.uvs6,t.uvs6._updatable),t.colors&&i.setVerticesData(ni.ColorKind,Ke.CheckColors4(t.colors,t.positions.length/3),t.colors._updatable),t.matricesIndices)if(t.matricesIndices._isExpanded)delete t.matricesIndices._isExpanded,i.setVerticesData(ni.MatricesIndicesKind,t.matricesIndices,t.matricesIndices._updatable);else{for(var G=[],W=0;W<t.matricesIndices.length;W++){var z=t.matricesIndices[W];G.push(255&z),G.push((65280&z)>>8),G.push((16711680&z)>>16),G.push(z>>24&255)}i.setVerticesData(ni.MatricesIndicesKind,G,t.matricesIndices._updatable)}if(t.matricesIndicesExtra)if(t.matricesIndicesExtra._isExpanded)delete t.matricesIndices._isExpanded,i.setVerticesData(ni.MatricesIndicesExtraKind,t.matricesIndicesExtra,t.matricesIndicesExtra._updatable);else{for(var X=[],H=0;H<t.matricesIndicesExtra.length;H++){var Z=t.matricesIndicesExtra[H];X.push(255&Z),X.push((65280&Z)>>8),X.push((16711680&Z)>>16),X.push(Z>>24&255)}i.setVerticesData(ni.MatricesIndicesExtraKind,X,t.matricesIndicesExtra._updatable)}t.matricesWeights&&(e._CleanMatricesWeights(t,i),i.setVerticesData(ni.MatricesWeightsKind,t.matricesWeights,t.matricesWeights._updatable)),t.matricesWeightsExtra&&i.setVerticesData(ni.MatricesWeightsExtraKind,t.matricesWeightsExtra,t.matricesWeights._updatable),i.setIndices(t.indices,null)}if(t.subMeshes){i.subMeshes=[];for(var K=0;K<t.subMeshes.length;K++){var Y=t.subMeshes[K];un.AddToMesh(Y.materialIndex,Y.verticesStart,Y.verticesCount,Y.indexStart,Y.indexCount,i)}}i._shouldGenerateFlatShading&&(i.convertToFlatShadedMesh(),i._shouldGenerateFlatShading=!1),i.computeWorldMatrix(!0),n.onMeshImportedObservable.notifyObservers(i)}},{key:"_CleanMatricesWeights",value:function(e,t){if(hn.CleanBoneMatrixWeights){var i=0;if(e.skeletonId>-1){var n=t.getScene().getLastSkeletonById(e.skeletonId);if(n){i=n.bones.length;for(var r=t.getVerticesData(ni.MatricesIndicesKind),s=t.getVerticesData(ni.MatricesIndicesExtraKind),a=e.matricesWeights,o=e.matricesWeightsExtra,l=e.numBoneInfluencer,u=a.length,h=0;h<u;h+=4){for(var c=0,d=-1,f=0;f<4;f++){var _=a[h+f];c+=_,_<.001&&d<0&&(d=f)}if(o)for(var v=0;v<4;v++){var g=o[h+v];c+=g,g<.001&&d<0&&(d=v+4)}if((d<0||d>l-1)&&(d=l-1),c>.001){for(var p=1/c,m=0;m<4;m++)a[h+m]*=p;if(o)for(var y=0;y<4;y++)o[h+y]*=p}else d>=4?(o[h+d-4]=1-c,s[h+d-4]=i):(a[h+d]=1-c,r[h+d]=i)}t.setVerticesData(ni.MatricesIndicesKind,r),e.matricesWeightsExtra&&t.setVerticesData(ni.MatricesIndicesExtraKind,s)}}}}},{key:"Parse",value:function(t,i,n){var r=new e(t.id,i,void 0,t.updatable);return r._loadedUniqueId=t.uniqueId,Ot&&Ot.AddTagsTo(r,t.tags),t.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=n+t.delayLoadingFile,r._boundingInfo=new an(z.FromArray(t.boundingBoxMinimum),z.FromArray(t.boundingBoxMaximum)),r._delayInfo=[],t.hasUVs&&r._delayInfo.push(ni.UVKind),t.hasUVs2&&r._delayInfo.push(ni.UV2Kind),t.hasUVs3&&r._delayInfo.push(ni.UV3Kind),t.hasUVs4&&r._delayInfo.push(ni.UV4Kind),t.hasUVs5&&r._delayInfo.push(ni.UV5Kind),t.hasUVs6&&r._delayInfo.push(ni.UV6Kind),t.hasColors&&r._delayInfo.push(ni.ColorKind),t.hasMatricesIndices&&r._delayInfo.push(ni.MatricesIndicesKind),t.hasMatricesWeights&&r._delayInfo.push(ni.MatricesWeightsKind),r._delayLoadingFunction=Qi.ImportVertexData):Qi.ImportVertexData(t,r),i.pushGeometry(r,!0),r}}]),e}();!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD",e[e.BONE=2]="BONE"}(dn||(dn={}));var _n,vn=(0,y.Z)((function e(){(0,m.Z)(this,e)}));vn.X=new z(1,0,0),vn.Y=new z(0,1,0),vn.Z=new z(0,0,1),function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(_n||(_n={}));var gn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return(0,m.Z)(this,i),(n=t.call(this,e,r))._forward=new z(0,0,1),n._up=new z(0,1,0),n._right=new z(1,0,0),n._position=z.Zero(),n._rotation=z.Zero(),n._rotationQuaternion=null,n._scaling=z.One(),n._transformToBoneReferal=null,n._isAbsoluteSynced=!1,n._billboardMode=i.BILLBOARDMODE_NONE,n._preserveParentRotationForBillboard=!1,n.scalingDeterminant=1,n._infiniteDistance=!1,n.ignoreNonUniformScaling=!1,n.reIntegrateRotationIntoRotationQuaternion=!1,n._poseMatrix=null,n._localMatrix=Z.Zero(),n._usePivotMatrix=!1,n._absolutePosition=z.Zero(),n._absoluteScaling=z.Zero(),n._absoluteRotationQuaternion=H.Identity(),n._pivotMatrix=Z.Identity(),n._postMultiplyPivotMatrix=!1,n._isWorldMatrixFrozen=!1,n._indexInSceneTransformNodesArray=-1,n.onAfterWorldMatrixUpdateObservable=new ee,n._nonUniformScaling=!1,s&&n.getScene().addTransformNode((0,u.Z)(n)),n}return(0,y.Z)(i,[{key:"billboardMode",get:function(){return this._billboardMode},set:function(e){this._billboardMode!==e&&(this._billboardMode=e)}},{key:"preserveParentRotationForBillboard",get:function(){return this._preserveParentRotationForBillboard},set:function(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e)}},{key:"infiniteDistance",get:function(){return this._infiniteDistance},set:function(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}},{key:"getClassName",value:function(){return"TransformNode"}},{key:"position",get:function(){return this._position},set:function(e){this._position=e,this._isDirty=!0}},{key:"isUsingPivotMatrix",value:function(){return this._usePivotMatrix}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}},{key:"scaling",get:function(){return this._scaling},set:function(e){this._scaling=e,this._isDirty=!0}},{key:"rotationQuaternion",get:function(){return this._rotationQuaternion},set:function(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}},{key:"forward",get:function(){return z.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}},{key:"up",get:function(){return z.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}},{key:"right",get:function(){return z.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}},{key:"updatePoseMatrix",value:function(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}},{key:"getPoseMatrix",value:function(){return this._poseMatrix||(this._poseMatrix=Z.Identity()),this._poseMatrix}},{key:"_isSynchronized",value:function(){var e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==i.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}},{key:"_initCache",value:function(){c((0,h.Z)(i.prototype),"_initCache",this).call(this);var e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1}},{key:"absolutePosition",get:function(){return this.getAbsolutePosition()}},{key:"absoluteScaling",get:function(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}},{key:"absoluteRotationQuaternion",get:function(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}},{key:"setPreTransformMatrix",value:function(e){return this.setPivotMatrix(e,!1)}},{key:"setPivotMatrix",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=Z.Invert(this._pivotMatrix)),this}},{key:"getPivotMatrix",value:function(){return this._pivotMatrix}},{key:"instantiateHierarchy",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0,n=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);n&&i&&i(this,n);var r,s=(0,p.Z)(this.getChildTransformNodes(!0));try{for(s.s();!(r=s.n()).done;){r.value.instantiateHierarchy(n,t,i)}}catch(a){s.e(a)}finally{s.f()}return n}},{key:"freezeWorldMatrix",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return e?arguments.length>1&&void 0!==arguments[1]&&arguments[1]?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||H.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}},{key:"unfreezeWorldMatrix",value:function(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}},{key:"isWorldMatrixFrozen",get:function(){return this._isWorldMatrixFrozen}},{key:"getAbsolutePosition",value:function(){return this.computeWorldMatrix(),this._absolutePosition}},{key:"setAbsolutePosition",value:function(e){if(!e)return this;var t,i,n;if(void 0===e.x){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],n=arguments[2]}else t=e.x,i=e.y,n=e.z;if(this.parent){var r=Y.Matrix[0];this.parent.getWorldMatrix().invertToRef(r),z.TransformCoordinatesFromFloatsToRef(t,i,n,r,this.position)}else this.position.x=t,this.position.y=i,this.position.z=n;return this._absolutePosition.copyFrom(e),this}},{key:"setPositionWithLocalVector",value:function(e){return this.computeWorldMatrix(),this.position=z.TransformNormal(e,this._localMatrix),this}},{key:"getPositionExpressedInLocalSpace",value:function(){this.computeWorldMatrix();var e=Y.Matrix[0];return this._localMatrix.invertToRef(e),z.TransformNormal(this.position,e)}},{key:"locallyTranslate",value:function(e){return this.computeWorldMatrix(!0),this.position=z.TransformCoordinates(e,this._localMatrix),this}},{key:"lookAt",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:dn.LOCAL,a=i._LookAtVectorCache,o=s===dn.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,a),this.setDirection(a,t,n,r),s===dn.WORLD&&this.parent)if(this.rotationQuaternion){var l=Y.Matrix[0];this.rotationQuaternion.toRotationMatrix(l);var u=Y.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(u),u.invert(),l.multiplyToRef(u,l),this.rotationQuaternion.fromRotationMatrix(l)}else{var h=Y.Quaternion[0];H.FromEulerVectorToRef(this.rotation,h);var c=Y.Matrix[0];h.toRotationMatrix(c);var d=Y.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(d),d.invert(),c.multiplyToRef(d,c),h.fromRotationMatrix(c),h.toEulerAnglesToRef(this.rotation)}return this}},{key:"getDirection",value:function(e){var t=z.Zero();return this.getDirectionToRef(e,t),t}},{key:"getDirectionToRef",value:function(e,t){return z.TransformNormalToRef(e,this.getWorldMatrix(),t),this}},{key:"setDirection",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=-Math.atan2(e.z,e.x)+Math.PI/2,s=Math.sqrt(e.x*e.x+e.z*e.z),a=-Math.atan2(e.y,s);return this.rotationQuaternion?H.RotationYawPitchRollToRef(r+t,a+i,n,this.rotationQuaternion):(this.rotation.x=a+i,this.rotation.y=r+t,this.rotation.z=n),this}},{key:"setPivotPoint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:dn.LOCAL;0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);var i=this.getWorldMatrix();if(t==dn.WORLD){var n=Y.Matrix[0];i.invertToRef(n),e=z.TransformCoordinates(e,n)}return this.setPivotMatrix(Z.Translation(-e.x,-e.y,-e.z),!0)}},{key:"getPivotPoint",value:function(){var e=z.Zero();return this.getPivotPointToRef(e),e}},{key:"getPivotPointToRef",value:function(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}},{key:"getAbsolutePivotPoint",value:function(){var e=z.Zero();return this.getAbsolutePivotPointToRef(e),e}},{key:"getAbsolutePivotPointToRef",value:function(e){return this.getPivotPointToRef(e),z.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}},{key:"markAsDirty",value:function(e){if(this._isDirty)return this;if(this._children){var t,n=(0,p.Z)(this._children);try{for(n.s();!(t=n.n()).done;){t.value.markAsDirty(e)}}catch(r){n.e(r)}finally{n.f()}}return c((0,h.Z)(i.prototype),"markAsDirty",this).call(this,e)}},{key:"setParent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e&&!this.parent)return this;var r=Y.Quaternion[0],s=Y.Vector3[0],a=Y.Vector3[1],o=Y.Matrix[1];Z.IdentityToRef(o);var l=Y.Matrix[0];this.computeWorldMatrix(!0);var u=this.rotationQuaternion;return u||(u=i._TmpRotation,H.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,u)),Z.ComposeToRef(this.scaling,u,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(o),l.multiplyToRef(o,l)),l.decompose(a,r,s,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(r):r.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(a),this.position.copyFrom(s),this.parent=e,n&&this.setPivotMatrix(Z.Identity()),this}},{key:"nonUniformScaling",get:function(){return this._nonUniformScaling}},{key:"_updateNonUniformScalingState",value:function(e){return this._nonUniformScaling!==e&&(this._nonUniformScaling=e,!0)}},{key:"attachToBone",value:function(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(),e.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}},{key:"detachFromBone",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,this.parent=e?this._currentParentWhenAttachingToBone:null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}},{key:"rotate",value:function(e,t,n){var r;if(e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0)),n&&n!==dn.LOCAL){if(this.parent){var s=Y.Matrix[0];this.parent.getWorldMatrix().invertToRef(s),e=z.TransformNormal(e,s)}(r=H.RotationAxisToRef(e,t,i._RotationAxisCache)).multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}else r=H.RotationAxisToRef(e,t,i._RotationAxisCache),this.rotationQuaternion.multiplyToRef(r,this.rotationQuaternion);return this}},{key:"rotateAround",value:function(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=H.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));var n=Y.Vector3[0],r=Y.Vector3[1],s=Y.Vector3[2],a=Y.Quaternion[0],o=Y.Matrix[0],l=Y.Matrix[1],u=Y.Matrix[2],h=Y.Matrix[3];return e.subtractToRef(this.position,n),Z.TranslationToRef(n.x,n.y,n.z,o),Z.TranslationToRef(-n.x,-n.y,-n.z,l),Z.RotationAxisToRef(t,i,u),l.multiplyToRef(u,h),h.multiplyToRef(o,h),h.decompose(r,a,s),this.position.addInPlace(s),a.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}},{key:"translate",value:function(e,t,i){var n=e.scale(t);if(i&&i!==dn.LOCAL)this.setAbsolutePosition(this.getAbsolutePosition().add(n));else{var r=this.getPositionExpressedInLocalSpace().add(n);this.setPositionWithLocalVector(r)}return this}},{key:"addRotation",value:function(e,t,i){var n;this.rotationQuaternion?n=this.rotationQuaternion:(n=Y.Quaternion[1],H.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,n));var r=Y.Quaternion[0];return H.RotationYawPitchRollToRef(t,e,i,r),n.multiplyInPlace(r),this.rotationQuaternion||n.toEulerAnglesToRef(this.rotation),this}},{key:"_getEffectiveParent",value:function(){return this.parent}},{key:"computeWorldMatrix",value:function(e){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;var t=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===t||this.isSynchronized()))return this._currentRenderId=t,this._worldMatrix;var n=this.getScene().activeCamera,r=0!==(this._billboardMode&i.BILLBOARDMODE_USE_POSITION),s=this._billboardMode!==i.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard;this._updateCache();var a=this._cache;a.pivotMatrixUpdated=!1,a.billboardMode=this.billboardMode,a.infiniteDistance=this.infiniteDistance,a.parent=this._parentNode,this._currentRenderId=t,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;var o,l=this._getEffectiveParent(),u=i._TmpScaling,h=this._position;if(this._infiniteDistance&&!this.parent&&n){var c=n.getWorldMatrix(),d=new z(c.m[12],c.m[13],c.m[14]);(h=i._TmpTranslation).copyFromFloats(this._position.x+d.x,this._position.y+d.y,this._position.z+d.z)}if(u.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant),this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,o=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(H.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(o=i._TmpRotation,H.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,o)),this._usePivotMatrix){var f=Y.Matrix[1];Z.ScalingToRef(u.x,u.y,u.z,f);var _=Y.Matrix[0];o.toRotationMatrix(_),this._pivotMatrix.multiplyToRef(f,Y.Matrix[4]),Y.Matrix[4].multiplyToRef(_,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(h.x,h.y,h.z)}else Z.ComposeToRef(u,o,h,this._localMatrix);if(l&&l.getWorldMatrix){if(e&&l.computeWorldMatrix(e),s){this._transformToBoneReferal?l.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),Y.Matrix[7]):Y.Matrix[7].copyFrom(l.getWorldMatrix());var v=Y.Vector3[5],g=Y.Vector3[6],p=Y.Quaternion[0];Y.Matrix[7].decompose(g,p,v),Z.ScalingToRef(g.x,g.y,g.z,Y.Matrix[7]),Y.Matrix[7].setTranslation(v),i.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(p,v),this._localMatrix.setTranslation(v)),this._localMatrix.multiplyToRef(Y.Matrix[7],this._worldMatrix)}else this._transformToBoneReferal?(this._localMatrix.multiplyToRef(l.getWorldMatrix(),Y.Matrix[6]),Y.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localMatrix.multiplyToRef(l.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(s&&n&&this.billboardMode&&!r){var m=Y.Vector3[0];if(this._worldMatrix.getTranslationToRef(m),Y.Matrix[1].copyFrom(n.getViewMatrix()),Y.Matrix[1].setTranslationFromFloats(0,0,0),Y.Matrix[1].invertToRef(Y.Matrix[0]),(this.billboardMode&i.BILLBOARDMODE_ALL)!==i.BILLBOARDMODE_ALL){Y.Matrix[0].decompose(void 0,Y.Quaternion[0],void 0);var y=Y.Vector3[1];Y.Quaternion[0].toEulerAnglesToRef(y),(this.billboardMode&i.BILLBOARDMODE_X)!==i.BILLBOARDMODE_X&&(y.x=0),(this.billboardMode&i.BILLBOARDMODE_Y)!==i.BILLBOARDMODE_Y&&(y.y=0),(this.billboardMode&i.BILLBOARDMODE_Z)!==i.BILLBOARDMODE_Z&&(y.z=0),Z.RotationYawPitchRollToRef(y.y,y.x,y.z,Y.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(Y.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(Y.Vector3[0])}else if(s&&n&&this.billboardMode&&r){var T=Y.Vector3[0];this._worldMatrix.getTranslationToRef(T);var E=n.globalPosition;this._worldMatrix.invertToRef(Y.Matrix[1]);var S=Y.Vector3[1];z.TransformCoordinatesToRef(E,Y.Matrix[1],S),S.normalize();var b=-Math.atan2(S.z,S.x)+Math.PI/2,x=Math.sqrt(S.x*S.x+S.z*S.z),M=-Math.atan2(S.y,x);if(H.RotationYawPitchRollToRef(b,M,0,Y.Quaternion[0]),(this.billboardMode&i.BILLBOARDMODE_ALL)!==i.BILLBOARDMODE_ALL){var A=Y.Vector3[1];Y.Quaternion[0].toEulerAnglesToRef(A),(this.billboardMode&i.BILLBOARDMODE_X)!==i.BILLBOARDMODE_X&&(A.x=0),(this.billboardMode&i.BILLBOARDMODE_Y)!==i.BILLBOARDMODE_Y&&(A.y=0),(this.billboardMode&i.BILLBOARDMODE_Z)!==i.BILLBOARDMODE_Z&&(A.z=0),Z.RotationYawPitchRollToRef(A.y,A.x,A.z,Y.Matrix[0])}else Z.FromQuaternionToRef(Y.Quaternion[0],Y.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(Y.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(Y.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):l&&l._nonUniformScaling?this._updateNonUniformScalingState(l._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=Z.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}},{key:"resetLocalMatrix",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this.computeWorldMatrix(),e)for(var t=this.getChildren(),i=0;i<t.length;++i){var n=t[i];if(n){n.computeWorldMatrix();var r=Y.Matrix[0];n._localMatrix.multiplyToRef(this._localMatrix,r);var s=Y.Quaternion[0];r.decompose(n.scaling,s,n.position),n.rotationQuaternion?n.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(n.rotation)}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=H.Identity()),this._worldMatrix=Z.Identity()}},{key:"_afterComputeWorldMatrix",value:function(){}},{key:"registerAfterWorldMatrixUpdate",value:function(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}},{key:"unregisterAfterWorldMatrixUpdate",value:function(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}},{key:"getPositionInCameraSpace",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return e||(e=this.getScene().activeCamera),z.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}},{key:"getDistanceToCamera",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}},{key:"clone",value:function(e,t,n){var r=this,s=jt.Clone((function(){return new i(e,r.getScene())}),this);if(s.name=e,s.id=e,t&&(s.parent=t),!n)for(var a=this.getDescendants(!0),o=0;o<a.length;o++){var l=a[o];l.clone&&l.clone(e+"."+l.name,s)}return s}},{key:"serialize",value:function(e){var t=jt.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),t}},{key:"getChildTransformNodes",value:function(e,t){var n=[];return this._getDescendants(n,e,(function(e){return(!t||t(e))&&e instanceof i})),n}},{key:"dispose",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){var n=this._parentContainer.transformNodes.indexOf(this);n>-1&&this._parentContainer.transformNodes.splice(n,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){var r,s=this.getChildTransformNodes(!0),a=(0,p.Z)(s);try{for(a.s();!(r=a.n()).done;){var o=r.value;o.parent=null,o.computeWorldMatrix(!0)}}catch(l){a.e(l)}finally{a.f()}}c((0,h.Z)(i.prototype),"dispose",this).call(this,e,t)}},{key:"normalizeToUnitCube",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2?arguments[2]:void 0,n=null,r=null;t&&(this.rotationQuaternion?(r=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(n=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));var s=this.getHierarchyBoundingVectors(e,i),a=s.max.subtract(s.min),o=Math.max(a.x,a.y,a.z);if(0===o)return this;var l=1/o;return this.scaling.scaleInPlace(l),t&&(this.rotationQuaternion&&r?this.rotationQuaternion.copyFrom(r):this.rotation&&n&&this.rotation.copyFrom(n)),this}},{key:"_syncAbsoluteScalingAndRotation",value:function(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}],[{key:"Parse",value:function(e,t,n){var r=jt.Parse((function(){return new i(e.name,t)}),e,t,n);return e.localMatrix?r.setPreTransformMatrix(Z.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(Z.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r._waitingParsedUniqueId=e.uniqueId,void 0!==e.parentId&&(r._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),r}}]),i}(Yi);gn.BILLBOARDMODE_NONE=0,gn.BILLBOARDMODE_X=1,gn.BILLBOARDMODE_Y=2,gn.BILLBOARDMODE_Z=4,gn.BILLBOARDMODE_ALL=7,gn.BILLBOARDMODE_USE_POSITION=128,gn.BillboardUseParentOrientation=!1,gn._TmpRotation=H.Zero(),gn._TmpScaling=z.Zero(),gn._TmpTranslation=z.Zero(),gn._LookAtVectorCache=new z(0,0,0),gn._RotationAxisCache=new H,Nt([Yt("position")],gn.prototype,"_position",void 0),Nt([Yt("rotation")],gn.prototype,"_rotation",void 0),Nt([function(e){return Wt(10,e)}("rotationQuaternion")],gn.prototype,"_rotationQuaternion",void 0),Nt([Yt("scaling")],gn.prototype,"_scaling",void 0),Nt([Xt("billboardMode")],gn.prototype,"_billboardMode",void 0),Nt([Xt()],gn.prototype,"scalingDeterminant",void 0),Nt([Xt("infiniteDistance")],gn.prototype,"_infiniteDistance",void 0),Nt([Xt()],gn.prototype,"ignoreNonUniformScaling",void 0),Nt([Xt()],gn.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);var pn=(0,y.Z)((function e(){(0,m.Z)(this,e),this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new z(0,0,0),this._diffPositionForCollisions=new z(0,0,0),this._collisionResponse=!0})),mn=(0,y.Z)((function e(){(0,m.Z)(this,e),this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=z.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1})),yn=(0,y.Z)((function e(){(0,m.Z)(this,e),this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new mn,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new pn,this._enableDistantPicking=!1})),Tn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;switch((0,m.Z)(this,i),(n=t.call(this,e,r,!1))._internalAbstractMeshDataInfo=new yn,n._waitingMaterialId=null,n.cullingStrategy=i.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,n.onCollideObservable=new ee,n.onCollisionPositionChangeObservable=new ee,n.onMaterialChangedObservable=new ee,n.definedFacingForward=!0,n._occlusionQuery=null,n._renderingGroup=null,n.alphaIndex=Number.MAX_VALUE,n.isVisible=!0,n.isPickable=!0,n.isNearPickable=!1,n.isNearGrabbable=!1,n.showSubMeshesBoundingBox=!1,n.isBlocker=!1,n.enablePointerMoveEvents=!1,n.outlineColor=Ze.Red(),n.outlineWidth=.02,n.overlayColor=Ze.Red(),n.overlayAlpha=.5,n.useOctreeForRenderingSelection=!0,n.useOctreeForPicking=!0,n.useOctreeForCollisions=!0,n.alwaysSelectAsActiveMesh=!1,n.doNotSyncBoundingInfo=!1,n.actionManager=null,n.ellipsoid=new z(.5,1,.5),n.ellipsoidOffset=new z(0,0,0),n.edgesWidth=1,n.edgesColor=new Ke(1,0,0,1),n._edgesRenderer=null,n._masterMesh=null,n._boundingInfo=null,n._boundingInfoIsDirty=!0,n._renderId=0,n._intersectionsInProgress=new Array,n._unIndexed=!1,n._lightSources=new Array,n._waitingData={lods:null,actions:null,freezeWorldMatrix:null},n._bonesTransformMatrices=null,n._transformMatrixTexture=null,n.onRebuildObservable=new ee,n._onCollisionPositionChange=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;t.subtractToRef(n._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,n._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),n._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>Xe.CollisionsEpsilon&&n.position.addInPlace(n._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),i&&n.onCollideObservable.notifyObservers(i),n.onCollisionPositionChangeObservable.notifyObservers(n.position)},(r=n.getScene()).addMesh((0,u.Z)(n)),n._resyncLightSources(),n._uniformBuffer=new ti(n.getScene().getEngine(),void 0,void 0,e,!n.getScene().getEngine().isWebGPU),n._buildUniformLayout(),r.performancePriority){case Gi.Aggressive:n.doNotSyncBoundingInfo=!0;case Gi.Intermediate:n.alwaysSelectAsActiveMesh=!0,n.isPickable=!1}return n}return(0,y.Z)(i,[{key:"facetNb",get:function(){return this._internalAbstractMeshDataInfo._facetData.facetNb}},{key:"partitioningSubdivisions",get:function(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions},set:function(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}},{key:"partitioningBBoxRatio",get:function(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio},set:function(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}},{key:"mustDepthSortFacets",get:function(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort},set:function(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}},{key:"facetDepthSortFrom",get:function(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom},set:function(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}},{key:"collisionRetryCount",get:function(){return this._internalAbstractMeshDataInfo._collisionRetryCount},set:function(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}},{key:"isFacetDataEnabled",get:function(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}},{key:"morphTargetManager",get:function(){return this._internalAbstractMeshDataInfo._morphTargetManager},set:function(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}},{key:"bakedVertexAnimationManager",get:function(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager},set:function(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}},{key:"_syncGeometryWithMorphTargetManager",value:function(){}},{key:"_updateNonUniformScalingState",value:function(e){return!!c((0,h.Z)(i.prototype),"_updateNonUniformScalingState",this).call(this,e)&&(this._markSubMeshesAsMiscDirty(),!0)}},{key:"onCollide",set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}},{key:"onCollisionPositionChange",set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}},{key:"visibility",get:function(){return this._internalAbstractMeshDataInfo._visibility},set:function(e){if(this._internalAbstractMeshDataInfo._visibility!==e){var t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(1===t&&1!==e||1!==t&&1===e)&&this._markSubMeshesAsMiscDirty()}}},{key:"pointerOverDisableMeshTesting",get:function(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting},set:function(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}},{key:"renderingGroupId",get:function(){return this._internalAbstractMeshDataInfo._renderingGroupId},set:function(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}},{key:"material",get:function(){return this._internalAbstractMeshDataInfo._material},set:function(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}},{key:"getMaterialForRenderPass",value:function(e){var t;return null===(t=this._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===t?void 0:t[e]}},{key:"setMaterialForRenderPass",value:function(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t}},{key:"receiveShadows",get:function(){return this._internalAbstractMeshDataInfo._receiveShadows},set:function(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}},{key:"hasVertexAlpha",get:function(){return this._internalAbstractMeshDataInfo._hasVertexAlpha},set:function(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}},{key:"useVertexColors",get:function(){return this._internalAbstractMeshDataInfo._useVertexColors},set:function(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}},{key:"computeBonesUsingShaders",get:function(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders},set:function(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}},{key:"numBoneInfluencers",get:function(){return this._internalAbstractMeshDataInfo._numBoneInfluencers},set:function(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}},{key:"applyFog",get:function(){return this._internalAbstractMeshDataInfo._applyFog},set:function(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}},{key:"enableDistantPicking",get:function(){return this._internalAbstractMeshDataInfo._enableDistantPicking},set:function(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}},{key:"layerMask",get:function(){return this._internalAbstractMeshDataInfo._layerMask},set:function(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}},{key:"collisionMask",get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask},set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}},{key:"collisionResponse",get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse},set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}},{key:"collisionGroup",get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup},set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}},{key:"surroundingMeshes",get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes},set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}},{key:"lightSources",get:function(){return this._lightSources}},{key:"_positions",get:function(){return null}},{key:"skeleton",get:function(){return this._internalAbstractMeshDataInfo._skeleton},set:function(e){var t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}},{key:"_buildUniformLayout",value:function(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}},{key:"transferToEffect",value:function(e){var t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}},{key:"getMeshUniformBuffer",value:function(){return this._uniformBuffer}},{key:"getClassName",value:function(){return"AbstractMesh"}},{key:"toString",value:function(e){var t="Name: "+this.name+", isInstance: "+("InstancedMesh"!==this.getClassName()?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);var i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}},{key:"_getEffectiveParent",value:function(){return this._masterMesh&&this.billboardMode!==gn.BILLBOARDMODE_NONE?this._masterMesh:c((0,h.Z)(i.prototype),"_getEffectiveParent",this).call(this)}},{key:"_getActionManagerForTrigger",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.actionManager&&(t||this.actionManager.isRecursive)){if(!e)return this.actionManager;if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}},{key:"_rebuild",value:function(){if(this.onRebuildObservable.notifyObservers(this),null!==this._occlusionQuery&&(this._occlusionQuery=null),this.subMeshes){var e,t=(0,p.Z)(this.subMeshes);try{for(t.s();!(e=t.n()).done;){e.value._rebuild()}}catch(i){t.e(i)}finally{t.f()}}}},{key:"_resyncLightSources",value:function(){this._lightSources.length=0;var e,t=(0,p.Z)(this.getScene().lights);try{for(t.s();!(e=t.n()).done;){var i=e.value;i.isEnabled()&&i.canAffectMesh(this)&&this._lightSources.push(i)}}catch(n){t.e(n)}finally{t.f()}this._markSubMeshesAsLightDirty()}},{key:"_resyncLightSource",value:function(e){var t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e),n=!1;if(-1===i){if(!t)return;this._lightSources.push(e)}else{if(t)return;n=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(n)}},{key:"_unBindEffect",value:function(){var e,t=(0,p.Z)(this.subMeshes);try{for(t.s();!(e=t.n()).done;){e.value.setEffect(null)}}catch(i){t.e(i)}finally{t.f()}}},{key:"_removeLightSource",value:function(e,t){var i=this._lightSources.indexOf(e);-1!==i&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}},{key:"_markSubMeshesAsDirty",value:function(e){if(this.subMeshes){var t,i=(0,p.Z)(this.subMeshes);try{for(i.s();!(t=i.n()).done;)for(var n=t.value,r=0;r<n._drawWrappers.length;++r){var s=n._drawWrappers[r];!s||!s.defines||!s.defines.markAllAsDirty||e(s.defines)}}catch(a){i.e(a)}finally{i.f()}}}},{key:"_markSubMeshesAsLightDirty",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._markSubMeshesAsDirty((function(t){return t.markAsLightDirty(e)}))}},{key:"_markSubMeshesAsAttributesDirty",value:function(){this._markSubMeshesAsDirty((function(e){return e.markAsAttributesDirty()}))}},{key:"_markSubMeshesAsMiscDirty",value:function(){this._markSubMeshesAsDirty((function(e){return e.markAsMiscDirty()}))}},{key:"markAsDirty",value:function(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}},{key:"resetDrawCache",value:function(e){if(this.subMeshes){var t,i=(0,p.Z)(this.subMeshes);try{for(i.s();!(t=i.n()).done;){t.value.resetDrawCache(e)}}catch(n){i.e(n)}finally{i.f()}}}},{key:"isBlocked",get:function(){return!1}},{key:"getLOD",value:function(e){return this}},{key:"getTotalVertices",value:function(){return 0}},{key:"getTotalIndices",value:function(){return 0}},{key:"getIndices",value:function(){return null}},{key:"getVerticesData",value:function(e){return null}},{key:"setVerticesData",value:function(e,t,i,n){return this}},{key:"updateVerticesData",value:function(e,t,i,n){return this}},{key:"setIndices",value:function(e,t){return this}},{key:"isVerticesDataPresent",value:function(e){return!1}},{key:"getBoundingInfo",value:function(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}},{key:"setBoundingInfo",value:function(e){return this._boundingInfo=e,this}},{key:"hasBoundingInfo",get:function(){return null!==this._boundingInfo}},{key:"buildBoundingInfo",value:function(e,t,i){return this._boundingInfo=new an(e,t,i),this._boundingInfo}},{key:"normalizeToUnitCube",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;return c((0,h.Z)(i.prototype),"normalizeToUnitCube",this).call(this,e,t,n)}},{key:"useBones",get:function(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(ni.MatricesIndicesKind)&&this.isVerticesDataPresent(ni.MatricesWeightsKind)}},{key:"_preActivate",value:function(){}},{key:"_preActivateForIntermediateRendering",value:function(e){}},{key:"_activate",value:function(e,t){return this._renderId=e,!0}},{key:"_postActivate",value:function(){}},{key:"_freeze",value:function(){}},{key:"_unFreeze",value:function(){}},{key:"getWorldMatrix",value:function(){return this._masterMesh&&this.billboardMode===gn.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():c((0,h.Z)(i.prototype),"getWorldMatrix",this).call(this)}},{key:"_getWorldMatrixDeterminant",value:function(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():c((0,h.Z)(i.prototype),"_getWorldMatrixDeterminant",this).call(this)}},{key:"isAnInstance",get:function(){return!1}},{key:"hasInstances",get:function(){return!1}},{key:"hasThinInstances",get:function(){return!1}},{key:"movePOV",value:function(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}},{key:"calcMovePOV",value:function(e,t,i){var n=new Z;(this.rotationQuaternion?this.rotationQuaternion:H.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(n);var r=z.Zero(),s=this.definedFacingForward?-1:1;return z.TransformCoordinatesFromFloatsToRef(e*s,t,i*s,n,r),r}},{key:"rotatePOV",value:function(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}},{key:"calcRotatePOV",value:function(e,t,i){var n=this.definedFacingForward?1:-1;return new z(e*n,t,i*n)}},{key:"refreshBoundingInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._boundingInfo&&this._boundingInfo.isLocked||this._refreshBoundingInfo(this._getPositionData(e,t),null),this}},{key:"_refreshBoundingInfo",value:function(e,t){if(e){var i=ln(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new an(i.minimum,i.maximum)}if(this.subMeshes)for(var n=0;n<this.subMeshes.length;n++)this.subMeshes[n].refreshBoundingInfo(e);this._updateBoundingInfo()}},{key:"_getData",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ni.PositionKind;if((n=null!==(e=n)&&void 0!==e?e:this.getVerticesData(r).slice())&&i&&this.morphTargetManager)for(var s=0,a=0,o=0;o<n.length;o++){for(var l=0;l<this.morphTargetManager.numTargets;l++){var u=this.morphTargetManager.getTarget(l),h=u.influence;if(h>0){var c=u.getPositions();c&&(n[o]+=(c[o]-n[o])*h)}}if(s++,r===ni.PositionKind&&this._positions&&3===s){s=0;var d=3*a;this._positions[a++].copyFromFloats(n[d],n[d+1],n[d+2])}}if(n&&t&&this.skeleton){var f=this.getVerticesData(ni.MatricesIndicesKind),_=this.getVerticesData(ni.MatricesWeightsKind);if(_&&f)for(var v=this.numBoneInfluencers>4,g=v?this.getVerticesData(ni.MatricesIndicesExtraKind):null,p=v?this.getVerticesData(ni.MatricesWeightsExtraKind):null,m=this.skeleton.getTransformMatrices(this),y=Y.Vector3[0],T=Y.Matrix[0],E=Y.Matrix[1],S=0,b=0;b<n.length;b+=3,S+=4){T.reset();var x=void 0,M=void 0;for(x=0;x<4;x++)(M=_[S+x])>0&&(Z.FromFloat32ArrayToRefScaled(m,Math.floor(16*f[S+x]),M,E),T.addToSelf(E));if(v)for(x=0;x<4;x++)(M=p[S+x])>0&&(Z.FromFloat32ArrayToRefScaled(m,Math.floor(16*g[S+x]),M,E),T.addToSelf(E));r===ni.NormalKind?z.TransformNormalFromFloatsToRef(n[b],n[b+1],n[b+2],T,y):z.TransformCoordinatesFromFloatsToRef(n[b],n[b+1],n[b+2],T,y),y.toArray(n,b),r===ni.PositionKind&&this._positions&&this._positions[b/3].copyFrom(y)}}return n}},{key:"getNormalsData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._getData(e,t,null,ni.NormalKind)}},{key:"getPositionData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2?arguments[2]:void 0;return this._getData(e,t,i,ni.PositionKind)}},{key:"_getPositionData",value:function(e,t){var i,n=this.getVerticesData(ni.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),n&&(e&&this.skeleton||t&&this.morphTargetManager)){if(n=n.slice(),this._generatePointsArray(),this._positions){var r=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(r.length);for(var s=0;s<r.length;s++)this._internalAbstractMeshDataInfo._positions[s]=(null===(i=r[s])||void 0===i?void 0:i.clone())||new z}return this.getPositionData(e,t,n)}return n}},{key:"_updateBoundingInfo",value:function(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new an(z.Zero(),z.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}},{key:"_updateSubMeshesBoundingInfo",value:function(e){if(!this.subMeshes)return this;for(var t=this.subMeshes.length,i=0;i<t;i++){var n=this.subMeshes[i];(t>1||!n.IsGlobal)&&n.updateBoundingInfo(e)}return this}},{key:"_afterComputeWorldMatrix",value:function(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}},{key:"isInFrustum",value:function(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}},{key:"isCompletelyInFrustum",value:function(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}},{key:"intersectsMesh",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2?arguments[2]:void 0,n=this.getBoundingInfo(),r=e.getBoundingInfo();if(n.intersects(r,t))return!0;if(i){var s,a=(0,p.Z)(this.getChildMeshes());try{for(a.s();!(s=a.n()).done;){if(s.value.intersectsMesh(e,t,!0))return!0}}catch(o){a.e(o)}finally{a.f()}}return!1}},{key:"intersectsPoint",value:function(e){return this.getBoundingInfo().intersectsPoint(e)}},{key:"checkCollisions",get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions},set:function(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}},{key:"collider",get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}},{key:"moveWithCollisions",value:function(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);var t=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=t.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,t.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}},{key:"_collideForSubMesh",value:function(e,t,i){var n;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];for(var r=e.verticesStart,s=e.verticesStart+e.verticesCount,a=r;a<s;a++)e._lastColliderWorldVertices.push(z.TransformCoordinates(this._positions[a],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),7===(null===(n=e.getMaterial())||void 0===n?void 0:n.fillMode)),this}},{key:"_processCollisionsForSubMeshes",value:function(e,t){for(var i=this._scene.getCollidingSubMeshCandidates(this,e),n=i.length,r=0;r<n;r++){var s=i.data[r];n>1&&!s._checkCollision(e)||this._collideForSubMesh(s,t,e)}return this}},{key:"_shouldConvertRHS",value:function(){return!1}},{key:"_checkCollision",value:function(e){if(!this.getBoundingInfo()._checkCollision(e))return this;var t=Y.Matrix[0],i=Y.Matrix[1];return Z.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}},{key:"_generatePointsArray",value:function(){return!1}},{key:"intersects",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4?arguments[4]:void 0,s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=new ri,o="InstancedLinesMesh"===this.getClassName()||"LinesMesh"===this.getClassName()?this.intersectionThreshold:0,l=this.getBoundingInfo();if(!this.subMeshes||!s&&(!e.intersectsSphere(l.boundingSphere,o)||!e.intersectsBox(l.boundingBox,o)))return a;if(n)return a.hit=!s,a.pickedMesh=s?null:this,a.distance=s?0:z.Distance(e.origin,l.boundingSphere.center),a.subMeshId=0,a;if(!this._generatePointsArray())return a;for(var u=null,h=this._scene.getIntersectingSubMeshCandidates(this,e),c=h.length,d=!1,f=0;f<c;f++){var _=h.data[f].getMaterial();if(_&&(7==_.fillMode||0==_.fillMode||1==_.fillMode||2==_.fillMode||4==_.fillMode)){d=!0;break}}if(!d)return a.hit=!0,a.pickedMesh=this,a.distance=z.Distance(e.origin,l.boundingSphere.center),a.subMeshId=-1,a;for(var v=0;v<c;v++){var g=h.data[v];if(!(c>1)||g.canIntersects(e)){var p=g.intersects(e,this._positions,this.getIndices(),t,i);if(p&&(t||!u||p.distance<u.distance)&&((u=p).subMeshId=v,t))break}}if(u){var m=null!==r&&void 0!==r?r:this.getWorldMatrix(),y=Y.Vector3[0],T=Y.Vector3[1];z.TransformCoordinatesToRef(e.origin,m,y),e.direction.scaleToRef(u.distance,T);var E=z.TransformNormal(T,m).addInPlace(y);return a.hit=!0,a.distance=z.Distance(y,E),a.pickedPoint=E,a.pickedMesh=this,a.bu=u.bu||0,a.bv=u.bv||0,a.subMeshFaceId=u.faceId,a.faceId=u.faceId+h.data[u.subMeshId].indexStart/(-1!==this.getClassName().indexOf("LinesMesh")?2:3),a.subMeshId=u.subMeshId,a}return a}},{key:"clone",value:function(e,t,i){return null}},{key:"releaseSubMeshes",value:function(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this}},{key:"dispose",value:function(e){var t,n=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),void 0!==this.actionManager&&null!==this.actionManager&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),t=0;t<this._intersectionsInProgress.length;t++){var s=this._intersectionsInProgress[t],a=s._intersectionsInProgress.indexOf(this);s._intersectionsInProgress.splice(a,1)}this._intersectionsInProgress.length=0,this.getScene().lights.forEach((function(e){var t=e.includedOnlyMeshes.indexOf(n);-1!==t&&e.includedOnlyMeshes.splice(t,1),-1!==(t=e.excludedMeshes.indexOf(n))&&e.excludedMeshes.splice(t,1);var i=e.getShadowGenerators();if(i)for(var r=i.values(),s=r.next();!0!==s.done;s=r.next()){var a=s.value.getShadowMap();a&&a.renderList&&(-1!==(t=a.renderList.indexOf(n))&&a.renderList.splice(t,1))}})),("InstancedMesh"!==this.getClassName()||"InstancedLinesMesh"!==this.getClassName())&&this.releaseSubMeshes();var o=this.getScene().getEngine();if(null!==this._occlusionQuery&&(this.isOcclusionQueryInProgress=!1,o.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),o.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){var l=this._parentContainer.meshes.indexOf(this);l>-1&&this._parentContainer.meshes.splice(l,1),this._parentContainer=null}if(r&&this.material&&("MultiMaterial"===this.material.getClassName()?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(t=0;t<this.getScene().particleSystems.length;t++)this.getScene().particleSystems[t].emitter===this&&(this.getScene().particleSystems[t].dispose(),t--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),c((0,h.Z)(i.prototype),"dispose",this).call(this,e,r)}},{key:"addChild",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e.setParent(this,t),this}},{key:"removeChild",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e.setParent(null,t),this}},{key:"_initFacetData",value:function(){var e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=new Array),e.facetPositions||(e.facetPositions=new Array),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(var t=0;t<e.facetNb;t++)e.facetNormals[t]=z.Zero(),e.facetPositions[t]=z.Zero();return e.facetDataEnabled=!0,this}},{key:"updateFacetData",value:function(){var e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();var t=this.getVerticesData(ni.PositionKind),i=this.getIndices(),n=this.getVerticesData(ni.NormalKind),r=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{for(var s=!1,a=0;a<i.length;a++)if(i[a]>65535){s=!0;break}e.depthSortedIndices=s?new Uint32Array(i):new Uint16Array(i)}if(e.facetDepthSortFunction=function(e,t){return t.sqDistance-e.sqDistance},!e.facetDepthSortFrom){var o=this.getScene().activeCamera;e.facetDepthSortFrom=o?o.position:z.Zero()}e.depthSortedFacets=[];for(var l=0;l<e.facetNb;l++){var u={ind:3*l,sqDistance:0};e.depthSortedFacets.push(u)}e.invertedMatrix=Z.Identity(),e.facetDepthSortOrigin=z.Zero()}e.bbSize.x=r.maximum.x-r.minimum.x>D?r.maximum.x-r.minimum.x:D,e.bbSize.y=r.maximum.y-r.minimum.y>D?r.maximum.y-r.minimum.y:D,e.bbSize.z=r.maximum.z-r.minimum.z>D?r.maximum.z-r.minimum.z:D;var h=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(h=h>e.bbSize.z?h:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/h),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/h),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/h),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=r,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),z.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,n&&Qi.ComputeNormals(t,i,n,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);for(var c=e.depthSortedIndices.length/3|0,d=0;d<c;d++){var f=e.depthSortedFacets[d].ind;e.depthSortedIndices[3*d]=i[f],e.depthSortedIndices[3*d+1]=i[f+1],e.depthSortedIndices[3*d+2]=i[f+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}},{key:"getFacetLocalNormals",value:function(){var e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}},{key:"getFacetLocalPositions",value:function(){var e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}},{key:"getFacetLocalPartitioning",value:function(){var e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}},{key:"getFacetPosition",value:function(e){var t=z.Zero();return this.getFacetPositionToRef(e,t),t}},{key:"getFacetPositionToRef",value:function(e,t){var i=this.getFacetLocalPositions()[e],n=this.getWorldMatrix();return z.TransformCoordinatesToRef(i,n,t),this}},{key:"getFacetNormal",value:function(e){var t=z.Zero();return this.getFacetNormalToRef(e,t),t}},{key:"getFacetNormalToRef",value:function(e,t){var i=this.getFacetLocalNormals()[e];return z.TransformNormalToRef(i,this.getWorldMatrix(),t),this}},{key:"getFacetsAtLocalCoordinates",value:function(e,t,i){var n=this.getBoundingInfo(),r=this._internalAbstractMeshDataInfo._facetData,s=Math.floor((e-n.minimum.x*r.partitioningBBoxRatio)*r.subDiv.X*r.partitioningBBoxRatio/r.bbSize.x),a=Math.floor((t-n.minimum.y*r.partitioningBBoxRatio)*r.subDiv.Y*r.partitioningBBoxRatio/r.bbSize.y),o=Math.floor((i-n.minimum.z*r.partitioningBBoxRatio)*r.subDiv.Z*r.partitioningBBoxRatio/r.bbSize.z);return s<0||s>r.subDiv.max||a<0||a>r.subDiv.max||o<0||o>r.subDiv.max?null:r.facetPartitioning[s+r.subDiv.max*a+r.subDiv.max*r.subDiv.max*o]}},{key:"getClosestFacetAtCoordinates",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=this.getWorldMatrix(),o=Y.Matrix[5];a.invertToRef(o);var l=Y.Vector3[8];z.TransformCoordinatesFromFloatsToRef(e,t,i,o,l);var u=this.getClosestFacetAtLocalCoordinates(l.x,l.y,l.z,n,r,s);return n&&z.TransformCoordinatesFromFloatsToRef(n.x,n.y,n.z,a,n),u}},{key:"getClosestFacetAtLocalCoordinates",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=null,o=0,l=0,u=0,h=0,c=0,d=0,f=0,_=0,v=this.getFacetLocalPositions(),g=this.getFacetLocalNormals(),p=this.getFacetsAtLocalCoordinates(e,t,i);if(!p)return null;for(var m,y,T,E=Number.MAX_VALUE,S=E,b=0;b<p.length;b++)y=g[m=p[b]],h=(e-(T=v[m]).x)*y.x+(t-T.y)*y.y+(i-T.z)*y.z,(!r||r&&s&&h>=0||r&&!s&&h<=0)&&(h=y.x*T.x+y.y*T.y+y.z*T.z,c=-(y.x*e+y.y*t+y.z*i-h)/(y.x*y.x+y.y*y.y+y.z*y.z),(S=(o=(d=e+y.x*c)-e)*o+(l=(f=t+y.y*c)-t)*l+(u=(_=i+y.z*c)-i)*u)<E&&(E=S,a=m,n&&(n.x=d,n.y=f,n.z=_)));return a}},{key:"getFacetDataParameters",value:function(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}},{key:"disableFacetData",value:function(){var e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=new Array,e.facetNormals=new Array,e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this}},{key:"updateIndices",value:function(e,t){return this}},{key:"createNormals",value:function(e){var t,i=this.getVerticesData(ni.PositionKind),n=this.getIndices();return t=this.isVerticesDataPresent(ni.NormalKind)?this.getVerticesData(ni.NormalKind):[],Qi.ComputeNormals(i,n,t,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(ni.NormalKind,t,e),this}},{key:"alignWithNormal",value:function(e,t){t||(t=vn.Y);var i=Y.Vector3[0],n=Y.Vector3[1];return z.CrossToRef(t,e,n),z.CrossToRef(e,n,i),this.rotationQuaternion?H.RotationQuaternionFromAxisToRef(i,e,n,this.rotationQuaternion):z.RotationFromAxisToRef(i,e,n,this.rotation),this}},{key:"_checkOcclusionQuery",value:function(){return!1}},{key:"disableEdgesRendering",value:function(){throw le("EdgesRenderer")}},{key:"enableEdgesRendering",value:function(e,t,i){throw le("EdgesRenderer")}},{key:"getConnectedParticleSystems",value:function(){var e=this;return this._scene.particleSystems.filter((function(t){return t.emitter===e}))}}],[{key:"BILLBOARDMODE_NONE",get:function(){return gn.BILLBOARDMODE_NONE}},{key:"BILLBOARDMODE_X",get:function(){return gn.BILLBOARDMODE_X}},{key:"BILLBOARDMODE_Y",get:function(){return gn.BILLBOARDMODE_Y}},{key:"BILLBOARDMODE_Z",get:function(){return gn.BILLBOARDMODE_Z}},{key:"BILLBOARDMODE_ALL",get:function(){return gn.BILLBOARDMODE_ALL}},{key:"BILLBOARDMODE_USE_POSITION",get:function(){return gn.BILLBOARDMODE_USE_POSITION}}]),i}(gn);function En(e){-1===e.indexOf("vClipPlane")&&e.push("vClipPlane"),-1===e.indexOf("vClipPlane2")&&e.push("vClipPlane2"),-1===e.indexOf("vClipPlane3")&&e.push("vClipPlane3"),-1===e.indexOf("vClipPlane4")&&e.push("vClipPlane4"),-1===e.indexOf("vClipPlane5")&&e.push("vClipPlane5"),-1===e.indexOf("vClipPlane6")&&e.push("vClipPlane6")}function Sn(e,t,i){var n,r,s,a,o,l,u=!1,h=null!==(n=e.clipPlane)&&void 0!==n?n:t.clipPlane;return u=Mn(h,i,"CLIPPLANE")||u,u=Mn(h=null!==(r=e.clipPlane2)&&void 0!==r?r:t.clipPlane2,i,"CLIPPLANE2")||u,u=Mn(h=null!==(s=e.clipPlane3)&&void 0!==s?s:t.clipPlane3,i,"CLIPPLANE3")||u,u=Mn(h=null!==(a=e.clipPlane4)&&void 0!==a?a:t.clipPlane4,i,"CLIPPLANE4")||u,u=Mn(h=null!==(o=e.clipPlane5)&&void 0!==o?o:t.clipPlane5,i,"CLIPPLANE5")||u,u=Mn(h=null!==(l=e.clipPlane6)&&void 0!==l?l:t.clipPlane6,i,"CLIPPLANE6")||u}function bn(e,t,i){var n,r,s,a,o,l,u=null!==(n=t.clipPlane)&&void 0!==n?n:i.clipPlane;xn(e,"vClipPlane",u),xn(e,"vClipPlane2",u=null!==(r=t.clipPlane2)&&void 0!==r?r:i.clipPlane2),xn(e,"vClipPlane3",u=null!==(s=t.clipPlane3)&&void 0!==s?s:i.clipPlane3),xn(e,"vClipPlane4",u=null!==(a=t.clipPlane4)&&void 0!==a?a:i.clipPlane4),xn(e,"vClipPlane5",u=null!==(o=t.clipPlane5)&&void 0!==o?o:i.clipPlane5),xn(e,"vClipPlane6",u=null!==(l=t.clipPlane6)&&void 0!==l?l:i.clipPlane6)}function xn(e,t,i){i&&e.setFloat4(t,i.normal.x,i.normal.y,i.normal.z,i.d)}function Mn(e,t,i){var n=!0;if(e)if(Array.isArray(t)){var r="#define "+i;(n=-1!==t.indexOf(r))||t.push(r)}else n=t[i],t[i]=!0;return!n}Tn.OCCLUSION_TYPE_NONE=0,Tn.OCCLUSION_TYPE_OPTIMISTIC=1,Tn.OCCLUSION_TYPE_STRICT=2,Tn.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,Tn.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,Tn.CULLINGSTRATEGY_STANDARD=0,Tn.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,Tn.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,Tn.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,N("BABYLON.AbstractMesh",Tn);var An=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"BindSceneUniformBuffer",value:function(e,t){t.bindToEffect(e,"Scene")}},{key:"PrepareDefinesForMergedUV",value:function(e,t,i){t._needUVs=!0,t[i]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0}},{key:"BindTextureMatrix",value:function(e,t,i){var n=e.getTextureMatrix();t.updateMatrix(i+"Matrix",n)}},{key:"GetFogState",value:function(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==zi.FOGMODE_NONE}},{key:"PrepareDefinesForMisc",value:function(e,t,i,n,r,s,a){a._areMiscDirty&&(a.LOGARITHMICDEPTH=i,a.POINTSIZE=n,a.FOG=r&&this.GetFogState(e,t),a.NONUNIFORMSCALING=e.nonUniformScaling,a.ALPHATEST=s)}},{key:"PrepareDefinesForCamera",value:function(e,t){var i=!1;if(e.activeCamera){var n=t.CAMERA_ORTHOGRAPHIC?1:0,r=t.CAMERA_PERSPECTIVE?1:0,s=e.activeCamera.mode===ji.ORTHOGRAPHIC_CAMERA?1:0,a=e.activeCamera.mode===ji.PERSPECTIVE_CAMERA?1:0;(n^s||r^a)&&(t.CAMERA_ORTHOGRAPHIC=1===s,t.CAMERA_PERSPECTIVE=1===a,i=!0)}return i}},{key:"PrepareDefinesForFrameBoundValues",value:function(t,i,n,r,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=e.PrepareDefinesForCamera(t,r);!1!==a&&(l=Sn(n,t,r)),r.DEPTHPREPASS!==!i.getColorWrite()&&(r.DEPTHPREPASS=!r.DEPTHPREPASS,l=!0),r.INSTANCES!==s&&(r.INSTANCES=s,l=!0),r.THIN_INSTANCES!==o&&(r.THIN_INSTANCES=o,l=!0),l&&r.markAsUnprocessed()}},{key:"PrepareDefinesForBones",value:function(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;var i=void 0!==t.BONETEXTURE;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=!i&&void 0;var n=e.getScene().prePassRenderer;if(n&&n.enabled){var r=-1===n.excludedSkinnedMesh.indexOf(e);t.BONES_VELOCITY_ENABLED=r}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,void 0!==t.BONETEXTURE&&(t.BONETEXTURE=!1)}},{key:"PrepareDefinesForMorphTargets",value:function(e,t){var i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS=i.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=i.numInfluencers,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}},{key:"PrepareDefinesForBakedVertexAnimation",value:function(e,t){var i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!(!i||!i.isEnabled)}},{key:"PrepareDefinesForAttributes",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(ni.NormalKind),t._needNormals&&e.isVerticesDataPresent(ni.TangentKind)&&(t.TANGENT=!0);for(var o=1;o<=6;++o)t["UV"+o]=!!t._needUVs&&e.isVerticesDataPresent("uv".concat(1===o?"":o));if(i){var l=e.useVertexColors&&e.isVerticesDataPresent(ni.ColorKind);t.VERTEXCOLOR=l,t.VERTEXALPHA=e.hasVertexAlpha&&l&&s}return e.isVerticesDataPresent(ni.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),n&&this.PrepareDefinesForBones(e,t),r&&this.PrepareDefinesForMorphTargets(e,t),a&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0}},{key:"PrepareDefinesForMultiview",value:function(e,t){if(e.activeCamera){var i=t.MULTIVIEW;t.MULTIVIEW=null!==e.activeCamera.outputRenderTarget&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}}},{key:"PrepareDefinesForOIT",value:function(e,t,i){var n=t.ORDER_INDEPENDENT_TRANSPARENCY,r=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(n!==t.ORDER_INDEPENDENT_TRANSPARENCY||r!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()}},{key:"PrepareDefinesForPrePass",value:function(e,t,i){var n=t.PREPASS;if(t._arePrePassDirty){var r=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount;for(var s=0;s<r.length;s++){var a=e.prePassRenderer.getIndex(r[s].type);-1!==a?(t[r[s].define]=!0,t[r[s].index]=a):t[r[s].define]=!1}}else{t.PREPASS=!1;for(var o=0;o<r.length;o++)t[r[o].define]=!1}t.PREPASS!=n&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}}},{key:"PrepareDefinesForLight",value:function(e,t,i,n,r,s,a){var o;switch(a.needNormals=!0,void 0===r["LIGHT"+n]&&(a.needRebuild=!0),r["LIGHT"+n]=!0,r["SPOTLIGHT"+n]=!1,r["HEMILIGHT"+n]=!1,r["POINTLIGHT"+n]=!1,r["DIRLIGHT"+n]=!1,i.prepareLightSpecificDefines(r,n),r["LIGHT_FALLOFF_PHYSICAL"+n]=!1,r["LIGHT_FALLOFF_GLTF"+n]=!1,r["LIGHT_FALLOFF_STANDARD"+n]=!1,i.falloffType){case Wi.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+n]=!0;break;case Wi.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+n]=!0;break;case Wi.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+n]=!0}if(s&&!i.specular.equalsFloats(0,0,0)&&(a.specularEnabled=!0),r["SHADOW"+n]=!1,r["SHADOWCSM"+n]=!1,r["SHADOWCSMDEBUG"+n]=!1,r["SHADOWCSMNUM_CASCADES"+n]=!1,r["SHADOWCSMUSESHADOWMAXZ"+n]=!1,r["SHADOWCSMNOBLEND"+n]=!1,r["SHADOWCSM_RIGHTHANDED"+n]=!1,r["SHADOWPCF"+n]=!1,r["SHADOWPCSS"+n]=!1,r["SHADOWPOISSON"+n]=!1,r["SHADOWESM"+n]=!1,r["SHADOWCLOSEESM"+n]=!1,r["SHADOWCUBE"+n]=!1,r["SHADOWLOWQUALITY"+n]=!1,r["SHADOWMEDIUMQUALITY"+n]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){var l=null!==(o=i.getShadowGenerator(e.activeCamera))&&void 0!==o?o:i.getShadowGenerator();if(l){var u=l.getShadowMap();u&&u.renderList&&u.renderList.length>0&&(a.shadowEnabled=!0,l.prepareDefines(r,n))}}i.lightmapMode!=Wi.LIGHTMAP_DEFAULT?(a.lightmapMode=!0,r["LIGHTMAPEXCLUDED"+n]=!0,r["LIGHTMAPNOSPECULAR"+n]=i.lightmapMode==Wi.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+n]=!1,r["LIGHTMAPNOSPECULAR"+n]=!1)}},{key:"PrepareDefinesForLights",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:4,s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];if(!i._areLightsDirty)return i._needNormals;var a=0,o={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!s){var l,u=(0,p.Z)(t.lightSources);try{for(u.s();!(l=u.n()).done;){var h=l.value;if(this.PrepareDefinesForLight(e,t,h,a,i,n,o),++a===r)break}}catch(f){u.e(f)}finally{u.f()}}i.SPECULARTERM=o.specularEnabled,i.SHADOWS=o.shadowEnabled;for(var c=a;c<r;c++)void 0!==i["LIGHT"+c]&&(i["LIGHT"+c]=!1,i["HEMILIGHT"+c]=!1,i["POINTLIGHT"+c]=!1,i["DIRLIGHT"+c]=!1,i["SPOTLIGHT"+c]=!1,i["SHADOW"+c]=!1,i["SHADOWCSM"+c]=!1,i["SHADOWCSMDEBUG"+c]=!1,i["SHADOWCSMNUM_CASCADES"+c]=!1,i["SHADOWCSMUSESHADOWMAXZ"+c]=!1,i["SHADOWCSMNOBLEND"+c]=!1,i["SHADOWCSM_RIGHTHANDED"+c]=!1,i["SHADOWPCF"+c]=!1,i["SHADOWPCSS"+c]=!1,i["SHADOWPOISSON"+c]=!1,i["SHADOWESM"+c]=!1,i["SHADOWCLOSEESM"+c]=!1,i["SHADOWCUBE"+c]=!1,i["SHADOWLOWQUALITY"+c]=!1,i["SHADOWMEDIUMQUALITY"+c]=!1);var d=e.getEngine().getCaps();return void 0===i.SHADOWFLOAT&&(o.needRebuild=!0),i.SHADOWFLOAT=o.shadowEnabled&&(d.textureFloatRender&&d.textureFloatLinearFiltering||d.textureHalfFloatRender&&d.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=o.lightmapMode,o.needRebuild&&i.rebuild(),o.needNormals}},{key:"PrepareUniformsAndSamplersForLight",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];r&&r.push("Light"+e),!s&&(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowSampler"+e),i.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),n&&(i.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))}},{key:"PrepareUniformsAndSamplersList",value:function(e,t,i){var n,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4,s=null;if(e.uniformsNames){var a=e;n=a.uniformsNames,s=a.uniformBuffersNames,t=a.samplers,i=a.defines,r=a.maxSimultaneousLights||0}else n=e,t||(t=[]);for(var o=0;o<r&&i["LIGHT"+o];o++)this.PrepareUniformsAndSamplersForLight(o,n,t,i["PROJECTEDLIGHTTEXTURE"+o],s);i.NUM_MORPH_INFLUENCERS&&n.push("morphTargetInfluences"),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(n.push("bakedVertexAnimationSettings"),n.push("bakedVertexAnimationTextureSizeInverted"),n.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}},{key:"HandleFallbacksForShadows",value:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=0,s=0;s<i&&e["LIGHT"+s];s++)s>0&&(r=n+s,t.addFallback(r,"LIGHT"+s)),e.SHADOWS||(e["SHADOW"+s]&&t.addFallback(n,"SHADOW"+s),e["SHADOWPCF"+s]&&t.addFallback(n,"SHADOWPCF"+s),e["SHADOWPCSS"+s]&&t.addFallback(n,"SHADOWPCSS"+s),e["SHADOWPOISSON"+s]&&t.addFallback(n,"SHADOWPOISSON"+s),e["SHADOWESM"+s]&&t.addFallback(n,"SHADOWESM"+s),e["SHADOWCLOSEESM"+s]&&t.addFallback(n,"SHADOWCLOSEESM"+s));return r++}},{key:"PrepareAttributesForMorphTargetsInfluencers",value:function(e,t,i){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=i,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)}},{key:"PrepareAttributesForMorphTargets",value:function(e,t,i){var n=i.NUM_MORPH_INFLUENCERS;if(n>0&&V.LastCreatedEngine){var r=V.LastCreatedEngine.getCaps().maxVertexAttribs,s=t.morphTargetManager;if(null!=s&&s.isUsingTextureForTargets)return;for(var a=s&&s.supportsNormals&&i.NORMAL,o=s&&s.supportsTangents&&i.TANGENT,l=s&&s.supportsUVs&&i.UV1,u=0;u<n;u++)e.push(ni.PositionKind+u),a&&e.push(ni.NormalKind+u),o&&e.push(ni.TangentKind+u),l&&e.push(ni.UVKind+"_"+u),e.length>r&&ue.Error("Cannot add more vertex attributes for mesh "+t.name)}}},{key:"PrepareAttributesForBakedVertexAnimation",value:function(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}},{key:"PrepareAttributesForBones",value:function(e,t,i,n){i.NUM_BONE_INFLUENCERS>0&&(n.addCPUSkinningFallback(0,t),e.push(ni.MatricesIndicesKind),e.push(ni.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(e.push(ni.MatricesIndicesExtraKind),e.push(ni.MatricesWeightsExtraKind)))}},{key:"PrepareAttributesForInstances",value:function(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(ni.ColorInstanceKind)}},{key:"PushAttributesForInstances",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}},{key:"BindLightProperties",value:function(e,t,i){e.transferToEffect(t,i+"")}},{key:"BindLight",value:function(e,t,i,n,r){var s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];e._bindLight(t,i,n,r,s)}},{key:"BindLights",value:function(e,t,i,n){for(var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:4,s=Math.min(t.lightSources.length,r),a=0;a<s;a++){var o=t.lightSources[a];this.BindLight(o,a,e,i,"boolean"==typeof n?n:n.SPECULARTERM,t.receiveShadows)}}},{key:"BindFogParameters",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e.fogEnabled&&t.applyFog&&e.fogMode!==zi.FOGMODE_NONE&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),n?(e.fogColor.toLinearSpaceToRef(this._TempFogColor),i.setColor3("vFogColor",this._TempFogColor)):i.setColor3("vFogColor",e.fogColor))}},{key:"BindBonesParameters",value:function(t,i,n){if(i&&t&&(t.computeBonesUsingShaders&&i._bonesComputationForcedToCPU&&(t.computeBonesUsingShaders=!1),t.useBones&&t.computeBonesUsingShaders&&t.skeleton)){var r=t.skeleton;if(r.isUsingTextureForMatrices&&i.getUniformIndex("boneTextureWidth")>-1){var s=r.getTransformMatrixTexture(t);i.setTexture("boneSampler",s),i.setFloat("boneTextureWidth",4*(r.bones.length+1))}else{var a=r.getTransformMatrices(t);a&&(i.setMatrices("mBones",a),n&&t.getScene().prePassRenderer&&t.getScene().prePassRenderer.getIndex(2)&&(n.previousBones[t.uniqueId]||(n.previousBones[t.uniqueId]=a.slice()),i.setMatrices("mPreviousBones",n.previousBones[t.uniqueId]),e._CopyBonesTransformationMatrices(a,n.previousBones[t.uniqueId])))}}}},{key:"_CopyBonesTransformationMatrices",value:function(e,t){return t.set(e),t}},{key:"BindMorphTargetParameters",value:function(e,t){var i=e.morphTargetManager;!e||!i||t.setFloatArray("morphTargetInfluences",i.influences)}},{key:"BindLogDepth",value:function(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){var n=i.activeCamera;n.mode===ji.ORTHOGRAPHIC_CAMERA&&ue.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(n.maxZ+1)/Math.LN2))}}}]),e}();An._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0},An._TempFogColor=Ze.Black();var Rn,Cn=function(){function e(){(0,m.Z)(this,e),this.reset()}return(0,y.Z)(e,[{key:"reset",value:function(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}},{key:"func",get:function(){return this._func},set:function(e){this._func=e}},{key:"funcRef",get:function(){return this._funcRef},set:function(e){this._funcRef=e}},{key:"funcMask",get:function(){return this._funcMask},set:function(e){this._funcMask=e}},{key:"opStencilFail",get:function(){return this._opStencilFail},set:function(e){this._opStencilFail=e}},{key:"opDepthFail",get:function(){return this._opDepthFail},set:function(e){this._opDepthFail=e}},{key:"opStencilDepthPass",get:function(){return this._opStencilDepthPass},set:function(e){this._opStencilDepthPass=e}},{key:"mask",get:function(){return this._mask},set:function(e){this._mask=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"getClassName",value:function(){return"MaterialStencilState"}},{key:"copyTo",value:function(e){jt.Clone((function(){return e}),this)}},{key:"serialize",value:function(){return jt.Serialize(this)}},{key:"parse",value:function(e,t,i){var n=this;jt.Parse((function(){return n}),e,t,i)}}]),e}();Nt([Xt()],Cn.prototype,"func",null),Nt([Xt()],Cn.prototype,"funcRef",null),Nt([Xt()],Cn.prototype,"funcMask",null),Nt([Xt()],Cn.prototype,"opStencilFail",null),Nt([Xt()],Cn.prototype,"opDepthFail",null),Nt([Xt()],Cn.prototype,"opStencilDepthPass",null),Nt([Xt()],Cn.prototype,"mask",null),Nt([Xt()],Cn.prototype,"enabled",null),function(e){e[e.Created=1]="Created",e[e.Disposed=2]="Disposed",e[e.GetDefineNames=4]="GetDefineNames",e[e.PrepareUniformBuffer=8]="PrepareUniformBuffer",e[e.IsReadyForSubMesh=16]="IsReadyForSubMesh",e[e.PrepareDefines=32]="PrepareDefines",e[e.BindForSubMesh=64]="BindForSubMesh",e[e.PrepareEffect=128]="PrepareEffect",e[e.GetAnimatables=256]="GetAnimatables",e[e.GetActiveTextures=512]="GetActiveTextures",e[e.HasTexture=1024]="HasTexture",e[e.FillRenderTargetTextures=2048]="FillRenderTargetTextures",e[e.HasRenderTargetTextures=4096]="HasRenderTargetTextures",e[e.HardBindForSubMesh=8192]="HardBindForSubMesh"}(Rn||(Rn={}));var In=function(){function e(t,i,n){(0,m.Z)(this,e),this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new ee,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new Cn,this._useUBO=!1,this._fillMode=e.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=function(){},this._callbackPluginEventIsReadyForSubMesh=function(){},this._callbackPluginEventPrepareDefines=function(){},this._callbackPluginEventPrepareDefinesBeforeAttributes=function(){},this._callbackPluginEventHardBindForSubMesh=function(){},this._callbackPluginEventBindForSubMesh=function(){},this._callbackPluginEventHasRenderTargetTextures=function(){},this._callbackPluginEventFillRenderTargetTextures=function(){},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=t;var r=i||V.LastCreatedScene;r&&(this._scene=r,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=t||It.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new Le(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=e.ClockWiseSideOrientation:this.sideOrientation=e.CounterClockWiseSideOrientation,this._uniformBuffer=new ti(this._scene.getEngine(),void 0,void 0,t),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,n||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),e.OnEventObservable.notifyObservers(this,Rn.Created))}return(0,y.Z)(e,[{key:"canRenderToMRT",get:function(){return!1}},{key:"alpha",get:function(){return this._alpha},set:function(t){if(this._alpha!==t){var i=this._alpha;this._alpha=t,(1===i||1===t)&&this.markAsDirty(e.MiscDirtyFlag)}}},{key:"backFaceCulling",get:function(){return this._backFaceCulling},set:function(t){this._backFaceCulling!==t&&(this._backFaceCulling=t,this.markAsDirty(e.TextureDirtyFlag))}},{key:"cullBackFaces",get:function(){return this._cullBackFaces},set:function(t){this._cullBackFaces!==t&&(this._cullBackFaces=t,this.markAsDirty(e.TextureDirtyFlag))}},{key:"blockDirtyMechanism",get:function(){return this._blockDirtyMechanism},set:function(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}},{key:"atomicMaterialsUpdate",value:function(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}},{key:"hasRenderTargetTextures",get:function(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}},{key:"onDispose",set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}},{key:"onBindObservable",get:function(){return this._onBindObservable||(this._onBindObservable=new ee),this._onBindObservable}},{key:"onBind",set:function(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}},{key:"onUnBindObservable",get:function(){return this._onUnBindObservable||(this._onUnBindObservable=new ee),this._onUnBindObservable}},{key:"onEffectCreatedObservable",get:function(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new ee),this._onEffectCreatedObservable}},{key:"alphaMode",get:function(){return this._alphaMode},set:function(t){this._alphaMode!==t&&(this._alphaMode=t,this.markAsDirty(e.TextureDirtyFlag))}},{key:"needDepthPrePass",get:function(){return this._needDepthPrePass},set:function(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}},{key:"isPrePassCapable",get:function(){return!1}},{key:"fogEnabled",get:function(){return this._fogEnabled},set:function(t){this._fogEnabled!==t&&(this._fogEnabled=t,this.markAsDirty(e.MiscDirtyFlag))}},{key:"wireframe",get:function(){switch(this._fillMode){case e.WireFrameFillMode:case e.LineListDrawMode:case e.LineLoopDrawMode:case e.LineStripDrawMode:return!0}return this._scene.forceWireframe},set:function(t){this.fillMode=t?e.WireFrameFillMode:e.TriangleFillMode}},{key:"pointsCloud",get:function(){switch(this._fillMode){case e.PointFillMode:case e.PointListDrawMode:return!0}return this._scene.forcePointsCloud},set:function(t){this.fillMode=t?e.PointFillMode:e.TriangleFillMode}},{key:"fillMode",get:function(){return this._fillMode},set:function(t){this._fillMode!==t&&(this._fillMode=t,this.markAsDirty(e.MiscDirtyFlag))}},{key:"_getDrawWrapper",value:function(){return this._drawWrapper}},{key:"_setDrawWrapper",value:function(e){this._drawWrapper=e}},{key:"toString",value:function(e){return"Name: "+this.name}},{key:"getClassName",value:function(){return"Material"}},{key:"_isMaterial",get:function(){return!0}},{key:"isFrozen",get:function(){return this.checkReadyOnlyOnce}},{key:"freeze",value:function(){this.markDirty(),this.checkReadyOnlyOnce=!0}},{key:"unfreeze",value:function(){this.markDirty(),this.checkReadyOnlyOnce=!1}},{key:"isReady",value:function(e,t){return!0}},{key:"isReadyForSubMesh",value:function(e,t,i){var n=t.materialDefines;return!!n&&(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh)}},{key:"getEffect",value:function(){return this._drawWrapper.effect}},{key:"getScene",value:function(){return this._scene}},{key:"transparencyMode",get:function(){return this._transparencyMode},set:function(t){this._transparencyMode!==t&&(this._transparencyMode=t,this._forceAlphaTest=t===e.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}},{key:"_disableAlphaBlending",get:function(){return this._transparencyMode===e.MATERIAL_OPAQUE||this._transparencyMode===e.MATERIAL_ALPHATEST}},{key:"needAlphaBlending",value:function(){return!this._disableAlphaBlending&&this.alpha<1}},{key:"needAlphaBlendingForMesh",value:function(e){return e.visibility<1||!this._disableAlphaBlending&&(e.hasVertexAlpha||this.needAlphaBlending())}},{key:"needAlphaTesting",value:function(){return!!this._forceAlphaTest}},{key:"_shouldTurnAlphaTestOn",value:function(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}},{key:"getAlphaTestTexture",value:function(){return null}},{key:"markDirty",value:function(){var t,i=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=this.getScene().meshes,r=(0,p.Z)(n);try{for(r.s();!(t=r.n()).done;){var s=t.value;if(s.subMeshes){var a,o=(0,p.Z)(s.subMeshes);try{for(o.s();!(a=o.n()).done;){var l=a.value;l.getMaterial()===this&&l.effect&&(l.effect._wasPreviouslyReady=!1,l.effect._wasPreviouslyUsingInstances=null,l.effect._forceRebindOnNextCall=i)}}catch(u){o.e(u)}finally{o.f()}}}}catch(u){r.e(u)}finally{r.f()}i&&this.markAsDirty(e.AllDirtyFlag)}},{key:"_preBind",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this._scene.getEngine(),r=(null!==i&&void 0!==i?i:this.sideOrientation)===e.ClockWiseSideOrientation;return n.enableEffect(t||this._getDrawWrapper()),n.setState(this.backFaceCulling,this.zOffset,!1,r,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),r}},{key:"bind",value:function(e,t){}},{key:"buildUniformLayout",value:function(){var e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(Rn.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}},{key:"bindForSubMesh",value:function(e,t,i){var n=i.effect;n&&(this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),n._forceRebindOnNextCall=!1)}},{key:"bindOnlyWorldMatrix",value:function(e){}},{key:"bindView",value:function(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}},{key:"bindViewProjection",value:function(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}},{key:"bindEyePosition",value:function(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}},{key:"_afterBind",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,An.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),this._scene._cachedVisibility=e?e.visibility:1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){var i=this._scene.getEngine();this._cachedDepthWriteState=i.getDepthWrite(),i.setDepthWrite(!1)}if(this.disableColorWrite){var n=this._scene.getEngine();this._cachedColorWriteState=n.getColorWrite(),n.setColorWrite(!1)}if(0!==this.depthFunction){var r=this._scene.getEngine();this._cachedDepthFunctionState=r.getDepthFunction()||0,r.setDepthFunction(this.depthFunction)}}},{key:"unbind",value:function(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),0!==this.depthFunction&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}},{key:"getAnimatables",value:function(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(Rn.GetAnimatables,this._eventInfo),this._eventInfo.animatables}},{key:"getActiveTextures",value:function(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(Rn.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}},{key:"hasTexture",value:function(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(Rn.HasTexture,this._eventInfo),this._eventInfo.hasTexture}},{key:"clone",value:function(e){return null}},{key:"getBindedMeshes",value:function(){var e=this;if(this.meshMap){var t=new Array;for(var i in this.meshMap){var n=this.meshMap[i];n&&t.push(n)}return t}return this._scene.meshes.filter((function(t){return t.material===e}))}},{key:"forceCompilation",value:function(e,t,i,n){var r=this,s=(0,a.Z)({clipPlane:!1,useInstances:!1},i),o=this.getScene(),l=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;!function i(){if(r._scene&&r._scene.getEngine()){var a=o.clipPlane;if(s.clipPlane&&(o.clipPlane=new Bi(0,0,0,1)),r._storeEffectOnSubMeshes){var u=!0,h=null;if(e.subMeshes){var c=new un(0,0,0,0,0,e,void 0,!1,!1);c.materialDefines&&(c.materialDefines._renderId=-1),r.isReadyForSubMesh(e,c,s.useInstances)||(c.effect&&c.effect.getCompilationError()&&c.effect.allFallbacksProcessed()?h=c.effect.getCompilationError():(u=!1,setTimeout(i,16)))}u&&(r.allowShaderHotSwapping=l,h&&n&&n(h),t&&t(r))}else r.isReady()?(r.allowShaderHotSwapping=l,t&&t(r)):setTimeout(i,16);s.clipPlane&&(o.clipPlane=a)}}()}},{key:"forceCompilationAsync",value:function(e,t){var i=this;return new Promise((function(n,r){i.forceCompilation(e,(function(){n()}),t,(function(e){r(e)}))}))}},{key:"markAsDirty",value:function(t){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(e._DirtyCallbackArray.length=0,t&e.TextureDirtyFlag&&e._DirtyCallbackArray.push(e._TextureDirtyCallBack),t&e.LightDirtyFlag&&e._DirtyCallbackArray.push(e._LightsDirtyCallBack),t&e.FresnelDirtyFlag&&e._DirtyCallbackArray.push(e._FresnelDirtyCallBack),t&e.AttributesDirtyFlag&&e._DirtyCallbackArray.push(e._AttributeDirtyCallBack),t&e.MiscDirtyFlag&&e._DirtyCallbackArray.push(e._MiscDirtyCallBack),t&e.PrePassDirtyFlag&&e._DirtyCallbackArray.push(e._PrePassDirtyCallBack),e._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(e._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}},{key:"resetDrawCache",value:function(){var e,t=this.getScene().meshes,i=(0,p.Z)(t);try{for(i.s();!(e=i.n()).done;){var n=e.value;if(n.subMeshes){var r,s=(0,p.Z)(n.subMeshes);try{for(s.s();!(r=s.n()).done;){var a=r.value;a.getMaterial()===this&&a.resetDrawCache()}}catch(o){s.e(o)}finally{s.f()}}}}catch(o){i.e(o)}finally{i.f()}}},{key:"_markAllSubMeshesAsDirty",value:function(e){if(!this.getScene().blockMaterialDirtyMechanism&&!this._blockDirtyMechanism){var t,i=this.getScene().meshes,n=(0,p.Z)(i);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.subMeshes){var s,a=(0,p.Z)(r.subMeshes);try{for(a.s();!(s=a.n()).done;){var o=s.value;if(o.getMaterial(!1)===this){var l,u=(0,p.Z)(o._drawWrappers);try{for(u.s();!(l=u.n()).done;){var h=l.value;!h||!h.defines||!h.defines.markAllAsDirty||this._materialContext===h.materialContext&&e(h.defines)}}catch(c){u.e(c)}finally{u.f()}}}}catch(c){a.e(c)}finally{a.f()}}}}catch(c){n.e(c)}finally{n.f()}}}},{key:"_markScenePrePassDirty",value:function(){if(!this.getScene().blockMaterialDirtyMechanism&&!this._blockDirtyMechanism){var e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}}},{key:"_markAllSubMeshesAsAllDirty",value:function(){this._markAllSubMeshesAsDirty(e._AllDirtyCallBack)}},{key:"_markAllSubMeshesAsImageProcessingDirty",value:function(){this._markAllSubMeshesAsDirty(e._ImageProcessingDirtyCallBack)}},{key:"_markAllSubMeshesAsTexturesDirty",value:function(){this._markAllSubMeshesAsDirty(e._TextureDirtyCallBack)}},{key:"_markAllSubMeshesAsFresnelDirty",value:function(){this._markAllSubMeshesAsDirty(e._FresnelDirtyCallBack)}},{key:"_markAllSubMeshesAsFresnelAndMiscDirty",value:function(){this._markAllSubMeshesAsDirty(e._FresnelAndMiscDirtyCallBack)}},{key:"_markAllSubMeshesAsLightsDirty",value:function(){this._markAllSubMeshesAsDirty(e._LightsDirtyCallBack)}},{key:"_markAllSubMeshesAsAttributesDirty",value:function(){this._markAllSubMeshesAsDirty(e._AttributeDirtyCallBack)}},{key:"_markAllSubMeshesAsMiscDirty",value:function(){this._markAllSubMeshesAsDirty(e._MiscDirtyCallBack)}},{key:"_markAllSubMeshesAsPrePassDirty",value:function(){this._markAllSubMeshesAsDirty(e._MiscDirtyCallBack)}},{key:"_markAllSubMeshesAsTexturesAndMiscDirty",value:function(){this._markAllSubMeshesAsDirty(e._TextureAndMiscDirtyCallBack)}},{key:"setPrePassRenderer",value:function(e){return!1}},{key:"dispose",value:function(e,t,i){var n=this.getScene();if(n.stopAnimation(this),n.freeProcessedMaterials(),n.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(Rn.Disposed,this._eventInfo),this._parentContainer){var r=this._parentContainer.materials.indexOf(this);r>-1&&this._parentContainer.materials.splice(r,1),this._parentContainer=null}if(!0!==i)if(this.meshMap)for(var s in this.meshMap){var a=this.meshMap[s];a&&(a.material=null,this.releaseVertexArrayObject(a,e))}else{var o,l=n.meshes,u=(0,p.Z)(l);try{for(u.s();!(o=u.n()).done;){var h=o.value;h.material===this&&!h.sourceMesh&&(h.material=null,this.releaseVertexArrayObject(h,e))}}catch(c){u.e(c)}finally{u.f()}}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}},{key:"releaseVertexArrayObject",value:function(e,t){if(e.geometry){var i=e.geometry;if(this._storeEffectOnSubMeshes){var n,r=(0,p.Z)(e.subMeshes);try{for(r.s();!(n=r.n()).done;){var s=n.value;i._releaseVertexArrayObject(s.effect),t&&s.effect&&s.effect.dispose()}}catch(a){r.e(a)}finally{r.f()}}else i._releaseVertexArrayObject(this._drawWrapper.effect)}}},{key:"serialize",value:function(){var e=jt.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,e}}],[{key:"Parse",value:function(e,t,i){if(e.customType){if("BABYLON.PBRMaterial"===e.customType&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return ue.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null}else e.customType="BABYLON.StandardMaterial";var n=It.Instantiate(e.customType).Parse(e,t,i);return n._loadedUniqueId=e.uniqueId,n}}]),e}();In.TriangleFillMode=0,In.WireFrameFillMode=1,In.PointFillMode=2,In.PointListDrawMode=3,In.LineListDrawMode=4,In.LineLoopDrawMode=5,In.LineStripDrawMode=6,In.TriangleStripDrawMode=7,In.TriangleFanDrawMode=8,In.ClockWiseSideOrientation=0,In.CounterClockWiseSideOrientation=1,In.TextureDirtyFlag=1,In.LightDirtyFlag=2,In.FresnelDirtyFlag=4,In.AttributesDirtyFlag=8,In.MiscDirtyFlag=16,In.PrePassDirtyFlag=32,In.AllDirtyFlag=63,In.MATERIAL_OPAQUE=0,In.MATERIAL_ALPHATEST=1,In.MATERIAL_ALPHABLEND=2,In.MATERIAL_ALPHATESTANDBLEND=3,In.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,In.MATERIAL_NORMALBLENDMETHOD_RNM=1,In.OnEventObservable=new ee,In._AllDirtyCallBack=function(e){return e.markAllAsDirty()},In._ImageProcessingDirtyCallBack=function(e){return e.markAsImageProcessingDirty()},In._TextureDirtyCallBack=function(e){return e.markAsTexturesDirty()},In._FresnelDirtyCallBack=function(e){return e.markAsFresnelDirty()},In._MiscDirtyCallBack=function(e){return e.markAsMiscDirty()},In._PrePassDirtyCallBack=function(e){return e.markAsPrePassDirty()},In._LightsDirtyCallBack=function(e){return e.markAsLightDirty()},In._AttributeDirtyCallBack=function(e){return e.markAsAttributesDirty()},In._FresnelAndMiscDirtyCallBack=function(e){In._FresnelDirtyCallBack(e),In._MiscDirtyCallBack(e)},In._TextureAndMiscDirtyCallBack=function(e){In._TextureDirtyCallBack(e),In._MiscDirtyCallBack(e)},In._DirtyCallbackArray=[],In._RunDirtyCallBacks=function(e){var t,i=(0,p.Z)(In._DirtyCallbackArray);try{for(i.s();!(t=i.n()).done;){(0,t.value)(e)}}catch(n){i.e(n)}finally{i.f()}},Nt([Xt()],In.prototype,"id",void 0),Nt([Xt()],In.prototype,"uniqueId",void 0),Nt([Xt()],In.prototype,"name",void 0),Nt([Xt()],In.prototype,"metadata",void 0),Nt([Xt()],In.prototype,"checkReadyOnEveryCall",void 0),Nt([Xt()],In.prototype,"checkReadyOnlyOnce",void 0),Nt([Xt()],In.prototype,"state",void 0),Nt([Xt("alpha")],In.prototype,"_alpha",void 0),Nt([Xt("backFaceCulling")],In.prototype,"_backFaceCulling",void 0),Nt([Xt("cullBackFaces")],In.prototype,"_cullBackFaces",void 0),Nt([Xt()],In.prototype,"sideOrientation",void 0),Nt([Xt("alphaMode")],In.prototype,"_alphaMode",void 0),Nt([Xt()],In.prototype,"_needDepthPrePass",void 0),Nt([Xt()],In.prototype,"disableDepthWrite",void 0),Nt([Xt()],In.prototype,"disableColorWrite",void 0),Nt([Xt()],In.prototype,"forceDepthWrite",void 0),Nt([Xt()],In.prototype,"depthFunction",void 0),Nt([Xt()],In.prototype,"separateCullingPass",void 0),Nt([Xt("fogEnabled")],In.prototype,"_fogEnabled",void 0),Nt([Xt()],In.prototype,"pointSize",void 0),Nt([Xt()],In.prototype,"zOffset",void 0),Nt([Xt()],In.prototype,"zOffsetUnits",void 0),Nt([Xt()],In.prototype,"pointsCloud",null),Nt([Xt()],In.prototype,"fillMode",null),Nt([Xt()],In.prototype,"transparencyMode",null);var Pn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r;return(0,m.Z)(this,i),(r=t.call(this,e,n,!0))._waitingSubMaterialsUniqueIds=[],r.getScene().multiMaterials.push((0,u.Z)(r)),r.subMaterials=new Array,r._storeEffectOnSubMeshes=!0,r}return(0,y.Z)(i,[{key:"subMaterials",get:function(){return this._subMaterials},set:function(e){this._subMaterials=e,this._hookArray(e)}},{key:"getChildren",value:function(){return this.subMaterials}},{key:"_hookArray",value:function(e){var t=this,i=e.push;e.push=function(){for(var n=arguments.length,r=new Array(n),s=0;s<n;s++)r[s]=arguments[s];var a=i.apply(e,r);return t._markAllSubMeshesAsTexturesDirty(),a};var n=e.splice;e.splice=function(i,r){var s=n.apply(e,[i,r]);return t._markAllSubMeshesAsTexturesDirty(),s}}},{key:"getSubMaterial",value:function(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}},{key:"getActiveTextures",value:function(){var e;return(e=c((0,h.Z)(i.prototype),"getActiveTextures",this).call(this)).concat.apply(e,(0,s.Z)(this.subMaterials.map((function(e){return e?e.getActiveTextures():[]}))))}},{key:"hasTexture",value:function(e){var t;if(c((0,h.Z)(i.prototype),"hasTexture",this).call(this,e))return!0;for(var n=0;n<this.subMaterials.length;n++)if(null!==(t=this.subMaterials[n])&&void 0!==t&&t.hasTexture(e))return!0;return!1}},{key:"getClassName",value:function(){return"MultiMaterial"}},{key:"isReadyForSubMesh",value:function(e,t,i){for(var n=0;n<this.subMaterials.length;n++){var r=this.subMaterials[n];if(r){if(r._storeEffectOnSubMeshes){if(!r.isReadyForSubMesh(e,t,i))return!1;continue}if(!r.isReady(e))return!1}}return!0}},{key:"clone",value:function(e,t){for(var n=new i(e,this.getScene()),r=0;r<this.subMaterials.length;r++){var s=null,a=this.subMaterials[r];s=t&&a?a.clone(e+"-"+a.name):this.subMaterials[r],n.subMaterials.push(s)}return n}},{key:"serialize",value:function(){var e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,Ot&&(e.tags=Ot.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(var t=0;t<this.subMaterials.length;t++){var i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}},{key:"dispose",value:function(e,t,n){var r=this.getScene();if(r){if(n)for(var s=0;s<this.subMaterials.length;s++){var a=this.subMaterials[s];a&&a.dispose(e,t)}var o=r.multiMaterials.indexOf(this);o>=0&&r.multiMaterials.splice(o,1),c((0,h.Z)(i.prototype),"dispose",this).call(this,e,t)}}}],[{key:"ParseMultiMaterial",value:function(e,t){var n=new i(e.name,t);return n.id=e.id,n._loadedUniqueId=e.uniqueId,Ot&&Ot.AddTagsTo(n,e.tags),e.materialsUniqueIds?n._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach((function(e){return n.subMaterials.push(t.getLastMaterialById(e))})),n}}]),i}(In);N("BABYLON.MultiMaterial",Pn);var kn=(0,y.Z)((function e(t,i){(0,m.Z)(this,e),this.distanceOrScreenCoverage=t,this.mesh=i})),Dn=(0,y.Z)((function e(){(0,m.Z)(this,e),this.visibleInstances={},this.batchCache=new Fn,this.batchCacheReplacementModeInFrozenMode=new Fn,this.instancesBufferSize=2048})),Fn=(0,y.Z)((function e(){(0,m.Z)(this,e),this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array})),wn=(0,y.Z)((function e(){(0,m.Z)(this,e),this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null})),On=(0,y.Z)((function e(){(0,m.Z)(this,e),this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0})),Ln=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4?arguments[4]:void 0,h=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];if((0,m.Z)(this,i),(n=t.call(this,e,r))._internalMeshDataInfo=new On,n.delayLoadState=0,n.instances=new Array,n._creationDataStorage=null,n._geometry=null,n._instanceDataStorage=new Dn,n._thinInstanceDataStorage=new wn,n._shouldGenerateFlatShading=!1,n._originalBuilderSideOrientation=i.DEFAULTSIDE,n.overrideMaterialSideOrientation=null,n.ignoreCameraMaxZ=!1,r=n.getScene(),n._onBeforeDraw=function(e,t,i){e&&i&&(n._uniformBuffer?n.transferToEffect(t):i.bindOnlyWorldMatrix(t))},a){if(a._geometry&&a._geometry.applyToMesh((0,u.Z)(n)),je.DeepCopy(a,(0,u.Z)(n),["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),n._internalMeshDataInfo._source=a,r.useClonedMeshMap&&(a._internalMeshDataInfo.meshMap||(a._internalMeshDataInfo.meshMap={}),a._internalMeshDataInfo.meshMap[n.uniqueId]=(0,u.Z)(n)),n._originalBuilderSideOrientation=a._originalBuilderSideOrientation,n._creationDataStorage=a._creationDataStorage,a._ranges){var c=a._ranges;for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&c[d]&&n.createAnimationRange(d,c[d].from,c[d].to)}if(a.metadata&&a.metadata.clone?n.metadata=a.metadata.clone():n.metadata=a.metadata,Ot&&Ot.HasTags(a)&&Ot.AddTagsTo((0,u.Z)(n),Ot.GetTags(a,!0)),n.setEnabled(a.isEnabled(!1)),n.parent=a.parent,n.setPivotMatrix(a.getPivotMatrix()),n.id=e+"."+a.id,n.material=a.material,!o)for(var f=a.getDescendants(!0),_=0;_<f.length;_++){var v=f[_];v.clone&&v.clone(e+"."+v.name,(0,u.Z)(n))}if(a.morphTargetManager&&(n.morphTargetManager=a.morphTargetManager),r.getPhysicsEngine){var g=r.getPhysicsEngine();if(h&&g&&1===g.getPluginVersion()){var p=g.getImpostorForPhysicsObject(a);p&&(n.physicsImpostor=p.clone((0,u.Z)(n)))}}for(var y=0;y<r.particleSystems.length;y++){var T=r.particleSystems[y];T.emitter===a&&T.clone(T.name,(0,u.Z)(n))}n.skeleton=a.skeleton,n.refreshBoundingInfo(!0,!0),n.computeWorldMatrix(!0)}return null!==s&&(n.parent=s),n._instanceDataStorage.hardwareInstancedRendering=n.getEngine().getCaps().instancedArrays,n._internalMeshDataInfo._onMeshReadyObserverAdded=function(e){e.unregisterOnNextCall=!0,n.isReady(!0)?n.onMeshReadyObservable.notifyObservers((0,u.Z)(n)):n._internalMeshDataInfo._checkReadinessObserver||(n._internalMeshDataInfo._checkReadinessObserver=n._scene.onBeforeRenderObservable.add((function(){n.isReady(!0)&&(n._scene.onBeforeRenderObservable.remove(n._internalMeshDataInfo._checkReadinessObserver),n._internalMeshDataInfo._checkReadinessObserver=null,n.onMeshReadyObservable.notifyObservers((0,u.Z)(n)))})))},n.onMeshReadyObservable=new ee(n._internalMeshDataInfo._onMeshReadyObserverAdded),a&&a.onClonedObservable.notifyObservers((0,u.Z)(n)),(0,l.Z)(n)}return(0,y.Z)(i,[{key:"useLODScreenCoverage",get:function(){return this._internalMeshDataInfo._useLODScreenCoverage},set:function(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}},{key:"computeBonesUsingShaders",get:function(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders},set:function(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(ni.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(ni.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}},{key:"onBeforeRenderObservable",get:function(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new ee),this._internalMeshDataInfo._onBeforeRenderObservable}},{key:"onBeforeBindObservable",get:function(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new ee),this._internalMeshDataInfo._onBeforeBindObservable}},{key:"onAfterRenderObservable",get:function(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new ee),this._internalMeshDataInfo._onAfterRenderObservable}},{key:"onBetweenPassObservable",get:function(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new ee),this._internalMeshDataInfo._onBetweenPassObservable}},{key:"onBeforeDrawObservable",get:function(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new ee),this._internalMeshDataInfo._onBeforeDrawObservable}},{key:"onBeforeDraw",set:function(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}},{key:"hasInstances",get:function(){return this.instances.length>0}},{key:"hasThinInstances",get:function(){var e;return(null!==(e=this._thinInstanceDataStorage.instancesCount)&&void 0!==e?e:0)>0}},{key:"forcedInstanceCount",get:function(){return this._internalMeshDataInfo._forcedInstanceCount},set:function(e){this._internalMeshDataInfo._forcedInstanceCount=e}},{key:"source",get:function(){return this._internalMeshDataInfo._source}},{key:"cloneMeshMap",get:function(){return this._internalMeshDataInfo.meshMap}},{key:"isUnIndexed",get:function(){return this._unIndexed},set:function(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}},{key:"worldMatrixInstancedBuffer",get:function(){return this._instanceDataStorage.instancesData}},{key:"previousWorldMatrixInstancedBuffer",get:function(){return this._instanceDataStorage.instancesPreviousData}},{key:"manualUpdateOfWorldMatrixInstancedBuffer",get:function(){return this._instanceDataStorage.manualUpdate},set:function(e){this._instanceDataStorage.manualUpdate=e}},{key:"manualUpdateOfPreviousWorldMatrixInstancedBuffer",get:function(){return this._instanceDataStorage.previousManualUpdate},set:function(e){this._instanceDataStorage.previousManualUpdate=e}},{key:"forceWorldMatrixInstancedBufferUpdate",get:function(){return this._instanceDataStorage.forceMatrixUpdates},set:function(e){this._instanceDataStorage.forceMatrixUpdates=e}},{key:"instantiateHierarchy",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0,n=0===this.getTotalVertices()||t&&t.doNotInstantiate&&(!0===t.doNotInstantiate||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));n.parent=e||this.parent,n.position=this.position.clone(),n.scaling=this.scaling.clone(),this.rotationQuaternion?n.rotationQuaternion=this.rotationQuaternion.clone():n.rotation=this.rotation.clone(),i&&i(this,n);var r,s=(0,p.Z)(this.getChildTransformNodes(!0));try{for(s.s();!(r=s.n()).done;){var a=r.value;"InstancedMesh"===a.getClassName()&&"Mesh"===n.getClassName()?a.instantiateHierarchy(n,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:n},i):a.instantiateHierarchy(n,t,i)}}catch(o){s.e(o)}finally{s.f()}return n}},{key:"getClassName",value:function(){return"Mesh"}},{key:"_isMesh",get:function(){return!0}},{key:"toString",value:function(e){var t=c((0,h.Z)(i.prototype),"toString",this).call(this,e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(var n=0;n<this.animations.length;n++)t+=", animation[0]: "+this.animations[n].toString(e);if(e)if(this._geometry){var r=this.getIndices(),s=this.getVerticesData(ni.PositionKind);s&&r&&(t+=", flat shading: "+(s.length/3===r.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}},{key:"_unBindEffect",value:function(){c((0,h.Z)(i.prototype),"_unBindEffect",this).call(this);var e,t=(0,p.Z)(this.instances);try{for(t.s();!(e=t.n()).done;){e.value._unBindEffect()}}catch(n){t.e(n)}finally{t.f()}}},{key:"hasLODLevels",get:function(){return this._internalMeshDataInfo._LODLevels.length>0}},{key:"getLODLevels",value:function(){return this._internalMeshDataInfo._LODLevels}},{key:"_sortLODLevels",value:function(){var e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((function(t,i){return t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0}))}},{key:"addLODLevel",value:function(e,t){if(t&&t._masterMesh)return ue.Warn("You cannot use a mesh as LOD level twice"),this;var i=new kn(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}},{key:"getLODLevelAtDistance",value:function(e){for(var t=this._internalMeshDataInfo,i=0;i<t._LODLevels.length;i++){var n=t._LODLevels[i];if(n.distanceOrScreenCoverage===e)return n.mesh}return null}},{key:"removeLODLevel",value:function(e){for(var t=this._internalMeshDataInfo,i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}},{key:"getLOD",value:function(e,t){var i=this._internalMeshDataInfo;if(!i._LODLevels||0===i._LODLevels.length)return this;var n=t||this.getBoundingInfo().boundingSphere,r=e.mode===ji.ORTHOGRAPHIC_CAMERA?e.minZ:n.centerWorld.subtract(e.globalPosition).length(),s=r,a=1;if(i._useLODScreenCoverage){var o=e.screenArea,l=n.radiusWorld*e.minZ/r;s=(l=l*l*Math.PI)/o,a=-1}if(a*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>a*s)return this.onLODLevelSelection&&this.onLODLevelSelection(s,this,this),this;for(var u=0;u<i._LODLevels.length;u++){var h=i._LODLevels[u];if(a*h.distanceOrScreenCoverage<a*s){if(h.mesh){if(4===h.mesh.delayLoadState)return h.mesh._checkDelayState(),this;if(2===h.mesh.delayLoadState)return this;h.mesh._preActivate(),h.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(s,this,h.mesh),h.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(s,this,this),this}},{key:"geometry",get:function(){return this._geometry}},{key:"getTotalVertices",value:function(){return null===this._geometry||void 0===this._geometry?0:this._geometry.getTotalVertices()}},{key:"getVerticesData",value:function(e,t,i){var n,r;if(!this._geometry)return null;var s=null===(r=null===(n=this._userInstancedBuffersStorage)||void 0===n?void 0:n.vertexBuffers[e])||void 0===r?void 0:r.getFloatData(this._geometry.getTotalVertices(),i||t&&1!==this._geometry.meshes.length);return s||(s=this._geometry.getVerticesData(e,t,i)),s}},{key:"getVertexBuffer",value:function(e){var t,i;return this._geometry?null!==(i=null===(t=this._userInstancedBuffersStorage)||void 0===t?void 0:t.vertexBuffers[e])&&void 0!==i?i:this._geometry.getVertexBuffer(e):null}},{key:"isVerticesDataPresent",value:function(e){var t;return this._geometry?void 0!==(null===(t=this._userInstancedBuffersStorage)||void 0===t?void 0:t.vertexBuffers[e])||this._geometry.isVerticesDataPresent(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}},{key:"isVertexBufferUpdatable",value:function(e){var t,i;return this._geometry?(null===(i=null===(t=this._userInstancedBuffersStorage)||void 0===t?void 0:t.vertexBuffers[e])||void 0===i?void 0:i.isUpdatable())||this._geometry.isVertexBufferUpdatable(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}},{key:"getVerticesDataKinds",value:function(){if(!this._geometry){var e=new Array;return this._delayInfo&&this._delayInfo.forEach((function(t){e.push(t)})),e}var t=this._geometry.getVerticesDataKinds();if(this._userInstancedBuffersStorage)for(var i in this._userInstancedBuffersStorage.vertexBuffers)t.push(i);return t}},{key:"getTotalIndices",value:function(){return this._geometry?this._geometry.getTotalIndices():0}},{key:"getIndices",value:function(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}},{key:"isBlocked",get:function(){return null!==this._masterMesh&&void 0!==this._masterMesh}},{key:"isReady",value:function(){var e,t,n,r,s,a,o=arguments.length>0&&void 0!==arguments[0]&&arguments[0],l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(2===this.delayLoadState||!c((0,h.Z)(i.prototype),"isReady",this).call(this,o))return!1;if(!this.subMeshes||0===this.subMeshes.length||!o)return!0;var u=this.getEngine(),d=this.getScene(),f=l||u.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();var _=this.material||d.defaultMaterial;if(_)if(_._storeEffectOnSubMeshes){var v,g=(0,p.Z)(this.subMeshes);try{for(g.s();!(v=g.n()).done;){var m=v.value,y=m.getMaterial();if(y)if(y._storeEffectOnSubMeshes){if(!y.isReadyForSubMesh(this,m,f))return!1}else if(!y.isReady(this,f))return!1}}catch(F){g.e(F)}finally{g.f()}}else if(!_.isReady(this,f))return!1;var T,E=u.currentRenderPassId,S=(0,p.Z)(this.lightSources);try{for(S.s();!(T=S.n()).done;){var b=T.value.getShadowGenerators();if(b)for(var x=b.values(),M=x.next();!0!==M.done;M=x.next()){var A=M.value;if(A&&(null===(e=A.getShadowMap())||void 0===e||!e.renderList||null!==(t=A.getShadowMap())&&void 0!==t&&t.renderList&&-1!==(null===(r=null===(n=A.getShadowMap())||void 0===n?void 0:n.renderList)||void 0===r?void 0:r.indexOf(this)))){A.getShadowMap()&&(u.currentRenderPassId=A.getShadowMap().renderPassId);var R,C=(0,p.Z)(this.subMeshes);try{for(C.s();!(R=C.n()).done;){var I=R.value;if(!A.isReady(I,f,null!==(a=null===(s=I.getMaterial())||void 0===s?void 0:s.needAlphaBlendingForMesh(this))&&void 0!==a&&a))return u.currentRenderPassId=E,!1}}catch(F){C.e(F)}finally{C.f()}u.currentRenderPassId=E}}}}catch(F){S.e(F)}finally{S.f()}var P,k=(0,p.Z)(this._internalMeshDataInfo._LODLevels);try{for(k.s();!(P=k.n()).done;){var D=P.value;if(D.mesh&&!D.mesh.isReady(f))return!1}}catch(F){k.e(F)}finally{k.f()}return!0}},{key:"areNormalsFrozen",get:function(){return this._internalMeshDataInfo._areNormalsFrozen}},{key:"freezeNormals",value:function(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}},{key:"unfreezeNormals",value:function(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}},{key:"overridenInstanceCount",set:function(e){this._instanceDataStorage.overridenInstanceCount=e}},{key:"_preActivate",value:function(){var e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t||(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null),this}},{key:"_preActivateForIntermediateRendering",value:function(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}},{key:"_registerInstanceForRenderId",value:function(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(void 0!==this._instanceDataStorage.previousRenderId&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}},{key:"_afterComputeWorldMatrix",value:function(){c((0,h.Z)(i.prototype),"_afterComputeWorldMatrix",this).call(this),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}},{key:"_postActivate",value:function(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}},{key:"refreshBoundingInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;var i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),i),this}},{key:"_createGlobalSubMesh",value:function(e){var t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){var i=this.getIndices();if(!i)return null;var n=i.length,r=!1;if(e)r=!0;else{var s,a=(0,p.Z)(this.subMeshes);try{for(a.s();!(s=a.n()).done;){var o=s.value;if(o.indexStart+o.indexCount>n){r=!0;break}if(o.verticesStart+o.verticesCount>t){r=!0;break}}}catch(l){a.e(l)}finally{a.f()}}if(!r)return this.subMeshes[0]}return this.releaseSubMeshes(),new un(0,0,t,0,this.getTotalIndices(),this)}},{key:"subdivide",value:function(e){if(!(e<1)){for(var t=this.getTotalIndices(),i=t/e|0,n=0;i%3!==0;)i++;this.releaseSubMeshes();for(var r=0;r<e&&!(n>=t);r++)un.CreateFromIndices(0,n,r===e-1?t-n:i,this),n+=i;this.synchronizeInstances()}}},{key:"setVerticesData",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3?arguments[3]:void 0;if(this._geometry)this._geometry.setVerticesData(e,t,i,n);else{var r=new Qi;r.set(t,e);var s=this.getScene();new fn(fn.RandomId(),s,r,i,this)}return this}},{key:"removeVerticesData",value:function(e){this._geometry&&this._geometry.removeVerticesData(e)}},{key:"markVerticesDataAsUpdatable",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}},{key:"setVerticesBuffer",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this._geometry||(this._geometry=fn.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}},{key:"updateVerticesData",value:function(e,t,i,n){return this._geometry?(n?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}},{key:"updateMeshPositions",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this.getVerticesData(ni.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(ni.PositionKind,i,!1,!1),t){var n=this.getIndices(),r=this.getVerticesData(ni.NormalKind);if(!r)return this;Qi.ComputeNormals(i,n,r),this.updateVerticesData(ni.NormalKind,r,!1,!1)}return this}},{key:"makeGeometryUnique",value:function(){if(!this._geometry)return this;if(1===this._geometry.meshes.length)return this;var e=this._geometry,t=this._geometry.copy(fn.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}},{key:"setIndices",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this._geometry)this._geometry.setIndices(e,t,i);else{var n=new Qi;n.indices=e;var r=this.getScene();new fn(fn.RandomId(),r,n,i,this)}return this}},{key:"updateIndices",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}},{key:"toLeftHanded",value:function(){return this._geometry?(this._geometry.toLeftHanded(),this):this}},{key:"_bind",value:function(e,t,i){if(!this._geometry)return this;var n,r=this.getScene().getEngine();if(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t),this._unIndexed)n=null;else switch(i){case In.PointFillMode:n=null;break;case In.WireFrameFillMode:n=e._getLinesIndexBuffer(this.getIndices(),r);break;default:case In.TriangleFillMode:n=this._geometry.getIndexBuffer()}return!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,n):this._geometry._bind(t,n,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this}},{key:"_draw",value:function(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);var n=this.getScene().getEngine();return this._unIndexed||t==In.PointFillMode?n.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==In.WireFrameFillMode?n.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):n.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}},{key:"registerBeforeRender",value:function(e){return this.onBeforeRenderObservable.add(e),this}},{key:"unregisterBeforeRender",value:function(e){return this.onBeforeRenderObservable.removeCallback(e),this}},{key:"registerAfterRender",value:function(e){return this.onAfterRenderObservable.add(e),this}},{key:"unregisterAfterRender",value:function(e){return this.onAfterRenderObservable.removeCallback(e),this}},{key:"_getInstancesRenderList",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}var i=this.getScene(),n=i._isInIntermediateRendering(),r=n?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,s=this._instanceDataStorage.batchCache;if(s.mustReturn=!1,s.renderSelf[e]=t||!r&&this.isEnabled()&&this.isVisible,s.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){var a=this._instanceDataStorage.visibleInstances,o=i.getRenderId(),l=n?a.intermediateDefaultRenderId:a.defaultRenderId;s.visibleInstances[e]=a[o],!s.visibleInstances[e]&&l&&(s.visibleInstances[e]=a[l])}return s.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&null!==s.visibleInstances[e]&&void 0!==s.visibleInstances[e],this._instanceDataStorage.previousBatch=s,s}},{key:"_renderWithInstances",value:function(e,t,n,r,s){for(var a,o=n.visibleInstances[e._id],l=o?o.length:0,u=this._instanceDataStorage,h=u.instancesBufferSize,c=u.instancesBuffer,d=u.instancesPreviousBuffer,f=16*(l+1)*4;u.instancesBufferSize<f;)u.instancesBufferSize*=2;(!u.instancesData||h!=u.instancesBufferSize)&&(u.instancesData=new Float32Array(u.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!u.instancesPreviousData||h!=u.instancesBufferSize)&&(u.instancesPreviousData=new Float32Array(u.instancesBufferSize/4));var _=0,v=0,g=n.renderSelf[e._id],p=!c||h!==u.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!u.instancesPreviousBuffer;if(this._instanceDataStorage.manualUpdate||u.isFrozen&&!p)v=(g?1:0)+l;else{var m=this.getWorldMatrix();if(g&&(this._scene.needsPreviousWorldMatrices&&(u.masterMeshPreviousWorldMatrix?(u.masterMeshPreviousWorldMatrix.copyToArray(u.instancesPreviousData,_),u.masterMeshPreviousWorldMatrix.copyFrom(m)):(u.masterMeshPreviousWorldMatrix=m.clone(),u.masterMeshPreviousWorldMatrix.copyToArray(u.instancesPreviousData,_))),m.copyToArray(u.instancesData,_),_+=16,v++),o){if(i.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&null!==(a=e.getMaterial())&&void 0!==a&&a.needAlphaBlendingForMesh(e.getRenderingMesh())){for(var y=this._scene.activeCamera.globalPosition,T=0;T<o.length;T++){var E=o[T];E._distanceToCamera=z.Distance(E.getBoundingInfo().boundingSphere.centerWorld,y)}o.sort((function(e,t){return e._distanceToCamera>t._distanceToCamera?-1:e._distanceToCamera<t._distanceToCamera?1:0}))}for(var S=0;S<o.length;S++){var b=o[S],x=b.getWorldMatrix();x.copyToArray(u.instancesData,_),this._scene.needsPreviousWorldMatrices&&(b._previousWorldMatrix?(b._previousWorldMatrix.copyToArray(u.instancesPreviousData,_),b._previousWorldMatrix.copyFrom(x)):(b._previousWorldMatrix=x.clone(),b._previousWorldMatrix.copyToArray(u.instancesPreviousData,_))),_+=16,v++}}}return p?(c&&c.dispose(),d&&d.dispose(),c=new ii(s,u.instancesData,!0,16,!1,!0),u.instancesBuffer=c,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=c.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=c.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=c.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=c.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(d=new ii(s,u.instancesPreviousData,!0,16,!1,!0),u.instancesPreviousBuffer=d,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=d.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=d.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=d.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=d.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(c.updateDirectly(u.instancesData,0,v),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&d.updateDirectly(u.instancesPreviousData,0,v)),this._processInstancedBuffers(o,g),this.getScene()._activeIndices.addCount(e.indexCount*v,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,r,t),this._draw(e,t,v),this._scene.needsPreviousWorldMatrices&&!p&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&d.updateDirectly(u.instancesData,0,v),s.unbindInstanceAttributes(),this}},{key:"_renderWithThinInstances",value:function(e,t,i,n){var r,s,a=null!==(s=null===(r=this._thinInstanceDataStorage)||void 0===r?void 0:r.instancesCount)&&void 0!==s?s:0;this.getScene()._activeIndices.addCount(e.indexCount*a,!1),n._currentDrawContext&&(n._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,a),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,a):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),n.unbindInstanceAttributes()}},{key:"_processInstancedBuffers",value:function(e,t){}},{key:"_processRendering",value:function(e,t,i,n,r,s,a,o){var l=this.getScene(),u=l.getEngine();if(s&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,n,i,u),this;if(s)this._renderWithInstances(t,n,r,i,u);else{u._currentDrawContext&&(u._currentDrawContext.useInstancing=!1);var h=0;r.renderSelf[t._id]&&(a&&a(!1,e.getWorldMatrix(),o),h++,this._draw(t,n,this._instanceDataStorage.overridenInstanceCount));var c=r.visibleInstances[t._id];if(c){var d=c.length;h+=d;for(var f=0;f<d;f++){var _=c[f].getWorldMatrix();a&&a(!0,_,o),this._draw(t,n)}}l._activeIndices.addCount(t.indexCount*h,!1)}return this}},{key:"_rebuild",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(var t in this._userInstancedBuffersStorage.vertexBuffers){var n=this._userInstancedBuffersStorage.vertexBuffers[t];n&&(e&&n.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,c((0,h.Z)(i.prototype),"_rebuild",this).call(this,e)}},{key:"_freeze",value:function(){if(this.subMeshes){for(var e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}},{key:"_unFreeze",value:function(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}},{key:"render",value:function(e,t,i){var n,r,s,a=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;var o=this._getInstancesRenderList(e._id,!!i);if(o.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;var l=a.getEngine(),u=0,h=null;this.ignoreCameraMaxZ&&a.activeCamera&&!a._isInIntermediateRendering()&&(u=a.activeCamera.maxZ,h=a.activeCamera,a.activeCamera.maxZ=0,a.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);var c,d=e.getRenderingMesh(),f=o.hardwareInstancedRendering[e._id]||d.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,_=this._instanceDataStorage,v=e.getMaterial();if(!v)return h&&(h.maxZ=u,a.updateTransformMatrix(!0)),this;if(_.isFrozen&&this._internalMeshDataInfo._effectiveMaterial&&this._internalMeshDataInfo._effectiveMaterial===v){if(v._storeEffectOnSubMeshes&&(null===(n=e.effect)||void 0===n||!n._wasPreviouslyReady)||!v._storeEffectOnSubMeshes&&(null===(r=v.getEffect())||void 0===r||!r._wasPreviouslyReady))return h&&(h.maxZ=u,a.updateTransformMatrix(!0)),this}else{if(v._storeEffectOnSubMeshes){if(!v.isReadyForSubMesh(this,e,f))return h&&(h.maxZ=u,a.updateTransformMatrix(!0)),this}else if(!v.isReady(this,f))return h&&(h.maxZ=u,a.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=v}t&&l.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);var g,m=null!==(s=null==(c=this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?e._drawWrapper:this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper())?void 0:c.effect)&&void 0!==s?s:null,y=(0,p.Z)(a._beforeRenderingMeshStage);try{for(y.s();!(g=y.n()).done;){g.value.action(this,e,o,m)}}catch(I){y.e(I)}finally{y.f()}if(!c||!m)return h&&(h.maxZ=u,a.updateTransformMatrix(!0)),this;var T,E=i||this;if(_.isFrozen||!this._internalMeshDataInfo._effectiveMaterial.backFaceCulling&&null===this.overrideMaterialSideOrientation)T=_.sideOrientation;else{var S=E._getWorldMatrixDeterminant();null==(T=this.overrideMaterialSideOrientation)&&(T=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),S<0&&(T=T===In.ClockWiseSideOrientation?In.CounterClockWiseSideOrientation:In.ClockWiseSideOrientation),_.sideOrientation=T}var b=this._internalMeshDataInfo._effectiveMaterial._preBind(c,T);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&l.setDepthWrite(!0);var x=a.forcePointsCloud?In.PointFillMode:a.forceWireframe?In.WireFrameFillMode:this._internalMeshDataInfo._effectiveMaterial.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),f||this._bind(e,m,x);var M=this._internalMeshDataInfo._effectiveMaterial,A=E.getWorldMatrix();M._storeEffectOnSubMeshes?M.bindForSubMesh(A,this,e):M.bind(A,this),!M.backFaceCulling&&M.separateCullingPass&&(l.setState(!0,M.zOffset,!1,!b,M.cullBackFaces,M.stencil,M.zOffsetUnits),this._processRendering(this,e,m,x,o,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),l.setState(!0,M.zOffset,!1,b,M.cullBackFaces,M.stencil,M.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,m,x,o,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();var R,C=(0,p.Z)(a._afterRenderingMeshStage);try{for(C.s();!(R=C.n()).done;){R.value.action(this,e,o,m)}}catch(I){C.e(I)}finally{C.f()}return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),h&&(h.maxZ=u,a.updateTransformMatrix(!0)),a.performancePriority===Gi.Aggressive&&!_.isFrozen&&this._freeze(),this}},{key:"cleanMatrixWeights",value:function(){this.isVerticesDataPresent(ni.MatricesWeightsKind)&&(this.isVerticesDataPresent(ni.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}},{key:"_normalizeSkinFourWeights",value:function(){for(var e=this.getVerticesData(ni.MatricesWeightsKind),t=e.length,i=0;i<t;i+=4){var n=e[i]+e[i+1]+e[i+2]+e[i+3];if(0===n)e[i]=1;else{var r=1/n;e[i]*=r,e[i+1]*=r,e[i+2]*=r,e[i+3]*=r}}this.setVerticesData(ni.MatricesWeightsKind,e)}},{key:"_normalizeSkinWeightsAndExtra",value:function(){for(var e=this.getVerticesData(ni.MatricesWeightsExtraKind),t=this.getVerticesData(ni.MatricesWeightsKind),i=t.length,n=0;n<i;n+=4){var r=t[n]+t[n+1]+t[n+2]+t[n+3];if(0===(r+=e[n]+e[n+1]+e[n+2]+e[n+3]))t[n]=1;else{var s=1/r;t[n]*=s,t[n+1]*=s,t[n+2]*=s,t[n+3]*=s,e[n]*=s,e[n+1]*=s,e[n+2]*=s,e[n+3]*=s}}this.setVerticesData(ni.MatricesWeightsKind,t),this.setVerticesData(ni.MatricesWeightsKind,e)}},{key:"validateSkinning",value:function(){var e=this.getVerticesData(ni.MatricesWeightsExtraKind),t=this.getVerticesData(ni.MatricesWeightsKind);if(null===t||null==this.skeleton)return{skinned:!1,valid:!0,report:"not skinned"};for(var i=t.length,n=0,r=0,s=0,a=0,o=null===e?4:8,l=new Array,u=0;u<=o;u++)l[u]=0;for(var h=0;h<i;h+=4){for(var c=t[h],d=c,f=0===d?0:1,_=1;_<o;_++){var v=_<4?t[h+_]:e[h+_-4];v>c&&n++,0!==v&&f++,d+=v,c=v}if(l[f]++,f>s&&(s=f),0===d)r++;else{for(var g=1/d,p=0,m=0;m<o;m++)p+=m<4?Math.abs(t[h+m]-t[h+m]*g):Math.abs(e[h+m-4]-e[h+m-4]*g);p>.001&&a++}}for(var y=this.skeleton.bones.length,T=this.getVerticesData(ni.MatricesIndicesKind),E=this.getVerticesData(ni.MatricesIndicesExtraKind),S=0,b=0;b<i;b+=4)for(var x=0;x<o;x++){var M=x<4?T[b+x]:E[b+x-4];(M>=y||M<0)&&S++}return{skinned:!0,valid:0===r&&0===a&&0===S,report:"Number of Weights = "+i/4+"\nMaximum influences = "+s+"\nMissing Weights = "+r+"\nNot Sorted = "+n+"\nNot Normalized = "+a+"\nWeightCounts = ["+l+"]\nNumber of bones = "+y+"\nBad Bone Indices = "+S}}},{key:"_checkDelayState",value:function(){var e=this.getScene();return this._geometry?this._geometry.load(e):4===this.delayLoadState&&(this.delayLoadState=2,this._queueLoad(e)),this}},{key:"_queueLoad",value:function(e){var t=this;e.addPendingData(this);var i=-1!==this.delayLoadingFile.indexOf(".babylonbinarymeshdata");return It.LoadFile(this.delayLoadingFile,(function(i){i instanceof ArrayBuffer?t._delayLoadingFunction(i,t):t._delayLoadingFunction(JSON.parse(i),t),t.instances.forEach((function(e){e.refreshBoundingInfo(),e._syncSubMeshes()})),t.delayLoadState=1,e.removePendingData(t)}),(function(){}),e.offlineProvider,i),this}},{key:"isInFrustum",value:function(e){return!(2===this.delayLoadState||!c((0,h.Z)(i.prototype),"isInFrustum",this).call(this,e))&&(this._checkDelayState(),!0)}},{key:"setMaterialById",value:function(e){var t,i=this.getScene().materials;for(t=i.length-1;t>-1;t--)if(i[t].id===e)return this.material=i[t],this;var n=this.getScene().multiMaterials;for(t=n.length-1;t>-1;t--)if(n[t].id===e)return this.material=n[t],this;return this}},{key:"getAnimatables",value:function(){var e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}},{key:"bakeTransformIntoVertices",value:function(e){if(!this.isVerticesDataPresent(ni.PositionKind))return this;var t=this.subMeshes.splice(0);this._resetPointsArrayCache();var i,n=this.getVerticesData(ni.PositionKind),r=z.Zero();for(i=0;i<n.length;i+=3)z.TransformCoordinatesFromFloatsToRef(n[i],n[i+1],n[i+2],e,r).toArray(n,i);if(this.setVerticesData(ni.PositionKind,n,this.getVertexBuffer(ni.PositionKind).isUpdatable()),this.isVerticesDataPresent(ni.NormalKind)){for(n=this.getVerticesData(ni.NormalKind),i=0;i<n.length;i+=3)z.TransformNormalFromFloatsToRef(n[i],n[i+1],n[i+2],e,r).normalize().toArray(n,i);this.setVerticesData(ni.NormalKind,n,this.getVertexBuffer(ni.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}},{key:"bakeCurrentTransformIntoVertices",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}},{key:"_positions",get:function(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}},{key:"_resetPointsArrayCache",value:function(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}},{key:"_generatePointsArray",value:function(){return!!this._geometry&&this._geometry._generatePointsArray()}},{key:"clone",value:function(){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t=arguments.length>2?arguments[2]:void 0,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return new i(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",this.getScene(),e,this,t,n)}},{key:"dispose",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);var n=this._internalMeshDataInfo;if(n._onBeforeDrawObservable&&n._onBeforeDrawObservable.clear(),n._onBeforeBindObservable&&n._onBeforeBindObservable.clear(),n._onBeforeRenderObservable&&n._onBeforeRenderObservable.clear(),n._onAfterRenderObservable&&n._onAfterRenderObservable.clear(),n._onBetweenPassObservable&&n._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(n.meshMap)for(var r in n.meshMap){var s=n.meshMap[r];s&&(s._internalMeshDataInfo._source=null,n.meshMap[r]=void 0)}n._source&&n._source._internalMeshDataInfo.meshMap&&(n._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{var a,o=this.getScene().meshes,l=(0,p.Z)(o);try{for(l.s();!(a=l.n()).done;){var u=a.value;u._internalMeshDataInfo&&u._internalMeshDataInfo._source&&u._internalMeshDataInfo._source===this&&(u._internalMeshDataInfo._source=null)}}catch(d){l.e(d)}finally{l.f()}}n._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),c((0,h.Z)(i.prototype),"dispose",this).call(this,e,t)}},{key:"_disposeInstanceSpecificData",value:function(){}},{key:"_disposeThinInstanceSpecificData",value:function(){}},{key:"_invalidateInstanceVertexArrayObject",value:function(){}},{key:"applyDisplacementMap",value:function(e,t,i,n,r,s){var a=this,o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=this.getScene();return It.LoadImage(e,(function(e){var l=e.width,u=e.height,h=a.getEngine().createCanvas(l,u).getContext("2d");h.drawImage(e,0,0);var c=h.getImageData(0,0,l,u).data;a.applyDisplacementMapFromBuffer(c,l,u,t,i,r,s,o),n&&n(a)}),(function(){}),l.offlineProvider),this}},{key:"applyDisplacementMapFromBuffer",value:function(e,t,i,n,r,s,a){var o=arguments.length>7&&void 0!==arguments[7]&&arguments[7];if(!this.isVerticesDataPresent(ni.PositionKind)||!this.isVerticesDataPresent(ni.NormalKind)||!this.isVerticesDataPresent(ni.UVKind))return ue.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;var l=this.getVerticesData(ni.PositionKind,!0,!0),u=this.getVerticesData(ni.NormalKind),h=this.getVerticesData(ni.UVKind),c=z.Zero(),d=z.Zero(),f=W.Zero();s=s||W.Zero(),a=a||new W(1,1);for(var _=0;_<l.length;_+=3){z.FromArrayToRef(l,_,c),z.FromArrayToRef(u,_,d),W.FromArrayToRef(h,_/3*2,f);var v=4*((Math.abs(f.x*a.x+s.x%1)*(t-1)%t|0)+(Math.abs(f.y*a.y+s.y%1)*(i-1)%i|0)*t),g=.3*(e[v]/255)+.59*(e[v+1]/255)+.11*(e[v+2]/255);d.normalize(),d.scaleInPlace(n+(r-n)*g),(c=c.add(d)).toArray(l,_)}return Qi.ComputeNormals(l,this.getIndices(),u),o?(this.setVerticesData(ni.PositionKind,l),this.setVerticesData(ni.NormalKind,u),this.setVerticesData(ni.UVKind,h)):(this.updateVerticesData(ni.PositionKind,l),this.updateVerticesData(ni.NormalKind,u)),this}},{key:"convertToFlatShadedMesh",value:function(){var e,t,i=this.getVerticesDataKinds(),n={},r={},s={},a=!1;for(e=0;e<i.length;e++){t=i[e];var o=this.getVertexBuffer(t),l=o.getData();if(!(l instanceof Array||l instanceof Float32Array)||0!==l.length){if(t===ni.NormalKind){a=o.isUpdatable(),i.splice(e,1),e--;continue}n[t]=o,r[t]=this.getVerticesData(t),s[t]=[]}}var u,h=this.subMeshes.slice(0),c=this.getIndices(),d=this.getTotalIndices();for(u=0;u<d;u++){var f=c[u];for(e=0;e<i.length;e++)if(n[t=i[e]])for(var _=n[t].getStrideSize(),v=0;v<_;v++)s[t].push(r[t][f*_+v])}var g,p=[],m=s[ni.PositionKind];for(g=this.getScene().useRightHandedSystem?1===this.overrideMaterialSideOrientation:0===this.overrideMaterialSideOrientation,u=0;u<d;u+=3){c[u]=u,c[u+1]=u+1,c[u+2]=u+2;var y=z.FromArray(m,3*u),T=z.FromArray(m,3*(u+1)),E=z.FromArray(m,3*(u+2)),S=y.subtract(T),b=E.subtract(T),x=z.Normalize(z.Cross(S,b));g&&x.scaleInPlace(-1);for(var M=0;M<3;M++)p.push(x.x),p.push(x.y),p.push(x.z)}for(this.setIndices(c),this.setVerticesData(ni.NormalKind,p,a),e=0;e<i.length;e++)s[t=i[e]]&&this.setVerticesData(t,s[t],n[t].isUpdatable());this.releaseSubMeshes();for(var A=0;A<h.length;A++){var R=h[A];un.AddToMesh(R.materialIndex,R.indexStart,R.indexCount,R.indexStart,R.indexCount,this)}return this.synchronizeInstances(),this}},{key:"convertToUnIndexedMesh",value:function(){var e,t,i=this.getVerticesDataKinds(),n={},r={},s={};for(e=0;e<i.length;e++){t=i[e];var a=this.getVertexBuffer(t);n[t]=a,r[t]=n[t].getData(),s[t]=[]}var o,l=this.subMeshes.slice(0),u=this.getIndices(),h=this.getTotalIndices();for(o=0;o<h;o++){var c=u[o];for(e=0;e<i.length;e++)for(var d=n[t=i[e]].getStrideSize(),f=0;f<d;f++)s[t].push(r[t][c*d+f])}for(o=0;o<h;o+=3)u[o]=o,u[o+1]=o+1,u[o+2]=o+2;for(this.setIndices(u),e=0;e<i.length;e++)t=i[e],this.setVerticesData(t,s[t],n[t].isUpdatable(),n[t].getStrideSize());this.releaseSubMeshes();for(var _=0;_<l.length;_++){var v=l[_];un.AddToMesh(v.materialIndex,v.indexStart,v.indexCount,v.indexStart,v.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this}},{key:"flipFaces",value:function(){var e,t,i=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=Qi.ExtractFromMesh(this);if(i&&this.isVerticesDataPresent(ni.NormalKind)&&n.normals)for(e=0;e<n.normals.length;e++)n.normals[e]*=-1;if(n.indices)for(e=0;e<n.indices.length;e+=3)t=n.indices[e+1],n.indices[e+1]=n.indices[e+2],n.indices[e+2]=t;return n.applyToMesh(this,this.isVertexBufferUpdatable(ni.PositionKind)),this}},{key:"increaseVertices",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=Qi.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,n=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,r=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,s=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(i&&n){t.indices=i,t.positions=n,r&&(t.uvs=r),s&&(t.normals=s);for(var a,o,l=e+1,u=new Array,h=0;h<l+1;h++)u[h]=new Array;var c,d,f,_=new z(0,0,0),v=new z(0,0,0),g=new W(0,0),p=new Array,m=new Array,y=new Array,T=n.length;r&&(d=r.length),s&&(f=s.length);for(var E=0;E<i.length;E+=3){m[0]=i[E],m[1]=i[E+1],m[2]=i[E+2];for(var S=0;S<3;S++)if(a=m[S],o=m[(S+1)%3],void 0===y[a]&&void 0===y[o]?(y[a]=new Array,y[o]=new Array):(void 0===y[a]&&(y[a]=new Array),void 0===y[o]&&(y[o]=new Array)),void 0===y[a][o]&&void 0===y[o][a]){y[a][o]=[],_.x=(n[3*o]-n[3*a])/l,_.y=(n[3*o+1]-n[3*a+1])/l,_.z=(n[3*o+2]-n[3*a+2])/l,s&&(v.x=(s[3*o]-s[3*a])/l,v.y=(s[3*o+1]-s[3*a+1])/l,v.z=(s[3*o+2]-s[3*a+2])/l),r&&(g.x=(r[2*o]-r[2*a])/l,g.y=(r[2*o+1]-r[2*a+1])/l),y[a][o].push(a);for(var b=1;b<l;b++)y[a][o].push(n.length/3),n[T++]=n[3*a]+b*_.x,n[T++]=n[3*a+1]+b*_.y,n[T++]=n[3*a+2]+b*_.z,s&&(s[f++]=s[3*a]+b*v.x,s[f++]=s[3*a+1]+b*v.y,s[f++]=s[3*a+2]+b*v.z),r&&(r[d++]=r[2*a]+b*g.x,r[d++]=r[2*a+1]+b*g.y);y[a][o].push(o),y[o][a]=new Array,c=y[a][o].length;for(var x=0;x<c;x++)y[o][a][x]=y[a][o][c-1-x]}u[0][0]=i[E],u[1][0]=y[i[E]][i[E+1]][1],u[1][1]=y[i[E]][i[E+2]][1];for(var M=2;M<l;M++){u[M][0]=y[i[E]][i[E+1]][M],u[M][M]=y[i[E]][i[E+2]][M],_.x=(n[3*u[M][M]]-n[3*u[M][0]])/M,_.y=(n[3*u[M][M]+1]-n[3*u[M][0]+1])/M,_.z=(n[3*u[M][M]+2]-n[3*u[M][0]+2])/M,s&&(v.x=(s[3*u[M][M]]-s[3*u[M][0]])/M,v.y=(s[3*u[M][M]+1]-s[3*u[M][0]+1])/M,v.z=(s[3*u[M][M]+2]-s[3*u[M][0]+2])/M),r&&(g.x=(r[2*u[M][M]]-r[2*u[M][0]])/M,g.y=(r[2*u[M][M]+1]-r[2*u[M][0]+1])/M);for(var A=1;A<M;A++)u[M][A]=n.length/3,n[T++]=n[3*u[M][0]]+A*_.x,n[T++]=n[3*u[M][0]+1]+A*_.y,n[T++]=n[3*u[M][0]+2]+A*_.z,s&&(s[f++]=s[3*u[M][0]]+A*v.x,s[f++]=s[3*u[M][0]+1]+A*v.y,s[f++]=s[3*u[M][0]+2]+A*v.z),r&&(r[d++]=r[2*u[M][0]]+A*g.x,r[d++]=r[2*u[M][0]+1]+A*g.y)}u[l]=y[i[E+1]][i[E+2]],p.push(u[0][0],u[1][0],u[1][1]);for(var R=1;R<l;R++){var C=void 0;for(C=0;C<R;C++)p.push(u[R][C],u[R+1][C],u[R+1][C+1]),p.push(u[R][C],u[R+1][C+1],u[R][C+1]);p.push(u[R][C],u[R+1][C],u[R+1][C+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(ni.PositionKind))}else ue.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions")}},{key:"forceSharedVertices",value:function(){var e=Qi.ExtractFromMesh(this),t=e.uvs,i=e.indices,n=e.positions,r=e.colors,s=e.matricesIndices,a=e.matricesWeights,o=e.matricesIndicesExtra,l=e.matricesWeightsExtra;if(void 0===i||void 0===n||null===i||null===n)ue.Warn("VertexData contains empty entries");else{for(var u,h,c=new Array,d=new Array,f=new Array,_=new Array,v=new Array,g=new Array,p=new Array,m=new Array,y=new Array,T=0,E={},S=0;S<i.length;S+=3){h=[i[S],i[S+1],i[S+2]],y=new Array;for(var b=0;b<3;b++){y[b]="";for(var x=0;x<3;x++)Math.abs(n[3*h[b]+x])<1e-8&&(n[3*h[b]+x]=0),y[b]+=n[3*h[b]+x]+"|"}if(y[0]!=y[1]&&y[0]!=y[2]&&y[1]!=y[2])for(var M=0;M<3;M++){if(void 0===(u=E[y[M]])){E[y[M]]=T,u=T++;for(var A=0;A<3;A++)c.push(n[3*h[M]+A]);if(null!=r)for(var R=0;R<4;R++)_.push(r[4*h[M]+R]);if(null!=t)for(var C=0;C<2;C++)f.push(t[2*h[M]+C]);if(null!=s)for(var I=0;I<4;I++)v.push(s[4*h[M]+I]);if(null!=a)for(var P=0;P<4;P++)g.push(a[4*h[M]+P]);if(null!=o)for(var k=0;k<4;k++)p.push(o[4*h[M]+k]);if(null!=l)for(var D=0;D<4;D++)m.push(l[4*h[M]+D])}d.push(u)}}var F=new Array;Qi.ComputeNormals(c,d,F),e.positions=c,e.indices=d,e.normals=F,null!=t&&(e.uvs=f),null!=r&&(e.colors=_),null!=s&&(e.matricesIndices=v),null!=a&&(e.matricesWeights=g),null!=o&&(e.matricesIndicesExtra=p),null!=a&&(e.matricesWeightsExtra=m),e.applyToMesh(this,this.isVertexBufferUpdatable(ni.PositionKind))}}},{key:"createInstance",value:function(e){return i._instancedMeshFactory(e,this)}},{key:"synchronizeInstances",value:function(){for(var e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}},{key:"optimizeIndices",value:function(e){var t=this,i=this.getIndices(),n=this.getVerticesData(ni.PositionKind);if(!n||!i)return this;for(var r=new Array,s=0;s<n.length;s+=3)r.push(z.FromArray(n,s));var a=new Array;return Pt.SyncAsyncForLoop(r.length,40,(function(e){for(var t=r.length-1-e,i=r[t],n=0;n<t;++n){var s=r[n];if(i.equals(s)){a[t]=n;break}}}),(function(){for(var n=0;n<i.length;++n)i[n]=a[i[n]]||i[n];var r=t.subMeshes.slice(0);t.setIndices(i),t.subMeshes=r,e&&e(t)})),this}},{key:"serialize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),Ot&&Ot.HasTags(this)&&(e.tags=Ot.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;var t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(var i=0;i<this.subMeshes.length;i++){var n=this.subMeshes[i];e.subMeshes.push({materialIndex:n.materialIndex,verticesStart:n.verticesStart,verticesCount:n.verticesCount,indexStart:n.indexStart,indexCount:n.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(hi.NAME_PHYSICSENGINE)){var r=this.getPhysicsImpostor();r&&(e.physicsMass=r.getParam("mass"),e.physicsFriction=r.getParam("friction"),e.physicsRestitution=r.getParam("mass"),e.physicsImpostor=r.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(var s=0;s<this.instances.length;s++){var a=this.instances[s];if(!a.doNotSerialize){var o={name:a.name,id:a.id,isEnabled:a.isEnabled(!1),isVisible:a.isVisible,isPickable:a.isPickable,checkCollisions:a.checkCollisions,position:a.position.asArray(),scaling:a.scaling.asArray()};if(a.parent&&a.parent._serializeAsParent(o),a.rotationQuaternion?o.rotationQuaternion=a.rotationQuaternion.asArray():a.rotation&&(o.rotation=a.rotation.asArray()),this.getScene()._getComponent(hi.NAME_PHYSICSENGINE)){var l=a.getPhysicsImpostor();l&&(o.physicsMass=l.getParam("mass"),o.physicsFriction=l.getParam("friction"),o.physicsRestitution=l.getParam("mass"),o.physicsImpostor=l.type)}a.metadata&&(o.metadata=a.metadata),e.instances.push(o),jt.AppendSerializedAnimations(a,o),o.ranges=a.serializeAnimationRanges()}}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){var u={data:{},sizes:{},strides:{}};for(var h in this._userThinInstanceBuffersStorage.data)u.data[h]=Array.from(this._userThinInstanceBuffersStorage.data[h]),u.sizes[h]=this._userThinInstanceBuffersStorage.sizes[h],u.strides[h]=this._userThinInstanceBuffersStorage.strides[h];e.thinInstances.userThinInstance=u}return jt.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}},{key:"_syncGeometryWithMorphTargetManager",value:function(){if(this.geometry){this._markSubMeshesAsAttributesDirty();var e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices())return ue.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),void(this.morphTargetManager=null);if(e.isUsingTextureForTargets)return;for(var t=0;t<e.numInfluencers;t++){var i=e.getActiveTarget(t),n=i.getPositions();if(!n)return void ue.Error("Invalid morph target. Target must have positions.");this.geometry.setVerticesData(ni.PositionKind+t,n,!1,3);var r=i.getNormals();r&&this.geometry.setVerticesData(ni.NormalKind+t,r,!1,3);var s=i.getTangents();s&&this.geometry.setVerticesData(ni.TangentKind+t,s,!1,3);var a=i.getUVs();a&&this.geometry.setVerticesData(ni.UVKind+"_"+t,a,!1,2)}}else for(var o=0;this.geometry.isVerticesDataPresent(ni.PositionKind+o);)this.geometry.removeVerticesData(ni.PositionKind+o),this.geometry.isVerticesDataPresent(ni.NormalKind+o)&&this.geometry.removeVerticesData(ni.NormalKind+o),this.geometry.isVerticesDataPresent(ni.TangentKind+o)&&this.geometry.removeVerticesData(ni.TangentKind+o),this.geometry.isVerticesDataPresent(ni.UVKind+o)&&this.geometry.removeVerticesData(ni.UVKind+"_"+o),o++}}},{key:"setPositionsForCPUSkinning",value:function(){var e=this._internalMeshDataInfo;if(!e._sourcePositions){var t=this.getVerticesData(ni.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(ni.PositionKind)||this.setVerticesData(ni.PositionKind,t,!0)}return e._sourcePositions}},{key:"setNormalsForCPUSkinning",value:function(){var e=this._internalMeshDataInfo;if(!e._sourceNormals){var t=this.getVerticesData(ni.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(ni.NormalKind)||this.setVerticesData(ni.NormalKind,t,!0)}return e._sourceNormals}},{key:"applySkeleton",value:function(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(ni.PositionKind))return this;if(!this.isVerticesDataPresent(ni.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(ni.MatricesWeightsKind))return this;var t=this.isVerticesDataPresent(ni.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){var n=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=n}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();var r=this.getVerticesData(ni.PositionKind);if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));var s=this.getVerticesData(ni.NormalKind);if(t){if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s))}var a=this.getVerticesData(ni.MatricesIndicesKind),o=this.getVerticesData(ni.MatricesWeightsKind);if(!o||!a)return this;for(var l,u=this.numBoneInfluencers>4,h=u?this.getVerticesData(ni.MatricesIndicesExtraKind):null,c=u?this.getVerticesData(ni.MatricesWeightsExtraKind):null,d=e.getTransformMatrices(this),f=z.Zero(),_=new Z,v=new Z,g=0,p=0;p<r.length;p+=3,g+=4){var m=void 0;for(l=0;l<4;l++)(m=o[g+l])>0&&(Z.FromFloat32ArrayToRefScaled(d,Math.floor(16*a[g+l]),m,v),_.addToSelf(v));if(u)for(l=0;l<4;l++)(m=c[g+l])>0&&(Z.FromFloat32ArrayToRefScaled(d,Math.floor(16*h[g+l]),m,v),_.addToSelf(v));z.TransformCoordinatesFromFloatsToRef(i._sourcePositions[p],i._sourcePositions[p+1],i._sourcePositions[p+2],_,f),f.toArray(r,p),t&&(z.TransformNormalFromFloatsToRef(i._sourceNormals[p],i._sourceNormals[p+1],i._sourceNormals[p+2],_,f),f.toArray(s,p)),_.reset()}return this.updateVerticesData(ni.PositionKind,r),t&&this.updateVerticesData(ni.NormalKind,s),this}},{key:"addInstance",value:function(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}},{key:"removeInstance",value:function(e){var t=e._indexInSourceMeshInstanceArray;if(-1!=t){if(t!==this.instances.length-1){var i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}},{key:"_shouldConvertRHS",value:function(){return this.overrideMaterialSideOrientation===In.CounterClockWiseSideOrientation}}],[{key:"_GetDefaultSideOrientation",value:function(e){return e||i.FRONTSIDE}},{key:"_instancedMeshFactory",value:function(e,t){throw le("InstancedMesh")}},{key:"_PhysicsImpostorParser",value:function(e,t,i){throw le("PhysicsImpostor")}},{key:"Parse",value:function(e,t,n){var r;if((r=e.type&&"LinesMesh"===e.type?i._LinesMeshParser(e,t):e.type&&"GroundMesh"===e.type?i._GroundMeshParser(e,t):e.type&&"GoldbergMesh"===e.type?i._GoldbergMeshParser(e,t):new i(e.name,t)).id=e.id,r._waitingParsedUniqueId=e.uniqueId,Ot&&Ot.AddTagsTo(r,e.tags),r.position=z.FromArray(e.position),void 0!==e.metadata&&(r.metadata=e.metadata),e.rotationQuaternion?r.rotationQuaternion=H.FromArray(e.rotationQuaternion):e.rotation&&(r.rotation=z.FromArray(e.rotation)),r.scaling=z.FromArray(e.scaling),e.localMatrix?r.setPreTransformMatrix(Z.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(Z.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r.isVisible=e.isVisible,r.infiniteDistance=e.infiniteDistance,r.showBoundingBox=e.showBoundingBox,r.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.applyFog&&(r.applyFog=e.applyFog),void 0!==e.pickable&&(r.isPickable=e.pickable),void 0!==e.alphaIndex&&(r.alphaIndex=e.alphaIndex),r.receiveShadows=e.receiveShadows,void 0!==e.billboardMode&&(r.billboardMode=e.billboardMode),void 0!==e.visibility&&(r.visibility=e.visibility),r.checkCollisions=e.checkCollisions,r.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation,void 0!==e.isBlocker&&(r.isBlocker=e.isBlocker),r._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(r._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),void 0!==e.parentId&&(r._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.actions&&(r._waitingData.actions=e.actions),void 0!==e.overlayAlpha&&(r.overlayAlpha=e.overlayAlpha),void 0!==e.overlayColor&&(r.overlayColor=Ze.FromArray(e.overlayColor)),void 0!==e.renderOverlay&&(r.renderOverlay=e.renderOverlay),r.isUnIndexed=!!e.isUnIndexed,r.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=n+e.delayLoadingFile,r.buildBoundingInfo(z.FromArray(e.boundingBoxMinimum),z.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(r._binaryInfo=e._binaryInfo),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(ni.UVKind),e.hasUVs2&&r._delayInfo.push(ni.UV2Kind),e.hasUVs3&&r._delayInfo.push(ni.UV3Kind),e.hasUVs4&&r._delayInfo.push(ni.UV4Kind),e.hasUVs5&&r._delayInfo.push(ni.UV5Kind),e.hasUVs6&&r._delayInfo.push(ni.UV6Kind),e.hasColors&&r._delayInfo.push(ni.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(ni.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(ni.MatricesWeightsKind),r._delayLoadingFunction=fn._ImportGeometry,hn.ForceFullSceneLoadingForIncremental&&r._checkDelayState()):fn._ImportGeometry(e,r),e.materialUniqueId?r._waitingMaterialId=e.materialUniqueId:e.materialId&&(r._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(r.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),void 0!==e.skeletonId&&null!==e.skeletonId&&(r.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(r.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(var s=0;s<e.animations.length;s++){var a=e.animations[s],o=B("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}Yi.ParseAnimationRanges(r,e,t)}if(e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?r.layerMask=Math.abs(parseInt(e.layerMask)):r.layerMask=268435455,e.physicsImpostor&&i._PhysicsImpostorParser(t,r,e),e.lodMeshIds&&(r._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(var l=0;l<e.instances.length;l++){var u=e.instances[l],h=r.createInstance(u.name);if(u.id&&(h.id=u.id),Ot&&(u.tags?Ot.AddTagsTo(h,u.tags):Ot.AddTagsTo(h,e.tags)),h.position=z.FromArray(u.position),void 0!==u.metadata&&(h.metadata=u.metadata),void 0!==u.parentId&&(h._waitingParentId=u.parentId),void 0!==u.parentInstanceIndex&&(h._waitingParentInstanceIndex=u.parentInstanceIndex),void 0!==u.isEnabled&&null!==u.isEnabled&&h.setEnabled(u.isEnabled),void 0!==u.isVisible&&null!==u.isVisible&&(h.isVisible=u.isVisible),void 0!==u.isPickable&&null!==u.isPickable&&(h.isPickable=u.isPickable),u.rotationQuaternion?h.rotationQuaternion=H.FromArray(u.rotationQuaternion):u.rotation&&(h.rotation=z.FromArray(u.rotation)),h.scaling=z.FromArray(u.scaling),null!=u.checkCollisions&&null!=u.checkCollisions&&(h.checkCollisions=u.checkCollisions),null!=u.pickable&&null!=u.pickable&&(h.isPickable=u.pickable),null!=u.showBoundingBox&&null!=u.showBoundingBox&&(h.showBoundingBox=u.showBoundingBox),null!=u.showSubMeshesBoundingBox&&null!=u.showSubMeshesBoundingBox&&(h.showSubMeshesBoundingBox=u.showSubMeshesBoundingBox),null!=u.alphaIndex&&null!=u.showSubMeshesBoundingBox&&(h.alphaIndex=u.alphaIndex),u.physicsImpostor&&i._PhysicsImpostorParser(t,h,u),u.animations){for(var c=0;c<u.animations.length;c++){var d=u.animations[c],f=B("BABYLON.Animation");f&&h.animations.push(f.Parse(d))}Yi.ParseAnimationRanges(h,u,t),u.autoAnimate&&t.beginAnimation(h,u.autoAnimateFrom,u.autoAnimateTo,u.autoAnimateLoop,u.autoAnimateSpeed||1)}}if(e.thinInstances){var _=e.thinInstances;if(r.thinInstanceEnablePicking=!!_.enablePicking,_.matrixData?(r.thinInstanceSetBuffer("matrix",new Float32Array(_.matrixData),16,!1),r._thinInstanceDataStorage.matrixBufferSize=_.matrixBufferSize,r._thinInstanceDataStorage.instancesCount=_.instancesCount):r._thinInstanceDataStorage.matrixBufferSize=_.matrixBufferSize,e.thinInstances.userThinInstance){var v=e.thinInstances.userThinInstance;for(var g in v.data)r.thinInstanceSetBuffer(g,new Float32Array(v.data[g]),v.strides[g],!1),r._userThinInstanceBuffersStorage.sizes[g]=v.sizes[g]}}return r}},{key:"MinMax",value:function(e){var t=null,i=null;return e.forEach((function(e){var n=e.getBoundingInfo().boundingBox;t&&i?(t.minimizeInPlace(n.minimumWorld),i.maximizeInPlace(n.maximumWorld)):(t=n.minimumWorld,i=n.maximumWorld)})),t&&i?{min:t,max:i}:{min:z.Zero(),max:z.Zero()}}},{key:"Center",value:function(e){var t=e instanceof Array?i.MinMax(e):e;return z.Center(t.min,t.max)}},{key:"MergeMeshes",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0;return Zi(i._MergeMeshesCoroutine(e,t,n,r,s,a,!1))}},{key:"MergeMeshesAsync",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0;return function(e,t,i){return new Promise((function(n,r){Hi(e,t,n,r,i)}))}(i._MergeMeshesCoroutine(e,t,n,r,s,a,!0),function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:25;return function(i,n,r){var s=performance.now();void 0===e||s-e>t?(e=s,setTimeout((function(){Xi(i,n,r)}),0)):Xi(i,n,r)}}())}},{key:"_MergeMeshesCoroutine",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0,o=arguments.length>6?arguments[6]:void 0;return(0,d.Z)().mark((function l(){var u,h,c,f,v,g,m,y,T,E,S,b,x,M,A,R,C,I,P,k,D,F,w,O,L,N,B,U,V,G;return(0,d.Z)().wrap((function(l){for(;;)switch(l.prev=l.next){case 0:if(0!==(e=e.filter(Boolean)).length){l.next=2;break}return l.abrupt("return",null);case 2:if(n){l.next=11;break}h=0,u=0;case 5:if(!(u<e.length)){l.next=11;break}if(!((h+=e[u].getTotalVertices())>=65536)){l.next=8;break}return l.abrupt("return",(ue.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null));case 8:u++,l.next=5;break;case 11:a&&(s=!1),c=new Array,f=new Array,v=new Array,g=e[0].overrideMaterialSideOrientation,u=0;case 14:if(!(u<e.length)){l.next=24;break}if(!(m=e[u]).isAnInstance){l.next=18;break}return l.abrupt("return",(ue.Warn("Cannot merge instance meshes."),null));case 18:if(g===m.overrideMaterialSideOrientation){l.next=20;break}return l.abrupt("return",(ue.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null));case 20:if(s&&v.push(m.getTotalIndices()),a)if(m.material)if((y=m.material)instanceof Pn){for(T=0;T<y.subMaterials.length;T++)c.indexOf(y.subMaterials[T])<0&&c.push(y.subMaterials[T]);for(E=0;E<m.subMeshes.length;E++)f.push(c.indexOf(y.subMaterials[m.subMeshes[E].materialIndex])),v.push(m.subMeshes[E].indexCount)}else for(c.indexOf(y)<0&&c.push(y),S=0;S<m.subMeshes.length;S++)f.push(c.indexOf(y)),v.push(m.subMeshes[S].indexCount);else for(b=0;b<m.subMeshes.length;b++)f.push(0),v.push(m.subMeshes[b].indexCount);case 21:u++,l.next=14;break;case 24:if(x=e[0],M=function(e){var t=e.computeWorldMatrix(!0);return[Qi.ExtractFromMesh(e,!1,!1),t]},A=M(x),R=(0,_.Z)(A,2),C=R[0],I=R[1],l.t0=o,!l.t0){l.next=29;break}return void(l.next=29);case 29:P=new Array(e.length-1),k=1;case 31:if(!(k<e.length)){l.next=40;break}if(P[k-1]=M(e[k]),l.t1=o,!l.t1){l.next=37;break}return void(l.next=37);case 37:k++,l.next=31;break;case 40:D=C._mergeCoroutine(I,P,n,o,!t),F=D.next();case 42:if(F.done){l.next=50;break}if(l.t2=o,!l.t2){l.next=47;break}return void(l.next=47);case 47:F=D.next();case 48:l.next=42;break;case 50:w=F.value,r||(r=new i(x.name+"_merged",x.getScene())),O=w._applyToCoroutine(r,void 0,o),L=O.next();case 54:if(L.done){l.next=62;break}if(l.t3=o,!l.t3){l.next=59;break}return void(l.next=59);case 59:L=O.next();case 60:l.next=54;break;case 62:if(r.checkCollisions=x.checkCollisions,r.overrideMaterialSideOrientation=x.overrideMaterialSideOrientation,t)for(u=0;u<e.length;u++)e[u].dispose();if(s||a){for(r.releaseSubMeshes(),u=0,N=0;u<v.length;)un.CreateFromIndices(0,N,v[u],r,void 0,!1),N+=v[u],u++;B=(0,p.Z)(r.subMeshes);try{for(B.s();!(U=B.n()).done;)U.value.refreshBoundingInfo()}catch(d){B.e(d)}finally{B.f()}r.computeWorldMatrix(!0)}if(a){for((V=new Pn(x.name+"_merged",x.getScene())).subMaterials=c,G=0;G<r.subMeshes.length;G++)r.subMeshes[G].materialIndex=f[G];r.material=V}else r.material=x.material;return l.abrupt("return",r);case 66:case"end":return l.stop()}}),l)}))()}}]),i}(Tn);Ln.FRONTSIDE=Qi.FRONTSIDE,Ln.BACKSIDE=Qi.BACKSIDE,Ln.DOUBLESIDE=Qi.DOUBLESIDE,Ln.DEFAULTSIDE=Qi.DEFAULTSIDE,Ln.NO_CAP=0,Ln.CAP_START=1,Ln.CAP_END=2,Ln.CAP_ALL=3,Ln.NO_FLIP=0,Ln.FLIP_TILE=1,Ln.ROTATE_TILE=2,Ln.FLIP_ROW=3,Ln.ROTATE_ROW=4,Ln.FLIP_N_ROTATE_TILE=5,Ln.FLIP_N_ROTATE_ROW=6,Ln.CENTER=0,Ln.LEFT=1,Ln.RIGHT=2,Ln.TOP=3,Ln.BOTTOM=4,Ln.INSTANCEDMESH_SORT_TRANSPARENT=!1,Ln._GroundMeshParser=function(e,t){throw le("GroundMesh")},Ln._GoldbergMeshParser=function(e,t){throw le("GoldbergMesh")},Ln._LinesMeshParser=function(e,t){throw le("LinesMesh")},N("BABYLON.Mesh",Ln),Ln.prototype.setMaterialByID=function(e){return this.setMaterialById(e)},Ln.CreateDisc=Ln.CreateDisc||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreateBox=Ln.CreateBox||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreateSphere=Ln.CreateSphere||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreateCylinder=Ln.CreateCylinder||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreateTorusKnot=Ln.CreateTorusKnot||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreateTorus=Ln.CreateTorus||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreatePlane=Ln.CreatePlane||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreateGround=Ln.CreateGround||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreateTiledGround=Ln.CreateTiledGround||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreateGroundFromHeightMap=Ln.CreateGroundFromHeightMap||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreateTube=Ln.CreateTube||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreatePolyhedron=Ln.CreatePolyhedron||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreateIcoSphere=Ln.CreateIcoSphere||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreateDecal=Ln.CreateDecal||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.CreateCapsule=Ln.CreateCapsule||function(){throw new Error("Import MeshBuilder to populate this function")},Ln.ExtendToGoldberg=Ln.ExtendToGoldberg||function(){throw new Error("Import MeshBuilder to populate this function")};var Nn=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;(0,m.Z)(this,e),this.priority=t}return(0,y.Z)(e,[{key:"getDescription",value:function(){return""}},{key:"apply",value:function(e,t){return!0}}]),e}(),Bn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1024,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return(0,m.Z)(this,i),(e=t.call(this,n)).priority=n,e.maximumSize=r,e.step=s,e}return(0,y.Z)(i,[{key:"getDescription",value:function(){return"Reducing render target texture size to "+this.maximumSize}},{key:"apply",value:function(e,t){for(var i=!0,n=0;n<e.textures.length;n++){var r=e.textures[n];if(r.canRescale&&!r.getContext){var s=r.getSize();Math.max(s.width,s.height)>this.maximumSize&&(r.scale(this.step),i=!1)}}return i}}]),i}(Nn),Un=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.25;return(0,m.Z)(this,i),(e=t.call(this,n)).priority=n,e.maximumScale=r,e.step=s,e._currentScale=-1,e._directionOffset=1,e}return(0,y.Z)(i,[{key:"getDescription",value:function(){return"Setting hardware scaling level to "+this._currentScale}},{key:"apply",value:function(e,t){return-1===this._currentScale&&(this._currentScale=e.getEngine().getHardwareScalingLevel(),this._currentScale>this.maximumScale&&(this._directionOffset=-1)),this._currentScale+=this._directionOffset*this.step,e.getEngine().setHardwareScalingLevel(this._currentScale),1===this._directionOffset?this._currentScale>=this.maximumScale:this._currentScale<=this.maximumScale}}]),i}(Nn),Vn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){return(0,m.Z)(this,i),t.apply(this,arguments)}return(0,y.Z)(i,[{key:"getDescription",value:function(){return"Turning shadows on/off"}},{key:"apply",value:function(e,t){return e.shadowsEnabled=t.isInImprovementMode,!0}}]),i}(Nn),Gn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){return(0,m.Z)(this,i),t.apply(this,arguments)}return(0,y.Z)(i,[{key:"getDescription",value:function(){return"Turning post-processes on/off"}},{key:"apply",value:function(e,t){return e.postProcessesEnabled=t.isInImprovementMode,!0}}]),i}(Nn),Wn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){return(0,m.Z)(this,i),t.apply(this,arguments)}return(0,y.Z)(i,[{key:"getDescription",value:function(){return"Turning lens flares on/off"}},{key:"apply",value:function(e,t){return e.lensFlaresEnabled=t.isInImprovementMode,!0}}]),i}(Nn),zn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){return(0,m.Z)(this,i),t.apply(this,arguments)}return(0,y.Z)(i,[{key:"getDescription",value:function(){return this.onGetDescription?this.onGetDescription():"Running user defined callback"}},{key:"apply",value:function(e,t){return!this.onApply||this.onApply(e,t)}}]),i}(Nn),Xn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){return(0,m.Z)(this,i),t.apply(this,arguments)}return(0,y.Z)(i,[{key:"getDescription",value:function(){return"Turning particles on/off"}},{key:"apply",value:function(e,t){return e.particlesEnabled=t.isInImprovementMode,!0}}]),i}(Nn),Hn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){return(0,m.Z)(this,i),t.apply(this,arguments)}return(0,y.Z)(i,[{key:"getDescription",value:function(){return"Turning render targets off"}},{key:"apply",value:function(e,t){return e.renderTargetsEnabled=t.isInImprovementMode,!0}}]),i}(Nn),Zn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){var e;return(0,m.Z)(this,i),(e=t.apply(this,arguments))._canBeMerged=function(e){if(!(e instanceof Ln))return!1;var t=e;return!(t.isDisposed()||!t.isVisible||!t.isEnabled()||t.instances.length>0||t.skeleton||t.hasLODLevels)},e}return(0,y.Z)(i,[{key:"getDescription",value:function(){return"Merging similar meshes together"}},{key:"apply",value:function(e,t,n){for(var r=e.meshes.slice(0),s=r.length,a=0;a<s;a++){var o=new Array,l=r[a];if(this._canBeMerged(l)){o.push(l);for(var u=a+1;u<s;u++){var h=r[u];this._canBeMerged(h)&&h.material===l.material&&h.checkCollisions===l.checkCollisions&&(o.push(h),s--,r.splice(u,1),u--)}o.length<2||Ln.MergeMeshes(o,void 0,!0)}}var c=e;return c.createOrUpdateSelectionOctree&&(null!=n?n&&c.createOrUpdateSelectionOctree():i.UpdateSelectionTree&&c.createOrUpdateSelectionOctree()),!0}}],[{key:"UpdateSelectionTree",get:function(){return i._UpdateSelectionTree},set:function(e){i._UpdateSelectionTree=e}}]),i}(Nn);Zn._UpdateSelectionTree=!1;var Kn=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:60,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2e3;(0,m.Z)(this,e),this.targetFrameRate=t,this.trackerDuration=i,this.optimizations=new Array}return(0,y.Z)(e,[{key:"addOptimization",value:function(e){return this.optimizations.push(e),this}},{key:"addCustomOptimization",value:function(e,t){var i=new zn(arguments.length>2&&void 0!==arguments[2]?arguments[2]:0);return i.onApply=e,i.onGetDescription=t,this.optimizations.push(i),this}}],[{key:"LowDegradationAllowed",value:function(t){var i=new e(t),n=0;return i.addOptimization(new Zn(n)),i.addOptimization(new Vn(n)),i.addOptimization(new Wn(n)),n++,i.addOptimization(new Gn(n)),i.addOptimization(new Xn(n)),n++,i.addOptimization(new Bn(n,1024)),i}},{key:"ModerateDegradationAllowed",value:function(t){var i=new e(t),n=0;return i.addOptimization(new Zn(n)),i.addOptimization(new Vn(n)),i.addOptimization(new Wn(n)),n++,i.addOptimization(new Gn(n)),i.addOptimization(new Xn(n)),n++,i.addOptimization(new Bn(n,512)),n++,i.addOptimization(new Hn(n)),n++,i.addOptimization(new Un(n,2)),i}},{key:"HighDegradationAllowed",value:function(t){var i=new e(t),n=0;return i.addOptimization(new Zn(n)),i.addOptimization(new Vn(n)),i.addOptimization(new Wn(n)),n++,i.addOptimization(new Gn(n)),i.addOptimization(new Xn(n)),n++,i.addOptimization(new Bn(n,256)),n++,i.addOptimization(new Hn(n)),n++,i.addOptimization(new Un(n,4)),i}}]),e}(),Yn=function(){function e(t,i){var n=this,r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if((0,m.Z)(this,e),this._isRunning=!1,this._currentPriorityLevel=0,this._targetFrameRate=60,this._trackerDuration=2e3,this._currentFrameRate=0,this._improvementMode=!1,this.onSuccessObservable=new ee,this.onNewOptimizationAppliedObservable=new ee,this.onFailureObservable=new ee,this._options=i||new Kn,this._options.targetFrameRate&&(this._targetFrameRate=this._options.targetFrameRate),this._options.trackerDuration&&(this._trackerDuration=this._options.trackerDuration),r){var a,o=0,l=(0,p.Z)(this._options.optimizations);try{for(l.s();!(a=l.n()).done;){a.value.priority=o++}}catch(u){l.e(u)}finally{l.f()}}this._improvementMode=s,this._scene=t||V.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add((function(){n._sceneDisposeObserver=null,n.dispose()}))}return(0,y.Z)(e,[{key:"isInImprovementMode",get:function(){return this._improvementMode},set:function(e){this._improvementMode=e}},{key:"currentPriorityLevel",get:function(){return this._currentPriorityLevel}},{key:"currentFrameRate",get:function(){return this._currentFrameRate}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){this._targetFrameRate=e}},{key:"trackerDuration",get:function(){return this._trackerDuration},set:function(e){this._trackerDuration=e}},{key:"optimizations",get:function(){return this._options.optimizations}},{key:"stop",value:function(){this._isRunning=!1}},{key:"reset",value:function(){this._currentPriorityLevel=0}},{key:"start",value:function(){var e=this;this._isRunning||(this._isRunning=!0,this._scene.executeWhenReady((function(){setTimeout((function(){e._checkCurrentState()}),e._trackerDuration)})))}},{key:"_checkCurrentState",value:function(){var e=this;if(this._isRunning){var t=this._scene,i=this._options;if(this._currentFrameRate=Math.round(t.getEngine().getFps()),this._improvementMode&&this._currentFrameRate<=this._targetFrameRate||!this._improvementMode&&this._currentFrameRate>=this._targetFrameRate)return this._isRunning=!1,void this.onSuccessObservable.notifyObservers(this);for(var n=!0,r=!0,s=0;s<i.optimizations.length;s++){var a=i.optimizations[s];a.priority===this._currentPriorityLevel&&(r=!1,n=n&&a.apply(t,this),this.onNewOptimizationAppliedObservable.notifyObservers(a))}if(r)return this._isRunning=!1,void this.onFailureObservable.notifyObservers(this);n&&this._currentPriorityLevel++,t.executeWhenReady((function(){setTimeout((function(){e._checkCurrentState()}),e._trackerDuration)}))}}},{key:"dispose",value:function(){this.stop(),this.onSuccessObservable.clear(),this.onFailureObservable.clear(),this.onNewOptimizationAppliedObservable.clear(),this._sceneDisposeObserver&&this._scene.onDisposeObservable.remove(this._sceneDisposeObserver)}}],[{key:"OptimizeAsync",value:function(t,i,n,r){var s=new e(t,i||Kn.ModerateDegradationAllowed(),!1);return n&&s.onSuccessObservable.add((function(){n()})),r&&s.onFailureObservable.add((function(){r()})),s.start(),s}}]),e}();function qn(e){var t=e.engine,i=new zi(t);i.clearColor=new Ke(0,0,0,0),i.pointerMovePredicate=function(){return!1},i.pointerDownPredicate=function(){return!1},i.pointerUpPredicate=function(){return!1},i.clearCachedVertexData(),i.themeData={};var n=Kn.LowDegradationAllowed();return n.optimizations=n.optimizations.splice(1),n.targetFrameRate=60,Yn.OptimizeAsync(i,n),i}var jn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r){var s,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return(0,m.Z)(this,i),(s=t.call(this,e,n,r,a))._tmpUpVector=z.Zero(),s._tmpTargetVector=z.Zero(),s.cameraDirection=new z(0,0,0),s.cameraRotation=new W(0,0),s.ignoreParentScaling=!1,s.updateUpVectorFromRotation=!1,s._tmpQuaternion=new H,s.rotation=new z(0,0,0),s.speed=2,s.noRotationConstraint=!1,s.invertRotation=!1,s.inverseRotationSpeed=.2,s.lockedTarget=null,s._currentTarget=z.Zero(),s._initialFocalDistance=1,s._viewMatrix=Z.Zero(),s._camMatrix=Z.Zero(),s._cameraTransformMatrix=Z.Zero(),s._cameraRotationMatrix=Z.Zero(),s._referencePoint=new z(0,0,1),s._transformedReferencePoint=z.Zero(),s._defaultUp=z.Up(),s._cachedRotationZ=0,s._cachedQuaternionRotationZ=0,s}return(0,y.Z)(i,[{key:"getFrontPosition",value:function(e){this.getWorldMatrix();var t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}},{key:"_getLockedTargetPosition",value:function(){return this.lockedTarget?(this.lockedTarget.absolutePosition&&this.lockedTarget.computeWorldMatrix(),this.lockedTarget.absolutePosition||this.lockedTarget):null}},{key:"storeState",value:function(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),c((0,h.Z)(i.prototype),"storeState",this).call(this)}},{key:"_restoreStateValues",value:function(){return!!c((0,h.Z)(i.prototype),"_restoreStateValues",this).call(this)&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0)}},{key:"_initCache",value:function(){c((0,h.Z)(i.prototype),"_initCache",this).call(this),this._cache.lockedTarget=new z(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new z(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new H(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}},{key:"_updateCache",value:function(e){e||c((0,h.Z)(i.prototype),"_updateCache",this).call(this);var t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}},{key:"_isSynchronizedViewMatrix",value:function(){if(!c((0,h.Z)(i.prototype),"_isSynchronizedViewMatrix",this).call(this))return!1;var e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}},{key:"_computeLocalCameraSpeed",value:function(){var e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(100*e.getFps()))}},{key:"setTarget",value:function(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=D),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),Z.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&H.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}},{key:"target",get:function(){return this.getTarget()},set:function(e){this.setTarget(e)}},{key:"getTarget",value:function(){return this._currentTarget}},{key:"_decideIfNeedsToMove",value:function(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}},{key:"_updatePosition",value:function(){if(this.parent)return this.parent.getWorldMatrix().invertToRef(Y.Matrix[0]),z.TransformNormalToRef(this.cameraDirection,Y.Matrix[0],Y.Vector3[0]),void this.position.addInPlace(Y.Vector3[0]);this.position.addInPlace(this.cameraDirection)}},{key:"_checkInputs",value:function(){var e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),n=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;t&&this._updatePosition(),n&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this.rotation),this.rotation.x+=this.cameraRotation.x*e,this.rotation.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this.rotation.x>1.570796&&(this.rotation.x=1.570796),this.rotation.x<-1.570796&&(this.rotation.x=-1.570796)),this.rotationQuaternion&&this.rotation.lengthSquared()&&H.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)),t&&(Math.abs(this.cameraDirection.x)<this.speed*D&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*D&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*D&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),n&&(Math.abs(this.cameraRotation.x)<this.speed*D&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*D&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),c((0,h.Z)(i.prototype),"_checkInputs",this).call(this)}},{key:"_updateCameraRotationMatrix",value:function(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):Z.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}},{key:"_rotateUpVectorWithCameraRotationMatrix",value:function(){return z.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}},{key:"_getViewMatrix",value:function(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),z.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?vn.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(H.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),vn.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}},{key:"_computeViewMatrix",value:function(e,t,i){if(this.ignoreParentScaling){if(this.parent){var n=this.parent.getWorldMatrix();z.TransformCoordinatesToRef(e,n,this._globalPosition),z.TransformCoordinatesToRef(t,n,this._tmpTargetVector),z.TransformNormalToRef(i,n,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?Z.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):Z.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix)}else if(this.getScene().useRightHandedSystem?Z.LookAtRHToRef(e,t,i,this._viewMatrix):Z.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){var r=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(r,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}},{key:"createRigCamera",value:function(e,t){if(this.cameraRigMode!==ji.RIG_MODE_NONE){var n=new i(e,this.position.clone(),this.getScene());return n.isRigCamera=!0,n.rigParent=this,(this.cameraRigMode===ji.RIG_MODE_VR||this.cameraRigMode===ji.RIG_MODE_WEBVR)&&(this.rotationQuaternion||(this.rotationQuaternion=new H),n._cameraRigParams={},n.rotationQuaternion=new H),n.mode=this.mode,n.orthoLeft=this.orthoLeft,n.orthoRight=this.orthoRight,n.orthoTop=this.orthoTop,n.orthoBottom=this.orthoBottom,n}return null}},{key:"_updateRigCameras",value:function(){var e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case ji.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case ji.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case ji.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case ji.RIG_MODE_STEREOSCOPIC_OVERUNDER:case ji.RIG_MODE_STEREOSCOPIC_INTERLACED:var n=this.cameraRigMode===ji.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,r=this.cameraRigMode===ji.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*n,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*r,t);break;case ji.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position)}c((0,h.Z)(i.prototype),"_updateRigCameras",this).call(this)}},{key:"_getRigCamPositionAndTarget",value:function(e,t){this.getTarget().subtractToRef(this.position,i._TargetFocalPoint),i._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);var n=i._TargetFocalPoint.addInPlace(this.position);Z.TranslationToRef(-n.x,-n.y,-n.z,i._TargetTransformMatrix),i._TargetTransformMatrix.multiplyToRef(Z.RotationAxis(t.upVector,e),i._RigCamTransformMatrix),Z.TranslationToRef(n.x,n.y,n.z,i._TargetTransformMatrix),i._RigCamTransformMatrix.multiplyToRef(i._TargetTransformMatrix,i._RigCamTransformMatrix),z.TransformCoordinatesToRef(this.position,i._RigCamTransformMatrix,t.position),t.setTarget(n)}},{key:"getClassName",value:function(){return"TargetCamera"}}]),i}(ji);function Qn(e){var t,i=e.scene;return(t=new jn("TargetCamera1",new z(0,36.5,0),i)).fov=.25,t.minZ=5,t.maxZ=37.5,t.setTarget(z.Zero()),t}jn._RigCamTransformMatrix=new Z,jn._TargetTransformMatrix=new Z,jn._TargetFocalPoint=new z,Nt([Yt()],jn.prototype,"rotation",void 0),Nt([Xt()],jn.prototype,"speed",void 0),Nt([function(e){return Wt(6,e)}("lockedTargetId")],jn.prototype,"lockedTarget",void 0);var Jn=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r;return(0,m.Z)(this,i),(r=t.call(this,e,n)).diffuse=new Ze(1,1,1),r.specular=new Ze(1,1,1),r.falloffType=i.FALLOFF_DEFAULT,r.intensity=1,r._range=Number.MAX_VALUE,r._inverseSquaredRange=0,r._photometricScale=1,r._intensityMode=i.INTENSITYMODE_AUTOMATIC,r._radius=1e-5,r.renderPriority=0,r._shadowEnabled=!0,r._excludeWithLayerMask=0,r._includeOnlyWithLayerMask=0,r._lightmapMode=0,r._shadowGenerators=null,r._excludedMeshesIds=new Array,r._includedOnlyMeshesIds=new Array,r._isLight=!0,r.getScene().addLight((0,u.Z)(r)),r._uniformBuffer=new ti(r.getScene().getEngine(),void 0,void 0,e),r._buildUniformLayout(),r.includedOnlyMeshes=new Array,r.excludedMeshes=new Array,r._resyncMeshes(),r}return(0,y.Z)(i,[{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}},{key:"intensityMode",get:function(){return this._intensityMode},set:function(e){this._intensityMode=e,this._computePhotometricScale()}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this._computePhotometricScale()}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}},{key:"includedOnlyMeshes",get:function(){return this._includedOnlyMeshes},set:function(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}},{key:"excludedMeshes",get:function(){return this._excludedMeshes},set:function(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}},{key:"excludeWithLayerMask",get:function(){return this._excludeWithLayerMask},set:function(e){this._excludeWithLayerMask=e,this._resyncMeshes()}},{key:"includeOnlyWithLayerMask",get:function(){return this._includeOnlyWithLayerMask},set:function(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}},{key:"lightmapMode",get:function(){return this._lightmapMode},set:function(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}},{key:"transferTexturesToEffect",value:function(e,t){return this}},{key:"_bindLight",value:function(e,t,i,n){var r,s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],a=e.toString(),o=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+a),this._renderId!==t.getRenderId()||this._lastUseSpecular!==n||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=n;var l=this.getScaledIntensity();this.transferToEffect(i,a),this.diffuse.scaleToRef(l,Ye.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",Ye.Color3[0],this.range,a),n&&(this.specular.scaleToRef(l,Ye.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",Ye.Color3[1],this.radius,a)),o=!0}if(this.transferTexturesToEffect(i,a),t.shadowsEnabled&&this.shadowEnabled&&s){var u=null!==(r=this.getShadowGenerator(t.activeCamera))&&void 0!==r?r:this.getShadowGenerator();u&&(u.bindShadowLight(a,i),o=!0)}o?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}},{key:"getClassName",value:function(){return"Light"}},{key:"toString",value:function(e){var t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(var i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}},{key:"_syncParentEnabledState",value:function(){c((0,h.Z)(i.prototype),"_syncParentEnabledState",this).call(this),this.isDisposed()||this._resyncMeshes()}},{key:"setEnabled",value:function(e){c((0,h.Z)(i.prototype),"setEnabled",this).call(this,e),this._resyncMeshes()}},{key:"getShadowGenerator",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return null===this._shadowGenerators?null:null!==(e=this._shadowGenerators.get(t))&&void 0!==e?e:null}},{key:"getShadowGenerators",value:function(){return this._shadowGenerators}},{key:"getAbsolutePosition",value:function(){return z.Zero()}},{key:"canAffectMesh",value:function(e){return!e||!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&-1===this.includedOnlyMeshes.indexOf(e)||this.excludedMeshes&&this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)||0!==this.includeOnlyWithLayerMask&&!(this.includeOnlyWithLayerMask&e.layerMask)||0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&e.layerMask)}},{key:"dispose",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._shadowGenerators){for(var n=this._shadowGenerators.values(),r=n.next();!0!==r.done;r=n.next())r.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){var s=this._parentContainer.lights.indexOf(this);s>-1&&this._parentContainer.lights.splice(s,1),this._parentContainer=null}var a,o=(0,p.Z)(this.getScene().meshes);try{for(o.s();!(a=o.n()).done;){a.value._removeLightSource(this,!0)}}catch(l){o.e(l)}finally{o.f()}this._uniformBuffer.dispose(),this.getScene().removeLight(this),c((0,h.Z)(i.prototype),"dispose",this).call(this,e,t)}},{key:"getTypeID",value:function(){return 0}},{key:"getScaledIntensity",value:function(){return this._photometricScale*this.intensity}},{key:"clone",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=i.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!n)return null;var r=jt.Clone(n,this);return e&&(r.name=e),t&&(r.parent=t),r.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(r),r}},{key:"serialize",value:function(){var e=jt.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach((function(t){e.excludedMeshesIds.push(t.id)}))),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach((function(t){e.includedOnlyMeshesIds.push(t.id)}))),jt.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}},{key:"_hookArrayForExcluded",value:function(e){var t=this,i=e.push;e.push=function(){for(var n=arguments.length,r=new Array(n),s=0;s<n;s++)r[s]=arguments[s];for(var a=i.apply(e,r),o=0,l=r;o<l.length;o++){l[o]._resyncLightSource(t)}return a};var n=e.splice;e.splice=function(i,r){var s,a=n.apply(e,[i,r]),o=(0,p.Z)(a);try{for(o.s();!(s=o.n()).done;){s.value._resyncLightSource(t)}}catch(l){o.e(l)}finally{o.f()}return a};var r,s=(0,p.Z)(e);try{for(s.s();!(r=s.n()).done;){r.value._resyncLightSource(this)}}catch(a){s.e(a)}finally{s.f()}}},{key:"_hookArrayForIncludedOnly",value:function(e){var t=this,i=e.push;e.push=function(){for(var n=arguments.length,r=new Array(n),s=0;s<n;s++)r[s]=arguments[s];var a=i.apply(e,r);return t._resyncMeshes(),a};var n=e.splice;e.splice=function(i,r){var s=n.apply(e,[i,r]);return t._resyncMeshes(),s},this._resyncMeshes()}},{key:"_resyncMeshes",value:function(){var e,t=(0,p.Z)(this.getScene().meshes);try{for(t.s();!(e=t.n()).done;){e.value._resyncLightSource(this)}}catch(i){t.e(i)}finally{t.f()}}},{key:"_markMeshesAsLightDirty",value:function(){var e,t=(0,p.Z)(this.getScene().meshes);try{for(t.s();!(e=t.n()).done;){var i=e.value;-1!==i.lightSources.indexOf(this)&&i._markSubMeshesAsLightDirty()}}catch(n){t.e(n)}finally{t.f()}}},{key:"_computePhotometricScale",value:function(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}},{key:"_getPhotometricScale",value:function(){var e=0,t=this.getTypeID(),n=this.intensityMode;switch(n===i.INTENSITYMODE_AUTOMATIC&&(n=t===i.LIGHTTYPEID_DIRECTIONALLIGHT?i.INTENSITYMODE_ILLUMINANCE:i.INTENSITYMODE_LUMINOUSINTENSITY),t){case i.LIGHTTYPEID_POINTLIGHT:case i.LIGHTTYPEID_SPOTLIGHT:switch(n){case i.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case i.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case i.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius}break;case i.LIGHTTYPEID_DIRECTIONALLIGHT:switch(n){case i.INTENSITYMODE_ILLUMINANCE:e=1;break;case i.INTENSITYMODE_LUMINANCE:var r=this.radius;r=Math.max(r,.001),e=2*Math.PI*(1-Math.cos(r))}break;case i.LIGHTTYPEID_HEMISPHERICLIGHT:e=1}return e}},{key:"_reorderLightsInScene",value:function(){var e=this.getScene();0!=this._renderPriority&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}],[{key:"GetConstructorFromName",value:function(e,t,i){return Yi.Construct("Light_Type_"+e,t,i)||null}},{key:"Parse",value:function(e,t){var n=i.GetConstructorFromName(e.type,e.name,t);if(!n)return null;var r=jt.Parse(n,e,t);if(e.excludedMeshesIds&&(r._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(r._includedOnlyMeshesIds=e.includedOnlyMeshesIds),void 0!==e.parentId&&(r._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.falloffType&&(r.falloffType=e.falloffType),void 0!==e.lightmapMode&&(r.lightmapMode=e.lightmapMode),e.animations){for(var s=0;s<e.animations.length;s++){var a=e.animations[s],o=B("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}Yi.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&r.setEnabled(e.isEnabled),r}}]),i}(Yi);Jn.FALLOFF_DEFAULT=Wi.FALLOFF_DEFAULT,Jn.FALLOFF_PHYSICAL=Wi.FALLOFF_PHYSICAL,Jn.FALLOFF_GLTF=Wi.FALLOFF_GLTF,Jn.FALLOFF_STANDARD=Wi.FALLOFF_STANDARD,Jn.LIGHTMAP_DEFAULT=Wi.LIGHTMAP_DEFAULT,Jn.LIGHTMAP_SPECULAR=Wi.LIGHTMAP_SPECULAR,Jn.LIGHTMAP_SHADOWSONLY=Wi.LIGHTMAP_SHADOWSONLY,Jn.INTENSITYMODE_AUTOMATIC=Wi.INTENSITYMODE_AUTOMATIC,Jn.INTENSITYMODE_LUMINOUSPOWER=Wi.INTENSITYMODE_LUMINOUSPOWER,Jn.INTENSITYMODE_LUMINOUSINTENSITY=Wi.INTENSITYMODE_LUMINOUSINTENSITY,Jn.INTENSITYMODE_ILLUMINANCE=Wi.INTENSITYMODE_ILLUMINANCE,Jn.INTENSITYMODE_LUMINANCE=Wi.INTENSITYMODE_LUMINANCE,Jn.LIGHTTYPEID_POINTLIGHT=Wi.LIGHTTYPEID_POINTLIGHT,Jn.LIGHTTYPEID_DIRECTIONALLIGHT=Wi.LIGHTTYPEID_DIRECTIONALLIGHT,Jn.LIGHTTYPEID_SPOTLIGHT=Wi.LIGHTTYPEID_SPOTLIGHT,Jn.LIGHTTYPEID_HEMISPHERICLIGHT=Wi.LIGHTTYPEID_HEMISPHERICLIGHT,Nt([Zt()],Jn.prototype,"diffuse",void 0),Nt([Zt()],Jn.prototype,"specular",void 0),Nt([Xt()],Jn.prototype,"falloffType",void 0),Nt([Xt()],Jn.prototype,"intensity",void 0),Nt([Xt()],Jn.prototype,"range",null),Nt([Xt()],Jn.prototype,"intensityMode",null),Nt([Xt()],Jn.prototype,"radius",null),Nt([Xt()],Jn.prototype,"_renderPriority",void 0),Nt([zt("_reorderLightsInScene")],Jn.prototype,"renderPriority",void 0),Nt([Xt("shadowEnabled")],Jn.prototype,"_shadowEnabled",void 0),Nt([Xt("excludeWithLayerMask")],Jn.prototype,"_excludeWithLayerMask",void 0),Nt([Xt("includeOnlyWithLayerMask")],Jn.prototype,"_includeOnlyWithLayerMask",void 0),Nt([Xt("lightmapMode")],Jn.prototype,"_lightmapMode",void 0);var $n=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){var e;return(0,m.Z)(this,i),(e=t.apply(this,arguments))._needProjectionMatrixCompute=!0,e}return(0,y.Z)(i,[{key:"_setPosition",value:function(e){this._position=e}},{key:"position",get:function(){return this._position},set:function(e){this._setPosition(e)}},{key:"_setDirection",value:function(e){this._direction=e}},{key:"direction",get:function(){return this._direction},set:function(e){this._setDirection(e)}},{key:"shadowMinZ",get:function(){return this._shadowMinZ},set:function(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}},{key:"shadowMaxZ",get:function(){return this._shadowMaxZ},set:function(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}},{key:"computeTransformedInformation",value:function(){return!(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition||(this.transformedPosition=z.Zero()),z.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=z.Zero()),z.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0)}},{key:"getDepthScale",value:function(){return 50}},{key:"getShadowDirection",value:function(e){return this.transformedDirection?this.transformedDirection:this.direction}},{key:"getAbsolutePosition",value:function(){return this.transformedPosition?this.transformedPosition:this.position}},{key:"setDirectionToTarget",value:function(e){return this.direction=z.Normalize(e.subtract(this.position)),this.direction}},{key:"getRotation",value:function(){this.direction.normalize();var e=z.Cross(this.direction,vn.Y),t=z.Cross(e,this.direction);return z.RotationFromAxis(e,t,this.direction)}},{key:"needCube",value:function(){return!1}},{key:"needProjectionMatrixCompute",value:function(){return this._needProjectionMatrixCompute}},{key:"forceProjectionMatrixCompute",value:function(){this._needProjectionMatrixCompute=!0}},{key:"_initCache",value:function(){c((0,h.Z)(i.prototype),"_initCache",this).call(this),this._cache.position=z.Zero()}},{key:"_isSynchronized",value:function(){return!!this._cache.position.equals(this.position)}},{key:"computeWorldMatrix",value:function(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=Z.Identity()),Z.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}},{key:"getDepthMinZ",value:function(e){return void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ}},{key:"getDepthMaxZ",value:function(e){return void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ}},{key:"setShadowProjectionMatrix",value:function(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}},{key:"_syncParentEnabledState",value:function(){c((0,h.Z)(i.prototype),"_syncParentEnabledState",this).call(this),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}}]),i}(Jn);Nt([Yt()],$n.prototype,"position",null),Nt([Yt()],$n.prototype,"direction",null),Nt([Xt()],$n.prototype,"shadowMinZ",null),Nt([Xt()],$n.prototype,"shadowMaxZ",null),Yi.AddNodeConstructor("Light_Type_1",(function(e,t){return function(){return new er(e,z.Zero(),t)}}));var er=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r){var s;return(0,m.Z)(this,i),(s=t.call(this,e,r))._shadowFrustumSize=0,s._shadowOrthoScale=.1,s.autoUpdateExtends=!0,s.autoCalcShadowZBounds=!1,s._orthoLeft=Number.MAX_VALUE,s._orthoRight=Number.MIN_VALUE,s._orthoTop=Number.MIN_VALUE,s._orthoBottom=Number.MAX_VALUE,s.position=n.scale(-1),s.direction=n,s}return(0,y.Z)(i,[{key:"shadowFrustumSize",get:function(){return this._shadowFrustumSize},set:function(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}},{key:"shadowOrthoScale",get:function(){return this._shadowOrthoScale},set:function(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}},{key:"orthoLeft",get:function(){return this._orthoLeft},set:function(e){this._orthoLeft=e}},{key:"orthoRight",get:function(){return this._orthoRight},set:function(e){this._orthoRight=e}},{key:"orthoTop",get:function(){return this._orthoTop},set:function(e){this._orthoTop=e}},{key:"orthoBottom",get:function(){return this._orthoBottom},set:function(e){this._orthoBottom=e}},{key:"getClassName",value:function(){return"DirectionalLight"}},{key:"getTypeID",value:function(){return Jn.LIGHTTYPEID_DIRECTIONALLIGHT}},{key:"_setDefaultShadowProjectionMatrix",value:function(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}},{key:"_setDefaultFixedFrustumShadowProjectionMatrix",value:function(e){var t=this.getScene().activeCamera;t&&Z.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}},{key:"_setDefaultAutoExtendShadowProjectionMatrix",value:function(e,t,i){var n=this.getScene().activeCamera;if(n){if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){var r=z.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;for(var s=Number.MAX_VALUE,a=Number.MIN_VALUE,o=0;o<i.length;o++){var l=i[o];if(l)for(var u=l.getBoundingInfo().boundingBox,h=0;h<u.vectorsWorld.length;h++)z.TransformCoordinatesToRef(u.vectorsWorld[h],t,r),r.x<this._orthoLeft&&(this._orthoLeft=r.x),r.y<this._orthoBottom&&(this._orthoBottom=r.y),r.x>this._orthoRight&&(this._orthoRight=r.x),r.y>this._orthoTop&&(this._orthoTop=r.y),this.autoCalcShadowZBounds&&(r.z<s&&(s=r.z),r.z>a&&(a=r.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=s,this._shadowMaxZ=a)}var c=this._orthoRight-this._orthoLeft,d=this._orthoTop-this._orthoBottom,f=void 0!==this.shadowMinZ?this.shadowMinZ:n.minZ,_=void 0!==this.shadowMaxZ?this.shadowMaxZ:n.maxZ,v=this.getScene().getEngine().useReverseDepthBuffer;Z.OrthoOffCenterLHToRef(this._orthoLeft-c*this.shadowOrthoScale,this._orthoRight+c*this.shadowOrthoScale,this._orthoBottom-d*this.shadowOrthoScale,this._orthoTop+d*this.shadowOrthoScale,v?_:f,v?f:_,e,this.getScene().getEngine().isNDCHalfZRange)}}},{key:"_buildUniformLayout",value:function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}},{key:"transferToEffect",value:function(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}},{key:"transferToNodeMaterialEffect",value:function(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}},{key:"getDepthMinZ",value:function(e){var t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}},{key:"getDepthMaxZ",value:function(e){var t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}},{key:"prepareLightSpecificDefines",value:function(e,t){e["DIRLIGHT"+t]=!0}}]),i}($n);Nt([Xt()],er.prototype,"shadowFrustumSize",null),Nt([Xt()],er.prototype,"shadowOrthoScale",null),Nt([Xt()],er.prototype,"autoUpdateExtends",void 0),Nt([Xt()],er.prototype,"autoCalcShadowZBounds",void 0),Nt([Xt("orthoLeft")],er.prototype,"_orthoLeft",void 0),Nt([Xt("orthoRight")],er.prototype,"_orthoRight",void 0),Nt([Xt("orthoTop")],er.prototype,"_orthoTop",void 0),Nt([Xt("orthoBottom")],er.prototype,"_orthoBottom",void 0),Yi.AddNodeConstructor("Light_Type_3",(function(e,t){return function(){return new tr(e,z.Zero(),t)}}));var tr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r){var s;return(0,m.Z)(this,i),(s=t.call(this,e,r)).groundColor=new Ze(0,0,0),s.direction=n||z.Up(),s}return(0,y.Z)(i,[{key:"_buildUniformLayout",value:function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}},{key:"getClassName",value:function(){return"HemisphericLight"}},{key:"setDirectionToTarget",value:function(e){return this.direction=z.Normalize(e.subtract(z.Zero())),this.direction}},{key:"getShadowGenerator",value:function(){return null}},{key:"transferToEffect",value:function(e,t){var i=z.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}},{key:"transferToNodeMaterialEffect",value:function(e,t){var i=z.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}},{key:"computeWorldMatrix",value:function(){return this._worldMatrix||(this._worldMatrix=Z.Identity()),this._worldMatrix}},{key:"getTypeID",value:function(){return Jn.LIGHTTYPEID_HEMISPHERICLIGHT}},{key:"prepareLightSpecificDefines",value:function(e,t){e["HEMILIGHT"+t]=!0}}]),i}(Jn);Nt([Zt()],tr.prototype,"groundColor",void 0),Nt([Yt()],tr.prototype,"direction",void 0);var ir=function(){function e(t,i){(0,m.Z)(this,e),this.width=t,this.height=i}return(0,y.Z)(e,[{key:"toString",value:function(){return"{W: ".concat(this.width,", H: ").concat(this.height,"}")}},{key:"getClassName",value:function(){return"Size"}},{key:"getHashCode",value:function(){var e=0|this.width;return e=397*e^(0|this.height)}},{key:"copyFrom",value:function(e){this.width=e.width,this.height=e.height}},{key:"copyFromFloats",value:function(e,t){return this.width=e,this.height=t,this}},{key:"set",value:function(e,t){return this.copyFromFloats(e,t)}},{key:"multiplyByFloats",value:function(t,i){return new e(this.width*t,this.height*i)}},{key:"clone",value:function(){return new e(this.width,this.height)}},{key:"equals",value:function(e){return!!e&&(this.width===e.width&&this.height===e.height)}},{key:"surface",get:function(){return this.width*this.height}},{key:"add",value:function(t){return new e(this.width+t.width,this.height+t.height)}},{key:"subtract",value:function(t){return new e(this.width-t.width,this.height-t.height)}}],[{key:"Zero",value:function(){return new e(0,0)}},{key:"Lerp",value:function(t,i,n){return new e(t.width+(i.width-t.width)*n,t.height+(i.height-t.height)*n)}}]),e}(),nr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return(0,m.Z)(this,i),(n=t.call(this,null)).metadata=null,n.reservedDataStore=null,n._hasAlpha=!1,n._getAlphaFromRGB=!1,n.level=1,n._coordinatesIndex=0,n.optimizeUVAllocation=!0,n._coordinatesMode=0,n.wrapR=1,n.anisotropicFilteringLevel=i.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,n._isCube=!1,n._gammaSpace=!0,n.invertZ=!1,n.lodLevelInAlpha=!1,n.isRenderTarget=!1,n._prefiltered=!1,n._forceSerialize=!1,n.animations=new Array,n.onDisposeObservable=new ee,n._onDisposeObserver=null,n._scene=null,n._uid=null,n._parentContainer=null,n._loadingError=!1,e?i._IsScene(e)?n._scene=e:n._engine=e:n._scene=V.LastCreatedScene,n._scene&&(n.uniqueId=n._scene.getUniqueId(),n._scene.addTexture((0,u.Z)(n)),n._engine=n._scene.getEngine()),n._texture=r,n._uid=null,n}return(0,y.Z)(i,[{key:"hasAlpha",get:function(){return this._hasAlpha},set:function(e){var t=this;this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(function(e){return e.hasTexture(t)})))}},{key:"getAlphaFromRGB",get:function(){return this._getAlphaFromRGB},set:function(e){var t=this;this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(function(e){return e.hasTexture(t)})))}},{key:"coordinatesIndex",get:function(){return this._coordinatesIndex},set:function(e){var t=this;this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(function(e){return e.hasTexture(t)})))}},{key:"coordinatesMode",get:function(){return this._coordinatesMode},set:function(e){var t=this;this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(function(e){return e.hasTexture(t)})))}},{key:"wrapU",get:function(){return this._wrapU},set:function(e){this._wrapU=e}},{key:"wrapV",get:function(){return this._wrapV},set:function(e){this._wrapV=e}},{key:"isCube",get:function(){return this._texture?this._texture.isCube:this._isCube},set:function(e){this._texture?this._texture.isCube=e:this._isCube=e}},{key:"is3D",get:function(){return!!this._texture&&this._texture.is3D},set:function(e){this._texture&&(this._texture.is3D=e)}},{key:"is2DArray",get:function(){return!!this._texture&&this._texture.is2DArray},set:function(e){this._texture&&(this._texture.is2DArray=e)}},{key:"gammaSpace",get:function(){return this._texture?(null===this._texture._gammaSpace&&(this._texture._gammaSpace=this._gammaSpace),this._texture._gammaSpace&&!this._texture._useSRGBBuffer):this._gammaSpace},set:function(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this._markAllSubMeshesAsTexturesDirty()}},{key:"isRGBD",get:function(){return null!=this._texture&&this._texture._isRGBD},set:function(e){this._texture&&(this._texture._isRGBD=e)}},{key:"noMipmap",get:function(){return!1}},{key:"lodGenerationOffset",get:function(){return this._texture?this._texture._lodGenerationOffset:0},set:function(e){this._texture&&(this._texture._lodGenerationOffset=e)}},{key:"lodGenerationScale",get:function(){return this._texture?this._texture._lodGenerationScale:0},set:function(e){this._texture&&(this._texture._lodGenerationScale=e)}},{key:"linearSpecularLOD",get:function(){return!!this._texture&&this._texture._linearSpecularLOD},set:function(e){this._texture&&(this._texture._linearSpecularLOD=e)}},{key:"irradianceTexture",get:function(){return this._texture?this._texture._irradianceTexture:null},set:function(e){this._texture&&(this._texture._irradianceTexture=e)}},{key:"uid",get:function(){return this._uid||(this._uid=Ct()),this._uid}},{key:"toString",value:function(){return this.name}},{key:"getClassName",value:function(){return"BaseTexture"}},{key:"onDispose",set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}},{key:"isBlocking",get:function(){return!0}},{key:"loadingError",get:function(){return this._loadingError}},{key:"errorObject",get:function(){return this._errorObject}},{key:"getScene",value:function(){return this._scene}},{key:"_getEngine",value:function(){return this._engine}},{key:"checkTransformsAreIdentical",value:function(e){return null!==e}},{key:"getTextureMatrix",value:function(){return Z.IdentityReadOnly}},{key:"getReflectionTextureMatrix",value:function(){return Z.IdentityReadOnly}},{key:"isReadyOrNotBlocking",value:function(){return!this.isBlocking||this.isReady()||this.loadingError}},{key:"scale",value:function(e){}},{key:"canRescale",get:function(){return!1}},{key:"_getFromCache",value:function(e,t,i,n,r,s){var a=this._getEngine();if(!a)return null;for(var o=a._getUseSRGBBuffer(!!r,t),l=a.getLoadedTexturesCache(),u=0;u<l.length;u++){var h=l[u];if((void 0===r||o===h._useSRGBBuffer)&&(void 0===n||n===h.invertY)&&h.url===e&&h.generateMipMaps===!t&&(!i||i===h.samplingMode)&&(void 0===s||s===h.isCube))return h.incrementReferences(),h}return null}},{key:"_rebuild",value:function(){}},{key:"clone",value:function(){return null}},{key:"textureType",get:function(){return this._texture&&void 0!==this._texture.type?this._texture.type:0}},{key:"textureFormat",get:function(){return this._texture&&void 0!==this._texture.format?this._texture.format:5}},{key:"_markAllSubMeshesAsTexturesDirty",value:function(){var e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}},{key:"readPixels",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Number.MAX_VALUE,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:Number.MAX_VALUE;if(!this._texture)return null;var u=this._getEngine();if(!u)return null;var h=this.getSize(),c=h.width,d=h.height;0!==t&&(c/=Math.pow(2,t),d/=Math.pow(2,t),c=Math.round(c),d=Math.round(d)),o=Math.min(c,o),l=Math.min(d,l);try{return this._texture.isCube?u._readTexturePixels(this._texture,o,l,e,t,i,n,r,s,a):u._readTexturePixels(this._texture,o,l,-1,t,i,n,r,s,a)}catch(f){return null}}},{key:"_readPixelsSync",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(!this._texture)return null;var s=this.getSize(),a=s.width,o=s.height,l=this._getEngine();if(!l)return null;0!=t&&(a/=Math.pow(2,t),o/=Math.pow(2,t),a=Math.round(a),o=Math.round(o));try{return this._texture.isCube?l._readTexturePixelsSync(this._texture,a,o,e,t,i,n,r):l._readTexturePixelsSync(this._texture,a,o,-1,t,i,n,r)}catch(u){return null}}},{key:"_lodTextureHigh",get:function(){return this._texture?this._texture._lodTextureHigh:null}},{key:"_lodTextureMid",get:function(){return this._texture?this._texture._lodTextureMid:null}},{key:"_lodTextureLow",get:function(){return this._texture?this._texture._lodTextureLow:null}},{key:"dispose",value:function(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);var e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){var t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,c((0,h.Z)(i.prototype),"dispose",this).call(this)}},{key:"serialize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.name&&!e)return null;var t=jt.Serialize(this);return jt.AppendSerializedAnimations(this,t),t}}],[{key:"WhenAllReady",value:function(e,t){var i=e.length;if(0!==i)for(var n=0;n<e.length;n++){var r=e[n];if(r.isReady())0===--i&&t();else{var s=r.onLoadObservable;s?s.addOnce((function(){0===--i&&t()})):0===--i&&t()}}else t()}},{key:"_IsScene",value:function(e){return"Scene"===e.getClassName()}}]),i}(function(){function e(t){(0,m.Z)(this,e),this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=ir.Zero(),this._cachedBaseSize=ir.Zero(),this._initialSamplingMode=2,this._texture=t,this._texture&&(this._engine=this._texture.getEngine())}return(0,y.Z)(e,[{key:"wrapU",get:function(){return this._wrapU},set:function(e){this._wrapU=e}},{key:"wrapV",get:function(){return this._wrapV},set:function(e){this._wrapV=e}},{key:"coordinatesMode",get:function(){return 0}},{key:"isCube",get:function(){return!!this._texture&&this._texture.isCube},set:function(e){this._texture&&(this._texture.isCube=e)}},{key:"is3D",get:function(){return!!this._texture&&this._texture.is3D},set:function(e){this._texture&&(this._texture.is3D=e)}},{key:"is2DArray",get:function(){return!!this._texture&&this._texture.is2DArray},set:function(e){this._texture&&(this._texture.is2DArray=e)}},{key:"getClassName",value:function(){return"ThinTexture"}},{key:"isReady",value:function(){return 4===this.delayLoadState?(this.delayLoad(),!1):!!this._texture&&this._texture.isReady}},{key:"delayLoad",value:function(){}},{key:"getInternalTexture",value:function(){return this._texture}},{key:"getSize",value:function(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}},{key:"getBaseSize",value:function(){return this.isReady()&&this._texture?this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize):(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize)}},{key:"samplingMode",get:function(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}},{key:"updateSamplingMode",value:function(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}},{key:"releaseInternalTexture",value:function(){this._texture&&(this._texture.dispose(),this._texture=null)}},{key:"dispose",value:function(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}]),e}());function rr(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=t.width,r=t.height;if(e instanceof Float32Array){for(var s=e.byteLength/e.BYTES_PER_ELEMENT,a=new Uint8Array(s);--s>=0;){var o=e[s];o<0?o=0:o>1&&(o=1),a[s]=255*o}e=a}var l=document.createElement("canvas");l.width=n,l.height=r;var u=l.getContext("2d");if(!u)return null;var h=u.createImageData(n,r);if(h.data.set(e),u.putImageData(h,0,0),i){var c=document.createElement("canvas");c.width=n,c.height=r;var d=c.getContext("2d");return d?(d.translate(0,r),d.scale(1,-1),d.drawImage(l,0,0),c.toDataURL("image/png")):null}return l.toDataURL("image/png")}function sr(){return sr=(0,f.Z)((0,d.Z)().mark((function e(t){var i,n,r,s,a=arguments;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=a.length>1&&void 0!==a[1]?a[1]:0,n=a.length>2&&void 0!==a[2]?a[2]:0,r=t.getInternalTexture()){e.next=5;break}return e.abrupt("return",null);case 5:return e.next=7,t.readPixels(i,n);case 7:return s=e.sent,e.abrupt("return",s?rr(s,t.getSize(),r.invertY):null);case 9:case"end":return e.stop()}}),e)}))),sr.apply(this,arguments)}nr.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,Nt([Xt()],nr.prototype,"uniqueId",void 0),Nt([Xt()],nr.prototype,"name",void 0),Nt([Xt()],nr.prototype,"metadata",void 0),Nt([Xt("hasAlpha")],nr.prototype,"_hasAlpha",void 0),Nt([Xt("getAlphaFromRGB")],nr.prototype,"_getAlphaFromRGB",void 0),Nt([Xt()],nr.prototype,"level",void 0),Nt([Xt("coordinatesIndex")],nr.prototype,"_coordinatesIndex",void 0),Nt([Xt()],nr.prototype,"optimizeUVAllocation",void 0),Nt([Xt("coordinatesMode")],nr.prototype,"_coordinatesMode",void 0),Nt([Xt()],nr.prototype,"wrapU",null),Nt([Xt()],nr.prototype,"wrapV",null),Nt([Xt()],nr.prototype,"wrapR",void 0),Nt([Xt()],nr.prototype,"anisotropicFilteringLevel",void 0),Nt([Xt()],nr.prototype,"isCube",null),Nt([Xt()],nr.prototype,"is3D",null),Nt([Xt()],nr.prototype,"is2DArray",null),Nt([Xt()],nr.prototype,"gammaSpace",null),Nt([Xt()],nr.prototype,"invertZ",void 0),Nt([Xt()],nr.prototype,"lodLevelInAlpha",void 0),Nt([Xt()],nr.prototype,"lodGenerationOffset",null),Nt([Xt()],nr.prototype,"lodGenerationScale",null),Nt([Xt()],nr.prototype,"linearSpecularLOD",null),Nt([Ht()],nr.prototype,"irradianceTexture",null),Nt([Xt()],nr.prototype,"isRenderTarget",void 0);var ar=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r,s){var a,o,h,c,d,f,_,v,g,p,y,T=arguments.length>4&&void 0!==arguments[4]?arguments[4]:i.TRILINEAR_SAMPLINGMODE,E=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,S=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,b=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,x=arguments.length>8&&void 0!==arguments[8]&&arguments[8],M=arguments.length>9?arguments[9]:void 0,A=arguments.length>10?arguments[10]:void 0,R=arguments.length>11?arguments[11]:void 0,C=arguments.length>12?arguments[12]:void 0,I=arguments.length>13?arguments[13]:void 0;(0,m.Z)(this,i),(o=t.call(this,n)).url=null,o.uOffset=0,o.vOffset=0,o.uScale=1,o.vScale=1,o.uAng=0,o.vAng=0,o.wAng=0,o.uRotationCenter=.5,o.vRotationCenter=.5,o.wRotationCenter=.5,o.homogeneousRotationInUVTransform=!1,o.inspectableCustomProperties=null,o._noMipmap=!1,o._invertY=!1,o._rowGenerationMatrix=null,o._cachedTextureMatrix=null,o._projectionModeMatrix=null,o._t0=null,o._t1=null,o._t2=null,o._cachedUOffset=-1,o._cachedVOffset=-1,o._cachedUScale=0,o._cachedVScale=0,o._cachedUAng=-1,o._cachedVAng=-1,o._cachedWAng=-1,o._cachedReflectionProjectionMatrixId=-1,o._cachedURotationCenter=-1,o._cachedVRotationCenter=-1,o._cachedWRotationCenter=-1,o._cachedHomogeneousRotationInUVTransform=!1,o._cachedReflectionTextureMatrix=null,o._cachedReflectionUOffset=-1,o._cachedReflectionVOffset=-1,o._cachedReflectionUScale=0,o._cachedReflectionVScale=0,o._cachedReflectionCoordinatesMode=-1,o._buffer=null,o._deleteBuffer=!1,o._format=null,o._delayedOnLoad=null,o._delayedOnError=null,o.onLoadObservable=new ee,o._isBlocking=!0,o.name=e||"",o.url=e;var P,k=!1,D=null;"object"==typeof r&&null!==r?(P=null!==(h=r.noMipmap)&&void 0!==h&&h,s=null!==(c=r.invertY)&&void 0!==c?c:!cn.UseOpenGLOrientationForUV,T=null!==(d=r.samplingMode)&&void 0!==d?d:i.TRILINEAR_SAMPLINGMODE,E=null!==(f=r.onLoad)&&void 0!==f?f:null,S=null!==(_=r.onError)&&void 0!==_?_:null,b=null!==(v=r.buffer)&&void 0!==v?v:null,x=null!==(g=r.deleteBuffer)&&void 0!==g&&g,M=r.format,A=r.mimeType,R=r.loaderOptions,C=r.creationFlags,k=null!==(p=r.useSRGBBuffer)&&void 0!==p&&p,D=null!==(y=r.internalTexture)&&void 0!==y?y:null):P=!!r,o._noMipmap=P,o._invertY=void 0===s?!cn.UseOpenGLOrientationForUV:s,o._initialSamplingMode=T,o._buffer=b,o._deleteBuffer=x,o._mimeType=A,o._loaderOptions=R,o._creationFlags=C,o._useSRGBBuffer=k,o._forcedExtension=I,M&&(o._format=M);var F=o.getScene(),w=o._getEngine();if(!w)return(0,l.Z)(o);w.onBeforeTextureInitObservable.notifyObservers((0,u.Z)(o));var O=function(){o._texture&&(o._texture._invertVScale&&(o.vScale*=-1,o.vOffset+=1),null!==o._texture._cachedWrapU&&(o.wrapU=o._texture._cachedWrapU,o._texture._cachedWrapU=null),null!==o._texture._cachedWrapV&&(o.wrapV=o._texture._cachedWrapV,o._texture._cachedWrapV=null),null!==o._texture._cachedWrapR&&(o.wrapR=o._texture._cachedWrapR,o._texture._cachedWrapR=null)),o.onLoadObservable.hasObservers()&&o.onLoadObservable.notifyObservers((0,u.Z)(o)),E&&E(),!o.isBlocking&&F&&F.resetCachedMaterial()},L=function(e,t){o._loadingError=!0,o._errorObject={message:e,exception:t},S&&S(e,t),i.OnTextureLoadErrorObservable.notifyObservers((0,u.Z)(o))};if(!o.url&&!D)return o._delayedOnLoad=O,o._delayedOnError=L,(0,l.Z)(o);if(o._texture=null!==(a=D)&&void 0!==a?a:o._getFromCache(o.url,P,T,o._invertY,k),o._texture)if(o._texture.isReady)ut.SetImmediate((function(){return O()}));else{var N=o._texture.onLoadedObservable.add(O);o._texture.onErrorObservable.add((function(e){var t;L(e.message,e.exception),null===(t=o._texture)||void 0===t||t.onLoadedObservable.remove(N)}))}else if(F&&F.useDelayedTextureLoading)o.delayLoadState=4,o._delayedOnLoad=O,o._delayedOnError=L;else{try{o._texture=w.createTexture(o.url,P,o._invertY,F,T,O,L,o._buffer,void 0,o._format,o._forcedExtension,A,R,C,k)}catch(N){throw L("error loading",N),N}x&&(o._buffer=null)}return o}return(0,y.Z)(i,[{key:"noMipmap",get:function(){return this._noMipmap}},{key:"mimeType",get:function(){return this._mimeType}},{key:"isBlocking",get:function(){return this._isBlocking},set:function(e){this._isBlocking=e}},{key:"invertY",get:function(){return this._invertY}},{key:"updateURL",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=n,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}},{key:"delayLoad",value:function(){if(4===this.delayLoadState){var e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer),this._texture?this._delayedOnLoad&&(this._texture.isReady?ut.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}}},{key:"_prepareRowForTextureGeneration",value:function(e,t,i,n){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,z.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,n),n.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,n.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,n.z+=this.wRotationCenter}},{key:"checkTransformsAreIdentical",value:function(e){return null!==e&&this.uOffset===e.uOffset&&this.vOffset===e.vOffset&&this.uScale===e.uScale&&this.vScale===e.vScale&&this.uAng===e.uAng&&this.vAng===e.vAng&&this.wAng===e.wAng}},{key:"getTextureMatrix",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*t===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*t,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=Z.Zero(),this._rowGenerationMatrix=new Z,this._t0=z.Zero(),this._t1=z.Zero(),this._t2=z.Zero()),Z.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(Z.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,Y.Matrix[0]),Z.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,Y.Matrix[1]),Z.ScalingToRef(this._cachedUScale,this._cachedVScale,0,Y.Matrix[2]),Z.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,Y.Matrix[3]),Y.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(Y.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(Y.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(Y.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),Z.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));var i=this.getScene();return i?(this.optimizeUVAllocation&&i.markAllMaterialsAsDirty(1,(function(t){return t.hasTexture(e)})),this._cachedTextureMatrix):this._cachedTextureMatrix}},{key:"getReflectionTextureMatrix",value:function(){var e=this,t=this.getScene();if(!t)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode){if(this.coordinatesMode!==i.PROJECTION_MODE)return this._cachedReflectionTextureMatrix;if(this._cachedReflectionProjectionMatrixId===t.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=Z.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=Z.Zero());var n=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case i.PLANAR_MODE:Z.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break;case i.PROJECTION_MODE:Z.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);var r=t.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=r.updateFlag,r.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break;default:Z.IdentityToRef(this._cachedReflectionTextureMatrix)}return n&&t.markAllMaterialsAsDirty(1,(function(t){return-1!==t.getActiveTextures().indexOf(e)})),this._cachedReflectionTextureMatrix}},{key:"clone",value:function(){var e=this,t={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return jt.Clone((function(){return new i(e._texture?e._texture.url:null,e.getScene(),t)}),this)}},{key:"serialize",value:function(){var e,t,n=this.name;i.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");var r=c((0,h.Z)(i.prototype),"serialize",this).call(this,i._SerializeInternalTextureUniqueId);return r?((i.SerializeBuffers||i.ForceSerializeBuffers)&&("string"==typeof this._buffer&&"data:"===this._buffer.substr(0,5)?(r.base64String=this._buffer,r.name=r.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?r.base64String="data:image/png;base64,"+ot(this._buffer):(i.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(r.base64String=!this._engine||this._engine._features.supportSyncTextureRead?function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=e.getInternalTexture();if(!n)return null;var r=e._readPixelsSync(t,i);return r?rr(r,e.getSize(),n.invertY):null}(this):function(e){return sr.apply(this,arguments)}(this))),r.invertY=this._invertY,r.samplingMode=this.samplingMode,r._creationFlags=this._creationFlags,r._useSRGBBuffer=this._useSRGBBuffer,i._SerializeInternalTextureUniqueId&&(r.internalTextureUniqueId=null!==(t=null===(e=this._texture)||void 0===e?void 0:e.uniqueId)&&void 0!==t?t:void 0),this.name=n,r):null}},{key:"getClassName",value:function(){return"Texture"}},{key:"dispose",value:function(){c((0,h.Z)(i.prototype),"dispose",this).call(this),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}}],[{key:"Parse",value:function(e,t,n){if(e.customType){var r=Rt.Instantiate(e.customType).Parse(e,t,n);return e.samplingMode&&r.updateSamplingMode&&r._samplingMode&&r._samplingMode!==e.samplingMode&&r.updateSamplingMode(e.samplingMode),r}if(e.isCube&&!e.isRenderTarget)return i._CubeTextureParser(e,t,n);var s,a=void 0!==e.internalTextureUniqueId;if(!e.name&&!e.isRenderTarget&&!a)return null;if(a){var o,l=t.getEngine().getLoadedTexturesCache(),u=(0,p.Z)(l);try{for(u.s();!(o=u.n()).done;){var h=o.value;if(h.uniqueId===e.internalTextureUniqueId){s=h;break}}}catch(d){u.e(d)}finally{u.f()}}var c=function(t){var i;if(t&&t._texture&&(t._texture._cachedWrapU=null,t._texture._cachedWrapV=null,t._texture._cachedWrapR=null),e.samplingMode){var n=e.samplingMode;t&&t.samplingMode!==n&&t.updateSamplingMode(n)}if(t&&e.animations)for(var r=0;r<e.animations.length;r++){var o=e.animations[r],l=B("BABYLON.Animation");l&&t.animations.push(l.Parse(o))}a&&!s&&(null===(i=null==t?void 0:t._texture)||void 0===i||i._setUniqueId(e.internalTextureUniqueId))};return jt.Parse((function(){var r,a,o,l,u=!0;if(e.noMipmap&&(u=!1),e.mirrorPlane){var h=i._CreateMirror(e.name,e.renderTargetSize,t,u);return h._waitingRenderList=e.renderList,h.mirrorPlane=Bi.FromArray(e.mirrorPlane),c(h),h}if(e.isRenderTarget){var d=null;if(e.isCube){if(t.reflectionProbes)for(var f=0;f<t.reflectionProbes.length;f++){var _=t.reflectionProbes[f];if(_.name===e.name)return _.cubeTexture}}else(d=i._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,u,null!==(r=e._creationFlags)&&void 0!==r?r:0))._waitingRenderList=e.renderList;return c(d),d}if(e.base64String&&!s)(l=i.CreateFromBase64String(e.base64String,e.base64String,t,!u,e.invertY,e.samplingMode,(function(){c(l)}),null!==(a=e._creationFlags)&&void 0!==a?a:0,null!==(o=e._useSRGBBuffer)&&void 0!==o&&o)).name=e.name;else{var v;v=e.name&&e.name.indexOf("://")>0?e.name:n+e.name,e.url&&(e.url.startsWith("data:")||i.UseSerializedUrlIfAny)&&(v=e.url);var g={noMipmap:!u,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:function(){c(l)},internalTexture:s};l=new i(v,t,g)}return l}),e,t)}},{key:"CreateFromBase64String",value:function(e,t,n,r,s){return new i("data:"+t,n,r,s,arguments.length>5&&void 0!==arguments[5]?arguments[5]:i.TRILINEAR_SAMPLINGMODE,arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,e,!1,arguments.length>8&&void 0!==arguments[8]?arguments[8]:5,void 0,void 0,arguments.length>9?arguments[9]:void 0)}},{key:"LoadFromDataString",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4?arguments[4]:void 0,a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:i.TRILINEAR_SAMPLINGMODE,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:5,c=arguments.length>10?arguments[10]:void 0;return"data:"!==e.substr(0,5)&&(e="data:"+e),new i(e,n,s,a,o,l,u,t,r,h,void 0,void 0,c)}}]),i}(nr);ar.SerializeBuffers=!0,ar.ForceSerializeBuffers=!1,ar.OnTextureLoadErrorObservable=new ee,ar._SerializeInternalTextureUniqueId=!1,ar._CubeTextureParser=function(e,t,i){throw le("CubeTexture")},ar._CreateMirror=function(e,t,i,n){throw le("MirrorTexture")},ar._CreateRenderTargetTexture=function(e,t,i,n,r){throw le("RenderTargetTexture")},ar.NEAREST_SAMPLINGMODE=1,ar.NEAREST_NEAREST_MIPLINEAR=8,ar.BILINEAR_SAMPLINGMODE=2,ar.LINEAR_LINEAR_MIPNEAREST=11,ar.TRILINEAR_SAMPLINGMODE=3,ar.LINEAR_LINEAR_MIPLINEAR=3,ar.NEAREST_NEAREST_MIPNEAREST=4,ar.NEAREST_LINEAR_MIPNEAREST=5,ar.NEAREST_LINEAR_MIPLINEAR=6,ar.NEAREST_LINEAR=7,ar.NEAREST_NEAREST=1,ar.LINEAR_NEAREST_MIPNEAREST=9,ar.LINEAR_NEAREST_MIPLINEAR=10,ar.LINEAR_LINEAR=2,ar.LINEAR_NEAREST=12,ar.EXPLICIT_MODE=0,ar.SPHERICAL_MODE=1,ar.PLANAR_MODE=2,ar.CUBIC_MODE=3,ar.PROJECTION_MODE=4,ar.SKYBOX_MODE=5,ar.INVCUBIC_MODE=6,ar.EQUIRECTANGULAR_MODE=7,ar.FIXED_EQUIRECTANGULAR_MODE=8,ar.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,ar.CLAMP_ADDRESSMODE=0,ar.WRAP_ADDRESSMODE=1,ar.MIRROR_ADDRESSMODE=2,ar.UseSerializedUrlIfAny=!1,Nt([Xt()],ar.prototype,"url",void 0),Nt([Xt()],ar.prototype,"uOffset",void 0),Nt([Xt()],ar.prototype,"vOffset",void 0),Nt([Xt()],ar.prototype,"uScale",void 0),Nt([Xt()],ar.prototype,"vScale",void 0),Nt([Xt()],ar.prototype,"uAng",void 0),Nt([Xt()],ar.prototype,"vAng",void 0),Nt([Xt()],ar.prototype,"wAng",void 0),Nt([Xt()],ar.prototype,"uRotationCenter",void 0),Nt([Xt()],ar.prototype,"vRotationCenter",void 0),Nt([Xt()],ar.prototype,"wRotationCenter",void 0),Nt([Xt()],ar.prototype,"homogeneousRotationInUVTransform",void 0),Nt([Xt()],ar.prototype,"isBlocking",null),N("BABYLON.Texture",ar),jt._TextureParser=ar.Parse;var or=function(){function e(t,i,n,r){(0,m.Z)(this,e),this._textures=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=t,this._isCube=i,this._size=n,this._engine=r,this._depthStencilTexture=null}return(0,y.Z)(e,[{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"depthStencilTextureWithStencil",get:function(){return this._depthStencilTextureWithStencil}},{key:"isCube",get:function(){return this._isCube}},{key:"isMulti",get:function(){return this._isMulti}},{key:"is2DArray",get:function(){return this.layers>0}},{key:"size",get:function(){return this.width}},{key:"width",get:function(){return this._size.width||this._size}},{key:"height",get:function(){return this._size.height||this._size}},{key:"layers",get:function(){return this._size.layers||0}},{key:"texture",get:function(){var e,t;return null!==(t=null===(e=this._textures)||void 0===e?void 0:e[0])&&void 0!==t?t:null}},{key:"textures",get:function(){return this._textures}},{key:"samples",get:function(){return this._samples}},{key:"setSamples",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.samples===e&&!i)return e;var n=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,n}},{key:"setTextures",value:function(e){Array.isArray(e)?this._textures=e:this._textures=e?[e]:null}},{key:"setTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._textures||(this._textures=[]),this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e}},{key:"createDepthStencilTexture",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14;return null===(e=this._depthStencilTexture)||void 0===e||e.dispose(),this._depthStencilTextureWithStencil=n,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:i,comparisonFunction:t,generateStencil:n,isCube:this._isCube,samples:r,depthTextureFormat:s},this),this._depthStencilTexture}},{key:"_shareDepth",value:function(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())}},{key:"_swapAndDie",value:function(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}},{key:"_cloneRenderTargetWrapper",value:function(){var e,t,i,n,r,s,a=null;if(this._isMulti){var o=this.textures;if(o&&o.length>0){var l=!1,u=o.length,h=o[o.length-1]._source;(h===q.Depth||h===q.DepthStencil)&&(l=!0,u--);for(var c=[],d=[],f=0;f<u;++f){var _=o[f];c.push(_.samplingMode),d.push(_.type)}var v={samplingModes:c,generateMipMaps:o[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:l,types:d,textureCount:u},g={width:this.width,height:this.height};a=this._engine.createMultipleRenderTarget(g,v)}}else{var p={};if(p.generateDepthBuffer=this._generateDepthBuffer,p.generateMipMaps=null!==(t=null===(e=this.texture)||void 0===e?void 0:e.generateMipMaps)&&void 0!==t&&t,p.generateStencilBuffer=this._generateStencilBuffer,p.samplingMode=null===(i=this.texture)||void 0===i?void 0:i.samplingMode,p.type=null===(n=this.texture)||void 0===n?void 0:n.type,p.format=null===(r=this.texture)||void 0===r?void 0:r.format,this.isCube)a=this._engine.createRenderTargetCubeTexture(this.width,p);else{var m={width:this.width,height:this.height,layers:this.is2DArray?null===(s=this.texture)||void 0===s?void 0:s.depth:void 0};a=this._engine.createRenderTargetTexture(m,p)}a.texture.isReady=!0}return a}},{key:"_swapRenderTargetWrapper",value:function(e){if(this._textures&&e._textures)for(var t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}},{key:"_rebuild",value:function(){var e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){var t=this._depthStencilTexture.samplingMode,i=2===t||3===t||11===t;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,i,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}},{key:"releaseTextures",value:function(){var e,t;if(this._textures)for(var i=0;null!==(t=i<(null===(e=this._textures)||void 0===e?void 0:e.length))&&void 0!==t&&t;++i)this._textures[i].dispose();this._textures=null}},{key:"dispose",value:function(){var e;arguments.length>0&&void 0!==arguments[0]&&arguments[0]||(null===(e=this._depthStencilTexture)||void 0===e||e.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}]),e}(),lr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r,s,a){var o;return(0,m.Z)(this,i),(o=t.call(this,e,n,r,s))._framebuffer=null,o._depthStencilBuffer=null,o._MSAAFramebuffer=null,o._colorTextureArray=null,o._depthStencilTextureArray=null,o._context=a,o}return(0,y.Z)(i,[{key:"_cloneRenderTargetWrapper",value:function(){var e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height)).texture.isReady=!0:e=c((0,h.Z)(i.prototype),"_cloneRenderTargetWrapper",this).call(this),e}},{key:"_swapRenderTargetWrapper",value:function(e){c((0,h.Z)(i.prototype),"_swapRenderTargetWrapper",this).call(this,e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}},{key:"_shareDepth",value:function(e){c((0,h.Z)(i.prototype),"_shareDepth",this).call(this,e);var t=this._context,n=this._depthStencilBuffer,r=e._MSAAFramebuffer||e._framebuffer;e._depthStencilBuffer&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=this._depthStencilBuffer,this._engine._bindUnboundFramebuffer(r),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,n),this._engine._bindUnboundFramebuffer(null)}},{key:"_bindTextureRenderTarget",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(e._hardwareTexture){var r=this._context,s=this._framebuffer,a=this._engine._currentFramebuffer;this._engine._bindUnboundFramebuffer(s);var o=r[this._engine.webGLVersion>1?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"],l=-1!==i?r.TEXTURE_CUBE_MAP_POSITIVE_X+i:r.TEXTURE_2D;r.framebufferTexture2D(r.FRAMEBUFFER,o,l,e._hardwareTexture.underlyingResource,n),this._engine._bindUnboundFramebuffer(a)}}},{key:"setTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];c((0,h.Z)(i.prototype),"setTexture",this).call(this,e,t,n),this._bindTextureRenderTarget(e,t)}},{key:"dispose",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),c((0,h.Z)(i.prototype),"dispose",this).call(this,e)}}]),i}(or);Ve.prototype._createHardwareRenderTargetWrapper=function(e,t,i){var n=new lr(e,t,i,this,this._gl);return this._renderTargetWrapperCache.push(n),n},Ve.prototype.createRenderTargetTexture=function(e,t){var i,n,r,s=this._createHardwareRenderTargetWrapper(!1,!1,e),a=!0,o=!1,l=!1,u=1;void 0!==t&&"object"==typeof t&&(a=null===(i=t.generateDepthBuffer)||void 0===i||i,o=!!t.generateStencilBuffer,l=!!t.noColorAttachment,r=t.colorAttachment,u=null!==(n=t.samples)&&void 0!==n?n:1);var h=r||(l?null:this._createInternalTexture(e,t,!0,q.RenderTarget)),c=e.width||e,d=e.height||e,f=this._currentFramebuffer,_=this._gl,v=_.createFramebuffer();return this._bindUnboundFramebuffer(v),s._depthStencilBuffer=this._setupFramebufferDepthAttachments(o,a,c,d),h&&!h.is2DArray&&_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,h._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(f),s._framebuffer=v,s._generateDepthBuffer=a,s._generateStencilBuffer=o,s.setTextures(h),this.updateRenderTargetTextureSampleCount(s,u),s},Ve.prototype.createDepthStencilTexture=function(e,t,i){if(t.isCube){var n=e.width||e;return this._createDepthStencilCubeTexture(n,t,i)}return this._createDepthStencilTexture(e,t,i)},Ve.prototype._createDepthStencilTexture=function(e,t,i){var n=this._gl,r=e.layers||0,s=0!==r?n.TEXTURE_2D_ARRAY:n.TEXTURE_2D,o=new ie(this,q.DepthStencil);if(!this._caps.depthTextureExtension)return ue.Error("Depth texture is not supported by your browser or hardware."),o;var l=(0,a.Z)({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},t);if(this._bindTextureDirectly(s,o,!0),this._setupDepthStencilTexture(o,e,l.generateStencil,0!==l.comparisonFunction&&l.bilinearFiltering,l.comparisonFunction,l.samples),void 0!==l.depthTextureFormat){if(15!==l.depthTextureFormat&&16!==l.depthTextureFormat&&17!==l.depthTextureFormat&&13!==l.depthTextureFormat&&14!==l.depthTextureFormat&&18!==l.depthTextureFormat)return ue.Error("Depth texture format is not supported."),o;o.format=l.depthTextureFormat}else o.format=l.generateStencil?13:16;var u=17===o.format||13===o.format||18===o.format;i._depthStencilTexture=o,i._depthStencilTextureWithStencil=u;var h=n.UNSIGNED_INT;15===o.format?h=n.UNSIGNED_SHORT:17===o.format||13===o.format?h=n.UNSIGNED_INT_24_8:14===o.format?h=n.FLOAT:18===o.format&&(h=n.FLOAT_32_UNSIGNED_INT_24_8_REV);var c=u?n.DEPTH_STENCIL:n.DEPTH_COMPONENT,d=c;this.webGLVersion>1&&(15===o.format?d=n.DEPTH_COMPONENT16:16===o.format?d=n.DEPTH_COMPONENT24:17===o.format||13===o.format?d=n.DEPTH24_STENCIL8:14===o.format?d=n.DEPTH_COMPONENT32F:18===o.format&&(d=n.DEPTH32F_STENCIL8)),o.is2DArray?n.texImage3D(s,0,d,o.width,o.height,r,0,c,h,null):n.texImage2D(s,0,d,o.width,o.height,0,c,h,null),this._bindTextureDirectly(s,null),this._internalTexturesCache.push(o);var f=i;if(f._depthStencilBuffer){var _=this._currentFramebuffer;this._bindUnboundFramebuffer(f._framebuffer),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,null),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,null),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.STENCIL_ATTACHMENT,n.RENDERBUFFER,null),this._bindUnboundFramebuffer(_),n.deleteRenderbuffer(f._depthStencilBuffer),f._depthStencilBuffer=null}return o},Ve.prototype.updateRenderTargetTextureSampleCount=function(e,t){if(this.webGLVersion<2||!e||!e.texture)return 1;if(e.samples===t)return t;var i=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(i.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(i.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);var n=e.texture._hardwareTexture;if(n._MSAARenderBuffer&&(i.deleteRenderbuffer(n._MSAARenderBuffer),n._MSAARenderBuffer=null),t>1&&i.renderbufferStorageMultisample){var r=i.createFramebuffer();if(!r)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=r,this._bindUnboundFramebuffer(e._MSAAFramebuffer);var s=this._createRenderBuffer(e.texture.width,e.texture.height,t,-1,this._getRGBAMultiSampleBufferFormat(e.texture.type),i.COLOR_ATTACHMENT0,!1);if(!s)throw new Error("Unable to create multi sampled framebuffer");n._MSAARenderBuffer=s}else this._bindUnboundFramebuffer(e._framebuffer);return e.texture.samples=t,e._samples=t,e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.texture.width,e.texture.height,t),this._bindUnboundFramebuffer(null),t},Ve.prototype.createRenderTargetCubeTexture=function(e,t){var i=this._createHardwareRenderTargetWrapper(!1,!0,e),n=(0,a.Z)({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},t);n.generateStencilBuffer=n.generateDepthBuffer&&n.generateStencilBuffer,(1===n.type&&!this._caps.textureFloatLinearFiltering||2===n.type&&!this._caps.textureHalfFloatLinearFiltering)&&(n.samplingMode=1);var r=this._gl,s=new ie(this,q.RenderTarget);this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,s,!0);var o=this._getSamplingParameters(n.samplingMode,n.generateMipMaps);1===n.type&&!this._caps.textureFloat&&(n.type=0,ue.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,o.mag),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,o.min),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);for(var l=0;l<6;l++)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(n.type,n.format),e,e,0,this._getInternalFormat(n.format),this._getWebGLTextureType(n.type),null);var u=r.createFramebuffer();return this._bindUnboundFramebuffer(u),i._depthStencilBuffer=this._setupFramebufferDepthAttachments(n.generateStencilBuffer,n.generateDepthBuffer,e,e),n.generateMipMaps&&r.generateMipmap(r.TEXTURE_CUBE_MAP),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),i._framebuffer=u,i._generateDepthBuffer=n.generateDepthBuffer,i._generateStencilBuffer=n.generateStencilBuffer,s.width=e,s.height=e,s.isReady=!0,s.isCube=!0,s.samples=1,s.generateMipMaps=n.generateMipMaps,s.samplingMode=n.samplingMode,s.type=n.type,s.format=n.format,this._internalTexturesCache.push(s),i.setTextures(s),i};xe.ShadersStore.postprocessVertexShader="attribute vec2 position;\nuniform vec2 scale;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";var ur={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]},hr=function(){function e(t){var i,n,s=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ur;(0,m.Z)(this,e),this._fullscreenViewport=new qi(0,0,1,1);var o=null!==(i=a.positions)&&void 0!==i?i:ur.positions,l=null!==(n=a.indices)&&void 0!==n?n:ur.indices;this.engine=t,this._vertexBuffers=(0,r.Z)({},ni.PositionKind,new ni(t,o,ni.PositionKind,!1,!1,2)),this._indexBuffer=t.createIndexBuffer(l),this._onContextRestoredObserver=t.onContextRestoredObservable.add((function(){for(var e in s._indexBuffer=t.createIndexBuffer(l),s._vertexBuffers)s._vertexBuffers[e]._rebuild()}))}return(0,y.Z)(e,[{key:"setViewport",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._fullscreenViewport;this.engine.setViewport(e)}},{key:"bindBuffers",value:function(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}},{key:"applyEffectWrapper",value:function(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}},{key:"restoreStates",value:function(){this.engine.depthCullingState.depthTest=!0,this.engine.stencilState.stencilTest=!0}},{key:"draw",value:function(){this.engine.drawElementsType(0,0,6)}},{key:"_isRenderTargetTexture",value:function(e){return void 0!==e.renderTarget}},{key:"render",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(e.effect.isReady()){this.setViewport();var i=null===t?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}}},{key:"dispose",value:function(){var e=this._vertexBuffers[ni.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[ni.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}]),e}(),cr=function(){function e(t){var i,n=this;(0,m.Z)(this,e),this.onApplyObservable=new ee;var r=t.uniformNames||[];t.vertexShader?i={fragmentSource:t.fragmentShader,vertexSource:t.vertexShader,spectorName:t.name||"effectWrapper"}:(r.push("scale"),i={fragmentSource:t.fragmentShader,vertex:"postprocess",spectorName:t.name||"effectWrapper"},this.onApplyObservable.add((function(){n.effect.setFloat2("scale",1,1)})));var s=t.defines?t.defines.join("\n"):"";this._drawWrapper=new Le(t.engine),t.useShaderStore?(i.fragment=i.fragmentSource,i.vertex||(i.vertex=i.vertexSource),delete i.fragmentSource,delete i.vertexSource,this.effect=t.engine.createEffect(i,t.attributeNames||["position"],r,t.samplerNames,s,void 0,t.onCompiled,void 0,void 0,t.shaderLanguage)):(this.effect=new Me(i,t.attributeNames||["position"],r,t.samplerNames,t.engine,s,void 0,t.onCompiled,void 0,void 0,void 0,t.shaderLanguage),this._onContextRestoredObserver=t.engine.onContextRestoredObservable.add((function(){n.effect._pipelineContext=null,n.effect._wasPreviouslyReady=!1,n.effect._prepareEffect()})))}return(0,y.Z)(e,[{key:"effect",get:function(){return this._drawWrapper.effect},set:function(e){this._drawWrapper.effect=e}},{key:"dispose",value:function(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}}]),e}(),dr="passPixelShader",fr="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\n}";xe.ShadersStore[dr]=fr;var _r=dr,vr=fr,gr=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"_CreateDumpRenderer",value:function(){if(!e._DumpToolsEngine){var t=document.createElement("canvas"),i=new Ve(t,!1,{preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1});i.getCaps().parallelShaderCompile=void 0;var n=new hr(i),r=new cr({engine:i,name:_r,fragmentShader:vr,samplerNames:["textureSampler"]});e._DumpToolsEngine={canvas:t,engine:i,renderer:n,wrapper:r}}return e._DumpToolsEngine}},{key:"DumpFramebuffer",value:function(){var t=(0,f.Z)((0,d.Z)().mark((function t(i,n,r,s){var a,o,l,u,h=arguments;return(0,d.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=h.length>4&&void 0!==h[4]?h[4]:"image/png",o=h.length>5?h[5]:void 0,t.next=4,r.readPixels(0,0,i,n);case 4:l=t.sent,u=new Uint8Array(l.buffer),e.DumpData(i,n,u,s,a,o,!0);case 7:case"end":return t.stop()}}),t)})));return function(e,i,n,r){return t.apply(this,arguments)}}()},{key:"DumpDataAsync",value:function(t,i,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"image/png",s=arguments.length>4?arguments[4]:void 0,a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=arguments.length>7?arguments[7]:void 0;return new Promise((function(u){e.DumpData(t,i,n,(function(e){return u(e)}),r,s,a,o,l)}))}},{key:"DumpData",value:function(t,i,n,r){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"image/png",a=arguments.length>5?arguments[5]:void 0,o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=arguments.length>7&&void 0!==arguments[7]&&arguments[7],u=arguments.length>8?arguments[8]:void 0,h=e._CreateDumpRenderer();if(h.engine.setSize(t,i,!0),n instanceof Float32Array){for(var c=new Uint8Array(n.length),d=n.length;d--;){var f=n[d];c[d]=f<0?0:f>1?1:Math.round(255*f)}n=c}var _=h.engine.createRawTexture(n,t,i,5,!1,!o,1);h.renderer.setViewport(),h.renderer.applyEffectWrapper(h.wrapper),h.wrapper.effect._bindTexture("textureSampler",_),h.renderer.draw(),l?It.ToBlob(h.canvas,(function(e){var t=new FileReader;t.onload=function(e){var t=e.target.result;r&&r(t)},t.readAsArrayBuffer(e)}),s,u):It.EncodeScreenshotCanvasData(h.canvas,r,s,a,u),_.dispose()}},{key:"Dispose",value:function(){e._DumpToolsEngine&&(e._DumpToolsEngine.wrapper.dispose(),e._DumpToolsEngine.renderer.dispose(),e._DumpToolsEngine.engine.dispose()),e._DumpToolsEngine=null}}]),e}();It.DumpData=gr.DumpData,It.DumpDataAsync=gr.DumpDataAsync,It.DumpFramebuffer=gr.DumpFramebuffer;var pr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r){var s,a,o,u,h,c,d,f,_=arguments.length>3&&void 0!==arguments[3]&&arguments[3],v=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],g=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,p=arguments.length>6&&void 0!==arguments[6]&&arguments[6],y=arguments.length>7&&void 0!==arguments[7]?arguments[7]:ar.TRILINEAR_SAMPLINGMODE,T=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],E=arguments.length>9&&void 0!==arguments[9]&&arguments[9],S=arguments.length>10&&void 0!==arguments[10]&&arguments[10],b=arguments.length>11&&void 0!==arguments[11]?arguments[11]:5,x=arguments.length>12&&void 0!==arguments[12]&&arguments[12],M=arguments.length>13?arguments[13]:void 0,A=arguments.length>14?arguments[14]:void 0,R=arguments.length>15&&void 0!==arguments[15]&&arguments[15],C=arguments.length>16&&void 0!==arguments[16]&&arguments[16];if((0,m.Z)(this,i),"object"==typeof _){var I=_;_=!!I.generateMipMaps,v=null===(a=I.doNotChangeAspectRatio)||void 0===a||a,g=null!==(o=I.type)&&void 0!==o?o:0,p=!!I.isCube,y=null!==(u=I.samplingMode)&&void 0!==u?u:ar.TRILINEAR_SAMPLINGMODE,T=null===(h=I.generateDepthBuffer)||void 0===h||h,E=!!I.generateStencilBuffer,S=!!I.isMulti,b=null!==(c=I.format)&&void 0!==c?c:5,x=!!I.delayAllocation,M=I.samples,A=I.creationFlags,R=!!I.noColorAttachment,C=!!I.useSRGBBuffer,f=I.colorAttachment}if((s=t.call(this,null,r,!_,void 0,y,void 0,void 0,void 0,void 0,b))._unObserveRenderList=null,s._renderListHasChanged=function(e,t){var i,n=s._renderList?s._renderList.length:0;(0===t&&n>0||0===n)&&(null===(i=s.getScene())||void 0===i||i.meshes.forEach((function(e){e._markSubMeshesAsLightDirty()})))},s.renderParticles=!0,s.renderSprites=!1,s.forceLayerMaskCheck=!1,s.ignoreCameraViewport=!1,s.onBeforeBindObservable=new ee,s.onAfterUnbindObservable=new ee,s.onBeforeRenderObservable=new ee,s.onAfterRenderObservable=new ee,s.onClearObservable=new ee,s.onResizeObservable=new ee,s._cleared=!1,s.skipInitialClear=!1,s._currentRefreshId=-1,s._refreshRate=1,s._samples=1,s._canRescale=!0,s._renderTarget=null,s.boundingBoxPosition=z.Zero(),!(r=s.getScene()))return(0,l.Z)(s);var P=s.getScene().getEngine();return s._coordinatesMode=ar.PROJECTION_MODE,s.renderList=new Array,s.name=e,s.isRenderTarget=!0,s._initialSizeParameter=n,s._renderPassIds=[],s._isCubeData=p,s._processSizeParameter(n),s.renderPassId=s._renderPassIds[0],s._resizeObserver=P.onResizeObservable.add((function(){})),s._generateMipMaps=!!_,s._doNotChangeAspectRatio=v,s._renderingManager=new ui(r),s._renderingManager._useSceneAutoClearSetup=!0,!S&&(s._renderTargetOptions={generateMipMaps:_,type:g,format:null!==(d=s._format)&&void 0!==d?d:void 0,samplingMode:s.samplingMode,generateDepthBuffer:T,generateStencilBuffer:E,samples:M,creationFlags:A,noColorAttachment:R,useSRGBBuffer:C,colorAttachment:f},s.samplingMode===ar.NEAREST_SAMPLINGMODE&&(s.wrapU=ar.CLAMP_ADDRESSMODE,s.wrapV=ar.CLAMP_ADDRESSMODE),x||(p?(s._renderTarget=r.getEngine().createRenderTargetCubeTexture(s.getRenderSize(),s._renderTargetOptions),s.coordinatesMode=ar.INVCUBIC_MODE,s._textureMatrix=Z.Identity()):s._renderTarget=r.getEngine().createRenderTargetTexture(s._size,s._renderTargetOptions),s._texture=s._renderTarget.texture,void 0!==M&&(s.samples=M))),(0,l.Z)(s)}return(0,y.Z)(i,[{key:"renderList",get:function(){return this._renderList},set:function(e){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=O(e,this._renderListHasChanged)),this._renderList=e}},{key:"postProcesses",get:function(){return this._postProcesses}},{key:"_prePassEnabled",get:function(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}},{key:"onAfterUnbind",set:function(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}},{key:"onBeforeRender",set:function(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}},{key:"onAfterRender",set:function(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}},{key:"onClear",set:function(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}},{key:"renderPassIds",get:function(){return this._renderPassIds}},{key:"currentRefreshId",get:function(){return this._currentRefreshId}},{key:"setMaterialForRendering",value:function(e,t){var i;i=Array.isArray(e)?e:[e];for(var n=0;n<i.length;++n)for(var r=0;r<this._renderPassIds.length;++r)i[n].setMaterialForRenderPass(this._renderPassIds[r],void 0!==t?Array.isArray(t)?t[r]:t:void 0)}},{key:"renderTargetOptions",get:function(){return this._renderTargetOptions}},{key:"renderTarget",get:function(){return this._renderTarget}},{key:"_onRatioRescale",value:function(){this._sizeRatio&&this.resize(this._initialSizeParameter)}},{key:"boundingBoxSize",get:function(){return this._boundingBoxSize},set:function(e){if(!this._boundingBoxSize||!this._boundingBoxSize.equals(e)){this._boundingBoxSize=e;var t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}}},{key:"depthStencilTexture",get:function(){var e,t;return null!==(t=null===(e=this._renderTarget)||void 0===e?void 0:e._depthStencilTexture)&&void 0!==t?t:null}},{key:"createDepthStencilTexture",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:14;null===(e=this._renderTarget)||void 0===e||e.createDepthStencilTexture(t,i,n,r,s)}},{key:"_releaseRenderPassId",value:function(){if(this._scene)for(var e=this._scene.getEngine(),t=0;t<this._renderPassIds.length;++t)e.releaseRenderPassId(this._renderPassIds[t]);this._renderPassIds=[]}},{key:"_createRenderPassId",value:function(){this._releaseRenderPassId();for(var e=this._scene.getEngine(),t=this._isCubeData?6:this.getRenderLayers()||1,i=0;i<t;++i)this._renderPassIds[i]=e.createRenderPassId("RenderTargetTexture - ".concat(this.name,"#").concat(i))}},{key:"_processSizeParameter",value:function(e){if(e.ratio){this._sizeRatio=e.ratio;var t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e;this._createRenderPassId()}},{key:"samples",get:function(){var e,t;return null!==(t=null===(e=this._renderTarget)||void 0===e?void 0:e.samples)&&void 0!==t?t:this._samples},set:function(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}},{key:"resetRefreshCounter",value:function(){this._currentRefreshId=-1}},{key:"refreshRate",get:function(){return this._refreshRate},set:function(e){this._refreshRate=e,this.resetRefreshCounter()}},{key:"addPostProcess",value:function(e){if(!this._postProcessManager){var t=this.getScene();if(!t)return;this._postProcessManager=new ai(t),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}},{key:"clearPostProcesses",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._postProcesses){if(e){var t,i=(0,p.Z)(this._postProcesses);try{for(i.s();!(t=i.n()).done;){t.value.dispose()}}catch(n){i.e(n)}finally{i.f()}}this._postProcesses=[]}}},{key:"removePostProcess",value:function(e){if(this._postProcesses){var t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}}},{key:"_shouldRender",value:function(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}},{key:"getRenderSize",value:function(){return this.getRenderWidth()}},{key:"getRenderWidth",value:function(){return this._size.width?this._size.width:this._size}},{key:"getRenderHeight",value:function(){return this._size.width?this._size.height:this._size}},{key:"getRenderLayers",value:function(){return this._size.layers||0}},{key:"disableRescaling",value:function(){this._canRescale=!1}},{key:"canRescale",get:function(){return this._canRescale}},{key:"scale",value:function(e){var t=Math.max(1,this.getRenderSize()*e);this.resize(t)}},{key:"getReflectionTextureMatrix",value:function(){return this.isCube?this._textureMatrix:c((0,h.Z)(i.prototype),"getReflectionTextureMatrix",this).call(this)}},{key:"resize",value:function(e){var t,i=this.isCube;null===(t=this._renderTarget)||void 0===t||t.dispose(),this._renderTarget=null;var n=this.getScene();n&&(this._processSizeParameter(e),this._renderTarget=i?n.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):n.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}},{key:"render",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._render(e,t)}},{key:"isReadyForRendering",value:function(){return this._render(!1,!1,!0)}},{key:"_render",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.getScene();if(!r)return n;var s=r.getEngine();if(void 0!==this.useCameraPostProcesses&&(t=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(var a=0;a<this._waitingRenderList.length;a++){var o=this._waitingRenderList[a],l=r.getMeshById(o);l&&this.renderList.push(l)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];var u=this.getScene();if(!u)return n;for(var h=u.meshes,c=0;c<h.length;c++){var d=h[c];this.renderListPredicate(d)&&this.renderList.push(d)}}var f=s.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);var _=null!==(e=this.activeCamera)&&void 0!==e?e:r.activeCamera,v=r.activeCamera;_&&(_!==r.activeCamera&&(r.setTransformMatrix(_.getViewMatrix(),_.getProjectionMatrix(!0)),r.activeCamera=_),s.setViewport(_.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;var g=n;if(n){r.getViewMatrix()||r.updateTransformMatrix();for(var p=this.is2DArray?this.getRenderLayers():this.isCube?6:1,m=0;m<p&&g;m++){var y=null,T=this.renderList?this.renderList:r.getActiveMeshes().data,E=this.renderList?this.renderList.length:r.getActiveMeshes().length;s.currentRenderPassId=this._renderPassIds[m],this.onBeforeRenderObservable.notifyObservers(m),this.getCustomRenderList&&(y=this.getCustomRenderList(m,T,E)),y||(y=T),this._doNotChangeAspectRatio||r.updateTransformMatrix(!0);for(var S=0;S<y.length&&g;++S){var b=y[S];if(b.isEnabled()&&!b.isBlocked&&b.isVisible&&b.subMeshes)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(b,this.refreshRate,n)){g=!1;continue}}else if(!b.isReady(!0)){g=!1;continue}}this.onAfterRenderObservable.notifyObservers(m),(this.is2DArray||this.isCube)&&(r.incrementRenderId(),r.resetCachedMaterial())}}else if(this.is2DArray)for(var x=0;x<this.getRenderLayers();x++)this._renderToTarget(0,t,i,x,_),r.incrementRenderId(),r.resetCachedMaterial();else if(this.isCube)for(var M=0;M<6;M++)this._renderToTarget(M,t,i,void 0,_),r.incrementRenderId(),r.resetCachedMaterial();else this._renderToTarget(0,t,i,void 0,_);return this.onAfterUnbindObservable.notifyObservers(this),s.currentRenderPassId=f,v&&(r.activeCamera=v,(r.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==r.activeCamera)&&r.setTransformMatrix(r.activeCamera.getViewMatrix(),r.activeCamera.getProjectionMatrix(!0)),s.setViewport(r.activeCamera.viewport)),r.resetCachedMaterial(),g}},{key:"_bestReflectionRenderTargetDimension",value:function(e,t){var i=e*t,n=Xe.NearestPOT(i+16384/(128+i));return Math.min(Xe.FloorPOT(e),n)}},{key:"_prepareRenderingManager",value:function(e,t,i,n){var r=this.getScene();if(r){this._renderingManager.reset();for(var s=r.getRenderId(),a=0;a<t;a++){var o=e[a];if(o&&!o.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(o,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!o.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}if(!o._internalAbstractMeshDataInfo._currentLODIsUpToDate&&r.activeCamera&&(o._internalAbstractMeshDataInfo._currentLOD=r.customLODSelector?r.customLODSelector(o,this.activeCamera||r.activeCamera):o.getLOD(this.activeCamera||r.activeCamera),o._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!o._internalAbstractMeshDataInfo._currentLOD)continue;var l=o._internalAbstractMeshDataInfo._currentLOD;l._preActivateForIntermediateRendering(s);var u=void 0;if(u=!(!n||!i)&&0===(o.layerMask&i.layerMask),o.isEnabled()&&o.isVisible&&o.subMeshes&&!u&&(l!==o&&l._activate(s,!0),o._activate(s,!0)&&o.subMeshes.length)){o.isAnInstance?o._internalAbstractMeshDataInfo._actAsRegularMesh&&(l=o):l._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,l._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(var h=0;h<l.subMeshes.length;h++){var c=l.subMeshes[h];this._renderingManager.dispatch(c,l)}}}}for(var d=0;d<r.particleSystems.length;d++){var f=r.particleSystems[d],_=f.emitter;!f.isStarted()||!_||!_.position||!_.isEnabled()||e.indexOf(_)>=0&&this._renderingManager.dispatchParticles(f)}}}},{key:"_bindFrameBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this.getScene();if(i){var n=i.getEngine();this._renderTarget&&n.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}}},{key:"_unbindFrameBuffer",value:function(e,t){var i=this;this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,(function(){i.onAfterRenderObservable.notifyObservers(t)}))}},{key:"_prepareFrame",value:function(e,t,i,n){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!n||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(t,i)}},{key:"_renderToTarget",value:function(e,t,i){var n,r,s,a,o,l,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,c=this.getScene();if(c){var d=c.getEngine();if(null===(n=d._debugPushGroup)||void 0===n||n.call(d,"render to face #".concat(e," layer #").concat(u),1),this._prepareFrame(c,e,u,t),this.is2DArray?(d.currentRenderPassId=this._renderPassIds[u],this.onBeforeRenderObservable.notifyObservers(u)):(d.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e)),d.snapshotRendering&&1===d.snapshotRenderingMode)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(d):this.skipInitialClear||d.clear(this.clearColor||c.clearColor,!0,!0,!0);else{var f=null,_=this.renderList?this.renderList:c.getActiveMeshes().data,v=this.renderList?this.renderList.length:c.getActiveMeshes().length;this.getCustomRenderList&&(f=this.getCustomRenderList(this.is2DArray?u:e,_,v)),f?this._prepareRenderingManager(f,f.length,h,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(_,v,h,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),f=_);var g,m=(0,p.Z)(c._beforeRenderTargetClearStage);try{for(m.s();!(g=m.n()).done;){g.value.action(this,e,u)}}catch(A){m.e(A)}finally{m.f()}this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(d):this.skipInitialClear||d.clear(this.clearColor||c.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||c.updateTransformMatrix(!0);var y,T=(0,p.Z)(c._beforeRenderTargetDrawStage);try{for(T.s();!(y=T.n()).done;){y.value.action(this,e,u)}}catch(A){T.e(A)}finally{T.f()}this._renderingManager.render(this.customRenderFunction,f,this.renderParticles,this.renderSprites);var E,S=(0,p.Z)(c._afterRenderTargetDrawStage);try{for(S.s();!(E=S.n()).done;){E.value.action(this,e,u)}}catch(A){S.e(A)}finally{S.f()}var b=null!==(s=null===(r=this._texture)||void 0===r?void 0:r.generateMipMaps)&&void 0!==s&&s;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,null!==(a=this._renderTarget)&&void 0!==a?a:void 0,e,this._postProcesses,this.ignoreCameraViewport):t&&c.postProcessManager._finalizeFrame(!1,null!==(o=this._renderTarget)&&void 0!==o?o:void 0,e);var x,M=(0,p.Z)(c._afterRenderTargetPostProcessStage);try{for(M.s();!(x=M.n()).done;){x.value.action(this,e,u)}}catch(A){M.e(A)}finally{M.f()}this._texture&&(this._texture.generateMipMaps=b),this._doNotChangeAspectRatio||c.updateTransformMatrix(!0),i&&gr.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),d)}this._unbindFrameBuffer(d,e),this._texture&&this.isCube&&5===e&&d.generateMipMapsForCubemap(this._texture),null===(l=d._debugPopGroup)||void 0===l||l.call(d,1)}}},{key:"setRenderingOrder",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._renderingManager.setRenderingOrder(e,t,i,n)}},{key:"setRenderingAutoClearDepthStencil",value:function(e,t){this._renderingManager.setRenderingAutoClearDepthStencil(e,t),this._renderingManager._useSceneAutoClearSetup=!1}},{key:"clone",value:function(){var e=this.getSize(),t=new i(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}},{key:"serialize",value:function(){if(!this.name)return null;var e=c((0,h.Z)(i.prototype),"serialize",this).call(this);if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(var t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}},{key:"disposeFramebufferObjects",value:function(){var e;null===(e=this._renderTarget)||void 0===e||e.dispose(!0)}},{key:"releaseInternalTexture",value:function(){var e;null===(e=this._renderTarget)||void 0===e||e.releaseTextures(),this._texture=null}},{key:"dispose",value:function(){var e;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;var t=this.getScene();if(t){var n=t.customRenderTargets.indexOf(this);n>=0&&t.customRenderTargets.splice(n,1);var r,s=(0,p.Z)(t.cameras);try{for(s.s();!(r=s.n()).done;){var a=r.value;(n=a.customRenderTargets.indexOf(this))>=0&&a.customRenderTargets.splice(n,1)}}catch(o){s.e(o)}finally{s.f()}null===(e=this._renderTarget)||void 0===e||e.dispose(),this._renderTarget=null,this._texture=null,c((0,h.Z)(i.prototype),"dispose",this).call(this)}}},{key:"_rebuild",value:function(){this.refreshRate===i.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=i.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}},{key:"freeRenderingGroups",value:function(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}},{key:"getViewCount",value:function(){return 1}}]),i}(ar);pr.REFRESHRATE_RENDER_ONCE=0,pr.REFRESHRATE_RENDER_ONEVERYFRAME=1,pr.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,ar._CreateRenderTargetTexture=function(e,t,i,n,r){return new pr(e,t,i,n)};var mr=function(){function e(t,i,n,r,s,a){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,l=arguments.length>7?arguments[7]:void 0,u=arguments.length>8?arguments[8]:void 0,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,d=arguments.length>11&&void 0!==arguments[11]?arguments[11]:"postprocess",f=arguments.length>12?arguments[12]:void 0,_=arguments.length>13&&void 0!==arguments[13]&&arguments[13],v=arguments.length>14&&void 0!==arguments[14]?arguments[14]:5,g=arguments.length>15&&void 0!==arguments[15]?arguments[15]:ve.GLSL;(0,m.Z)(this,e),this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new kt(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new W(1,1),this._texelSize=W.Zero(),this.onActivateObservable=new ee,this.onSizeChangedObservable=new ee,this.onApplyObservable=new ee,this.onBeforeRenderObservable=new ee,this.onAfterRenderObservable=new ee,this.name=t,null!=a?(this._camera=a,this._scene=a.getScene(),a.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=s,this.renderTargetSamplingMode=o||1,this._reusable=u||!1,this._textureType=c,this._textureFormat=v,this._shaderLanguage=g,this._samplers=r||[],this._samplers.push("textureSampler"),this._fragmentUrl=i,this._vertexUrl=d,this._parameters=n||[],this._parameters.push("scale"),this._indexParameters=f,this._drawWrapper=new Le(this._engine),_||this.updateEffect(h)}return(0,y.Z)(e,[{key:"samples",get:function(){return this._samples},set:function(e){var t=this;this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach((function(e){e.setSamples(t._samples)}))}},{key:"getEffectName",value:function(){return this._fragmentUrl}},{key:"onActivate",set:function(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}},{key:"onSizeChanged",set:function(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}},{key:"onApply",set:function(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}},{key:"onBeforeRender",set:function(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}},{key:"onAfterRender",set:function(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}},{key:"inputTexture",get:function(){return this._textures.data[this._currentRenderTextureInd]},set:function(e){this._forcedOutputTexture=e}},{key:"restoreDefaultInputTexture",value:function(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}},{key:"getCamera",value:function(){return this._camera}},{key:"texelSize",get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}},{key:"getClassName",value:function(){return"PostProcess"}},{key:"getEngine",value:function(){return this._engine}},{key:"getEffect",value:function(){return this._drawWrapper.effect}},{key:"shareOutputWith",value:function(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}},{key:"useOwnOutput",value:function(){0==this._textures.length&&(this._textures=new kt(2)),this._shareOutputWithPostProcess=null}},{key:"updateEffect",value:function(){var t,i,n=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,l=arguments.length>3?arguments[3]:void 0,u=arguments.length>4?arguments[4]:void 0,h=arguments.length>5?arguments[5]:void 0,c=arguments.length>6?arguments[6]:void 0,d=arguments.length>7?arguments[7]:void 0,f=e._GetShaderCodeProcessing(this.name);if(null!=f&&f.defineCustomBindings){var _=null!==(t=null==a?void 0:a.slice())&&void 0!==t?t:[];_.push.apply(_,(0,s.Z)(this._parameters));var v=null!==(i=null==o?void 0:o.slice())&&void 0!==i?i:[];v.push.apply(v,(0,s.Z)(this._samplers)),r=f.defineCustomBindings(this.name,r,_,v),a=_,o=v}this._postProcessDefines=r,this._drawWrapper.effect=this._engine.createEffect({vertex:null!==c&&void 0!==c?c:this._vertexUrl,fragment:null!==d&&void 0!==d?d:this._fragmentUrl},{attributes:["position"],uniformsNames:a||this._parameters,uniformBuffersNames:[],samplers:o||this._samplers,defines:null!==r?r:"",fallbacks:null,onCompiled:null!==u&&void 0!==u?u:null,onError:null!==h&&void 0!==h?h:null,indexParameters:l||this._indexParameters,processCodeAfterIncludes:null!=f&&f.processCodeAfterIncludes?function(e,t){return f.processCodeAfterIncludes(n.name,e,t)}:null,processFinalCode:null!=f&&f.processFinalCode?function(e,t){return f.processFinalCode(n.name,e,t)}:null,shaderLanguage:this._shaderLanguage},this._engine)}},{key:"isReusable",value:function(){return this._reusable}},{key:"markTextureDirty",value:function(){this.width=-1}},{key:"_createRenderTargetTexture",value:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=0;n<this._textureCache.length;n++)if(this._textureCache[n].texture.width===e.width&&this._textureCache[n].texture.height===e.height&&this._textureCache[n].postProcessChannel===i&&this._textureCache[n].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[n].texture.samples===t.samples)return this._textureCache[n].texture;var r=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:r,postProcessChannel:i,lastUsedRenderId:-1}),r}},{key:"_flushTextureCache",value:function(){for(var e=this._renderId,t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){for(var i=!1,n=0;n<this._textures.length;n++)if(this._textures.data[n]===this._textureCache[t].texture){i=!0;break}i||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}},{key:"_resize",value:function(e,t,i,n,r){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;for(var s=null,a=0;a<i._postProcesses.length;a++)if(null!==i._postProcesses[a]){s=i._postProcesses[a];break}var o={width:this.width,height:this.height},l={generateMipMaps:n,generateDepthBuffer:r||s===this,generateStencilBuffer:(r||s===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples};this._textures.push(this._createRenderTargetTexture(o,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(o,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}},{key:"activate",value:function(e){var t,i,n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2?arguments[2]:void 0,a=(e=e||this._camera).getScene(),o=a.getEngine(),l=o.getCaps().maxTextureSize,u=(r?r.width:this._engine.getRenderWidth(!0))*this._options|0,h=(r?r.height:this._engine.getRenderHeight(!0))*this._options|0,c=e.parent;c&&(c.leftCamera==e||c.rightCamera==e)&&(u/=2);var d,f=this._options.width||u,_=this._options.height||h,v=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){var g=o.currentViewport;g&&(f*=g.width,_*=g.height)}(v||this.alwaysForcePOT)&&(this._options.width||(f=o.needPOTTextures?Xe.GetExponentOfTwo(f,l,this.scaleMode):f),this._options.height||(_=o.needPOTTextures?Xe.GetExponentOfTwo(_,l,this.scaleMode):_)),(this.width!==f||this.height!==_)&&this._resize(f,_,e,v,s),this._textures.forEach((function(e){e.samples!==n.samples&&n._engine.updateRenderTargetTextureSampleCount(e,n.samples)})),this._flushTextureCache(),this._renderId++}if(this._shareOutputWithPostProcess)d=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)d=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{var p;d=this.inputTexture;for(var m=0;m<this._textureCache.length;m++)if(this._textureCache[m].texture===d){p=this._textureCache[m];break}p&&(p.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(u/f,h/_),this._engine.bindFramebuffer(d,0,u,h,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(d,0,void 0,void 0,this.forceFullscreenViewport)),null===(i=(t=this._engine)._debugInsertMarker)||void 0===i||i.call(t,"post process ".concat(this.name," input")),this.onActivateObservable.notifyObservers(e),this.autoClear&&0===this.alphaMode&&this._engine.clear(this.clearColor?this.clearColor:a.clearColor,a._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),d}},{key:"isSupported",get:function(){return this._drawWrapper.effect.isSupported}},{key:"aspectRatio",get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}},{key:"isReady",value:function(){var e,t;return null!==(t=null===(e=this._drawWrapper.effect)||void 0===e?void 0:e.isReady())&&void 0!==t&&t}},{key:"apply",value:function(){var t,i,n,r;return null!==(t=this._drawWrapper.effect)&&void 0!==t&&t.isReady()?(this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),r=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",null==r?void 0:r.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),null===(n=null===(i=e._GetShaderCodeProcessing(this.name))||void 0===i?void 0:i.bindCustomBindings)||void 0===n||n.call(i,this.name,this._drawWrapper.effect),this._drawWrapper.effect):null}},{key:"_disposeTextures",value:function(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}},{key:"_disposeTextureCache",value:function(){for(var e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}},{key:"setPrePassRenderer",value:function(e){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}},{key:"dispose",value:function(e){var t;if(e=e||this._camera,this._disposeTextures(),this._scene&&(-1!==(t=this._scene.postProcesses.indexOf(this))&&this._scene.postProcesses.splice(t,1)),this._parentContainer){var i=this._parentContainer.postProcesses.indexOf(this);i>-1&&this._parentContainer.postProcesses.splice(i,1),this._parentContainer=null}if(-1!==(t=this._engine.postProcesses.indexOf(this))&&this._engine.postProcesses.splice(t,1),e){if(e.detachPostProcess(this),0===(t=e._postProcesses.indexOf(this))&&e._postProcesses.length>0){var n=this._camera._getFirstPostProcess();n&&n.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}},{key:"serialize",value:function(){var e=jt.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}},{key:"clone",value:function(){var t=this.serialize();t._engine=this._engine,t.cameraId=null;var i=e.Parse(t,this._scene,"");return i?(i.onActivateObservable=this.onActivateObservable.clone(),i.onSizeChangedObservable=this.onSizeChangedObservable.clone(),i.onApplyObservable=this.onApplyObservable.clone(),i.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),i.onAfterRenderObservable=this.onAfterRenderObservable.clone(),i._prePassEffectConfiguration=this._prePassEffectConfiguration,i):null}}],[{key:"RegisterShaderCodeProcessing",value:function(t,i){i?e._CustomShaderCodeProcessing[null!==t&&void 0!==t?t:""]=i:delete e._CustomShaderCodeProcessing[null!==t&&void 0!==t?t:""]}},{key:"_GetShaderCodeProcessing",value:function(t){var i;return null!==(i=e._CustomShaderCodeProcessing[t])&&void 0!==i?i:e._CustomShaderCodeProcessing[""]}},{key:"Parse",value:function(e,t,i){var n=B(e.customType);if(!n||!n._Parse)return null;var r=t?t.getCameraById(e.cameraId):null;return n._Parse(e,r,t,i)}},{key:"_Parse",value:function(t,i,n,r){return jt.Parse((function(){return new e(t.name,t.fragmentUrl,t.parameters,t.samplers,t.options,i,t.renderTargetSamplingMode,t._engine,t.reusable,t.defines,t.textureType,t.vertexUrl,t.indexParameters,!1,t.textureFormat)}),t,n,r)}}]),e}();mr._CustomShaderCodeProcessing={},Nt([Xt()],mr.prototype,"uniqueId",void 0),Nt([Xt()],mr.prototype,"name",void 0),Nt([Xt()],mr.prototype,"width",void 0),Nt([Xt()],mr.prototype,"height",void 0),Nt([Xt()],mr.prototype,"renderTargetSamplingMode",void 0),Nt([qt()],mr.prototype,"clearColor",void 0),Nt([Xt()],mr.prototype,"autoClear",void 0),Nt([Xt()],mr.prototype,"alphaMode",void 0),Nt([Xt()],mr.prototype,"alphaConstants",void 0),Nt([Xt()],mr.prototype,"enablePixelPerfectMode",void 0),Nt([Xt()],mr.prototype,"forceFullscreenViewport",void 0),Nt([Xt()],mr.prototype,"scaleMode",void 0),Nt([Xt()],mr.prototype,"alwaysForcePOT",void 0),Nt([Xt("samples")],mr.prototype,"_samples",void 0),Nt([Xt()],mr.prototype,"adaptScaleToCurrentViewport",void 0),N("BABYLON.PostProcess",mr);xe.IncludesShadersStore.kernelBlurVaryingDeclaration="varying vec2 sampleCoord{X};";xe.IncludesShadersStore.packingFunctions="vec4 pack(float depth)\n{\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(depth*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}";xe.IncludesShadersStore.kernelBlurFragment="#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;\nsumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif\n";xe.IncludesShadersStore.kernelBlurFragment2="#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});\ncomputedWeight=KERNEL_DEP_WEIGHT{X}*factor;\nsumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";xe.ShadersStore.kernelBlurPixelShader="uniform sampler2D textureSampler;\nuniform vec2 delta;\nvarying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;\nfloat sampleCoC(in vec2 offset) {\nfloat coc=texture2D(circleOfConfusionSampler,offset).r;\nreturn coc; \n}\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat computedWeight=0.0;\n#ifdef PACKEDFLOAT\nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}";xe.IncludesShadersStore.kernelBlurVertex="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";xe.ShadersStore.kernelBlurVertexShader="attribute vec2 position;\nuniform vec2 delta;\nvarying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";var yr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r,s,a){var o,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:ar.BILINEAR_SAMPLINGMODE,u=arguments.length>6?arguments[6]:void 0,h=arguments.length>7?arguments[7]:void 0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,d=arguments.length>9&&void 0!==arguments[9]?arguments[9]:"",f=arguments.length>10&&void 0!==arguments[10]&&arguments[10],_=arguments.length>11&&void 0!==arguments[11]?arguments[11]:5;return(0,m.Z)(this,i),(o=t.call(this,e,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],s,a,l,u,h,null,c,"kernelBlur",{varyingCount:0,depCount:0},!0,_))._blockCompilation=f,o._packedFloat=!1,o._staticDefines="",o._staticDefines=d,o.direction=n,o.onApplyObservable.add((function(e){o._outputTexture?e.setFloat2("delta",1/o._outputTexture.width*o.direction.x,1/o._outputTexture.height*o.direction.y):e.setFloat2("delta",1/o.width*o.direction.x,1/o.height*o.direction.y)})),o.kernel=r,o}return(0,y.Z)(i,[{key:"kernel",get:function(){return this._idealKernel},set:function(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())}},{key:"packedFloat",get:function(){return this._packedFloat},set:function(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())}},{key:"getClassName",value:function(){return"BlurPostProcess"}},{key:"updateEffect",value:function(){var e=arguments.length>4?arguments[4]:void 0,t=arguments.length>5?arguments[5]:void 0;this._updateParameters(e,t)}},{key:"_updateParameters",value:function(e,t){for(var n=this._kernel,r=(n-1)/2,s=[],a=[],o=0,l=0;l<n;l++){var u=l/(n-1),d=this._gaussianWeight(2*u-1);s[l]=l-r,a[l]=d,o+=d}for(var f=0;f<a.length;f++)a[f]/=o;for(var _=[],v=[],g=[],p=0;p<=r;p+=2){var m=Math.min(p+1,Math.floor(r));if(p===m)g.push({o:s[p],w:a[p]});else{var y=m===r,T=a[p]+a[m]*(y?.5:1),E=s[p]+1/(1+a[p]/a[m]);0===E?(g.push({o:s[p],w:a[p]}),g.push({o:s[p+1],w:a[p+1]})):(g.push({o:E,w:T}),g.push({o:-E,w:T}))}}for(var S=0;S<g.length;S++)v[S]=g[S].o,_[S]=g[S].w;s=v,a=_;var b=this.getEngine().getCaps().maxVaryingVectors,x=Math.max(b,0)-1,M=Math.min(s.length,x),A="";A+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(A+="#define CENTER_WEIGHT ".concat(this._glslFloat(a[M-1]),"\r\n"),M--);for(var R=0;R<M;R++)A+="#define KERNEL_OFFSET".concat(R," ").concat(this._glslFloat(s[R]),"\r\n"),A+="#define KERNEL_WEIGHT".concat(R," ").concat(this._glslFloat(a[R]),"\r\n");for(var C=0,I=x;I<s.length;I++)A+="#define KERNEL_DEP_OFFSET".concat(C," ").concat(this._glslFloat(s[I]),"\r\n"),A+="#define KERNEL_DEP_WEIGHT".concat(C," ").concat(this._glslFloat(a[I]),"\r\n"),C++;this.packedFloat&&(A+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,c((0,h.Z)(i.prototype),"updateEffect",this).call(this,A,null,null,{varyingCount:M,depCount:C},e,t)}},{key:"_nearestBestKernel",value:function(e){for(var t=Math.round(e),i=0,n=[t,t-1,t+1,t-2,t+2];i<n.length;i++){var r=n[i];if(r%2!==0&&Math.floor(r/2)%2===0&&r>0)return Math.max(r,3)}return Math.max(t,3)}},{key:"_gaussianWeight",value:function(e){var t=.3333333333333333,i=-e*e/(2*t*t);return 1/(Math.sqrt(2*Math.PI)*t)*Math.exp(i)}},{key:"_glslFloat",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8;return e.toFixed(t).replace(/0+$/,"")}}],[{key:"_Parse",value:function(e,t,n,r){return jt.Parse((function(){return new i(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,n.getEngine(),e.reusable,e.textureType,void 0,!1)}),e,n,r)}}]),i}(mr);Nt([Xt("kernel")],yr.prototype,"_kernel",void 0),Nt([Xt("packedFloat")],yr.prototype,"_packedFloat",void 0),Nt([function(e){return Wt(4,e)}()],yr.prototype,"direction",void 0),N("BABYLON.BlurPostProcess",yr);var Tr=function(){function e(){(0,m.Z)(this,e),this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}return(0,y.Z)(e,[{key:"unBindMesh",value:function(){this._mesh=null}},{key:"addFallback",value:function(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}},{key:"addCPUSkinningFallback",value:function(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}},{key:"hasMoreFallbacks",get:function(){return this._currentRank<=this._maxRank}},{key:"reduce",value:function(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;for(var i=this._mesh.getScene(),n=0;n<i.meshes.length;n++){var r=i.meshes[n];if(r.material){if(r.computeBonesUsingShaders&&0!==r.numBoneInfluencers)if(r.material.getEffect()===t)r.computeBonesUsingShaders=!1;else if(r.subMeshes){var s,a=(0,p.Z)(r.subMeshes);try{for(a.s();!(s=a.n()).done;){if(s.value.effect===t){r.computeBonesUsingShaders=!1;break}}}catch(u){a.e(u)}finally{a.f()}}}else!this._mesh.material&&r.computeBonesUsingShaders&&r.numBoneInfluencers>0&&(r.computeBonesUsingShaders=!1)}}else{var o=this._defines[this._currentRank];if(o)for(var l=0;l<o.length;l++)e=e.replace("#define "+o[l],"");this._currentRank++}return e}}]),e}();xe.IncludesShadersStore.bayerDitherFunctions="float bayerDither2(vec2 _P) {\nreturn mod(2.0*_P.y+_P.x+1.0,4.0);\n}\nfloat bayerDither4(vec2 _P) {\nvec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5*mod(_P,4.0)); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);\n}\nfloat bayerDither8(vec2 _P) {\nvec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5 *mod(_P,4.0)); \nvec2 P4=floor(0.25*mod(_P,8.0)); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);\n}\n";xe.IncludesShadersStore.shadowMapFragmentExtraDeclaration="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform float softTransparentShadowSM;\n#endif\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nuniform vec3 lightDataSM;\nvarying vec3 vPositionWSM;\n#endif\nuniform vec3 biasAndScaleSM;\nuniform vec2 depthValuesSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";xe.IncludesShadersStore.clipPlaneFragmentDeclaration="#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nvarying float fClipDistance6;\n#endif\n";xe.IncludesShadersStore.clipPlaneFragment="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fClipDistance>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE2\nelse if (fClipDistance2>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE3\nelse if (fClipDistance3>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE4\nelse if (fClipDistance4>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE5\nelse if (fClipDistance5>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE6\nelse if (fClipDistance6>0.0)\n{\ndiscard;\n}\n#endif\n";xe.IncludesShadersStore.shadowMapFragment="float depthSM=vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\ndepthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_FragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\ngl_FragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\ngl_FragColor=vec4(depthSM,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depthSM);\n#endif\nreturn;";xe.ShadersStore.shadowMapPixelShader="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nfloat alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE)\ndiscard;\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;\n#else\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;\n#endif\n#endif\n#include<shadowMapFragment>\n}";xe.IncludesShadersStore.bonesDeclaration="#if NUM_BONE_INFLUENCERS>0\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;\nattribute vec4 matricesWeightsExtra;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nuniform sampler2D boneSampler;\nuniform float boneTextureWidth;\n#else\nuniform mat4 mBones[BonesPerMesh];\n#ifdef BONES_VELOCITY_ENABLED\nuniform mat4 mPreviousBones[BonesPerMesh];\n#endif\n#endif\n#ifdef BONETEXTURE\n#define inline\nmat4 readMatrixFromRawSampler(sampler2D smp,float index)\n{\nfloat offset=index *4.0;\nfloat dx=1.0/boneTextureWidth;\nvec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));\nvec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));\nvec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));\nvec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));\nreturn mat4(m0,m1,m2,m3);\n}\n#endif\n#endif\n#endif\n";xe.IncludesShadersStore.bakedVertexAnimationDeclaration="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform float bakedVertexAnimationTime;\nuniform vec2 bakedVertexAnimationTextureSizeInverted;\nuniform vec4 bakedVertexAnimationSettings;\nuniform sampler2D bakedVertexAnimationTexture;\n#ifdef INSTANCES\nattribute vec4 bakedVertexAnimationSettingsInstanced;\n#endif\n#define inline\nmat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)\n{\nfloat offset=index*4.0;\nfloat frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;\nfloat dx=bakedVertexAnimationTextureSizeInverted.x;\nvec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));\nvec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));\nvec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));\nvec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));\nreturn mat4(m0,m1,m2,m3);\n}\n#endif\n";xe.IncludesShadersStore.morphTargetsVertexGlobalDeclaration="#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#ifdef MORPHTARGETS_TEXTURE \nprecision mediump sampler2DArray; \nuniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];\nuniform vec3 morphTargetTextureInfo;\nuniform sampler2DArray morphTargets;\nvec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)\n{ \nfloat y=floor(vertexIndex/morphTargetTextureInfo.y);\nfloat x=vertexIndex-y*morphTargetTextureInfo.y;\nvec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);\nreturn texture(morphTargets,textureUV).xyz;\n}\n#endif\n#endif\n";xe.IncludesShadersStore.morphTargetsVertexDeclaration="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\nattribute vec3 position{X};\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#ifdef MORPHTARGETS_UV\nattribute vec2 uv_{X};\n#endif\n#endif\n#endif\n";xe.IncludesShadersStore.helperFunctions="const float PI=3.1415926535897932384626433832795;\nconst float HALF_MIN=5.96046448e-08; \nconst float LinearEncodePowerApprox=2.2;\nconst float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;\nconst vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);\nconst float Epsilon=0.0000001;\n#define saturate(x) clamp(x,0.0,1.0)\n#define absEps(x) abs(x)+Epsilon\n#define maxEps(x) max(x,Epsilon)\n#define saturateEps(x) clamp(x,Epsilon,1.0)\nmat3 transposeMat3(mat3 inMatrix) {\nvec3 i0=inMatrix[0];\nvec3 i1=inMatrix[1];\nvec3 i2=inMatrix[2];\nmat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);\nreturn outMatrix;\n}\nmat3 inverseMat3(mat3 inMatrix) {\nfloat a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];\nfloat a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];\nfloat a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];\nfloat b01=a22*a11-a12*a21;\nfloat b11=-a22*a10+a12*a20;\nfloat b21=a21*a10-a11*a20;\nfloat det=a00*b01+a01*b11+a02*b21;\nreturn mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),\nb11,(a22*a00-a02*a20),(-a12*a00+a02*a10),\nb21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;\n}\n#if USE_EXACT_SRGB_CONVERSIONS\nvec3 toLinearSpaceExact(vec3 color)\n{\nvec3 nearZeroSection=0.0773993808*color;\nvec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));\n#else\nreturn\nvec3(\ncolor.r<=0.04045 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.04045 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.04045 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\nvec3 toGammaSpaceExact(vec3 color)\n{\nvec3 nearZeroSection=12.92*color;\nvec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));\n#else\nreturn\nvec3(\ncolor.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\n#endif\nfloat toLinearSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=0.0773993808*color;\nfloat remainingSection=pow(0.947867299*(color+0.055),2.4);\nreturn color<=0.04045 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nvec3 toLinearSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3(LinearEncodePowerApprox));\n#endif\n}\nvec4 toLinearSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfloat toGammaSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=12.92*color;\nfloat remainingSection=1.055*pow(color,0.41666)-0.055;\nreturn color<=0.0031308 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,GammaEncodePowerApprox);\n#endif\n}\nvec3 toGammaSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3(GammaEncodePowerApprox));\n#endif\n}\nvec4 toGammaSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfloat square(float value)\n{\nreturn value*value;\n}\nvec3 square(vec3 value)\n{\nreturn value*value;\n}\nfloat pow5(float value) {\nfloat sq=value*value;\nreturn sq*sq*value;\n}\nfloat getLuminance(vec3 color)\n{\nreturn clamp(dot(color,LuminanceEncodeApprox),0.,1.);\n}\nfloat getRand(vec2 seed) {\nreturn fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);\n}\nfloat dither(vec2 seed,float varianceAmount) {\nfloat rand=getRand(seed);\nfloat normVariance=varianceAmount/255.0;\nfloat dither=mix(-normVariance,normVariance,rand);\nreturn dither;\n}\nconst float rgbdMaxRange=255.0;\nvec4 toRGBD(vec3 color) {\nfloat maxRGB=maxEps(max(color.r,max(color.g,color.b)));\nfloat D =max(rgbdMaxRange/maxRGB,1.);\nD =clamp(floor(D)/255.0,0.,1.);\nvec3 rgb=color.rgb*D;\nrgb=toGammaSpace(rgb);\nreturn vec4(clamp(rgb,0.,1.),D); \n}\nvec3 fromRGBD(vec4 rgbd) {\nrgbd.rgb=toLinearSpace(rgbd.rgb);\nreturn rgbd.rgb/rgbd.a;\n}\nvec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {\nvec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;\nvec3 halfSize=cubeSize*0.5;\nvec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;\nvec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;\nvec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);\nfloat distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);\nvec3 intersectPositionWS=vertexPos+origVec*distance;\nreturn intersectPositionWS-cubePos;\n}\n";xe.IncludesShadersStore.sceneVertexDeclaration="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec4 vEyePosition;\n";xe.IncludesShadersStore.meshVertexDeclaration="uniform mat4 world;\nuniform float visibility;\n";xe.IncludesShadersStore.shadowMapVertexDeclaration="#include<sceneVertexDeclaration>\n#include<meshVertexDeclaration>\n";xe.IncludesShadersStore.sceneUboDeclaration="layout(std140,column_major) uniform;\nuniform Scene {\nmat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \nmat4 view;\nmat4 projection;\nvec4 vEyePosition;\n};\n";xe.IncludesShadersStore.meshUboDeclaration="#ifdef WEBGL2\nuniform mat4 world;\nuniform float visibility;\n#else\nlayout(std140,column_major) uniform;\nuniform Mesh\n{\nmat4 world;\nfloat visibility;\n};\n#endif\n#define WORLD_UBO\n";xe.IncludesShadersStore.shadowMapUboDeclaration="layout(std140,column_major) uniform;\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";xe.IncludesShadersStore.shadowMapVertexExtraDeclaration="#if SM_NORMALBIAS==1\nuniform vec3 lightDataSM;\n#endif\nuniform vec3 biasAndScaleSM;\nuniform vec2 depthValuesSM;\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nvarying vec3 vPositionWSM;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";xe.IncludesShadersStore.clipPlaneVertexDeclaration="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;\nvarying float fClipDistance6;\n#endif\n";xe.IncludesShadersStore.morphTargetsVertexGlobal="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nfloat vertexID;\n#endif\n#endif\n";xe.IncludesShadersStore.morphTargetsVertex="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE \nvertexID=float(gl_VertexID)*morphTargetTextureInfo.x;\npositionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];\nvertexID+=1.0;\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#else\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n";xe.IncludesShadersStore.instancesVertex="#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nmat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\nfinalWorld=world*finalWorld;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\nmat4 finalWorld=world;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nmat4 finalPreviousWorld=previousWorld;\n#endif\n#endif\n";xe.IncludesShadersStore.bonesVertex="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];\n#endif\n#else\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n";xe.IncludesShadersStore.bakedVertexAnimation="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\n#define BVASNAME bakedVertexAnimationSettingsInstanced\n#else\n#define BVASNAME bakedVertexAnimationSettings\n#endif\nfloat VATStartFrame=BVASNAME.x;\nfloat VATEndFrame=BVASNAME.y;\nfloat VATOffsetFrame=BVASNAME.z;\nfloat VATSpeed=BVASNAME.w;\nfloat totalFrames=VATEndFrame-VATStartFrame+1.0;\nfloat time=bakedVertexAnimationTime*VATSpeed/totalFrames;\nfloat frameCorrection=time<1.0 ? 0.0 : 1.0;\nfloat numOfFrames=totalFrames-frameCorrection;\nfloat VATFrameNum=fract(time)*numOfFrames;\nVATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);\nVATFrameNum=floor(VATFrameNum);\nVATFrameNum+=VATStartFrame+frameCorrection;\nmat4 VATInfluence;\nVATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;\n}\n#endif\n";xe.IncludesShadersStore.shadowMapVertexNormalBias="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvec3 worldLightDirSM=normalize(-lightDataSM.xyz);\n#else\nvec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;\nvec3 worldLightDirSM=normalize(directionToLightSM);\n#endif\nfloat ndlSM=dot(vNormalW,worldLightDirSM);\nfloat sinNLSM=sqrt(1.0-ndlSM*ndlSM);\nfloat normalBiasSM=biasAndScaleSM.y*sinNLSM;\nworldPos.xyz-=vNormalW*normalBiasSM;\n#endif\n";xe.IncludesShadersStore.shadowMapVertexMetric="#if SM_USEDISTANCE==1\nvPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#else\ngl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nzSM=gl_Position.z;\ngl_Position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\nvDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n";xe.IncludesShadersStore.clipPlaneVertex="#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nfClipDistance2=dot(worldPos,vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nfClipDistance3=dot(worldPos,vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nfClipDistance4=dot(worldPos,vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nfClipDistance5=dot(worldPos,vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nfClipDistance6=dot(worldPos,vClipPlane6);\n#endif\n";xe.ShadersStore.shadowMapVertexShader="attribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#endif\n#include<helperFunctions>\n#include<__decl__shadowMapVertex>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normWorldSM=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));\nvNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvec3 vNormalW=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\ngl_Position=viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n}";xe.ShadersStore.depthBoxBlurPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec4 colorDepth=vec4(0.0);\nfor (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);\ngl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));\n}";xe.IncludesShadersStore.shadowMapFragmentSoftTransparentShadow="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;\n#endif\n";var Er=function(){function e(t,i,n,r){(0,m.Z)(this,e),this.onBeforeShadowMapRenderObservable=new ee,this.onAfterShadowMapRenderObservable=new ee,this.onBeforeShadowMapRenderMeshObservable=new ee,this.onAfterShadowMapRenderMeshObservable=new ee,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=e.FILTER_NONE,this._filteringQuality=e.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=z.Zero(),this._viewMatrix=Z.Zero(),this._projectionMatrix=Z.Zero(),this._transformMatrix=Z.Zero(),this._cachedPosition=new z(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new z(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=Z.Identity(),this._mapSize=t,this._light=i,this._scene=i.getScene(),this._camera=null!==r&&void 0!==r?r:null;var s=i._shadowGenerators;s||(s=i._shadowGenerators=new Map),s.set(this._camera,this),this.id=i.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer('Scene for Shadow Generator (light "'.concat(this._light.name,'")')))),e._SceneComponentInitialization(this._scene);var a=this._scene.getEngine().getCaps();n?a.textureFloatRender&&a.textureFloatLinearFiltering?this._textureType=1:a.textureHalfFloatRender&&a.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:a.textureHalfFloatRender&&a.textureHalfFloatLinearFiltering?this._textureType=2:a.textureFloatRender&&a.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}return(0,y.Z)(e,[{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e}},{key:"blurBoxOffset",get:function(){return this._blurBoxOffset},set:function(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}},{key:"blurScale",get:function(){return this._blurScale},set:function(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}},{key:"blurKernel",get:function(){return this._blurKernel},set:function(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}},{key:"useKernelBlur",get:function(){return this._useKernelBlur},set:function(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}},{key:"depthScale",get:function(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()},set:function(e){this._depthScale=e}},{key:"_validateFilter",value:function(e){return e}},{key:"filter",get:function(){return this._filter},set:function(t){if(t=this._validateFilter(t),this._light.needCube()){if(t===e.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(t===e.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(t===e.FILTER_PCF||t===e.FILTER_PCSS)return void(this.usePoissonSampling=!0)}t!==e.FILTER_PCF&&t!==e.FILTER_PCSS||this._scene.getEngine()._features.supportShadowSamplers?this._filter!==t&&(this._filter=t,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=!0}},{key:"usePoissonSampling",get:function(){return this.filter===e.FILTER_POISSONSAMPLING},set:function(t){var i=this._validateFilter(e.FILTER_POISSONSAMPLING);!t&&this.filter!==e.FILTER_POISSONSAMPLING||(this.filter=t?i:e.FILTER_NONE)}},{key:"useExponentialShadowMap",get:function(){return this.filter===e.FILTER_EXPONENTIALSHADOWMAP},set:function(t){var i=this._validateFilter(e.FILTER_EXPONENTIALSHADOWMAP);!t&&this.filter!==e.FILTER_EXPONENTIALSHADOWMAP||(this.filter=t?i:e.FILTER_NONE)}},{key:"useBlurExponentialShadowMap",get:function(){return this.filter===e.FILTER_BLUREXPONENTIALSHADOWMAP},set:function(t){var i=this._validateFilter(e.FILTER_BLUREXPONENTIALSHADOWMAP);!t&&this.filter!==e.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=t?i:e.FILTER_NONE)}},{key:"useCloseExponentialShadowMap",get:function(){return this.filter===e.FILTER_CLOSEEXPONENTIALSHADOWMAP},set:function(t){var i=this._validateFilter(e.FILTER_CLOSEEXPONENTIALSHADOWMAP);!t&&this.filter!==e.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=t?i:e.FILTER_NONE)}},{key:"useBlurCloseExponentialShadowMap",get:function(){return this.filter===e.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},set:function(t){var i=this._validateFilter(e.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!t&&this.filter!==e.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=t?i:e.FILTER_NONE)}},{key:"usePercentageCloserFiltering",get:function(){return this.filter===e.FILTER_PCF},set:function(t){var i=this._validateFilter(e.FILTER_PCF);!t&&this.filter!==e.FILTER_PCF||(this.filter=t?i:e.FILTER_NONE)}},{key:"filteringQuality",get:function(){return this._filteringQuality},set:function(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}},{key:"useContactHardeningShadow",get:function(){return this.filter===e.FILTER_PCSS},set:function(t){var i=this._validateFilter(e.FILTER_PCSS);!t&&this.filter!==e.FILTER_PCSS||(this.filter=t?i:e.FILTER_NONE)}},{key:"contactHardeningLightSizeUVRatio",get:function(){return this._contactHardeningLightSizeUVRatio},set:function(e){this._contactHardeningLightSizeUVRatio=e}},{key:"darkness",get:function(){return this._darkness},set:function(e){this.setDarkness(e)}},{key:"getDarkness",value:function(){return this._darkness}},{key:"setDarkness",value:function(e){return this._darkness=e>=1?1:e<=0?0:e,this}},{key:"transparencyShadow",get:function(){return this._transparencyShadow},set:function(e){this.setTransparencyShadow(e)}},{key:"setTransparencyShadow",value:function(e){return this._transparencyShadow=e,this}},{key:"getShadowMap",value:function(){return this._shadowMap}},{key:"getShadowMapForRendering",value:function(){return this._shadowMap2?this._shadowMap2:this._shadowMap}},{key:"getClassName",value:function(){return e.CLASSNAME}},{key:"addShadowCaster",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(e)&&this._shadowMap.renderList.push(e),t){var i,n=(0,p.Z)(e.getChildMeshes());try{for(n.s();!(i=n.n()).done;){var r=i.value;-1===this._shadowMap.renderList.indexOf(r)&&this._shadowMap.renderList.push(r)}}catch(s){n.e(s)}finally{n.f()}}return this}},{key:"removeShadowCaster",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._shadowMap||!this._shadowMap.renderList)return this;var i=this._shadowMap.renderList.indexOf(e);if(-1!==i&&this._shadowMap.renderList.splice(i,1),t){var n,r=(0,p.Z)(e.getChildren());try{for(r.s();!(n=r.n()).done;){var s=n.value;this.removeShadowCaster(s)}}catch(a){r.e(a)}finally{r.f()}}return this}},{key:"getLight",value:function(){return this._light}},{key:"_getCamera",value:function(){var e;return null!==(e=this._camera)&&void 0!==e?e:this._scene.activeCamera}},{key:"mapSize",get:function(){return this._mapSize},set:function(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}},{key:"_initializeGenerator",value:function(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}},{key:"_createTargetRenderTexture",value:function(){var e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new pr(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)):this._shadowMap=new pr(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube())}},{key:"_initializeShadowMap",value:function(){var t=this;if(this._createTargetRenderTexture(),null!==this._shadowMap){this._shadowMap.wrapU=ar.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=ar.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(ar.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this),this._shadowMap.customIsReadyFunction=function(){return!0};var i=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add((function(){var e;t._currentSceneUBO=t._scene.getSceneUniformBuffer(),null===(e=i._debugPushGroup)||void 0===e||e.call(i,"shadow map generation for pass id ".concat(i.currentRenderPassId),1)})),this._shadowMap.onBeforeRenderObservable.add((function(n){t._sceneUBOs&&t._scene.setSceneUniformBuffer(t._sceneUBOs[0]),t._currentFaceIndex=n,t._filter===e.FILTER_PCF&&i.setColorWrite(!1),t.getTransformMatrix(),t._scene.setTransformMatrix(t._viewMatrix,t._projectionMatrix),t._useUBO&&(t._scene.getSceneUniformBuffer().unbindEffect(),t._scene.finalizeSceneUbo())})),this._shadowMap.onAfterUnbindObservable.add((function(){var n,r;if(t._sceneUBOs&&t._scene.setSceneUniformBuffer(t._currentSceneUBO),t._scene.updateTransformMatrix(),t._filter===e.FILTER_PCF&&i.setColorWrite(!0),t.useBlurExponentialShadowMap||t.useBlurCloseExponentialShadowMap){var s=t.getShadowMapForRendering();s&&(t._scene.postProcessManager.directRender(t._blurPostProcesses,s.renderTarget,!0),i.unBindFramebuffer(s.renderTarget,!0),null===(r=i._debugPopGroup)||void 0===r||r.call(i,1))}else null===(n=i._debugPopGroup)||void 0===n||n.call(i,1)}));var n=new Ke(0,0,0,0),r=new Ke(1,1,1,1);this._shadowMap.onClearObservable.add((function(i){t._filter===e.FILTER_PCF?i.clear(r,!1,!0,!1):t.useExponentialShadowMap||t.useBlurExponentialShadowMap?i.clear(n,!0,!0,!1):i.clear(r,!0,!0,!1)})),this._shadowMap.onResizeObservable.add((function(e){t._storedUniqueId=t._shadowMap.uniqueId,t._mapSize=e.getRenderSize(),t._light._markMeshesAsLightDirty(),t.recreateShadowMap()}));for(var s=ui.MIN_RENDERINGGROUPS;s<ui.MAX_RENDERINGGROUPS;s++)this._shadowMap.setRenderingAutoClearDepthStencil(s,!1)}}},{key:"_initializeBlurRTTAndPostProcesses",value:function(){var e=this,t=this._scene.getEngine(),i=this._mapSize/this.blurScale;(!this.useKernelBlur||1!==this.blurScale)&&(this._shadowMap2=new pr(this._light.name+"_shadowMap2",i,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=ar.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=ar.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(ar.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new yr(this._light.name+"KernelBlurX",new W(1,0),this.blurKernel,1,null,ar.BILINEAR_SAMPLINGMODE,t,!1,this._textureType),this._kernelBlurXPostprocess.width=i,this._kernelBlurXPostprocess.height=i,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add((function(t){t.setTexture("textureSampler",e._shadowMap)})),this._kernelBlurYPostprocess=new yr(this._light.name+"KernelBlurY",new W(0,1),this.blurKernel,1,null,ar.BILINEAR_SAMPLINGMODE,t,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new mr(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,ar.BILINEAR_SAMPLINGMODE,t,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add((function(t){t.setFloat2("screenSize",i,i),t.setTexture("textureSampler",e._shadowMap)})),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}},{key:"_renderForShadowMap",value:function(e,t,i,n){var r;if(n.length)for(r=0;r<n.length;r++)this._renderSubMeshForShadowMap(n.data[r]);for(r=0;r<e.length;r++)this._renderSubMeshForShadowMap(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMeshForShadowMap(t.data[r]);if(this._transparencyShadow)for(r=0;r<i.length;r++)this._renderSubMeshForShadowMap(i.data[r],!0);else for(r=0;r<i.length;r++)i.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}},{key:"_bindCustomEffectForRenderSubMeshForShadowMap",value:function(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}},{key:"_renderSubMeshForShadowMap",value:function(e){var t,i,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=e.getRenderingMesh(),s=e.getEffectiveMesh(),a=this._scene,o=a.getEngine(),l=e.getMaterial();if(s._internalAbstractMeshDataInfo._isActiveIntermediate=!1,l&&0!==e.verticesCount&&e._renderId!==a.getRenderId()){var u=s._getWorldMatrixDeterminant()<0,h=null!==(t=r.overrideMaterialSideOrientation)&&void 0!==t?t:l.sideOrientation;u&&(h=0===h?1:0);var c=0===h;o.setState(l.backFaceCulling,void 0,void 0,c,l.cullBackFaces);var d=r._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(!d.mustReturn){var f=o.getCaps().instancedArrays&&(null!==d.visibleInstances[e._id]&&void 0!==d.visibleInstances[e._id]||r.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(e))if(this.isReady(e,f,n)){e._renderId=a.getRenderId();var _=l.shadowDepthWrapper,v=null!==(i=null==_?void 0:_.getEffect(e,this,o.currentRenderPassId))&&void 0!==i?i:e._getDrawWrapper(),g=Le.GetEffect(v);o.enableEffect(v),f||r._bind(e,g,l.fillMode),this.getTransformMatrix(),g.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===Jn.LIGHTTYPEID_DIRECTIONALLIGHT?g.setVector3("lightDataSM",this._cachedDirection):g.setVector3("lightDataSM",this._cachedPosition);var p=this._getCamera();if(p&&g.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(p),this.getLight().getDepthMinZ(p)+this.getLight().getDepthMaxZ(p)),n&&this.enableSoftTransparentShadow&&g.setFloat("softTransparentShadowSM",s.visibility*l.alpha),_)e._setMainDrawWrapperOverride(v),_.standalone?_.baseMaterial.bindForSubMesh(s.getWorldMatrix(),r,e):l.bindForSubMesh(s.getWorldMatrix(),r,e),e._setMainDrawWrapperOverride(null);else{if(this.useOpacityTextureForTransparentShadow){var m=l.opacityTexture;m&&(g.setTexture("diffuseSampler",m),g.setMatrix("diffuseMatrix",m.getTextureMatrix()||this._defaultTextureMatrix))}else if(l.needAlphaTesting()||l.needAlphaBlending()){var y=l.getAlphaTestTexture();y&&(g.setTexture("diffuseSampler",y),g.setMatrix("diffuseMatrix",y.getTextureMatrix()||this._defaultTextureMatrix))}if(r.useBones&&r.computeBonesUsingShaders&&r.skeleton){var T=r.skeleton;if(T.isUsingTextureForMatrices){var E=T.getTransformMatrixTexture(r);if(!E)return;g.setTexture("boneSampler",E),g.setFloat("boneTextureWidth",4*(T.bones.length+1))}else g.setMatrices("mBones",T.getTransformMatrices(r))}An.BindMorphTargetParameters(r,g),r.morphTargetManager&&r.morphTargetManager.isUsingTextureForTargets&&r.morphTargetManager._bind(g),bn(g,l,a)}!this._useUBO&&!_&&this._bindCustomEffectForRenderSubMeshForShadowMap(e,g,s),An.BindSceneUniformBuffer(g,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();var S=s.getWorldMatrix();f&&(s.getMeshUniformBuffer().bindToEffect(g,"Mesh"),s.transferToEffect(S)),this.forceBackFacesOnly&&o.setState(!0,0,!1,!0,l.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(r),this.onBeforeShadowMapRenderObservable.notifyObservers(g),r._processRendering(s,e,g,l.fillMode,d,f,(function(e,t){s===r||e?(s.getMeshUniformBuffer().bindToEffect(g,"Mesh"),s.transferToEffect(e?t:S)):(r.getMeshUniformBuffer().bindToEffect(g,"Mesh"),r.transferToEffect(t))})),this.forceBackFacesOnly&&o.setState(!0,0,!1,!1,l.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(g),this.onAfterShadowMapRenderMeshObservable.notifyObservers(r)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}}}},{key:"_applyFilterValues",value:function(){this._shadowMap&&(this.filter===e.FILTER_NONE||this.filter===e.FILTER_PCSS?this._shadowMap.updateSamplingMode(ar.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(ar.BILINEAR_SAMPLINGMODE))}},{key:"forceCompilation",value:function(e,t){var i=this,n=(0,a.Z)({useInstances:!1},t),r=this.getShadowMap();if(r){var o=r.renderList;if(o){var l,u=new Array,h=(0,p.Z)(o);try{for(h.s();!(l=h.n()).done;){var c=l.value;u.push.apply(u,(0,s.Z)(c.subMeshes))}}catch(f){h.e(f)}finally{h.f()}if(0!==u.length){var d=0;!function t(){var r,s;if(i._scene&&i._scene.getEngine()){for(;i.isReady(u[d],n.useInstances,null!==(s=null===(r=u[d].getMaterial())||void 0===r?void 0:r.needAlphaBlendingForMesh(u[d].getMesh()))&&void 0!==s&&s);)if(++d>=u.length)return void(e&&e(i));setTimeout(t,16)}}()}else e&&e(this)}else e&&e(this)}else e&&e(this)}},{key:"forceCompilationAsync",value:function(e){var t=this;return new Promise((function(i){t.forceCompilation((function(){i()}),e)}))}},{key:"_isReadyCustomDefines",value:function(e,t,i){}},{key:"_prepareShadowDefines",value:function(e,t,i,n){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));var r=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&r.isVerticesDataPresent(ni.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===Jn.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&n?"1":"0")),this._isReadyCustomDefines(i,e,t),i}},{key:"isReady",value:function(t,i,n){var r,s=t.getMaterial(),a=null==s?void 0:s.shadowDepthWrapper;if(!s)return!1;var o=[];if(this._prepareShadowDefines(t,i,o,n),a){if(!a.isReadyForSubMesh(t,o,this,i,this._scene.getEngine().currentRenderPassId))return!1}else{var l=t._getDrawWrapper(void 0,!0),u=l.effect,h=l.defines,c=[ni.PositionKind],d=t.getMesh();this.normalBias&&d.isVerticesDataPresent(ni.NormalKind)&&(c.push(ni.NormalKind),o.push("#define NORMAL"),d.nonUniformScaling&&o.push("#define NONUNIFORMSCALING"));var f=null==s?void 0:s.needAlphaTesting(),_=null==s?void 0:s.needAlphaBlending();if(s&&(f||_)){var v=null;if(v=this.useOpacityTextureForTransparentShadow?s.opacityTexture:s.getAlphaTestTexture()){if(!v.isReady())return!1;var g=null!==(r=s.alphaCutOff)&&void 0!==r?r:e.DEFAULT_ALPHA_CUTOFF;o.push("#define ALPHATEXTURE"),f&&o.push("#define ALPHATESTVALUE ".concat(g).concat(g%1===0?".":"")),d.isVerticesDataPresent(ni.UVKind)&&(c.push(ni.UVKind),o.push("#define UV1")),d.isVerticesDataPresent(ni.UV2Kind)&&1===v.coordinatesIndex&&(c.push(ni.UV2Kind),o.push("#define UV2"))}}var m=new Tr;if(d.useBones&&d.computeBonesUsingShaders&&d.skeleton){c.push(ni.MatricesIndicesKind),c.push(ni.MatricesWeightsKind),d.numBoneInfluencers>4&&(c.push(ni.MatricesIndicesExtraKind),c.push(ni.MatricesWeightsExtraKind));var y=d.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+d.numBoneInfluencers),d.numBoneInfluencers>0&&m.addCPUSkinningFallback(0,d),y.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(y.bones.length+1))}else o.push("#define NUM_BONE_INFLUENCERS 0");var T=d.morphTargetManager,E=0;if(T&&T.numInfluencers>0&&(o.push("#define MORPHTARGETS"),E=T.numInfluencers,o.push("#define NUM_MORPH_INFLUENCERS "+E),T.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),An.PrepareAttributesForMorphTargetsInfluencers(c,d,E)),Sn(s,this._scene,o),i&&(o.push("#define INSTANCES"),An.PushAttributesForInstances(c),t.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines){var S,b=(0,p.Z)(this.customShaderOptions.defines);try{for(b.s();!(S=b.n()).done;){var x=S.value;-1===o.indexOf(x)&&o.push(x)}}catch(U){b.e(U)}finally{b.f()}}var M=o.join("\n");if(h!==M){h=M;var A="shadowMap",R=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],C=["diffuseSampler","boneSampler","morphTargets"];if(En(R),this.customShaderOptions){if(A=this.customShaderOptions.shaderName,this.customShaderOptions.attributes){var I,P=(0,p.Z)(this.customShaderOptions.attributes);try{for(P.s();!(I=P.n()).done;){var k=I.value;-1===c.indexOf(k)&&c.push(k)}}catch(U){P.e(U)}finally{P.f()}}if(this.customShaderOptions.uniforms){var D,F=(0,p.Z)(this.customShaderOptions.uniforms);try{for(F.s();!(D=F.n()).done;){var w=D.value;-1===R.indexOf(w)&&R.push(w)}}catch(U){F.e(U)}finally{F.f()}}if(this.customShaderOptions.samplers){var O,L=(0,p.Z)(this.customShaderOptions.samplers);try{for(L.s();!(O=L.n()).done;){var N=O.value;-1===C.indexOf(N)&&C.push(N)}}catch(U){L.e(U)}finally{L.f()}}}var B=this._scene.getEngine();u=B.createEffect(A,{attributes:c,uniformsNames:R,uniformBuffersNames:["Scene","Mesh"],samplers:C,defines:M,fallbacks:m,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:E}},B),l.setEffect(u,h)}if(!u.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}},{key:"prepareDefines",value:function(t,i){var n=this._scene,r=this._light;!n.shadowsEnabled||!r.shadowEnabled||(t["SHADOW"+i]=!0,this.useContactHardeningShadow?(t["SHADOWPCSS"+i]=!0,this._filteringQuality===e.QUALITY_LOW?t["SHADOWLOWQUALITY"+i]=!0:this._filteringQuality===e.QUALITY_MEDIUM&&(t["SHADOWMEDIUMQUALITY"+i]=!0)):this.usePercentageCloserFiltering?(t["SHADOWPCF"+i]=!0,this._filteringQuality===e.QUALITY_LOW?t["SHADOWLOWQUALITY"+i]=!0:this._filteringQuality===e.QUALITY_MEDIUM&&(t["SHADOWMEDIUMQUALITY"+i]=!0)):this.usePoissonSampling?t["SHADOWPOISSON"+i]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?t["SHADOWESM"+i]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(t["SHADOWCLOSEESM"+i]=!0),r.needCube()&&(t["SHADOWCUBE"+i]=!0))}},{key:"bindShadowLight",value:function(t,i){var n=this._light;if(this._scene.shadowsEnabled&&n.shadowEnabled){var r=this._getCamera();if(r){var s=this.getShadowMap();s&&(n.needCube()||i.setMatrix("lightMatrix"+t,this.getTransformMatrix()),this._filter===e.FILTER_PCF?(i.setDepthStencilTexture("shadowSampler"+t,this.getShadowMapForRendering()),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),s.getSize().width,1/s.getSize().width,this.frustumEdgeFalloff,t)):this._filter===e.FILTER_PCSS?(i.setDepthStencilTexture("shadowSampler"+t,this.getShadowMapForRendering()),i.setTexture("depthSampler"+t,this.getShadowMapForRendering()),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/s.getSize().width,this._contactHardeningLightSizeUVRatio*s.getSize().width,this.frustumEdgeFalloff,t)):(i.setTexture("shadowSampler"+t,this.getShadowMapForRendering()),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/s.getSize().width,this.depthScale,this.frustumEdgeFalloff,t)),n._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),t))}}}},{key:"getTransformMatrix",value:function(){var e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;var t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),z.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(z.Dot(this._lightDirection,z.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),Z.LookAtLHToRef(t,t.add(this._lightDirection),z.Up(),this._viewMatrix);var i=this.getShadowMap();if(i){var n=i.renderList;n&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,n)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}},{key:"recreateShadowMap",value:function(){var e=this._shadowMap;if(e){var t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);var i,n=(0,p.Z)(t);try{for(n.s();!(i=n.n()).done;){var r=i.value;this._shadowMap.renderList.push(r)}}catch(s){n.e(s)}finally{n.f()}}else this._shadowMap.renderList=null}}},{key:"_disposeBlurPostProcesses",value:function(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}},{key:"_disposeRTTandPostProcesses",value:function(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}},{key:"_disposeSceneUBOs",value:function(){if(this._sceneUBOs){var e,t=(0,p.Z)(this._sceneUBOs);try{for(t.s();!(e=t.n()).done;){e.value.dispose()}}catch(i){t.e(i)}finally{t.f()}this._sceneUBOs=[]}}},{key:"dispose",value:function(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){for(var e=this._light._shadowGenerators.entries(),t=e.next();!0!==t.done;t=e.next()){var i=(0,_.Z)(t.value,2),n=i[0];i[1]===this&&this._light._shadowGenerators.delete(n)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}},{key:"serialize",value:function(){var e,t={},i=this.getShadowMap();if(!i)return t;if(t.className=this.getClassName(),t.lightId=this._light.id,t.cameraId=null===(e=this._camera)||void 0===e?void 0:e.id,t.id=this.id,t.mapSize=i.getRenderSize(),t.forceBackFacesOnly=this.forceBackFacesOnly,t.darkness=this.getDarkness(),t.transparencyShadow=this._transparencyShadow,t.frustumEdgeFalloff=this.frustumEdgeFalloff,t.bias=this.bias,t.normalBias=this.normalBias,t.usePercentageCloserFiltering=this.usePercentageCloserFiltering,t.useContactHardeningShadow=this.useContactHardeningShadow,t.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,t.filteringQuality=this.filteringQuality,t.useExponentialShadowMap=this.useExponentialShadowMap,t.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,t.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.usePoissonSampling=this.usePoissonSampling,t.depthScale=this.depthScale,t.blurBoxOffset=this.blurBoxOffset,t.blurKernel=this.blurKernel,t.blurScale=this.blurScale,t.useKernelBlur=this.useKernelBlur,t.renderList=[],i.renderList)for(var n=0;n<i.renderList.length;n++){var r=i.renderList[n];t.renderList.push(r.id)}return t}}],[{key:"Parse",value:function(t,i,n){for(var r=i.getLightById(t.lightId),s=void 0!==t.cameraId?i.getCameraById(t.cameraId):null,a=n?n(t.mapSize,r,s):new e(t.mapSize,r,void 0,s),o=a.getShadowMap(),l=0;l<t.renderList.length;l++)i.getMeshesById(t.renderList[l]).forEach((function(e){o&&(o.renderList||(o.renderList=[]),o.renderList.push(e))}));return void 0!==t.id&&(a.id=t.id),a.forceBackFacesOnly=!!t.forceBackFacesOnly,void 0!==t.darkness&&a.setDarkness(t.darkness),t.transparencyShadow&&a.setTransparencyShadow(!0),void 0!==t.frustumEdgeFalloff&&(a.frustumEdgeFalloff=t.frustumEdgeFalloff),void 0!==t.bias&&(a.bias=t.bias),void 0!==t.normalBias&&(a.normalBias=t.normalBias),t.usePercentageCloserFiltering?a.usePercentageCloserFiltering=!0:t.useContactHardeningShadow?a.useContactHardeningShadow=!0:t.usePoissonSampling?a.usePoissonSampling=!0:t.useExponentialShadowMap?a.useExponentialShadowMap=!0:t.useBlurExponentialShadowMap?a.useBlurExponentialShadowMap=!0:t.useCloseExponentialShadowMap?a.useCloseExponentialShadowMap=!0:t.useBlurCloseExponentialShadowMap?a.useBlurCloseExponentialShadowMap=!0:t.useVarianceShadowMap?a.useExponentialShadowMap=!0:t.useBlurVarianceShadowMap&&(a.useBlurExponentialShadowMap=!0),void 0!==t.contactHardeningLightSizeUVRatio&&(a.contactHardeningLightSizeUVRatio=t.contactHardeningLightSizeUVRatio),void 0!==t.filteringQuality&&(a.filteringQuality=t.filteringQuality),t.depthScale&&(a.depthScale=t.depthScale),t.blurScale&&(a.blurScale=t.blurScale),t.blurBoxOffset&&(a.blurBoxOffset=t.blurBoxOffset),t.useKernelBlur&&(a.useKernelBlur=t.useKernelBlur),t.blurKernel&&(a.blurKernel=t.blurKernel),a}}]),e}();Er.CLASSNAME="ShadowGenerator",Er.FILTER_NONE=0,Er.FILTER_EXPONENTIALSHADOWMAP=1,Er.FILTER_POISSONSAMPLING=2,Er.FILTER_BLUREXPONENTIALSHADOWMAP=3,Er.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,Er.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,Er.FILTER_PCF=6,Er.FILTER_PCSS=7,Er.QUALITY_HIGH=0,Er.QUALITY_MEDIUM=1,Er.QUALITY_LOW=2,Er.DEFAULT_ALPHA_CUTOFF=.5,Er._SceneComponentInitialization=function(e){throw le("ShadowGeneratorSceneComponent")};xe.ShadersStore.depthPixelShader="#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying float vDepthMetric;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\ngl_FragColor=pack(gl_FragCoord.z);\n#else\ngl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\ngl_FragColor=pack(vDepthMetric);\n#else\ngl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n}";xe.IncludesShadersStore.instancesDeclaration="#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#ifdef INSTANCESCOLOR\nattribute vec4 instanceColor;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nattribute vec4 previousWorld0;\nattribute vec4 previousWorld1;\nattribute vec4 previousWorld2;\nattribute vec4 previousWorld3;\n#ifdef THIN_INSTANCES\nuniform mat4 previousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nuniform mat4 previousWorld;\n#endif\n#endif\n";xe.ShadersStore.depthVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nuniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvarying float vDepthMetric;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\ngl_Position=viewProjection*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));\n#else\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}\n";var Sr=function(){function e(t){var i=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ar.TRILINEAR_SAMPLINGMODE;(0,m.Z)(this,e),this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this._scene=t,this._storeNonLinearDepth=s,this.isPacked=0===n,this.isPacked?this._clearColor=new Ke(1,1,1,1):this._clearColor=new Ke(1,0,0,1),e._SceneComponentInitialization(this._scene);var o=t.getEngine();this._camera=r,a!==ar.NEAREST_SAMPLINGMODE&&(1===n&&!o._caps.textureFloatLinearFiltering&&(a=ar.NEAREST_SAMPLINGMODE),2===n&&!o._caps.textureHalfFloatLinearFiltering&&(a=ar.NEAREST_SAMPLINGMODE));var l=this.isPacked||!o._features.supportExtendedTextureFormats?5:6;this._depthMap=new pr("DepthRenderer",{width:o.getRenderWidth(),height:o.getRenderHeight()},this._scene,!1,!0,n,!1,a,void 0,void 0,void 0,l),this._depthMap.wrapU=ar.CLAMP_ADDRESSMODE,this._depthMap.wrapV=ar.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add((function(e){e.clear(i._clearColor,!0,!0,!0)})),this._depthMap.onBeforeBindObservable.add((function(){var e;null===(e=o._debugPushGroup)||void 0===e||e.call(o,"depth renderer",1)})),this._depthMap.onAfterUnbindObservable.add((function(){var e;null===(e=o._debugPopGroup)||void 0===e||e.call(o,1)})),this._depthMap.customIsReadyFunction=function(e,t,n){if((n||0===t)&&e.subMeshes)for(var r=0;r<e.subMeshes.length;++r){var s=e.subMeshes[r],a=s.getRenderingMesh(),l=a._getInstancesRenderList(s._id,!!s.getReplacementMesh()),u=o.getCaps().instancedArrays&&(null!==l.visibleInstances[s._id]&&void 0!==l.visibleInstances[s._id]||a.hasThinInstances);if(!i.isReady(s,u))return!1}return!0};var u=function(e){var t,n,r=e.getRenderingMesh(),s=e.getEffectiveMesh(),a=i._scene,o=a.getEngine(),l=e.getMaterial();if(s._internalAbstractMeshDataInfo._isActiveIntermediate=!1,l&&!s.infiniteDistance&&!l.disableDepthWrite&&0!==e.verticesCount&&e._renderId!==a.getRenderId()){var u=s._getWorldMatrixDeterminant()<0,h=null!==(t=r.overrideMaterialSideOrientation)&&void 0!==t?t:l.sideOrientation;u&&(h=0===h?1:0);var c=0===h;o.setState(l.backFaceCulling,0,!1,c,l.cullBackFaces);var d=r._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(!d.mustReturn){var f=o.getCaps().instancedArrays&&(null!==d.visibleInstances[e._id]&&void 0!==d.visibleInstances[e._id]||r.hasThinInstances),_=i._camera||a.activeCamera;if(i.isReady(e,f)&&_){e._renderId=a.getRenderId();var v=null===(n=s._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===n?void 0:n[o.currentRenderPassId],g=e._getDrawWrapper();!g&&v&&(g=v._getDrawWrapper());var p=_.mode===ji.ORTHOGRAPHIC_CAMERA;if(!g)return;var m,y,T=g.effect;if(o.enableEffect(g),f||r._bind(e,T,l.fillMode),v?v.bindForSubMesh(s.getWorldMatrix(),s,e):(T.setMatrix("viewProjection",a.getTransformMatrix()),T.setMatrix("world",s.getWorldMatrix())),p?(m=!o.useReverseDepthBuffer&&o.isNDCHalfZRange?0:1,y=o.useReverseDepthBuffer&&o.isNDCHalfZRange?0:1):(m=o.useReverseDepthBuffer&&o.isNDCHalfZRange?_.minZ:o.isNDCHalfZRange?0:_.minZ,y=o.useReverseDepthBuffer&&o.isNDCHalfZRange?0:_.maxZ),T.setFloat2("depthValues",m,m+y),!v){if(l.needAlphaTesting()){var E=l.getAlphaTestTexture();E&&(T.setTexture("diffuseSampler",E),T.setMatrix("diffuseMatrix",E.getTextureMatrix()))}if(r.useBones&&r.computeBonesUsingShaders&&r.skeleton){var S=r.skeleton;if(S.isUsingTextureForMatrices){var b=S.getTransformMatrixTexture(r);if(!b)return;T.setTexture("boneSampler",b),T.setFloat("boneTextureWidth",4*(S.bones.length+1))}else T.setMatrices("mBones",S.getTransformMatrices(r))}bn(T,l,a),An.BindMorphTargetParameters(r,T),r.morphTargetManager&&r.morphTargetManager.isUsingTextureForTargets&&r.morphTargetManager._bind(T)}r._processRendering(s,e,T,l.fillMode,d,f,(function(e,t){return T.setMatrix("world",t)}))}}}};this._depthMap.customRenderFunction=function(e,t,n,r){var s;if(r.length)for(s=0;s<r.length;s++)u(r.data[s]);for(s=0;s<e.length;s++)u(e.data[s]);for(s=0;s<t.length;s++)u(t.data[s]);if(i.forceDepthWriteTransparentMeshes)for(s=0;s<n.length;s++)u(n.data[s]);else for(s=0;s<n.length;s++)n.data[s].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}return(0,y.Z)(e,[{key:"setMaterialForRendering",value:function(e,t){this._depthMap.setMaterialForRendering(e,t)}},{key:"isReady",value:function(e,t){var i,n=this._scene.getEngine(),r=e.getMesh(),s=r.getScene(),a=null===(i=r._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===i?void 0:i[n.currentRenderPassId];if(a)return a.isReadyForSubMesh(r,e,t);var o=e.getMaterial();if(!o||o.disableDepthWrite)return!1;var l=[],u=[ni.PositionKind];if(o&&o.needAlphaTesting()&&o.getAlphaTestTexture()&&(l.push("#define ALPHATEST"),r.isVerticesDataPresent(ni.UVKind)&&(u.push(ni.UVKind),l.push("#define UV1")),r.isVerticesDataPresent(ni.UV2Kind)&&(u.push(ni.UV2Kind),l.push("#define UV2"))),r.useBones&&r.computeBonesUsingShaders){u.push(ni.MatricesIndicesKind),u.push(ni.MatricesWeightsKind),r.numBoneInfluencers>4&&(u.push(ni.MatricesIndicesExtraKind),u.push(ni.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),l.push("#define BonesPerMesh "+(r.skeleton?r.skeleton.bones.length+1:0));var h=e.getRenderingMesh().skeleton;null!=h&&h.isUsingTextureForMatrices&&l.push("#define BONETEXTURE")}else l.push("#define NUM_BONE_INFLUENCERS 0");var c=r.morphTargetManager,d=0;c&&c.numInfluencers>0&&(d=c.numInfluencers,l.push("#define MORPHTARGETS"),l.push("#define NUM_MORPH_INFLUENCERS "+d),c.isUsingTextureForTargets&&l.push("#define MORPHTARGETS_TEXTURE"),An.PrepareAttributesForMorphTargetsInfluencers(u,r,d)),t&&(l.push("#define INSTANCES"),An.PushAttributesForInstances(u),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&l.push("#define NONLINEARDEPTH"),this.isPacked&&l.push("#define PACKED"),Sn(o,s,l);var f=e._getDrawWrapper(void 0,!0),_=f.defines,v=l.join("\n");if(_!==v){var g=["world","mBones","boneTextureWidth","viewProjection","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];En(g),f.setEffect(n.createEffect("depth",u,g,["diffuseSampler","morphTargets","boneSampler"],v,void 0,void 0,void 0,{maxSimultaneousMorphTargets:d}),v)}return f.effect.isReady()}},{key:"getDepthMap",value:function(){return this._depthMap}},{key:"dispose",value:function(){var e=[];for(var t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0){this._depthMap.dispose();var i,n=(0,p.Z)(e);try{for(n.s();!(i=n.n()).done;){var r=i.value;delete this._scene._depthRenderer[r]}}catch(s){n.e(s)}finally{n.f()}}}}]),e}();Sr._SceneComponentInitialization=function(e){throw le("DepthRendererSceneComponent")};xe.ShadersStore.minmaxReduxPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#if defined(INITIAL)\nuniform sampler2D sourceTexture;\nuniform vec2 texSize;\nvoid main(void)\n{\nivec2 coord=ivec2(vUV*(texSize-1.0));\nfloat f1=texelFetch(sourceTexture,coord,0).r;\nfloat f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;\nfloat f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;\nfloat f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;\nfloat minz=min(min(min(f1,f2),f3),f4);\n#ifdef DEPTH_REDUX\nfloat maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);\n#else\nfloat maxz=max(max(max(f1,f2),f3),f4);\n#endif\nglFragColor=vec4(minz,maxz,0.,0.);\n}\n#elif defined(MAIN)\nuniform vec2 texSize;\nvoid main(void)\n{\nivec2 coord=ivec2(vUV*(texSize-1.0));\nvec2 f1=texelFetch(textureSampler,coord,0).rg;\nvec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;\nvec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;\nvec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;\nfloat minz=min(min(min(f1.x,f2.x),f3.x),f4.x);\nfloat maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);\nglFragColor=vec4(minz,maxz,0.,0.);\n}\n#elif defined(ONEBEFORELAST)\nuniform ivec2 texSize;\nvoid main(void)\n{\nivec2 coord=ivec2(vUV*vec2(texSize-1));\nvec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;\nvec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;\nvec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;\nvec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;\nfloat minz=min(f1.x,f2.x);\nfloat maxz=max(f1.y,f2.y);\nglFragColor=vec4(minz,maxz,0.,0.);\n}\n#elif defined(LAST)\nvoid main(void)\n{\nglFragColor=vec4(0.);\nif (true) { \ndiscard;\n}\n}\n#endif\n";var br=function(){function e(t){var i=this;(0,m.Z)(this,e),this.onAfterReductionPerformed=new ee,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=t,this._postProcessManager=new ai(t.getScene()),this._onContextRestoredObserver=t.getEngine().onContextRestoredObservable.add((function(){i._postProcessManager._rebuild()}))}return(0,y.Z)(e,[{key:"sourceTexture",get:function(){return this._sourceTexture}},{key:"setSourceTexture",value:function(e,t){var i=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(e!==this._sourceTexture){this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=r;var s=this._camera.getScene(),a=new mr("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,s.getEngine(),!1,"#define INITIAL"+(t?"\n#define DEPTH_REDUX":""),n,void 0,void 0,void 0,7);a.autoClear=!1,a.forceFullscreenViewport=r;var o=this._sourceTexture.getRenderWidth(),l=this._sourceTexture.getRenderHeight();a.onApply=function(e,t){return function(n){n.setTexture("sourceTexture",i._sourceTexture),n.setFloat2("texSize",e,t)}}(o,l),this._reductionSteps.push(a);for(var u=1;o>1||l>1;){o=Math.max(Math.round(o/2),1),l=Math.max(Math.round(l/2),1);var h=new mr("Reduction phase "+u,"minmaxRedux",["texSize"],null,{width:o,height:l},null,1,s.getEngine(),!1,"#define "+(1==o&&1==l?"LAST":1==o||1==l?"ONEBEFORELAST":"MAIN"),n,void 0,void 0,void 0,7);if(h.autoClear=!1,h.forceFullscreenViewport=r,h.onApply=function(e,t){return function(i){1==e||1==t?i.setInt2("texSize",e,t):i.setFloat2("texSize",e,t)}}(o,l),this._reductionSteps.push(h),u++,1==o&&1==l){h.onAfterRenderObservable.add(function(e,t,n){var r=new Float32Array(4*e*t),a={min:0,max:0};return function(){s.getEngine()._readTexturePixels(n.inputTexture.texture,e,t,-1,0,r,!1),a.min=r[0],a.max=r[1],i.onAfterReductionPerformed.notifyObservers(a)}}(o,l,h))}}}}},{key:"refreshRate",get:function(){return this._sourceTexture?this._sourceTexture.refreshRate:-1},set:function(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}},{key:"activated",get:function(){return this._activated}},{key:"activate",value:function(){var e=this;this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add((function(){var t,i,n=e._camera.getScene().getEngine();null===(t=n._debugPushGroup)||void 0===t||t.call(n,"min max reduction",1),e._reductionSteps[0].activate(e._camera),e._postProcessManager.directRender(e._reductionSteps,e._reductionSteps[0].inputTexture,e._forceFullscreenViewport),n.unBindFramebuffer(e._reductionSteps[0].inputTexture,!1),null===(i=n._debugPopGroup)||void 0===i||i.call(n,1)})),this._activated=!0)}},{key:"deactivate",value:function(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}},{key:"dispose",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(var t=0;t<this._reductionSteps.length;++t)this._reductionSteps[t].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}]),e}(),xr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e){return(0,m.Z)(this,i),t.call(this,e)}return(0,y.Z)(i,[{key:"depthRenderer",get:function(){return this._depthRenderer}},{key:"setDepthRenderer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=this._camera.getScene();this._depthRenderer&&(delete r._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),null===e&&(r._depthRenderer||(r._depthRenderer={}),(e=this._depthRenderer=new Sr(r,t,this._camera,!1,1)).enabled=!1,this._depthRendererId="minmax"+this._camera.id,r._depthRenderer[this._depthRendererId]=e),c((0,h.Z)(i.prototype),"setSourceTexture",this).call(this,e.getDepthMap(),!0,t,n)}},{key:"setSourceTexture",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];c((0,h.Z)(i.prototype),"setSourceTexture",this).call(this,e,t,n,r)}},{key:"activate",value:function(){this._depthRenderer&&(this._depthRenderer.enabled=!0),c((0,h.Z)(i.prototype),"activate",this).call(this)}},{key:"deactivate",value:function(){c((0,h.Z)(i.prototype),"deactivate",this).call(this),this._depthRenderer&&(this._depthRenderer.enabled=!1)}},{key:"dispose",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(c((0,h.Z)(i.prototype),"dispose",this).call(this,e),this._depthRenderer&&e){var t=this._depthRenderer.getDepthMap().getScene();t&&delete t._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}]),i}(br),Mr=z.Up(),Ar=z.Zero(),Rr=new z,Cr=new z,Ir=new Z,Pr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n,r,s){var a;return(0,m.Z)(this,i),i.IsSupported?((a=t.call(this,e,n,r,s)).usePercentageCloserFiltering=!0,a):(ue.Error("CascadedShadowMap is not supported by the current engine."),(0,l.Z)(a))}return(0,y.Z)(i,[{key:"_validateFilter",value:function(e){return e===Er.FILTER_NONE||e===Er.FILTER_PCF||e===Er.FILTER_PCSS?e:(console.error('Unsupported filter "'+e+'"!'),Er.FILTER_NONE)}},{key:"numCascades",get:function(){return this._numCascades},set:function(e){(e=Math.min(Math.max(e,i.MIN_CASCADES_COUNT),i.MAX_CASCADES_COUNT))!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}},{key:"freezeShadowCastersBoundingInfo",get:function(){return this._freezeShadowCastersBoundingInfo},set:function(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!e&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(this._computeShadowCastersBoundingInfo.bind(this))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}},{key:"_computeShadowCastersBoundingInfo",value:function(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._shadowMap&&this._shadowMap.renderList){for(var e=this._shadowMap.renderList,t=0;t<e.length;t++){var i=e[t];if(i){var n=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(n.minimumWorld),this._scbiMax.maximizeInPlace(n.maximumWorld)}}for(var r=this._scene.meshes,s=0;s<r.length;s++){var a=r[s];if(a&&a.isVisible&&a.isEnabled&&a.receiveShadows){var o=a.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(o.minimumWorld),this._scbiMax.maximizeInPlace(o.maximumWorld)}}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}},{key:"shadowCastersBoundingInfo",get:function(){return this._shadowCastersBoundingInfo},set:function(e){this._shadowCastersBoundingInfo=e}},{key:"setMinMaxDistance",value:function(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}},{key:"minDistance",get:function(){return this._minDistance}},{key:"maxDistance",get:function(){return this._maxDistance}},{key:"getClassName",value:function(){return i.CLASSNAME}},{key:"getCascadeMinExtents",value:function(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}},{key:"getCascadeMaxExtents",value:function(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}},{key:"shadowMaxZ",get:function(){return this._getCamera()?this._shadowMaxZ:0},set:function(e){var t=this._getCamera();t?this._shadowMaxZ===e||e<t.minZ||e>t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0):this._shadowMaxZ=e}},{key:"debug",get:function(){return this._debug},set:function(e){this._debug=e,this._light._markMeshesAsLightDirty()}},{key:"depthClamp",get:function(){return this._depthClamp},set:function(e){this._depthClamp=e}},{key:"cascadeBlendPercentage",get:function(){return this._cascadeBlendPercentage},set:function(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}},{key:"lambda",get:function(){return this._lambda},set:function(e){var t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}},{key:"getCascadeViewMatrix",value:function(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}},{key:"getCascadeProjectionMatrix",value:function(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}},{key:"getCascadeTransformMatrix",value:function(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}},{key:"setDepthRenderer",value:function(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}},{key:"autoCalcDepthBounds",get:function(){return this._autoCalcDepthBounds},set:function(e){var t=this,i=this._getCamera();if(i){if(this._autoCalcDepthBounds=e,!e)return this._depthReducer&&this._depthReducer.deactivate(),void this.setMinMaxDistance(0,1);this._depthReducer||(this._depthReducer=new xr(i),this._depthReducer.onAfterReductionPerformed.add((function(e){var i=e.min,n=e.max;i>=n&&(i=0,n=1),(i!=t._minDistance||n!=t._maxDistance)&&t.setMinMaxDistance(i,n)})),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}},{key:"autoCalcDepthBoundsRefreshRate",get:function(){var e,t,i;return null!==(i=null===(t=null===(e=this._depthReducer)||void 0===e?void 0:e.depthRenderer)||void 0===t?void 0:t.getDepthMap().refreshRate)&&void 0!==i?i:-1},set:function(e){var t;null!==(t=this._depthReducer)&&void 0!==t&&t.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}},{key:"splitFrustum",value:function(){this._breaksAreDirty=!0}},{key:"_splitFrustum",value:function(){var e=this._getCamera();if(e){for(var t=e.minZ,i=e.maxZ,n=i-t,r=this._minDistance,s=t+r*n,a=t+(this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance)*n,o=a-s,l=a/s,u=0;u<this._cascades.length;++u){var h=(u+1)/this._numCascades,c=s*Math.pow(l,h),d=s+o*h,f=this._lambda*(c-d)+d;this._cascades[u].prevBreakDistance=0===u?r:this._cascades[u-1].breakDistance,this._cascades[u].breakDistance=(f-t)/n,this._viewSpaceFrustumsZ[u]=f,this._frustumLengths[u]=(this._cascades[u].breakDistance-this._cascades[u].prevBreakDistance)*n}this._breaksAreDirty=!1}}},{key:"_computeMatrices",value:function(){var e=this._scene;if(this._getCamera()){z.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),1===Math.abs(z.Dot(this._lightDirection,z.Up()))&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);for(var t=e.getEngine().useReverseDepthBuffer,i=0;i<this._numCascades;++i){this._computeFrustumInWorldSpace(i),this._computeCascadeFrustum(i),this._cascadeMaxExtents[i].subtractToRef(this._cascadeMinExtents[i],Rr),this._frustumCenter[i].addToRef(this._lightDirection.scale(this._cascadeMinExtents[i].z),this._shadowCameraPos[i]),Z.LookAtLHToRef(this._shadowCameraPos[i],this._frustumCenter[i],Mr,this._viewMatrices[i]);var n=0,r=Rr.z,s=this._shadowCastersBoundingInfo;s.update(this._viewMatrices[i]),r=Math.min(r,s.boundingBox.maximumWorld.z),n=this._depthClamp&&this.filter!==Er.FILTER_PCSS?Math.max(n,s.boundingBox.minimumWorld.z):Math.min(n,s.boundingBox.minimumWorld.z),Z.OrthoOffCenterLHToRef(this._cascadeMinExtents[i].x,this._cascadeMaxExtents[i].x,this._cascadeMinExtents[i].y,this._cascadeMaxExtents[i].y,t?r:n,t?n:r,this._projectionMatrices[i],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[i].z=n,this._cascadeMaxExtents[i].z=r,this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),z.TransformCoordinatesToRef(Ar,this._transformMatrices[i],Rr),Rr.scaleInPlace(this._mapSize/2),Cr.copyFromFloats(Math.round(Rr.x),Math.round(Rr.y),Math.round(Rr.z)),Cr.subtractInPlace(Rr).scaleInPlace(2/this._mapSize),Z.TranslationToRef(Cr.x,Cr.y,0,Ir),this._projectionMatrices[i].multiplyToRef(Ir,this._projectionMatrices[i]),this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),this._transformMatrices[i].copyToArray(this._transformMatricesAsArray,16*i)}}}},{key:"_computeFrustumInWorldSpace",value:function(e){var t=this._getCamera();if(t){var n=this._cascades[e].prevBreakDistance,r=this._cascades[e].breakDistance,s=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();for(var a=Z.Invert(t.getTransformationMatrix()),o=this._scene.getEngine().useReverseDepthBuffer?4:0,l=0;l<i._FrustumCornersNDCSpace.length;++l)Rr.copyFrom(i._FrustumCornersNDCSpace[(l+o)%i._FrustumCornersNDCSpace.length]),s&&-1===Rr.z&&(Rr.z=0),z.TransformCoordinatesToRef(Rr,a,this._frustumCornersWorldSpace[e][l]);for(var u=0;u<i._FrustumCornersNDCSpace.length/2;++u)Rr.copyFrom(this._frustumCornersWorldSpace[e][u+4]).subtractInPlace(this._frustumCornersWorldSpace[e][u]),Cr.copyFrom(Rr).scaleInPlace(n),Rr.scaleInPlace(r),Rr.addInPlace(this._frustumCornersWorldSpace[e][u]),this._frustumCornersWorldSpace[e][u+4].copyFrom(Rr),this._frustumCornersWorldSpace[e][u].addInPlace(Cr)}}},{key:"_computeCascadeFrustum",value:function(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),this._getCamera()){for(var t=0;t<this._frustumCornersWorldSpace[e].length;++t)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][t]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){for(var i=0,n=0;n<this._frustumCornersWorldSpace[e].length;++n){var r=this._frustumCornersWorldSpace[e][n].subtractToRef(this._frustumCenter[e],Rr).length();i=Math.max(i,r)}i=Math.ceil(16*i)/16,this._cascadeMaxExtents[e].copyFromFloats(i,i,i),this._cascadeMinExtents[e].copyFromFloats(-i,-i,-i)}else{var s=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,Rr),Z.LookAtLHToRef(s,Rr,Mr,Ir);for(var a=0;a<this._frustumCornersWorldSpace[e].length;++a)z.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][a],Ir,Rr),this._cascadeMinExtents[e].minimizeInPlace(Rr),this._cascadeMaxExtents[e].maximizeInPlace(Rr)}}}},{key:"_recreateSceneUBOs",value:function(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(var e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer('Scene for CSM Shadow Generator (light "'.concat(this._light.name,'" cascade #').concat(e,")")))}},{key:"_initializeGenerator",value:function(){var e,t,n,r,s,a,o,l,u,d,f,_,v,g,p,m,y,T,E,S;this.penumbraDarkness=null!==(e=this.penumbraDarkness)&&void 0!==e?e:1,this._numCascades=null!==(t=this._numCascades)&&void 0!==t?t:i.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=null!==(n=this.stabilizeCascades)&&void 0!==n&&n,this._freezeShadowCastersBoundingInfoObservable=null!==(r=this._freezeShadowCastersBoundingInfoObservable)&&void 0!==r?r:null,this.freezeShadowCastersBoundingInfo=null!==(s=this.freezeShadowCastersBoundingInfo)&&void 0!==s&&s,this._scbiMin=null!==(a=this._scbiMin)&&void 0!==a?a:new z(0,0,0),this._scbiMax=null!==(o=this._scbiMax)&&void 0!==o?o:new z(0,0,0),this._shadowCastersBoundingInfo=null!==(l=this._shadowCastersBoundingInfo)&&void 0!==l?l:new an(new z(0,0,0),new z(0,0,0)),this._breaksAreDirty=null===(u=this._breaksAreDirty)||void 0===u||u,this._minDistance=null!==(d=this._minDistance)&&void 0!==d?d:0,this._maxDistance=null!==(f=this._maxDistance)&&void 0!==f?f:1,this._currentLayer=null!==(_=this._currentLayer)&&void 0!==_?_:0,this._shadowMaxZ=null!==(p=null!==(v=this._shadowMaxZ)&&void 0!==v?v:null===(g=this._getCamera())||void 0===g?void 0:g.maxZ)&&void 0!==p?p:1e4,this._debug=null!==(m=this._debug)&&void 0!==m&&m,this._depthClamp=null===(y=this._depthClamp)||void 0===y||y,this._cascadeBlendPercentage=null!==(T=this._cascadeBlendPercentage)&&void 0!==T?T:.1,this._lambda=null!==(E=this._lambda)&&void 0!==E?E:.5,this._autoCalcDepthBounds=null!==(S=this._autoCalcDepthBounds)&&void 0!==S&&S,this._recreateSceneUBOs(),c((0,h.Z)(i.prototype),"_initializeGenerator",this).call(this)}},{key:"_createTargetRenderTexture",value:function(){var e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new pr(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)}},{key:"_initializeShadowMap",value:function(){var e=this;if(c((0,h.Z)(i.prototype),"_initializeShadowMap",this).call(this),null!==this._shadowMap){this._transformMatricesAsArray=new Float32Array(16*this._numCascades),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(2*this._numCascades),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(var t=0;t<this._numCascades;++t){this._cascades[t]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[t]=Z.Zero(),this._projectionMatrices[t]=Z.Zero(),this._transformMatrices[t]=Z.Zero(),this._cascadeMinExtents[t]=new z,this._cascadeMaxExtents[t]=new z,this._frustumCenter[t]=new z,this._shadowCameraPos[t]=new z,this._frustumCornersWorldSpace[t]=new Array(i._FrustumCornersNDCSpace.length);for(var n=0;n<i._FrustumCornersNDCSpace.length;++n)this._frustumCornersWorldSpace[t][n]=new z}var r=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add((function(t){e._sceneUBOs&&e._scene.setSceneUniformBuffer(e._sceneUBOs[t]),e._currentLayer=t,e._filter===Er.FILTER_PCF&&r.setColorWrite(!1),e._scene.setTransformMatrix(e.getCascadeViewMatrix(t),e.getCascadeProjectionMatrix(t)),e._useUBO&&(e._scene.getSceneUniformBuffer().unbindEffect(),e._scene.finalizeSceneUbo())})),this._shadowMap.onBeforeBindObservable.add((function(){var t;e._currentSceneUBO=e._scene.getSceneUniformBuffer(),null===(t=r._debugPushGroup)||void 0===t||t.call(r,"cascaded shadow map generation for pass id ".concat(r.currentRenderPassId),1),e._breaksAreDirty&&e._splitFrustum(),e._computeMatrices()})),this._splitFrustum()}}},{key:"_bindCustomEffectForRenderSubMeshForShadowMap",value:function(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}},{key:"_isReadyCustomDefines",value:function(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==Er.FILTER_PCSS?"1":"0"))}},{key:"prepareDefines",value:function(e,t){c((0,h.Z)(i.prototype),"prepareDefines",this).call(this,e,t);var n=this._scene,r=this._light;if(n.shadowsEnabled&&r.shadowEnabled){e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=n.useRightHandedSystem;var s=this._getCamera();s&&this._shadowMaxZ<s.maxZ&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),0===this.cascadeBlendPercentage&&(e["SHADOWCSMNOBLEND"+t]=!0)}}},{key:"bindShadowLight",value:function(e,t){var i=this._light;if(this._scene.shadowsEnabled&&i.shadowEnabled){var n=this._getCamera();if(n){var r=this.getShadowMap();if(r){var s=r.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===Er.FILTER_PCF)t.setDepthStencilTexture("shadowSampler"+e,r),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),s,1/s,this.frustumEdgeFalloff,e);else if(this._filter===Er.FILTER_PCSS){for(var a=0;a<this._numCascades;++a)this._lightSizeUVCorrection[2*a+0]=0===a?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[a].x-this._cascadeMinExtents[a].x),this._lightSizeUVCorrection[2*a+1]=0===a?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[a].y-this._cascadeMinExtents[a].y),this._depthCorrection[a]=0===a?1:(this._cascadeMaxExtents[a].z-this._cascadeMinExtents[a].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowSampler"+e,r),t.setTexture("depthSampler"+e,r),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/s,this._contactHardeningLightSizeUVRatio*s,this.frustumEdgeFalloff,e)}else t.setTexture("shadowSampler"+e,r),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),s,1/s,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(n),this.getLight().getDepthMinZ(n)+this.getLight().getDepthMaxZ(n),e)}}}}},{key:"getTransformMatrix",value:function(){return this.getCascadeTransformMatrix(0)}},{key:"dispose",value:function(){c((0,h.Z)(i.prototype),"dispose",this).call(this),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}},{key:"serialize",value:function(){var e=c((0,h.Z)(i.prototype),"serialize",this).call(this),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(var n=0;n<t.renderList.length;n++){var r=t.renderList[n];e.renderList.push(r.id)}return e}}],[{key:"IsSupported",get:function(){var e=V.LastCreatedEngine;return!!e&&e._features.supportCSM}},{key:"Parse",value:function(e,t){var n=Er.Parse(e,t,(function(e,t,n){return new i(e,t,void 0,n)}));return void 0!==e.numCascades&&(n.numCascades=e.numCascades),void 0!==e.debug&&(n.debug=e.debug),void 0!==e.stabilizeCascades&&(n.stabilizeCascades=e.stabilizeCascades),void 0!==e.lambda&&(n.lambda=e.lambda),void 0!==e.cascadeBlendPercentage&&(n.cascadeBlendPercentage=e.cascadeBlendPercentage),void 0!==e.depthClamp&&(n.depthClamp=e.depthClamp),void 0!==e.autoCalcDepthBounds&&(n.autoCalcDepthBounds=e.autoCalcDepthBounds),void 0!==e.shadowMaxZ&&(n.shadowMaxZ=e.shadowMaxZ),void 0!==e.penumbraDarkness&&(n.penumbraDarkness=e.penumbraDarkness),void 0!==e.freezeShadowCastersBoundingInfo&&(n.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),void 0!==e.minDistance&&void 0!==e.maxDistance&&n.setMinMaxDistance(e.minDistance,e.maxDistance),n}}]),i}(Er);Pr._FrustumCornersNDCSpace=[new z(-1,1,-1),new z(1,1,-1),new z(1,-1,-1),new z(-1,-1,-1),new z(-1,1,1),new z(1,1,1),new z(1,-1,1),new z(-1,-1,1)],Pr.CLASSNAME="CascadedShadowGenerator",Pr.DEFAULT_CASCADES_COUNT=4,Pr.MIN_CASCADES_COUNT=2,Pr.MAX_CASCADES_COUNT=4,Pr._SceneComponentInitialization=function(e){throw le("ShadowGeneratorSceneComponent")},Lt.AddParser(hi.NAME_SHADOWGENERATOR,(function(e,t){if(void 0!==e.shadowGenerators&&null!==e.shadowGenerators)for(var i=0,n=e.shadowGenerators.length;i<n;i++){var r=e.shadowGenerators[i];r.className===Pr.CLASSNAME?Pr.Parse(r,t):Er.Parse(r,t)}}));var kr=function(){function e(t){(0,m.Z)(this,e),this.name=hi.NAME_SHADOWGENERATOR,this.scene=t}return(0,y.Z)(e,[{key:"register",value:function(){this.scene._gatherRenderTargetsStage.registerStep(hi.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}},{key:"rebuild",value:function(){}},{key:"serialize",value:function(e){e.shadowGenerators=[];var t,i=this.scene.lights,n=(0,p.Z)(i);try{for(n.s();!(t=n.n()).done;){var r=t.value.getShadowGenerators();if(r)for(var s=r.values(),a=s.next();!0!==a.done;a=s.next()){var o=a.value;e.shadowGenerators.push(o.serialize())}}}catch(l){n.e(l)}finally{n.f()}}},{key:"addFromContainer",value:function(e){}},{key:"removeFromContainer",value:function(e,t){}},{key:"dispose",value:function(){}},{key:"_gatherRenderTargets",value:function(e){var t=this.scene;if(this.scene.shadowsEnabled)for(var i=0;i<t.lights.length;i++){var n=t.lights[i],r=n.getShadowGenerators();if(n.isEnabled()&&n.shadowEnabled&&r)for(var s=r.values(),a=s.next();!0!==a.done;a=s.next()){var o=a.value.getShadowMap();-1!==t.textures.indexOf(o)&&e.push(o)}}}}]),e}();Er._SceneComponentInitialization=function(e){var t=e._getComponent(hi.NAME_SHADOWGENERATOR);t||(t=new kr(e),e._addComponent(t))};var Dr={enableShadows:!0};function Fr(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Dr,t=e.enableShadows,i=e.shadowTransparency,n=e.intensity,r=e.scene,s=new er("DirectionalLight",new z(-.3,-1,.4),r);s.position=new z(-50,65,-50),s.intensity=.65*n;var a=new tr("HemisphericLight",new z(1,1,0),r);return a.intensity=.4*n,t&&(s.shadowMinZ=1,s.shadowMaxZ=70,s.shadowGenerator=new Er(2048,s),s.shadowGenerator.useCloseExponentialShadowMap=!0,s.shadowGenerator.darkness=i),{directional:s,hemispheric:a}}function wr(e){var t,i=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],n=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],r=[],s=e.width||e.size||1,a=e.height||e.size||1,o=e.depth||e.size||1,l=e.wrap||!1,u=void 0===e.topBaseAt?1:e.topBaseAt,h=void 0===e.bottomBaseAt?0:e.bottomBaseAt,c=[2,0,3,1][u=(u+4)%4],d=[2,0,1,3][h=(h+4)%4],f=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(l){i=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],f=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];for(var _=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],v=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]],g=[17,18,19,16],p=[22,23,20,21];c>0;)_.unshift(_.pop()),g.unshift(g.pop()),c--;for(;d>0;)v.unshift(v.pop()),p.unshift(p.pop()),d--;_=_.flat(),v=v.flat(),f=f.concat(_).concat(v),i.push(g[0],g[2],g[3],g[0],g[1],g[2]),i.push(p[0],p[2],p[3],p[0],p[1],p[2])}var m=[s/2,a/2,o/2];t=f.reduce((function(e,t,i){return e.concat(t*m[i%3])}),[]);for(var y=0===e.sideOrientation?0:e.sideOrientation||Qi.DEFAULTSIDE,T=e.faceUV||new Array(6),E=e.faceColors,S=[],b=0;b<6;b++)void 0===T[b]&&(T[b]=new X(0,0,1,1)),E&&void 0===E[b]&&(E[b]=new Ke(1,1,1,1));for(var x=0;x<6;x++)if(r.push(T[x].z,cn.UseOpenGLOrientationForUV?1-T[x].w:T[x].w),r.push(T[x].x,cn.UseOpenGLOrientationForUV?1-T[x].w:T[x].w),r.push(T[x].x,cn.UseOpenGLOrientationForUV?1-T[x].y:T[x].y),r.push(T[x].z,cn.UseOpenGLOrientationForUV?1-T[x].y:T[x].y),E)for(var M=0;M<4;M++)S.push(E[x].r,E[x].g,E[x].b,E[x].a);Qi._ComputeSides(y,t,i,n,r,e.frontUVs,e.backUVs);var A=new Qi;if(A.indices=i,A.positions=t,A.normals=n,A.uvs=r,E){var R=y===Qi.DOUBLESIDE?S.concat(S):S;A.colors=R}return A}function Or(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=new Ln(e,arguments.length>2&&void 0!==arguments[2]?arguments[2]:null);return t.sideOrientation=Ln._GetDefaultSideOrientation(t.sideOrientation),i._originalBuilderSideOrientation=t.sideOrientation,wr(t).applyToMesh(i,t.updatable),i}Qi.CreateBox=wr,Ln.CreateBox=function(e,t){return Or(e,{size:t,sideOrientation:arguments.length>4?arguments[4]:void 0,updatable:arguments.length>3?arguments[3]:void 0},arguments.length>2&&void 0!==arguments[2]?arguments[2]:null)};var Lr=function(){function e(){(0,m.Z)(this,e),this.previousWorldMatrices={},this.previousBones={}}return(0,y.Z)(e,[{key:"bindForSubMesh",value:function(e,t,i,n,r){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&-1!==t.prePassRenderer.getIndex(2)){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=n.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());var s=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=s.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==s.frameId&&(this._lastUpdateFrameId=s.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=n.clone()}}}],[{key:"AddUniforms",value:function(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}},{key:"AddSamplers",value:function(e){}}]),e}(),Nr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r,s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return(0,m.Z)(this,i),(r=t.call(this,e,n))._normalMatrix=new Z,r._storeEffectOnSubMeshes=s,r}return(0,y.Z)(i,[{key:"getEffect",value:function(){return this._storeEffectOnSubMeshes?this._activeEffect:c((0,h.Z)(i.prototype),"getEffect",this).call(this)}},{key:"isReady",value:function(e,t){return!!e&&(!this._storeEffectOnSubMeshes||!e.subMeshes||0===e.subMeshes.length||this.isReadyForSubMesh(e,e.subMeshes[0],t))}},{key:"_isReadyForSubMesh",value:function(e){var t=e.materialDefines;return!(this.checkReadyOnEveryCall||!e.effect||!t||t._renderId!==this.getScene().getRenderId())}},{key:"bindOnlyWorldMatrix",value:function(e){this._activeEffect.setMatrix("world",e)}},{key:"bindOnlyNormalMatrix",value:function(e){this._activeEffect.setMatrix("normalMatrix",e)}},{key:"bind",value:function(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}},{key:"_afterBind",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;c((0,h.Z)(i.prototype),"_afterBind",this).call(this,e,t),this.getScene()._cachedEffect=t,t&&(t._forceRebindOnNextCall=!1)}},{key:"_mustRebind",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return e.isCachedMaterialInvalid(this,t,i)}}]),i}(In),Br=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"DiffuseTextureEnabled",get:function(){return this._DiffuseTextureEnabled},set:function(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"DetailTextureEnabled",get:function(){return this._DetailTextureEnabled},set:function(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"AmbientTextureEnabled",get:function(){return this._AmbientTextureEnabled},set:function(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"OpacityTextureEnabled",get:function(){return this._OpacityTextureEnabled},set:function(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"ReflectionTextureEnabled",get:function(){return this._ReflectionTextureEnabled},set:function(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"EmissiveTextureEnabled",get:function(){return this._EmissiveTextureEnabled},set:function(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"SpecularTextureEnabled",get:function(){return this._SpecularTextureEnabled},set:function(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"BumpTextureEnabled",get:function(){return this._BumpTextureEnabled},set:function(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"LightmapTextureEnabled",get:function(){return this._LightmapTextureEnabled},set:function(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"RefractionTextureEnabled",get:function(){return this._RefractionTextureEnabled},set:function(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"ColorGradingTextureEnabled",get:function(){return this._ColorGradingTextureEnabled},set:function(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"FresnelEnabled",get:function(){return this._FresnelEnabled},set:function(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,Xe.MarkAllMaterialsAsDirty(4))}},{key:"ClearCoatTextureEnabled",get:function(){return this._ClearCoatTextureEnabled},set:function(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"ClearCoatBumpTextureEnabled",get:function(){return this._ClearCoatBumpTextureEnabled},set:function(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"ClearCoatTintTextureEnabled",get:function(){return this._ClearCoatTintTextureEnabled},set:function(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"SheenTextureEnabled",get:function(){return this._SheenTextureEnabled},set:function(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"AnisotropicTextureEnabled",get:function(){return this._AnisotropicTextureEnabled},set:function(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"ThicknessTextureEnabled",get:function(){return this._ThicknessTextureEnabled},set:function(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"RefractionIntensityTextureEnabled",get:function(){return this._ThicknessTextureEnabled},set:function(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"TranslucencyIntensityTextureEnabled",get:function(){return this._ThicknessTextureEnabled},set:function(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}},{key:"IridescenceTextureEnabled",get:function(){return this._IridescenceTextureEnabled},set:function(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,Xe.MarkAllMaterialsAsDirty(1))}}]),e}();Br._DiffuseTextureEnabled=!0,Br._DetailTextureEnabled=!0,Br._AmbientTextureEnabled=!0,Br._OpacityTextureEnabled=!0,Br._ReflectionTextureEnabled=!0,Br._EmissiveTextureEnabled=!0,Br._SpecularTextureEnabled=!0,Br._BumpTextureEnabled=!0,Br._LightmapTextureEnabled=!0,Br._RefractionTextureEnabled=!0,Br._ColorGradingTextureEnabled=!0,Br._FresnelEnabled=!0,Br._ClearCoatTextureEnabled=!0,Br._ClearCoatBumpTextureEnabled=!0,Br._ClearCoatTintTextureEnabled=!0,Br._SheenTextureEnabled=!0,Br._AnisotropicTextureEnabled=!0,Br._ThicknessTextureEnabled=!0,Br._RefractionIntensityTextureEnabled=!0,Br._TranslucencyIntensityTextureEnabled=!0,Br._IridescenceTextureEnabled=!0;xe.IncludesShadersStore.defaultFragmentDeclaration="uniform vec4 vEyePosition;\nuniform vec4 vDiffuseColor;\n#ifdef SPECULARTERM\nuniform vec4 vSpecularColor;\n#endif\nuniform vec3 vEmissiveColor;\nuniform vec3 vAmbientColor;\nuniform float visibility;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#ifdef ALPHATEST\nuniform float alphaCutOff;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;\nuniform vec4 refractionRightColor;\n#endif\n#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)\nuniform vec3 vRefractionPosition;\nuniform vec3 vRefractionSize; \n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;\nuniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;\nuniform vec4 emissiveRightColor;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)\nuniform mat4 reflectionMatrix;\n#endif\n#ifndef REFLECTIONMAP_SKYBOX\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;\nuniform vec4 reflectionRightColor;\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#define ADDITIONAL_FRAGMENT_DECLARATION\n";xe.IncludesShadersStore.defaultUboDeclaration="layout(std140,column_major) uniform;\nuniform Material\n{\nvec4 diffuseLeftColor;\nvec4 diffuseRightColor;\nvec4 opacityParts;\nvec4 reflectionLeftColor;\nvec4 reflectionRightColor;\nvec4 refractionLeftColor;\nvec4 refractionRightColor;\nvec4 emissiveLeftColor;\nvec4 emissiveRightColor;\nvec2 vDiffuseInfos;\nvec2 vAmbientInfos;\nvec2 vOpacityInfos;\nvec2 vReflectionInfos;\nvec3 vReflectionPosition;\nvec3 vReflectionSize;\nvec2 vEmissiveInfos;\nvec2 vLightmapInfos;\nvec2 vSpecularInfos;\nvec3 vBumpInfos;\nmat4 diffuseMatrix;\nmat4 ambientMatrix;\nmat4 opacityMatrix;\nmat4 reflectionMatrix;\nmat4 emissiveMatrix;\nmat4 lightmapMatrix;\nmat4 specularMatrix;\nmat4 bumpMatrix;\nvec2 vTangentSpaceParams;\nfloat pointSize;\nfloat alphaCutOff;\nmat4 refractionMatrix;\nvec4 vRefractionInfos;\nvec3 vRefractionPosition;\nvec3 vRefractionSize;\nvec4 vSpecularColor;\nvec3 vEmissiveColor;\nvec4 vDiffuseColor;\nvec3 vAmbientColor;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";xe.IncludesShadersStore.prePassDeclaration="#ifdef PREPASS\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;\n#ifdef PREPASS_DEPTH\nvarying highp vec3 vViewPos;\n#endif\n#ifdef PREPASS_VELOCITY\nvarying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;\n#endif\n#endif\n";xe.IncludesShadersStore.oitDeclaration="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out vec2 depth; \nlayout(location=1) out vec4 frontColor;\nlayout(location=2) out vec4 backColor;\n#define MAX_DEPTH 99999.0\nhighp vec4 gl_FragColor;\nuniform sampler2D oitDepthSampler;\nuniform sampler2D oitFrontColorSampler;\n#endif\n";xe.IncludesShadersStore.mainUVVaryingDeclaration="#ifdef MAINUV{X}\nvarying vec2 vMainUV{X};\n#endif\n";xe.IncludesShadersStore.lightFragmentDeclaration="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float cascadeBlendFactor{X};\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\nuniform highp sampler2DArray depthSampler{X};\nuniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\n#else\nuniform highp sampler2DArray shadowSampler{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);\nvec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X};\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};\nuniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\nuniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#endif\n";xe.IncludesShadersStore.lightUboDeclaration="#ifdef LIGHT{X}\nuniform Light{X}\n{\nvec4 vLightData;\nvec4 vLightDiffuse;\nvec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;\nvec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;\nvec2 depthValues;\n} light{X};\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float cascadeBlendFactor{X};\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\nuniform highp sampler2DArray depthSampler{X};\nuniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\n#else\nuniform highp sampler2DArray shadowSampler{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);\nvec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X}; \n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";xe.IncludesShadersStore.lightsFragmentFunctions="struct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 lightVectorW;\nfloat attenuation=1.0;\nif (lightData.w==0.)\n{\nvec3 direction=lightData.xyz-vPositionW;\nattenuation=max(0.,1.0-length(direction)/range);\nlightVectorW=normalize(direction);\n}\nelse\n{\nlightVectorW=normalize(-lightData.xyz);\n}\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 direction=lightData.xyz-vPositionW;\nvec3 lightVectorW=normalize(direction);\nfloat attenuation=max(0.,1.0-length(direction)/range);\nfloat cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));\nif (cosAngle>=lightDirection.w)\n{\ncosAngle=max(0.,pow(cosAngle,lightData.w));\nattenuation*=cosAngle;\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {\nlightingInfo result;\nfloat ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor;\n#endif\nreturn result;\n}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){\nvec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);\nstrq/=strq.w;\nvec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;\nreturn textureColor;\n}";xe.IncludesShadersStore.shadowsFragmentFunctions="#ifdef SHADOWS\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{\nfloat mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));\nreturn mix(value,1.0,mask);\n}\n#define inline\nfloat computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nreturn depth>shadow ? darkness : 1.0;\n}\n#define inline\nfloat computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\nfloat visibility=1.;\nvec3 poissonDisk[4];\npoissonDisk[0]=vec3(-1.0,1.0,-1.0);\npoissonDisk[1]=vec3(1.0,-1.0,-1.0);\npoissonDisk[2]=vec3(-1.0,-1.0,-1.0);\npoissonDisk[3]=vec3(1.0,-1.0,1.0);\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);\n}\n#define inline\nfloat computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); \nreturn esm;\n}\n#define inline\nfloat computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn esm;\n}\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define inline\nfloat computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nvec3 uvLayer=vec3(uv.x,uv.y,layer);\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uvLayer));\n#else\nfloat shadow=texture2D(shadowSampler,uvLayer).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;\n}\n#endif\n#define inline\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;\n}\n}\n#define inline\nfloat computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\nfloat visibility=1.;\nvec2 poissonDisk[4];\npoissonDisk[0]=vec2(-0.94201624,-0.39906216);\npoissonDisk[1]=vec2(0.94558609,-0.76890725);\npoissonDisk[2]=vec2(-0.094184101,-0.92938870);\npoissonDisk[3]=vec2(0.34495938,0.29387760);\n#ifndef SHADOWFLOAT\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\n#else\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#ifdef IS_NDC_HALF_ZRANGE\n#define ZINCLIP clipSpace.z\n#else\n#define ZINCLIP uvDepth.z\n#endif\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define GREATEST_LESS_THAN_ONE 0.99999994\n#define inline\nfloat computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);\nfloat shadow=texture2D(shadowSampler,uvDepthLayer);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n#define inline\nfloat computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;\nvec2 uvw1=1.+2.*st;\nvec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;\nvec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));\nshadow=shadow/16.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n#define inline\nfloat computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;\nvec2 uvw1=vec2(7.);\nvec2 uvw2=1.+3.*st;\nvec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;\nvec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));\nshadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));\nshadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));\nshadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));\nshadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));\nshadow=shadow/144.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n#define inline\nfloat computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nfloat shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;\nvec2 uvw1=1.+2.*st;\nvec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;\nvec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);\nshadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);\nshadow=shadow/16.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;\nvec2 uvw1=vec2(7.);\nvec2 uvw2=1.+3.*st;\nvec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;\nvec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);\nshadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);\nshadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);\nshadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);\nshadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);\nshadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);\nshadow=shadow/144.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\nconst vec3 PoissonSamplers32[64]=vec3[64](\nvec3(0.06407013,0.05409927,0.),\nvec3(0.7366577,0.5789394,0.),\nvec3(-0.6270542,-0.5320278,0.),\nvec3(-0.4096107,0.8411095,0.),\nvec3(0.6849564,-0.4990818,0.),\nvec3(-0.874181,-0.04579735,0.),\nvec3(0.9989998,0.0009880066,0.),\nvec3(-0.004920578,-0.9151649,0.),\nvec3(0.1805763,0.9747483,0.),\nvec3(-0.2138451,0.2635818,0.),\nvec3(0.109845,0.3884785,0.),\nvec3(0.06876755,-0.3581074,0.),\nvec3(0.374073,-0.7661266,0.),\nvec3(0.3079132,-0.1216763,0.),\nvec3(-0.3794335,-0.8271583,0.),\nvec3(-0.203878,-0.07715034,0.),\nvec3(0.5912697,0.1469799,0.),\nvec3(-0.88069,0.3031784,0.),\nvec3(0.5040108,0.8283722,0.),\nvec3(-0.5844124,0.5494877,0.),\nvec3(0.6017799,-0.1726654,0.),\nvec3(-0.5554981,0.1559997,0.),\nvec3(-0.3016369,-0.3900928,0.),\nvec3(-0.5550632,-0.1723762,0.),\nvec3(0.925029,0.2995041,0.),\nvec3(-0.2473137,0.5538505,0.),\nvec3(0.9183037,-0.2862392,0.),\nvec3(0.2469421,0.6718712,0.),\nvec3(0.3916397,-0.4328209,0.),\nvec3(-0.03576927,-0.6220032,0.),\nvec3(-0.04661255,0.7995201,0.),\nvec3(0.4402924,0.3640312,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.)\n);\nconst vec3 PoissonSamplers64[64]=vec3[64](\nvec3(-0.613392,0.617481,0.),\nvec3(0.170019,-0.040254,0.),\nvec3(-0.299417,0.791925,0.),\nvec3(0.645680,0.493210,0.),\nvec3(-0.651784,0.717887,0.),\nvec3(0.421003,0.027070,0.),\nvec3(-0.817194,-0.271096,0.),\nvec3(-0.705374,-0.668203,0.),\nvec3(0.977050,-0.108615,0.),\nvec3(0.063326,0.142369,0.),\nvec3(0.203528,0.214331,0.),\nvec3(-0.667531,0.326090,0.),\nvec3(-0.098422,-0.295755,0.),\nvec3(-0.885922,0.215369,0.),\nvec3(0.566637,0.605213,0.),\nvec3(0.039766,-0.396100,0.),\nvec3(0.751946,0.453352,0.),\nvec3(0.078707,-0.715323,0.),\nvec3(-0.075838,-0.529344,0.),\nvec3(0.724479,-0.580798,0.),\nvec3(0.222999,-0.215125,0.),\nvec3(-0.467574,-0.405438,0.),\nvec3(-0.248268,-0.814753,0.),\nvec3(0.354411,-0.887570,0.),\nvec3(0.175817,0.382366,0.),\nvec3(0.487472,-0.063082,0.),\nvec3(-0.084078,0.898312,0.),\nvec3(0.488876,-0.783441,0.),\nvec3(0.470016,0.217933,0.),\nvec3(-0.696890,-0.549791,0.),\nvec3(-0.149693,0.605762,0.),\nvec3(0.034211,0.979980,0.),\nvec3(0.503098,-0.308878,0.),\nvec3(-0.016205,-0.872921,0.),\nvec3(0.385784,-0.393902,0.),\nvec3(-0.146886,-0.859249,0.),\nvec3(0.643361,0.164098,0.),\nvec3(0.634388,-0.049471,0.),\nvec3(-0.688894,0.007843,0.),\nvec3(0.464034,-0.188818,0.),\nvec3(-0.440840,0.137486,0.),\nvec3(0.364483,0.511704,0.),\nvec3(0.034028,0.325968,0.),\nvec3(0.099094,-0.308023,0.),\nvec3(0.693960,-0.366253,0.),\nvec3(0.678884,-0.204688,0.),\nvec3(0.001801,0.780328,0.),\nvec3(0.145177,-0.898984,0.),\nvec3(0.062655,-0.611866,0.),\nvec3(0.315226,-0.604297,0.),\nvec3(-0.780145,0.486251,0.),\nvec3(-0.371868,0.882138,0.),\nvec3(0.200476,0.494430,0.),\nvec3(-0.494552,-0.711051,0.),\nvec3(0.612476,0.705252,0.),\nvec3(-0.578845,-0.768792,0.),\nvec3(-0.772454,-0.090976,0.),\nvec3(0.504440,0.372295,0.),\nvec3(0.155736,0.065157,0.),\nvec3(0.391522,0.849605,0.),\nvec3(-0.620106,-0.328104,0.),\nvec3(0.789239,-0.419965,0.),\nvec3(-0.545396,0.538133,0.),\nvec3(-0.178564,-0.596057,0.)\n);\n#define inline\nfloat computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);\nfloat blockerDepth=0.0;\nfloat sumBlockerDepth=0.0;\nfloat numBlocker=0.0;\nfor (int i=0; i<searchTapCount; i ++) {\nblockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;\nif (blockerDepth<depthMetric) {\nsumBlockerDepth+=blockerDepth;\nnumBlocker++;\n}\n}\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;\nfloat AAOffset=shadowMapSizeInverse*10.;\nfloat penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);\nvec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);\nfloat random=getRand(vPositionFromLight.xy);\nfloat rotationAngle=random*3.1415926;\nvec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));\nfloat shadow=0.;\nfor (int i=0; i<pcfTapCount; i++) {\nvec4 offset=vec4(poissonSamplers[i],0.);\noffset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);\nshadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);\n}\nshadow/=float(pcfTapCount);\nshadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));\nshadow=mix(darkness,1.,shadow);\nif (numBlocker<1.0) {\nreturn 1.0;\n}\nelse\n{\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nfloat blockerDepth=0.0;\nfloat sumBlockerDepth=0.0;\nfloat numBlocker=0.0;\nfor (int i=0; i<searchTapCount; i ++) {\nblockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;\nif (blockerDepth<depthMetric) {\nsumBlockerDepth+=blockerDepth;\nnumBlocker++;\n}\n}\nif (numBlocker<1.0) {\nreturn 1.0;\n}\nelse\n{\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;\nfloat AAOffset=shadowMapSizeInverse*10.;\nfloat penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);\nfloat filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;\nfloat random=getRand(vPositionFromLight.xy);\nfloat rotationAngle=random*3.1415926;\nvec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));\nfloat shadow=0.;\nfor (int i=0; i<pcfTapCount; i++) {\nvec3 offset=poissonSamplers[i];\noffset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);\nshadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);\n}\nshadow/=float(pcfTapCount);\nshadow=mix(shadow,1.,depthMetric-avgBlockerDepth);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n}\n#define inline\nfloat computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);\n}\n#define inline\nfloat computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);\n}\n#define inline\nfloat computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);\n}\n#define inline\nfloat computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nreturn computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);\n}\n#define inline\nfloat computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nreturn computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);\n}\n#define inline\nfloat computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nreturn computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);\n}\n#endif\n#endif\n";xe.IncludesShadersStore.samplerFragmentDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\nuniform sampler2D _SAMPLERNAME_Sampler;\n#endif\n";xe.IncludesShadersStore.fresnelFunction="#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{\nfloat fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);\nreturn clamp(fresnelTerm,0.,1.);\n}\n#endif\n";xe.IncludesShadersStore.reflectionFunction="vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{\nfloat lon=atan(direction.z,direction.x);\nfloat lat=acos(direction.y);\nvec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;\nfloat s=sphereCoords.x*0.5+0.5;\nfloat t=sphereCoords.y;\nreturn vec3(s,t,0); \n}\nvec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{\nfloat lon=atan(direction.z,direction.x);\nfloat lat=acos(direction.y);\nvec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;\nfloat s=sphereCoords.x*0.5+0.5;\nfloat t=sphereCoords.y;\nreturn vec3(1.0-s,t,0); \n}\nvec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{\nvec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);\nvec3 r=normalize(reflect(cameraToVertex,worldNormal));\nr=vec3(reflectionMatrix*vec4(r,0));\nfloat lon=atan(r.z,r.x);\nfloat lat=acos(r.y);\nvec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;\nfloat s=sphereCoords.x*0.5+0.5;\nfloat t=sphereCoords.y;\nreturn vec3(s,t,0);\n}\nvec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)\n{\nvec3 viewDir=normalize(vec3(view*worldPos));\nvec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));\nvec3 r=reflect(viewDir,viewNormal);\nr=vec3(reflectionMatrix*vec4(r,0));\nr.z=r.z-1.0;\nfloat m=2.0*length(r);\nreturn vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);\n}\nvec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{\nvec3 viewDir=worldPos.xyz-eyePosition;\nvec3 coords=normalize(reflect(viewDir,worldNormal));\nreturn vec3(reflectionMatrix*vec4(coords,1));\n}\nvec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{\nvec3 viewDir=normalize(worldPos.xyz-eyePosition);\nvec3 coords=reflect(viewDir,worldNormal);\ncoords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;\n}\nvec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)\n{\nvec3 viewDir=normalize(worldPos.xyz-eyePosition);\nvec3 coords=reflect(viewDir,worldNormal);\ncoords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);\ncoords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;\n}\nvec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)\n{\nreturn vec3(reflectionMatrix*(view*worldPos));\n}\nvec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)\n{\nreturn vec3(reflectionMatrix*vec4(positionW,1.));\n}\n#ifdef REFLECTION\nvec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);\nreturn computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);\nreturn computeFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nreturn computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nreturn computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nreturn computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_CUBIC\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nreturn computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);\n#else\nreturn computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn computeProjectionCoords(worldPos,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn computeSkyBoxCoords(vPositionUVW,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}\n#endif\n";xe.IncludesShadersStore.imageProcessingDeclaration="#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#if defined(VIGNETTE) || defined(DITHER)\nuniform vec2 vInverseScreenSize;\n#endif\n#ifdef VIGNETTE\nuniform vec4 vignetteSettings1;\nuniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;\nuniform vec4 vCameraColorCurveNeutral;\nuniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nuniform highp sampler3D txColorTransform;\n#else\nuniform sampler2D txColorTransform;\n#endif\nuniform vec4 colorTransformSettings;\n#endif\n#ifdef DITHER\nuniform float ditherIntensity;\n#endif\n";xe.IncludesShadersStore.imageProcessingFunctions="#if defined(COLORGRADING) && !defined(COLORGRADING3D)\n/** \n* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.\n* sampler3dSetting.x=textureOffset (0.5/textureSize).\n* sampler3dSetting.y=textureSize.\n*/\n#define inline\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{\nfloat sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);\nfloat sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;\nsliceUV.x+=sliceInteger*sliceSize;\nsliceUV=saturate(sliceUV);\nvec4 slice0Color=texture2D(colorTransform,sliceUV);\nsliceUV.x+=sliceSize;\nsliceUV=saturate(sliceUV);\nvec4 slice1Color=texture2D(colorTransform,sliceUV);\nvec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;\n}\n#endif\n#ifdef TONEMAPPING_ACES\nconst mat3 ACESInputMat=mat3(\nvec3(0.59719,0.07600,0.02840),\nvec3(0.35458,0.90834,0.13383),\nvec3(0.04823,0.01566,0.83777)\n);\nconst mat3 ACESOutputMat=mat3(\nvec3( 1.60475,-0.10208,-0.00327),\nvec3(-0.53108, 1.10813,-0.07276),\nvec3(-0.07367,-0.00605, 1.07602)\n);\nvec3 RRTAndODTFit(vec3 v)\n{\nvec3 a=v*(v+0.0245786)-0.000090537;\nvec3 b=v*(0.983729*v+0.4329510)+0.238081;\nreturn a/b;\n}\nvec3 ACESFitted(vec3 color)\n{\ncolor=ACESInputMat*color;\ncolor=RRTAndODTFit(color);\ncolor=ACESOutputMat*color;\ncolor=saturate(color);\nreturn color;\n}\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS\nvec4 applyImageProcessing(vec4 result) {\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;\nviewportXY=viewportXY*2.0-1.0;\nvec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);\nfloat vignetteTerm=dot(vignetteXY1,vignetteXY1);\nfloat vignette=pow(vignetteTerm,vignetteSettings2.w);\nvec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);\nresult.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#ifdef TONEMAPPING\n#ifdef TONEMAPPING_ACES\nresult.rgb=ACESFitted(result.rgb);\n#else\nconst float tonemappingCalibration=1.590579;\nresult.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\n#endif\nresult.rgb=toGammaSpace(result.rgb);\nresult.rgb=saturate(result.rgb);\n#ifdef CONTRAST\nvec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);\nif (contrast<1.0) {\nresult.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);\n} else {\nresult.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);\n}\n#endif\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;\n#else\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\n#endif\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\nfloat luma=getLuminance(result.rgb);\nvec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));\nvec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;\nresult.rgb*=colorCurve.rgb;\nresult.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\n#ifdef DITHER\nfloat rand=getRand(gl_FragCoord.xy*vInverseScreenSize);\nfloat dither=mix(-ditherIntensity,ditherIntensity,rand);\nresult.rgb=saturate(result.rgb+vec3(dither));\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND\nreturn result;\n}";xe.IncludesShadersStore.bumpFragmentMainFunctions="#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#endif\nvec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)\n{\n#ifdef NORMALXYSCALE\nnormal=normalize(normal*vec3(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*normal);\n}\nvec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)\n{\nreturn perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);\n}\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)\n{\nvec3 dp1=dFdx(p);\nvec3 dp2=dFdy(p);\nvec2 duv1=dFdx(uv);\nvec2 duv2=dFdy(uv);\nvec3 dp2perp=cross(dp2,normal);\nvec3 dp1perp=cross(normal,dp1);\nvec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;\nvec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;\ntangent*=tangentSpaceParams.x;\nbitangent*=tangentSpaceParams.y;\nfloat det=max(dot(tangent,tangent),dot(bitangent,bitangent));\nfloat invmax=det==0.0 ? 0.0 : inversesqrt(det);\nreturn mat3(tangent*invmax,bitangent*invmax,normal);\n}\n#endif\n";xe.IncludesShadersStore.bumpFragmentFunctions="#if defined(BUMP)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(BUMP) && defined(PARALLAX)\nconst float minSamples=4.;\nconst float maxSamples=15.;\nconst int iMaxSamples=15;\nvec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {\nfloat parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;\nparallaxLimit*=parallaxScale;\nvec2 vOffsetDir=normalize(vViewDirCoT.xy);\nvec2 vMaxOffset=vOffsetDir*parallaxLimit;\nfloat numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));\nfloat stepSize=1.0/numSamples;\nfloat currRayHeight=1.0;\nvec2 vCurrOffset=vec2(0,0);\nvec2 vLastOffset=vec2(0,0);\nfloat lastSampledHeight=1.0;\nfloat currSampledHeight=1.0;\nbool keepWorking=true;\nfor (int i=0; i<iMaxSamples; i++)\n{\ncurrSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;\nif (!keepWorking)\n{\n}\nelse if (currSampledHeight>currRayHeight)\n{\nfloat delta1=currSampledHeight-currRayHeight;\nfloat delta2=(currRayHeight+stepSize)-lastSampledHeight;\nfloat ratio=delta1/(delta1+delta2);\nvCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;\nkeepWorking=false;\n}\nelse\n{\ncurrRayHeight-=stepSize;\nvLastOffset=vCurrOffset;\nvCurrOffset+=stepSize*vMaxOffset;\nlastSampledHeight=currSampledHeight;\n}\n}\nreturn vCurrOffset;\n}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{\nfloat height=texture2D(bumpSampler,vBumpUV).w;\nvec2 texCoordOffset=heightScale*viewDir.xy*height;\nreturn -texCoordOffset;\n}\n#endif\n";xe.IncludesShadersStore.logDepthDeclaration="#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;\nvarying float vFragmentDepth;\n#endif\n";xe.IncludesShadersStore.fogFragmentDeclaration="#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;\nuniform vec3 vFogColor;\nvarying vec3 vFogDistance;\nfloat CalcFogFactor()\n{\nfloat fogCoeff=1.0;\nfloat fogStart=vFogInfos.y;\nfloat fogEnd=vFogInfos.z;\nfloat fogDensity=vFogInfos.w;\nfloat fogDistance=length(vFogDistance);\nif (FOGMODE_LINEAR==vFogInfos.x)\n{\nfogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);\n}\nelse if (FOGMODE_EXP==vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDensity);\n}\nelse if (FOGMODE_EXP2==vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);\n}\nreturn clamp(fogCoeff,0.0,1.0);\n}\n#endif\n";xe.IncludesShadersStore.bumpFragment="vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#elif defined(BUMP)\nfloat normalScale=vBumpInfos.y;\n#else\nfloat normalScale=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#elif defined(BUMP)\nvec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;\nmat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);\n#else\nvec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;\nmat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#elif defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nvec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;\nmat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef DETAIL\nvec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);\nvec2 detailNormalRG=detailColor.wy*2.0-1.0;\nfloat detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));\nvec3 detailNormal=vec3(detailNormalRG,detailNormalB);\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\nnormalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);\nnormalW=normalize(mat3(normalMatrix)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);\n#else\nvec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal.xy*=vDetailInfos.z;\nvec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal.xy*=vDetailInfos.z;\nbumpNormal+=vec3(0.0,0.0,1.0);\ndetailNormal*=vec3(-1.0,-1.0,1.0);\nvec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal.xy*=vDetailInfos.z;\nnormalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);\n#endif\n";xe.IncludesShadersStore.depthPrePass="#ifdef DEPTHPREPASS\ngl_FragColor=vec4(0.,0.,0.,1.0);\nreturn;\n#endif\n";xe.IncludesShadersStore.lightFragment="#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\n#ifdef PBR\n#ifdef SPOTLIGHT{X}\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(POINTLIGHT{X})\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(HEMILIGHT{X})\npreInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(DIRLIGHT{X})\npreInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#endif\npreInfo.NdotV=NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\npreInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\npreInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\npreInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\npreInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo.attenuation=1.0;\n#endif\n#ifdef HEMILIGHT{X}\npreInfo.roughness=roughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\n#ifdef HEMILIGHT{X}\ninfo.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);\n#elif defined(SS_TRANSLUCENCY)\ninfo.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);\n#endif\n#ifdef SPECULARTERM\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#endif\n#endif\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\n#ifdef HEMILIGHT{X}\npreInfo.roughness=sheenOut.sheenRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#endif\n#ifdef CLEARCOAT\n#ifdef HEMILIGHT{X}\npreInfo.roughness=clearcoatOut.clearCoatRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);\n#ifdef CLEARCOAT_TINT\nabsorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);\ninfo.diffuse*=absorption;\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\n#else\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);\n#elif defined(HEMILIGHT{X})\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);\n#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) \n{\n#ifdef SHADOWCSM_RIGHTHANDED{X}\ndiff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;\n#else\ndiff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;\n#endif\nif (diff{X}>=0.) {\nindex{X}=i;\nbreak;\n}\n}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nif (index{X}>=0)\n#endif\n{\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nshadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nshadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];\n#endif\n#ifndef SHADOWCSMNOBLEND{X}\nfloat frustumLength=frustumLengths{X}[index{X}];\nfloat diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};\nif (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)\n{\nindex{X}+=1;\nfloat nextShadow=0.;\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nnextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nnextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nnextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\nshadow=mix(nextShadow,shadow,diffRatio);\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);\n#endif\n}\n#endif\n}\n#elif defined(SHADOWCLOSEESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;\nshadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor.rgb*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifndef LIGHTMAPNOSPECULAR{X}\nclearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef SHEEN\n#ifndef LIGHTMAPNOSPECULAR{X}\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#else\n#ifdef SHADOWCSMDEBUG{X}\ndiffuseBase+=info.diffuse*shadowDebug{X};\n#else \ndiffuseBase+=info.diffuse*shadow;\n#endif\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#ifdef CLEARCOAT\nclearCoatBase+=info.clearCoat.rgb*shadow;\n#endif\n#ifdef SHEEN\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#endif\n#endif\n";xe.IncludesShadersStore.logDepthFragment="#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif\n";xe.IncludesShadersStore.fogFragment="#ifdef FOG\nfloat fog=CalcFogFactor();\n#ifdef PBR\nfog=toLinearSpace(fog);\n#endif\ncolor.rgb=mix(vFogColor,color.rgb,fog);\n#endif\n";xe.IncludesShadersStore.oitFragment="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\nfloat fragDepth=gl_FragCoord.z; \n#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS\nuint halfFloat=packHalf2x16(vec2(fragDepth));\nvec2 full=unpackHalf2x16(halfFloat);\nfragDepth=full.x;\n#endif\nivec2 fragCoord=ivec2(gl_FragCoord.xy);\nvec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;\nvec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);\ndepth.rg=vec2(-MAX_DEPTH);\nfrontColor=lastFrontColor;\nbackColor=vec4(0.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\nfloat furthestDepth=-lastDepth.x;\nfloat nearestDepth=lastDepth.y;\n#else\nfloat nearestDepth=-lastDepth.x;\nfloat furthestDepth=lastDepth.y;\n#endif\nfloat alphaMultiplier=1.0-lastFrontColor.a;\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth>nearestDepth || fragDepth<furthestDepth) {\n#else\nif (fragDepth<nearestDepth || fragDepth>furthestDepth) {\n#endif\nreturn;\n}\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth<nearestDepth && fragDepth>furthestDepth) {\n#else\nif (fragDepth>nearestDepth && fragDepth<furthestDepth) {\n#endif\ndepth.rg=vec2(-fragDepth,fragDepth);\nreturn;\n}\n#endif\n";xe.ShadersStore.defaultPixelShader="#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#define RECIPROCAL_PI2 0.15915494\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#include<helperFunctions>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULARTERM)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)\n#endif\n#include<fresnelFunction>\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\nvec4 baseColor=vec4(1.,1.,1.,1.);\nvec3 diffuseColor=vDiffuseColor.rgb;\nfloat alpha=vDiffuseColor.a;\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)\nif (baseColor.a<alphaCutOff)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#include<depthPrePass>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbaseColor.rgb*=vColor.rgb;\n#endif\n#ifdef DETAIL\nbaseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\n#ifdef SPECULARTERM\nfloat glossiness=vSpecularColor.a;\nvec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);\nspecularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#else\nfloat glossiness=0.;\n#endif\nvec3 diffuseBase=vec3(0.,0.,0.);\nlightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;\n#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\nvec4 refractionColor=vec4(0.,0.,0.,1.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\n#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nif (dot(refractionVector,viewDirectionW)<1.0) {\nrefractionColor=textureCube(refractionCubeSampler,refractionVector);\n}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\nrefractionColor=texture2D(refraction2DSampler,refractionCoords);\n#endif\n#ifdef RGBDREFRACTION\nrefractionColor.rgb=fromRGBD(refractionColor);\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor.rgb=toGammaSpace(refractionColor.rgb);\n#endif\nrefractionColor.rgb*=vRefractionInfos.x;\n#endif\nvec4 reflectionColor=vec4(0.,0.,0.,1.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nvReflectionUVW.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;\nreflectionColor=texture2D(reflection2DSampler,coords);\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor.rgb=toGammaSpace(reflectionColor.rgb);\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);\nrefractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);\nalpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);\nalpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n#ifdef ALPHATEST\n#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS\nif (alpha<alphaCutOff)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);\nemissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);\ndiffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor.rgb;\n#else\ncolor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor.rgb=max(color.rgb,0.);\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);\ncolor=applyImageProcessing(color);\n#endif\n#endif\ncolor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;\ngl_FragData[0]=color; \n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;\nvec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;\nvec2 velocity=abs(a-b);\nvelocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;\ngl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_IRRADIANCE\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_NORMAL\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4((view*vec4(normalW,0.0)).rgb,writeGeometryInfo); \n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(SPECULARTERM)\n#if defined(SPECULAR)\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularMapColor)*writeGeometryInfo; \n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularColor,1.0)*writeGeometryInfo;\n#endif\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=color;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {\nfrontColor.rgb+=color.rgb*color.a*alphaMultiplier;\nfrontColor.a=1.0-alphaMultiplier*(1.0-color.a);\n} else {\nbackColor+=color;\n}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";xe.IncludesShadersStore.defaultVertexDeclaration="uniform mat4 viewProjection;\nuniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\nuniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef REFLECTION\nuniform mat4 reflectionMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\nuniform mat4 detailMatrix;\n#endif\n#define ADDITIONAL_VERTEX_DECLARATION\n";xe.IncludesShadersStore.uvAttributeDeclaration="#ifdef UV{X}\nattribute vec2 uv{X};\n#endif\n";xe.IncludesShadersStore.prePassVertexDeclaration="#ifdef PREPASS\n#ifdef PREPASS_DEPTH\nvarying vec3 vViewPos;\n#endif\n#ifdef PREPASS_VELOCITY\nuniform mat4 previousViewProjection;\nvarying vec4 vCurrentPosition;\nvarying vec4 vPreviousPosition;\n#endif\n#endif\n";xe.IncludesShadersStore.samplerVertexDeclaration="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n";xe.IncludesShadersStore.bumpVertexDeclaration="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n";xe.IncludesShadersStore.fogVertexDeclaration="#ifdef FOG\nvarying vec3 vFogDistance;\n#endif\n";xe.IncludesShadersStore.lightVxFragmentDeclaration="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};\nuniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\nuniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#endif\n";xe.IncludesShadersStore.lightVxUboDeclaration="#ifdef LIGHT{X}\nuniform Light{X}\n{\nvec4 vLightData;\nvec4 vLightDiffuse;\nvec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;\nvec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;\nvec2 depthValues;\n} light{X};\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";xe.IncludesShadersStore.prePassVertex="#ifdef PREPASS_DEPTH\nvViewPos=(view*worldPos).rgb;\n#endif\n#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*worldPos;\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;\npreviousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n";xe.IncludesShadersStore.uvVariableDeclaration="#if !defined(UV{X}) && defined(MAINUV{X})\nvec2 uv{X}=vec2(0.,0.);\n#endif\n#ifdef MAINUV{X}\nvMainUV{X}=uv{X};\n#endif\n";xe.IncludesShadersStore.samplerVertexImplementation="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nif (v_INFONAME_==0.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));\n}\n#ifdef UV2\nelse if (v_INFONAME_==1.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef UV3\nelse if (v_INFONAME_==2.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));\n}\n#endif\n#ifdef UV4\nelse if (v_INFONAME_==3.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));\n}\n#endif\n#ifdef UV5\nelse if (v_INFONAME_==4.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));\n}\n#endif\n#ifdef UV6\nelse if (v_INFONAME_==5.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));\n}\n#endif\n#endif\n";xe.IncludesShadersStore.bumpVertex="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);\nvec3 tbnTangent=normalize(tangentUpdated.xyz);\nvec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;\nvTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif\n";xe.IncludesShadersStore.fogVertex="#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif\n";xe.IncludesShadersStore.shadowsVertex="#ifdef SHADOWS\n#if defined(SHADOWCSM{X})\nvPositionFromCamera{X}=view*worldPos;\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {\nvPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n}\n#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#endif\n";xe.IncludesShadersStore.vertexColorMixing="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvColor=vec4(1.0);\n#ifdef VERTEXCOLOR\n#ifdef VERTEXALPHA\nvColor*=color;\n#else\nvColor.rgb*=color.rgb;\n#endif\n#endif\n#ifdef INSTANCESCOLOR\nvColor*=instanceColor;\n#endif\n#endif\n";xe.IncludesShadersStore.pointCloudVertex="#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n";xe.IncludesShadersStore.logDepthVertex="#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;\ngl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif\n";xe.ShadersStore.defaultVertexShader="#include<__decl__defaultVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<mainUVVaryingDeclaration>[1..7]\n#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#if defined(SPECULARTERM)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)\n#endif\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));\nvNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\nvPositionW=vec3(worldPos);\n#include<prePassVertex>\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#if defined(SPECULARTERM)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)\n#endif\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<pointCloudVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";var Ur=new RegExp("^([gimus]+)!"),Vr=function(){function e(t){(0,m.Z)(this,e),this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=t,this._scene=t.getScene(),this._engine=this._scene.getEngine()}return(0,y.Z)(e,[{key:"_addPlugin",value:function(t){for(var i=0;i<this._plugins.length;++i)if(this._plugins[i].name===t.name)throw'Plugin "'.concat(t.name,'" already added to the material "').concat(this._material.name,'"!');if(this._material._uniformBufferLayoutBuilt)throw'The plugin "'.concat(t.name,'" can\'t be added to the material "').concat(this._material.name,'" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.');var n=t.getClassName();e._MaterialPluginClassToMainDefine[n]||(e._MaterialPluginClassToMainDefine[n]="MATERIALPLUGIN_"+ ++e._MaterialPluginCounter),this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(t),this._plugins.sort((function(e,t){return e.priority-t.priority})),this._codeInjectionPoints={};var r={};r[e._MaterialPluginClassToMainDefine[n]]={type:"boolean",default:!0};var s,a=(0,p.Z)(this._plugins);try{for(a.s();!(s=a.n()).done;){var o=s.value;o.collectDefines(r),this._collectPointNames("vertex",o.getCustomCode("vertex")),this._collectPointNames("fragment",o.getCustomCode("fragment"))}}catch(l){a.e(l)}finally{a.f()}this._defineNamesFromPlugins=r}},{key:"_activatePlugin",value:function(e){-1===this._activePlugins.indexOf(e)&&(this._activePlugins.push(e),this._activePlugins.sort((function(e,t){return e.priority-t.priority})),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort((function(e,t){return e.priority-t.priority})),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}},{key:"getPlugin",value:function(e){for(var t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}},{key:"_handlePluginEventIsReadyForSubMesh",value:function(e){var t,i=!0,n=(0,p.Z)(this._activePlugins);try{for(n.s();!(t=n.n()).done;){var r=t.value;i=i&&r.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh)}}catch(s){n.e(s)}finally{n.f()}e.isReadyForSubMesh=i}},{key:"_handlePluginEventPrepareDefinesBeforeAttributes",value:function(e){var t,i=(0,p.Z)(this._activePlugins);try{for(i.s();!(t=i.n()).done;){t.value.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}}catch(n){i.e(n)}finally{i.f()}}},{key:"_handlePluginEventPrepareDefines",value:function(e){var t,i=(0,p.Z)(this._activePlugins);try{for(i.s();!(t=i.n()).done;){t.value.prepareDefines(e.defines,this._scene,e.mesh)}}catch(n){i.e(n)}finally{i.f()}}},{key:"_handlePluginEventHardBindForSubMesh",value:function(e){var t,i=(0,p.Z)(this._activePluginsForExtraEvents);try{for(i.s();!(t=i.n()).done;){t.value.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}}catch(n){i.e(n)}finally{i.f()}}},{key:"_handlePluginEventBindForSubMesh",value:function(e){var t,i=(0,p.Z)(this._activePlugins);try{for(i.s();!(t=i.n()).done;){t.value.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}}catch(n){i.e(n)}finally{i.f()}}},{key:"_handlePluginEventHasRenderTargetTextures",value:function(e){var t,i=!1,n=(0,p.Z)(this._activePluginsForExtraEvents);try{for(n.s();!(t=n.n()).done;){if(i=t.value.hasRenderTargetTextures())break}}catch(r){n.e(r)}finally{n.f()}e.hasRenderTargetTextures=i}},{key:"_handlePluginEventFillRenderTargetTextures",value:function(e){var t,i=(0,p.Z)(this._activePluginsForExtraEvents);try{for(i.s();!(t=i.n()).done;){t.value.fillRenderTargetTextures(e.renderTargets)}}catch(n){i.e(n)}finally{i.f()}}},{key:"_handlePluginEvent",value:function(e,t){switch(e){case Rn.GetActiveTextures:var i,n=t,r=(0,p.Z)(this._activePlugins);try{for(r.s();!(i=r.n()).done;){i.value.getActiveTextures(n.activeTextures)}}catch(D){r.e(D)}finally{r.f()}break;case Rn.GetAnimatables:var a,o=t,l=(0,p.Z)(this._activePlugins);try{for(l.s();!(a=l.n()).done;){a.value.getAnimatables(o.animatables)}}catch(D){l.e(D)}finally{l.f()}break;case Rn.HasTexture:var u,h=t,c=!1,d=(0,p.Z)(this._activePlugins);try{for(d.s();!(u=d.n()).done;){if(c=u.value.hasTexture(h.texture))break}}catch(D){d.e(D)}finally{d.f()}h.hasTexture=c;break;case Rn.Disposed:var f,_=t,v=(0,p.Z)(this._plugins);try{for(v.s();!(f=v.n()).done;){f.value.dispose(_.forceDisposeTextures)}}catch(D){v.e(D)}finally{v.f()}break;case Rn.GetDefineNames:t.defineNames=this._defineNamesFromPlugins;break;case Rn.PrepareEffect:var g,m,y,T,E=t,S=(0,p.Z)(this._activePlugins);try{for(S.s();!(T=S.n()).done;){var b=T.value;E.fallbackRank=b.addFallbacks(E.defines,E.fallbacks,E.fallbackRank),b.getAttributes(E.attributes,this._scene,E.mesh)}}catch(D){S.e(D)}finally{S.f()}this._uniformList.length>0&&(g=E.uniforms).push.apply(g,(0,s.Z)(this._uniformList)),this._samplerList.length>0&&(m=E.samplers).push.apply(m,(0,s.Z)(this._samplerList)),this._uboList.length>0&&(y=E.uniformBuffersNames).push.apply(y,(0,s.Z)(this._uboList)),E.customCode=this._injectCustomCode(E.customCode);break;case Rn.PrepareUniformBuffer:var x=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];var M,A=(0,p.Z)(this._plugins);try{for(A.s();!(M=A.n()).done;){var R=M.value,C=R.getUniforms();if(C){if(C.ubo){var I,P=(0,p.Z)(C.ubo);try{for(P.s();!(I=P.n()).done;){var k=I.value;x.ubo.addUniform(k.name,k.size),this._uboDeclaration+="".concat(k.type," ").concat(k.name,";\r\n"),this._uniformList.push(k.name)}}catch(D){P.e(D)}finally{P.f()}}C.vertex&&(this._vertexDeclaration+=C.vertex+"\r\n"),C.fragment&&(this._fragmentDeclaration+=C.fragment+"\r\n")}R.getSamplers(this._samplerList),R.getUniformBuffersNames(this._uboList)}}catch(D){A.e(D)}finally{A.f()}}}},{key:"_collectPointNames",value:function(e,t){if(t)for(var i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}},{key:"_injectCustomCode",value:function(e){var t=this;return function(i,n){var r;e&&(n=e(i,n)),t._uboDeclaration&&(n=n.replace("#define ADDITIONAL_UBO_DECLARATION",t._uboDeclaration)),t._vertexDeclaration&&(n=n.replace("#define ADDITIONAL_VERTEX_DECLARATION",t._vertexDeclaration)),t._fragmentDeclaration&&(n=n.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",t._fragmentDeclaration));var s=null===(r=t._codeInjectionPoints)||void 0===r?void 0:r[i];if(!s)return n;for(var a in s){var o,l="",u=(0,p.Z)(t._activePlugins);try{for(u.s();!(o=u.n()).done;){var h=o.value.getCustomCode(i);null!=h&&h[a]&&(l+=h[a]+"\r\n")}}catch(T){u.e(T)}finally{u.f()}if(l.length>0)if("!"===a.charAt(0)){var c="g";if("!"===(a=a.substring(1)).charAt(0))c="",a=a.substring(1);else{var d=Ur.exec(a);d&&d.length>=2&&(c=d[1],a=a.substring(c.length+1))}c.indexOf("g")<0&&(c+="g");for(var f=n,_=new RegExp(a,c),v=_.exec(f);null!==v;){for(var g=l,m=0;m<v.length;++m)g=g.replace("$"+m,v[m]);n=n.replace(v[0],g),v=_.exec(f)}}else{var y="#define "+a;n=n.replace(y,"\r\n"+l+"\r\n"+y)}}return n}}}]),e}();Vr._MaterialPluginClassToMainDefine={},Vr._MaterialPluginCounter=0;var Gr=function(){function e(t,i,n,r){var s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];(0,m.Z)(this,e),this.priority=500,this.registerForExtraEvents=!1,this._material=t,this.name=i,this.priority=n,t.pluginManager||(t.pluginManager=new Vr(t)),this._pluginDefineNames=r,this._pluginManager=t.pluginManager,s&&this._pluginManager._addPlugin(this),a&&this._enable(!0),this.markAllDefinesAsDirty=t._dirtyCallbacks[63]}return(0,y.Z)(e,[{key:"_enable",value:function(e){e&&this._pluginManager._activatePlugin(this)}},{key:"getClassName",value:function(){return"MaterialPluginBase"}},{key:"isReadyForSubMesh",value:function(e,t,i,n){return!0}},{key:"hardBindForSubMesh",value:function(e,t,i,n){}},{key:"bindForSubMesh",value:function(e,t,i,n){}},{key:"dispose",value:function(e){}},{key:"getCustomCode",value:function(e){return null}},{key:"collectDefines",value:function(e){if(this._pluginDefineNames)for(var t=0,i=Object.keys(this._pluginDefineNames);t<i.length;t++){var n=i[t];if("_"!==n[0]){var r=typeof this._pluginDefineNames[n];e[n]={type:"number"===r?"number":"string"===r?"string":"boolean"===r?"boolean":"object",default:this._pluginDefineNames[n]}}}}},{key:"prepareDefinesBeforeAttributes",value:function(e,t,i){}},{key:"prepareDefines",value:function(e,t,i){}},{key:"hasTexture",value:function(e){return!1}},{key:"hasRenderTargetTextures",value:function(){return!1}},{key:"fillRenderTargetTextures",value:function(e){}},{key:"getActiveTextures",value:function(e){}},{key:"getAnimatables",value:function(e){}},{key:"addFallbacks",value:function(e,t,i){return i}},{key:"getSamplers",value:function(e){}},{key:"getAttributes",value:function(e,t,i){}},{key:"getUniformBuffersNames",value:function(e){}},{key:"getUniforms",value:function(){return{}}},{key:"copyTo",value:function(e){jt.Clone((function(){return e}),this)}},{key:"serialize",value:function(){return jt.Serialize(this)}},{key:"parse",value:function(e,t,i){var n=this;jt.Parse((function(){return n}),e,t,i)}}]),e}();Nt([Xt()],Gr.prototype,"name",void 0),Nt([Xt()],Gr.prototype,"priority",void 0),Nt([Xt()],Gr.prototype,"registerForExtraEvents",void 0);var Wr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){var e;return(0,m.Z)(this,i),(e=t.apply(this,arguments)).DETAIL=!1,e.DETAILDIRECTUV=0,e.DETAIL_NORMALBLENDMETHOD=0,e}return(0,y.Z)(i)}(Jt),zr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e){var n,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return(0,m.Z)(this,i),(n=t.call(this,e,"DetailMap",140,new Wr,r))._texture=null,n.diffuseBlendLevel=1,n.roughnessBlendLevel=1,n.bumpLevel=1,n._normalBlendMethod=In.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,n._isEnabled=!1,n.isEnabled=!1,n._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],n}return(0,y.Z)(i,[{key:"_markAllSubMeshesAsTexturesDirty",value:function(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}},{key:"isReadyForSubMesh",value:function(e,t,i){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&Br.DetailTextureEnabled&&!this._texture.isReady())}},{key:"prepareDefines",value:function(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;var i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&Br.DetailTextureEnabled&&this._isEnabled?(An.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}},{key:"bindForSubMesh",value:function(e,t){if(this._isEnabled){var i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&this._texture&&Br.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),An.BindTextureMatrix(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&Br.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}}},{key:"hasTexture",value:function(e){return this._texture===e}},{key:"getActiveTextures",value:function(e){this._texture&&e.push(this._texture)}},{key:"getAnimatables",value:function(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}},{key:"dispose",value:function(e){var t;e&&(null===(t=this._texture)||void 0===t||t.dispose())}},{key:"getClassName",value:function(){return"DetailMapConfiguration"}},{key:"getSamplers",value:function(e){e.push("detailSampler")}},{key:"getUniforms",value:function(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}]),i}(Gr);Nt([Ht("detailTexture"),zt("_markAllSubMeshesAsTexturesDirty")],zr.prototype,"texture",void 0),Nt([Xt()],zr.prototype,"diffuseBlendLevel",void 0),Nt([Xt()],zr.prototype,"roughnessBlendLevel",void 0),Nt([Xt()],zr.prototype,"bumpLevel",void 0),Nt([Xt(),zt("_markAllSubMeshesAsTexturesDirty")],zr.prototype,"normalBlendMethod",void 0),Nt([Xt(),zt("_markAllSubMeshesAsTexturesDirty")],zr.prototype,"isEnabled",void 0);var Xr={effect:null,subMesh:null},Hr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e){var n;return(0,m.Z)(this,i),(n=t.call(this,e)).MAINUV1=!1,n.MAINUV2=!1,n.MAINUV3=!1,n.MAINUV4=!1,n.MAINUV5=!1,n.MAINUV6=!1,n.DIFFUSE=!1,n.DIFFUSEDIRECTUV=0,n.BAKED_VERTEX_ANIMATION_TEXTURE=!1,n.AMBIENT=!1,n.AMBIENTDIRECTUV=0,n.OPACITY=!1,n.OPACITYDIRECTUV=0,n.OPACITYRGB=!1,n.REFLECTION=!1,n.EMISSIVE=!1,n.EMISSIVEDIRECTUV=0,n.SPECULAR=!1,n.SPECULARDIRECTUV=0,n.BUMP=!1,n.BUMPDIRECTUV=0,n.PARALLAX=!1,n.PARALLAXOCCLUSION=!1,n.SPECULAROVERALPHA=!1,n.CLIPPLANE=!1,n.CLIPPLANE2=!1,n.CLIPPLANE3=!1,n.CLIPPLANE4=!1,n.CLIPPLANE5=!1,n.CLIPPLANE6=!1,n.ALPHATEST=!1,n.DEPTHPREPASS=!1,n.ALPHAFROMDIFFUSE=!1,n.POINTSIZE=!1,n.FOG=!1,n.SPECULARTERM=!1,n.DIFFUSEFRESNEL=!1,n.OPACITYFRESNEL=!1,n.REFLECTIONFRESNEL=!1,n.REFRACTIONFRESNEL=!1,n.EMISSIVEFRESNEL=!1,n.FRESNEL=!1,n.NORMAL=!1,n.TANGENT=!1,n.UV1=!1,n.UV2=!1,n.UV3=!1,n.UV4=!1,n.UV5=!1,n.UV6=!1,n.VERTEXCOLOR=!1,n.VERTEXALPHA=!1,n.NUM_BONE_INFLUENCERS=0,n.BonesPerMesh=0,n.BONETEXTURE=!1,n.BONES_VELOCITY_ENABLED=!1,n.INSTANCES=!1,n.THIN_INSTANCES=!1,n.INSTANCESCOLOR=!1,n.GLOSSINESS=!1,n.ROUGHNESS=!1,n.EMISSIVEASILLUMINATION=!1,n.LINKEMISSIVEWITHDIFFUSE=!1,n.REFLECTIONFRESNELFROMSPECULAR=!1,n.LIGHTMAP=!1,n.LIGHTMAPDIRECTUV=0,n.OBJECTSPACE_NORMALMAP=!1,n.USELIGHTMAPASSHADOWMAP=!1,n.REFLECTIONMAP_3D=!1,n.REFLECTIONMAP_SPHERICAL=!1,n.REFLECTIONMAP_PLANAR=!1,n.REFLECTIONMAP_CUBIC=!1,n.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,n.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,n.REFLECTIONMAP_PROJECTION=!1,n.REFLECTIONMAP_SKYBOX=!1,n.REFLECTIONMAP_EXPLICIT=!1,n.REFLECTIONMAP_EQUIRECTANGULAR=!1,n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,n.REFLECTIONMAP_OPPOSITEZ=!1,n.INVERTCUBICMAP=!1,n.LOGARITHMICDEPTH=!1,n.REFRACTION=!1,n.REFRACTIONMAP_3D=!1,n.REFLECTIONOVERALPHA=!1,n.TWOSIDEDLIGHTING=!1,n.SHADOWFLOAT=!1,n.MORPHTARGETS=!1,n.MORPHTARGETS_NORMAL=!1,n.MORPHTARGETS_TANGENT=!1,n.MORPHTARGETS_UV=!1,n.NUM_MORPH_INFLUENCERS=0,n.MORPHTARGETS_TEXTURE=!1,n.NONUNIFORMSCALING=!1,n.PREMULTIPLYALPHA=!1,n.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,n.ALPHABLEND=!0,n.PREPASS=!1,n.PREPASS_IRRADIANCE=!1,n.PREPASS_IRRADIANCE_INDEX=-1,n.PREPASS_ALBEDO_SQRT=!1,n.PREPASS_ALBEDO_SQRT_INDEX=-1,n.PREPASS_DEPTH=!1,n.PREPASS_DEPTH_INDEX=-1,n.PREPASS_NORMAL=!1,n.PREPASS_NORMAL_INDEX=-1,n.PREPASS_POSITION=!1,n.PREPASS_POSITION_INDEX=-1,n.PREPASS_VELOCITY=!1,n.PREPASS_VELOCITY_INDEX=-1,n.PREPASS_REFLECTIVITY=!1,n.PREPASS_REFLECTIVITY_INDEX=-1,n.SCENE_MRT_COUNT=0,n.RGBDLIGHTMAP=!1,n.RGBDREFLECTION=!1,n.RGBDREFRACTION=!1,n.IMAGEPROCESSING=!1,n.VIGNETTE=!1,n.VIGNETTEBLENDMODEMULTIPLY=!1,n.VIGNETTEBLENDMODEOPAQUE=!1,n.TONEMAPPING=!1,n.TONEMAPPING_ACES=!1,n.CONTRAST=!1,n.COLORCURVES=!1,n.COLORGRADING=!1,n.COLORGRADING3D=!1,n.SAMPLER3DGREENDEPTH=!1,n.SAMPLER3DBGRMAP=!1,n.DITHER=!1,n.IMAGEPROCESSINGPOSTPROCESS=!1,n.SKIPFINALCOLORCLAMP=!1,n.MULTIVIEW=!1,n.ORDER_INDEPENDENT_TRANSPARENCY=!1,n.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,n.CAMERA_ORTHOGRAPHIC=!1,n.CAMERA_PERSPECTIVE=!1,n.IS_REFLECTION_LINEAR=!1,n.IS_REFRACTION_LINEAR=!1,n.EXPOSURE=!1,n.rebuild(),n}return(0,y.Z)(i,[{key:"setReflectionMode",value:function(e){for(var t=0,i=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];t<i.length;t++){var n=i[t];this[n]=n===e}}}]),i}(Jt),Zr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r;return(0,m.Z)(this,i),(r=t.call(this,e,n))._diffuseTexture=null,r._ambientTexture=null,r._opacityTexture=null,r._reflectionTexture=null,r._emissiveTexture=null,r._specularTexture=null,r._bumpTexture=null,r._lightmapTexture=null,r._refractionTexture=null,r.ambientColor=new Ze(0,0,0),r.diffuseColor=new Ze(1,1,1),r.specularColor=new Ze(1,1,1),r.emissiveColor=new Ze(0,0,0),r.specularPower=64,r._useAlphaFromDiffuseTexture=!1,r._useEmissiveAsIllumination=!1,r._linkEmissiveWithDiffuse=!1,r._useSpecularOverAlpha=!1,r._useReflectionOverAlpha=!1,r._disableLighting=!1,r._useObjectSpaceNormalMap=!1,r._useParallax=!1,r._useParallaxOcclusion=!1,r.parallaxScaleBias=.05,r._roughness=0,r.indexOfRefraction=.98,r.invertRefractionY=!0,r.alphaCutOff=.4,r._useLightmapAsShadowmap=!1,r._useReflectionFresnelFromSpecular=!1,r._useGlossinessFromSpecularMapAlpha=!1,r._maxSimultaneousLights=4,r._invertNormalMapX=!1,r._invertNormalMapY=!1,r._twoSidedLighting=!1,r._renderTargets=new kt(16),r._worldViewProjectionMatrix=Z.Zero(),r._globalAmbientColor=new Ze(0,0,0),r._cacheHasRenderTargetTextures=!1,r.detailMap=new zr((0,u.Z)(r)),r._attachImageProcessingConfiguration(null),r.prePassConfiguration=new Lr,r.getRenderTargetTextures=function(){return r._renderTargets.reset(),i.ReflectionTextureEnabled&&r._reflectionTexture&&r._reflectionTexture.isRenderTarget&&r._renderTargets.push(r._reflectionTexture),i.RefractionTextureEnabled&&r._refractionTexture&&r._refractionTexture.isRenderTarget&&r._renderTargets.push(r._refractionTexture),r._eventInfo.renderTargets=r._renderTargets,r._callbackPluginEventFillRenderTargetTextures(r._eventInfo),r._renderTargets},r}return(0,y.Z)(i,[{key:"imageProcessingConfiguration",get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}},{key:"_attachImageProcessingConfiguration",value:function(e){var t=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((function(){t._markAllSubMeshesAsImageProcessingDirty()}))))}},{key:"isPrePassCapable",get:function(){return!this.disableDepthWrite}},{key:"cameraColorCurvesEnabled",get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}},{key:"cameraColorGradingEnabled",get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e}},{key:"cameraToneMappingEnabled",get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e}},{key:"cameraExposure",get:function(){return this._imageProcessingConfiguration.exposure},set:function(e){this._imageProcessingConfiguration.exposure=e}},{key:"cameraContrast",get:function(){return this._imageProcessingConfiguration.contrast},set:function(e){this._imageProcessingConfiguration.contrast=e}},{key:"cameraColorGradingTexture",get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(e){this._imageProcessingConfiguration.colorGradingTexture=e}},{key:"cameraColorCurves",get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(e){this._imageProcessingConfiguration.colorCurves=e}},{key:"canRenderToMRT",get:function(){return!0}},{key:"hasRenderTargetTextures",get:function(){return!!(i.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||i.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}},{key:"getClassName",value:function(){return"StandardMaterial"}},{key:"useLogarithmicDepth",get:function(){return this._useLogarithmicDepth},set:function(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()}},{key:"needAlphaBlending",value:function(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled)}},{key:"needAlphaTesting",value:function(){return!!this._forceAlphaTest||this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===In.MATERIAL_ALPHATEST)}},{key:"_shouldUseAlphaFromDiffuseTexture",value:function(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==In.MATERIAL_OPAQUE}},{key:"_hasAlphaChannel",value:function(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||null!=this._opacityTexture}},{key:"getAlphaTestTexture",value:function(){return this._diffuseTexture}},{key:"isReadyForSubMesh",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===n)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Rn.GetDefineNames,this._eventInfo),t.materialDefines=new Hr(this._eventInfo.defineNames));var r=this.getScene(),s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;var a=r.getEngine();s._needNormals=An.PrepareDefinesForLights(r,e,s,!0,this._maxSimultaneousLights,this._disableLighting),An.PrepareDefinesForMultiview(r,s);var o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(An.PrepareDefinesForPrePass(r,s,this.canRenderToMRT&&!o),An.PrepareDefinesForOIT(r,s,o),s._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,s._needUVs=!1;for(var l=1;l<=6;++l)s["MAINUV"+l]=!1;if(r.texturesEnabled){if(s.DIFFUSEDIRECTUV=0,s.BUMPDIRECTUV=0,s.AMBIENTDIRECTUV=0,s.OPACITYDIRECTUV=0,s.EMISSIVEDIRECTUV=0,s.SPECULARDIRECTUV=0,s.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&i.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;An.PrepareDefinesForMergedUV(this._diffuseTexture,s,"DIFFUSE")}else s.DIFFUSE=!1;if(this._ambientTexture&&i.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking())return!1;An.PrepareDefinesForMergedUV(this._ambientTexture,s,"AMBIENT")}else s.AMBIENT=!1;if(this._opacityTexture&&i.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking())return!1;An.PrepareDefinesForMergedUV(this._opacityTexture,s,"OPACITY"),s.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}else s.OPACITY=!1;if(this._reflectionTexture&&i.ReflectionTextureEnabled){if(!this._reflectionTexture.isReadyOrNotBlocking())return!1;switch(s._needNormals=!0,s.REFLECTION=!0,s.ROUGHNESS=this._roughness>0,s.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,s.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===ar.INVCUBIC_MODE,s.REFLECTIONMAP_3D=this._reflectionTexture.isCube,s.REFLECTIONMAP_OPPOSITEZ=s.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,s.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case ar.EXPLICIT_MODE:s.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case ar.PLANAR_MODE:s.setReflectionMode("REFLECTIONMAP_PLANAR");break;case ar.PROJECTION_MODE:s.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case ar.SKYBOX_MODE:s.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case ar.SPHERICAL_MODE:s.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case ar.EQUIRECTANGULAR_MODE:s.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case ar.FIXED_EQUIRECTANGULAR_MODE:s.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case ar.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:s.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case ar.CUBIC_MODE:case ar.INVCUBIC_MODE:default:s.setReflectionMode("REFLECTIONMAP_CUBIC")}s.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else s.REFLECTION=!1,s.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&i.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking())return!1;An.PrepareDefinesForMergedUV(this._emissiveTexture,s,"EMISSIVE")}else s.EMISSIVE=!1;if(this._lightmapTexture&&i.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking())return!1;An.PrepareDefinesForMergedUV(this._lightmapTexture,s,"LIGHTMAP"),s.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,s.RGBDLIGHTMAP=this._lightmapTexture.isRGBD}else s.LIGHTMAP=!1;if(this._specularTexture&&i.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking())return!1;An.PrepareDefinesForMergedUV(this._specularTexture,s,"SPECULAR"),s.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha}else s.SPECULAR=!1;if(r.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&i.BumpTextureEnabled){if(!this._bumpTexture.isReady())return!1;An.PrepareDefinesForMergedUV(this._bumpTexture,s,"BUMP"),s.PARALLAX=this._useParallax,s.PARALLAXOCCLUSION=this._useParallaxOcclusion,s.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else s.BUMP=!1,s.PARALLAX=!1,s.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&i.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking())return!1;s._needUVs=!0,s.REFRACTION=!0,s.REFRACTIONMAP_3D=this._refractionTexture.isCube,s.RGBDREFRACTION=this._refractionTexture.isRGBD,s.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize}else s.REFRACTION=!1;s.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else s.DIFFUSE=!1,s.AMBIENT=!1,s.OPACITY=!1,s.REFLECTION=!1,s.EMISSIVE=!1,s.LIGHTMAP=!1,s.BUMP=!1,s.REFRACTION=!1;s.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),s.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,s.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,s.SPECULAROVERALPHA=this._useSpecularOverAlpha,s.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,s.ALPHATEST_AFTERALLALPHACOMPUTATIONS=null!==this.transparencyMode,s.ALPHABLEND=null===this.transparencyMode||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(s._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(s),s.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,s.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace}s._areFresnelDirty&&(i.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(s.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,s.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,s.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,s.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,s.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,s.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,s._needNormals=!0,s.FRESNEL=!0):s.FRESNEL=!1),An.PrepareDefinesForMisc(e,r,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,s),An.PrepareDefinesForFrameBoundValues(r,a,this,s,n,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=s,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),An.PrepareDefinesForAttributes(e,s,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);var u=!1;if(s.isDirty){var h=s._areLightsDisposed;s.markAsProcessed();var c=new Tr;s.REFLECTION&&c.addFallback(0,"REFLECTION"),s.SPECULAR&&c.addFallback(0,"SPECULAR"),s.BUMP&&c.addFallback(0,"BUMP"),s.PARALLAX&&c.addFallback(1,"PARALLAX"),s.PARALLAXOCCLUSION&&c.addFallback(0,"PARALLAXOCCLUSION"),s.SPECULAROVERALPHA&&c.addFallback(0,"SPECULAROVERALPHA"),s.FOG&&c.addFallback(1,"FOG"),s.POINTSIZE&&c.addFallback(0,"POINTSIZE"),s.LOGARITHMICDEPTH&&c.addFallback(0,"LOGARITHMICDEPTH"),An.HandleFallbacksForShadows(s,c,this._maxSimultaneousLights),s.SPECULARTERM&&c.addFallback(0,"SPECULARTERM"),s.DIFFUSEFRESNEL&&c.addFallback(1,"DIFFUSEFRESNEL"),s.OPACITYFRESNEL&&c.addFallback(2,"OPACITYFRESNEL"),s.REFLECTIONFRESNEL&&c.addFallback(3,"REFLECTIONFRESNEL"),s.EMISSIVEFRESNEL&&c.addFallback(4,"EMISSIVEFRESNEL"),s.FRESNEL&&c.addFallback(4,"FRESNEL"),s.MULTIVIEW&&c.addFallback(0,"MULTIVIEW");var d=[ni.PositionKind];s.NORMAL&&d.push(ni.NormalKind),s.TANGENT&&d.push(ni.TangentKind);for(var f=1;f<=6;++f)s["UV"+f]&&d.push("uv".concat(1===f?"":f));s.VERTEXCOLOR&&d.push(ni.ColorKind),An.PrepareAttributesForBones(d,e,s,c),An.PrepareAttributesForInstances(d,s),An.PrepareAttributesForMorphTargets(d,e,s),An.PrepareAttributesForBakedVertexAnimation(d,e,s);var _="default",v=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],g=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],p=["Material","Scene","Mesh"];this._eventInfo.fallbacks=c,this._eventInfo.fallbackRank=0,this._eventInfo.defines=s,this._eventInfo.uniforms=v,this._eventInfo.attributes=d,this._eventInfo.samplers=g,this._eventInfo.uniformBuffersNames=p,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(Rn.PrepareEffect,this._eventInfo),Lr.AddUniforms(v),ei&&(ei.PrepareUniforms(v,s),ei.PrepareSamplers(g,s)),An.PrepareUniformsAndSamplersList({uniformsNames:v,uniformBuffersNames:p,samplers:g,defines:s,maxSimultaneousLights:this._maxSimultaneousLights}),En(v);var m={};this.customShaderNameResolve&&(_=this.customShaderNameResolve(_,v,p,g,s,d,m));var y=s.toString(),T=t.effect,E=r.getEngine().createEffect(_,{attributes:d,uniformsNames:v,uniformBuffersNames:p,samplers:g,defines:y,fallbacks:c,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:s.NUM_MORPH_INFLUENCERS},processFinalCode:m.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:s.PREPASS},a);if(this._eventInfo.customCode=void 0,E)if(this._onEffectCreatedObservable&&(Xr.effect=E,Xr.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Xr)),this.allowShaderHotSwapping&&T&&!E.isReady()){if(E=T,s.markAsUnprocessed(),u=this.isFrozen,h)return s._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(E,s,this._materialContext)}return!(!t.effect||!t.effect.isReady())&&(s._renderId=r.getRenderId(),t.effect._wasPreviouslyReady=!u,t.effect._wasPreviouslyUsingInstances=n,r.performancePriority!==Gi.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}},{key:"buildUniformLayout",value:function(){var e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),c((0,h.Z)(i.prototype),"buildUniformLayout",this).call(this)}},{key:"bindForSubMesh",value:function(e,t,n){var r,s=this.getScene(),a=n.materialDefines;if(a){var o=n.effect;if(o){this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,s,t,e,this.isFrozen),this._eventInfo.subMesh=n,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),a.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));var l=o._forceRebindOnNextCall||this._mustRebind(s,o,t.visibility);An.BindBonesParameters(t,o);var u=this._uniformBuffer;if(l){if(this.bindViewProjection(o),!u.useUbo||!this.isFrozen||!u.isSync||o._forceRebindOnNextCall){if(i.FresnelEnabled&&a.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(u.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),u.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&u.updateColor4("opacityParts",new Ze(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(u.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),u.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(u.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),u.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(u.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),u.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),s.texturesEnabled){if(this._diffuseTexture&&i.DiffuseTextureEnabled&&(u.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),An.BindTextureMatrix(this._diffuseTexture,u,"diffuse")),this._ambientTexture&&i.AmbientTextureEnabled&&(u.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),An.BindTextureMatrix(this._ambientTexture,u,"ambient")),this._opacityTexture&&i.OpacityTextureEnabled&&(u.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),An.BindTextureMatrix(this._opacityTexture,u,"opacity")),this._hasAlphaChannel()&&u.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&i.ReflectionTextureEnabled&&(u.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),u.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){var h=this._reflectionTexture;u.updateVector3("vReflectionPosition",h.boundingBoxPosition),u.updateVector3("vReflectionSize",h.boundingBoxSize)}if(this._emissiveTexture&&i.EmissiveTextureEnabled&&(u.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),An.BindTextureMatrix(this._emissiveTexture,u,"emissive")),this._lightmapTexture&&i.LightmapTextureEnabled&&(u.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),An.BindTextureMatrix(this._lightmapTexture,u,"lightmap")),this._specularTexture&&i.SpecularTextureEnabled&&(u.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),An.BindTextureMatrix(this._specularTexture,u,"specular")),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&i.BumpTextureEnabled&&(u.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),An.BindTextureMatrix(this._bumpTexture,u,"bump"),s._mirroredCameraPosition?u.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):u.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&i.RefractionTextureEnabled){var c=1;if(this._refractionTexture.isCube||(u.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(c=this._refractionTexture.depth)),u.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,c,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){var d=this._refractionTexture;u.updateVector3("vRefractionPosition",d.boundingBoxPosition),u.updateVector3("vRefractionSize",d.boundingBoxSize)}}}this.pointsCloud&&u.updateFloat("pointSize",this.pointSize),a.SPECULARTERM&&u.updateColor4("vSpecularColor",this.specularColor,this.specularPower),u.updateColor3("vEmissiveColor",i.EmissiveTextureEnabled?this.emissiveColor:Ze.BlackReadOnly),u.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),s.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),u.updateColor3("vAmbientColor",this._globalAmbientColor)}s.texturesEnabled&&(this._diffuseTexture&&i.DiffuseTextureEnabled&&o.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&i.AmbientTextureEnabled&&o.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&i.OpacityTextureEnabled&&o.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&i.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?o.setTexture("reflectionCubeSampler",this._reflectionTexture):o.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&i.EmissiveTextureEnabled&&o.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&i.LightmapTextureEnabled&&o.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&i.SpecularTextureEnabled&&o.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&i.BumpTextureEnabled&&o.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&i.RefractionTextureEnabled&&(this._refractionTexture.isCube?o.setTexture("refractionCubeSampler",this._refractionTexture):o.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=n,this._callbackPluginEventBindForSubMesh(this._eventInfo),bn(o,this,s),this.bindEyePosition(o)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(s.lightsEnabled&&!this._disableLighting&&An.BindLights(s,t,o,a,this._maxSimultaneousLights),(s.fogEnabled&&t.applyFog&&s.fogMode!==zi.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||a.PREPASS)&&this.bindView(o),An.BindFogParameters(s,t,o),a.NUM_MORPH_INFLUENCERS&&An.BindMorphTargetParameters(t,o),a.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(r=t.bakedVertexAnimationManager)||void 0===r||r.bind(o,a.INSTANCES)),this.useLogarithmicDepth&&An.BindLogDepth(a,o,s),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),u.update()}}}},{key:"getAnimatables",value:function(){var e=c((0,h.Z)(i.prototype),"getAnimatables",this).call(this);return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}},{key:"getActiveTextures",value:function(){var e=c((0,h.Z)(i.prototype),"getActiveTextures",this).call(this);return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}},{key:"hasTexture",value:function(e){return!(!c((0,h.Z)(i.prototype),"hasTexture",this).call(this,e)&&this._diffuseTexture!==e&&this._ambientTexture!==e&&this._opacityTexture!==e&&this._reflectionTexture!==e&&this._emissiveTexture!==e&&this._specularTexture!==e&&this._bumpTexture!==e&&this._lightmapTexture!==e&&this._refractionTexture!==e)}},{key:"dispose",value:function(e,t){var n,r,s,a,o,l,u,d,f;t&&(null===(n=this._diffuseTexture)||void 0===n||n.dispose(),null===(r=this._ambientTexture)||void 0===r||r.dispose(),null===(s=this._opacityTexture)||void 0===s||s.dispose(),null===(a=this._reflectionTexture)||void 0===a||a.dispose(),null===(o=this._emissiveTexture)||void 0===o||o.dispose(),null===(l=this._specularTexture)||void 0===l||l.dispose(),null===(u=this._bumpTexture)||void 0===u||u.dispose(),null===(d=this._lightmapTexture)||void 0===d||d.dispose(),null===(f=this._refractionTexture)||void 0===f||f.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),c((0,h.Z)(i.prototype),"dispose",this).call(this,e,t)}},{key:"clone",value:function(e){var t=this,n=jt.Clone((function(){return new i(e,t.getScene())}),this);return n.name=e,n.id=e,this.stencil.copyTo(n.stencil),n}}],[{key:"Parse",value:function(e,t,n){var r=jt.Parse((function(){return new i(e.name,t)}),e,t,n);return e.stencil&&r.stencil.parse(e.stencil,t,n),r}},{key:"DiffuseTextureEnabled",get:function(){return Br.DiffuseTextureEnabled},set:function(e){Br.DiffuseTextureEnabled=e}},{key:"DetailTextureEnabled",get:function(){return Br.DetailTextureEnabled},set:function(e){Br.DetailTextureEnabled=e}},{key:"AmbientTextureEnabled",get:function(){return Br.AmbientTextureEnabled},set:function(e){Br.AmbientTextureEnabled=e}},{key:"OpacityTextureEnabled",get:function(){return Br.OpacityTextureEnabled},set:function(e){Br.OpacityTextureEnabled=e}},{key:"ReflectionTextureEnabled",get:function(){return Br.ReflectionTextureEnabled},set:function(e){Br.ReflectionTextureEnabled=e}},{key:"EmissiveTextureEnabled",get:function(){return Br.EmissiveTextureEnabled},set:function(e){Br.EmissiveTextureEnabled=e}},{key:"SpecularTextureEnabled",get:function(){return Br.SpecularTextureEnabled},set:function(e){Br.SpecularTextureEnabled=e}},{key:"BumpTextureEnabled",get:function(){return Br.BumpTextureEnabled},set:function(e){Br.BumpTextureEnabled=e}},{key:"LightmapTextureEnabled",get:function(){return Br.LightmapTextureEnabled},set:function(e){Br.LightmapTextureEnabled=e}},{key:"RefractionTextureEnabled",get:function(){return Br.RefractionTextureEnabled},set:function(e){Br.RefractionTextureEnabled=e}},{key:"ColorGradingTextureEnabled",get:function(){return Br.ColorGradingTextureEnabled},set:function(e){Br.ColorGradingTextureEnabled=e}},{key:"FresnelEnabled",get:function(){return Br.FresnelEnabled},set:function(e){Br.FresnelEnabled=e}}]),i}(Nr);Nt([Ht("diffuseTexture")],Zr.prototype,"_diffuseTexture",void 0),Nt([zt("_markAllSubMeshesAsTexturesAndMiscDirty")],Zr.prototype,"diffuseTexture",void 0),Nt([Ht("ambientTexture")],Zr.prototype,"_ambientTexture",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"ambientTexture",void 0),Nt([Ht("opacityTexture")],Zr.prototype,"_opacityTexture",void 0),Nt([zt("_markAllSubMeshesAsTexturesAndMiscDirty")],Zr.prototype,"opacityTexture",void 0),Nt([Ht("reflectionTexture")],Zr.prototype,"_reflectionTexture",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"reflectionTexture",void 0),Nt([Ht("emissiveTexture")],Zr.prototype,"_emissiveTexture",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"emissiveTexture",void 0),Nt([Ht("specularTexture")],Zr.prototype,"_specularTexture",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"specularTexture",void 0),Nt([Ht("bumpTexture")],Zr.prototype,"_bumpTexture",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"bumpTexture",void 0),Nt([Ht("lightmapTexture")],Zr.prototype,"_lightmapTexture",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"lightmapTexture",void 0),Nt([Ht("refractionTexture")],Zr.prototype,"_refractionTexture",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"refractionTexture",void 0),Nt([Zt("ambient")],Zr.prototype,"ambientColor",void 0),Nt([Zt("diffuse")],Zr.prototype,"diffuseColor",void 0),Nt([Zt("specular")],Zr.prototype,"specularColor",void 0),Nt([Zt("emissive")],Zr.prototype,"emissiveColor",void 0),Nt([Xt()],Zr.prototype,"specularPower",void 0),Nt([Xt("useAlphaFromDiffuseTexture")],Zr.prototype,"_useAlphaFromDiffuseTexture",void 0),Nt([zt("_markAllSubMeshesAsTexturesAndMiscDirty")],Zr.prototype,"useAlphaFromDiffuseTexture",void 0),Nt([Xt("useEmissiveAsIllumination")],Zr.prototype,"_useEmissiveAsIllumination",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"useEmissiveAsIllumination",void 0),Nt([Xt("linkEmissiveWithDiffuse")],Zr.prototype,"_linkEmissiveWithDiffuse",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"linkEmissiveWithDiffuse",void 0),Nt([Xt("useSpecularOverAlpha")],Zr.prototype,"_useSpecularOverAlpha",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"useSpecularOverAlpha",void 0),Nt([Xt("useReflectionOverAlpha")],Zr.prototype,"_useReflectionOverAlpha",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"useReflectionOverAlpha",void 0),Nt([Xt("disableLighting")],Zr.prototype,"_disableLighting",void 0),Nt([zt("_markAllSubMeshesAsLightsDirty")],Zr.prototype,"disableLighting",void 0),Nt([Xt("useObjectSpaceNormalMap")],Zr.prototype,"_useObjectSpaceNormalMap",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"useObjectSpaceNormalMap",void 0),Nt([Xt("useParallax")],Zr.prototype,"_useParallax",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"useParallax",void 0),Nt([Xt("useParallaxOcclusion")],Zr.prototype,"_useParallaxOcclusion",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"useParallaxOcclusion",void 0),Nt([Xt()],Zr.prototype,"parallaxScaleBias",void 0),Nt([Xt("roughness")],Zr.prototype,"_roughness",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"roughness",void 0),Nt([Xt()],Zr.prototype,"indexOfRefraction",void 0),Nt([Xt()],Zr.prototype,"invertRefractionY",void 0),Nt([Xt()],Zr.prototype,"alphaCutOff",void 0),Nt([Xt("useLightmapAsShadowmap")],Zr.prototype,"_useLightmapAsShadowmap",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"useLightmapAsShadowmap",void 0),Nt([Kt("diffuseFresnelParameters")],Zr.prototype,"_diffuseFresnelParameters",void 0),Nt([zt("_markAllSubMeshesAsFresnelDirty")],Zr.prototype,"diffuseFresnelParameters",void 0),Nt([Kt("opacityFresnelParameters")],Zr.prototype,"_opacityFresnelParameters",void 0),Nt([zt("_markAllSubMeshesAsFresnelAndMiscDirty")],Zr.prototype,"opacityFresnelParameters",void 0),Nt([Kt("reflectionFresnelParameters")],Zr.prototype,"_reflectionFresnelParameters",void 0),Nt([zt("_markAllSubMeshesAsFresnelDirty")],Zr.prototype,"reflectionFresnelParameters",void 0),Nt([Kt("refractionFresnelParameters")],Zr.prototype,"_refractionFresnelParameters",void 0),Nt([zt("_markAllSubMeshesAsFresnelDirty")],Zr.prototype,"refractionFresnelParameters",void 0),Nt([Kt("emissiveFresnelParameters")],Zr.prototype,"_emissiveFresnelParameters",void 0),Nt([zt("_markAllSubMeshesAsFresnelDirty")],Zr.prototype,"emissiveFresnelParameters",void 0),Nt([Xt("useReflectionFresnelFromSpecular")],Zr.prototype,"_useReflectionFresnelFromSpecular",void 0),Nt([zt("_markAllSubMeshesAsFresnelDirty")],Zr.prototype,"useReflectionFresnelFromSpecular",void 0),Nt([Xt("useGlossinessFromSpecularMapAlpha")],Zr.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"useGlossinessFromSpecularMapAlpha",void 0),Nt([Xt("maxSimultaneousLights")],Zr.prototype,"_maxSimultaneousLights",void 0),Nt([zt("_markAllSubMeshesAsLightsDirty")],Zr.prototype,"maxSimultaneousLights",void 0),Nt([Xt("invertNormalMapX")],Zr.prototype,"_invertNormalMapX",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"invertNormalMapX",void 0),Nt([Xt("invertNormalMapY")],Zr.prototype,"_invertNormalMapY",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"invertNormalMapY",void 0),Nt([Xt("twoSidedLighting")],Zr.prototype,"_twoSidedLighting",void 0),Nt([zt("_markAllSubMeshesAsTexturesDirty")],Zr.prototype,"twoSidedLighting",void 0),Nt([Xt()],Zr.prototype,"useLogarithmicDepth",null),N("BABYLON.StandardMaterial",Zr),zi.DefaultMaterialFactory=function(e){return new Zr("default material",e)};xe.IncludesShadersStore.imageProcessingCompatibility="#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));\n#endif\n";xe.ShadersStore.shadowOnlyPixelShader="precision highp float;\nuniform vec4 vEyePosition;\nuniform float alpha;\nuniform vec3 shadowColor;\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#include<helperFunctions>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(1.0,1.0,1.0);\n#endif\nvec3 diffuseBase=vec3(0.,0.,0.);\nlightingInfo info;\nfloat shadow=1.;\nfloat glossiness=0.;\n#include<lightFragment>[0..1]\nvec4 color=vec4(shadowColor,(1.0-clamp(shadow,0.,1.))*alpha);\n#include<fogFragment>\ngl_FragColor=color;\n#include<imageProcessingCompatibility>\n#define CUSTOM_FRAGMENT_MAIN_END\n}";xe.ShadersStore.shadowOnlyVertexShader="precision highp float;\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nuniform mat4 view;\nuniform mat4 viewProjection;\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(position,1.0);\ngl_Position=viewProjection*worldPos;\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nvNormalW=normalize(vec3(finalWorld*vec4(normal,0.0)));\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n";var Kr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(){var e;return(0,m.Z)(this,i),(e=t.call(this)).CLIPPLANE=!1,e.CLIPPLANE2=!1,e.CLIPPLANE3=!1,e.CLIPPLANE4=!1,e.CLIPPLANE5=!1,e.CLIPPLANE6=!1,e.POINTSIZE=!1,e.FOG=!1,e.NORMAL=!1,e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.INSTANCES=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.SKIPFINALCOLORCLAMP=!1,e.rebuild(),e}return(0,y.Z)(i)}(Jt),Yr=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r;return(0,m.Z)(this,i),(r=t.call(this,e,n))._needAlphaBlending=!0,r.shadowColor=Ze.Black(),r}return(0,y.Z)(i,[{key:"needAlphaBlending",value:function(){return this._needAlphaBlending}},{key:"needAlphaTesting",value:function(){return!1}},{key:"getAlphaTestTexture",value:function(){return null}},{key:"activeLight",get:function(){return this._activeLight},set:function(e){this._activeLight=e}},{key:"_getFirstShadowLightForMesh",value:function(e){var t,i=(0,p.Z)(e.lightSources);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(n.shadowEnabled)return n}}catch(r){i.e(r)}finally{i.f()}return null}},{key:"isReadyForSubMesh",value:function(e,t,i){var n;if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new Kr);var r=t.materialDefines,s=this.getScene();if(this._isReadyForSubMesh(t))return!0;var a=s.getEngine();if(this._activeLight){var o,l=(0,p.Z)(e.lightSources);try{for(l.s();!(o=l.n()).done;){var u=o.value;if(u.shadowEnabled){if(this._activeLight===u)break;var h=e.lightSources.indexOf(this._activeLight);-1!==h&&(e.lightSources.splice(h,1),e.lightSources.splice(0,0,this._activeLight));break}}}catch(T){l.e(T)}finally{l.f()}}An.PrepareDefinesForFrameBoundValues(s,a,this,r,!!i),An.PrepareDefinesForMisc(e,s,!1,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),r),r._needNormals=An.PrepareDefinesForLights(s,e,r,!1,1);var c=null===(n=this._getFirstShadowLightForMesh(e))||void 0===n?void 0:n.getShadowGenerator();if(this._needAlphaBlending=!0,c&&c.getClassName&&"CascadedShadowGenerator"===c.getClassName()){var d=c;this._needAlphaBlending=!d.autoCalcDepthBounds}if(An.PrepareDefinesForAttributes(e,r,!1,!0),r.isDirty){r.markAsProcessed(),s.resetCachedMaterial();var f=new Tr;r.FOG&&f.addFallback(1,"FOG"),An.HandleFallbacksForShadows(r,f,1),r.NUM_BONE_INFLUENCERS>0&&f.addCPUSkinningFallback(0,e),r.IMAGEPROCESSINGPOSTPROCESS=s.imageProcessingConfiguration.applyByPostProcess;var _=[ni.PositionKind];r.NORMAL&&_.push(ni.NormalKind),An.PrepareAttributesForBones(_,e,r,f),An.PrepareAttributesForInstances(_,r);var v=r.toString(),g=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","alpha","shadowColor","mBones"],m=new Array,y=new Array;En(g),An.PrepareUniformsAndSamplersList({uniformsNames:g,uniformBuffersNames:y,samplers:m,defines:r,maxSimultaneousLights:1}),t.setEffect(s.getEngine().createEffect("shadowOnly",{attributes:_,uniformsNames:g,uniformBuffersNames:y,samplers:m,defines:v,fallbacks:f,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:1}},a),r,this._materialContext)}return!(!t.effect||!t.effect.isReady())&&(r._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=!!i,!0)}},{key:"bindForSubMesh",value:function(e,t,i){var n=this.getScene(),r=i.materialDefines;if(r){var s=i.effect;if(s){if(this._activeEffect=s,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",n.getTransformMatrix()),An.BindBonesParameters(t,this._activeEffect),this._mustRebind(n,s)&&(bn(s,this,n),this.pointsCloud&&this._activeEffect.setFloat("pointSize",this.pointSize),this._activeEffect.setFloat("alpha",this.alpha),this._activeEffect.setColor3("shadowColor",this.shadowColor),n.bindEyePosition(s)),n.lightsEnabled){An.BindLights(n,t,this._activeEffect,r,1);var a=this._getFirstShadowLightForMesh(t);a&&(a._renderId=-1)}(n.fogEnabled&&t.applyFog&&n.fogMode!==zi.FOGMODE_NONE||r.SHADOWCSM0)&&this._activeEffect.setMatrix("view",n.getViewMatrix()),An.BindFogParameters(n,t,this._activeEffect),this._afterBind(t,this._activeEffect)}}}},{key:"clone",value:function(e){var t=this;return jt.Clone((function(){return new i(e,t.getScene())}),this)}},{key:"serialize",value:function(){var e=c((0,h.Z)(i.prototype),"serialize",this).call(this);return e.customType="BABYLON.ShadowOnlyMaterial",e}},{key:"getClassName",value:function(){return"ShadowOnlyMaterial"}}],[{key:"Parse",value:function(e,t,n){return jt.Parse((function(){return new i(e.name,t)}),e,t,n)}}]),i}(Nr);N("BABYLON.ShadowOnlyMaterial",Yr);var qr,jr={aspect:2,enableDebugging:!1,enableShadows:!0},Qr=function(){function e(t){(0,m.Z)(this,e),b(this,"size",9.5),this.config=(0,a.Z)((0,a.Z)({},jr),t),this.create()}return(0,y.Z)(e,[{key:"create",value:function(e){this.destroy(),Object.assign(this.config,e);var t,i=this.config,n=i.aspect,r=i.enableDebugging,s=void 0===r||r,a=i.enableShadows,o=30;this.box=new gn("diceBox"),s?((t=new Zr("diceBox_material")).alpha=.7,t.diffuseColor=new Ze(1,1,0)):a&&(t=new Yr("shadowOnly",this.config.scene));var l=Or("ground",{width:2*this.size,height:1,depth:2*this.size},this.config.scene);if(l.scaling=new z(n,1,1),l.material=t,l.receiveShadows=!0,l.setParent(this.box),s){var u=Or("wallTop",{width:this.size,height:o,depth:1},this.config.scene);u.position.y=15,u.position.z=this.size/-2,u.scaling=new z(n,1,1),u.material=t,u.setParent(this.box);var h=Or("wallRight",{width:1,height:o,depth:this.size},this.config.scene);h.position.x=this.size*n/2,h.position.y=15,h.material=t,h.setParent(this.box);var c=Or("wallBottom",{width:this.size,height:o,depth:1},this.config.scene);c.position.y=15,c.position.z=this.size/2,c.scaling=new z(n,1,1),c.material=t,c.setParent(this.box);var d=Or("wallLeft",{width:1,height:o,depth:this.size},this.config.scene);d.position.x=this.size*n/-2,d.position.y=15,d.material=t,d.setParent(this.box)}}},{key:"destroy",value:function(){this.box&&this.box.dispose()}}]),e}();!function(e){e[e.Clean=0]="Clean",e[e.Stop=1]="Stop",e[e.Sync=2]="Sync",e[e.NoSync=3]="NoSync"}(qr||(qr={}));var Jr=function(){function e(){(0,m.Z)(this,e)}return(0,y.Z)(e,null,[{key:"ForceFullSceneLoadingForIncremental",get:function(){return hn.ForceFullSceneLoadingForIncremental},set:function(e){hn.ForceFullSceneLoadingForIncremental=e}},{key:"ShowLoadingScreen",get:function(){return hn.ShowLoadingScreen},set:function(e){hn.ShowLoadingScreen=e}},{key:"loggingLevel",get:function(){return hn.loggingLevel},set:function(e){hn.loggingLevel=e}},{key:"CleanBoneMatrixWeights",get:function(){return hn.CleanBoneMatrixWeights},set:function(e){hn.CleanBoneMatrixWeights=e}},{key:"GetDefaultPlugin",value:function(){return e._RegisteredPlugins[".babylon"]}},{key:"_GetPluginForExtension",value:function(t){return e._RegisteredPlugins[t]||(ue.Warn("Unable to find a plugin to load "+t+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),e.GetDefaultPlugin())}},{key:"_GetPluginForDirectLoad",value:function(t){for(var i in e._RegisteredPlugins){var n=e._RegisteredPlugins[i].plugin;if(n.canDirectLoad&&n.canDirectLoad(t))return e._RegisteredPlugins[i]}return e.GetDefaultPlugin()}},{key:"_GetPluginForFilename",value:function(t){var i=t.indexOf("?");-1!==i&&(t=t.substring(0,i));var n=t.lastIndexOf("."),r=t.substring(n,t.length).toLowerCase();return e._GetPluginForExtension(r)}},{key:"_GetDirectLoad",value:function(e){return"data:"===e.substr(0,5)?e.substr(5):null}},{key:"_FormatErrorMessage",value:function(e,t,i){var n="Unable to load from "+e.url;return t?n+=": ".concat(t):i&&(n+=": ".concat(i)),n}},{key:"_LoadData",value:function(t,i,n,r,s,a,o){var l,u=e._GetDirectLoad(t.url),h=o?e._GetPluginForExtension(o):u?e._GetPluginForDirectLoad(t.url):e._GetPluginForFilename(t.url);if(!(l=void 0!==h.plugin.createPlugin?h.plugin.createPlugin():h.plugin))throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(e.OnPluginActivatedObservable.notifyObservers(l),u&&(l.canDirectLoad&&l.canDirectLoad(t.url)||!St(t.url))){if(l.directLoad){var c=l.directLoad(i,u);c.then?c.then((function(e){n(l,e)})).catch((function(e){s("Error in directLoad of _loadData: "+e,e)})):n(l,c)}else n(l,u);return l}var d=h.isBinary,f=function(e,t){i.isDisposed?s("Scene has been disposed"):n(l,e,t)},_=null,v=!1,g=l.onDisposeObservable;g&&g.add((function(){v=!0,_&&(_.abort(),_=null),a()}));var m=function(){if(!v){var e=function(e,t){s(null==e?void 0:e.statusText,t)},n=t.file||t.url;_=l.loadFile?l.loadFile(i,n,f,r,d,e):i._loadFile(n,f,r,!0,d,e)}},y=i.getEngine(),T=y.enableOfflineSupport;if(T){var E,S=!1,b=(0,p.Z)(i.disableOfflineSupportExceptionRules);try{for(b.s();!(E=b.n()).done;){if(E.value.test(t.url)){S=!0;break}}}catch(x){b.e(x)}finally{b.f()}T=!S}return T&&Xe.OfflineProviderFactory?i.offlineProvider=Xe.OfflineProviderFactory(t.url,m,y.disableManifestCheck):m(),l}},{key:"_GetFileInfo",value:function(e,t){var i,n,r=null;if(t)if(t.name){var s=t;i="file:".concat(s.name),n=s.name,r=s}else if("string"==typeof t&&t.startsWith("data:"))i=t,n="";else{var a=t;if("/"===a.substr(0,1))return It.Error("Wrong sceneFilename parameter"),null;i=e+a,n=a}else i=e,n=It.GetFilename(e),e=It.GetFolderPath(e);return{url:i,rootUrl:e,name:n,file:r}}},{key:"GetPluginForExtension",value:function(t){return e._GetPluginForExtension(t).plugin}},{key:"IsPluginForExtensionAvailable",value:function(t){return!!e._RegisteredPlugins[t]}},{key:"RegisterPlugin",value:function(t){if("string"==typeof t.extensions){var i=t.extensions;e._RegisteredPlugins[i.toLowerCase()]={plugin:t,isBinary:!1}}else{var n=t.extensions;Object.keys(n).forEach((function(i){e._RegisteredPlugins[i.toLowerCase()]={plugin:t,isBinary:n[i].isBinary}}))}}},{key:"ImportMesh",value:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:V.LastCreatedScene,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(!r)return ue.Error("No scene available to import mesh to"),null;var u=e._GetFileInfo(i,n);if(!u)return null;var h={};r.addPendingData(h);var c=function(){r.removePendingData(h)},d=function(t,i){var n=e._FormatErrorMessage(u,t,i);o?o(r,n,new at(n,it,i)):ue.Error(n),c()},f=a?function(e){try{a(e)}catch(t){d("Error in onProgress callback: "+t,t)}}:void 0,_=function(e,t,i,n,a,o,l){if(r.importedMeshesFiles.push(u.url),s)try{s(e,t,i,n,a,o,l)}catch(c){d("Error in onSuccess callback: "+c,c)}r.removePendingData(h)};return e._LoadData(u,r,(function(e,i,n){if(e.rewriteRootURL&&(u.rootUrl=e.rewriteRootURL(u.rootUrl,n)),e.importMesh){var s=e,a=new Array,o=new Array,l=new Array;if(!s.importMesh(t,r,i,u.rootUrl,a,o,l,d))return;r.loadingPluginName=e.name,_(a,o,l,[],[],[],[])}else e.importMeshAsync(t,r,i,u.rootUrl,f,u.name).then((function(t){r.loadingPluginName=e.name,_(t.meshes,t.particleSystems,t.skeletons,t.animationGroups,t.transformNodes,t.geometries,t.lights)})).catch((function(e){d(e.message,e)}))}),f,d,c,l)}},{key:"ImportMeshAsync",value:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:V.LastCreatedScene,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;return new Promise((function(o,l){e.ImportMesh(t,i,n,r,(function(e,t,i,n,r,s,a){o({meshes:e,particleSystems:t,skeletons:i,animationGroups:n,transformNodes:r,geometries:s,lights:a})}),s,(function(e,t,i){l(i||new Error(t))}),a)}))}},{key:"Load",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:V.LastCreatedEngine,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;return n?e.Append(t,i,new zi(n),r,s,a,o):(It.Error("No engine available"),null)}},{key:"LoadAsync",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:V.LastCreatedEngine,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return new Promise((function(a,o){e.Load(t,i,n,(function(e){a(e)}),r,(function(e,t,i){o(i||new Error(t))}),s)}))}},{key:"Append",value:function(t){var i=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:V.LastCreatedScene,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;if(!r)return ue.Error("No scene available to append to"),null;var u=e._GetFileInfo(t,n);if(!u)return null;var h={};r.addPendingData(h);var c=function(){r.removePendingData(h)};e.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,r.getEngine().displayLoadingUI(),r.executeWhenReady((function(){r.getEngine().hideLoadingUI(),i._ShowingLoadingScreen=!1})));var d=function(t,i){var n=e._FormatErrorMessage(u,t,i);o?o(r,n,new at(n,it,i)):ue.Error(n),c()},f=a?function(e){try{a(e)}catch(t){d("Error in onProgress callback",t)}}:void 0,_=function(){if(s)try{s(r)}catch(e){d("Error in onSuccess callback",e)}r.removePendingData(h)};return e._LoadData(u,r,(function(e,t){if(e.load){if(!e.load(r,t,u.rootUrl,d))return;r.loadingPluginName=e.name,_()}else e.loadAsync(r,t,u.rootUrl,f,u.name).then((function(){r.loadingPluginName=e.name,_()})).catch((function(e){d(e.message,e)}))}),f,d,c,l)}},{key:"AppendAsync",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:V.LastCreatedScene,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return new Promise((function(a,o){e.Append(t,i,n,(function(e){a(e)}),r,(function(e,t,i){o(i||new Error(t))}),s)}))}},{key:"LoadAssetContainer",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:V.LastCreatedScene,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;if(!n)return ue.Error("No scene available to load asset container to"),null;var l=e._GetFileInfo(t,i);if(!l)return null;var u={};n.addPendingData(u);var h=function(){n.removePendingData(u)},c=function(t,i){var r=e._FormatErrorMessage(l,t,i);a?a(n,r,new at(r,it,i)):ue.Error(r),h()},d=s?function(e){try{s(e)}catch(t){c("Error in onProgress callback",t)}}:void 0,f=function(e){if(r)try{r(e)}catch(t){c("Error in onSuccess callback",t)}n.removePendingData(u)};return e._LoadData(l,n,(function(e,t){if(e.loadAssetContainer){var i=e.loadAssetContainer(n,t,l.rootUrl,c);if(!i)return;n.loadingPluginName=e.name,f(i)}else e.loadAssetContainerAsync?e.loadAssetContainerAsync(n,t,l.rootUrl,d,l.name).then((function(t){n.loadingPluginName=e.name,f(t)})).catch((function(e){c(e.message,e)})):c("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")}),d,c,h,o)}},{key:"LoadAssetContainerAsync",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:V.LastCreatedScene,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return new Promise((function(a,o){e.LoadAssetContainer(t,i,n,(function(e){a(e)}),r,(function(e,t,i){o(i||new Error(t))}),s)}))}},{key:"ImportAnimations",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:V.LastCreatedScene,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:qr.Clean,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null;if(i){if(n){var h,c=(0,p.Z)(i.animatables);try{for(c.s();!(h=c.n()).done;){h.value.reset()}}catch(f){c.e(f)}finally{c.f()}i.stopAllAnimations(),i.animationGroups.slice().forEach((function(e){e.dispose()})),i.getNodes().forEach((function(e){e.animations&&(e.animations=[])}))}else switch(r){case qr.Clean:i.animationGroups.slice().forEach((function(e){e.dispose()}));break;case qr.Stop:i.animationGroups.forEach((function(e){e.stop()}));break;case qr.Sync:i.animationGroups.forEach((function(e){e.reset(),e.restart()}));break;case qr.NoSync:break;default:return void ue.Error("Unknown animation group loading mode value '"+r+"'")}var d=i.animatables.length;this.LoadAssetContainer(e,t,i,(function(e){e.mergeAnimationsTo(i,i.animatables.slice(d),s),e.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),a&&a(i)}),o,l,u)}else ue.Error("No scene available to load animations to")}},{key:"ImportAnimationsAsync",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:V.LastCreatedScene,r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:qr.Clean,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,l=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null;return new Promise((function(u,h){e.ImportAnimations(t,i,n,r,s,a,(function(e){u(e)}),o,(function(e,t,i){h(i||new Error(t))}),l)}))}}]),e}();Jr.NO_LOGGING=0,Jr.MINIMAL_LOGGING=1,Jr.SUMMARY_LOGGING=2,Jr.DETAILED_LOGGING=3,Jr.OnPluginActivatedObservable=new ee,Jr._RegisteredPlugins={},Jr._ShowingLoadingScreen=!1;var $r=function(){function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE;(0,m.Z)(this,e),this.origin=t,this.direction=i,this.length=n}return(0,y.Z)(e,[{key:"clone",value:function(){return new e(this.origin.clone(),this.direction.clone(),this.length)}},{key:"intersectsBoxMinMax",value:function(t,i){var n,r,s,a,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,l=e._TmpVector3[0].copyFromFloats(t.x-o,t.y-o,t.z-o),u=e._TmpVector3[1].copyFromFloats(i.x+o,i.y+o,i.z+o),h=0,c=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<l.x||this.origin.x>u.x)return!1}else if(n=1/this.direction.x,r=(l.x-this.origin.x)*n,(s=(u.x-this.origin.x)*n)===-1/0&&(s=1/0),r>s&&(a=r,r=s,s=a),(h=Math.max(r,h))>(c=Math.min(s,c)))return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<l.y||this.origin.y>u.y)return!1}else if(n=1/this.direction.y,r=(l.y-this.origin.y)*n,(s=(u.y-this.origin.y)*n)===-1/0&&(s=1/0),r>s&&(a=r,r=s,s=a),(h=Math.max(r,h))>(c=Math.min(s,c)))return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<l.z||this.origin.z>u.z)return!1}else if(n=1/this.direction.z,r=(l.z-this.origin.z)*n,(s=(u.z-this.origin.z)*n)===-1/0&&(s=1/0),r>s&&(a=r,r=s,s=a),(h=Math.max(r,h))>(c=Math.min(s,c)))return!1;return!0}},{key:"intersectsBox",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}},{key:"intersectsSphere",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e.center.x-this.origin.x,n=e.center.y-this.origin.y,r=e.center.z-this.origin.z,s=i*i+n*n+r*r,a=e.radius+t,o=a*a;if(s<=o)return!0;var l=i*this.direction.x+n*this.direction.y+r*this.direction.z;return!(l<0)&&s-l*l<=o}},{key:"intersectsTriangle",value:function(t,i,n){var r=e._TmpVector3[0],s=e._TmpVector3[1],a=e._TmpVector3[2],o=e._TmpVector3[3],l=e._TmpVector3[4];i.subtractToRef(t,r),n.subtractToRef(t,s),z.CrossToRef(this.direction,s,a);var u=z.Dot(r,a);if(0===u)return null;var h=1/u;this.origin.subtractToRef(t,o);var c=z.Dot(o,a)*h;if(c<0||c>1)return null;z.CrossToRef(o,r,l);var d=z.Dot(this.direction,l)*h;if(d<0||c+d>1)return null;var f=z.Dot(s,l)*h;return f>this.length?null:new Ji(1-c-d,c,f)}},{key:"intersectsPlane",value:function(e){var t,i=z.Dot(e.normal,this.direction);if(Math.abs(i)<9.99999997475243e-7)return null;var n=z.Dot(e.normal,this.origin);return(t=(-e.d-n)/i)<0?t<-9.99999997475243e-7?null:0:t}},{key:"intersectsAxis",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;switch(e){case"y":var i=(this.origin.y-t)/this.direction.y;return i>0?null:new z(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i);case"x":var n=(this.origin.x-t)/this.direction.x;return n>0?null:new z(t,this.origin.y+this.direction.y*-n,this.origin.z+this.direction.z*-n);case"z":var r=(this.origin.z-t)/this.direction.z;return r>0?null:new z(this.origin.x+this.direction.x*-r,this.origin.y+this.direction.y*-r,t);default:return null}}},{key:"intersectsMesh",value:function(t,i){var n=Y.Matrix[0];return t.getWorldMatrix().invertToRef(n),this._tmpRay?e.TransformToRef(this,n,this._tmpRay):this._tmpRay=e.Transform(this,n),t.intersects(this._tmpRay,i)}},{key:"intersectsMeshes",value:function(e,t,i){i?i.length=0:i=[];for(var n=0;n<e.length;n++){var r=this.intersectsMesh(e[n],t);r.hit&&i.push(r)}return i.sort(this._comparePickingInfo),i}},{key:"_comparePickingInfo",value:function(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}},{key:"intersectionSegment",value:function(t,i,n){var r=this.origin,s=Y.Vector3[0],a=Y.Vector3[1],o=Y.Vector3[2],l=Y.Vector3[3];i.subtractToRef(t,s),this.direction.scaleToRef(e._Rayl,o),r.addToRef(o,a),t.subtractToRef(r,l);var u,h,c=z.Dot(s,s),d=z.Dot(s,o),f=z.Dot(o,o),_=z.Dot(s,l),v=z.Dot(o,l),g=c*f-d*d,p=g,m=g;g<e._Smallnum?(u=0,p=1,h=v,m=f):(h=c*v-d*_,(u=d*v-f*_)<0?(u=0,h=v,m=f):u>p&&(u=p,h=v+d,m=f)),h<0?(h=0,-_<0?u=0:-_>c?u=p:(u=-_,p=c)):h>m&&(h=m,-_+d<0?u=0:-_+d>c?u=p:(u=-_+d,p=c));var y=Math.abs(u)<e._Smallnum?0:u/p,T=Math.abs(h)<e._Smallnum?0:h/m,E=Y.Vector3[4];o.scaleToRef(T,E);var S=Y.Vector3[5];s.scaleToRef(y,S),S.addInPlace(l);var b=Y.Vector3[6];return S.subtractToRef(E,b),T>0&&T<=this.length&&b.lengthSquared()<n*n?S.length():-1}},{key:"update",value:function(t,i,n,r,s,a,o){if(arguments.length>7&&void 0!==arguments[7]&&arguments[7]){e._RayDistant||(e._RayDistant=e.Zero()),e._RayDistant.unprojectRayToRef(t,i,n,r,Z.IdentityReadOnly,a,o);var l=Y.Matrix[0];s.invertToRef(l),e.TransformToRef(e._RayDistant,l,this)}else this.unprojectRayToRef(t,i,n,r,s,a,o);return this}},{key:"unprojectRayToRef",value:function(e,t,i,n,r,s,a){var o,l=Y.Matrix[0];r.multiplyToRef(s,l),l.multiplyToRef(a,l),l.invert();var u=Y.Vector3[0];u.x=e/i*2-1,u.y=-(t/n*2-1),u.z=null!==(o=V.LastCreatedEngine)&&void 0!==o&&o.isNDCHalfZRange?0:-1;var h=Y.Vector3[1].copyFromFloats(u.x,u.y,1-1e-8),c=Y.Vector3[2],d=Y.Vector3[3];z._UnprojectFromInvertedMatrixToRef(u,l,c),z._UnprojectFromInvertedMatrixToRef(h,l,d),this.origin.copyFrom(c),d.subtractToRef(c,this.direction),this.direction.normalize()}}],[{key:"Zero",value:function(){return new e(z.Zero(),z.Zero())}},{key:"CreateNew",value:function(t,i,n,r,s,a,o){return e.Zero().update(t,i,n,r,s,a,o)}},{key:"CreateNewFromTo",value:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Z.IdentityReadOnly,r=i.subtract(t),s=Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z);return r.normalize(),e.Transform(new e(t,r,s),n)}},{key:"Transform",value:function(t,i){var n=new e(new z(0,0,0),new z(0,0,0));return e.TransformToRef(t,i,n),n}},{key:"TransformToRef",value:function(e,t,i){z.TransformCoordinatesToRef(e.origin,t,i.origin),z.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length;var n=i.direction,r=n.length();if(0!==r&&1!==r){var s=1/r;n.x*=s,n.y*=s,n.z*=s,i.length*=r}}}]),e}();$r._TmpVector3=F.BuildArray(6,z.Zero),$r._RayDistant=$r.Zero(),$r._Smallnum=1e-8,$r._Rayl=1e9,zi.prototype.createPickingRay=function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=$r.Zero();return this.createPickingRayToRef(e,t,i,s,n,r),s},zi.prototype.createPickingRayToRef=function(e,t,i,n,r){var s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=arguments.length>6&&void 0!==arguments[6]&&arguments[6],o=this.getEngine();if(!r){if(!this.activeCamera)return this;r=this.activeCamera}var l=r.viewport.toGlobal(o.getRenderWidth(),o.getRenderHeight());return e=e/o.getHardwareScalingLevel()-l.x,t=t/o.getHardwareScalingLevel()-(o.getRenderHeight()-l.y-l.height),n.update(e,t,l.width,l.height,i||Z.IdentityReadOnly,s?Z.IdentityReadOnly:r.getViewMatrix(),r.getProjectionMatrix(),a),this},zi.prototype.createPickingRayInCameraSpace=function(e,t,i){var n=$r.Zero();return this.createPickingRayInCameraSpaceToRef(e,t,n,i),n},zi.prototype.createPickingRayInCameraSpaceToRef=function(e,t,i,n){if(!ri)return this;var r=this.getEngine();if(!n){if(!this.activeCamera)throw new Error("Active camera not set");n=this.activeCamera}var s=n.viewport.toGlobal(r.getRenderWidth(),r.getRenderHeight()),a=Z.Identity();return e=e/r.getHardwareScalingLevel()-s.x,t=t/r.getHardwareScalingLevel()-(r.getRenderHeight()-s.y-s.height),i.update(e,t,s.width,s.height,a,a,n.getProjectionMatrix()),this},zi.prototype._internalPickForMesh=function(e,t,i,n,r,s,a,o){var l=t(n,i.enableDistantPicking),u=i.intersects(l,r,a,s,n,o);return!u||!u.hit||!r&&null!=e&&u.distance>=e.distance?null:u},zi.prototype._internalPick=function(e,t,i,n,r){for(var s=null,a=0;a<this.meshes.length;a++){var o=this.meshes[a];if(t){if(!t(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;var l=o.getWorldMatrix();if(o.hasThinInstances&&o.thinInstanceEnablePicking){var u=this._internalPickForMesh(s,e,o,l,!0,!0,r);if(u){if(n)return u;for(var h=Y.Matrix[1],c=o.thinInstanceGetWorldMatrices(),d=0;d<c.length;d++){c[d].multiplyToRef(l,h);var f=this._internalPickForMesh(s,e,o,h,i,n,r,!0);if(f&&((s=f).thinInstanceIndex=d,i))return s}}}else{var _=this._internalPickForMesh(s,e,o,l,i,n,r);if(_&&(s=_,i))return s}}return s||new ri},zi.prototype._internalMultiPick=function(e,t,i){if(!ri)return null;for(var n=new Array,r=0;r<this.meshes.length;r++){var s=this.meshes[r];if(t){if(!t(s))continue}else if(!s.isEnabled()||!s.isVisible||!s.isPickable)continue;var a=s.getWorldMatrix();if(s.hasThinInstances&&s.thinInstanceEnablePicking){if(this._internalPickForMesh(null,e,s,a,!0,!0,i))for(var o=Y.Matrix[1],l=s.thinInstanceGetWorldMatrices(),u=0;u<l.length;u++){l[u].multiplyToRef(a,o);var h=this._internalPickForMesh(null,e,s,o,!1,!1,i,!0);h&&(h.thinInstanceIndex=u,n.push(h))}}else{var c=this._internalPickForMesh(null,e,s,a,!1,!1,i);c&&n.push(c)}}return n},zi.prototype.pickWithBoundingInfo=function(e,t,i,n,r){var s=this;if(!ri)return null;var a=this._internalPick((function(i){return s._tempPickingRay||(s._tempPickingRay=$r.Zero()),s.createPickingRayToRef(e,t,i,s._tempPickingRay,r||null),s._tempPickingRay}),i,n,!0);return a&&(a.ray=this.createPickingRay(e,t,Z.Identity(),r||null)),a},Object.defineProperty(zi.prototype,"_pickingAvailable",{get:function(){return!0},enumerable:!1,configurable:!1}),zi.prototype.pick=function(e,t,i,n,r,s){var a=this,o=this._internalPick((function(i,n){return a._tempPickingRay||(a._tempPickingRay=$r.Zero()),a.createPickingRayToRef(e,t,i,a._tempPickingRay,r||null,!1,n),a._tempPickingRay}),i,n,!1,s);return o&&(o.ray=this.createPickingRay(e,t,Z.Identity(),r||null)),o},zi.prototype.pickWithRay=function(e,t,i,n){var r=this,s=this._internalPick((function(t){return r._pickWithRayInverseMatrix||(r._pickWithRayInverseMatrix=Z.Identity()),t.invertToRef(r._pickWithRayInverseMatrix),r._cachedRayForTransform||(r._cachedRayForTransform=$r.Zero()),$r.TransformToRef(e,r._pickWithRayInverseMatrix,r._cachedRayForTransform),r._cachedRayForTransform}),t,i,!1,n);return s&&(s.ray=e),s},zi.prototype.multiPick=function(e,t,i,n,r){var s=this;return this._internalMultiPick((function(i){return s.createPickingRay(e,t,i,n||null)}),i,r)},zi.prototype.multiPickWithRay=function(e,t,i){var n=this;return this._internalMultiPick((function(t){return n._pickWithRayInverseMatrix||(n._pickWithRayInverseMatrix=Z.Identity()),t.invertToRef(n._pickWithRayInverseMatrix),n._cachedRayForTransform||(n._cachedRayForTransform=$r.Zero()),$r.TransformToRef(e,n._pickWithRayInverseMatrix,n._cachedRayForTransform),n._cachedRayForTransform}),t,i)},ji.prototype.getForwardRay=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;return this.getForwardRayToRef(new $r(z.Zero(),z.Zero(),e),e,t,i)},ji.prototype.getForwardRayToRef=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;return i||(i=this.getWorldMatrix()),e.length=t,n?e.origin.copyFrom(n):e.origin.copyFrom(this.position),Y.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),z.TransformNormalToRef(Y.Vector3[2],i,Y.Vector3[3]),z.NormalizeToRef(Y.Vector3[3],e.direction),e};var es=function(e,t,i){for(var n in t)if(e.name===t[n])return i.push(e.id),!0;return!(!e.parentId||-1===i.indexOf(e.parentId))&&(i.push(e.id),!0)},ts=function(e,t){return e+" of "+(t?t.file+" from "+t.name+" version: "+t.version+", exporter version: "+t.exporter_version:"unknown")};Jr.RegisterPlugin({name:"babylon.js",extensions:".json",canDirectLoad:function(e){return e.indexOf("json"),!0},importMesh:function(e,t,i,n,r,s,a,o){var l="importMesh has failed JSON parse";try{var u=JSON.parse(i);u.physicsEnabled=!1,null==u||u.meshes.map((function(e){return delete e.physicsImpostor})),l="";var h=Jr.loggingLevel===Jr.DETAILED_LOGGING;e?Array.isArray(e)||(e=[e]):e=null;var c=new Array;if(void 0!==u.meshes&&null!==u.meshes){var d,f,_;for(d=0,f=u.meshes.length;d<f;d++){var v=u.meshes[d];if(null===e||es(v,e,c)){null!==e&&delete e[e.indexOf(v.name)];var g=Ln.Parse(v,t,n);r.push(g),l+="\n\tMesh "+g.toString(h)}}for(d=0,f=t.meshes.length;d<f;d++)(_=t.meshes[d])._waitingParentId&&(_.parent=t.getLastEntryByID(_._waitingParentId),_._waitingParentId=null),_.computeWorldMatrix(!0)}return!0}catch(m){var p=ts("importMesh",u?u.producer:"Unknown")+l;if(!o)throw ue.Log(p),m;o(p,m)}finally{null!==l&&Jr.loggingLevel!==Jr.NO_LOGGING&&ue.Log(ts("importMesh",u?u.producer:"Unknown")+(Jr.loggingLevel!==Jr.MINIMAL_LOGGING?l:""))}return!1},load:function(e,t,i,n){var r="importScene has failed JSON parse";try{var s=JSON.parse(t);return r="",void 0!==s.clearColor&&null!==s.clearColor&&(e.clearColor=Color4.FromArray(s.clearColor)),!!loadAssetContainer(e,t,i,n,!0)}catch(o){var a=ts("importScene",s?s.producer:"Unknown")+r;if(!n)throw ue.Log(a),o;n(a,o)}finally{null!==r&&Jr.loggingLevel!==Jr.NO_LOGGING&&ue.Log(ts("importScene",s?s.producer:"Unknown")+(Jr.loggingLevel!==Jr.MINIMAL_LOGGING?r:""))}return!1},loadAssetContainer:function(e){function t(t,i,n,r){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e,t,i,n){return loadAssetContainer(e,t,i,n)}))}),Ln._instancedMeshFactory=function(e,t){var i=new is(e,t);if(t.instancedBuffers)for(var n in i.instancedBuffers={},t.instancedBuffers)i.instancedBuffers[n]=t.instancedBuffers[n];return i};var is=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r;(0,m.Z)(this,i),(r=t.call(this,e,n.getScene()))._indexInSourceMeshInstanceArray=-1,r._distanceToCamera=0,n.addInstance((0,u.Z)(r)),r._sourceMesh=n,r._unIndexed=n._unIndexed,r.position.copyFrom(n.position),r.rotation.copyFrom(n.rotation),r.scaling.copyFrom(n.scaling),n.rotationQuaternion&&(r.rotationQuaternion=n.rotationQuaternion.clone()),r.animations=n.animations.slice();var s,a=(0,p.Z)(n.getAnimationRanges());try{for(a.s();!(s=a.n()).done;){var o=s.value;null!=o&&r.createAnimationRange(o.name,o.from,o.to)}}catch(l){a.e(l)}finally{a.f()}return r.infiniteDistance=n.infiniteDistance,r.setPivotMatrix(n.getPivotMatrix()),r.refreshBoundingInfo(!0,!0),r._syncSubMeshes(),r}return(0,y.Z)(i,[{key:"getClassName",value:function(){return"InstancedMesh"}},{key:"lightSources",get:function(){return this._sourceMesh._lightSources}},{key:"_resyncLightSources",value:function(){}},{key:"_resyncLightSource",value:function(){}},{key:"_removeLightSource",value:function(){}},{key:"receiveShadows",get:function(){return this._sourceMesh.receiveShadows}},{key:"material",get:function(){return this._sourceMesh.material}},{key:"visibility",get:function(){return this._sourceMesh.visibility}},{key:"skeleton",get:function(){return this._sourceMesh.skeleton}},{key:"renderingGroupId",get:function(){return this._sourceMesh.renderingGroupId},set:function(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||ue.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}},{key:"getTotalVertices",value:function(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}},{key:"getTotalIndices",value:function(){return this._sourceMesh.getTotalIndices()}},{key:"sourceMesh",get:function(){return this._sourceMesh}},{key:"createInstance",value:function(e){return this._sourceMesh.createInstance(e)}},{key:"isReady",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._sourceMesh.isReady(e,!0)}},{key:"getVerticesData",value:function(e,t){return this._sourceMesh.getVerticesData(e,t)}},{key:"setVerticesData",value:function(e,t,i,n){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,n),this.sourceMesh}},{key:"updateVerticesData",value:function(e,t,i,n){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,n),this.sourceMesh}},{key:"setIndices",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}},{key:"isVerticesDataPresent",value:function(e){return this._sourceMesh.isVerticesDataPresent(e)}},{key:"getIndices",value:function(){return this._sourceMesh.getIndices()}},{key:"_positions",get:function(){return this._sourceMesh._positions}},{key:"refreshBoundingInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;var i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,t),i),this}},{key:"_preActivate",value:function(){return this._currentLOD&&this._currentLOD._preActivate(),this}},{key:"_activate",value:function(e,t){if(c((0,h.Z)(i.prototype),"_activate",this).call(this,e,t),this._sourceMesh.subMeshes||ue.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}},{key:"_postActivate",value:function(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}},{key:"getWorldMatrix",value:function(){if(this._currentLOD&&this._currentLOD.billboardMode!==gn.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new Z);var e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,Y.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(Y.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return c((0,h.Z)(i.prototype),"getWorldMatrix",this).call(this)}},{key:"isAnInstance",get:function(){return!0}},{key:"getLOD",value:function(e){if(!e)return this;var t=this.sourceMesh.getLODLevels();if(t&&0!==t.length){var i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}else this._currentLOD=this.sourceMesh;return this._currentLOD}},{key:"_preActivateForIntermediateRendering",value:function(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}},{key:"_syncSubMeshes",value:function(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(var e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}},{key:"_generatePointsArray",value:function(){return this._sourceMesh._generatePointsArray()}},{key:"_updateBoundingInfo",value:function(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}},{key:"clone",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2?arguments[2]:void 0,n=((arguments.length>3?arguments[3]:void 0)||this._sourceMesh).createInstance(e);if(je.DeepCopy(this,n,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(n.parent=t),!i)for(var r=0;r<this.getScene().meshes.length;r++){var s=this.getScene().meshes[r];s.parent===this&&s.clone(s.name,n)}return n.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(n),n}},{key:"dispose",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._sourceMesh.removeInstance(this),c((0,h.Z)(i.prototype),"dispose",this).call(this,e,t)}},{key:"_serializeAsParent",value:function(e){c((0,h.Z)(i.prototype),"_serializeAsParent",this).call(this,e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}},{key:"instantiateHierarchy",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0,n=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);n&&i&&i(this,n);var r,s=(0,p.Z)(this.getChildTransformNodes(!0));try{for(s.s();!(r=s.n()).done;){r.value.instantiateHierarchy(n,t,i)}}catch(a){s.e(a)}finally{s.f()}return n}}]),i}(Tn);Ln.prototype.registerInstancedBuffer=function(e,t){var i,n;if(null===(n=null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e])||void 0===n||n.dispose(),!this.instancedBuffers){this.instancedBuffers={};var r,s=(0,p.Z)(this.instances);try{for(s.s();!(r=s.n()).done;){r.value.instancedBuffers={}}}catch(l){s.e(l)}finally{s.f()}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0})}this.instancedBuffers[e]=null,this._userInstancedBuffersStorage.strides[e]=t,this._userInstancedBuffersStorage.sizes[e]=32*t,this._userInstancedBuffersStorage.data[e]=new Float32Array(this._userInstancedBuffersStorage.sizes[e]),this._userInstancedBuffersStorage.vertexBuffers[e]=new ni(this.getEngine(),this._userInstancedBuffersStorage.data[e],e,!0,!1,t,!0);var a,o=(0,p.Z)(this.instances);try{for(o.s();!(a=o.n()).done;){a.value.instancedBuffers[e]=null}}catch(l){o.e(l)}finally{o.f()}this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()},Ln.prototype._processInstancedBuffers=function(e,t){var i=e?e.length:0;for(var n in this.instancedBuffers){for(var r=this._userInstancedBuffersStorage.sizes[n],s=this._userInstancedBuffersStorage.strides[n],a=(i+1)*s;r<a;)r*=2;this._userInstancedBuffersStorage.data[n].length!=r&&(this._userInstancedBuffersStorage.data[n]=new Float32Array(r),this._userInstancedBuffersStorage.sizes[n]=r,this._userInstancedBuffersStorage.vertexBuffers[n]&&(this._userInstancedBuffersStorage.vertexBuffers[n].dispose(),this._userInstancedBuffersStorage.vertexBuffers[n]=null));var o=this._userInstancedBuffersStorage.data[n],l=0;if(t){var u=this.instancedBuffers[n];u.toArray?u.toArray(o,l):u.copyToArray?u.copyToArray(o,l):o[l]=u,l+=s}for(var h=0;h<i;h++){var c=e[h].instancedBuffers[n];c.toArray?c.toArray(o,l):c.copyToArray?c.copyToArray(o,l):o[l]=c,l+=s}this._userInstancedBuffersStorage.vertexBuffers[n]?this._userInstancedBuffersStorage.vertexBuffers[n].updateDirectly(o,0):(this._userInstancedBuffersStorage.vertexBuffers[n]=new ni(this.getEngine(),this._userInstancedBuffersStorage.data[n],n,!0,!1,s,!0),this._invalidateInstanceVertexArrayObject())}},Ln.prototype._invalidateInstanceVertexArrayObject=function(){if(this._userInstancedBuffersStorage&&void 0!==this._userInstancedBuffersStorage.vertexArrayObjects){for(var e in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[e]);this._userInstancedBuffersStorage.vertexArrayObjects={}}},Ln.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(var e in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[e]&&this._userInstancedBuffersStorage.vertexBuffers[e].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};var ns={assetPath:"",enableShadows:!1,groupId:null,id:null,lights:[],rollId:null,scene:null},rs=function(){function e(t,i){(0,m.Z)(this,e),b(this,"value",0),b(this,"asleep",!1),this.config=(0,a.Z)((0,a.Z)({},ns),t),this.id=void 0!==this.config.id?this.config.id:Date.now(),this.dieType=this.config.sides,this.comboKey="".concat(this.config.theme,"_").concat(this.dieType),this.scene=i,this.createInstance()}return(0,y.Z)(e,[{key:"createInstance",value:function(){var e="".concat(this.config.meshName,"_").concat(this.dieType,"_").concat(this.config.theme).concat(this.config.colorSuffix),t="".concat(e,"-instance-").concat(this.id),i=this.scene.getMeshByName(e).createInstance(t);if(this.config.colorSuffix.length>0){var n=Ze.FromHexString(this.config.themeColor);i.instancedBuffers.customColor=n}i.position.y=-100,i.scaling=new z(i.scaling.x*this.config.scale,i.scaling.y*this.config.scale,i.scaling.z*this.config.scale),this.config.enableShadows&&this.config.lights.directional.shadowGenerator.addShadowCaster(i),this.mesh=i}},{key:"updateConfig",value:function(e){this.config=(0,a.Z)((0,a.Z)({},this.config),e)}}],[{key:"loadDie",value:function(){var e=(0,f.Z)((0,d.Z)().mark((function e(t,i){var n,r,s,a,o,l,u,h;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.sides,r=t.theme,s=void 0===r?"default":r,a=t.meshName,o=t.colorSuffix,u=(l=a+"_"+n)+"_"+s+o,h=i.getMeshByName(u),e.abrupt("return",(h||(h=i.getMeshByName(l).clone(u)),h.material||(h.material=i.getMaterialByName(s+o),o.length>0&&h.registerInstancedBuffer("customColor",3)),t));case 3:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"loadModels",value:function(){var e=(0,f.Z)((0,d.Z)().mark((function e(t,i){var n,r,s,a,o,l,u;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.meshFilePath,r=t.meshName,t.scale,s=t.d4FaceDown,a=void 0===s||s,o=!1,l=!1,e.next=4,fetch("".concat(n)).then((function(e){if(e.ok){var t=e.headers.get("content-type");if(t&&-1!==t.indexOf("application/json"))return e.json();if(e.type&&"basic"===e.type)return e.json();throw new Error("Incorrect contentType: ".concat(t,'. Expected "application/json" or "basic"'))}throw new Error("Unable to load 3D mesh file: '".concat(n,"'. Request rejected with status ").concat(e.status,": ").concat(e.statusText))})).catch((function(e){return console.error(e)}));case 4:if(!(u=e.sent)){e.next=7;break}return e.abrupt("return",(Jr.ImportMeshAsync(null,null,"data:"+JSON.stringify(u),i).then((function(e){if(e.meshes.forEach((function(e){"__root__"===e.name&&e.dispose(),e.name.includes("collider")&&(e.scaling=new z(.9*e.scaling.x,.9*e.scaling.y,.9*e.scaling.z)),o||(o="d100"===e.name),l||(l="d10"===e.name),e.setEnabled(!1),e.freezeNormals(),e.freezeWorldMatrix(),e.isPickable=!1,e.doNotSyncBoundingInfo=!0,e.name=r+"_"+e.name})),!o&&l&&(i.getMeshByName(r+"_d10").clone(r+"_d100"),i.getMeshByName(r+"_d10_collider").clone(r+"_d100_collider"),u.colliderFaceMap&&(u.colliderFaceMap.d100=(0,T.d)(u.colliderFaceMap.d10),Object.values(u.colliderFaceMap.d100).forEach((function(e,t){u.colliderFaceMap.d100[t]=e*(10===e?0:10)})))),!u.colliderFaceMap)throw new Error("'colliderFaceMap' data not found in ".concat(n,". Without the colliderFaceMap data dice values can not be resolved."));i.themeData[r]={},i.themeData[r].colliderFaceMap=u.colliderFaceMap,i.themeData[r].d4FaceDown=a})).catch((function(e){return console.error(e)})),u.meshes.filter((function(e){return e.name.includes("collider")}))));case 7:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"setVector3",value:function(t,i,n){return e.vector3.set(t,i,n)}},{key:"getVector3",value:function(){return e.vector3}},{key:"getRollResult",value:function(){var t=(0,f.Z)((0,d.Z)().mark((function t(i,n){var r;return(0,d.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i;return new Promise((function(r,s){var a=i.config.parentMesh||i.config.meshName,o=n.themeData[a].colliderFaceMap,l=n.themeData[a].d4FaceDown;if(!o[t.dieType])throw new Error("No colliderFaceMap data for ".concat(t.dieType));var u=n.getMeshByName("".concat(a,"_").concat(t.dieType,"_collider")).createInstance("".concat(a,"_").concat(t.dieType,"-hitbox-").concat(t.id));u.isPickable=!0,u.isVisible=!0,u.setEnabled(!0),u.position=t.mesh.position,u.rotationQuaternion=t.mesh.rotationQuaternion;var h=e.setVector3(0,1,0);"d4"===t.dieType&&l&&(h=e.setVector3(0,-1,0)),e.ray.direction=h,e.ray.origin=i.mesh.position;var c=n.pickWithRay(e.ray);if(u.dispose(),t.value=o[t.dieType][c.faceId],void 0===t.value)throw new Error("colliderFaceMap Error: No value found for ".concat(t.dieType," mesh face ").concat(c.faceId));return r(t.value)})).catch((function(e){return console.error(e)}))},!i.mesh){t.next=7;break}return t.next=4,r();case 4:t.t0=t.sent,t.next=8;break;case 7:t.t0=i.value;case 8:return t.abrupt("return",t.t0);case 9:case"end":return t.stop()}}),t)})));return function(e,i){return t.apply(this,arguments)}}()}]),e}(),ss=rs;b(ss,"ray",new $r(z.Zero(),z.Zero(),1)),b(ss,"vector3",z.Zero());var as=(0,y.Z)((function e(){(0,m.Z)(this,e)})),os=function(e){(0,v.Z)(i,e);var t=(0,g.Z)(i);function i(e,n){var r;return(0,m.Z)(this,i),(r=t.call(this,e,n)).CustomParts=new as,r.customShaderNameResolve=r.Builder,r.FragmentShader=Me.ShadersStore.defaultPixelShader,r.VertexShader=Me.ShadersStore.defaultVertexShader,r}return(0,y.Z)(i,[{key:"AttachAfterBind",value:function(e,t){if(this._newUniformInstances)for(var i in this._newUniformInstances){var n=i.toString().split("-");"vec2"==n[0]?t.setVector2(n[1],this._newUniformInstances[i]):"vec3"==n[0]?t.setVector3(n[1],this._newUniformInstances[i]):"vec4"==n[0]?t.setVector4(n[1],this._newUniformInstances[i]):"mat4"==n[0]?t.setMatrix(n[1],this._newUniformInstances[i]):"float"==n[0]&&t.setFloat(n[1],this._newUniformInstances[i])}if(this._newSamplerInstances)for(var r in this._newSamplerInstances){var s=r.toString().split("-");"sampler2D"==s[0]&&this._newSamplerInstances[r].isReady&&this._newSamplerInstances[r].isReady()&&t.setTexture(s[1],this._newSamplerInstances[r])}}},{key:"ReviewUniform",value:function(e,t){if("uniform"==e&&this._newUniforms)for(var i=0;i<this._newUniforms.length;i++)-1==this._customUniform[i].indexOf("sampler")&&t.push(this._newUniforms[i]);if("sampler"==e&&this._newUniforms)for(var n=0;n<this._newUniforms.length;n++)-1!=this._customUniform[n].indexOf("sampler")&&t.push(this._newUniforms[n]);return t}},{key:"Builder",value:function(e,t,n,r,a,o){var l=this;if(o&&this._customAttributes&&this._customAttributes.length>0&&o.push.apply(o,(0,s.Z)(this._customAttributes)),this.ReviewUniform("uniform",t),this.ReviewUniform("sampler",r),this._isCreatedShader)return this._createdShaderName;this._isCreatedShader=!1,i.ShaderIndexer++;var u="custom_"+i.ShaderIndexer,h=this._afterBind.bind(this);return this._afterBind=function(e,t){if(t){l.AttachAfterBind(e,t);try{h(e,t)}catch(i){}}},Me.ShadersStore[u+"VertexShader"]=this.VertexShader.replace("#define CUSTOM_VERTEX_BEGIN",this.CustomParts.Vertex_Begin?this.CustomParts.Vertex_Begin:"").replace("#define CUSTOM_VERTEX_DEFINITIONS",(this._customUniform?this._customUniform.join("\n"):"")+(this.CustomParts.Vertex_Definitions?this.CustomParts.Vertex_Definitions:"")).replace("#define CUSTOM_VERTEX_MAIN_BEGIN",this.CustomParts.Vertex_MainBegin?this.CustomParts.Vertex_MainBegin:"").replace("#define CUSTOM_VERTEX_UPDATE_POSITION",this.CustomParts.Vertex_Before_PositionUpdated?this.CustomParts.Vertex_Before_PositionUpdated:"").replace("#define CUSTOM_VERTEX_UPDATE_NORMAL",this.CustomParts.Vertex_Before_NormalUpdated?this.CustomParts.Vertex_Before_NormalUpdated:"").replace("#define CUSTOM_VERTEX_MAIN_END",this.CustomParts.Vertex_MainEnd?this.CustomParts.Vertex_MainEnd:""),this.CustomParts.Vertex_After_WorldPosComputed&&(Me.ShadersStore[u+"VertexShader"]=Me.ShadersStore[u+"VertexShader"].replace("#define CUSTOM_VERTEX_UPDATE_WORLDPOS",this.CustomParts.Vertex_After_WorldPosComputed)),Me.ShadersStore[u+"PixelShader"]=this.FragmentShader.replace("#define CUSTOM_FRAGMENT_BEGIN",this.CustomParts.Fragment_Begin?this.CustomParts.Fragment_Begin:"").replace("#define CUSTOM_FRAGMENT_MAIN_BEGIN",this.CustomParts.Fragment_MainBegin?this.CustomParts.Fragment_MainBegin:"").replace("#define CUSTOM_FRAGMENT_DEFINITIONS",(this._customUniform?this._customUniform.join("\n"):"")+(this.CustomParts.Fragment_Definitions?this.CustomParts.Fragment_Definitions:"")).replace("#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE",this.CustomParts.Fragment_Custom_Diffuse?this.CustomParts.Fragment_Custom_Diffuse:"").replace("#define CUSTOM_FRAGMENT_UPDATE_ALPHA",this.CustomParts.Fragment_Custom_Alpha?this.CustomParts.Fragment_Custom_Alpha:"").replace("#define CUSTOM_FRAGMENT_BEFORE_LIGHTS",this.CustomParts.Fragment_Before_Lights?this.CustomParts.Fragment_Before_Lights:"").replace("#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR",this.CustomParts.Fragment_Before_FragColor?this.CustomParts.Fragment_Before_FragColor:"").replace("#define CUSTOM_FRAGMENT_MAIN_END",this.CustomParts.Fragment_MainEnd?this.CustomParts.Fragment_MainEnd:""),this.CustomParts.Fragment_Before_Fog&&(Me.ShadersStore[u+"PixelShader"]=Me.ShadersStore[u+"PixelShader"].replace("#define CUSTOM_FRAGMENT_BEFORE_FOG",this.CustomParts.Fragment_Before_Fog)),this._isCreatedShader=!0,this._createdShaderName=u,u}},{key:"AddUniform",value:function(e,t,i){return this._customUniform||(this._customUniform=new Array,this._newUniforms=new Array,this._newSamplerInstances={},this._newUniformInstances={}),i&&(-1!=t.indexOf("sampler")?this._newSamplerInstances[t+"-"+e]=i:this._newUniformInstances[t+"-"+e]=i),this._customUniform.push("uniform "+t+" "+e+";"),this._newUniforms.push(e),this}},{key:"AddAttribute",value:function(e){return this._customAttributes||(this._customAttributes=[]),this._customAttributes.push(e),this}},{key:"Fragment_Begin",value:function(e){return this.CustomParts.Fragment_Begin=e,this}},{key:"Fragment_Definitions",value:function(e){return this.CustomParts.Fragment_Definitions=e,this}},{key:"Fragment_MainBegin",value:function(e){return this.CustomParts.Fragment_MainBegin=e,this}},{key:"Fragment_MainEnd",value:function(e){return this.CustomParts.Fragment_MainEnd=e,this}},{key:"Fragment_Custom_Diffuse",value:function(e){return this.CustomParts.Fragment_Custom_Diffuse=e.replace("result","diffuseColor"),this}},{key:"Fragment_Custom_Alpha",value:function(e){return this.CustomParts.Fragment_Custom_Alpha=e.replace("result","alpha"),this}},{key:"Fragment_Before_Lights",value:function(e){return this.CustomParts.Fragment_Before_Lights=e,this}},{key:"Fragment_Before_Fog",value:function(e){return this.CustomParts.Fragment_Before_Fog=e,this}},{key:"Fragment_Before_FragColor",value:function(e){return this.CustomParts.Fragment_Before_FragColor=e.replace("result","color"),this}},{key:"Vertex_Begin",value:function(e){return this.CustomParts.Vertex_Begin=e,this}},{key:"Vertex_Definitions",value:function(e){return this.CustomParts.Vertex_Definitions=e,this}},{key:"Vertex_MainBegin",value:function(e){return this.CustomParts.Vertex_MainBegin=e,this}},{key:"Vertex_Before_PositionUpdated",value:function(e){return this.CustomParts.Vertex_Before_PositionUpdated=e.replace("result","positionUpdated"),this}},{key:"Vertex_Before_NormalUpdated",value:function(e){return this.CustomParts.Vertex_Before_NormalUpdated=e.replace("result","normalUpdated"),this}},{key:"Vertex_After_WorldPosComputed",value:function(e){return this.CustomParts.Vertex_After_WorldPosComputed=e,this}},{key:"Vertex_MainEnd",value:function(e){return this.CustomParts.Vertex_MainEnd=e,this}}]),i}(Zr);os.ShaderIndexer=1,N("BABYLON.CustomMaterial",os),os.prototype.clone=function(e){var t=this,i=this,n=jt.Clone((function(){return new os(e,t.getScene())}),this);return n.name=e,n.id=e,n.CustomParts.Fragment_Begin=i.CustomParts.Fragment_Begin,n.CustomParts.Fragment_Definitions=i.CustomParts.Fragment_Definitions,n.CustomParts.Fragment_MainBegin=i.CustomParts.Fragment_MainBegin,n.CustomParts.Fragment_Custom_Diffuse=i.CustomParts.Fragment_Custom_Diffuse,n.CustomParts.Fragment_Before_Lights=i.CustomParts.Fragment_Before_Lights,n.CustomParts.Fragment_Before_Fog=i.CustomParts.Fragment_Before_Fog,n.CustomParts.Fragment_Custom_Alpha=i.CustomParts.Fragment_Custom_Alpha,n.CustomParts.Fragment_Before_FragColor=i.CustomParts.Fragment_Before_FragColor,n.CustomParts.Vertex_Begin=i.CustomParts.Vertex_Begin,n.CustomParts.Vertex_Definitions=i.CustomParts.Vertex_Definitions,n.CustomParts.Vertex_MainBegin=i.CustomParts.Vertex_MainBegin,n.CustomParts.Vertex_Before_PositionUpdated=i.CustomParts.Vertex_Before_PositionUpdated,n.CustomParts.Vertex_Before_NormalUpdated=i.CustomParts.Vertex_Before_NormalUpdated,n.CustomParts.Vertex_After_WorldPosComputed=i.CustomParts.Vertex_After_WorldPosComputed,n.CustomParts.Vertex_MainEnd=i.CustomParts.Vertex_MainEnd,n};var ls,us,hs,cs,ds,fs,_s,vs,gs,ps,ms,ys,Ts,Es,Ss,bs=function(){function e(t){(0,m.Z)(this,e),b(this,"loadedThemes",{}),b(this,"themeData",{}),this.scene=t.scene}return(0,y.Z)(e,[{key:"loadStandardMaterial",value:function(){var e=(0,f.Z)((0,d.Z)().mark((function e(t){var i,n,r;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.theme,n=t.material,r=new Zr(i,this.scene),e.t0=n.diffuseTexture,!e.t0){e.next=6;break}return e.next=5,this.getTexture("diffuse",t);case 5:r.diffuseTexture=e.sent;case 6:if(e.t1=n.bumpTexture,!e.t1){e.next=11;break}return e.next=10,this.getTexture("bump",t);case 10:r.bumpTexture=e.sent;case 11:if(e.t2=n.specularTexture,!e.t2){e.next=16;break}return e.next=15,this.getTexture("specular",t);case 15:r.specularTexture=e.sent;case 16:r.allowShaderHotSwapping=!1;case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"loadColorMaterial",value:function(){var e=(0,f.Z)((0,d.Z)().mark((function e(t){var i,n,r,s,a;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.theme,n=t.material,r=new os(i+"_light",this.scene),s=(0,T.d)(t),e.t0=n.diffuseTexture&&n.diffuseTexture.light,!e.t0){e.next=7;break}return s.material.diffuseTexture=t.material.diffuseTexture.light,e.next=6,this.getTexture("diffuse",s);case 6:r.diffuseTexture=e.sent;case 7:if(e.t1=n.bumpTexture,!e.t1){e.next=12;break}return e.next=11,this.getTexture("bump",t);case 11:r.bumpTexture=e.sent;case 12:if(e.t2=n.specularTexture,!e.t2){e.next=17;break}return e.next=16,this.getTexture("specular",t);case 16:r.specularTexture=e.sent;case 17:if(r.allowShaderHotSwapping=!1,r.Vertex_Definitions("\n      attribute vec3 customColor;\n      varying vec3 vColor;\n    ").Vertex_MainEnd("\n      vColor = customColor;\n    ").Fragment_Definitions("\n      varying vec3 vColor;\n    ").Fragment_Custom_Diffuse("\n      baseColor.rgb = mix(vColor.rgb, baseColor.rgb, baseColor.a);\n    "),r.AddAttribute("customColor"),a=r.clone(i+"_dark"),e.t3=n.diffuseTexture&&n.diffuseTexture.dark,!e.t3){e.next=27;break}return s.material.diffuseTexture=t.material.diffuseTexture.dark,e.next=26,this.getTexture("diffuse",s);case 26:a.diffuseTexture=e.sent;case 27:a.AddAttribute("customColor");case 28:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getTexture",value:function(){var e=(0,f.Z)((0,d.Z)().mark((function e(t,i){var n,r,s,a,o,l;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=i.basePath,r=i.material,s=i.theme,o=t+"Level",l=t+"Texture",e.prev=2,e.t0=t,e.next="diffuse"===e.t0?6:"bump"===e.t0?11:"specular"===e.t0?16:21;break;case 6:return e.next=8,this.importTextureAsync("".concat(n,"/").concat(r[l]),s);case 8:return a=e.sent,r[o]&&(a.level=r[o]),e.abrupt("break",22);case 11:return e.next=13,this.importTextureAsync("".concat(n,"/").concat(r[l]),s);case 13:return a=e.sent,r[o]&&(a.level=r[o]),e.abrupt("break",22);case 16:return e.next=18,this.importTextureAsync("".concat(n,"/").concat(r[l]),s);case 18:return a=e.sent,r.specularPower&&(a.specularPower=r.specularPower),e.abrupt("break",22);case 21:throw new Error("Texture type: ".concat(t," is not supported"));case 22:e.next=27;break;case 24:e.prev=24,e.t1=e.catch(2),console.error(e.t1);case 27:return e.abrupt("return",a);case 28:case"end":return e.stop()}}),e,this,[[2,24]])})));return function(t,i){return e.apply(this,arguments)}}()},{key:"importTextureAsync",value:function(){var e=(0,f.Z)((0,d.Z)().mark((function e(t,i){var n=this;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){var s=t.match(/^(.*\/)(.*)$/),a=new ar(t,n.scene,void 0,!0,void 0,(function(){return e(a)}),(function(){return r("Unable to load texture '".concat(s[2],"' for theme: '").concat(i,"'. Check that your assetPath is configured correctly and that the files exist at path: '").concat(s[1],"'"))}))})).catch((function(e){return console.error(e)})));case 1:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"load",value:function(){var e=(0,f.Z)((0,d.Z)().mark((function e(t){var i;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("color"!==(i=t.material).type){e.next=6;break}return e.next=4,this.loadColorMaterial(t);case 4:e.next=12;break;case 6:if("standard"!==i.type){e.next=11;break}return e.next=9,this.loadStandardMaterial(t);case 9:e.next=12;break;case 11:console.error("Material type: ".concat(i.type," not supported"));case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}(),xs=function(){function e(t){(0,m.Z)(this,e),A(this,Es),b(this,"config"),b(this,"initialized",!1),A(this,ls,{}),A(this,us,0),A(this,hs,0),A(this,cs,[]),A(this,ds,void 0),A(this,fs,void 0),A(this,_s,void 0),A(this,vs,void 0),A(this,gs,void 0),A(this,ps,void 0),A(this,ms,void 0),A(this,ys,void 0),A(this,Ts,{}),b(this,"noop",(function(){})),b(this,"diceBufferView",new Float32Array(8e3)),this.onInitComplete=t.onInitComplete||this.noop,this.onThemeLoaded=t.onThemeLoaded||this.noop,this.onRollResult=t.onRollResult||this.noop,this.onRollComplete=t.onRollComplete||this.noop,this.onDieRemoved=t.onDieRemoved||this.noop,this.initialized=this.initScene(t)}return(0,y.Z)(e,[{key:"initScene",value:function(){var e=(0,f.Z)((0,d.Z)().mark((function e(t){return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:R(this,ds,t.canvas),M(this,ds).width=t.width,M(this,ds).height=t.height,this.config=t.options,R(this,fs,He(M(this,ds))),R(this,_s,qn({engine:M(this,fs)})),R(this,vs,Qn({engine:M(this,fs),scene:M(this,_s)})),R(this,gs,Fr({enableShadows:this.config.enableShadows,shadowTransparency:this.config.shadowTransparency,intensity:this.config.lightIntensity,scene:M(this,_s)})),R(this,ps,new Qr({enableShadows:this.config.enableShadows,aspect:M(this,ds).width/M(this,ds).height,lights:M(this,gs),scene:M(this,_s)})),R(this,ms,new bs({scene:M(this,_s)})),this.onInitComplete();case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"connect",value:function(e){var t=this;R(this,ys,e),M(this,ys).postMessage({action:"initBuffer",diceBuffer:this.diceBufferView.buffer},[this.diceBufferView.buffer]),M(this,ys).onmessage=function(e){if("updates"===e.data.action)t.updatesFromPhysics(e.data.diceBuffer);else console.error("action from physicsWorker not found in offscreen worker")}}},{key:"updateConfig",value:function(e){var t=this,i=this.config;this.config=e,i.enableShadows!==this.config.enableShadows&&(Object.values(M(this,gs)).forEach((function(e){return e.dispose()})),R(this,gs,Fr({enableShadows:this.config.enableShadows}))),i.scale!==this.config.scale&&Object.values(M(this,ls)).forEach((function(e){var i=e.mesh;i&&(i.scaling=new z(t.config.scale,t.config.scale,t.config.scale))})),i.shadowTransparency!==this.config.shadowTransparency&&(M(this,gs).directional.shadowGenerator.darkness=this.config.shadowTransparency),i.lightIntensity!==this.config.lightIntensity&&(M(this,gs).directional.intensity=.65*this.config.lightIntensity,M(this,gs).hemispheric.intensity=.4*this.config.lightIntensity)}},{key:"render",value:function(e){M(this,fs).runRenderLoop(this.renderLoop.bind(this)),M(this,ys).postMessage({action:"resumeSimulation",newStartPoint:e})}},{key:"renderLoop",value:function(){M(this,hs)&&M(this,hs)===Object.keys(M(this,ls)).length?(M(this,fs).stopRenderLoop(),M(this,ys).postMessage({action:"stopSimulation"}),this.onRollComplete()):M(this,_s).render()}},{key:"loadTheme",value:function(){var e=(0,f.Z)((0,d.Z)().mark((function e(t){var i,n,r,s,a,o;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.theme,n=t.basePath,r=t.material,s=t.meshFilePath,a=t.meshName,e.next=3,M(this,ms).load({theme:i,basePath:n,material:r});case 3:if(Object.keys(M(this,Ts)).includes(a)){e.next=11;break}return M(this,Ts)[a]=s,e.next=7,ss.loadModels({meshFilePath:s,meshName:a},M(this,_s));case 7:if(o=e.sent){e.next=10;break}throw new Error("No colliders returned from the 3D mesh file. Low poly colliders are expected to be in the same file as the high poly dice and the mesh name contains the word 'collider'");case 10:M(this,ys).postMessage({action:"loadModels",options:{colliders:o,meshName:a}});case 11:this.onThemeLoaded({id:i});case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"clear",value:function(){!Object.keys(M(this,ls)).length&&!M(this,hs)||(this.diceBufferView.byteLength&&this.diceBufferView.fill(0),M(this,cs).forEach((function(e){return clearTimeout(e)})),M(this,fs).stopRenderLoop(),Object.values(M(this,ls)).forEach((function(e){e.mesh&&e.mesh.dispose()})),R(this,ls,{}),R(this,us,0),R(this,hs,0),M(this,_s).render())}},{key:"add",value:function(e){var t=this;ss.loadDie(e,M(this,_s)).then((function(e){M(t,cs).push(setTimeout((function(){(function(e,t,i){return x(e,t,"access private method"),i})(t,Es,Ss).call(t,e)}),C(t,us)._++*t.config.delay))}))}},{key:"addNonDie",value:function(e){var t=this;0===M(this,fs).activeRenderLoops.length&&this.render(!1);var i=e.id,r={id:i,value:e.value,config:(0,n.Z)(e,E)};M(this,ls)[i]=r,setTimeout((function(){M(t,cs).push(setTimeout((function(){t.handleAsleep(r)}),C(t,us)._++*t.config.delay))}),10)}},{key:"remove",value:function(e){var t=M(this,ls)[e.id];t.hasOwnProperty("d10Instance")&&(M(this,ls)[t.d10Instance.id].mesh&&(M(this,ls)[t.d10Instance.id].mesh.dispose(),M(this,ys).postMessage({action:"removeDie",id:t.d10Instance.id})),delete M(this,ls)[t.d10Instance.id],C(this,hs)._--),M(this,ls)[e.id].mesh&&M(this,ls)[e.id].mesh.dispose(),delete M(this,ls)[e.id],C(this,hs)._--,M(this,_s).render(),this.onDieRemoved(e.rollId)}},{key:"updatesFromPhysics",value:function(e){var t=this;this.diceBufferView=new Float32Array(e);for(var i=1,n=0,r=this.diceBufferView[0];n<r;n++)if(Object.keys(M(this,ls)).length){var s=M(this,ls)["".concat(this.diceBufferView[i])];if(!s){console.log("Error: die not available in scene to animate");break}if(-1===this.diceBufferView[i+1])this.handleAsleep(s);else{var a=this.diceBufferView[i+1],o=this.diceBufferView[i+2],l=this.diceBufferView[i+3],u=this.diceBufferView[i+4],h=this.diceBufferView[i+5],c=this.diceBufferView[i+6],d=this.diceBufferView[i+7];s.mesh.position.set(a,o,l),s.mesh.rotationQuaternion.set(u,h,c,d)}i+=8}requestAnimationFrame((function(){M(t,ys).postMessage({action:"stepSimulation",diceBuffer:t.diceBufferView.buffer},[t.diceBufferView.buffer])}))}},{key:"handleAsleep",value:function(){var e=(0,f.Z)((0,d.Z)().mark((function e(t){var i,n,r,s;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.asleep=!0,e.next=3,ss.getRollResult(t,M(this,_s));case 3:if(!t.d10Instance&&!t.dieParent){e.next=7;break}(null!=(i=null==t?void 0:t.d10Instance)&&i.asleep||null!=(n=null==t?void 0:t.dieParent)&&n.asleep)&&(r=100===t.config.sides?t:t.dieParent,0===(s=10===t.config.sides?t:t.d10Instance).value&&0===r.value?r.value=100:r.value=r.value+s.value,this.onRollResult({rollId:r.config.rollId,value:r.value})),e.next=8;break;case 7:10===t.config.sides&&0===t.value&&(t.value=10),this.onRollResult({rollId:t.config.rollId,value:t.value});case 8:C(this,hs)._++;case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"resize",value:function(e){var t=M(this,ds).width=e.width,i=M(this,ds).height=e.height;M(this,ps).create({aspect:t/i}),M(this,fs).resize()}}]),e}();ls=new WeakMap,us=new WeakMap,hs=new WeakMap,cs=new WeakMap,ds=new WeakMap,fs=new WeakMap,_s=new WeakMap,vs=new WeakMap,gs=new WeakMap,ps=new WeakMap,ms=new WeakMap,ys=new WeakMap,Ts=new WeakMap,Es=new WeakSet,Ss=function(){var e=(0,f.Z)((0,d.Z)().mark((function e(t){var i,n,r=this;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===M(this,fs).activeRenderLoops.length&&this.render(t.newStartPoint),i=(0,a.Z)((0,a.Z)({},t),{},{assetPath:this.config.assetPath,enableShadows:this.config.enableShadows,scale:this.config.scale,lights:M(this,gs)}),n=new ss(i,M(this,_s)),M(this,ls)[n.id]=n,M(this,ys).postMessage({action:"addDie",options:{sides:t.sides,scale:this.config.scale,id:n.id,newStartPoint:t.newStartPoint,theme:t.theme,meshName:t.meshName}}),e.t0=100===t.sides,!e.t0){e.next=11;break}return e.next=8,ss.loadDie((0,a.Z)((0,a.Z)({},i),{},{sides:10,id:n.id+1e4}),M(this,_s)).then((function(e){var t=new ss(e,M(r,_s));return t.dieParent=n,t}));case 8:n.d10Instance=e.sent,M(this,ls)["".concat(n.d10Instance.id)]=n.d10Instance,M(this,ys).postMessage({action:"addDie",options:{sides:10,scale:this.config.scale,id:n.d10Instance.id,theme:t.theme,meshName:t.meshName}});case 11:return e.abrupt("return",n);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}}]);
//# sourceMappingURL=125.4d36beb3.chunk.js.map